Ext.define("Sch.crud.AbstractManager",{require:["Ext.data.StoreManager"],mixins:{observable:Ext.util.Observable},revision:null,stores:null,storeIdProperty:"storeId",filterParam:"filter",storesIndex:null,activeRequests:null,delayedSyncs:null,transport:null,trackResponseType:!1,phantomIdField:"$PhantomId",autoLoad:!1,autoSyncTimeout:100,autoSync:!1,resetIdsBeforeSync:!0,syncApplySequence:null,writeAllFields:!1,ignoreUpdates:0,createMissingRecords:!1,autoSyncTimerId:null,constructor:function(n){var i,t;n=n||{};this.mixins.observable.constructor.call(this,n);this.activeRequests={};this.delayedSyncs=[];this.transport=n.transport||this.transport||{};i=n.stores||this.stores;this.stores=[];this.addStore(i);t=n.syncApplySequence||this.syncApplySequence;t&&(this.syncApplySequence=null,this.addStoreToApplySequence(t));this.autoLoad&&this.load()},updateStoreIndex:function(){for(var t,i={},n=0,r=this.stores.length;n<r;n++)t=this.stores[n],t.storeId&&(i[t.storeId]=this.stores[n]);this.storesIndex=i},getStoreDescriptor:function(n){if(n)if(n.isStore){for(var t=0,i=this.stores.length;t<i;t++)if(this.stores[t].store===n)return this.stores[t]}else return typeof n=="object"?this.storesIndex[n.storeId]:this.storesIndex[n]||this.getStoreDescriptor(Ext.data.StoreManager.get(n))},getStore:function(n){var t=this.getStoreDescriptor(n);return t&&t.store},forEachStore:function(n,t){var r,i,u;if(n)for(r=this.stores,i=0,u=r.length;i<u;i++)if(n.call(t||this,r[i].store,r[i].storeId,r[i])===!1)break},addStore:function(n,t,i){var f,e,c,r,u,l,o,s,h;if(n){for(Ext.isArray(n)||(n=[n]),f=[],e=0,c=n.length;e<c;e++){if(r=n[e],r.isStore)r={store:r};else if(typeof r=="object"){if(r.stores)for(Ext.isArray(r.stores)||(r.stores=[r.stores]),u=0,l=r.stores.length;u<l;u++)o=r.stores[u],s=o,"string"==typeof o&&(s={storeId:o}),s.masterStoreInfo=r,r.stores[u]=s}else r={store:Ext.data.StoreManager.get(r)};f.push(this.fillStoreDescriptor(r));r.store.crudManager=this;r.store.isTreeStore&&r.store.setProxy({type:"memory"});this.bindStoreListeners(r.store)}typeof t=="undefined"?this.stores.push.apply(this.stores,f):(h=t,i&&((i.isStore||typeof i!="object")&&(i=this.getStoreDescriptor(i)),h+=Ext.Array.indexOf(this.stores,i)),this.stores.splice.apply(this.stores,[].concat([h,0],f)));this.updateStoreIndex()}},bindStoreListeners:function(n,t){var i={update:this.onStoreUpdate,clear:this.onStoreChange,scope:this};n.isTreeStore?Ext.apply(i,{nodeappend:this.onStoreChange,nodeinsert:this.onStoreChange,noderemove:this.onNodeRemove}):Ext.apply(i,{add:this.onStoreChange,remove:this.onStoreChange});t?this.mun(n,i):this.mon(n,i)},unbindStoreListeners:function(n){this.bindStoreListeners(n,!0)},fillStoreDescriptor:function(n){var i=n.store,r=i.storeIdProperty||this.storeIdProperty,t=i.getModel&&i.getModel()||i.model;return t=t&&t.prototype,Ext.applyIf(n,{storeId:i[r],phantomIdField:t&&t.phantomIdField,idProperty:t&&t.idProperty,writeAllFields:i.writeAllFields}),n},removeStore:function(n){for(var t,i=0,r=this.stores.length;i<r;i++)if(t=this.stores[i],t===n||t.store===n||t.storeId===n){this.unbindStoreListeners(t.store);delete this.storesIndex[t.storeId];this.stores.splice(i,1);this.syncApplySequence&&this.removeStoreFromApplySequence(n);break}},addStoreToApplySequence:function(n,t,i){var r,u,o,f,e;if(n){for(Ext.isArray(n)||(n=[n]),r=[],u=0,o=n.length;u<o;u++)f=this.getStoreDescriptor(n[u]),f&&r.push(f);this.syncApplySequence||(this.syncApplySequence=[]);typeof t=="undefined"?this.syncApplySequence.push.apply(this.syncApplySequence,r):(e=t,i&&((i.isStore||typeof i!="object")&&(i=this.getStoreDescriptor(i)),e+=Ext.Array.indexOf(this.syncApplySequence,i)),this.syncApplySequence.splice.apply(this.syncApplySequence,[].concat([e,0],r)))}},removeStoreFromApplySequence:function(n){for(var t,i=0,r=this.syncApplySequence.length;i<r;i++)if(t=this.syncApplySequence[i],t===n||t.store===n||t.storeId===n){this.syncApplySequence.splice(i,1);break}},onNodeRemove:function(n){var t=n&&n.getTreeStore();t&&t.on("endupdate",this.onStoreChange,this,{single:!0})},onStoreUpdate:function(n,t,i,r){if(!n.isTreeStore||t!==n.getRoot()){var u=r&&r.length===1&&t.getField(r[0])&&!t.getField(r[0]).persist;u||this.onStoreChange()}},onStoreChange:function(){if(!this.ignoreUpdates){var n=this;this.fireEvent(this.hasChanges()?"haschanges":"nochanges",this);this.autoSync&&(this.autoSyncTimerId||(this.autoSyncTimerId=setTimeout(function(){n.autoSyncTimerId=null;n.sync()},this.autoSyncTimeout)))}},hasChanges:function(n){var i,t,r;if(n)return(i=this.getStore(n),!i)?!1:this.isStoreDirty(i);for(t=0,r=this.stores.length;t<r;t++)if(this.isStoreDirty(this.stores[t].store))return!0;return!1},isStoreDirty:function(n){var u,t,r,i,f;if(n.getRemovedRecords().length)return!0;if(n.isTreeStore)for(u in n.byIdMap)if(t=n.byIdMap[u],t.dirty!==!0||t.get("root")&&Ext.Object.getKeys(t.modified).length===1&&"expanded"in t.modified){if(!t.get("root")&&t.phantom&&t.isValid())return!0}else return!0;else for(r=n.getData().items,i=0,f=r.length;i<f;i++)if(r[i].dirty||r[i].phantom)return!0;return!1},getLoadPackage:function(n){for(var u,f,o={type:"load",requestId:this.getRequestId(),stores:[]},e=this.stores,s=o.stores,r=0,l=e.length;r<l;r++){var t=e[r],h=t.filterParam||t.store.filterParam||this.filterParam,i=n&&n[t.storeId],c=t.pageSize||t.store.pageSize;t.store.remoteFilter&&h&&(i=i||{},u=[],t.store.getFilters().each(function(n){u.push(n.serialize())}),i[h]=u);i||c?(f=Ext.apply({storeId:t.storeId,page:1,pageSize:c},i),e[r].currentPage=f.page,s.push(f)):s.push(t.storeId)}return o},prepareAdded:function(n,t,i){for(var e,s,r,h=[],o=0,l=n.length;o<l;o++){var u=n[o],f={},c=u.getFields();for(f.hasOwnProperty(t)||(f[t]=u.getId()),e=0,s=c.length;e<s;e++)r=c[e],r&&r.persist&&(u.data.hasOwnProperty(r.name)||r.critical)&&(f[r.name]=r.serialize?r.serialize(u.data[r.name],u):u.data[r.name]);this.resetIdsBeforeSync&&delete f[u.idProperty];i&&this.processSubStores(u,f,i);h.push(f)}return h},prepareUpdated:function(n,t,i){for(var r,e,s,o,c=[],l=i.writeAllFields||i.writeAllFields!==!1&&this.writeAllFields,f,u,h=0,a=n.length;h<a;h++){if(r=n[h],l){f=r.getData();f[r.idProperty]=r.getId();for(e in f)u=r.getField(e),u&&(u.persist||u.critical)?f[e]=u.serialize?u.serialize(f[e],r):r.get(e):delete f[e]}else{f=r.getChanges();f[r.idProperty]=r.getId();for(e in f)u=r.getField(e),u&&u.persist?f[e]=u.serialize?u.serialize(f[e],r):r.get(e):delete f[e];for(s=r.getCriticalFields(),o=0;o<s.length;o++)u=s[o],f[u.getName()]=u.serialize?u.serialize(r.get(u.getName()),r):r.get(u.getName())}t&&this.processSubStores(r,f,t);c.push(f)}return c},prepareRemoved:function(n){for(var r=[],i,t=0,u=n.length;t<u;t++)i={},i[n[t].idProperty]=n[t].getId(),r.push(i);return r},processSubStores:function(n,t,i){for(var r,f,e,u=0,o=i.length;u<o;u++)r=i[u].storeId,f=n.get(r),f?(e=this.getStoreChanges(Ext.apply({store:f},i[u])),e?t[r]=Ext.apply(e,{$store:!0}):delete t[r]):delete t[r]},getStoreChanges:function(n,t){t=t||n.phantomIdField||this.phantomIdField;var e=n.store,i=e.getNewRecords(),r=e.getUpdatedRecords(),u=e.getRemovedRecords(),o=n.stores,f;return i.length&&(i=this.prepareAdded(i,t,o)),r.length&&(r=this.prepareUpdated(r,o,n)),u.length&&(u=this.prepareRemoved(u)),(i.length||r.length||u.length)&&(f={},i.length&&(f.added=i),r.length&&(f.updated=r),u.length&&(f.removed=u)),f},getChangeSetPackage:function(){for(var i={type:"sync",requestId:this.getRequestId(),revision:this.revision},r=this.stores,u=0,n=0,e=r.length;n<e;n++){var t=r[n],o=t.phantomIdField||this.phantomIdField,s=t.storeId,f=this.getStoreChanges(t,o);f&&(u++,i[s]=f)}return u?i:null},getSubStoresData:function(n,t,i,r){var e;if(n){var f=[],o=function(n,t){for(var r,u=0,e=t.length;u<e;u++)r=t[u].storeId,n[r]&&(f.push({id:n[i],storeDesc:t[u],data:n[r]}),delete n[r])},u=0,s=n.length;if(r)for(;u<s;u++)o(n[u],t),e=this.getSubStoresData(n[u].children,t,i,!0),e&&(f=f.concat(e));else for(;u<s;u++)o(n[u],t);return f}},loadDataToTreeStore:function(n,t){var i=t&&t.rows;n.proxy.data=i;n.load()},loadDataToFlatStore:function(n,t,i,r){var f=t&&t.rows,u;n.totalCount=t.total;n.currentPage=r.currentPage;u=Ext.Array.map(f,function(t){return new n.model(t)});n.loadData(u,i&&i.append||t.append);n.fireEvent("load",n,u,!0)},loadDataToStore:function(n,t,i){var r=n.store,o=r.getModel(),h=n.stores,v=n.idProperty||o&&o.prototype&&o.prototype.idProperty||"id",s=r.isTreeStore,f,c=t&&t.rows,l,e,a,u;if(r.metaData=t&&t.metaData,c){if(h&&(f=this.getSubStoresData(c,h,v,s)),r.__loading=!0,l=s?this.loadDataToTreeStore:this.loadDataToFlatStore,l.call(this,r,t,i,n),f)for(e=0,a=f.length;e<a;e++)u=f[e],this.loadDataToStore(Ext.apply({store:r[s?"getNodeById":"getById"](u.id).get(u.storeDesc.storeId)},u.storeDesc),u.data);r.__loading=!1}},loadData:function(n,t){var i,r;for(t=t||{},this.ignoreUpdates++,i=0,r=this.stores.length;i<r;i++){var u=this.stores[i],f=u.storeId,e=n[f];e&&this.loadDataToStore(u,e,t[f])}this.ignoreUpdates--},applyChangesToRecord:function(n,t,i,r){var a=n.data,h={},o=!1,u,e,c,s,f,l;if(i)for(e=0,c=i.length;e<c;e++)u=i[e].storeId,t.hasOwnProperty(u)&&(h[u]=!0,s=n.get(u),s?this.applyChangesToStore(Ext.apply({store:s},i[e]),t[u]):Ext.log("Can't find store for the response sub-package"));for(u in t)t.hasOwnProperty(u)&&!h[u]&&(f=t[u],n.isEqual(a[u],f)||(o||(o=!0,n.beginEdit()),u===n.idProperty?n.setId(f):u=="parentId"&&r.isTreeStore?(l=f&&r.getNodeById(f)||r.getRoot(),l.appendChild(n)):n.set(u,f)));this.ignoreUpdates++;o&&n.endEdit();this.ignoreUpdates--;n.commit()},applyRemovals:function(n,t,i){for(var e,o,r,c,u,l=i.idProperty,f=n.isTreeStore?n.removedNodes:n.removed,a=i.findByIdFn,v=i.removeRecordFn,s=0,h=0,y=t.length;h<y;h++){for(e=!1,o=t[h][l],r=0,c=f.length;r<c;r++)if(f[r].getId()==o){f.splice(r,1);e=!0;s++;break}e||(u=a(o),u?(this.ignoreUpdates++,v(u),Ext.Array.remove(f,u),s++,this.ignoreUpdates--):Ext.log("Can't find record to remove from the response package"))}return s},getApplyChangesToStoreHelpers:function(n){if(n.isTreeStore){var t=function(t){return n.getNodeById(t)};return{findByPhantomFn:t,findByIdFn:t,addRecordFn:function(t){var i=t.parentId&&n.getNodeById(t.parentId)||n.getRoot();return i.appendChild(t)},removeRecordFn:function(n){return n.parentNode.removeChild(n)}}}return{findByPhantomFn:function(t){return n.data.getByKey(t)},findByIdFn:function(t){return n.getById(t)},addRecordFn:function(t){return n.add(t)[0]},removeRecordFn:function(t){return n.remove(t)}}},applyChangesToStore:function(n,t){var u=this,b=n.phantomIdField||u.phantomIdField,e=n.idProperty,i=n.store,f,o,a,c,v,s,y;e||(f=i.getModel&&i.getModel()||i.model,f=f&&f.prototype,e=f&&f.idProperty||"id");var h=u.getApplyChangesToStoreHelpers(i),k=h.findByPhantomFn,p=h.findByIdFn,d=h.addRecordFn,g=h.removeRecordFn,l=t.rows,w=t.removed,r;if(l)for(v=n.stores,s=0,y=l.length;s<y;s++)o=l[s],c=o[b],a=o[e],r=null,c!=null?r=k(c):e&&(r=p(a)),r?u.applyChangesToRecord(r,o,v,i):(u.ignoreUpdates++,r=d(o),u.ignoreUpdates--,r.commit());w&&u.applyRemovals(i,w,{idProperty:e,findByIdFn:p,removeRecordFn:g})&&i.fireEvent("datachanged",i)},applySyncResponse:function(n){for(var i,r=this.syncApplySequence||this.stores,t=0,u=r.length;t<u;t++)i=n[r[t].storeId],i&&this.applyChangesToStore(r[t],i)},applyLoadResponse:function(n,t){this.loadData(n,t)},applyResponse:function(n,t,i){this.trackResponseType&&(n=t.type||n);switch(n){case"load":this.applyLoadResponse(t,i);break;case"sync":this.applySyncResponse(t)}},getRequestId:function(){return Ext.Date.now()},onResponse:function(n,t,i,r){this.activeRequests[n]=null;var u=this.decode(t);return!u||!u.success?(this.fireEvent("requestfail",this,n,u,i),this.fireEvent(n+"fail",this,u,i,r),this.warn("CrudManager: "+n+" failed, please inspect the server response",t),u):(this.fireEvent("beforeresponseapply",this,n,u)!==!1&&this.fireEvent("before"+n+"apply",this,u,r)!==!1&&(this.revision=u.revision,this.applyResponse(n,u,r),this.fireEvent("requestdone",this,n,u,i),this.fireEvent(n,this,u,i,r),this.hasChanges()||this.fireEvent("nochanges",this)),u)},onLoad:function(n,t,i){return this.onResponse("load",n,t,i)},onSync:function(n,t,i){return this.onResponse("sync",n,t,i)},load:function(n,t,i){var u,r;typeof n=="object"&&(u=n,n=t,t=i,i=arguments[3]);r=this.getLoadPackage(u);this.fireEvent("beforeload",this,r)!==!1?(i=i||this,this.activeRequests.load&&(this.cancelRequest(this.activeRequests.load.desc),this.fireEvent("loadcanceled",this,r)),this.activeRequests.load={id:r.requestId},this.activeRequests.load.desc=this.sendRequest({data:this.encode(r),type:"load",success:function(r,f){var e=this.onLoad(r,f,u);!t||e&&e.success?n&&n.call(i,e,r,u):t.call(i,e,r,u)},failure:function(n,r){this.onLoad(n,r);t&&t.apply(i,arguments)},scope:this})):this.fireEvent("loadcanceled",this,r)},sync:function(n,t,i){if(this.activeRequests.sync){this.delayedSyncs.push(arguments);this.fireEvent("syncdelayed",this,arguments);return}var r=this.getChangeSetPackage();if(i=i||this,!r){n&&n.call(i,null,null);return}if(this.fireEvent("beforesync",this,r)===!1){this.fireEvent("synccanceled",this,r);return}this.activeRequests.sync={id:r.requestId};this.activeRequests.sync.desc=this.sendRequest({data:this.encode(r),type:"sync",success:function(r,u){var e=this.activeRequests.sync,f=this.onSync(r,u);!t||f&&f.success?n&&n.call(i,f,r,e):t.call(i,f,r,e);this.runDelayedSync()},failure:function(n,r){this.onSync(n,r);t&&t.apply(i,arguments);this.runDelayedSync()},scope:this})},runDelayedSync:function(){var n=this.delayedSyncs.shift();n&&this.sync.apply(this,n)},commit:function(){for(var n=0,t=this.stores.length;n<t;n++)this.stores[n].store.commitChanges()},reject:function(){for(var n=0,t=this.stores.length;n<t;n++)this.stores[n].store.rejectChanges()},warn:function(){if("console"in window){var n=console;n.log&&n.log.apply&&n.log.apply(n,arguments)}},isLoading:function(){return!!this.activeRequests.load}});Ext.define("Sch.app.CrudManagerDomain",{extend:Ext.app.EventDomain,singleton:!0,type:"crudmanager",prefix:"crudmanager.",constructor:function(){var n=this;n.callParent();n.monitor(Sch.crud.AbstractManager)},match:function(n,t){var i=!1,r=n.alias;return t==="*"?i=!0:r&&(i=Ext.Array.indexOf(r,this.prefix+t)>-1),i}});Ext.define("Sch.column.Day",{extend:Ext.grid.column.Column,alias:"widget.weekview-day",align:"center",start:null,end:null,draggable:!1,groupable:!1,hideable:!1,sortable:!1,menuDisabled:!0,enableLocking:!1,flex:1,resizable:!1,tdCls:"sch-timetd",initComponent:function(){var n=new Date;this.addCls("sch-daycolumn-header");this.isWeekend()&&(this.addCls("sch-daycolumn-header-weekend"),this.tdCls=(this.tdCls||"")+" sch-daycolumn-weekend");this.start.getDate()===n.getDate()&&this.start.getMonth()===n.getMonth()&&this.start.getYear()===n.getYear()&&(this.addCls("sch-daycolumn-header-today"),this.tdCls=(this.tdCls||"")+" sch-daycolumn-today");this.callParent(arguments)},isWeekend:function(){var n=this.start.getDay();return n===6||n===0}});Ext.define("Sch.column.Resource",{extend:Ext.grid.Column,alias:"widget.resourcecolumn",align:"center",menuDisabled:!0,hideable:!1,sortable:!1,locked:!1,lockable:!1,draggable:!1,enableLocking:!1,model:null,initComponent:function(){this.tdCls=(this.tdCls||"")+" sch-timetd";this.cls=(this.cls||"")+" sch-resourcecolumn-header";this.callParent(arguments)}});Ext.define("Sch.view.HorizontalTimeAxis",{extend:Ext.util.Observable,trackHeaderOver:!0,compactCellWidthThreshold:15,baseCls:"sch-column-header",tableCls:"sch-header-row",headerHtmlRowTpl:'<table border="0" cellspacing="0" cellpadding="0" style="width: {totalWidth}px; {tstyle}" class="{{tableCls}} sch-header-row-{position} {cls}"><thead><tr><tpl for="cells"><td class="{{baseCls}} {headerCls} sch-header-cell-{align}" data-date="{[fm.date(values.start, \'Ymd_His\')]}" style="position : static; text-align: {align}; width: {width}px; {style}" tabIndex="0"headerPosition="{parent.position}" headerIndex="{[xindex-1]}"><div class="sch-simple-timeheader">{header}<\/div><\/td><\/tpl><\/tr><\/thead><\/table>',model:null,hoverCls:"",containerEl:null,height:null,constructor:function(n){var t=this,r=!!Ext.versions.touch,i;Ext.apply(this,n);t.callParent(arguments);t.model.on("update",t.onModelUpdate,this,{priority:5});if(t.containerEl=Ext.get(t.containerEl),t.headerHtmlRowTpl instanceof Ext.Template||(t.headerHtmlRowTpl=t.headerHtmlRowTpl.replace("{{baseCls}}",this.baseCls).replace("{{tableCls}}",this.tableCls),t.headerHtmlRowTpl=new Ext.XTemplate(t.headerHtmlRowTpl)),t.trackHeaderOver&&t.hoverCls){t.containerEl.on({mousemove:t.highlightCell,delegate:".sch-column-header",scope:t});t.containerEl.on({mouseleave:t.clearHighlight,scope:t})}if(i={scope:this,delegate:".sch-column-header"},r?(i.tap=this.onElClick("tap"),i.doubletap=this.onElClick("doubletap")):(i.click=this.onElClick("click"),i.dblclick=this.onElClick("dblclick"),i.contextmenu=this.onElClick("contextmenu")),t._listenerCfg=i,t.containerEl)t.containerEl.on(i)},destroy:function(){var n=this;n.containerEl&&(n.containerEl.un(n._listenerCfg),n.containerEl.un({mousemove:n.highlightCell,delegate:".sch-simple-timeheader",scope:n}),n.containerEl.un({mouseleave:n.clearHighlight,scope:n}));n.model.un({update:n.onModelUpdate,scope:n})},onModelUpdate:function(){this.render()},getHTML:function(){var n=this.model.getColumnConfig(),r=this.model.getTotalWidth(),u=Ext.Object.getKeys(n).length,t=this.height?this.height/u:0,i="";return n.top&&(this.embedCellWidths(n.top),i+=this.headerHtmlRowTpl.apply({totalWidth:r,cells:n.top,position:"top",tstyle:"border-top : 0;"+(t?"height:"+t+"px":"")})),n.middle&&(this.embedCellWidths(n.middle),i+=this.headerHtmlRowTpl.apply({totalWidth:r,cells:n.middle,position:"middle",tstyle:(n.top?"":"border-top : 0;")+(t?"height:"+t+"px":""),cls:!n.bottom&&this.model.getTickWidth()<=this.compactCellWidthThreshold?"sch-header-row-compact":""})),n.bottom&&(this.embedCellWidths(n.bottom),i+=this.headerHtmlRowTpl.apply({totalWidth:r,cells:n.bottom,position:"bottom",tstyle:t?"height:"+t+"px":"",cls:this.model.getTickWidth()<=this.compactCellWidthThreshold?"sch-header-row-compact":""})),i+'<div class="sch-header-secondary-canvas"><\/div>'},render:function(){var i;if(this.containerEl){var u=this.containerEl,n=u.dom,f=n.style.display,r=this.model.getColumnConfig(),t=n.parentNode;n.style.display="none";t.removeChild(n);i=this.getHTML();n.innerHTML=i;r.top||r.middle?this.containerEl.removeCls("sch-header-single-row"):this.containerEl.addCls("sch-header-single-row");t&&t.appendChild(n);n.style.display=f;this.fireEvent("refresh",this)}},embedCellWidths:function(n){for(var t,r,u=Ext.isIE7||Ext.isSafari&&!Ext.supports.Touch?1:0,i=0;i<n.length;i++)t=n[i],r=this.model.getDistanceBetweenDates(t.start,t.end),r?t.width=r-(i?u:0):(t.width=0,t.style="display: none")},onElClick:function(n){return function(t,i){i=t.delegatedTarget||i;var u=Ext.fly(i).getAttribute("headerPosition"),f=Ext.fly(i).getAttribute("headerIndex"),r=this.model.getColumnConfig()[u][f];this.fireEvent("timeheader"+n,this,r.start,r.end,t)}},highlightCell:function(n,t){var i=this;t!==i.highlightedCell&&(i.clearHighlight(),i.highlightedCell=t,Ext.fly(t).addCls(i.hoverCls))},clearHighlight:function(){var n=this,t=n.highlightedCell;t&&(Ext.fly(t).removeCls(n.hoverCls),delete n.highlightedCell)}});Ext.define("Sch.column.timeAxis.Horizontal",{extend:Ext.grid.column.Column,alias:"widget.timeaxiscolumn",draggable:!1,groupable:!1,hideable:!1,sortable:!1,resizable:!1,menuDisabled:!0,cls:"sch-simple-timeaxis",tdCls:"sch-timetd",enableLocking:!1,timeAxisViewModel:null,headerView:null,hoverCls:"",ownHoverCls:"sch-column-header-over",trackHeaderOver:!0,compactCellWidthThreshold:Ext.theme&&Ext.theme.name.toLowerCase()==="classic"?15:35,afterRender:function(){var n=this,t=n.titleEl.createChild({cls:"sch-horizontaltimeaxis-ct"});n.headerView=new Sch.view.HorizontalTimeAxis({model:n.timeAxisViewModel,containerEl:t,hoverCls:n.ownHoverCls,trackHeaderOver:n.trackHeaderOver,compactCellWidthThreshold:n.compactCellWidthThreshold});n.headerView.on("refresh",n.onTimeAxisViewRefresh,n);n.ownerCt.on("afterlayout",function(){n.ownerCt&&(n.mon(n.ownerCt,"resize",n.onHeaderContainerResize,n),this.getWidth()>0&&(n.getAvailableWidthForSchedule()===n.timeAxisViewModel.getAvailableWidth()?n.headerView.render():n.timeAxisViewModel.update(n.getAvailableWidthForSchedule()),n.setWidth(n.timeAxisViewModel.getTotalWidth())))},null,{single:!0});this.enableBubble("timeheaderclick","timeheaderdblclick","timeheadercontextmenu");n.relayEvents(n.headerView,["timeheaderclick","timeheaderdblclick","timeheadercontextmenu"]);n.callParent(arguments);n.focusable=!1},initRenderData:function(){var n=this;return n.renderData.headerCls=n.renderData.headerCls||n.headerCls,n.callParent(arguments)},destroy:function(){this.headerView&&this.headerView.destroy();this.callParent(arguments)},onTimeAxisViewRefresh:function(){this.headerView.un("refresh",this.onTimeAxisViewRefresh,this);this.setWidth(this.timeAxisViewModel.getTotalWidth());this.headerView.on("refresh",this.onTimeAxisViewRefresh,this)},getAvailableWidthForSchedule:function(){for(var i=this.ownerCt.isVisible(!0)?this.ownerCt.getWidth():this.ownerCt.lastBox&&this.ownerCt.lastBox.width||0,r=this.ownerCt.items,n,t=1;t<r.length;t++)n=r.get(t),n.hidden||(i-=n.isVisible(!0)?n.getWidth():n.lastBox&&n.lastBox.width||0);return i-Ext.getScrollbarSize().width-1},onResize:function(){this.callParent(arguments);this.timeAxisViewModel.setAvailableWidth(this.getAvailableWidthForSchedule())},onHeaderContainerResize:function(){this.timeAxisViewModel.setAvailableWidth(this.getAvailableWidthForSchedule());this.headerView.render()},refresh:function(){this.timeAxisViewModel.update(null,!0);this.headerView.render()}});Ext.define("Sch.column.timeAxis.Vertical",{extend:Ext.grid.column.Column,alias:"widget.verticaltimeaxis",align:"right",draggable:!1,groupable:!1,hideable:!1,sortable:!1,menuDisabled:!0,timeAxis:null,timeAxisViewModel:null,cellTopBorderWidth:null,cellBottomBorderWidth:null,totalBorderWidth:null,enableLocking:!1,locked:!0,flex:1,dataIndex:"start",initComponent:function(){this.callParent(arguments);this.tdCls=(this.tdCls||"")+" sch-verticaltimeaxis-cell";this.scope=this;this.totalBorderWidth=this.cellTopBorderWidth+this.cellBottomBorderWidth},afterRender:function(){this.callParent(arguments);var n=this.up("panel");n.getView().on("resize",this.onContainerResize,this)},onContainerResize:function(n,t,i){this.timeAxisViewModel.update(i-21)},renderer:function(n,t,i,r){var u=this.timeAxisViewModel.getBottomHeader();return t.style="height:"+(this.timeAxisViewModel.getTickWidth()-this.totalBorderWidth)+"px",u.renderer?u.renderer.call(u.scope||this,i.data.start,i.data.end,t,r):Ext.Date.format(n,u.dateFormat)}});Ext.define("Sch.crud.encoder.Json",{format:"json",encode:function(n){return Ext.JSON.encode(n)},decode:function(n){return typeof n=="object"?n:Ext.JSON.decode(n,!0)}});Ext.define("Sch.crud.encoder.Xml",{format:"xml",stringReplaces:[[/&/g,"&amp;"],[/</g,"&lt;"],[/>/g,"&gt;"],[/"/g,"&quot;"]],encodeString:function(n){var i,r,t,u;if(!n)return n;for(i=n.toString(),r=this.stringReplaces,t=0,u=r.length;t<u;t++)i=i.replace(r[t][0],r[t][1]);return i},encodeRecords:function(n){for(var i="",t=0,r=n.length;t<r;t++)i+=this.encodeRecord(n[t]);return i},encodeRecord:function(n){var r="<record>",i,t;for(i in n)t=n[i],r+='<field id="'+this.encodeString(i)+'">'+(t&&t.$store?this.encodeStoreChanges({storeId:i},t):this.encodeString(t))+"<\/field>";return r+"<\/record>"},encodeStoreChanges:function(n,t){var i='<store id="'+this.encodeString(n.storeId)+'">';return t.added&&(i+="<added>"+this.encodeRecords(t.added)+"<\/added>"),t.updated&&(i+="<updated>"+this.encodeRecords(t.updated)+"<\/updated>"),t.removed&&(i+="<removed>"+this.encodeRecords(t.removed)+"<\/removed>"),i+"<\/store>"},encode:function(n){var r,i,u,t;switch(n.type){case"load":for(r='<load requestId="'+this.encodeString(n.requestId)+'">',i=0,u=n.stores.length;i<u;i++)t=n.stores[i],r+=typeof t=="string"?'<store id="'+this.encodeString(t)+'"/>':'<store id="'+this.encodeString(t.storeId)+'" page="'+this.encodeString(t.page)+'" pageSize="'+this.encodeString(t.pageSize)+'"/>';return r+"<\/load>";case"sync":r='<sync requestId="'+this.encodeString(n.requestId)+'" revision="'+this.encodeString(n.revision)+'">';for(i in n)n.hasOwnProperty(i)&&(t=this.getStore(i),t&&(r+=this.encodeStoreChanges(t,n[i])));r+="<\/sync>"}return r},stringToXML:function(n){if(n){var t;return window.DOMParser?t=(new DOMParser).parseFromString(n,"text/xml"):window.ActiveXObject&&(t=new ActiveXObject("Microsoft.XMLDOM"),t.async=!1,t.loadXML(n)),t}},decodeRecords:function(n){for(var i=[],t=0,r=n.length;t<r;t++)i.push(this.decodeRecord(n[t]));return i},decodeRecord:function(n){for(var t,i,f=n.childNodes,e={},r,u=0,o=f.length;u<o;u++)t=f[u],t.nodeName=="field"&&(r="",t.firstChild&&(i=this.getElementByTagName(t,"store"),r=i?this.decodeStore(i):t.firstChild.nodeValue),e[t.getAttribute("id")]=r);return e},getElementsByTagName:function(n,t){for(var r=n.childNodes,u=[],i=0,f=r.length;i<f;i++)r[i].nodeName==t&&u.push(r[i]);return u},getElementByTagName:function(n,t){for(var r=n.childNodes,i=0,u=r.length;i<u;i++)if(r[i].nodeName==t)return r[i]},decodeStore:function(n){var t={},r=this.getElementsByTagName(n,"rows"),i,u;return r.length&&(t.rows=this.decodeRecords(this.getElementsByTagName(r[0],"record")),i=parseInt(r[0].getAttribute("total"),10),(isNaN(i)||i<t.rows.length)&&(i=t.rows.length),t.total=i),u=this.getElementByTagName(n,"removed"),u&&(t.removed=this.decodeRecords(this.getElementsByTagName(u,"record"))),t},decode:function(n){var o=typeof n=="string"?this.stringToXML(n):n,r,u,s;if(o){var t={},i=o.documentElement,h=i.getElementsByTagName("store"),f,e;for(t.requestId=i.getAttribute("requestId"),t.revision=i.getAttribute("revision"),t.success=i.getAttribute("success")||"false",t.success=t.success.toLowerCase()=="true",t.success||(t.code=i.getAttribute("code"),r=i.getElementsByTagName("message")[0],t.message=r&&r.firstChild&&r.firstChild.nodeValue),u=0,s=h.length;u<s;u++)f=h[u],e=f.getAttribute("id"),this.getStore(e)&&(t[e]=this.decodeStore(f));return t}}});Ext.define("Sch.crud.transport.Ajax",{defaultMethod:{load:"GET",sync:"POST"},cancelRequest:function(n){Ext.Ajax.abort(n)},sendRequest:function(n){var r=n.data,i=this.transport[n.type],u=i.paramName,f=Ext.apply({},i&&i.params),e=i.method||this.defaultMethod[n.type],t=Ext.apply({url:i.url,method:e,params:f,failure:n.failure,success:function(t){n.success&&n.success.call(n.scope||this,t.responseXml||t.responseText)},scope:n.scope},i.requestConfig);return u?(t.params=t.params||{},t.params[u]=r):this.format==="xml"?Ext.apply(t,{xmlData:r}):Ext.apply(t,{jsonData:r}),this.fireEvent("beforesend",this,f,n.type,t),Ext.Ajax.request(t)}});Ext.define("Sch.data.mixin.UniversalModelGetter",{getModelById:function(n){var t=this;return t.getNodeById?t.getNodeById(n):t.getById(n)},getModelByInternalId:function(n){var t=this;return t.byInternalIdMap?t.byInternalIdMap[n]:t.getByInternalId(n)}});Ext.define("Sch.data.mixin.CacheHintHelper",{extend:Ext.Mixin,mixinConfig:{before:{loadRecords:"loadRecords",removeAll:"removeAll"}},loadRecords:function(){this.fireEvent("cacheresethint",this)},removeAll:function(n){n&&this.fireEvent("cacheresethint",this)}});Ext.define("Robo.data.Store",{extend:Ext.Mixin,undoRedoPostponed:null,inUndoRedoTransaction:!1,undoRedoEventBus:null,mixinConfig:{before:{constructor:"constructor",destroy:"destroy",fireEventArgs:"fireEventArgs",setRoot:"beforeSetRoot",fillNode:"beforeFillNode"},after:{setRoot:"afterSetRoot",fillNode:"afterFillNode"}},constructor:function(){var n=this;n.undoRedoEventBus=new Ext.util.Observable},destroy:function(){Ext.destroy(this.undoRedoEventBus)},fireEventArgs:function(n,t){var i=this;t.hasOwnProperty("$undoRedoEventBusFired")||(t.$undoRedoEventBusFired={});t.$undoRedoEventBusFired[n]||(t.$undoRedoEventBusFired[n]=!0,i.undoRedoEventBus.hasListener(n)&&i.undoRedoEventBus.fireEventArgs(n,t))},isInUndoRedoTransaction:function(){return this.inUndoRedoTransaction},onUndoRedoTransactionStart:function(){this.inUndoRedoTransaction=!0},onUndoRedoTransactionEnd:function(){this.inUndoRedoTransaction=!1},isUndoingOrRedoing:function(){return!!this.undoRedoPostponed},beforeUndoRedo:function(){this.undoRedoPostponed=[]},afterUndoRedo:function(){var n=this;Ext.Array.forEach(n.undoRedoPostponed,function(n){n()});n.undoRedoPostponed=null},postponeAfterUndoRedo:function(n){Ext.Assert&&Ext.Assert.isFunction(n,"Parameter must be a function");this.undoRedoPostponed.push(n)},beforeSetRoot:function(){this.__isSettingRoot=!0},afterSetRoot:function(){this.__isSettingRoot=!1;this.getRoot()||this.fireEvent("clear",this)},beforeFillNode:function(n){n.isRoot()&&this.beforeSetRoot()},afterFillNode:function(n){n.isRoot()&&this.afterSetRoot()},isRootSettingOrLoading:function(){return this.isLoading()||this.isTreeStore&&this.__isSettingRoot}});Ext.define("Robo.data.Model",{extend:Ext.Mixin,modelName:null,editMementoFix:null,mixinConfig:{before:{endEdit:"onBeforeEndEdit"},after:{endEdit:"onAfterEndEdit"}},onBeforeEndEdit:function(n,t){var i=this.editMemento;i&&(this.editMementoFix=i,t||(t=this.getModifiedFieldNames(i.data)),i.previousValues||(i.previousValues={}),Ext.Array.each(t,function(n){i.previousValues[n]=i.data[n]}))},onAfterEndEdit:function(){delete this.editMementoFix},getTitle:function(){return""}});Ext.define("Sch.model.Customizable",function(){return{extend:Ext.data.Model,mixins:{robo:Robo.data.Model},customizableFields:null,previous:null,__editing:null,__editCounter:0,constructor:function(){return this.callParent(arguments)},set:function(n,t){var i,f,u,r;if(this.previous=this.previous||{},typeof n=="string")if(i=this.get(n),i instanceof Date&&!(t instanceof Date)&&(t=this.getField(n).convert(t,this)),i instanceof Date&&i-t||!(i instanceof Date)&&i!==t)this.previous[n]=i;else return[];else for(u in n)i=this.get(u),r=n[u],i instanceof Date&&!(r instanceof Date)&&(r=this.getField(u).convert(r,this)),(i instanceof Date&&i-r||!(i instanceof Date)&&i!==r)&&(this.previous[u]=i);return f=this.callParent(arguments),this.__editing||delete this.previous,f},reject:function(){var n=this,i=n.modified||{},t;n.__editing=!0;n.previous=n.previous||{};for(t in i)i.hasOwnProperty(t)&&typeof i[t]!="function"&&(n.previous[t]=n.get(t));n.callParent(arguments);delete n.previous;n.__editing=!1},beginEdit:function(){this.__editCounter++;this.__editing=!0;this.callParent(arguments)},cancelEdit:function(){this.__editCounter=0;this.__editing=!1;this.callParent(arguments);delete this.previous},endEdit:function(n,t){if(--this.__editCounter==0){if(!n&&this.getModifiedFieldNames){var i=this.editMemento;t||(t=this.getModifiedFieldNames(i.data));t&&t.length===0&&(n=!0)}this.callParent([n].concat(Array.prototype.slice.call(arguments,1)));this.__editing=!1;delete this.previous}}}},function(n){n.onExtended(function(n,t,i){var r=i.onBeforeCreated;i.onBeforeCreated=function(n){var t;if(r.apply(this,arguments),t=n.prototype,t.customizableFields){t.customizableFields=(n.superclass.customizableFields||[]).concat(t.customizableFields);var u=t.customizableFields,f={},s=this,e=Ext.Array.findBy(n.fields,function(n){return n.name===t.idProperty});s.idField=t.idField=e;n.fieldsMap[t.idProperty]||(n.fieldsMap[t.idProperty]=e);Ext.Array.each(u,function(n){typeof n=="string"&&(n={name:n});f[n.name]=n});var h=t.fields,o=[],i=[];Ext.Array.each(h,function(n){n.isCustomizableField&&i.push(n.getName())});t.idProperty!=="id"&&t.getField("id")&&(t.getField("id").hasOwnProperty("name")||i.push("id"));t.idProperty!=="Id"&&t.getField("Id")&&(t.getField("Id").hasOwnProperty("name")||i.push("Id"));n.removeFields(i);Ext.Object.each(f,function(n,i){var c,e,s;i.isCustomizableField=!0;var h=i.name||i.getName(),l=h==="Id"?"idProperty":h.charAt(0).toLowerCase()+h.substr(1)+"Field",a=t[l],r=a||h,f;t.getField(r)?(f=Ext.applyIf({name:h,isCustomizableField:!0},t.getField(r)),t.getField(r).isCustomizableField=!0,f=Ext.create("data.field."+(f.type||"auto"),f),u.push(f)):(f=Ext.applyIf({name:r,isCustomizableField:!0},i),f=Ext.create("data.field."+(f.type||"auto"),f),o.push(f));c=Ext.String.capitalize(h);c!="Id"&&(e="get"+c,s="set"+c,(!t[e]||t[e].__getterFor__&&t[e].__getterFor__!=r)&&(t[e]=function(){return this.get(this[l]||r)},t[e].__getterFor__=r),(!t[s]||t[s].__setterFor__&&t[s].__setterFor__!=r)&&(t[s]=function(n){return this.set(this[l]||r,n)},t[s].__setterFor__=r))});n.addFields(o)}}})});Ext.define("Sch.model.Assignment",{extend:Sch.model.Customizable,idProperty:"Id",customizableFields:[{name:"ResourceId"},{name:"EventId"}],resourceIdField:"ResourceId",eventIdField:"EventId",getInternalId:function(){return this.internalId},getAssignmentStore:function(){return this.joined&&this.joined[0]},getEventStore:function(){var n=this.getAssignmentStore();return n&&n.getEventStore()},getResourceStore:function(){var n=this.getEventStore();return n&&n.getResourceStore()},getEvent:function(n){var t=this;return n=n||t.getEventStore(),n&&n.getModelById(t.getEventId())},getResource:function(n){var t=this;return n=n||t.getResourceStore(),n&&n.getModelById(t.getResourceId())},getEventName:function(n){var t=this.getEvent(n);return t&&t.getName()||""},getResourceName:function(n){var t=this.getResource(n);return t&&t.getName()||""},isPersistable:function(){var n=this,t=n.getEvent(),i=n.getResource();return t&&!t.phantom&&i&&!i.phantom},fullCopy:function(){return this.copy.apply(this,arguments)}});Ext.define("Sch.locale.Locale",{l10n:null,legacyMode:!0,localeName:null,namespaceId:null,constructor:function(){var n,i,t;Sch.locale.Active||(Sch.locale.Active={},this.bindRequire());n=this.self.getName().split(".");i=this.localeName=n.pop();this.namespaceId=n.join(".");t=Sch.locale.Active[this.namespaceId];i=="En"&&t&&t.localeName!="En"||this.apply()},bindRequire:function(){var n=Ext.ClassManager.triggerCreated;Ext.ClassManager.triggerCreated=function(t){var i,r;if(n.apply(this,arguments),t){i=Ext.ClassManager.get(t);for(r in Sch.locale.Active)Sch.locale.Active[r].apply(i)}}},applyToClass:function(n,t){var f=this,e=f.self.getName(),r,i,u;if(t=t||Ext.ClassManager.get(n),t&&t.activeLocaleId!==e){if(r=f.l10n[n],typeof r=="function"?r(n):t.singleton?t.l10n=Ext.apply({},r,t.prototype&&t.prototype.l10n):Ext.override(t,{l10n:r}),f.legacyMode&&(t.prototype?i=t.prototype:t.singleton&&(i=t),i&&i.legacyMode)){i.legacyHolderProp&&(i[i.legacyHolderProp]||(i[i.legacyHolderProp]={}),i=i[i.legacyHolderProp]);for(u in r)typeof i[u]!="function"&&(i[u]=r[u])}t.activeLocaleId=e;t.onLocalized&&t.onLocalized()}},apply:function(n){var u,i,r,t,f,e;if(this.l10n)if(u=this,n)for(Ext.isArray(n)||(n=[n]),t=0,f=n.length;t<f;t++)Ext.isObject(n[t])?n[t].singleton?(r=n[t],i=Ext.getClassName(Ext.getClass(r))):(r=Ext.getClass(n[t]),i=Ext.getClassName(r)):(r=null,i="string"==typeof n[t]?n[t]:Ext.getClassName(n[t])),i&&i in this.l10n&&u.applyToClass(i,r);else{Sch.locale.Active[this.namespaceId]=this;for(e in this.l10n)u.applyToClass(e)}}});Ext.define("Sch.locale.En",{extend:Sch.locale.Locale,singleton:!0,constructor:function(){Ext.apply(this,{l10n:{"Sch.util.Date":{unitNames:{YEAR:{single:"year",plural:"years",abbrev:"yr"},QUARTER:{single:"quarter",plural:"quarters",abbrev:"q"},MONTH:{single:"month",plural:"months",abbrev:"mon"},WEEK:{single:"week",plural:"weeks",abbrev:"w"},DAY:{single:"day",plural:"days",abbrev:"d"},HOUR:{single:"hour",plural:"hours",abbrev:"h"},MINUTE:{single:"minute",plural:"minutes",abbrev:"min"},SECOND:{single:"second",plural:"seconds",abbrev:"s"},MILLI:{single:"ms",plural:"ms",abbrev:"ms"}}},"Sch.panel.TimelineGridPanel":{weekStartDay:1,loadingText:"Loading, please wait...",savingText:"Saving changes, please wait..."},"Sch.panel.TimelineTreePanel":{weekStartDay:1,loadingText:"Loading, please wait...",savingText:"Saving changes, please wait..."},"Sch.mixin.SchedulerView":{loadingText:"Loading events..."},"Sch.plugin.CurrentTimeLine":{tooltipText:"Current time"},"Sch.plugin.EventEditor":{saveText:"Save",deleteText:"Delete",cancelText:"Cancel"},"Sch.plugin.SimpleEditor":{newEventText:"New booking..."},"Sch.widget.ExportDialogForm":{formatFieldLabel:"Paper format",orientationFieldLabel:"Orientation",rangeFieldLabel:"Schedule range",showHeaderLabel:"Add page number",showFooterLabel:"Add footer",orientationPortraitText:"Portrait",orientationLandscapeText:"Landscape",completeViewText:"Complete schedule",currentViewText:"Visible schedule",dateRangeText:"Date range",dateRangeFromText:"Export from",dateRangeToText:"Export to",exportersFieldLabel:"Control pagination",adjustCols:"Adjust column width",adjustColsAndRows:"Adjust column width and row height",specifyDateRange:"Specify date range",columnPickerLabel:"Select columns",completeDataText:"Complete schedule (for all events)",dpiFieldLabel:"DPI (dots per inch)",rowsRangeLabel:"Rows range",allRowsLabel:"All rows",visibleRowsLabel:"Visible rows"},"Sch.widget.ExportDialog":{title:"Export Settings",exportButtonText:"Export",cancelButtonText:"Cancel",progressBarText:"Exporting..."},"Sch.plugin.Export":{generalError:"An error occurred",fetchingRows:"Fetching row {0} of {1}",builtPage:"Built page {0} of {1}",requestingPrintServer:"Please wait..."},"Sch.plugin.Printable":{dialogTitle:"Print settings",exportButtonText:"Print"},"Sch.plugin.exporter.AbstractExporter":{name:"Exporter"},"Sch.plugin.exporter.SinglePage":{name:"Single page"},"Sch.plugin.exporter.MultiPageVertical":{name:"Multiple pages (vertically)"},"Sch.plugin.exporter.MultiPage":{name:"Multiple pages"},"Sch.preset.Manager":{hourAndDay:{displayDateFormat:"G:i",middleDateFormat:"G:i",topDateFormat:"D d/m"},secondAndMinute:{displayDateFormat:"g:i:s",topDateFormat:"D, d g:iA"},dayAndWeek:{displayDateFormat:"m/d h:i A",middleDateFormat:"D d M"},weekAndDay:{displayDateFormat:"m/d",bottomDateFormat:"d M",middleDateFormat:"Y F d"},weekAndMonth:{displayDateFormat:"m/d/Y",middleDateFormat:"m/d",topDateFormat:"m/d/Y"},weekAndDayLetter:{displayDateFormat:"m/d/Y",middleDateFormat:"D d M Y"},weekDateAndMonth:{displayDateFormat:"m/d/Y",middleDateFormat:"d",topDateFormat:"Y F"},monthAndYear:{displayDateFormat:"m/d/Y",middleDateFormat:"M Y",topDateFormat:"Y"},year:{displayDateFormat:"m/d/Y",middleDateFormat:"Y"},manyYears:{displayDateFormat:"m/d/Y",middleDateFormat:"Y"}}}});this.callParent(arguments)}});Ext.define("Sch.mixin.Localizable",{legacyMode:!1,activeLocaleId:"",l10n:null,isLocaleApplied:function(){var n=this.singleton&&this.activeLocaleId||this.self.activeLocaleId,t;if(!n)return!1;for(t in Sch.locale.Active)if(n===Sch.locale.Active[t].self.getName())return!0;return!1},applyLocale:function(){for(var n in Sch.locale.Active)Sch.locale.Active[n].apply(this.singleton?this:this.self.getName())},L:function(){return this.localize.apply(this,arguments)},localize:function(n,t,i){var r,f,e,o,u,s;if(this.isLocaleApplied()||i||this.applyLocale(),this.hasOwnProperty("l10n")&&this.l10n.hasOwnProperty(n)&&"function"!=typeof this.l10n[n])return this.l10n[n];if(r=this.self&&this.self.prototype,this.legacyMode){if(f=t||this.legacyHolderProp,e=f?this[f]:this,e&&e.hasOwnProperty(n)&&"function"!=typeof e[n])return e[n];if(r&&(o=f?r[f]:r,o&&o.hasOwnProperty(n)&&"function"!=typeof o[n]))return o[n]}if(u=r.l10n&&r.l10n[n],(u===null||u===undefined)&&(s=r&&r.superclass,s&&s.localize&&(u=s.localize(n,t,i)),u===null||u===undefined))throw"Cannot find locale: "+n+" ["+this.self.getName()+"]";return u}});Ext.define("Sch.util.Date",{mixins:[Sch.mixin.Localizable],singleton:!0,stripEscapeRe:/(\\.)/g,hourInfoRe:/([gGhHisucUOPZ]|MS)/,unitHash:null,unitsByName:{},constructor:function(){var t=Ext.Date,i=this.unitHash={MILLI:t.MILLI,SECOND:t.SECOND,MINUTE:t.MINUTE,HOUR:t.HOUR,DAY:t.DAY,WEEK:"w",MONTH:t.MONTH,QUARTER:"q",YEAR:t.YEAR},n;Ext.apply(this,i);n=this;this.units=[n.MILLI,n.SECOND,n.MINUTE,n.HOUR,n.DAY,n.WEEK,n.MONTH,n.QUARTER,n.YEAR]},onLocalized:function(){this.setUnitNames(this.L("unitNames"))},setUnitNames:function(n){var u=this.unitsByName={},r,t,i;this.l10n.unitNames=n;this._unitNames=Ext.apply({},n);r=this.unitHash;for(t in r)r.hasOwnProperty(t)&&(i=r[t],this._unitNames[i]=this._unitNames[t],u[t]=i,u[i]=i)},betweenLesser:function(n,t,i){var r=n.getTime();return t.getTime()<=r&&r<i.getTime()},constrain:function(n,t,i){return this.min(this.max(n,t),i)},compareUnits:function(n,t){var i=Ext.Array.indexOf(this.units,n),r=Ext.Array.indexOf(this.units,t);return i>r?1:i<r?-1:0},isUnitGreater:function(n,t){return this.compareUnits(n,t)>0},copyTimeValues:function(n,t){n.setHours(t.getHours());n.setMinutes(t.getMinutes());n.setSeconds(t.getSeconds());n.setMilliseconds(t.getMilliseconds())},add:function(n,t,i){var r=Ext.Date.clone(n),u;if(!t||i===0)return r;switch(t.toLowerCase()){case this.MILLI:r=new Date(n.getTime()+i);break;case this.SECOND:r=new Date(n.getTime()+i*1e3);break;case this.MINUTE:r=new Date(n.getTime()+i*6e4);break;case this.HOUR:r=new Date(n.getTime()+i*36e5);break;case this.DAY:r.setDate(n.getDate()+i);r.getHours()===23&&n.getHours()===0&&(r=Ext.Date.add(r,Ext.Date.HOUR,1));break;case this.WEEK:r.setDate(n.getDate()+i*7);break;case this.MONTH:u=n.getDate();u>28&&(u=Math.min(u,Ext.Date.getLastDateOfMonth(this.add(Ext.Date.getFirstDateOfMonth(n),this.MONTH,i)).getDate()));r.setDate(u);r.setMonth(r.getMonth()+i);break;case this.QUARTER:r=this.add(n,this.MONTH,i*3);break;case this.YEAR:r.setFullYear(n.getFullYear()+i)}return r},getUnitDurationInMs:function(n){return this.add(new Date(1,0,1),n,1)-new Date(1,0,1)},getMeasuringUnit:function(n){return n===this.WEEK?this.DAY:n},getDurationInUnit:function(n,t,i,r){var u;switch(i){case this.YEAR:u=this.getDurationInYears(n,t);break;case this.QUARTER:u=this.getDurationInMonths(n,t)/3;break;case this.MONTH:u=this.getDurationInMonths(n,t);break;case this.WEEK:u=this.getDurationInDays(n,t)/7;break;case this.DAY:u=this.getDurationInDays(n,t);break;case this.HOUR:u=this.getDurationInHours(n,t);break;case this.MINUTE:u=this.getDurationInMinutes(n,t);break;case this.SECOND:u=this.getDurationInSeconds(n,t);break;case this.MILLI:u=this.getDurationInMilliseconds(n,t)}return r?u:Math.round(u)},getUnitToBaseUnitRatio:function(n,t){if(n===t)return 1;switch(n){case this.YEAR:switch(t){case this.QUARTER:return 1/4;case this.MONTH:return 1/12}break;case this.QUARTER:switch(t){case this.YEAR:return 4;case this.MONTH:return 1/3}break;case this.MONTH:switch(t){case this.YEAR:return 12;case this.QUARTER:return 3}break;case this.WEEK:switch(t){case this.DAY:return 1/7;case this.HOUR:return 1/168}break;case this.DAY:switch(t){case this.WEEK:return 7;case this.HOUR:return 1/24;case this.MINUTE:return 1/1440}break;case this.HOUR:switch(t){case this.DAY:return 24;case this.MINUTE:return 1/60}break;case this.MINUTE:switch(t){case this.HOUR:return 60;case this.SECOND:return 1/60;case this.MILLI:return 1/6e4}break;case this.SECOND:switch(t){case this.MILLI:return 1/1e3}break;case this.MILLI:switch(t){case this.SECOND:return 1e3}}return-1},getDurationInMilliseconds:function(n,t){return t-n},getDurationInSeconds:function(n,t){return(t-n)/1e3},getDurationInMinutes:function(n,t){return(t-n)/6e4},getDurationInHours:function(n,t){return(t-n)/36e5},getDurationInDays:function(n,t){var i=n.getTimezoneOffset()-t.getTimezoneOffset();return(t-n+i*6e4)/864e5},getDurationInMonths:function(n,t){return(t.getFullYear()-n.getFullYear())*12+(t.getMonth()-n.getMonth())},getDurationInYears:function(n,t){return this.getDurationInMonths(n,t)/12},min:function(n,t){return n<t?n:t},max:function(n,t){return n>t?n:t},intersectSpans:function(n,t,i,r){return this.betweenLesser(n,i,r)||this.betweenLesser(i,n,t)},getNameOfUnit:function(n){n=this.getUnitByName(n);switch(n.toLowerCase()){case this.YEAR:return"YEAR";case this.QUARTER:return"QUARTER";case this.MONTH:return"MONTH";case this.WEEK:return"WEEK";case this.DAY:return"DAY";case this.HOUR:return"HOUR";case this.MINUTE:return"MINUTE";case this.SECOND:return"SECOND";case this.MILLI:return"MILLI"}throw"Incorrect UnitName";},getReadableNameOfUnit:function(n,t){return this.isLocaleApplied()||this.applyLocale(),this._unitNames[n][t?"plural":"single"]},getShortNameOfUnit:function(n){return this.isLocaleApplied()||this.applyLocale(),this._unitNames[n].abbrev},getUnitByName:function(n){return this.isLocaleApplied()||this.applyLocale(),this.unitsByName[n]||Ext.Error.raise("Unknown unit name: "+n),this.unitsByName[n]},getNext:function(n,t,i,r){var u=Ext.Date.clone(n),e,f;r=arguments.length<4?1:r;i=i==null?1:i;switch(t){case this.MILLI:u=this.add(n,t,i);break;case this.SECOND:u=this.add(n,t,i);u.getMilliseconds()>0&&u.setMilliseconds(0);break;case this.MINUTE:u=this.add(n,t,i);u.getSeconds()>0&&u.setSeconds(0);u.getMilliseconds()>0&&u.setMilliseconds(0);break;case this.HOUR:u=this.add(n,t,i);u.getMinutes()>0&&u.setMinutes(0);u.getSeconds()>0&&u.setSeconds(0);u.getMilliseconds()>0&&u.setMilliseconds(0);break;case this.DAY:if(e=n.getHours()===23&&this.add(u,this.HOUR,1).getHours()===1,e)return u=this.add(u,this.DAY,2),this.clearTime(u),u;this.clearTime(u);u=this.add(u,this.DAY,i);u.getHours()===1&&this.clearTime(u);break;case this.WEEK:this.clearTime(u);f=u.getDay();u=this.add(u,this.DAY,r-f+7*(i-(r<=f?0:1)));u.getDay()!==r?u=this.add(u,this.HOUR,1):this.clearTime(u);break;case this.MONTH:u=this.add(u,this.MONTH,i);u.setDate(1);this.clearTime(u);break;case this.QUARTER:u=this.add(u,this.MONTH,(i-1)*3+(3-u.getMonth()%3));this.clearTime(u);u.setDate(1);break;case this.YEAR:u=new Date(u.getFullYear()+i,0,1);break;default:throw"Invalid date unit";}return u},getNumberOfMsFromTheStartOfDay:function(n){return n-this.clearTime(n,!0)||864e5},getNumberOfMsTillTheEndOfDay:function(n){return this.getStartOfNextDay(n,!0)-n},getStartOfNextDay:function(n,t,i){var r=this.add(i?n:this.clearTime(n,t),this.DAY,1),u,f;return r.getDate()==n.getDate()&&(u=this.add(this.clearTime(n,t),this.DAY,2).getTimezoneOffset(),f=n.getTimezoneOffset(),r=this.add(r,this.MINUTE,f-u)),r},getEndOfPreviousDay:function(n,t){var i=t?n:this.clearTime(n,!0);return i-n?i:this.add(i,this.DAY,-1)},timeSpanContains:function(n,t,i,r){return i-n>=0&&t-r>=0},compareWithPrecision:function(n,t,i){var r=Sch.util.Date,u=Ext.Date,f;switch(i){case r.DAY:n=Number(u.format(n,"Ymd"));t=Number(u.format(t,"Ymd"));break;case r.WEEK:n=Number(u.format(n,"YmW"));t=Number(u.format(t,"YmW"));break;case r.MONTH:n=Number(u.format(n,"Ym"));t=Number(u.format(t,"Ym"));break;case r.QUARTER:n=n.getFullYear()*4+Math.floor(n.getMonth()/3);t=t.getFullYear()*4+Math.floor(t.getMonth()/3);break;case r.YEAR:n=n.getFullYear();t=t.getFullYear();break;default:case r.MILLI:case r.SECOND:case r.MINUTE:case r.HOUR:i=i&&this.getUnitDurationInMs(i)||1;n=Math.floor(n.valueOf()/i);t=Math.floor(t.valueOf()/i)}return n<t&&(f=-1)||n>t&&(f=1)||(f=0),f},getValueInUnits:function(n,t){switch(t){case this.MONTH:return n.getMonth();case this.DAY:return n.getDate();case this.HOUR:return n.getHours();case this.MINUTE:return n.getMinutes();case this.SECOND:return n.getSeconds()}},setValueInUnits:function(n,t,i){var u=Ext.Date.clone(n),r;switch(t){case this.YEAR:r="setFullYear";break;case this.MONTH:r="setMonth";break;case this.DAY:r="setDate";break;case this.HOUR:r="setHours";break;case this.MINUTE:r="setMinutes";break;case this.SECOND:r="setSeconds";break;case this.MILLI:r="setMilliseconds"}return u[r](i),u},getSubUnit:function(n){switch(n){case this.YEAR:return this.MONTH;case this.MONTH:return this.DAY;case this.DAY:return this.HOUR;case this.HOUR:return this.MINUTE;case this.MINUTE:return this.SECOND;case this.SECOND:return this.MILLI}},setValueInSubUnits:function(n,t,i){return t=this.getSubUnit(t),this.setValueInUnits(n,t,i)},mergeDates:function(n,t,i){var r=Ext.Date.clone(n);switch(i){case this.YEAR:r.setFullYear(t.getFullYear());case this.MONTH:r.setMonth(t.getMonth());case this.WEEK:case this.DAY:i===this.WEEK?r=this.add(r,this.DAY,t.getDay()-r.getDay()):r.setDate(t.getDate());case this.HOUR:r.setHours(t.getHours());case this.MINUTE:r.setMinutes(t.getMinutes());case this.SECOND:r.setSeconds(t.getSeconds());case this.MILLI:r.setMilliseconds(t.getMilliseconds())}return r},splitToSubUnits:function(n,t,i,r){i=i||1;r=arguments.length<4?1:r;switch(t){case this.MONTH:return this.splitMonth(n,i,r);case this.WEEK:case this.DAY:return this.splitDay(n,i)}},splitYear:function(n,t){var r=this.clearTime(n,!0),u,i;for(r.setMonth(0),r.setDate(1),u=[],i=0;i<=12;i=i+t)u.push(this.add(r,this.MONTH,i));return u},splitMonth:function(n,t,i){var r=this.clearTime(n,!0),u;r.setDate(1);r=this.add(r,this.DAY,i-r.getDay());var f=Ext.Date.clone(r),o=this.add(r,this.MONTH,1),e=[];for(u=0;f.getTime()<o.getTime();u=u+t)f=this.add(r,this.WEEK,u),e.push(f);return e},splitWeek:function(n,t,i){var u=this.add(n,this.DAY,i-n.getDay()),f,r;for(u=this.clearTime(u),f=[],r=0;r<=7;r=r+t)f.push(this.add(u,this.DAY,r));return f},splitDay:function(n,t){for(var u=this.clearTime(n,!0),r=[],i=0;i<=24;i=i+t)r.push(this.add(u,this.HOUR,i));return r},splitHour:function(n,t){var r=new Date(n.getTime()),u,i;for(r.setMinutes(0),r.setSeconds(0),r.setMilliseconds(0),u=[],i=0;i<=60;i=i+t)u.push(this.add(r,this.MINUTE,i));return u},splitMinute:function(n,t){var r=Ext.Date.clone(n),u,i;for(r.setSeconds(0),r.setMilliseconds(0),u=[],i=0;i<=60;i=i+t)u.push(this.add(r,this.SECOND,i));return u},clearTime:function(n,t){return n.getHours()>0||n.getMinutes()>0||n.getSeconds()>0?Ext.Date.clearTime(n,t):t?Ext.Date.clone(n):n}});Ext.define("Sch.model.Range",{extend:Sch.model.Customizable,idProperty:"Id",config:Ext.versions.touch?{idProperty:"Id"}:null,startDateField:"StartDate",endDateField:"EndDate",nameField:"Name",clsField:"Cls",customizableFields:[{name:"StartDate",type:"date",dateFormat:"c"},{name:"EndDate",type:"date",dateFormat:"c"},{name:"Cls",type:"string"},{name:"Name",type:"string"}],setStartDate:function(n,t){var i=this.getEndDate(),r=this.getStartDate();this.set(this.startDateField,n);t===!0&&i&&r&&this.setEndDate(Sch.util.Date.add(n,Sch.util.Date.MILLI,i-r))},setEndDate:function(n,t){var i=this.getStartDate(),r=this.getEndDate();this.set(this.endDateField,n);t===!0&&i&&r&&this.setStartDate(Sch.util.Date.add(n,Sch.util.Date.MILLI,-(r-i)))},setStartEndDate:function(n,t){this.beginEdit();this.set(this.startDateField,n);this.set(this.endDateField,t);this.endEdit()},getDates:function(){for(var t=[],i=this.getEndDate(),n=Ext.Date.clearTime(this.getStartDate(),!0);n<i;n=Sch.util.Date.add(n,Sch.util.Date.DAY,1))t.push(n);return t},forEachDate:function(n,t){return Ext.Array.each(this.getDates(),n,t)},isValid:function(){var n=this.callParent(arguments),t,i;return n&&(t=this.getStartDate(),i=this.getEndDate(),n=!t||!i||i-t>=0),n},shift:function(n,t){this.setStartEndDate(Sch.util.Date.add(this.getStartDate(),n,t),Sch.util.Date.add(this.getEndDate(),n,t))},fullCopy:function(){return this.copy.apply(this,arguments)},intersectsRange:function(n,t){var i=this.getStartDate(),r=this.getEndDate();return i&&r&&Sch.util.Date.intersectSpans(i,r,n,t)}});Ext.define("Sch.model.Resource",{extend:Sch.model.Customizable,idProperty:"Id",config:Ext.versions.touch?{idProperty:"Id"}:null,nameField:"Name",customizableFields:[{name:"Name",type:"string"}],getInternalId:function(){return this.internalId},getResourceStore:function(){return this.joined&&this.joined[0]},getEventStore:function(){var n=this.getResourceStore();return n&&n.getEventStore()||this.parentNode&&this.parentNode.getEventStore()},getAssignmentStore:function(){var n=this.getEventStore();return n&&n.getAssignmentStore()},getEvents:function(n){var t=this;return n=n||t.getEventStore(),n&&n.getEventsForResource(t)||[]},getAssignments:function(){var n=this,t=n.getEventStore();return t&&t.getAssignmentsForResource(n)},isPersistable:function(){var n=this.parentNode;return!n||!n.phantom||n.isRoot&&n.isRoot()}});Ext.define("Sch.util.Cache",{cache:null,constructor:function(){this.cache={}},key:function(n){return n instanceof Ext.data.Model?n.getId().toString():n===undefined||n===null?"[ undefined / null ]":n.toString()},get:function(n,t){var r=this,i;return n=r.key(n),i=r.cache.hasOwnProperty(n)&&r.cache[n],!i&&t?i=t():i||(i=[]),r.cache[n]=i,i},add:function(n,t){var i=this,r=i.key(n);return i.cache.hasOwnProperty(r)||(i.cache[r]=i.get(n)),Ext.Array.include(i.cache[r],t),i},remove:function(n,t){var i=this;return n=i.key(n),i.cache.hasOwnProperty(n)&&Ext.Array.remove(i.cache[n],t),i},move:function(n,t,i){var r=this;n=r.key(n);t=r.key(t);n!=t&&arguments.length>=3?(r.remove(n,i),r.add(t,i)):n!=t&&r.cache.hasOwnProperty(n)&&r.cache.hasOwnProperty(t)?(r.cache[t]=Ext.Array.union(r.cache[t],r.cache[n]),r.cache[n]=[]):n!=t&&r.cache.hasOwnProperty(n)&&(r.cache[t]=r.cache[n],r.cache[n]=[])},clear:function(n){var t=this;return arguments.length?(n=t.key(n),t.cache.hasOwnProperty(n)&&delete t.cache[n]):t.cache={},t},uncache:function(n){var t=this;for(var i in t.cache)t.cache.hasOwnProperty(i)&&(t.cache[i]=Ext.Array.remove(t.cache[i],n));return t}});Ext.define("Sch.data.util.EventAssignmentsCache",{extend:Sch.util.Cache,assignmentStore:null,assignmentStoreDetacher:null,eventStoreDetacher:null,constructor:function(n){function f(n,i){Ext.Array.each(i,function(n){t.add(n.getEventId(),n)})}function e(n,i){Ext.Array.each(i,function(n){t.remove(n.getEventId(),n)})}function o(n,i){var r=i.eventIdField,u=i.previous&&r in i.previous,f=u&&i.previous[r];u&&t.move(f,i.getEventId(),i)}function i(){t.clear()}function s(n,i){t.clear();u(i)}function h(n,i,r,u){t.move(r,u)}function c(n,i){Ext.Array.each(i,function(n){t.clear(n)})}function r(){t.clear()}function u(n){Ext.destroy(t.eventStoreDetacher);t.eventStoreDetacher=n&&n.on({idchanged:h,remove:c,cacheresethint:r,clear:r,rootchange:r,priority:100,destroyable:!0})}var t=this,l=n.getEventStore();t.callParent();t.assignmentStoreDetacher=n.on({add:f,remove:e,update:o,cacheresethint:i,clear:i,eventstorechange:s,priority:100,destroyable:!0});t.assignmentStoreFiltersDetacher=n.getFilters().on("endupdate",i,t,{priority:1002,destroyable:!0});u(l);t.assignmentStore=n},destroy:function(){var n=this;Ext.destroyMembers(n,"assignmentStoreDetacher","eventStoreDetacher");n.assignmentStore=null},get:function(n,t){var i=this;return n=i.key(n),t=t||function(){return Ext.Array.filter(i.assignmentStore.getRange(),function(t){return t.getEventId()==n})},i.callParent([n,t])}});Ext.define("Sch.data.util.ResourceAssignmentsCache",{extend:Sch.util.Cache,assignmentStore:null,assignmentStoreDetacher:null,eventStoreDetacher:null,resourceStoreDetacher:null,constructor:function(n){function o(n,i){Ext.Array.each(i,function(n){t.add(n.getResourceId(),n)})}function s(n,i){Ext.Array.each(i,function(n){t.remove(n.getResourceId(),n)})}function h(n,i){var r=i.resourceIdField,u=i.previous&&r in i.previous,f=u&&i.previous[r];u&&t.move(f,i.getResourceId(),i)}function i(){t.clear()}function c(n,t){e(t);u(t&&t.getResourceStore())}function l(n,i){t.clear();u(i)}function a(n,i,r,u){t.move(r,u)}function v(n,i){Ext.Array.each(i,function(n){t.clear(n)})}function r(){t.clear()}function e(n){Ext.destroy(t.eventStoreDetacher);t.eventStoreDetacher=n&&n.on({resourcestorechange:l,priority:100,destroyable:!0})}function u(n){Ext.destroy(t.resourceStoreDetacher);t.resourceStoreDetacher=n&&n.on({idchanged:a,remove:v,clear:r,cacheresethint:r,rootchange:r,priority:100,destroyable:!0})}var t=this,f=n.getEventStore(),y=f&&f.getResourceStore();t.callParent();t.assignmentStoreDetacher=n.on({add:o,remove:s,update:h,clear:i,cacheresethint:i,eventstorechange:c,priority:100,destroyable:!0});t.assignmentStoreFiltersDetacher=n.getFilters().on("endupdate",i,t,{priority:1002,destroyable:!0});e(f);u(y);t.assignmentStore=n},destroy:function(){var n=this;Ext.destroyMembers(n,"assignmentStoreDetacher","assignmentStoreFiltersDetacher","eventStoreDetacher","resourceStoreDetacher");n.assignmentStore=null},get:function(n,t){var i=this;return n=i.key(n),t=t||function(){return Ext.Array.filter(i.assignmentStore.getRange(),function(t){return t.getResourceId()==n})},i.callParent([n,t])}});Ext.define("Sch.data.util.AssignmentStoreEventResourcesCache",{extend:Sch.util.Cache,assignmentStore:null,assignmentStoreDetacher:null,eventStoreDetacher:null,resourceStoreDetacher:null,constructor:function(n){function u(n,i){var r=t.assignmentStore.getEventStore(),u=r&&r.getResourceStore();Ext.Array.each(i,function(n){var i=u&&u.getModelById(n.getResourceId());i?t.add(n.getEventId(),i):t.clear(n.getEventId())})}function f(n,i){var r=t.assignmentStore.getEventStore(),u=r&&r.getResourceStore();Ext.Array.each(i,function(n){var i=u.getModelById(n.getResourceId());i?t.remove(n.getEventId(),i):t.clear(n.getEventId())})}function e(n,i){var s=i.resourceIdField,f=i.previous&&s in i.previous,e=f&&i.previous[s],h=i.eventIdField,o=i.previous&&h in i.previous,u=o&&i.previous[h],c=t.assignmentStore.getEventStore(),l=c&&c.getResourceStore(),r;(f||o)&&(e=f?e:i.getResourceId(),u=o?u:i.getEventId(),r=l.getModelById(e),r?t.remove(u,r):t.clear(u),r=l.getModelById(i.getResourceId()),r?t.add(i.getEventId(),r):t.clear(i.getEventId()))}function i(){t.clear()}var t=this,r=n.getEventStore(),o=r&&r.getResourceStore();t.callParent();t.assignmentStoreDetacher=n.on({add:u,remove:f,update:e,clear:i,cacheresethint:i,priority:100,destroyable:!0});t.assignmentStore=n},destroy:function(){var n=this;Ext.destroyMembers(n,"assignmentStoreDetacher","eventStoreDetacher","resourceStoreDetacher");n.assignmentStore=null},get:function(n,t){var i=this;return t=t||function(){return i.assignmentStore.mapAssignmentsForEvent(n,function(n){return n.getResource()},function(n){return!!n})},i.callParent([n,t])}});Ext.define("Sch.data.util.AssignmentStoreResourceEventsCache",{extend:Sch.util.Cache,assignmentStore:null,assignmentStoreDetacher:null,eventStoreDetacher:null,resourceStoreDetacher:null,constructor:function(n){function s(n,i){var r=t.assignmentStore.getEventStore();Ext.Array.each(i,function(n){var i=r&&r.getModelById(n.getEventId());i?t.add(n.getResourceId(),i):t.clear(n.getResourceId())})}function h(n,i){var r=t.assignmentStore.getEventStore();Ext.Array.each(i,function(n){var i=r&&r.getModelById(n.getEventId());i?t.remove(n.getResourceId(),i):t.clear(n.getResourceId())})}function c(n,i){var h=i.resourceIdField,e=i.previous&&h in i.previous,u=e&&i.previous[h],c=i.eventIdField,o=i.previous&&c in i.previous,s=o&&i.previous[c],f=t.assignmentStore.getEventStore(),r;(e||o)&&(u=e?u:i.getResourceId(),s=o?s:i.getEventId(),r=f&&f.getModelById(s),r?t.remove(u,r):t.clear(u),r=f&&f.getModelById(i.getEventId()),r?t.add(i.getResourceId(),r):t.clear(i.getResourceId()))}function e(){t.clear()}function l(n,i){t.clear();o(i);u(i&&i.getResourceStore())}function a(n,i){Ext.Array.each(i,function(n){t.uncache(n)})}function i(){t.clear()}function v(n,i){t.clear();u(i)}function y(n,i,r,u){t.move(r,u)}function p(n,i){Ext.Array.each(i,function(n){t.clear(n)})}function r(){t.clear()}function o(n){Ext.destroy(t.eventStoreDetacher);t.eventStoreDetacher=n&&n.on({remove:a,cacheresethint:i,clear:i,rootchange:i,resourcestorechange:v,priority:100,destroyable:!0})}function u(n){Ext.destroy(t.resourceStoreDetacher);t.resourceStoreDetacher=n&&n.on({idchanged:y,remove:p,cacheresethint:r,clear:r,rootchange:r,priority:100,destroyable:!0})}var t=this,f=n.getEventStore(),w=f&&f.getResourceStore();t.callParent();t.assignmentStoreDetacher=n.on({add:s,remove:h,update:c,cacheresethint:e,clear:e,eventstorechange:l,priority:100,destroyable:!0});o(f);u(w);t.assignmentStore=n},destroy:function(){var n=this;Ext.destroyMembers(n,"assignmentStoreDetacher","eventStoreDetacher","resourceStoreDetacher");n.assignmentStore=null},get:function(n,t){var i=this;return t=t||function(){return i.assignmentStore.mapAssignmentsForResource(n,function(n){return n.getEvent()},function(n){return!!n})},i.callParent([n,t])}});Ext.define("Sch.data.AssignmentStore",{extend:Ext.data.Store,mixins:[Sch.data.mixin.UniversalModelGetter,Sch.data.mixin.CacheHintHelper,Robo.data.Store],model:"Sch.model.Assignment",alias:"store.assignmentstore",storeId:"assignments",eventResourceCache:null,resourceEventsCache:null,eventStoreDetacher:null,resourceStoreDetacher:null,eventStore:null,constructor:function(n){var t=this;t.callParent([n]);t.eventAssignmentsCache=t.eventAssignmentsCache||new Sch.data.util.EventAssignmentsCache(t);t.resourceAssignmentsCache=t.resourceAssignmentsCache||new Sch.data.util.ResourceAssignmentsCache(t)},destroy:function(){var n=this;Ext.destroyMembers(n,"eventResourceCache","resourceEventsCache","eventAssignmentsCache","resourceEventsCache","eventStoreDetacher","resourceStoreDetacher");n.callParent()},getEventStore:function(){return this.eventStore},setEventStore:function(n){var t=this,i=t.eventStore;t.eventStore=n&&Ext.StoreMgr.lookup(n)||null;t.attachToEventStore(t.eventStore);(i||n)&&i!==n&&t.fireEvent("eventstorechange",t,n,i)},attachToEventStore:function(n){var t=this;Ext.destroy(t.eventStoreDetacher);n&&(t.eventStoreDetacher=n.isTreeStore?n.on({noderemove:t.onEventNodeRemove,resourcestorechange:t.onEventStoreResourceStoreChange,scope:t,destroyable:!0,priority:200}):n.on({remove:t.onEventRemove,resourcestorechange:t.onEventStoreResourceStoreChange,scope:t,destroyable:!0,priority:200}));t.attachToResourceStore(n&&n.getResourceStore())},attachToResourceStore:function(n){var t=this;Ext.destroy(t.resourceStoreDetacher);n&&(t.resourceStoreDetacher=n.isTreeStore?n.on({noderemove:t.onResourceNodeRemove,scope:t,destroyable:!0,priority:200}):n.on({remove:t.onResourceRemove,scope:t,destroyable:!0,priority:200}))},onEventStoreResourceStoreChange:function(n,t){this.attachToResourceStore(t)},onEventRemove:function(n,t,i,r){var f=this,u;r||(u=[],Ext.Array.each(t,function(n){u=u.concat(f.getAssignmentsForEvent(n))}),u.length&&f.remove(u))},onEventNodeRemove:function(n,t,i){var u=this,r;i||(r=[],t.cascadeBy(function(n){r=r.concat(u.getAssignmentsForEvent(n))}),r.length&&u.remove(r))},onResourceRemove:function(n,t,i,r){var f=this,u;r||(u=[],Ext.Array.each(t,function(n){u=u.concat(f.getAssignmentsForResource(n))}),u.length&&f.remove(u))},onResourceNodeRemove:function(n,t,i){var u=this,r;i||(r=[],t.cascadeBy(function(n){r=r.concat(u.getAssignmentsForResource(n))}),r.length&&u.remove(r))},mapAssignmentsForEvent:function(n,t,i){var u=this,r=[];return t=t||Ext.identityFn,i=i||Ext.returnTrue,t!==Ext.identityFn||i!==Ext.returnTrue?Ext.Array.each(u.eventAssignmentsCache.get(n),function(n){var u=t(n);i(u)&&r.push(u)}):r=[].concat(u.eventAssignmentsCache.get(n)),r},mapAssignmentsForResource:function(n,t,i){var u=this,r=[];return t=t||Ext.identityFn,i=i||Ext.returnTrue,t!==Ext.identityFn||i!==Ext.returnTrue?Ext.Array.each(u.resourceAssignmentsCache.get(n),function(n){var u=t(n);i(u)&&r.push(u)}):r=[].concat(u.resourceAssignmentsCache.get(n)),r},getAssignmentsForEvent:function(n){return this.mapAssignmentsForEvent(n)},removeAssignmentsForEvent:function(n){var t=this;t.remove(t.getAssignmentsForEvent(n))},getAssignmentsForResource:function(n){return this.mapAssignmentsForResource(n)},removeAssignmentsForResource:function(n){var t=this;t.remove(t.getAssignmentsForResource(n))},getResourcesForEvent:function(n){var t=this;return t.eventResourceCache?t.eventResourceCache.get(n):t.mapAssignmentsForEvent(n,function(n){return n.getResource()},function(n){return!!n})},getEventsForResource:function(n){var t=this;return t.resourceEventsCache?t.resourceEventsCache.get(n):t.mapAssignmentsForResource(n,function(n){return n.getEvent()},function(n){return!!n})},assignEventToResource:function(n,t,i){var r=this,u=[],f;return i=i||Ext.identityFn,f=Ext.isArray(t)?t:[t],Ext.Array.each(f,function(t){if(!r.isEventAssignedToResource(n,t)){var f=new r.model;f.setEventId(n instanceof Ext.data.Model&&n.getId()||n);f.setResourceId(t instanceof Ext.data.Model&&t.getId()||t);f=i(f);u.push(f)}}),r.add(u),u},unassignEventFromResource:function(n,t){var i=this,r;return t?i.isEventAssignedToResource(n,t)&&(r=i.getAssignmentForEventAndResource(n,t),i.remove(r)):this.removeAssignmentsForEvent(n),r},isEventAssignedToResource:function(n,t){var e=this,u=e.getResourcesForEvent(n),i=!1,r,f;for(t=t instanceof Ext.data.Model&&t.getId()||t,r=0,f=u.length;!i&&r<f;r++)i=u[r],i=i.getId()==t;return i},getAssignmentForEventAndResource:function(n,t){var e=this,u=e.getAssignmentsForEvent(n),i=null,r,f;for(t=t instanceof Ext.data.Model&&t.getId()||t,r=0,f=u.length;!i&&r<f;r++)i=u[r],i=i.getResourceId()==t&&i||null;return i}});Ext.define("Sch.data.CrudManager",{extend:Sch.crud.AbstractManager,mixins:[Sch.crud.encoder.Json,Sch.crud.transport.Ajax],resourceStore:null,eventStore:null,assignmentStore:null,addRelatedStores:!0,constructor:function(n){var o,u,f;n=n||{};var t=n.resourceStore||this.resourceStore||new Sch.data.ResourceStore,i=n.eventStore||this.eventStore||new Sch.data.EventStore,r=n.assignmentStore||this.assignmentStore,e=[];i&&n.addRelatedStores!==!1&&(o=this.getEventStoreInfo(i,n),r=r||o.assignmentStore,t=t||o.resourceStore);i&&e.push(i);t&&e.push(t);r&&e.push(r);e.length&&(u=[],t&&u.push(t),i&&u.push(i),r&&u.push(r),u.length&&(n.syncApplySequence=(n.syncApplySequence||n.stores||[]).concat(u)),f=n.stores||this.stores,f&&!Ext.isArray(f)&&(f=[f]),n.stores=(f||[]).concat(e));this.callParent([n]);this.eventStore=this.getStoreDescriptor(i);this.resourceStore=this.getStoreDescriptor(t);this.assignmentStore=this.getStoreDescriptor(r)},getEventStoreInfo:function(n,t){n.isStore||(n=typeof n=="string"?Ext.data.StoreManager.get(n):n.store);var i={},r=t.assignmentStore,u=t.resourceStore;return r||(i.assignmentStore=n.getAssignmentStore()),u||(i.resourceStore=n.getResourceStore()),i},getResourceStore:function(){return this.resourceStore&&this.resourceStore.store},setResourceStore:function(n){this.getResourceStore()&&this.removeStore(this.getResourceStore());this.addStore(n);this.resourceStore={store:n}},getEventStore:function(){return this.eventStore&&this.eventStore.store},setEventStore:function(n){this.getEventStore()&&this.removeStore(this.getEventStore());this.addStore(n);this.eventStore={store:n}},getAssignmentStore:function(){return this.assignmentStore&&this.assignmentStore.store},setAssignmentStore:function(n){this.getAssignmentStore()&&this.removeStore(this.getAssignmentStore());this.addStore(n);this.assignmentStore={store:n}}});Ext.define("Sch.data.util.IdConsistencyManager",{config:{eventStore:null,resourceStore:null,assignmentStore:null},eventStoreDetacher:null,resourceStoreDetacher:null,constructor:function(n){this.initConfig(n)},updateEventStore:function(n){var t=this;Ext.destroyMembers(t,"eventStoreDetacher");n&&(t.eventStoreDetacher=n.on({idchanged:t.onEventIdChanged,scope:t,destroyable:!0,priority:200}))},updateResourceStore:function(n){var t=this;Ext.destroyMembers(t,"resourceStoreDetacher");n&&(t.resourceStoreDetacher=n.on({idchanged:t.onResourceIdChanged,scope:t,destroyable:!0,priority:200}))},onEventIdChanged:function(n,t,i,r){var u=this,f=u.getAssignmentStore(),e;if(f){e=u.getUpdateAssignmentEventIdFieldFn(f,i,r);n.on("update",e,null,{single:!0,priority:200})}},onResourceIdChanged:function(n,t,i,r){var u=this,s=u.getEventStore(),f=u.getAssignmentStore(),e,o;if(s&&!f&&(e=u.getUpdateEventResourceIdFieldFn(s,i,r)),f&&(o=u.getUpdateAssignmentResourceIdFieldFn(f,i,r)),e||f)n.on("update",function(){e&&e();o&&o()},null,{single:!0,priority:200})},getUpdateEventResourceIdFieldFn:function(n,t,i){var r=n.getRange();return function(){Ext.Array.each(r,function(n){n.getResourceId()==t&&n.setResourceId(i)})}},getUpdateAssignmentEventIdFieldFn:function(n,t,i){var r=n.getAssignmentsForEvent(t);return function(){Ext.Array.each(r,function(n){n.getEventId()==t&&n.setEventId(i)})}},getUpdateAssignmentResourceIdFieldFn:function(n,t,i){var r=n.getAssignmentsForResource(t);return function(){Ext.Array.each(r,function(n){n.getResourceId()==t&&n.setResourceId(i)})}}});Ext.define("Sch.data.util.ModelPersistencyManager",{config:{eventStore:null,resourceStore:null,assignmentStore:null},eventStoreDetacher:null,resourceStoreDetacher:null,assignmentStoreDetacher:null,constructor:function(n){this.initConfig(n)},updateEventStore:function(n){var t=this;Ext.destroyMembers(t,"eventStoreDetacher");n&&n.autoSync&&(t.eventStoreDetacher=n.on({beforesync:t.onEventStoreBeforeSync,scope:t,destroyable:!0,priority:100}))},updateResourceStore:function(n){var t=this;Ext.destroyMembers(t,"resourceStoreDetacher");n&&n.autoSync&&(t.resourceStoreDetacher=n.on({beforesync:t.onResourceStoreBeforeSync,scope:t,destroyable:!0,priority:100}))},updateAssignmentStore:function(n){var t=this;Ext.destroyMembers(t,"assignmentStoreDetacher");n&&n.autoSync&&(t.assignmentStoreDetacher=n.on({beforesync:t.onAssignmentStoreBeforeSync,scope:t,destroyable:!0,priority:100}))},onEventStoreBeforeSync:function(n){var t=this;return t.removeNonPersistableRecordsToCreate(n),t.shallContinueSync(n)},onResourceStoreBeforeSync:function(n){var t=this;return t.removeNonPersistableRecordsToCreate(n),t.shallContinueSync(n)},onAssignmentStoreBeforeSync:function(n){var t=this;return t.removeNonPersistableRecordsToCreate(n),t.shallContinueSync(n)},removeNonPersistableRecordsToCreate:function(n){for(var t=n.create||[],i,r=t.length-1;r>=0;--r)i=t[r],i.isPersistable()||Ext.Array.remove(t,i);t.length===0&&delete n.create},shallContinueSync:function(n){return Boolean(n.create&&n.create.length>0||n.update&&n.update.length>0||n.destroy&&n.destroy.length>0)}});Ext.define("Sch.data.util.ResourceEventsCache",{extend:Sch.util.Cache,eventStore:null,eventStoreDetacher:null,resourceStoreDetacher:null,constructor:function(n){function f(n,i){Ext.Array.each(i,function(n){t.add(n.getResourceId(),n)})}function e(n,i){Ext.Array.each(i,function(n){t.remove(n.getResourceId(),n)})}function o(n,i){var r=i.resourceIdField,u=i.previous&&r in i.previous,f=u&&i.previous[r];u&&t.move(f,i.getResourceId(),i)}function i(){t.clear()}function s(n,i){t.clear();u(i)}function h(n,i,r,u){t.move(r,u)}function c(n,i){Ext.Array.each(i,function(n){t.clear(n)})}function r(){t.clear()}function u(n){Ext.destroy(t.resourceStoreDetacher);t.resourceStoreDetacher=n&&n.on({idchanged:h,remove:c,clear:r,cacheresethint:r,rootchange:r,priority:100,destroyable:!0})}var t=this,l=n.getResourceStore();t.callParent();t.eventStoreDetacher=n.on({add:f,remove:e,update:o,clear:i,cacheresethint:i,rootchange:i,resourcestorechange:s,priority:100,destroyable:!0});t.eventStoreFiltersDetacher=n.getFilters().on("endupdate",i,this,{priority:1002,destroyable:!0});u(l);t.eventStore=n},destroy:function(){var n=this;Ext.destroyMembers(n,"eventStoreDetacher","eventStoreFiltersDetacher","resourceStoreDetacher");n.eventStore=null},get:function(n,t){var i=this;return n=i.key(n),t=t||function(){return Ext.Array.filter(i.eventStore.getRange(),function(t){return t.getResourceId()==n})},i.callParent([n,t])}});Ext.define("Sch.data.mixin.EventStore",{extend:Ext.Mixin,isEventStore:!0,resourceStore:null,resourceStoreDetacher:null,assignmentStore:null,resourceEventsCache:null,idConsistencyManager:null,modelPersistencyManager:null,mixinConfig:{after:{constructor:"constructor",destroy:"destroy"}},constructor:function(){var n=this;n.resourceEventsCache=n.createResourceEventsCache();n.idConsistencyManager=n.createIdConsistencyManager();n.modelPersistencyManager=n.createModelPersistencyManager()},destroy:function(){var n=this;Ext.destroyMembers(n,"resourceEventsCache","idConsistencyManager","modelPersistencyManager")},createResourceEventsCache:function(){return new Sch.data.util.ResourceEventsCache(this)},createIdConsistencyManager:function(){var n=this;return new Sch.data.util.IdConsistencyManager({eventStore:n,resourceStore:n.getResourceStore(),assignmentStore:n.getAssignmentStore()})},createModelPersistencyManager:function(){var n=this;return new Sch.data.util.ModelPersistencyManager({eventStore:n,resourceStore:n.getResourceStore(),assignmentStore:n.getAssignmentStore()})},getResourceStore:function(){return this.resourceStore},setResourceStore:function(n){var t=this,i=t.resourceStore;t.resourceStore&&(t.resourceStore.setEventStore(null),t.idConsistencyManager&&t.idConsistencyManager.setResourceStore(null),t.modelPersistencyManager&&t.modelPersistencyManager.setResourceStore(null));t.resourceStore=n&&Ext.StoreMgr.lookup(n)||null;t.resourceStore&&(t.modelPersistencyManager&&t.modelPersistencyManager.setResourceStore(t.resourceStore),t.idConsistencyManager&&t.idConsistencyManager.setResourceStore(t.resourceStore),n.setEventStore(t));(i||n)&&i!==n&&t.fireEvent("resourcestorechange",t,n,i)},getAssignmentStore:function(){return this.assignmentStore},setAssignmentStore:function(n){var t=this,i=t.assignmentStore;t.assignmentStore&&(t.assignmentStore.setEventStore(null),t.idConsistencyManager&&t.idConsistencyManager.setAssignmentStore(null),t.modelPersistencyManager&&t.modelPersistencyManager.setAssignmentStore(null));t.assignmentStore=n&&Ext.StoreMgr.lookup(n)||null;t.assignmentStore?(t.modelPersistencyManager&&t.modelPersistencyManager.setAssignmentStore(t.assignmentStore),t.idConsistencyManager&&t.idConsistencyManager.setAssignmentStore(t.assignmentStore),t.assignmentStore.setEventStore(t),Ext.destroy(t.resourceEventsCache)):t.resourceEventsCache=t.createResourceEventsCache();(i||n)&&i!==n&&t.fireEvent("assignmentstorechange",t,n,i)},isDateRangeAvailable:function(n,t,i,r){var f=Sch.util.Date,e=this.getEventsForResource(r),u=!0;return Ext.each(e,function(r){return u=i===r||!f.intersectSpans(n,t,r.getStartDate(),r.getEndDate())}),u},getEventsInTimeSpan:function(n,t,i){var u=new Ext.util.MixedCollection,r=[],f;return i!==!1?(f=Sch.util.Date,this.forEachScheduledEvent(function(i,u,e){f.intersectSpans(u,e,n,t)&&r.push(i)})):this.forEachScheduledEvent(function(i,u,f){u-n>=0&&t-f>=0&&r.push(i)}),u.addAll(r),u},forEachScheduledEvent:function(n,t){this.each(function(i){var r=i.getStartDate(),u=i.getEndDate();if(r&&u)return n.call(t||this,i,r,u)},this)},getTotalTimeSpan:function(){var n=new Date(9999,0,1),t=new Date(0),i=Sch.util.Date;return this.each(function(r){r.getStartDate()&&(n=i.min(r.getStartDate(),n));r.getEndDate()&&(t=i.max(r.getEndDate(),t))}),n=n<new Date(9999,0,1)?n:null,t=t>new Date(0)?t:null,this.lastTotalTimeSpan={start:n||null,end:t||n||null},this.lastTotalTimeSpan},filterEventsForResource:function(n,t,i){var r=n.getEvents(this);return Ext.Array.filter(r,t,i||this)},append:function(){throw"Must be implemented by consuming class";},getResourcesForEvent:function(n){var i=this,r=i.getAssignmentStore(),u=i.getResourceStore(),t;return r?t=r.getResourcesForEvent(n):u?(n=n instanceof Sch.model.Event&&n||i.getModelById(n),t=n&&u.getModelById(n.getResourceId()),t=t&&[t]||[]):t=[],t},getEventsForResource:function(n){var t=this,i=t.getAssignmentStore();return i?i.getEventsForResource(n):t.resourceEventsCache?t.resourceEventsCache.get(n):[]},getAssignmentsForEvent:function(n){var i=this,t=i.getAssignmentStore();return t&&t.getAssignmentsForEvent(n)||[]},getAssignmentsForResource:function(n){var i=this,t=i.getAssignmentStore();return t&&t.getAssignmentsForResource(n)||[]},assignEventToResource:function(n,t){var i=this,r=i.getAssignmentStore();r?r.assignEventToResource(n,t):(n=n instanceof Sch.model.Event&&n||i.getModelById(n),t=t instanceof Sch.model.Resource?t.getId():t,n&&n.setResourceId(t))},unassignEventFromResource:function(n,t){var i=this,r=i.getAssignmentStore();r?r.unassignEventFromResource(n,t):(n=n instanceof Sch.model.Event&&n||i.getModelById(n),t=t instanceof Sch.model.Resource?t.getId():t,n&&n.getResourceId()==t&&n.setResourceId(null))},reassignEventFromResourceToResource:function(n,t,i){var u=this,r=u.getAssignmentStore();r?(r.unassignEventFromResource(n,t),r.assignEventToResource(n,i)):(n=n instanceof Sch.model.Event&&n||u.getModelById(n),t=t instanceof Sch.model.Resource?t.getId():t,i=i instanceof Sch.model.Resource?i.getId():i,n.getResourceId()==t&&n.setResourceId(i))},isEventAssignedToResource:function(n,t){var r=this,u=r.getAssignmentStore(),i;return u?i=u.isEventAssignedToResource(n,t):(n=n instanceof Sch.model.Event&&n||r.getModelById(n),t=t instanceof Sch.model.Resource?t.getId():t,i=n&&n.getResourceId()==t||!1),i},removeAssignmentsForEvent:function(n){var t=this,i=t.getAssignmentStore();i?i.removeAssignmentsForEvent(n):(n=n instanceof Sch.model.Event&&n||t.getModelById(n),n&&n.setResourceId(null))},removeAssignmentsForResource:function(n){var t=this,i=t.getAssignmentStore(),r=t.getResourceStore();i?i.removeAssignmentsForResource(n):r?(n=n instanceof Sch.model.Resource&&n||r.getModelById(n),n&&Ext.Array.each(t.resourceEventsCache.get(n),function(n){n.setResourceId(null)})):(n=n instanceof Sch.model.Resource?n.getId():n,Ext.Array.each(t.getRange(),function(t){t.getResourceId()==n&&t.setResourceId(null)}))},isEventPersistable:function(n){var f=this,e=f.getAssignmentStore(),i,t,u,r=!0;if(!e)for(i=n.getResources(),t=0,u=i.length;r&&t<u;++t)r=i[t].phantom!==!0;return r}});Ext.define("Sch.model.Event",{extend:Sch.model.Range,idProperty:"Id",customizableFields:[{name:"ResourceId"},{name:"Draggable",type:"boolean",persist:!1,defaultValue:!0},{name:"Resizable",persist:!1,defaultValue:!0}],resourceIdField:"ResourceId",draggableField:"Draggable",resizableField:"Resizable",getInternalId:function(){return this.internalId},getEventStore:function(){var t=this,n=t.joined&&t.joined[0];return n&&!n.isEventStore&&(Ext.Array.sort(t.joined,function(n,t){return(n.isEventStore||!1)>(t.isEventStore||!1)&&-1||1}),n=t.joined[0],n=n.isEventStore?n:null),n},getResourceStore:function(){var n=this.getEventStore();return n&&n.getResourceStore()},getAssignmentStore:function(){var n=this.getEventStore();return n&&n.getAssignmentStore()},getResources:function(){var n=this,t=n.getEventStore();return t&&t.getResourcesForEvent(n)||[]},forEachResource:function(n,t){for(var r=this.getResources(),i=0;i<r.length;i++)if(n.call(t||this,r[i])===!1)return},getResource:function(n){var r=this,t=null,i=r.getEventStore(),u=i&&i.getResourceStore();return n=n==null?r.getResourceId():n,i&&(n===null||n===undefined)?(t=i.getResourcesForEvent(r),t.length==1?t=t[0]:t.length>1?Ext.Error.raise("Event::getResource() is not applicable for events with multiple assignments, please use Event::getResources() instead."):t=null):u&&(t=u.getModelById(n)),t},setResource:function(n){var t=this,i=t.getEventStore();i&&i.removeAssignmentsForEvent(t);t.assign(n)},assign:function(n){var t=this,i=t.getEventStore();n=n instanceof Sch.model.Resource?n.getId():n;i?i.assignEventToResource(t,n):t.setResourceId(n)},unassign:function(n){var t=this,i=t.getEventStore();n=n instanceof Sch.model.Resource?n.getId():n;i?i.unassignEventFromResource(t,n):t.getResourceId()==n&&t.setResourceId(null)},reassign:function(n,t){var i=this,r=i.getEventStore();n=n instanceof Sch.model.Resource?n.getId():n;t=t instanceof Sch.model.Resource?t.getId():t;r?r.reassignEventFromResourceToResource(i,n,t):i.setResourceId(t)},isAssignedTo:function(n){var t=this,i=t.getEventStore();return n=n instanceof Sch.model.Resource&&n.getId()||n,i?i.isEventAssignedToResource(t,n):t.getResourceId()==n},getAssignments:function(){var n=this,t=n.getEventStore();return t&&t.getAssignmentsForEvent(n)},isDraggable:function(){return this.getDraggable()},isResizable:function(){return this.getResizable()},isPersistable:function(){var n=this,t=n.getEventStore();return t&&t.isEventPersistable(n)}});Ext.define("Sch.data.EventStore",{extend:Ext.data.Store,alias:"store.eventstore",mixins:[Sch.data.mixin.UniversalModelGetter,Sch.data.mixin.CacheHintHelper,Sch.data.mixin.EventStore,Robo.data.Store],storeId:"events",model:"Sch.model.Event",config:{model:"Sch.model.Event"},constructor:function(n){var t=this;if(t.callParent([n]),t.resourceStore&&t.setResourceStore(t.resourceStore),t.assignmentStore&&t.setAssignmentStore(t.assignmentStore),t.getModel()!==Sch.model.Event&&!(t.getModel().prototype instanceof Sch.model.Event))throw"The model for the EventStore must subclass Sch.model.Event";},append:function(n){this.add(n)}});Ext.define("Sch.util.Patch",{target:null,minVersion:null,maxVersion:null,reportUrl:null,description:null,applyFn:null,ieOnly:!1,macOnly:!1,overrides:null,onClassExtended:function(n,t){Sch.disableOverrides||(!t.ieOnly||Ext.isIE)&&(!t.macOnly||Ext.isMac)&&(!t.minVersion||Ext.versions.extjs.equals(t.minVersion)||Ext.versions.extjs.isGreaterThan(t.minVersion))&&(!t.maxVersion||Ext.versions.extjs.equals(t.maxVersion)||Ext.versions.extjs.isLessThan(t.maxVersion))&&(t.applyFn?t.applyFn():t.overrides&&Ext.ClassManager.get(t.target).override(t.overrides))}});Ext.define("Sch.patches.OperationDestroy",{extend:Sch.util.Patch,target:"Ext.data.operation.Destroy",minVersion:"5.1.1",maxVersion:"5.1.2",overrides:{doProcess:function(){for(var t=Ext.Array.slice(this.getRecords()),i=t.length,n=0;n<i;++n)t[n].setErased()}}});Ext.define("Sch.data.mixin.ResourceStore",{eventStore:null,getEventStore:function(){return this.eventStore},setEventStore:function(n){var t=this,i;t.eventStore!==n&&(i=t.eventStore,t.eventStore=n&&Ext.StoreMgr.lookup(n)||null,t.fireEvent("eventstorechange",t,n,i))},getScheduledEventsInTimeSpan:function(n,t,i){var r=[],u=Sch.util.Date;return i=i||this.getEventStore(),Ext.Array.each(this.getRange(),function(u){Ext.Array.each(i.getEventsForResource(u),function(i){i.intersectsRange(n,t)&&r.push(i)})}),r}});Ext.define("Sch.data.ResourceStore",{extend:Ext.data.Store,model:"Sch.model.Resource",config:{model:"Sch.model.Resource"},alias:"store.resourcestore",mixins:[Sch.data.mixin.UniversalModelGetter,Sch.data.mixin.CacheHintHelper,Sch.data.mixin.ResourceStore,Robo.data.Store],storeId:"resources",constructor:function(){if(this.callParent(arguments),this.getModel()!==Sch.model.Resource&&!(this.getModel().prototype instanceof Sch.model.Resource))throw"The model for the ResourceStore must subclass Sch.model.Resource";}});Ext.define("Sch.patches.TreeStore",{extend:Sch.util.Patch,target:"Ext.data.TreeStore",minVersion:"5.1.0",overrides:{getRejectRecords:function(){return this.getModifiedRecords()},rejectChanges:function(){this.removed=this.removedNodes;this.callParent(arguments)},remove:function(n){if(n.isModel)n.remove();else if(n instanceof Array&&n[0].isModel)for(var t=0;t<n.length;t++)n[t].remove();else this.callParent(arguments)}}});Ext.define("Sch.patches.TreeStoreInternalIdMap",{extend:Sch.util.Patch,target:"Ext.data.TreeStore",minVersion:"5.1.1",overrides:{registerNode:function(n){var t=this;t.byInternalIdMap||(t.byInternalIdMap={});t.byInternalIdMap[n.internalId]=n;t.callParent(arguments)},unregisterNode:function(n){var t=this;t.byInternalIdMap&&delete t.byInternalIdMap[n.internalId];t.callParent(arguments)},updateRoot:function(){this.byInternalIdMap={};this.callParent(arguments)}}});Ext.define("Sch.patches.NodeStore",{extend:Sch.util.Patch,target:"Ext.data.NodeStore",ieOnly:!0,maxVersion:"5.1.1",overrides:{afterEdit:function(n,t){if(this.getNode()&&t){if(Ext.Array.indexOf(t,"loaded")!==-1)return this.add(this.retrieveChildNodes(n));if(Ext.Array.indexOf(t,"expanded")!==-1)return this.filter();if(Ext.Array.indexOf(t,"sorted")!==-1)return this.sort()}Ext.data.Store.prototype.afterEdit.apply(this,arguments)}}});Ext.define("Sch.data.mixin.FilterableTreeStore",{isFilteredFlag:!1,isHiddenFlag:!1,treeFilter:null,lastTreeFilter:null,lastTreeHiding:null,allowExpandCollapseWhileFiltered:!0,reApplyFilterOnDataChange:!0,suspendIncrementalFilterRefresh:0,filterGeneration:0,currentFilterGeneration:null,dataChangeListeners:null,monitoringDataChange:!1,filterUpdateSuspended:!1,onClassMixedIn:function(n){n.override(Sch.data.mixin.FilterableTreeStore.prototype.inheritables()||{})},initTreeFiltering:function(){this.treeFilter=new Ext.util.Filter({filterFn:this.isNodeFilteredIn,scope:this});this.dataChangeListeners={nodeappend:this.onNeedToUpdateFilter,nodeinsert:this.onNeedToUpdateFilter,scope:this};Ext.apply(this.dataChangeListeners,{beforeload:this.onStoreBeforeLoad,load:this.onStoreLoad})},onStoreBeforeLoad:function(){this.filterUpdateSuspended=!0},onStoreLoad:function(){this.filterUpdateSuspended=!1;this.onNeedToUpdateFilter()},startDataChangeMonitoring:function(){if(!this.monitoringDataChange){this.monitoringDataChange=!0;this.on(this.dataChangeListeners)}},stopDataChangeMonitoring:function(){this.monitoringDataChange&&(this.monitoringDataChange=!1,this.un(this.dataChangeListeners))},onNeedToUpdateFilter:function(){!this.reApplyFilterOnDataChange||this.filterUpdateSuspended||this.suspendIncrementalFilterRefresh||this.reApplyFilter()},clearTreeFilter:function(){this.isTreeFiltered()&&(this.currentFilterGeneration=null,this.isFilteredFlag=!1,this.lastTreeFilter=null,this.isTreeFiltered(!0)||this.stopDataChangeMonitoring(),this.refreshNodeStoreContent(),this.fireEvent("filter-clear",this))},reApplyFilter:function(){this.isHiddenFlag&&this.hideNodesBy.apply(this,this.lastTreeHiding.concat(this.isFilteredFlag));this.isFilteredFlag&&this.filterTreeBy(this.lastTreeFilter)},refreshNodeStoreContent:function(){var n=this,t=n.getFilters();t.indexOf(n.treeFilter)<0?n.addFilter(n.treeFilter):this.getFilters().fireEvent("endupdate",this.getFilters())},getIndexInTotalDataset:function(n){var t=this.getRootNode(),i=-1,r=this.rootVisible;if(!r&&n==t)return-1;var f=this.isTreeFiltered(),e=this.currentFilterGeneration,u=function(o){var h,c,s;if((f&&o.__filterGen!=e||o.hidden)&&o==n||((r||o!=t)&&i++,o==n))return!1;if(!o.isLeaf()&&o.isExpanded())for(h=o.childNodes,c=h.length,s=0;s<c;s++)if(u(h[s])===!1)return!1};return u(t),i},isTreeFiltered:function(n){return this.isFilteredFlag||n&&this.isHiddenFlag},markFilteredNodes:function(n,t){var v=this,y=this.currentFilterGeneration,i={},u=this.getRootNode(),c=this.rootVisible,f=function(n){for(var t=n.parentNode;t&&!i[t.internalId];)i[t.internalId]=!0,t=t.parentNode},e=t.filter,o=t.scope||this,s=t.shallow,h=t.checkParents||s,l=t.fullMatchingParents,a=t.onlyParents||l,r;if(a&&h)throw new Error("Can't combine `onlyParents` and `checkParents` options");c&&(i[u.internalId]=!0);r=function(n){if(n.addedWhileFiltered=!1,!n.hidden){var y,v,p,t;if(n.isLeaf())e.call(o,n,i)&&(i[n.internalId]=!0,f(n));else if(a){if(y=e.call(o,n),v=n.childNodes,p=v.length,y&&(i[n.internalId]=!0,f(n),l)){n.cascadeBy(function(n){i[n.internalId]=!0});return}for(t=0;t<p;t++)y&&v[t].isLeaf()?i[v[t].internalId]=!0:v[t].isLeaf()||r(v[t])}else if(h&&(y=e.call(o,n,i),y&&(i[n.internalId]=!0,f(n))),!h||!s||s&&(y||n==u&&!c))for(v=n.childNodes,p=v.length,t=0;t<p;t++)r(v[t])}};r(n);u.cascadeBy(function(n){i[n.internalId]&&(n.__filterGen=y,v.allowExpandCollapseWhileFiltered&&!n.isLeaf()&&n.expand())})},filterTreeBy:function(n,t){this.currentFilterGeneration=this.filterGeneration++;var i;arguments.length==1&&Ext.isObject(arguments[0])?(t=n.scope,i=n.filter):(i=n,n={filter:i,scope:t});this.fireEvent("nodestore-datachange-start",this);n=n||{};this.markFilteredNodes(this.getRootNode(),n);this.startDataChangeMonitoring();this.isFilteredFlag=!0;this.lastTreeFilter=n;this.fireEvent("nodestore-datachange-end",this);this.fireEvent("filter-set",this);this.refreshNodeStoreContent()},isNodeFilteredIn:function(n){var t=this.isTreeFiltered(),i=this.currentFilterGeneration;return this.loading||!Boolean(t&&n.__filterGen!=i||n.hidden)},hasNativeFilters:function(){var n=this,t=n.getFilters(),i=t.getCount();return i&&i>1||t.indexOf(n.treeFilter)<0},hideNodesBy:function(n,t,i){var r=this;if(r.isFiltered()&&r.hasNativeFilters())throw new Error("Can't hide nodes of a filtered tree store");t=t||r;r.getRootNode().cascadeBy(function(i){i.hidden=Boolean(n.call(t,i,r))});r.startDataChangeMonitoring();r.isHiddenFlag=!0;r.lastTreeHiding=[n,t];i||r.refreshNodeStoreContent()},showAllNodes:function(n){this.getRootNode().cascadeBy(function(n){n.hidden=!1});this.isHiddenFlag=!1;this.lastTreeHiding=null;this.isTreeFiltered(!0)||this.stopDataChangeMonitoring();n||this.refreshNodeStoreContent()},inheritables:function(){return{onNodeExpand:function(n){if(this.isTreeFiltered(!0)&&n==this.getRoot())this.callParent(arguments),this.reApplyFilter();else return this.callParent(arguments)},onNodeCollapse:function(n,t){var i=this,r=i.data,f=r.contains,e=i.isTreeFiltered(),o=i.currentFilterGeneration,u,s;r.contains=function(){for(var u,r,h,c=i.indexOf(n)+1,l=!1,s=0;s<t.length;s++)if(!(t[s].hidden||e&&t[s].__filterGen!=o)&&f.call(this,t[s])){for(u=n;u.parentNode;){r=u;do r=r.nextSibling;while(r&&(r.hidden||e&&r.__filterGen!=o));if(r){l=!0;h=i.indexOf(r);break}else u=u.parentNode}l||(h=i.getCount());i.removeAt(c,h-c);break}return!1};this.callParent(arguments);this.isTreeFiltered()&&(i.needsLocalFilter()&&(t=Ext.Array.filter(t,i.filterVisible)),t.length||(u=i.indexOf(n)+1,s=i.indexOfNextVisibleNode(n),i.removeAt(u,s-u)));r.contains=f},handleNodeExpand:function(n,t,i){for(var r,e=this,u=[],o=e.isTreeFiltered(),s=e.currentFilterGeneration,f=0;f<t.length;f++)r=t[f],o&&r.__filterGen!=s||r.hidden||(u[u.length]=r);return this.callParent([n,u,i])},onNodeInsert:function(n,t,i){var r=this,f,u,a,o,e,s,y=t.raw||t.data,p=r.removedNodes,h,c,l,v=this.isTreeFiltered();if(r.filterFn&&(c=r.filterFn(t),t.set("visible",c),c&&n.set("visible",r.filterFn(n))),!this.reApplyFilterOnDataChange&&v&&(t.addedWhileFiltered=!0),r.registerNode(t,!0),r.beginUpdate(),r.isVisible(t)||v&&t.addedWhileFiltered){if(i!==0&&t.previousSibling){for(u=t.previousSibling;u&&!u.addedWhileFiltered&&!u.get("visible");u=u.previousSibling);if(u){while(u.isExpanded()&&u.lastChild)u=u.lastChild;for(;u&&!u.addedWhileFiltered&&!u.get("visible");u=u.previousSibling);f=u}else f=n}else f=n;if(r.insert(r.indexOf(f)+1,t),!t.isLeaf()&&t.isExpanded())if(t.isLoaded())r.onNodeExpand(t,t.childNodes);else r.fillCount||(t.set("expanded",!1),t.expand())}Ext.Array.remove(p,t);r.needsSync=r.needsSync||t.phantom||t.dirty;t.isLeaf()||t.isLoaded()||r.lazyFill||(a=r.getProxy().getReader(),o=t.getProxy(),e=o?o.getReader():null,s=e&&e.initialConfig.rootProperty?e:a,h=s.getRoot(y),h&&(l=t.childType,r.fillNode(t,s.extractData(h,l?{model:l}:undefined))));r.endUpdate()},isFiltered:function(){return this.callParent(arguments)||this.isTreeFiltered()}}}});Ext.define("Sch.data.ResourceTreeStore",{extend:Ext.data.TreeStore,mixins:[Sch.patches.NodeStore,Sch.data.mixin.UniversalModelGetter,Sch.data.mixin.CacheHintHelper,Sch.data.mixin.ResourceStore,Sch.data.mixin.FilterableTreeStore,Robo.data.Store],alias:"store.resourcetreestore",model:"Sch.model.Resource",storeId:"resources",constructor:function(){if(this.callParent(arguments),this.initTreeFiltering(),this.getModel()!==Sch.model.Resource&&!(this.getModel().prototype instanceof Sch.model.Resource))throw"The model for the ResourceTreeStore must subclass Sch.model.Resource";},setRootNode:function(){this.isSettingRoot=!0;var n=this.callParent(arguments);return this.isSettingRoot=!1,n}});Ext.define("Sch.model.TimeAxisTick",{extend:Sch.model.Range,startDateField:"start",endDateField:"end"});Ext.define("Sch.data.TimeAxis",{extend:Ext.data.JsonStore,model:"Sch.model.TimeAxisTick",continuous:!0,originalContinuous:null,autoAdjust:!0,unit:null,increment:null,resolutionUnit:null,resolutionIncrement:null,weekStartDay:null,mainUnit:null,shiftUnit:null,shiftIncrement:1,defaultSpan:1,isConfigured:!1,adjustedStart:null,adjustedEnd:null,visibleTickStart:null,visibleTickEnd:null,presetName:null,mode:"plain",startTime:0,endTime:24,constructor:function(n){var t=this,i;n=n||{};t.setModel&&t.setModel(t.model);t.setMode(n.mode||t.mode);t.originalContinuous=t.continuous;t.callParent(arguments);t.on(Ext.versions.touch?"refresh":"datachanged",function(){t.fireEvent("reconfigure",t,!1)});t.on("endreconfigure",function(n,t){n.fireEvent("reconfigure",n,t)});n.viewPreset&&(i=Sch.preset.Manager.getPreset(n.viewPreset),i&&t.consumeViewPreset(i));(n.start||t.start)&&t.reconfigure(n)},reconfigure:function(n,t){var u,i;this.isConfigured=!0;Ext.apply(this,n);var o=this.getAdjustedDates(n.start,n.end,!0),s=this.getAdjustedDates(n.start,n.end),h=s.start,c=s.end;if(this.fireEvent("beforereconfigure",this,h,c)!==!1){this.fireEvent("beginreconfigure",this);var r=this.unit,f=this.increment||1,e=this.generateTicks(h,c,r,f,this.mainUnit);this.removeAll(!0);this.suspendEvents();this.add(e);this.getCount()===0&&Ext.Error.raise("Invalid time axis configuration or filter, please check your input data.");this.resumeEvents();u=Sch.util.Date;i=e.length;this.isContinuous()?(this.adjustedStart=o.start,this.adjustedEnd=this.getNext(i>1?e[i-1].start:o.start,r,f)):(this.adjustedStart=this.getStart(),this.adjustedEnd=this.getEnd());do this.visibleTickStart=(this.getStart()-this.adjustedStart)/(u.getUnitDurationInMs(r)*f),this.visibleTickStart>=1&&(this.adjustedStart=u.getNext(this.adjustedStart,r,f));while(this.visibleTickStart>=1);do this.visibleTickEnd=i-(this.adjustedEnd-this.getEnd())/(u.getUnitDurationInMs(r)*f),i-this.visibleTickEnd>=1&&(this.adjustedEnd=u.getNext(this.adjustedEnd,r,-1));while(i-this.visibleTickEnd>=1);this.fireEvent("endreconfigure",this,t)}},setMode:function(n){this.mode=n;this.generateTicksValidatorFn=n==="calendar"?function(n){return this.startTime>0||this.endTime<24?n.getHours()>=this.startTime&&n.getHours()<this.endTime:!0}:function(){return!0}},setTimeSpan:function(n,t){var i=this.getAdjustedDates(n,t);n=i.start;t=i.end;(this.getStart()-n!=0||this.getEnd()-t!=0)&&this.reconfigure({start:n,end:t})},filterBy:function(n,t){this.continuous=!1;t=t||this;this.clearFilter(!0);this.suspendEvents(!0);this.filter([{filterFn:function(i,r){return n.call(t,i.data,r)}}]);this.getCount()===0&&(this.clearFilter(),this.resumeEvents(),Ext.Error.raise("Invalid time axis filter - no ticks passed through the filter. Please check your filter method."));this.resumeEvents()},isContinuous:function(){return this.continuous&&!this.isFiltered()},clearFilter:function(){this.continuous=this.originalContinuous;this.callParent(arguments)},generateTicks:function(n,t,i,r){var f=[],u,o=Sch.util.Date,e=0,s,h;for(i=i||this.unit,r=r||this.increment,s=this.getAdjustedDates(n,t),n=s.start,t=s.end;n<t;)u=this.getNext(n,i,r),!this.autoAdjust&&u>t&&(u=t),i===o.HOUR&&r>1&&f.length>0&&e===0&&(h=f[f.length-1],e=(h.start.getHours()+r)%24-h.end.getHours(),e!==0&&(u=o.add(u,o.HOUR,e))),this.generateTicksValidatorFn(n)&&f.push({start:n,end:u}),n=u;return f},getVisibleTickTimeSpan:function(){return this.isContinuous()?this.visibleTickEnd-this.visibleTickStart:this.getCount()},getAdjustedDates:function(n,t,i){var r=Sch.util.Date,e,o,u,s,f;return n=n||this.getStart(),t=t||r.add(n,this.mainUnit,this.defaultSpan),this.mode==="calendar"?this.shiftUnit===r.MONTH&&(e=r.add(n,r.WEEK,1),o=r.add(t,r.WEEK,-1),t||(t=this.getNext(n,this.shiftUnit,1),t=this.ceilDate(t,!1,this.shiftUnit,1),t=this.ceilDate(t,!1,this.mainUnit,1)),e.getMonth()!==n.getMonth()&&o.getMonth()!==t.getMonth())?{start:n,end:t}:(u=this.floorDate(n,!1,this.shiftUnit,1),u=this.floorDate(u,!1,this.mainUnit,1),s=this.getNext(n,this.shiftUnit,1),f=this.ceilDate(s,!1,this.shiftUnit,1),f=this.ceilDate(f,!1,this.mainUnit,1),{start:u,end:f}):this.autoAdjust||i?{start:this.floorDate(n,!1,this.autoAdjust?this.mainUnit:this.unit,1),end:this.ceilDate(t,!1,this.autoAdjust?this.mainUnit:this.unit,1)}:{start:n,end:t}},getTickFromDate:function(n){var t=this.data.items,u=t.length-1,o,i,e,f;if(n<t[0].data.start||n>t[u].data.end)return-1;if(this.isContinuous()){if(n-t[0].data.start==0)return this.visibleTickStart;if(n-t[u].data.end==0)return this.visibleTickEnd;var s=this.adjustedStart,h=this.adjustedEnd,r=Math.floor(t.length*(n-s)/(h-s));return(r>u&&(r=u),i=r===0?s:t[r].data.start,e=r==u?h:t[r].data.end,o=r+(n-i)/(e-i),o<this.visibleTickStart||o>this.visibleTickEnd)?-1:o}for(f=0;f<=u;f++)if(e=t[f].data.end,n<=e)return i=t[f].data.start,f+(n>i?(n-i)/(e-i):0);return-1},getDateFromTick:function(n,t){if(n===this.visibleTickEnd)return this.getEnd();var i=Math.floor(n),o=n-i,u=this.getAt(i);if(!u)return null;var f=u.data,e=i===0?this.adjustedStart:f.start,s=i==this.getCount()-1&&this.isContinuous()?this.adjustedEnd:f.end,r=Sch.util.Date.add(e,Sch.util.Date.MILLI,o*(s-e));return t&&(r=this[t+"Date"](r)),r},getTicks:function(){var n=[];return this.each(function(t){n.push(t.data)}),n},getStart:function(){var n=this.first();return n?new Date(n.data.start):null},getEnd:function(){var n=this.last();return n?new Date(n.data.end):null},floorDate:function(n,t,i,r){var f,e,c,h;t=t!==!1;var u=Ext.Date.clone(n),o=t?this.getStart():null,s=r||this.resolutionIncrement,l;l=i?i:t?this.resolutionUnit:this.mainUnit;f=Sch.util.Date;e=function(n,t){return Math.floor(n/t)*t};switch(l){case f.MILLI:t&&(u=f.add(o,f.MILLI,e(f.getDurationInMilliseconds(o,u),s)));break;case f.SECOND:t?u=f.add(o,f.MILLI,e(f.getDurationInSeconds(o,u),s)*1e3):(u.setMilliseconds(0),u.setSeconds(e(u.getSeconds(),s)));break;case f.MINUTE:t?u=f.add(o,f.SECOND,e(f.getDurationInMinutes(o,u),s)*60):(u.setMinutes(e(u.getMinutes(),s)),u.setSeconds(0),u.setMilliseconds(0));break;case f.HOUR:t?u=f.add(o,f.MINUTE,e(f.getDurationInHours(this.getStart(),u),s)*60):(u.setMinutes(0),u.setSeconds(0),u.setMilliseconds(0),u.setHours(e(u.getHours(),s)));break;case f.DAY:t?u=f.add(o,f.DAY,e(f.getDurationInDays(o,u),s)):(Sch.util.Date.clearTime(u),u.setDate(e(u.getDate()-1,s)+1));break;case f.WEEK:c=u.getDay()||7;h=this.weekStartDay||7;Sch.util.Date.clearTime(u);u=f.add(u,f.DAY,c>=h?h-c:-(7-h+c));u.getDay()!==h&&u.getHours()===23&&(u=f.add(u,f.HOUR,1));break;case f.MONTH:t?u=f.add(o,f.MONTH,e(f.getDurationInMonths(o,u),s)):(Sch.util.Date.clearTime(u),u.setDate(1),u.setMonth(e(u.getMonth(),s)));break;case f.QUARTER:Sch.util.Date.clearTime(u);u.setDate(1);u=f.add(u,f.MONTH,-(u.getMonth()%3));break;case f.YEAR:u=t?f.add(o,f.YEAR,e(f.getDurationInYears(o,u),s)):new Date(e(n.getFullYear()-1,s)+1,0,1)}return u},roundDate:function(n,t){var i=Ext.Date.clone(n),r=this.resolutionIncrement,f,e,o,s,h,c,l,a,v,y,u,p,w,b,k,d;t=t||this.getStart();switch(this.resolutionUnit){case Sch.util.Date.MILLI:f=Sch.util.Date.getDurationInMilliseconds(t,i);e=Math.round(f/r)*r;i=Sch.util.Date.add(t,Sch.util.Date.MILLI,e);break;case Sch.util.Date.SECOND:o=Sch.util.Date.getDurationInSeconds(t,i);s=Math.round(o/r)*r;i=Sch.util.Date.add(t,Sch.util.Date.MILLI,s*1e3);break;case Sch.util.Date.MINUTE:h=Sch.util.Date.getDurationInMinutes(t,i);c=Math.round(h/r)*r;i=Sch.util.Date.add(t,Sch.util.Date.SECOND,c*60);break;case Sch.util.Date.HOUR:l=Sch.util.Date.getDurationInHours(t,i);a=Math.round(l/r)*r;i=Sch.util.Date.add(t,Sch.util.Date.MINUTE,a*60);break;case Sch.util.Date.DAY:v=Sch.util.Date.getDurationInDays(t,i);y=Math.round(v/r)*r;i=Sch.util.Date.add(t,Sch.util.Date.DAY,y);break;case Sch.util.Date.WEEK:Sch.util.Date.clearTime(i);u=i.getDay()-this.weekStartDay;u<0&&(u=7+u);p=Math.round(u/7)===1?7-u:-u;i=Sch.util.Date.add(i,Sch.util.Date.DAY,p);break;case Sch.util.Date.MONTH:w=Sch.util.Date.getDurationInMonths(t,i)+i.getDate()/Ext.Date.getDaysInMonth(i);b=Math.round(w/r)*r;i=Sch.util.Date.add(t,Sch.util.Date.MONTH,b);break;case Sch.util.Date.QUARTER:Sch.util.Date.clearTime(i);i.setDate(1);i=Sch.util.Date.add(i,Sch.util.Date.MONTH,3-i.getMonth()%3);break;case Sch.util.Date.YEAR:k=Sch.util.Date.getDurationInYears(t,i);d=Math.round(k/r)*r;i=Sch.util.Date.add(t,Sch.util.Date.YEAR,d)}return i},ceilDate:function(n,t,i){var r=Ext.Date.clone(n),e,u,f;t=t!==!1;e=t?this.resolutionIncrement:1;u=!1;f=i?i:t?this.resolutionUnit:this.mainUnit;switch(f){case Sch.util.Date.HOUR:(r.getMinutes()>0||r.getSeconds()>0||r.getMilliseconds()>0)&&(u=!0);break;case Sch.util.Date.DAY:(r.getHours()>0||r.getMinutes()>0||r.getSeconds()>0||r.getMilliseconds()>0)&&(u=!0);break;case Sch.util.Date.WEEK:Sch.util.Date.clearTime(r);(r.getDay()!==this.weekStartDay||n.getTime()-r.getTime()>0)&&(u=!0);break;case Sch.util.Date.MONTH:Sch.util.Date.clearTime(r);(r.getDate()!==1||n.getTime()-r.getTime()>0)&&(u=!0);break;case Sch.util.Date.QUARTER:Sch.util.Date.clearTime(r);(r.getMonth()%3!=0||r.getDate()!==1||n.getTime()-r.getTime()>0)&&(u=!0);break;case Sch.util.Date.YEAR:Sch.util.Date.clearTime(r);(r.getMonth()!==0||r.getDate()!==1||n.getTime()-r.getTime()>0)&&(u=!0)}return u?this.getNext(r,f,e):r},getNext:function(n,t,i){return Sch.util.Date.getNext(n,t,i,this.weekStartDay)},getResolution:function(){return{unit:this.resolutionUnit,increment:this.resolutionIncrement}},setResolution:function(n,t){this.resolutionUnit=n;this.resolutionIncrement=t||1},shift:function(n,t){this.setTimeSpan(Sch.util.Date.add(this.getStart(),t,n),Sch.util.Date.add(this.getEnd(),t,n))},shiftNext:function(n){n=n||this.getShiftIncrement();var t=this.getShiftUnit();this.setTimeSpan(Sch.util.Date.add(this.getStart(),t,n),Sch.util.Date.add(this.getEnd(),t,n))},shiftPrevious:function(n){n=-(n||this.getShiftIncrement());var t=this.getShiftUnit();this.setTimeSpan(Sch.util.Date.add(this.getStart(),t,n),Sch.util.Date.add(this.getEnd(),t,n))},getShiftUnit:function(){return this.shiftUnit||this.mainUnit},getShiftIncrement:function(){return this.shiftIncrement||1},getUnit:function(){return this.unit},getIncrement:function(){return this.increment},getRowTicks:function(){if(this.mode!=="plain"){var t=this.getStart(),i=Sch.util.Date.add(t,this.headerConfig.middle.splitUnit,1),n=this.findBy(function(n){return n.getStartDate().getTime()>=i.getTime()});return n===-1?this.getRange():this.getRange(0,n-1)}},dateInAxis:function(n){return Sch.util.Date.betweenLesser(n,this.getStart(),this.getEnd())},timeSpanInAxis:function(n,t){return this.isContinuous()?Sch.util.Date.intersectSpans(n,t,this.getStart(),this.getEnd()):n<this.getStart()&&t>this.getEnd()||this.getTickFromDate(n)!==this.getTickFromDate(t)},isRangeInAxis:function(n){var t=n.getStartDate(),i=n.getEndDate();return!t||!i?!1:this.timeSpanInAxis(t,i)},forEachAuxInterval:function(n,t,i,r){r=r||this;var f=this.getEnd(),u=this.getStart(),o=0,e;if(u>f)throw"Invalid time axis configuration";while(u<f)e=Sch.util.Date.min(this.getNext(u,n,t||1),f),i.call(r,u,e,o),u=e,o++},consumeViewPreset:function(n){Ext.apply(this,{unit:n.getBottomHeader().unit,increment:n.getBottomHeader().increment||1,resolutionUnit:n.timeResolution.unit,resolutionIncrement:n.timeResolution.increment,mainUnit:n.getMainHeader().unit,shiftUnit:n.shiftUnit,shiftIncrement:n.shiftIncrement||1,defaultSpan:n.defaultSpan||1,presetName:n.name,headerConfig:n.headerConfig})}});Ext.define("Robo.Transaction",{actions:null,title:null,constructor:function(n){n=n||{};Ext.apply(this,n);this.callParent([n]);this.actions=[]},hasActions:function(){return this.actions.length>0},addAction:function(n){this.actions.push(n)},getActions:function(){return this.actions},undo:function(){for(var n=this.actions.length-1;n>=0;n--)this.actions[n].undo()},redo:function(){for(var n=0;n<this.actions.length;n++)this.actions[n].redo()},getTitle:function(){if(this.title)return this.title;var n=this.actions[0];return n?n.getTitle():null}});Ext.define("Robo.action.Base",{constructor:function(n){Ext.apply(this,n)},undo:function(){throw new Error("Abstract method call");},redo:function(){throw new Error("Abstract method call");},getTitle:function(){return""}});Ext.define("Robo.action.flat.Update",{extend:Robo.action.Base,inheritableStatics:{CUSTOMLY_PROCESSED:{}},config:{record:null,fieldNames:null},oldValues:null,newValues:null,constructor:function(n){var t=this;t.callParent([n]);t.initConfig(n);t.saveValues()},saveValues:function(){var n=this,i=n.getRecord(),t=n.getFieldNames();t&&(n.oldValues=Ext.Array.map(t,function(t){return n.processSavingOldValue(t,i)}),n.newValues=Ext.Array.map(t,function(t){return n.processSavingNewValue(t,i)}))},undo:function(){var i,n=this,t=n.getRecord(),r=n.getFieldNames(),u;r&&(i=n.self.CUSTOMLY_PROCESSED,t.beginEdit(),u=Robo.util.Array.reduce(r,function(r,u,f){var e;return u&&(e=n.processRestoringValue(n.oldValues[f],u,t,"undo"),e!==i&&(r[u]=e)),r},{}),t.set(u),t.endEdit())},redo:function(){var i,n=this,t=n.getRecord(),r=n.getFieldNames(),u;r&&(i=n.self.CUSTOMLY_PROCESSED,t.beginEdit(),u=Robo.util.Array.reduce(r,function(r,u,f){var e;return u&&(e=n.processRestoringValue(n.newValues[f],u,t,"redo"),e!==i&&(r[u]=e)),r},{}),t.set(u),t.endEdit())},processSavingOldValue:function(n,t){var i=t.previous||t.previousValues;if(i&&i.hasOwnProperty(n))return i[n];if(t.editMementoFix)return i=t.editMementoFix.previousValues||t.editMementoFix.data,i[n];throw"Can not get previous value";},processSavingNewValue:function(n,t){return t.get(n)},processRestoringValue:Ext.identityFn,getTitle:function(){var n=this.getRecord(),t=this.getFieldNames();return n.getTitle?"Edit of "+t[0]+" for "+n.getTitle():n.modelName?"Edit of "+n.modelName+" "+n.getId():""}});Ext.define("Robo.action.flat.Add",{extend:Robo.action.Base,store:null,records:null,index:null,undo:function(){var t=this.records,n;for(this.store.remove(t),n=0;n<t.length;n++)this.store.removeFromRemoved(t[n])},redo:function(){this.store.insert(this.index,this.records)},getRecord:function(){return this.records[0]},getTitle:function(){var n=Ext.Array.map(this.records,function(n){return n.getTitle?n.getTitle():n.modelName?n.modelName+" "+n.getId():"unknown"});return"Addition of "+n.join(",")}});Ext.define("Robo.action.flat.Remove",{extend:Robo.action.Base,store:null,records:null,index:null,undo:function(){var n=this;n.store.insert(n.index,n.records)},redo:function(){var n=this;n.store.remove(n.records)},getRecord:function(){return this.records[0]},getTitle:function(){var n=Ext.Array.map(this.records,function(n){return n.getTitle?n.getTitle():n.modelName?n.modelName+" "+n.getId():"unknown"});return"Removal of "+n.join(",")}});Ext.define("Robo.action.tree.Append",{extend:Robo.action.Base,parent:null,newChild:null,undo:function(){var n=this.newChild,t;this.parent.removeChild(n);delete n.data.lastParentId;t=this.parent.getTreeStore();Ext.Array.remove(t.removedNodes,n)},redo:function(){this.parent.appendChild(this.newChild)},getRecord:function(){return this.newChild},getTitle:function(){var n=this.newChild,t;if(n.getTitle)t=n.getTitle();else if(n.modelName)return n.modelName+" "+n.getId();return"Append of "+t}});Ext.define("Robo.action.tree.Insert",{extend:Robo.action.Base,parent:null,newChild:null,insertedBefore:null,undo:function(){var n=this.newChild,t;this.parent.removeChild(n);delete n.data.lastParentId;t=this.parent.getTreeStore();Ext.Array.remove(t.removedNodes,n)},redo:function(){var n=this.insertedBefore,t=n&&n.isFirst();this.parent.insertBefore(this.newChild,n);t&&n.updateInfo(!1,{isFirst:!1})},getRecord:function(){return this.newChild},getTitle:function(){var n=this.newChild,t;if(n.getTitle)t=n.getTitle();else if(n.modelName)return n.modelName+" "+n.getId();return"Insertion of "+t}});Ext.define("Robo.action.tree.Remove",{extend:Robo.action.Base,parent:null,removedChild:null,nextSibling:null,newParent:null,newNextSibling:null,dirty:!1,isMove:!1,constructor:function(){this.callParent(arguments);this.dirty=this.removedChild.dirty},undo:function(){var i;this.isMove&&(this.newParent=this.removedChild.parentNode,this.newNextSibling=this.removedChild.nextSibling);var n=this.nextSibling,r=n&&n.isFirst(),t=this.removedChild;this.parent.insertBefore(t,n);t.dirty=this.dirty;this.isMove||(i=t.getTreeStore(),t.cascadeBy(function(n){Ext.Array.remove(i.removedNodes,n)}));r&&n.updateInfo(!1,{isFirst:!1})},redo:function(){if(this.isMove){var n=this.newNextSibling,t=n&&n.isFirst();this.newParent.insertBefore(this.removedChild,n);t&&n.updateInfo(!1,{isFirst:!1})}else this.parent.removeChild(this.removedChild),delete this.removedChild.data.lastParentId},getRecord:function(){return this.removedChild},getTitle:function(){var n=this.removedChild,t;if(n.getTitle)t=n.getTitle();else if(n.modelName)return n.modelName+" "+n.getId();return this.isMove?"Move of "+t:"Removal of "+t}});Ext.define("Robo.action.tree.Update",{extend:Robo.action.flat.Update,processRestoringValue:function(n,t,i,r){var u=this;return t==="expanded"?(n?i.expand():i.collapse(),n=u.self.CUSTOMLY_PROCESSED):t=="leaf"?(n=u.callParent(arguments),n===!0&&r=="undo"&&(i.data.loaded=!1)):n=u.callParent(arguments),n}});Ext.define("Robo.Manager",{extend:Ext.util.Observable,stores:null,storesById:null,treeStoreListeners:null,flatStoreListeners:null,stub:function(){},undoQueue:null,redoQueue:null,ignoredFieldNames:{expanded:1},state:"created",transactionBoundary:"timeout",transactionMaxDuration:100,transactionTimeout:null,currentTransaction:null,constructor:function(n){var t=this,i;n=n||{};Ext.apply(t,n);t.treeStoreListeners={nodeappend:t.onTreeStoreAppend,nodeinsert:t.onTreeStoreInsert,noderemove:t.onTreeStoreRemove,update:t.onTreeStoreUpdate,load:t.clearQueues,clear:t.clearQueues,scope:t};t.flatStoreListeners={add:t.onFlatStoreAdd,remove:t.onFlatStoreRemove,update:t.onFlatStoreUpdate,load:t.clearQueues,clear:t.clearQueues,scope:t};t.callParent([n]);i=t.stores||[];t.stores=[];t.storesById={};t.undoQueue=[];t.redoQueue=[];Ext.Array.forEach(i,function(n){t.addStore(n)})},addStore:function(n,t){n=Ext.data.StoreManager.lookup(n);Ext.Assert&&Ext.Assert.isObject(n,"Must provide a store or a valid store id");this.stores.push(n);t&&n.setStoreId(t);this.storesById[n.storeId]=n},getStoreById:function(n){return this.storesById[n]},bindStore:function(n){(n.undoRedoEventBus||n).on(this.getStoreTypeListeners(n));if(n.undoRedoEventBus)n.on(this.getStoreTypeListenerStubs(n))},unbindStore:function(n){(n.undoRedoEventBus||n).un(this.getStoreTypeListeners(n));n.undoRedoEventBus&&n.un(this.getStoreTypeListenerStubs(n))},getStoreTypeListenerStubs:function(n){var i=this,t=this.getStoreTypeListeners(n);return t=Ext.apply({},t),Ext.Object.each(t,function(n){t[n]=i.stub}),t},getStoreTypeListeners:function(n){return Ext.data.TreeStore&&n instanceof Ext.data.TreeStore?this.treeStoreListeners:this.flatStoreListeners},removeStore:function(n){Ext.Array.remove(this.stores,n);this.storesById[n.storeId]=null;this.unbindStore(n)},forEachStore:function(n){Ext.Array.forEach(this.stores,n,this)},onAnyChangeInAnyStore:function(n){return this.state==="paused"||n.isRootSettingOrLoading&&n.isRootSettingOrLoading()?!1:(this.currentTransaction||this.startTransaction(),!0)},hasPersistableChanges:function(n,t){var i=this.ignoredFieldNames;return Robo.util.Array.reduce(t,function(t,r){var u=n.getField(r);return t||!u||u.persist&&(!n.isNode||!i.hasOwnProperty(r))},!1)},onFlatStoreUpdate:function(n,t,i,r){this.onAnyChangeInAnyStore(n)&&i=="edit"&&r&&r.length&&this.hasPersistableChanges(t,r)&&this.currentTransaction.addAction(new Robo.action.flat.Update({record:t,fieldNames:r}))},onFlatStoreAdd:function(n,t,i){this.onAnyChangeInAnyStore(n)&&this.currentTransaction.addAction(new Robo.action.flat.Add({store:n,records:t,index:i}))},onFlatStoreRemove:function(n,t,i,r){this.onAnyChangeInAnyStore(n)&&this.currentTransaction.addAction(new Robo.action.flat.Remove({store:n,records:t,index:i,isMove:r}))},onTreeStoreUpdate:function(n,t,i,r){this.onAnyChangeInAnyStore(n)&&i=="edit"&&r&&r.length&&this.hasPersistableChanges(t,r)&&this.currentTransaction.addAction(new Robo.action.tree.Update({record:t,fieldNames:r}))},onTreeStoreAppend:function(n,t){n&&this.onAnyChangeInAnyStore(n.getTreeStore())&&(t.$undoRedoMoving?delete t.$undoRedoMoving:this.currentTransaction.addAction(new Robo.action.tree.Append({parent:n,newChild:t})))},onTreeStoreInsert:function(n,t,i){n&&this.onAnyChangeInAnyStore(n.getTreeStore())&&(t.$undoRedoMoving?delete t.$undoRedoMoving:this.currentTransaction.addAction(new Robo.action.tree.Insert({parent:n,newChild:t,insertedBefore:i})))},onTreeStoreRemove:function(n,t,i,r){this.onAnyChangeInAnyStore(n.getTreeStore())&&(i&&(t.$undoRedoMoving=!0),this.currentTransaction.addAction(new Robo.action.tree.Remove({parent:n,removedChild:t,nextSibling:r.nextSibling,isMove:i})))},start:function(){(this.state=="created"||this.state=="disabled")&&(this.fireEvent("start",this),this.fireEvent("undoqueuechange",this,this.undoQueue),this.fireEvent("redoqueuechange",this,this.redoQueue));this.state!=="hold"&&(this.forEachStore(this.bindStore),this.state="enabled")},stop:function(){this.endTransaction();this.forEachStore(this.unbindStore);this.state="disabled";this.clearQueues();this.fireEvent("stop",this)},clearQueues:function(){this.clearUndoQueue();this.clearRedoQueue()},pause:function(){this.state="paused"},resume:function(){this.state="enabled"},hold:function(){Ext.Assert&&Ext.Assert.isObject(this.currentTransaction,"Can't hold, no transaction is currently in progress");this.state="hold"},release:function(){Ext.Assert&&Ext.Assert.isObject(this.currentTransaction,"Can't release, no transaction is currently in progress");this.state="enabled"},getUndoQueue:function(){return this.undoQueue.slice()},getRedoQueue:function(){return this.redoQueue.slice()},clearUndoQueue:function(){this.undoQueue.length&&(this.undoQueue=[],this.fireEvent("undoqueuechange",this,this.undoQueue.slice()))},clearRedoQueue:function(){this.redoQueue.length&&(this.redoQueue=[],this.fireEvent("redoqueuechange",this,this.redoQueue.slice()))},startTransaction:function(n){var t=this,i;t.state!="disabled"&&(t.currentTransaction&&t.endTransaction(),i=new Robo.Transaction({title:n}),t.currentTransaction=i,t.notifyStoresAboutTransactionStart(i),t.transactionBoundary=="timeout"&&t.scheduleEndTransaction())},scheduleEndTransaction:function(){var n=this;n.transactionTimeout&&clearTimeout(n.transactionTimeout);n.transactionTimeout=setTimeout(function(){n.state!=="hold"?(n.endTransaction(),n.transactionTimeout=null):n.scheduleEndTransaction()},n.transactionMaxDuration)},endTransaction:function(){var n=this,t=n.currentTransaction;return t?(n.currentTransaction=null,n.transactionBoundary=="timeout"&&(clearTimeout(n.transactionTimeout),n.transactionTimeout=null),t.hasActions()&&n.addTransaction(t),n.notifyStoresAboutTransactionEnd(t),t.hasActions()):!1},addTransaction:function(n){this.undoQueue.push(n);this.fireEvent("undoqueuechange",this,this.undoQueue.slice());this.redoQueue.length&&(this.redoQueue.length=0,this.fireEvent("redoqueuechange",this,this.redoQueue.slice()));this.fireEvent("transactionadd",this,n)},undo:function(n){var t=this.undoQueue,i,r,u,f=t.length;if(this.state!="disabled"&&n!==0&&t.length){if(n instanceof Robo.Transaction){if(i=Ext.Array.indexOf(t,n),i==-1)return;n=t.length-i}for(n=n||1,this.fireEvent("beforeundo",this),this.pause(),this.notifyStoresAboutUndoRedoStart(),u=0;u<Math.min(n,f);u++)r=t.pop(),r.undo(),this.redoQueue.unshift(r);this.notifyStoresAboutUndoRedoComplete();this.fireEvent("undoqueuechange",this,t.slice());this.fireEvent("redoqueuechange",this,this.redoQueue.slice());this.resume();this.fireEvent("afterundo",this)}},redo:function(n){var t=this.redoQueue,i,r,u,f=t.length;if(this.state!="disabled"&&n!==0&&t.length){if(n instanceof Robo.Transaction){if(r=Ext.Array.indexOf(t,n),r==-1)return;n=r+1}for(n=n||1,this.fireEvent("beforeredo",this),this.pause(),this.notifyStoresAboutUndoRedoStart(),u=0;u<Math.min(n,f);u++)i=this.redoQueue.shift(),i.redo(),this.undoQueue.push(i);this.notifyStoresAboutUndoRedoComplete();this.fireEvent("redoqueuechange",this,this.redoQueue.slice());this.fireEvent("undoqueuechange",this,this.undoQueue.slice());this.resume();this.fireEvent("afterredo",this)}},undoAll:function(){this.undo(this.undoQueue.length)},notifyStoresAboutTransactionStart:function(n){this.forEachStore(function(t){t.onUndoRedoTransactionStart&&t.onUndoRedoTransactionStart(this,n)})},notifyStoresAboutTransactionEnd:function(n){this.forEachStore(function(t){t.onUndoRedoTransactionEnd&&t.onUndoRedoTransactionEnd(this,n)})},notifyStoresAboutUndoRedoStart:function(){this.forEachStore(function(n){n.beforeUndoRedo&&n.beforeUndoRedo(this)})},notifyStoresAboutUndoRedoComplete:function(){this.forEachStore(function(n){n.afterUndoRedo&&n.afterUndoRedo(this)})}},function(){Ext.apply(Robo,{VERSION:"4.1.2"})});Ext.define("Sch.eventlayout.Horizontal",{nbrOfBandsByResource:null,bandIndexToPxConvertFn:null,bandIndexToPxConvertScope:null,constructor:function(n){Ext.apply(this,n);this.nbrOfBandsByResource={}},clearCache:function(n){n?delete this.nbrOfBandsByResource[n.internalId]:this.nbrOfBandsByResource={}},getNumberOfBands:function(n,t){var i=this.nbrOfBandsByResource,r,u;return i.hasOwnProperty(n.internalId)?i[n.internalId]:(r=Ext.isFunction(t)?t():t,u=Ext.Array.map(r,function(n){return{start:n.getStartDate(),end:n.getEndDate(),event:n}}),this.applyLayout(u,n))},applyLayout:function(n,t){var i=n.slice(),r=this;return i.sort(function(n,t){return r.sortEvents(n.event,t.event)}),this.nbrOfBandsByResource[t.internalId]=this.layoutEventsInBands(i)},sortEvents:function(n,t){var i=n.getStartDate(),r=t.getStartDate(),u=i-r==0;return u?n.getEndDate()>t.getEndDate()?-1:1:i<r?-1:1},layoutEventsInBands:function(n){var i=0,t;do{for(t=n[0];t;)t.top=this.bandIndexToPxConvertFn.call(this.bandIndexToPxConvertScope||this,i,t.event),Ext.Array.remove(n,t),t=this.findClosestSuccessor(t,n);i++}while(n.length>0);return i},findClosestSuccessor:function(n,t){for(var u=Infinity,f,e=n.end,r,o=n.end-n.start==0,i=0,s=t.length;i<s;i++)r=t[i].start-e,r>=0&&r<u&&(r>0||t[i].end-t[i].start>0||!o)&&(f=t[i],u=r);return f}});Ext.define("Sch.eventlayout.Vertical",{view:null,constructor:function(n){Ext.apply(this,n)},applyLayout:function(n,t){var l,i,o,u,h,s,c,v,y,a,p,f,e,r;if(n.length!==0){for(l=this,n.sort(function(n,t){return l.sortEvents(n.event,t.event)}),a=this.view,p=Sch.util.Date,i=0,o=n.length;i<o;i++){if(e=n[i],v=e.start,y=e.end,f=this.findStartSlot(n,e),u=this.getCluster(n,i),u.length>1){for(e.left=f.start,e.width=f.end-f.start,r=1;r<u.length-1&&u[r+1].start-e.start==0;)r++;h=this.findStartSlot(n,u[r]);h&&h.start<.8&&(u=u.slice(0,r))}for(s=u.length,c=(f.end-f.start)/s,r=0;r<s;r++)u[r].width=c,u[r].left=f.start+r*c;i+=s-1}for(i=0,o=n.length;i<o;i++)n[i].width=n[i].width*t,n[i].left=a.barMargin+n[i].left*t}},findStartSlot:function(n,t){var i=this.getPriorOverlappingEvents(n,t),r;if(i.length===0)return{start:0,end:1};for(r=0;r<i.length;r++){if(r===0&&i[0].left>0)return{start:0,end:i[0].left};if(i[r].left+i[r].width<(r<i.length-1?i[r+1].left:1))return{start:i[r].left+i[r].width,end:r<i.length-1?i[r+1].left:1}}return!1},getPriorOverlappingEvents:function(n,t){for(var u=Sch.util.Date,f=t.start,e=t.end,r=[],i=0,o=Ext.Array.indexOf(n,t);i<o;i++)u.intersectSpans(f,e,n[i].start,n[i].end)&&r.push(n[i]);return r.sort(this.sortOverlappers),r},sortOverlappers:function(n,t){return n.left<t.left?-1:1},getCluster:function(n,t){if(t>=n.length-1)return[n[t]];for(var e=[n[t]],r=n[t].start,u=n[t].end,o=n.length,f=Sch.util.Date,i=t+1;i<o&&f.intersectSpans(r,u,n[i].start,n[i].end);)e.push(n[i]),r=f.max(r,n[i].start),u=f.min(n[i].end,u),i++;return e},sortEvents:function(n,t){var i=n.getStartDate(),u=n.getEndDate(),r=t.getStartDate(),f=t.getEndDate(),e=i-r==0;return e?u>f?-1:1:i<r?-1:1}});Ext.define("Sch.feature.AbstractTimeSpan",{extend:Ext.AbstractPlugin,mixins:{observable:Ext.util.Observable},lockableScope:"top",schedulerView:null,timeAxis:null,containerEl:null,expandToFitView:!1,disabled:!1,cls:null,clsField:"Cls",template:null,store:null,renderElementsBuffered:!1,renderDelay:15,refreshSizeOnItemUpdate:!0,_resizeTimer:null,_renderTimer:null,showHeaderElements:!1,headerTemplate:null,innerHeaderTpl:null,headerContainerCls:"sch-header-secondary-canvas",headerContainerEl:null,renderingDoneEvent:null,constructor:function(n){this.uniqueCls=this.uniqueCls||"sch-timespangroup-"+Ext.id();Ext.apply(this,n);this.mixins.observable.constructor.call(this);this.callParent(arguments)},setDisabled:function(n){n&&this.removeElements();this.disabled=n},removeElements:function(){this.removeBodyElements();this.showHeaderElements&&this.removeHeaderElements()},getBodyElements:function(){return this.containerEl?this.containerEl.select("."+this.uniqueCls):null},getHeaderContainerEl:function(){var n=this.headerContainerEl,i=Ext.baseCSSPrefix,t;return n&&n.dom||(t=this.schedulerView.isHorizontal()?this.panel.getHorizontalTimeAxisColumn().headerView.containerEl:this.panel.el.down("."+i+"grid-inner-locked ."+i+"panel-body ."+i+"grid-view"),t&&(n=t.down("."+this.headerContainerCls),n||(n=t.appendChild({cls:this.headerContainerCls})),this.headerContainerEl=n)),n},getHeaderElements:function(){var n=this.getHeaderContainerEl();return n?n.select("."+this.uniqueCls):null},removeBodyElements:function(){var n=this.getBodyElements();n&&n.each(function(n){n.destroy()})},removeHeaderElements:function(){var n=this.getHeaderElements();n&&n.each(function(n){n.destroy()})},getElementId:function(n){return this.uniqueCls+"-"+n.internalId},getHeaderElementId:function(n){return this.uniqueCls+"-header-"+n.internalId},getTemplateData:function(n){return this.prepareTemplateData?this.prepareTemplateData(n):n.data},getElementCls:function(n,t){var i=n.clsField||this.clsField;return t||(t=this.getTemplateData(n)),this.cls+" "+this.uniqueCls+" "+(t[i]||"")},getHeaderElementCls:function(n,t){var i=n.clsField||this.clsField;return t||(t=this.getTemplateData(n)),"sch-header-indicator "+this.uniqueCls+" "+(t[i]||"")},init:function(n){if(Ext.versions.touch&&!n.isReady()){n.on("viewready",function(){this.init(n)},this);return}typeof this.innerHeaderTpl=="string"&&(this.innerHeaderTpl=new Ext.XTemplate(this.innerHeaderTpl));var t=this.innerHeaderTpl;if(this.headerTemplate||(this.headerTemplate=new Ext.XTemplate('<tpl for=".">','<div id="{id}" class="{cls}" style="{side}:{position}px;">'+(t?"{[this.renderInner(values)]}":"")+"<\/div>","<\/tpl>",{renderInner:function(n){return t.apply(n)}})),this.schedulerView=n.getSchedulingView(),this.panel=n,this.timeAxis=n.getTimeAxis(),this.store=Ext.StoreManager.lookup(this.store),this.store||Ext.Error.raise("Error: You must define a store for this plugin"),this.schedulerView.getEl())this.onAfterRender();else this.schedulerView.on({afterrender:this.onAfterRender,scope:this})},onAfterRender:function(){var n=this.schedulerView,t;this.containerEl=n.getSecondaryCanvasEl();this.storeListeners={load:this.renderElements,datachanged:this.renderElements,clear:this.renderElements,add:this.renderElements,remove:this.renderElements,update:this.refreshSingle,addrecords:this.renderElements,removerecords:this.renderElements,updaterecord:this.refreshSingle,expand:this.renderElements,collapse:this.renderElements,scope:this};this.store.on(this.storeListeners);n.on({bufferedrefresh:this.renderElements,refresh:this.renderElements,itemadd:this.refreshSizeOnItemUpdate?this.refreshSizes:this.renderElements,itemremove:this.refreshSizeOnItemUpdate?this.refreshSizes:this.renderElements,itemupdate:this.refreshSizeOnItemUpdate?this.refreshSizes:this.renderElements,groupexpand:this.renderElements,groupcollapse:this.renderElements,columnwidthchange:this.renderElements,resize:this.renderElements,scope:this});if(n.headerCt)n.headerCt.on({add:this.renderElements,remove:this.renderElements,scope:this});this.panel.on({viewchange:this.renderElements,show:this.refreshSizes,modechange:this.forceNewRenderingTimeout,scope:this});t=n.getRowContainerEl();t&&t.down(".sch-timetd",!0)&&this.renderElements()},forceNewRenderingTimeout:function(){this.renderElementsBuffered=!1;clearTimeout(this._renderTimer);clearTimeout(this._resizeTimer);this.renderElements()},refreshSizesInternal:function(){if(!this.schedulerView.isDestroyed&&this.schedulerView.isHorizontal()){var n=this.schedulerView.getTimeSpanRegion(new Date,null,this.expandToFitView);this.getBodyElements().setHeight(n.bottom-n.top)}},refreshSizes:function(){clearTimeout(this._resizeTimer);this._resizeTimer=Ext.Function.defer(this.refreshSizesInternal,this.renderDelay,this)},renderElements:function(){this.renderElementsBuffered||this.disabled||(this.renderElementsBuffered=!0,clearTimeout(this._renderTimer),this._renderTimer=Ext.Function.defer(this.renderElementsInternal,this.renderDelay,this))},setElementX:function(n,t){this.panel.rtl?n.setRight(t):n.setLeft(t)},getHeaderElementPosition:function(n){var t=this.schedulerView.getTimeAxisViewModel();return Math.round(t.getPositionFromDate(n))},renderBodyElementsInternal:function(n){if(this.panel.getMode()!=="calendar"){var t=this.timeAxis.getStart(),i=this.timeAxis.getEnd(),r=this.getElementData(t,i,n);this.template.append(this.containerEl,r)}},getHeaderElementData:function(){throw"Abstract method call";},renderHeaderElementsInternal:function(n){var t,i;this.panel.getMode()!=="calendar"&&(t=this.getHeaderContainerEl(),t&&(i=this.getHeaderElementData(n),this.headerTemplate.append(t,i)))},renderElementsInternal:function(){(this.renderElementsBuffered=!1,this.disabled||this.schedulerView.isDestroyed)||(!Ext.versions.extjs||this.schedulerView.getEl().down("."+Ext.baseCSSPrefix+"grid-item-container"))&&(this.removeElements(),this.renderBodyElementsInternal(),this.showHeaderElements&&(this.headerContainerEl=null,this.renderHeaderElementsInternal()),this.renderingDoneEvent&&this.fireEvent(this.renderingDoneEvent,this))},getElementData:function(){throw"Abstract method call";},updateBodyElement:function(n){var t=Ext.get(this.getElementId(n));if(t){var r=this.timeAxis.getStart(),u=this.timeAxis.getEnd(),i=this.getElementData(r,u,[n])[0];i?(t.dom.className=i.$cls,t.setTop(i.top),this.setElementX(t,i.left),t.setSize(i.width,i.height)):Ext.destroy(t)}else this.renderBodyElementsInternal([n])},updateHeaderElement:function(n){var t=Ext.get(this.getHeaderElementId(n)),i;t?(i=this.getHeaderElementData([n])[0],i?(t.dom.className=i.cls,this.schedulerView.isHorizontal()?(this.setElementX(t,i.position),t.setWidth(i.size)):(t.setTop(i.position),t.setHeight(i.size))):Ext.destroy(t)):this.renderHeaderElementsInternal([n])},destroy:function(){clearTimeout(this._renderTimer);clearTimeout(this._resizeTimer);this.store.un(this.storeListeners);this.store.autoDestroy&&this.store.destroy()},refreshSingle:function(n,t){t=t instanceof Array?t:[t];Ext.Array.each(t,function(n){this.updateBodyElement(n);this.showHeaderElements&&this.updateHeaderElement(n)},this)}});Ext.define("Sch.plugin.Lines",{extend:Sch.feature.AbstractTimeSpan,alias:"plugin.scheduler_lines",cls:"sch-timeline",showTip:!0,innerTpl:null,prepareTemplateData:null,side:null,init:function(n){typeof this.innerTpl=="string"&&(this.innerTpl=new Ext.XTemplate(this.innerTpl));this.side=n.rtl?"right":"left";var t=this.innerTpl;this.template||(this.template=new Ext.XTemplate('<tpl for=".">','<div id="{id}" '+(this.showTip?'title="{[this.getTipText(values)]}" ':"")+'class="{$cls}" style="'+this.side+':{left}px;top:{top}px;height:{height}px;width:{width}px">'+(t?"{[this.renderInner(values)]}":"")+"<\/div>","<\/tpl>",{getTipText:function(t){return n.getSchedulingView().getFormattedDate(t.Date)+" "+(t.Text||"")},renderInner:function(n){return t.apply(n)}}));this.callParent(arguments)},getElementData:function(n,t,i){var w=this.store,s=this.schedulerView,h=s.isHorizontal(),l=i||w.getRange(),a=[],v,y,f=s.getTimeSpanRegion(n,null,this.expandToFitView),u,e,r,o,p,c;for(v=Ext.versions.touch?"100%":h?f.bottom-f.top:1,y=h?1:f.right-f.left,o=0,p=l.length;o<p;o++)u=l[o],e=u.get("Date"),e&&Sch.util.Date.betweenLesser(e,n,t)&&(c=s.getCoordinateFromDate(e),r=Ext.apply({},this.getTemplateData(u)),r.id=this.getElementId(u),r.$cls=this.getElementCls(u,r),r.width=y,r.height=v,h?r.left=c:r.top=c,a.push(r));return a},getHeaderElementData:function(n){var s=this.timeAxis.getStart(),h=this.timeAxis.getEnd(),c=this.schedulerView.isHorizontal(),f=[],i,r,e,t,u,o;for(n=n||this.store.getRange(),u=0,o=n.length;u<o;u++)i=n[u],r=i.get("Date"),r&&Sch.util.Date.betweenLesser(r,s,h)&&(e=this.getHeaderElementPosition(r),t=this.getTemplateData(i),t=Ext.apply({side:c?this.side:"top",cls:this.getHeaderElementCls(i,t),position:e},t),t.id=this.getHeaderElementId(i),f.push(t));return f}});Ext.define("Sch.feature.ColumnLines",{extend:Sch.plugin.Lines,cls:"sch-column-line",showTip:!1,timeAxisViewModel:null,renderingDoneEvent:"columnlinessynced",useLowestHeader:null,init:function(n){this.timeAxis=n.getTimeAxis();this.timeAxisViewModel=n.timeAxisViewModel;this.panel=n;this.store=new Ext.data.JsonStore({fields:["Date"]});this.callParent(arguments);n.on({modechange:this.populate,destroy:this.onHostDestroy,scope:this});this.timeAxisViewModel.on("update",this.populate,this);this.populate()},onHostDestroy:function(){this.timeAxisViewModel.un("update",this.populate,this)},populate:function(){this.store.setData(this.getData())},getElementData:function(){var n=this.schedulerView;return n.isHorizontal()&&n.store.getCount()>0?this.callParent(arguments):[]},getData:function(){var l=this.panel,e=[],o,u,h,i,s,c,f,r;if(l.isHorizontal()){var n=this.timeAxisViewModel,t=this.useLowestHeader?n.getLowestHeader():n.columnLinesFor,a=!!(n.headerConfig&&n.headerConfig[t].cellGenerator);if(a)for(o=n.getColumnConfig()[t],u=1,h=o.length;u<h;u++)e.push({Date:o[u].start});else c=n.getColumnConfig(),t==="bottom"?i="middle":t==="middle"&&(i="top"),s=c[i],s&&(r=n.headerConfig,(r[i].increment!==r[t].increment||r[i].unit!==r[t].unit)&&(f={},Ext.Array.each(s,function(n){f[n.start.getTime()]=1}))),n.forEachInterval(t,function(n,t,i){i>0&&e.push({Date:n,Cls:f&&f[n.getTime()]?"sch-column-line-solid":""})})}return e}});Ext.define("Sch.util.ScrollManager",{singleton:!0,vthresh:25,hthresh:25,increment:100,frequency:500,animate:!0,animDuration:200,activeCmp:null,activeEl:null,scrollElRegion:null,scrollProcess:{},pt:null,scrollWidth:null,scrollHeight:null,direction:"both",constructor:function(){this.doScroll=Ext.Function.bind(this.doScroll,this)},triggerRefresh:function(){this.activeEl&&(this.refreshElRegion(),this.clearScrollInterval(),this.onMouseMove())},doScroll:function(){var u=this.scrollProcess,f=u.cmp,e=f.rtl,t=u.dir[0],n=this.increment,o=this.activeCmp.getScrollX(),s=this.activeCmp.getScrollY(),i,r;t==="r"?n=Math.min(n,e?o:this.scrollWidth-o-this.activeEl.dom.clientWidth):t==="d"&&(n=Math.min(n,this.scrollHeight-s-this.activeEl.dom.clientHeight));n=Math.max(n,0);i=0;r=0;t==="r"&&(i=n);t==="l"&&(i=-n);t==="u"&&(r=-n);t==="d"&&(r=n);e&&(i=-i);f.scrollBy(i,r,{duration:this.animDuration,callback:this.triggerRefresh,scope:this})},clearScrollInterval:function(){var n=this.scrollProcess;n.id&&clearTimeout(n.id);n.id=0;n.cmp=null;n.dir=""},isScrollAllowed:function(n){switch(this.direction){case"both":return!0;case"horizontal":return n==="right"||n==="left";case"vertical":return n==="up"||n==="down";default:throw"Invalid direction: "+this.direction;}},startScrollInterval:function(n,t){this.isScrollAllowed(t)&&(this.clearScrollInterval(),this.scrollProcess.cmp=n,this.scrollProcess.dir=t,this.scrollProcess.id=setTimeout(this.doScroll,this.frequency))},onMouseMove:function(n){var r=n?n.getPoint():this.pt,s=r.x,h=r.y,u=this.scrollProcess,t=this.activeCmp,f=t.getScrollX(),c=t.getScrollY(),l=t.rtl,a=this.activeEl,i=this.scrollElRegion,o=a.dom,e=this;if(this.pt=r,i&&i.contains(r)&&a.isScrollable()){if(i.bottom-h<=e.vthresh&&this.scrollHeight-c-o.clientHeight>0){u.cmp!=t&&this.startScrollInterval(t,"down");return}if(i.right-s<=e.hthresh&&(l?f>0:this.scrollWidth-f-o.clientWidth>0)){u.cmp!=t&&this.startScrollInterval(t,"right");return}if(h-i.top<=e.vthresh&&c>0){u.cmp!=t&&this.startScrollInterval(t,"up");return}if(s-i.left<=e.hthresh&&(l?o.clientWidth+f<this.scrollWidth:f>0)){u.cmp!=t&&this.startScrollInterval(t,"left");return}}this.clearScrollInterval()},refreshElRegion:function(){this.scrollElRegion=this.activeEl.getRegion()},activate:function(n,t){var r=Ext.getScrollbarSize(),i;this.direction=t||"both";this.activeCmp=n;this.activeEl=n.getEl();i=n.getScrollable().getMaxPosition();this.scrollWidth=i.x+n.getWidth()-r.width;this.scrollHeight=i.y+n.getHeight()-r.height;this.refreshElRegion();this.activeEl.on("mousemove",this.onMouseMove,this)},deactivate:function(){this.clearScrollInterval();this.activeEl.un("mousemove",this.onMouseMove,this);this.activeEl=this.activeCmp=this.scrollElRegion=this.scrollWidth=this.scrollHeight=null;this.direction="both"}});Ext.define("Sch.util.DragTracker",{extend:Ext.dd.DragTracker,xStep:1,yStep:1,deferredActivation:0,constructor:function(){this.callParent(arguments);this.on("dragstart",function(){var n=this.el,t={scroll:this.onMouseMove,pinchstart:this.onMouseUp,scope:this};n.on(t);this.on("dragend",function(){n.un(t)},this,{single:!0})});this.moveListener={pinchstart:this.abortWait,touchend:this.abortWait,mouseup:this.abortWait,mousemove:this.onMoveWhileWaiting,scope:this,capture:!0}},setXStep:function(n){this.xStep=n},startScroll:null,deferTimer:null,deferTolerance:10,moveListener:null,setYStep:function(n){this.yStep=n},onMoveWhileWaiting:function(n){var t=n.getXY(),i=this.startXY;if(Math.max(Math.abs(i[0]-t[0]),Math.abs(i[1]-t[1]))>this.deferTolerance){this.abortWait();this.onMouseUp(n)}},abortWait:function(){clearTimeout(this.deferTimer);this.deferTimer=null;Ext.getDoc().un(this.moveListener)},getRegion:function(){var t=this.startXY,n=this.el.getScroll();Ext.isIE&&this.rtl&&(n.left=this.el.dom.scrollWidth-this.el.getWidth()-n.left);var i=this.getXY(),r=i[0],u=i[1],h=n.left-this.startScroll.left,c=n.top-this.startScroll.top,f=t[0]-h,e=t[1]-c,o=Math.min(f,r),s=Math.min(e,u),l=Math.abs(f-r),a=Math.abs(e-u);return new Ext.util.Region(s,o+l,s+a,o)},onMouseDown:function(n,t){if(!n.event.touches||!(n.event.touches.length>1)){if(n.stopPropagation=Ext.emptyFn,this.startXY=n.getXY(),this.deferredActivation){var i=this;Ext.getDoc().on(this.moveListener);this.deferTimer=setTimeout(function(){var r=i.deferredActivation;Ext.getDoc().un(i.moveListener);i.deferredActivation=!1;i.onMouseDown(n,t);i.deferredActivation=r},this.deferredActivation);return}this.callParent([n,t]);this.lastXY=this.startXY;this.startScroll=this.el.getScroll();Ext.isIE&&this.rtl&&(this.startScroll.left=this.el.dom.scrollWidth-this.el.getWidth()-this.startScroll.left)}},onMouseMove:function(n){var t,u,i,r,f;if(this.active&&n.type==="mousemove"&&Ext.isIE9m&&!n.browserEvent.button){n.preventDefault();this.onMouseUp(n);return}if(n.preventDefault(),t=n.type==="scroll"?this.lastXY:n.getXY(),u=this.startXY,!this.active)if(Math.max(Math.abs(u[0]-t[0]),Math.abs(u[1]-t[1]))>this.tolerance)this.triggerStart(n);else return;if(i=t[0],r=t[1],this.xStep>1&&(i-=this.startXY[0],i=Math.round(i/this.xStep)*this.xStep+this.startXY[0]),this.yStep>1&&(r-=this.startXY[1],r=Math.round(r/this.yStep)*this.yStep+this.startXY[1]),f=this.xStep>1||this.yStep>1,!f||i!==t[0]||r!==t[1])if(this.lastXY=[i,r],this.fireEvent("mousemove",this,n)===!1)this.onMouseUp(n);else{this.onDrag(n);this.fireEvent("drag",this,n)}}});Ext.define("Sch.tooltip.ClockTemplate",{extend:Ext.XTemplate,minuteHeight:8,minuteTop:2,hourHeight:8,hourTop:2,handLeft:10,mode:"hour",getRotateStyle:function(n){return"transform:rotate(Ddeg);-ms-transform:rotate(Ddeg);-moz-transform: rotate(Ddeg);-webkit-transform: rotate(Ddeg);-o-transform:rotate(Ddeg);".replace(/D/g,n)},getRotateStyleIE:function(){var n=Math.PI/180,t=Math.cos,i=Math.sin;return function(r,u,f){var h=this,e=r*n,o=t(e),s=i(e),c=f*i((90-r)*n),l=f*t((90-r)*n),a=Math.min(f,f-c),v=r>180?l:0,y="progid:DXImageTransform.Microsoft.Matrix(sizingMethod='auto expand', M11 = "+o+", M12 = "+-s+", M21 = "+s+", M22 = "+o+")";return Ext.String.format("filter:{0};-ms-filter:{0};top:{1}px;left:{2}px;",y,a+u,v+h.handLeft)}}(),constructor:function(){var n=Ext.isIE&&Ext.isIE8m;this.callParent(['<div class="sch-clockwrap '+(n?"":"sch-supports-border-radius")+' sch-clock-{[this.mode]}"><div class="sch-clock"><div class="sch-hourIndicator" style="{[this.getHourStyle((values.date.getHours() % 12) * 30,'+this.hourTop+", + "+this.hourHeight+')]}">{[Ext.Date.monthNames[values.date.getMonth()].substr(0,3)]}<\/div><div class="sch-minuteIndicator" style="{[this.getMinuteStyle(values.date.getMinutes() * 6,'+this.minuteTop+", + "+this.minuteHeight+')]}">{[values.date.getDate()]}<\/div>'+(n?"":'<div class="sch-clock-dot"><\/div>')+'<\/div><span class="sch-clock-text">{text}<\/span><\/div>',{getMinuteStyle:n?this.getRotateStyleIE:this.getRotateStyle,getHourStyle:n?this.getRotateStyleIE:this.getRotateStyle}])}});Ext.define("Sch.tooltip.Tooltip",{extend:Ext.tip.ToolTip,autoHide:!1,anchor:"b",padding:"0 3 0 0",showDelay:0,hideDelay:0,quickShowInterval:0,dismissDelay:0,trackMouse:!1,anchorOffset:5,shadow:!1,frame:!1,schedulerView:null,message:null,startDate:null,endDate:null,template:null,valid:!0,mode:null,offsetAdjust:[18,5],constructor:function(){var n=new Sch.tooltip.ClockTemplate;this.startDate=this.endDate=new Date;this.template||(this.template=Ext.create("Ext.XTemplate",'<div class="sch-tip-{[values.valid ? "ok" : "notok"]}">{[this.renderClock(values.startDate, values.startText, "sch-tooltip-startdate")]}{[this.renderClock(values.endDate, values.endText, "sch-tooltip-enddate")]}<div class="sch-tip-message">{message}<\/div><\/div>',{disableFormats:!0,renderClock:function(t,i,r){return n.apply({date:t,text:i,cls:r})}}));this.callParent(arguments)},update:function(n,t,i,r){var u,f,e;(this.startDate-n!=0||this.endDate-t!=0||this.valid!==i||this.message!==r)&&(u=this.message&&!r||!this.message&&r,this.startDate=n,this.endDate=t,this.valid=i,this.message=r,f=this.schedulerView.getFormattedDate(n),e=this.schedulerView.getFormattedEndDate(t,n),this.mode!=="calendar"||t.getHours()!==0||t.getMinutes()!==0||t.getYear()===n.getYear()&&t.getMonth()===n.getMonth()&&t.getDate()===n.getDate()||(t=Sch.util.Date.add(t,Sch.util.Date.DAY,-1)),this.callParent([this.template.apply({valid:i,startDate:n,endDate:t,startText:f,endText:e,message:r})]),u&&this.realign())},show:function(n,t){n&&!Ext.isArray(n)&&(this.rendered===!0&&this.setPosition(0,0),Sch.util.Date.compareUnits(this.schedulerView.getTimeResolution().unit,Sch.util.Date.DAY)>=0?(this.mode="calendar",this.addCls("sch-day-resolution"),this.removeCls("sch-hour-resolution")):(this.mode="clock",this.removeCls("sch-day-resolution"),this.addCls("sch-hour-resolution")),t=arguments.length>1?t:this.offsetAdjust[0],this.mouseOffsets=[t-this.offsetAdjust[0],-this.offsetAdjust[1]],this.setTarget(n),this.callParent(),this.realign())},realign:function(){this.el.alignTo(this.target,"bl-tl",this.mouseOffsets)},afterRender:function(){this.callParent(arguments);this.el.on("mouseenter",this.realign,this)}});Ext.define("Sch.tooltip.HoverTip",{extend:Ext.tip.ToolTip,alias:"widget.scheduler_hovertip",trackMouse:!0,bodyCls:"sch-hovertip",messageTpl:'<div class="sch-hovertip-msg">{message}<\/div>',autoHide:!1,dismissDelay:1e3,showDelay:0,schedulerView:null,clockTpl:null,lastTime:null,lastResource:null,initComponent:function(){var n=this,t=n.schedulerView;n.clockTpl=new Sch.tooltip.ClockTemplate;n.messageTpl=new Ext.XTemplate(n.messageTpl);n.lastTime=null;n.lastResource=null;n.callParent(arguments);n.on("beforeshow",n.tipOnBeforeShow,n);t.mon(t.el,{mouseleave:function(){n.hide()},mousemove:n.handleMouseMove,scope:n});t.mon(t.el,{click:n.onBodyMouseDown,scope:n,delay:1})},onBodyMouseDown:function(){this.hide()},handleMouseMove:function(n){var t=this,i=t.schedulerView,r,u;t.disabled||(n.getTarget("."+i.itemCls,5)&&!n.getTarget(i.eventSelector)?(r=i.getDateFromDomEvent(n,"floor"),r?(u=i.resolveResource(n.getTarget()),(r-t.lastTime!=0||u!==t.lastResource)&&(t.lastResource=u,t.hidden&&(t.clockTpl.mode=Sch.util.Date.compareUnits(this.schedulerView.getTimeResolution().unit,Sch.util.Date.DAY)>=0?"day":"hour",t.show()),t.updateHoverTip(r,n))):(t.hide(),t.lastTime=null,t.lastResource=null)):(t.hide(),t.lastTime=null,t.lastResource=null))},getText:function(){},updateHoverTip:function(n,t){if(n){var i=this.clockTpl.apply({date:n,text:this.schedulerView.getFormattedDate(n)}),r=this.messageTpl.apply({message:this.getText(n,t)});this.update(i+r);this.lastTime=n}},tipOnBeforeShow:function(){return!this.disabled&&this.lastTime!==null}});Ext.define("Sch.feature.DragCreator",{disabled:!1,showHoverTip:!0,showDragTip:!0,dragTip:null,dragTolerance:2,hoverTip:null,validatorFn:Ext.emptyFn,validatorFnScope:null,trackerConfig:null,schedulerView:null,template:'<div class="sch-dragcreator-proxy"><div class="sch-event-inner">&#160;<\/div><\/div>',constructor:function(n){Ext.apply(this,n||{});this.lastTime=new Date;this.template instanceof Ext.Template||(this.template=new Ext.Template(this.template));this.schedulerView.on("destroy",this.onSchedulerDestroy,this);if(Ext.supports.Touch)this.schedulerView.on("boxready",this.initDragTracker,this);else this.schedulerView.el.on("mousemove",this.initDragTracker,this,{single:!0});this.callParent([n])},setDisabled:function(n){this.disabled=n;this.hoverTip&&this.hoverTip.setDisabled(n);this.dragTip&&this.dragTip.setDisabled(n)},getProxy:function(){if(!this.proxy){this.proxy=this.template.append(this.schedulerView.getSecondaryCanvasEl(),{},!0);var n=this.schedulerView.rtl;this.proxy.hide=function(){n?this.setStyle({right:"-10000px",top:"-10000px"}):this.setStyle({left:"-10000px",top:"-10000px"})}}return this.proxy},onBeforeDragStart:function(n,t){var i=this.schedulerView,r=t.getTarget("."+i.timeCellCls,5),u,f;return r&&this.isCreateAllowed(t)&&(!t.event.touches||t.event.touches.length===1)&&(u=i.resolveResource(r),f=i.getDateFromDomEvent(t),!this.disabled&&r&&i.fireEvent("beforedragcreate",i,u,f,t)!==!1)?(this.resourceRecord=u,this.originalStart=f,this.resourceRegion=i.getScheduleRegion(this.resourceRecord,this.originalStart),this.dateConstraints=i.getDateConstraints(this.resourceRecord,this.originalStart),!0):!1},isCreateAllowed:function(n){return!n.getTarget(this.schedulerView.eventSelector)},onDragStart:function(){var n=this,t=n.schedulerView,r=n.tracker.getRegion(),i=n.getProxy();this.dragging=!0;this.hoverTip&&this.hoverTip.disable();n.start=n.originalStart;n.end=n.start;n.originalScroll=t.getScroll();n.rowBoundaries=t.getMode()==="horizontal"?{top:n.resourceRegion.top,bottom:n.resourceRegion.bottom}:{left:n.resourceRegion.left,right:n.resourceRegion.right};Ext.apply(r,n.rowBoundaries);t.rtl&&i.setStyle({right:"auto"});i.setBox(r);i.show();t.fireEvent("dragcreatestart",t,i);n.showDragTip&&(n.dragTip.enable(),n.dragTip.update(n.start,n.end,!0),n.dragTip.show(i),n.dragTip.setStyle("visibility","visible"));Sch.util.ScrollManager.activate(t,t.getMode()==="horizontal"?"horizontal":"vertical")},onDrag:function(){var n=this,i=n.schedulerView,r=n.tracker.getRegion(),u=i.getStartEndDatesFromRegion(r,"round"),e="",t,o,f;u&&(n.start=u.start||n.start,n.end=u.end||n.end,t=n.dateConstraints,t&&(n.end=Sch.util.Date.constrain(n.end,t.start,t.end),n.start=Sch.util.Date.constrain(n.start,t.start,t.end)),n.valid=this.validatorFn.call(n.validatorFnScope||n,n.resourceRecord,n.start,n.end),n.valid&&typeof n.valid!="boolean"&&(e=n.valid.message,n.valid=n.valid.valid),n.valid=n.valid!==!1,n.showDragTip&&n.dragTip.update(n.start,n.end,n.valid,e),Ext.apply(r,n.rowBoundaries),o=i.getScroll(),f=this.getProxy(),f.setBox(r),i.isHorizontal()&&f.setY(n.resourceRegion.top+n.originalScroll.top-o.top))},eventSwallower:function(n){n.stopPropagation();n.preventDefault()},onDragEnd:function(n,t){var i=this,f=i.schedulerView,r=!0,e=t.getTarget(),u=Ext.get(e);u.on("click",this.eventSwallower);setTimeout(function(){u.un("click",i.eventSwallower)},100);i.dragging=!1;i.showDragTip&&i.dragTip.disable();(!i.start||!i.end||i.end-i.start<=0)&&(i.valid=!1);i.createContext={start:i.start,end:i.end,resourceRecord:i.resourceRecord,e:t,finalize:function(){i.finalize.apply(i,arguments)}};i.valid&&(r=f.fireEvent("beforedragcreatefinalize",i,i.createContext,t,this.getProxy())!==!1);r&&i.finalize(i.valid);Sch.util.ScrollManager.deactivate()},finalize:function(n){var r=this.createContext,i=this.schedulerView,t;n?(t=Ext.create(i.getEventStore().getModel()),t.setCalendar&&t.setCalendar(i.getEventStore().getCalendar()),t.setStartEndDate(r.start,r.end),t.setCalendar&&t.setCalendar(null),i.fireEvent("dragcreateend",i,t,r.resourceRecord,r.e,this.getProxy())):this.proxy.hide();this.schedulerView.fireEvent("afterdragcreate",i,this.getProxy());this.hoverTip&&this.hoverTip.enable()},dragging:!1,initDragTracker:function(){var n=this,t=Ext.supports.Touch,i=n.schedulerView,r=Ext.apply({el:i.el,rtl:i.rtl,deferredActivation:t?1e3:!1,tolerance:n.dragTolerance,listeners:{mousedown:n.verifyLeftButtonPressed,beforedragstart:n.onBeforeDragStart,dragstart:n.onDragStart,drag:n.onDrag,dragend:n.onDragEnd,scope:n}},this.trackerConfig);this.bindRightClickPreventer();t?(this.showDragTip=!1,this.showHoverTip=!1,this.dragTip=null,this.hoverTip=null):this.setupTooltips();n.tracker=new Sch.util.DragTracker(r)},bindRightClickPreventer:function(){var n=Ext.isIE9m?"mousedown":"contextmenu";this.schedulerView.el.on(n,this.stopDragCreateOnRightClick,this,{priority:999})},stopDragCreateOnRightClick:function(n){if(n.button!==0&&this.dragging)this.tracker.onMouseUp(n)},setupTooltips:function(){var n=this,t=n.schedulerView,i,r;if(this.showDragTip)if(i=this.dragTip,i instanceof Ext.tip.ToolTip){i.schedulerView=t;i.on("beforeshow",function(){return n.dragging})}else this.dragTip=new Sch.tooltip.Tooltip(Ext.apply({cls:"sch-dragcreate-tip",schedulerView:t,listeners:{beforeshow:function(){return n.dragging}}},i));n.showHoverTip&&(r=n.hoverTip,r instanceof Ext.tip.ToolTip?r.schedulerView=t:n.hoverTip=Ext.ComponentManager.create(Ext.applyIf({renderTo:Ext.getBody(),target:t.el,schedulerView:t},r),"scheduler_hovertip"))},verifyLeftButtonPressed:function(n,t){return t.button===0},onSchedulerDestroy:function(){this.hoverTip&&this.hoverTip.destroy();this.dragTip&&this.dragTip.destroy();this.tracker&&this.tracker.destroy();this.proxy&&(Ext.destroy(this.proxy),this.proxy=null)}});Ext.define("Sch.feature.SchedulerDragZone",{extend:Ext.dd.DragZone,repairHighlight:!1,repairHighlightColor:"transparent",containerScroll:!1,showTooltip:!0,tip:null,tipIsProcessed:!1,deltaSetXY:null,schedulerView:null,lastXY:null,showExactDropPosition:!1,enableCopy:!1,enableCopyKey:"SHIFT",validatorFn:function(){return!0},validatorFnScope:null,copyKeyPressed:!1,dragDropProxyCls:"sch-dd-ref",constructor:function(){var t,n;Ext.isIE8m&&window.top!==window&&(Ext.dd.DragDropManager.notifyOccluded=!0);t=this.proxy=this.proxy||new Ext.dd.StatusProxy({shadow:!1,dropAllowed:this.dropAllowed,dropNotAllowed:this.dropNotAllowed,ensureAttachedToBody:Ext.emptyFn});this.callParent(arguments);this.isTarget=!0;this.scroll=!1;this.ignoreSelf=!1;n=this.schedulerView;n.touchScroll&&(this.showTooltip=!1);n.el.appendChild(t.el);this.bindRightClickPreventer();t.addCls("sch-dragproxy");n.on({eventdragstart:function(){Sch.util.ScrollManager.activate(n,n.constrainDragToResource&&n.getMode())},aftereventdrop:function(){Sch.util.ScrollManager.deactivate()},scope:this})},bindRightClickPreventer:function(){var n=Ext.isIE10?"contextmenu":"mousedown";this.schedulerView.el.on(n,this.preventRightClick,this,{priority:999})},destroy:function(){this.callParent(arguments);Ext.destroyMembers(this,"tip")},preventRightClick:function(n){if(this.dragging&&n.button!==0)return n.stopEvent(),!1},autoOffset:function(){this.setDelta(0,0)},setupConstraints:function(n,t,i,r,u,f,e){var o,s,h,c;this.clearTicks();o=u&&!this.showExactDropPosition&&f>1?f:0;s=!u&&!this.showExactDropPosition&&f>1?f:0;this.resetConstraints();this.initPageX=n.left+i;this.initPageY=n.top+r;h=t.right-t.left;c=t.bottom-t.top;u?(e?this.setXConstraint(n.left+i,n.right-h+i,o):this.setXConstraint(n.left,n.right,o),this.setYConstraint(n.top+r,n.bottom-c+r,s)):(this.setXConstraint(n.left+i,n.right-h+i,o),e?this.setYConstraint(n.top+r,n.bottom-c+r,s):this.setYConstraint(n.top,n.bottom,s))},setXConstraint:function(n,t,i){this.leftConstraint=n;this.rightConstraint=t;this.minX=n;this.maxX=t;i&&this.setXTicks(this.initPageX,i);this.constrainX=!0},setYConstraint:function(n,t,i){this.topConstraint=n;this.bottomConstraint=t;this.minY=n;this.maxY=t;i&&this.setYTicks(this.initPageY,i);this.constrainY=!0},onDragEnter:Ext.emptyFn,onDragOut:Ext.emptyFn,setVisibilityForSourceEvents:function(n){Ext.Array.each(this.dragData.getEventBarElements(),function(t){t[n?"show":"hide"]()})},onDragOver:function(n){var i,t,f;if(n&&n.event.touches&&n.event.touches.length>1){Ext.dd.DragDropManager.handleMouseUp(n);return}if(i=n?n.getXY():this.lastXY,i){this.checkShiftChange();t=this.dragData;t.originalHidden||(this.setVisibilityForSourceEvents(!1),t.originalHidden=!0);var e=t.startDate,o=t.newResource,r=this.schedulerView;if(this.updateDragContext(n),this.showExactDropPosition){var s=r.isHorizontal(),h=r.getDateFromCoordinate(s?i[0]:i[1])-t.sourceDate,c=new Date(t.origStart-0+h),u=r.timeAxisViewModel.getDistanceBetweenDates(c,t.startDate);t.startDate>r.timeAxis.getStart()&&(f=this.proxy.el,u&&(r.isHorizontal()?f.setX(i[0]+(this.schedulerView.rtl?-u:u)):f.setY(i[1]+u)))}(t.startDate-e!=0||o!==t.newResource)&&this.schedulerView.fireEvent("eventdrag",this.schedulerView,t.draggedRecords,t.startDate,t.newResource,t);this.showTooltip&&(this.tip.realign(),this.tip.update(t.startDate,t.endDate,t.valid,t.message));n&&(this.lastXY=n.getXY())}},getCoordinate:function(n){switch(this.schedulerView.getMode()){case"horizontal":return n[0];case"vertical":return n[1];case"calendar":return n}},getDragData:function(n){var t=this.schedulerView,f=n.getTarget(t.eventSelector),y,h,r;if(f&&(!n.event.touches||!(n.event.touches.length>1))){var i=t.resolveEventRecord(f),e=t.resolveResource(f),p=t.resolveAssignmentRecord(f);if(!i||i.isDraggable()===!1||t.fireEvent("beforeeventdrag",t,i,n)===!1)return null;var c=n.getXY(),l=Ext.get(f),a=l.getXY(),v=[c[0]-a[0],c[1]-a[1]],k=l.getRegion();this.lastXY=null;y=t.getMode()==="horizontal";t.constrainDragToResource&&!e&&Ext.Error.raise("Resource could not be resolved for event: "+i.getId());h=t.getDateConstraints(t.constrainDragToResource?e:null,i);this.setupConstraints(t.getScheduleRegion(t.constrainDragToResource?e:null,i),k,v[0],v[1],y,t.getSnapPixelAmount(),Boolean(h));var o=i.getStartDate(),s=i.getEndDate(),w=t.timeAxis,b=this.getRelatedRecords(p||i)||[],u=t.getElementsFromEventRecord(i,t.getMode()==="calendar"?null:e);return Ext.Array.each(b,function(n){u=n instanceof Sch.model.Assignment?u.concat(t.getElementsFromEventRecord(n.getEvent(),n.getResource())):u.concat(t.getElementsFromEventRecord(n))}),u=Ext.Array.unique(u),r={offsets:v,repairXY:a,prevScroll:t.getScroll(),dateConstraints:h,eventBarEls:u,getEventBarElements:function(){return r.eventBarEls=Ext.Array.map(r.eventBarEls,function(n){return n.dom&&n||Ext.get(n.id)})},draggedRecords:[p||i].concat(b),resourceRecord:e,sourceDate:t.getDateFromCoordinate(this.getCoordinate(c)),origStart:o,origEnd:s,startDate:o,endDate:s,timeDiff:0,startsOutsideView:o<w.getStart(),endsOutsideView:s>w.getEnd(),duration:s-o,bodyScroll:Ext.getBody().getScroll(),eventObj:n},r.ddel=this.getDragElement(l,r),r}},onStartDrag:function(){var n=this.schedulerView,t=this.dragData;Ext.Array.each(t.getEventBarElements(),function(n){n.removeCls("sch-event-hover")});n.fireEvent("eventdragstart",n,t.draggedRecords);n.getScrollable().on("scroll",this.onViewScroll,this)},alignElWithMouse:function(n,t,i){this.callParent(arguments);var r=this.getTargetCoord(t,i),u=n.dom?n:Ext.fly(n,"_dd");this.setLocalXY(u,r.x+this.deltaSetXY[0],r.y+this.deltaSetXY[1])},onViewScroll:function(n,t,i){var e=this.proxy,o=this.schedulerView,r=this.dragData,u,s,f;this.setVisibilityForSourceEvents(!1);u=e.getXY();s=o.rtl?[u[0]-t+r.prevScroll.left,u[1]+i-r.prevScroll.top]:[u[0]+t-r.prevScroll.left,u[1]+i-r.prevScroll.top];f=this.deltaSetXY;this.deltaSetXY=o.rtl?[f[0]-t+r.prevScroll.left,f[1]+i-r.prevScroll.top]:[f[0]+t-r.prevScroll.left,f[1]+i-r.prevScroll.top];r.prevScroll={left:t,top:i};e.setXY(s);this.onDragOver()},getCopyKeyPressed:function(){return Boolean(this.enableCopy&&this.dragData.eventObj[this.enableCopyKey.toLowerCase()+"Key"])},checkShiftChange:function(){var n=this.getCopyKeyPressed(),t=this.dragData;n!==this.copyKeyPressed&&(this.copyKeyPressed=n,n?(t.refElements.addCls("sch-event-copy"),this.setVisibilityForSourceEvents(!0)):(t.refElements.removeCls("sch-event-copy"),this.setVisibilityForSourceEvents(!1)))},onKey:function(n){this.enableCopy&&n.getKey()===n[this.enableCopyKey]&&this.checkShiftChange();n.getKey()===n.ESC&&(this.dragData.ddCallbackArgs=[n.getTarget(),n,this.id],this.finalize(!1),Ext.dd.DragDropManager.stopDrag(n),Ext.dd.DragDropManager.stopEvent(n))},startDrag:function(){var r,n,t,u,i;Ext.getDoc().on({keydown:this.onKey,keyup:this.onKey,useCapture:!0,scope:this});return r=this.callParent(arguments),n=this.dragData,n.refElement=this.proxy.el.down("."+this.dragDropProxyCls),n.refElements=this.proxy.el.select(".sch-event"),n.refElement.removeCls("sch-event-hover"),this.showTooltip&&(t=this.schedulerView,u=t.up("[lockable=true]").el,this.tipIsProcessed||(this.tipIsProcessed=!0,i=this.tip,i instanceof Ext.tip.ToolTip?i.schedulerView=t:this.tip=new Sch.tooltip.Tooltip(Ext.apply({schedulerView:t,cls:"sch-dragdrop-tip",constrainTo:u},i))),this.tip.update(n.origStart,n.origEnd,!0),this.tip.setStyle("visibility"),this.tip.show(n.refElement,n.offsets[0])),this.copyKeyPressed=this.getCopyKeyPressed(),this.copyKeyPressed&&(n.refElements.addCls("sch-event-copy"),n.originalHidden=!0),r},endDrag:function(){this.schedulerView.getScrollable().un("scroll",this.onViewScroll,this);Ext.getDoc().un({keydown:this.onKey,keyup:this.onKey,useCapture:!0,scope:this});this.callParent(arguments)},onMouseUp:function(){this.dragging||this.afterDragFinalized()},afterDragFinalized:function(){this.proxy.el.setStyle({left:0,top:0})},updateRecords:function(n){var t=this,i=t.schedulerView,r=i.getEventStore(),f=i.getResourceStore(),e=r.getAssignmentStore(),o=n.newResource,s=n.draggedRecords[0],h=n.draggedRecords.slice(1),c=n.resourceRecord,u=t.getCopyKeyPressed(),l=n.startDate,a=n.timeDiff,v=i.getMode();e&&r instanceof Sch.data.EventStore?t.updateRecordsMultipleAssignmentMode(l,a,s,h,c,o,r,f,e,u,v):e?t.updateRecordsSingleAssignmentMode(l,a,s.getEvent(),Ext.Array.map(h,function(n){return n.getEvent()}),c,o,r,f,u,v):t.updateRecordsSingleAssignmentMode(l,a,s,h,c,o,r,f,u,v);i.fireEvent("eventdrop",i,n.draggedRecords,u)},updateRecordsSingleAssignmentMode:function(n,t,i,r,u,f,e,o,s,h){var a=this,c=[],l;s&&(i=i.fullCopy(null),c.push(i));i.beginEdit();!s&&f!==u&&u instanceof Sch.model.Resource&&f instanceof Sch.model.Resource?i.reassign(u,f):f!==u&&u instanceof Sch.model.Resource&&f instanceof Sch.model.Resource&&i.assign(f);i.setStartDate(n,!0,e.skipWeekendsDuringDragDrop);i.endEdit();h!=="calendar"&&(l=o.indexOf(u)-o.indexOf(f),Ext.Array.each(r,function(n){var i=n.getResources();s&&(n=n.fullCopy(null),c.push(n));n.beginEdit();n.setStartDate(a.adjustStartDate(n.getStartDate(),t),!0,e.skipWeekendsDuringDragDrop);l!==0&&i.length&&Ext.Array.each(i,function(t){var i=o.indexOf(t)-l,r;i<0?i=0:i>=o.getCount()&&(i=o.getCount()-1);r=o.getAt(i);n.reassign(t,r)});n.endEdit()}));c.length&&e.append(c)},updateRecordsMultipleAssignmentMode:function(n,t,i,r,u,f,e,o,s,h,c){var l=this;Ext.Array.each([].concat(i,r),function(n){var i=n.getEvent();i.setStartDate(l.adjustStartDate(i.getStartDate(),t),!0,e.skipWeekendsDuringDragDrop);c!="calendar"&&u!==f&&(h?i.assign(f):i.isAssignedTo(f)?i.unassign(n.getResource()):i.reassign(n.getResource(),f))})},isValidDrop:function(n,t,i){return n!==t?i instanceof Sch.model.Assignment?!i.getEvent().isAssignedTo(t):!i.isAssignedTo(t):!0},resolveResource:function(n){var f=this.proxy.el.dom,i=this.dragData.bodyScroll,t,r,u;if(f.style.display="none",t=document.elementFromPoint(n[0]-i.left,n[1]-i.top),Ext.isIE8&&window.top.Siesta&&(t=document.elementFromPoint(n[0]-i.left,n[1]-i.top)),f.style.display="block",!t)return null;if(r=this.schedulerView,t.className.match(Ext.baseCSSPrefix+"grid-item"))return this.resolveResource([n[0],n[1]+3]);if(!t.className.match(r.timeCellCls))if(u=Ext.fly(t).up("."+r.timeCellCls),u)t=u.dom;else return null;return r.resolveResource(t)},adjustStartDate:function(n,t){var i=this.schedulerView;return i.timeAxis.roundDate(new Date(+n+t),i.snapRelativeToEventStartDate?n:!1)},updateDragContext:function(n){var t=this.dragData,u=n?n.getXY():this.lastXY,i,f,o,e,r;t.refElement&&(i=this.schedulerView,f=t.refElement.getRegion(),i.timeAxis.isContinuous()?(i.isHorizontal()&&this.minX<u[0]&&u[0]<this.maxX||i.isVertical()&&this.minY<u[1]&&u[1]<this.maxY)&&(o=i.getDateFromCoordinate(this.getCoordinate(u)),t.timeDiff=o-t.sourceDate,t.startDate=this.adjustStartDate(t.origStart,t.timeDiff),t.endDate=new Date(t.startDate-0+t.duration)):(e=this.resolveStartEndDates(f),t.startDate=e.startDate,t.endDate=e.endDate,t.timeDiff=t.startDate-t.origStart),t.newResource=i.constrainDragToResource?t.resourceRecord:this.resolveResource([f.left+t.offsets[0],f.top+t.offsets[1]]),t.newResource?(r=!n||this.validatorFn.call(this.validatorFnScope||this,t.draggedRecords,t.newResource,t.startDate,t.duration,n),r&&typeof r!="boolean"?(t.valid=r.valid!==!1,t.message=r.message):(t.valid=r!==!1,t.message="")):t.valid=!1)},getRelatedRecords:function(n){var t=this.schedulerView,i=t.getEventSelectionModel(),r=i.getDraggableSelections();return Ext.Array.filter(r,function(t){return n!==t})},getDragElement:function(n,t){var f=t.getEventBarElements(),i,r,e=t.offsets[0],o=t.offsets[1],u;return f.length>1?(u=Ext.core.DomHelper.createDom({tag:"div",cls:"sch-dd-wrap",style:{overflow:"visible"}}),Ext.Array.each(f,function(t){i=t.dom.cloneNode(!0);i.id=Ext.id();t.dom===n.dom&&(i.className+=" "+this.dragDropProxyCls,Ext.isIE8&&Ext.fly(i).addCls(this.dragDropProxyCls));u.appendChild(i);var r=t.getOffsetsTo(n);Ext.fly(i).setStyle({left:r[0]-e+"px",top:r[1]-o+"px"})},this),r=u):(i=n.dom.cloneNode(!0),i.id=Ext.id(),i.style.left=-e+"px",i.style.top=-o+"px",i.className+=" "+this.dragDropProxyCls,Ext.isIE8&&Ext.fly(i).addCls(this.dragDropProxyCls),r=i),n.dom.style.height||Ext.fly(r).setHeight(n.getHeight()),r},onDragDrop:function(n,t){this.updateDragContext(n);var r=this,e=r.schedulerView,o=r.cachedTarget||Ext.dd.DragDropMgr.getDDById(t),i=r.dragData,f=!1,u=!0;i.ddCallbackArgs=[o,n,t];i.valid&&i.startDate&&i.endDate&&(i.finalize=function(){r.finalize.apply(r,arguments)},u=e.fireEvent("beforeeventdropfinalize",r,i,n)!==!1,u&&r.isValidDrop(i.resourceRecord,i.newResource,i.draggedRecords[0])&&(f=i.startDate-i.origStart!=0||i.newResource!==i.resourceRecord));u?r.finalize(i.valid&&f):r.proxy.el.addCls("sch-before-drag-finalized")},finalize:function(n){var t=this,r=t.schedulerView,f=r.getEventStore(),i=t.dragData,e,u;if(t.proxy.el.removeCls("sch-before-drag-finalized"),t.tip&&t.tip.hide(),n){u=function(){e=!0};f.on("update",u,null,{single:!0});t.updateRecords(i);f.un("update",u,null,{single:!0});e?(Ext.isIE9?(t.proxy.el.setStyle("visibility","hidden"),Ext.Function.defer(t.onValidDrop,10,t,i.ddCallbackArgs)):t.onValidDrop.apply(t,i.ddCallbackArgs),r.fireEvent("aftereventdrop",r,i.draggedRecords)):t.onInvalidDrop.apply(t,i.ddCallbackArgs);t.afterDragFinalized()}else t.onInvalidDrop.apply(t,i.ddCallbackArgs)},onInvalidDrop:function(n,t,i){t||(t=n,n=t.getTarget()||document.body);this.tip&&this.tip.hide();this.setVisibilityForSourceEvents(!0);var r=this.schedulerView,u=this.callParent([n,t,i]);return r.fireEvent("aftereventdrop",r,this.dragData.draggedRecords),this.afterDragFinalized(),u},resolveStartEndDates:function(n){var t=this.dragData,i,r=t.origStart,u=t.origEnd,f=Sch.util.Date;return t.startsOutsideView?t.endsOutsideView||(i=this.schedulerView.getStartEndDatesFromRegion(n,"round"),i&&(u=i.end||t.endDate,r=f.add(u,f.MILLI,-t.duration))):(i=this.schedulerView.getStartEndDatesFromRegion(n,"round"),i&&(r=i.start||t.startDate,u=f.add(r,f.MILLI,t.duration))),{startDate:r,endDate:u}}});Ext.define("Sch.feature.DragDrop",{validatorFn:function(){return!0},validatorFnScope:null,dragConfig:null,constructor:function(n,t){Ext.apply(this,t);this.schedulerView=n;n.eventDragZone=new Sch.feature.SchedulerDragZone(n.ownerCt.el,Ext.apply({ddGroup:n.id,schedulerView:n,validatorFn:this.validatorFn,validatorFnScope:this.validatorFnScope},this.dragConfig));this.schedulerView.on("destroy",this.cleanUp,this);this.callParent([t])},cleanUp:function(){var n=this.schedulerView;n.eventDragZone&&n.eventDragZone.destroy()}});Ext.define("Sch.feature.ResizeZone",{extend:Ext.util.Observable,showTooltip:!0,showExactResizePosition:!1,validatorFn:Ext.emptyFn,validatorFnScope:null,schedulerView:null,origEl:null,handlePos:null,eventRec:null,tip:null,tipInstance:null,startScroll:null,constructor:function(n){Ext.apply(this,n);var t=this.schedulerView;t.on({destroy:this.cleanUp,scope:this});t.el.on({mousedown:this.onMouseDown,mouseup:this.onMouseUp,scope:this,delegate:".sch-resizable-handle"});this.bindRightClickPreventer();this.callParent(arguments)},bindRightClickPreventer:function(){var t,n;t=Ext.isIE9m?"mousedown":"contextmenu";n={scope:this,priority:999};n[t]=this.preventRightClick;this.schedulerView.el.on(n)},preventRightClick:function(n){if(n.button!==0&&this.resizer)return n.stopEvent(),!1},onMouseDown:function(n,t){var r=this.schedulerView,u=this.eventRec=r.resolveEventRecord(t),i=u.isResizable();if(n.button===0&&i!==!1&&(typeof i!="string"||t.className.match(i))){this.eventRec=u;this.handlePos=this.getHandlePosition(t);this.origEl=Ext.get(n.getTarget(".sch-event"));r.el.on({mousemove:this.onMouseMove,scope:this,single:!0})}},onMouseUp:function(){var n=this.schedulerView;n.el.un({mousemove:this.onMouseMove,scope:this,single:!0})},getTipInstance:function(){if(this.tipInstance)return this.tipInstance;var t=this.schedulerView,n=this.tip,i=t.up("[lockable=true]").el;return n instanceof Ext.tip.ToolTip?n.schedulerView=t:n=new Sch.tooltip.Tooltip(Ext.apply({rtl:this.rtl,schedulerView:t,constrainTo:i,cls:"sch-resize-tip"},n)),this.tipInstance=n},onMouseMove:function(n){var i=this.schedulerView,t=this.eventRec,u=this.handlePos,f,r;if(t&&i.fireEvent("beforeeventresize",i,t,n)!==!1){delete this.eventRec;n.stopEvent();this.origEl.addCls("sch-event-resizing");this.resizer=this.createResizer(this.origEl,t,u);f=this.resizer.resizeTracker;this.showTooltip&&(r=this.getTipInstance(),r.setTarget(this.origEl),r.update(t.getStartDate(),t.getEndDate(),!0),r.show(this.origEl,n.getX()-this.origEl.getX()));f.onMouseDown(n,this.resizer[u].dom);f.onMouseMove(n,this.resizer[u].dom);i.fireEvent("eventresizestart",i,t);i.getScrollable().on("scroll",this.onViewScroll,this)}},getHandlePosition:function(n){var t=n.className.match("start");return this.schedulerView.getMode()==="horizontal"?this.schedulerView.rtl?t?"east":"west":t?"west":"east":t?"north":"south"},createResizer:function(n,t,i){var r=this.schedulerView,o=this,s=r.resolveResource(n),f=r.getSnapPixelAmount(),y=r.getScheduleRegion(s,t),p=r.getDateConstraints(s,t),a=n.getHeight(),h=r.rtl&&i[0]==="e"||!r.rtl&&i[0]==="w"||i[0]==="n",c=r.getMode()!=="horizontal",e={otherEdgeX:h?n.getRight():n.getLeft(),otherEdgeY:h?n.getBottom():n.getTop(),target:n,isStart:h,startYOffset:n.getY()-n.parent().getY(),startXOffset:n.getX()-n.parent().getX(),dateConstraints:p,resourceRecord:s,eventRecord:t,handles:i[0],minHeight:a,constrainTo:y,listeners:{resizedrag:this.partialResize,resize:this.afterResize,scope:this}},l,u,v;return c?f>0&&(l=n.getWidth(),Ext.apply(e,{minHeight:f,minWidth:l,maxWidth:l,heightIncrement:f})):f>0&&Ext.apply(e,{minWidth:f,maxHeight:a,widthIncrement:f}),u=new Ext.resizer.Resizer(e),u.resizeTracker&&(u.resizeTracker.tolerance=-1,v=u.resizeTracker.updateDimensions,u.resizeTracker.updateDimensions=function(n){if(!Ext.isWebKit||!n.getTarget||n.getTarget(".sch-timelineview")){var t;c?(t=r.getScrollY()-o.startScroll.top,u.resizeTracker.minHeight=e.minHeight-Math.abs(t)):(t=r.getScrollX()-o.startScroll.left,u.resizeTracker.minWidth=e.minWidth-Math.abs(t));v.apply(this,arguments)}},u.resizeTracker.resize=function(n){var t;c?(t=r.getScrollY()-o.startScroll.top,i[0]==="s"&&(n.y-=t),n.height+=Math.abs(t)):(t=r.getScrollX()-o.startScroll.left,i[0]==="e"&&(n.x-=t),n.width+=Math.abs(t));Ext.resizer.ResizeTracker.prototype.resize.apply(this,arguments)}),n.setStyle("z-index",parseInt(n.getStyle("z-index"),10)+1),Sch.util.ScrollManager.activate(r,r.getMode()==="horizontal"?"horizontal":"vertical"),this.startScroll=r.getScroll(),u},getStartEndDates:function(){var n=this.resizer,t=n.el,i=this.schedulerView,e=n.isStart,r,u,f;return e?(f=i.getMode()==="horizontal"?[i.rtl?t.getRight():t.getLeft()+1,t.getTop()]:[(t.getRight()+t.getLeft())/2,t.getTop()],u=n.eventRecord.getEndDate(),i.snapRelativeToEventStartDate?(r=i.getDateFromXY(f),r=i.timeAxis.roundDate(r,n.eventRecord.getStartDate())):r=i.getDateFromXY(f,"round")):(f=i.getMode()==="horizontal"?[i.rtl?t.getLeft():t.getRight(),t.getBottom()]:[(t.getRight()+t.getLeft())/2,t.getBottom()],r=n.eventRecord.getStartDate(),i.snapRelativeToEventStartDate?(u=i.getDateFromXY(f),u=i.timeAxis.roundDate(u,n.eventRecord.getEndDate())):u=i.getDateFromXY(f,"round")),r=r||n.start,u=u||n.end,n.dateConstraints&&(r=Sch.util.Date.constrain(r,n.dateConstraints.start,n.dateConstraints.end),u=Sch.util.Date.constrain(u,n.dateConstraints.start,n.dateConstraints.end)),{start:r,end:u}},partialResize:function(n,t,i,r){var u=this.schedulerView,b=r?r.getXY():this.resizer.resizeTracker.lastXY,p=this.getStartEndDates(b),f=p.start,o=p.end,c=n.eventRecord,v=u.isHorizontal(),s,y,e,h,l,a,w;if(v?n.target.el.setY(n.target.parent().getY()+n.startYOffset):n.target.el.setX(n.target.parent().getX()+n.startXOffset),this.showTooltip&&(s=this.validatorFn.call(this.validatorFnScope||this,n.resourceRecord,c,f,o),y="",s&&typeof s!="boolean"&&(y=s.message,s=s.valid),this.getTipInstance().update(f,o,s!==!1,y)),this.showExactResizePosition)e=n.target.el,n.isStart?(u.getMode()==="calendar"?(w=u.calendar.getEventColumns(c)[0],h=u.timeAxisViewModel.getDistanceBetweenDates(f,w.end)):h=u.timeAxisViewModel.getDistanceBetweenDates(f,c.getEndDate()),v?(l=u.getDateFromCoordinate(n.otherEdgeX-Math.min(t,n.maxWidth))||f,a=u.timeAxisViewModel.getDistanceBetweenDates(l,f),e.setWidth(h),e.setX(e.getX()+a)):(l=u.getDateFromCoordinate(n.otherEdgeY-Math.min(t,n.maxHeight))||f,a=u.timeAxisViewModel.getDistanceBetweenDates(l,f),e.setHeight(h),e.setY(e.getY()+a))):(h=u.timeAxisViewModel.getDistanceBetweenDates(c.getStartDate(),o),v?e.setWidth(h):e.setHeight(h));else if(!f||!o||n.start-f==0&&n.end-o==0)return;n.end=o;n.start=f;u.fireEvent("eventpartialresize",u,c,f,o,n.el)},onViewScroll:function(){this.resizer.resizeTracker.onDrag({});this.partialResize(this.resizer,0,0)},afterResize:function(n,t,i,r){var u=this,c=n.resourceRecord,s=n.eventRecord,l=s.getStartDate(),a=s.getEndDate(),f=n.start||l,e=n.end||a,h=u.schedulerView,v=!1,y=!0,o=u.validatorFn.call(u.validatorFnScope||u,c,s,f,e,r);Sch.util.ScrollManager.deactivate();h.getScrollable().un("scroll",this.onViewScroll,this);this.showTooltip&&this.getTipInstance().hide();h.el.select("[id^=calendar-resizer-placeholder]").remove();u.resizeContext={resourceRecord:n.resourceRecord,eventRecord:s,start:f,end:e,finalize:function(){u.finalize.apply(u,arguments)}};o&&typeof o!="boolean"&&(o=o.valid);f&&e&&e-f>0&&(f-l!=0||e-a!=0)&&o!==!1?(y=h.fireEvent("beforeeventresizefinalize",u,u.resizeContext,r)!==!1,v=!0):h.repaintEventsForResource(c);y&&u.finalize(v)},finalize:function(n){var t=this.schedulerView,i=this.resizeContext,r=!1,u=function(){r=!0};t.getEventStore().on("update",u);this.resizer.target.destroy();Ext.isIE&&document.body.focus();n?(this.resizer.isStart?i.eventRecord.setStartDate(i.start,!1,t.getEventStore().skipWeekendsDuringDragDrop):i.eventRecord.setEndDate(i.end,!1,t.getEventStore().skipWeekendsDuringDragDrop),r||t.repaintEventsForResource(i.resourceRecord)):t.repaintEventsForResource(i.resourceRecord);this.resizer.destroy();delete this.resizer;t.getEventStore().un("update",u);t.fireEvent("eventresizeend",t,i.eventRecord);this.resizeContext=null},cleanUp:function(){this.tipInstance&&this.tipInstance.destroy()}});Ext.define("Sch.plugin.Zones",{extend:Sch.feature.AbstractTimeSpan,alias:"plugin.scheduler_zones",innerTpl:null,cls:"sch-zone",side:null,init:function(n){typeof this.innerTpl=="string"&&(this.innerTpl=new Ext.XTemplate(this.innerTpl));this.side=n.rtl?"right":"left";var t=this.innerTpl;this.template||(this.template=new Ext.XTemplate('<tpl for="."><div id="{id}" class="{$cls}" style="'+this.side+':{left}px;top:{top}px;height:{height}px;width:{width}px;{style}">'+(t?"{[this.renderInner(values)]}":"")+"<\/div><\/tpl>",{renderInner:function(n){return t.apply(n)}}));typeof this.innerHeaderTpl=="string"&&(this.innerHeaderTpl=new Ext.XTemplate(this.innerHeaderTpl));this.callParent(arguments)},getElementData:function(n,t,i,r){var h=this.schedulerView,w=[],o=h.getTimeSpanRegion(n,t,this.expandToFitView),s,c,l,u,y,v,b,p,f,e,a;for(i=i||this.store.getRange(),v=0,b=i.length;v<b;v++)s=i[v],c=s.getStartDate(),l=s.getEndDate(),y=this.getTemplateData(s),c&&l&&Sch.util.Date.intersectSpans(c,l,n,t)&&(u=Ext.apply({},y),u.id=this.getElementId(s),u.$cls=this.getElementCls(s,y),p=h.getMode(),p==="calendar"?(f=h.getTimeSpanRegion(c,l),u.left=f.left,u.top=f.top,u.height=f.bottom-f.top,u.width=f.right-f.left):(e=h.getCoordinateFromDate(Sch.util.Date.max(c,n)),a=h.getCoordinateFromDate(Sch.util.Date.min(l,t)),p==="horizontal"?(u.left=e,u.top=o.top,u.width=r?0:a-e,u.height=o.bottom-o.top,u.style=r?"border-left-width:"+(a-e)+"px":""):(u.left=o.left,u.top=e,u.height=r?0:a-e,u.width=o.right-o.left,u.style=r?"border-top-width:"+(a-e)+"px":"")),w.push(u));return w},getHeaderElementId:function(n,t){return this.callParent([n])+(t?"-start":"-end")},getHeaderElementCls:function(n,t,i){var r=n.clsField||this.clsField;return t||(t=this.getTemplateData(n)),"sch-header-indicator sch-header-indicator-"+(i?"start ":"end ")+this.uniqueCls+" "+(t[r]||"")},getZoneHeaderElementData:function(n,t,i,r){var u=r?i.getStartDate():i.getEndDate(),e=null,o,s,f;return u&&Sch.util.Date.betweenLesser(u,n,t)&&(o=this.getHeaderElementPosition(u),s=this.schedulerView.isHorizontal(),f=this.getTemplateData(i),e=Ext.apply({id:this.getHeaderElementId(i,r),cls:this.getHeaderElementCls(i,f,r),isStart:r,side:s?this.side:"top",position:o},f)),e},getHeaderElementData:function(n){var e=this.timeAxis.getStart(),o=this.timeAxis.getEnd(),i=[],r,u,f,t,s;for(n=n||this.store.getRange(),t=0,s=n.length;t<s;t++)r=n[t],u=this.getZoneHeaderElementData(e,o,r,!0),u&&i.push(u),f=this.getZoneHeaderElementData(e,o,r,!1),f&&i.push(f);return i},updateZoneHeaderElement:function(n,t){n.dom.className=t.cls;this.schedulerView.isHorizontal()?this.setElementX(n,t.position):n.setTop(t.position)},updateHeaderElement:function(n){var u=this.timeAxis.getStart(),f=this.timeAxis.getEnd(),t=Ext.get(this.getHeaderElementId(n,!0)),i=Ext.get(this.getHeaderElementId(n,!1)),e=this.getZoneHeaderElementData(u,f,n,!0),r=this.getZoneHeaderElementData(u,f,n,!1);t&&r&&i&&r?(t&&(e?this.updateZoneHeaderElement(t,e):Ext.destroy(t)),i&&(r?this.updateZoneHeaderElement(i,r):Ext.destroy(i))):(Ext.destroy(t,i),this.renderHeaderElementsInternal([n]))}});Ext.define("Sch.plugin.ResourceZones",{extend:Sch.plugin.Zones,alias:"plugin.scheduler_resourcezones",innerTpl:null,store:null,cls:"sch-resourcezone",init:function(n){this.store=Ext.StoreManager.lookup(this.store);this.uniqueCls=this.uniqueCls||"sch-timespangroup-"+Ext.id();this.scheduler=n;n.registerRenderer(this.renderer,this);typeof this.innerTpl=="string"&&(this.innerTpl=new Ext.XTemplate(this.innerTpl));var t=this.innerTpl;this.template||(this.template=new Ext.XTemplate('<tpl for="."><div id="'+this.uniqueCls+'-{id}" class="'+this.cls+" "+this.uniqueCls+' {Cls}" style="'+(n.rtl?"right":"left")+':{start}px;width:{width}px;top:{start}px;height:{width}px;{style}">'+(t?"{[this.renderInner(values)]}":"{"+this.store.getModel().prototype.nameField+"}")+"<\/div><\/tpl>",{renderInner:function(n){return t.apply(n)}}));this.storeListeners={load:this.fullRefresh,datachanged:this.fullRefresh,clear:this.fullRefresh,add:this.fullRefresh,remove:this.fullRefresh,update:this.onModelUpdate,addrecords:this.fullRefresh,removerecords:this.fullRefresh,updaterecord:this.onModelUpdate,scope:this};this.store.on(this.storeListeners)},destroy:function(){this.store.un(this.storeListeners);this.callParent(arguments)},fullRefresh:function(){this.scheduler.getSchedulingView().refreshView()},renderer:function(n,t,i,r){return this.scheduler.getOrientation()==="horizontal"||r===0?this.renderZones(i):""},renderZones:function(n){for(var t,i,u,f,l=this.store,r=this.scheduler,a=r.timeAxis.getStart(),v=r.timeAxis.getEnd(),e=[],c=n.getEvents(l),o,s,h=0,y=c.length;h<y;h++)t=c[h],o=t.getStartDate(),s=t.getEndDate(),o&&s&&Sch.util.Date.intersectSpans(o,s,a,v)&&(i=r.getSchedulingView()[r.getOrientation()].getEventRenderData(t),r.getMode()==="horizontal"?(u=r.rtl?i.right:i.left,f=i.width):(u=i.top,f=i.height),e[e.length]=Ext.apply({id:t.internalId,start:u,width:f,Cls:t.getCls()},t.data));return this.template.apply(e)},onModelUpdate:function(n,t){var i=document.getElementById(this.uniqueCls+"-"+t.internalId);if(i){var r=this.scheduler,e=r.timeAxis.getStart(),o=r.timeAxis.getEnd(),s=Sch.util.Date.max(e,t.getStartDate()),h=Sch.util.Date.min(o,t.getEndDate()),c=t.getCls(),u=r.getSchedulingView().getCoordinateFromDate(s),f=r.getSchedulingView().getCoordinateFromDate(h)-u;i.className=this.cls+" "+this.uniqueCls+" "+(c||"");i.style.left=u+"px";i.style.top=u+"px";i.style.height=f+"px";i.style.width=f+"px"}}});Ext.define("Sch.mixin.AbstractSchedulerPanel",{eventBarIconClsField:"",enableEventDragDrop:!0,resourceColumnClass:"Sch.column.Resource",resourceColumnWidth:null,calendarColumnWidth:null,allowOverlap:!0,startParamName:"startDate",endParamName:"endDate",passStartEndParameters:!1,eventRenderer:null,eventRendererScope:null,eventStore:null,resourceStore:null,onEventCreated:function(){},resourceZones:null,resourceZonesConfig:null,initStores:function(){var n=this.resourceStore||this.store;!this.crudManager||this.crudManager instanceof Sch.data.CrudManager||(this.crudManager=new Sch.data.CrudManager(this.crudManager));n||(this.crudManager&&(n=this.resourceStore=this.crudManager.getResourceStore()),n||(n=this.isTree?new Sch.data.ResourceTreeStore({proxy:"memory"}):new Sch.data.ResourceStore));this.eventStore||(this.crudManager&&(this.eventStore=this.crudManager.getEventStore()),this.eventStore=this.eventStore||new Sch.data.EventStore);this.store=Ext.StoreManager.lookup(n);this.resourceStore=this.store;this.setEventStore(this.eventStore);this.eventStore&&this.eventStore.isEventStore||Ext.Error.raise("Your eventStore should be a subclass of Sch.data.EventStore (or consume the EventStore mixin)");this.resourceStore.eventStore=this.getEventStore()},_initializeSchedulerPanel:function(){this.initStores();this.eventBodyTemplate&&typeof this.eventBodyTemplate=="string"&&(this.eventBodyTemplate=new Ext.XTemplate(this.eventBodyTemplate));this.on("destroy",function(){this.setResourceStore(null);this.setEventStore(null)})},getResourceStore:function(){return this.resourceStore},setResourceStore:function(n){var r=this.getResourceStore(),u=r===this.store,t,f,i;n=n&&Ext.StoreManager.lookup(n);t=this.getEventStore();f=this.getAssignmentStore();this.resourceStore=n;t&&t.setResourceStore(n);this.getCrudManager()&&this.getCrudManager().setResourceStore(n);i=this.getSchedulingView();i&&i.setResourceStore(n);n&&(this.fireEvent("resourcestorechange",this,n,r),u?this.reconfigure(this.resourceStore):this.rendered&&this.getView().relayFn("refreshView"))},getEventStore:function(){return this.eventStore},setEventStore:function(n){var u=this.getEventStore(),t,i,r;n=n&&Ext.StoreManager.lookup(n);this.getEventStore()&&this.mun(this.getEventStore(),"beforeload",this.applyStartEndParameters,this);t=this.getResourceStore();i=this.getAssignmentStore();this.eventStore=n;t&&t.setEventStore(n);this.getCrudManager()&&this.getCrudManager().setEventStore(n);i&&n&&!n.getAssignmentStore()&&n.setAssignmentStore(i);r=this.getSchedulingView();r&&r.setEventStore(n);n&&(this.fireEvent("eventstorechange",this,n,u),this.passStartEndParameters&&this.mon(n,"beforeload",this.applyStartEndParameters,this),this.rendered&&this.getView().relayFn("refreshView"))},applyStartEndParameters:function(n){var t=n.getProxy();t.setExtraParam(this.startParamName,this.getStart());t.setExtraParam(this.endParamName,this.getEnd())},getAssignmentStore:function(){var n=this.getEventStore();return n&&n.isStore&&n.getAssignmentStore()},setAssignmentStore:function(n){var t=this.getAssignmentStore();this.getCrudManager()&&this.getCrudManager().setAssignmentStore(n);this.getEventStore().setAssignmentStore(n);n&&(this.fireEvent("assignmentstorechange",this,n,t),this.rendered&&this.getView().relayFn("refreshView"))},createResourceColumns:function(n){return Ext.Array.map(this.resourceStore.getRange(),function(t){return{xclass:this.resourceColumnClass,renderer:this.mainRenderer,scope:this,width:n||100,text:t.getName(),model:t}},this)}});Ext.define("Sch.template.Event",{extend:Ext.XTemplate,eventPrefix:null,resizeHandles:null,resizeTpl:'<div class="sch-resizable-handle sch-resizable-handle-DIR"><\/div>',constructor:function(n){Ext.apply(this,n);this.callParent(['<tpl for="."><div unselectable="on" tabindex="-1" id="'+this.eventPrefix+'{id}" style="right:{right}px;left:{left}px;top:{top}px;height:{height}px;width:{width}px;{style}" class="sch-event '+Ext.baseCSSPrefix+'unselectable {internalCls} {cls}">'+(this.resizeHandles==="start"||this.resizeHandles==="both"?this.resizeTpl.replace(/DIR/,"start"):"")+'<div unselectable="on" class="sch-event-inner {iconCls}">{body}<\/div>'+(this.resizeHandles==="end"||this.resizeHandles==="both"?this.resizeTpl.replace(/DIR/,"end"):"")+"<\/div><\/tpl>"])}});Ext.define("Sch.view.Vertical",{view:null,constructor:function(n){Ext.apply(this,n)},translateToScheduleCoordinate:function(n){var t=this.view;return n-t.getEl().getY()+t.getScroll().top},translateToPageCoordinate:function(n){var t=this.view,i=t.getEl(),r=t.getScroll();return n+i.getY()-r.top},getDateFromXY:function(n,t,i){var r=n[1];return i||(r=this.translateToScheduleCoordinate(r)),this.view.timeAxisViewModel.getDateFromPosition(r,t)},getEventRenderData:function(n,t){var f=n.getStartDate(),e=n.getEndDate(),u=this.view,o=u.timeAxis.getStart(),s=u.timeAxis.getEnd(),i=Math,h=i.floor(u.getCoordinateFromDate(Sch.util.Date.max(f,o))),c=i.floor(u.getCoordinateFromDate(Sch.util.Date.min(e,s))),l=this.getResourceColumnWidth(t),r;return r={top:i.max(0,i.min(h,c)-u.eventBorderWidth),height:i.max(1,i.abs(h-c))},r.start=f,r.end=e,r.startsOutsideView=f<o,r.endsOutsideView=e>s,r},getScheduleRegion:function(n,t){var i=this.view,r=n?Ext.fly(i.getScheduleCell(i.getNodes()[0],i.getResourceStore().indexOf(n))).getRegion():i.getTableRegion(),u=i.timeAxis.getStart(),f=i.timeAxis.getEnd(),e=i.getDateConstraints(n,t)||{start:u,end:f},o=this.translateToPageCoordinate(i.getCoordinateFromDate(Sch.util.Date.max(u,e.start))),s=this.translateToPageCoordinate(i.getCoordinateFromDate(Sch.util.Date.min(f,e.end))),h=r.left+i.barMargin,c=(n?r.left+this.getResourceColumnWidth(n):r.right)-i.barMargin;return new Ext.util.Region(Math.min(o,s),c,Math.max(o,s),h)},getResourceColumnWidth:function(){return this.view.timeAxisViewModel.resourceColumnWidth},getResourceRegion:function(n,t,i){var r=this.view,u=r.getResourceStore().indexOf(n)*this.getResourceColumnWidth(n),f=r.timeAxis.getStart(),e=r.timeAxis.getEnd(),h=t?Sch.util.Date.max(f,t):f,c=i?Sch.util.Date.min(e,i):e,o=Math.max(0,r.getCoordinateFromDate(h)-r.cellTopBorderWidth),s=r.getCoordinateFromDate(c)-r.cellTopBorderWidth,l=u+r.cellBorderWidth,a=u+this.getResourceColumnWidth(n)-r.cellBorderWidth;return new Ext.util.Region(Math.min(o,s),a,Math.max(o,s),l)},columnRenderer:function(n,t,i,r,u){var f=this.view,c="",p,l,e,s,o,a;if(r===0){for(p=Sch.util.Date,l=f.timeAxis,e=[],s=f.getEventStore().getEventsForResource(i),o=0,a=s.length;o<a;o++){var h=s[o],v=h.getStartDate(),y=h.getEndDate();v&&y&&l.timeSpanInAxis(v,y)&&e.push(f.generateTplData(h,i,u))}f.eventLayout.vertical.applyLayout(e,this.getResourceColumnWidth(i)-2*f.barMargin-f.cellBorderWidth);c="&#160;"+f.eventTpl.apply(e)}return u%2==1&&(t.tdCls=(t.tdCls||"")+" "+f.altColCls,t.cellCls=(t.cellCls||"")+" "+f.altColCls),c},resolveResource:function(n){var f=this,t=f.view,r,i,u;if(r=Ext.fly(n).is(t.eventSelector)&&n||Ext.fly(n).up(t.eventSelector,null,!0),r)u=t.getResourceRecordFromDomId(r.id);else{if(n=Ext.fly(n).is(t.timeCellSelector)?n:Ext.fly(n).up(t.timeCellSelector,null,!0),i=-1,n&&Ext.isIE8m)for(n=n.previousSibling;n;)n.nodeType===1&&i++,n=n.previousSibling;else n&&(i=Ext.Array.indexOf(Array.prototype.slice.call(n.parentNode.children),n));u=i>=0&&t.getResourceStore().getAt(i)||null}return u},onEventUpdate:function(n,t){var i=this,r=t.previous||{},u=i.view,s=u.timeAxis,f=t.getStartDate(),e=t.getEndDate(),h=r.StartDate||f,c=r.EndDate||e,l=h&&c&&s.timeSpanInAxis(h,c),o;t.resourceIdField in r&&l&&(o=n.getResourceStore().getById(r[t.resourceIdField]),o&&i.relayoutRenderedEvents(o));(f&&e&&s.timeSpanInAxis(f,e)||l)&&(i.renderSingle(t),Ext.Array.each(t.getResources(),function(n){i.relayoutRenderedEvents(n);u.getEventSelectionModel().isSelected(t)&&u.onEventBarSelect(t,!0)}))},onEventAdd:function(n,t){var r=this,e=r.view,i,u,f;t.length===1?(i=t[0],u=i.getStartDate(),f=i.getEndDate(),u&&f&&e.timeAxis.timeSpanInAxis(u,f)&&(r.renderSingle(i),Ext.Array.each(n.getResourcesForEvent(i),function(n){r.relayoutRenderedEvents(n)}))):e.repaintAllEvents()},onEventRemove:function(n,t){var h=this,o=h.view,u,f,e,i,s,r;for(r=!1,i=0,s=t.length;!r&&i<s;i++)u=t[i],f=u.getStartDate(),e=u.getEndDate(),r=f&&e&&o.timeAxis.timeSpanInAxis(f,e),r&&o.repaintAllEvents()},relayoutRenderedEvents:function(n){var i=[],t=this.view,r=t.getEventStore().getEventsForResource(n);Ext.Array.each(r,function(r){var u=t.getElementsFromEventRecord(r,n);u.length&&i.push({start:r.getStartDate(),end:r.getEndDate(),event:r,node:u[0]})});t.eventLayout.vertical.applyLayout(i,this.getResourceColumnWidth(n)-2*t.barMargin-t.cellBorderWidth);Ext.Array.each(i,function(n){n.node.setStyle({left:n.left+"px",width:n.width+"px"});t.fireEvent("eventrepaint",t,n.event,n.node)})},renderSingle:function(n){var u=this,t=u.view,i=n.getStartDate(),r=n.getEndDate();Ext.Array.each(t.getElementsFromEventRecord(n),function(n){n.destroy()});i&&r&&t.timeAxis.timeSpanInAxis(i,r)&&Ext.Array.each(n.getResources(),function(i){var r=t.getResourceStore().indexOf(i),u=Ext.fly(t.getScheduleCell(0,r)),f;u&&(f=t.generateTplData(n,i,r),t.eventTpl.append(u.first(),[f]))})},getTimeSpanRegion:function(n,t){var i=this.view,r=i.getCoordinateFromDate(n),f=t?i.getCoordinateFromDate(t):r,u=i.getTableRegion(),e=u?u.right-u.left:i.getEl().dom.clientWidth;return new Ext.util.Region(Math.min(r,f),e,Math.max(r,f),0)},getStartEndDatesFromRegion:function(n,t){var i=this.view.getDateFromCoordinate(n.top,t),r=this.view.getDateFromCoordinate(n.bottom,t);return i&&r?{start:Sch.util.Date.min(i,r),end:Sch.util.Date.max(i,r)}:null},setColumnWidth:function(n,t){var i=this.view;i.resourceColumnWidth=n;i.getTimeAxisViewModel().setViewColumnWidth(n,t)},getVisibleDateRange:function(){var n=this.view,t;if(!n.rendered)return null;var i=n.getScroll(),r=n.getHeight(),u=n.getTableRegion(),f=n.timeAxis.getEnd();return u.bottom-u.top<r?(t=n.timeAxis.getStart(),{startDate:t,endDate:f}):{startDate:n.getDateFromCoordinate(i.top,null,!0),endDate:n.getDateFromCoordinate(i.top+r,null,!0)||f}}});Ext.define("Sch.mixin.AbstractSchedulerView",{_cmpCls:"sch-schedulerview",scheduledEventName:"event",eventTemplateClass:"Sch.template.Event",eventTpl:null,barMargin:0,constrainDragToResource:!1,allowOverlap:null,readOnly:null,altColCls:"sch-col-alt",dynamicRowHeight:!0,managedEventSizing:!0,eventAnimations:!0,horizontalLayoutCls:"Sch.eventlayout.Horizontal",horizontalEventSorterFn:null,verticalLayoutCls:"Sch.eventlayout.Vertical",verticalEventSorterFn:null,eventCls:"sch-event",verticalViewClass:"Sch.view.Vertical",eventStore:null,resourceStore:null,eventLayout:null,_initializeSchedulerView:function(){var n=Ext.ClassManager.get(this.horizontalLayoutCls),t=Ext.ClassManager.get(this.verticalLayoutCls);this.eventSelector="."+this.eventCls;this.eventLayout={};this.eventTpl=this.eventTpl||Ext.create(this.eventTemplateClass,{eventPrefix:this.eventPrefix,resizeHandles:this.eventResizeHandles});n&&(this.eventLayout.horizontal=new n(Ext.apply({timeAxisViewModel:this.timeAxisViewModel},{bandIndexToPxConvertFn:this.horizontal.layoutEventVertically,bandIndexToPxConvertScope:this.horizontal},this.horizontalEventSorterFn?{sortEvents:this.horizontalEventSorterFn}:{})));t&&(this.eventLayout.vertical=new t(Ext.apply({},{view:this},this.verticalEventSorterFn?{sortEvents:this.verticalEventSorterFn}:{})));this.store=this.store||this.resourceStore;this.resourceStore=this.resourceStore||this.store},generateTplData:function(n,t,i){var r=this[this.mode].getEventRenderData(n,t,i),e=n.getStartDate(),o=n.getEndDate(),u=n.getCls()||"",f;return u+=" sch-event-resizable-"+n.getResizable(),n.dirty&&(u+=" sch-dirty "),r.endsOutsideView&&(u+=" sch-event-endsoutside "),r.startsOutsideView&&(u+=" sch-event-startsoutside "),this.eventBarIconClsField&&(u+=" sch-event-withicon "),n.isDraggable()===!1&&(u+=" sch-event-fixed "),o-e==0&&(u+=" sch-event-milestone "),this.getEventSelectionModel().isSelected(n)&&(u+=" "+this.selectedEventCls+" "),r.id=n.internalId+"-"+t.internalId+(this.getMode()==="calendar"?"-"+i:"-x"),r.internalCls=u,r.start=e,r.end=o,r.iconCls=n.data[this.eventBarIconClsField]||"",r.event=n,this.eventRenderer?(f=this.eventRenderer.call(this.eventRendererScope||this,n,t,r,i),r.body=this.eventBodyTemplate?this.eventBodyTemplate.apply(f):f):this.eventBodyTemplate?r.body=this.eventBodyTemplate.apply(n.data):this.eventBarTextField&&(r.body=n.data[this.eventBarTextField]||""),r},resolveResource:function(n){var t=this;return t[t.mode].resolveResource(n)},getResourceRegion:function(n,t,i){return this[this.mode].getResourceRegion(n,t,i)},resolveEventRecord:function(n){return n=n.dom?n.dom:n,Ext.fly(n).is(this.eventSelector)||(n=Ext.fly(n).up(this.eventSelector)),n&&this.getEventRecordFromDomId(n.id)},resolveEventRecordFromResourceRow:function(n){var t=this,r=t.getEventSelectionModel(),i;return n=n.dom?n.dom:n,i=t.getRecord(n),r.getFirstSelectedEventForResource(i)},resolveAssignmentRecord:function(n){var t=this,u=t.getEventStore().getAssignmentStore(),f=null,i,r;return u&&(i=t.getEventRecordFromDomId(n.id),r=t.getResourceRecordFromDomId(n.id),i&&r&&(f=u.getAssignmentForEventAndResource(i,r))),f},getEventRecordFromDomId:function(n){return n=this.getEventIdFromDomNodeId(n),this.getEventStore().getModelByInternalId(n)},getResourceRecordFromDomId:function(n){return n=this.getResourceIdFromDomNodeId(n),this.getResourceStore().getByInternalId(n)},isDateRangeAvailable:function(n,t,i,r){return this.getEventStore().isDateRangeAvailable(n,t,i,r)},getEventsInView:function(){var n=this.timeAxis.getStart(),t=this.timeAxis.getEnd();return this.getEventStore().getEventsInTimeSpan(n,t)},getEventNodes:function(){return this.getEl().select(this.eventSelector)},highlightEvents:function(n){var i=this,t=[];Ext.Array.each([].concat(n),function(n){t.push.apply(t,i.getElementsFromEventRecord(n,null,null,!0))});Ext.Array.each([].concat(t),function(n){Ext.fly(n).addCls("sch-event-highlighted")})},highlightEventsBy:function(n,t){var i=this.getEventsInView();this.highlightEvents(i.filterBy(n,t).getRange())},clearHighlightedEvents:function(){this.getEl().select(".sch-event-highlighted").removeCls("sch-event-highlighted")},onEventCreated:function(){},getEventStore:function(){return this.eventStore},registerEventEditor:function(n){this.eventEditor=n},getEventEditor:function(){return this.eventEditor},onEventUpdate:function(n,t,i){this[this.mode].onEventUpdate(n,t,i)},onEventAdd:function(n,t){Ext.isArray(t)||(t=[t]);this[this.mode].onEventAdd(n,t)},onAssignmentAdd:function(n,t){var i=this;Ext.Array.each(t,function(n){var t=n.getResource();t&&i.repaintEventsForResource(t)})},onAssignmentUpdate:function(n,t){var i=this,r=t.previous&&t.previous[t.resourceIdField],u=t.getResourceId(),f,e;r&&(f=i.getResourceStore().getModelById(r),i.repaintEventsForResource(f));u&&(e=i.getResourceStore().getModelById(u),i.repaintEventsForResource(e))},onAssignmentRemove:function(n,t){var i=this;Ext.Array.each(t,function(n){var t=n.getResourceId(),r=t&&i.getResourceStore().getModelById(t);r&&i.repaintEventsForResource(r)})},onEventRemove:function(n,t){this[this.mode].onEventRemove(n,t)},setEventStore:function(n,t){var i=this,o=i.getEventStore(),r={scope:i,refresh:i.onEventDataRefresh,addrecords:i.onEventAdd,updaterecord:i.onEventUpdate,removerecords:i.onEventRemove,add:i.onEventAdd,update:i.onEventUpdate,remove:i.onEventRemove,nodeinsert:i.onEventAdd,nodeappend:i.onEventAdd},e={scope:i,refresh:i.onEventDataRefresh,load:i.onEventDataRefresh,update:i.onAssignmentUpdate,add:i.onAssignmentAdd,remove:i.onAssignmentRemove},u,f;if(Ext.versions.touch||(r.clear=i.onEventDataRefresh),!t&&i.eventStore&&(i.eventStore.setResourceStore(null),n!==i.eventStore&&i.eventStore.autoDestroy?i.eventStore.destroy():i.mun?(i.mun(i.eventStore,r),u=i.eventStore.getAssignmentStore(),u&&i.mun(u,e)):i.eventStore.un(r),n||(i.eventStore=null)),n){if(n=Ext.data.StoreManager.lookup(n),i.mon)i.mon(n,r);else n.on(r);i.eventStore=n;n.setResourceStore(i.getResourceStore());f=n.getAssignmentStore();f&&i.mon(f,e)}n&&!t&&(this.getTimeAxisViewModel().setEventStore(n),this.getEventSelectionModel().bindStore(n),this.fireEvent("eventstorechange",this,n,o),i.refreshView())},onEventDataRefresh:function(){this.refreshKeepingScroll()},onEventBarSelect:function(n){var r=this,t,i;n instanceof Sch.model.Assignment?(t=n.getEvent(),i=n.getResource()):(t=n,i=null);Ext.Array.each(r.getElementsFromEventRecord(t,i),function(n){n.addCls(r.selectedEventCls)})},onEventBarDeselect:function(n){var r=this,t,i;n instanceof Sch.model.Assignment?(t=n.getEvent(),i=n.getResource()):(t=n,i=null);t&&Ext.Array.each(r.getElementsFromEventRecord(t,i),function(n){n.removeCls(r.selectedEventCls)})},refresh:function(){throw"Abstract method call";},repaintEventsForResource:function(){throw"Abstract method call";},repaintAllEvents:function(){this.refreshKeepingScroll()},scrollEventIntoView:function(n,t,i,r,u){var e=this,f=n.getResources();f.length&&e.scrollResourceEventIntoView(f[0],n,null,t,i,r,u)},getResourceStore:function(){return this.resourceStore},setResourceStore:function(n){var t=this.resourceStore;this.resourceStore=n;n&&this.fireEvent("resourcestorechange",this,n,t)}});Ext.define("Sch.preset.ViewPreset",{name:null,rowHeight:null,timeColumnWidth:50,timeRowHeight:null,timeAxisColumnWidth:null,displayDateFormat:"G:i",shiftUnit:"HOUR",shiftIncrement:1,defaultSpan:12,timeResolution:null,headerConfig:null,columnLinesFor:"middle",headers:null,mainHeader:0,constructor:function(n){Ext.apply(this,n)},getHeaders:function(){if(this.headers)return this.headers;var n=this.headerConfig;return this.mainHeader=n.top?1:0,this.headers=[].concat(n.top||[],n.middle||[],n.bottom||[])},getMainHeader:function(){return this.getHeaders()[this.mainHeader]},getBottomHeader:function(){var n=this.getHeaders();return n[n.length-1]},clone:function(){var n={},t=this;return Ext.Array.each(["rowHeight","timeColumnWidth","timeRowHeight","timeAxisColumnWidth","displayDateFormat","shiftUnit","shiftIncrement","defaultSpan","timeResolution","headerConfig"],function(i){n[i]=t[i]}),new this.self(Ext.clone(n))}});Ext.define("Sch.preset.Manager",{extend:Ext.util.MixedCollection,mixins:[Sch.mixin.Localizable],singleton:!0,defaultPresets:{secondAndMinute:{timeColumnWidth:30,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"G:i:s",shiftIncrement:10,shiftUnit:"MINUTE",defaultSpan:24,timeResolution:{unit:"SECOND",increment:5},headerConfig:{middle:{unit:"SECOND",increment:10,align:"center",dateFormat:"s"},top:{unit:"MINUTE",align:"center",dateFormat:"D, d g:iA"}}},minuteAndHour:{timeColumnWidth:100,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"G:i",shiftIncrement:1,shiftUnit:"HOUR",defaultSpan:24,timeResolution:{unit:"MINUTE",increment:30},headerConfig:{middle:{unit:"MINUTE",increment:"30",align:"center",dateFormat:"i"},top:{unit:"HOUR",align:"center",dateFormat:"D, gA/d"}}},hourAndDay:{timeColumnWidth:60,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"G:i",shiftIncrement:1,shiftUnit:"DAY",defaultSpan:24,timeResolution:{unit:"MINUTE",increment:30},headerConfig:{middle:{unit:"HOUR",align:"center",dateFormat:"G:i"},top:{unit:"DAY",align:"center",dateFormat:"D d/m"}}},dayAndWeek:{timeColumnWidth:100,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d G:i",shiftUnit:"DAY",shiftIncrement:1,defaultSpan:5,timeResolution:{unit:"HOUR",increment:1},headerConfig:{middle:{unit:"DAY",align:"center",dateFormat:"D d M"},top:{unit:"WEEK",align:"center",renderer:function(n){return Sch.util.Date.getShortNameOfUnit("WEEK")+"."+Ext.Date.format(n,"W M Y")}}}},weekAndDay:{timeColumnWidth:100,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"WEEK",shiftIncrement:1,defaultSpan:1,timeResolution:{unit:"DAY",increment:1},headerConfig:{bottom:{unit:"DAY",align:"center",increment:1,dateFormat:"d/m"},middle:{unit:"WEEK",dateFormat:"D d M"}}},weekAndMonth:{timeColumnWidth:100,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"WEEK",shiftIncrement:5,defaultSpan:6,timeResolution:{unit:"DAY",increment:1},headerConfig:{middle:{unit:"WEEK",align:"center",renderer:function(n){return Ext.Date.format(n,"d M")}},top:{unit:"MONTH",align:"center",dateFormat:"M Y"}}},monthAndYear:{timeColumnWidth:110,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftIncrement:3,shiftUnit:"MONTH",defaultSpan:12,timeResolution:{unit:"DAY",increment:1},headerConfig:{middle:{unit:"MONTH",align:"center",dateFormat:"M Y"},top:{unit:"YEAR",align:"center",dateFormat:"Y"}}},year:{timeColumnWidth:100,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"YEAR",shiftIncrement:1,defaultSpan:1,timeResolution:{unit:"MONTH",increment:1},headerConfig:{middle:{unit:"QUARTER",align:"center",renderer:function(n){return Ext.String.format(Sch.util.Date.getShortNameOfUnit("QUARTER").toUpperCase()+"{0}",Math.floor(n.getMonth()/3)+1)}},top:{unit:"YEAR",align:"center",dateFormat:"Y"}}},manyYears:{timeColumnWidth:50,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"YEAR",shiftIncrement:1,defaultSpan:1,timeResolution:{unit:"YEAR",increment:1},headerConfig:{middle:{unit:"YEAR",align:"center",dateFormat:"Y",increment:5},bottom:{unit:"YEAR",align:"center",dateFormat:"y",increment:1}}},weekAndDayLetter:{timeColumnWidth:20,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"WEEK",shiftIncrement:1,defaultSpan:10,timeResolution:{unit:"DAY",increment:1},headerConfig:{bottom:{unit:"DAY",align:"center",renderer:function(n){return Ext.Date.dayNames[n.getDay()].substring(0,1)}},middle:{unit:"WEEK",dateFormat:"D d M Y"}}},weekDateAndMonth:{timeColumnWidth:30,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"Y-m-d",shiftUnit:"WEEK",shiftIncrement:1,defaultSpan:10,timeResolution:{unit:"DAY",increment:1},headerConfig:{middle:{unit:"WEEK",align:"center",dateFormat:"d"},top:{unit:"MONTH",dateFormat:"Y F"}}},day:{timeRowHeight:40,calendarColumnWidth:200,displayDateFormat:"G:i",shiftIncrement:1,shiftUnit:"DAY",defaultSpan:24,timeResolution:{unit:"MINUTE",increment:30},headerConfig:{bottom:{unit:"HOUR",align:"center",renderer:function(n){return Ext.String.format('<div class="sch-calendarcolumn-ct"><span class="sch-calendarcolumn-hours">{0}<\/span><span class="sch-calendarcolumn-minutes">{1}<\/span><\/div>',Ext.Date.format(n,"H"),Ext.Date.format(n,"i"))}},middle:{unit:"DAY",align:"center",dateFormat:"D d/m",splitUnit:"DAY"}}},week:{timeRowHeight:40,calendarColumnWidth:164,displayDateFormat:"G:i",shiftIncrement:1,shiftUnit:"WEEK",defaultSpan:24,timeResolution:{unit:"MINUTE",increment:30},headerConfig:{bottom:{unit:"HOUR",align:"center",dateFormat:"H:i",renderer:function(n){return Ext.String.format('<div class="sch-calendarcolumn-ct"><span class="sch-calendarcolumn-hours">{0}<\/span><span class="sch-calendarcolumn-minutes">{1}<\/span><\/div>',Ext.Date.format(n,"H"),Ext.Date.format(n,"i"))}},middle:{unit:"WEEK",align:"center",dateFormat:"D d",splitUnit:"DAY"}}},month:{timeColumnWidth:60,rowHeight:24,resourceColumnWidth:100,displayDateFormat:"G:i",shiftIncrement:1,shiftUnit:"MONTH",defaultSpan:4,timeResolution:{unit:"HOUR",increment:12},headerConfig:{bottom:{unit:"DAY",align:"center",dateFormat:"D",splitUnit:"WEEK"},middle:{unit:"WEEK",align:"center",dateFormat:"D d/m"},top:{unit:"MONTH",align:"center",renderer:function(n,t){return Ext.Date.format(n,"d/m")+" - "+Ext.Date.format(t,"d/m, Y")},splitUnit:"WEEK"}}}},constructor:function(){this.callParent(arguments);this.registerDefaults()},onLocalized:function(){var n=this;this.eachKey(function(t,i){if(n.l10n[t]){var r=n.L(t);r.displayDateFormat&&(i.displayDateFormat=r.displayDateFormat);r.middleDateFormat&&(i.headerConfig.middle.dateFormat=r.middleDateFormat);r.topDateFormat&&(i.headerConfig.top.dateFormat=r.topDateFormat);r.bottomDateFormat&&(i.headerConfig.bottom.dateFormat=r.bottomDateFormat)}})},registerPreset:function(n,t){var i,r,u,f,e;if(t){i=t.headerConfig;r=Sch.util.Date;for(u in i)i.hasOwnProperty(u)&&(r[i[u].unit]&&(i[u].unit=r[i[u].unit.toUpperCase()]),r[i[u].splitUnit]&&(i[u].splitUnit=r[i[u].splitUnit.toUpperCase()]));t.timeColumnWidth||(t.timeColumnWidth=50);t.rowHeight||(t.rowHeight=24);f=t.timeResolution;f&&r[f.unit]&&(f.unit=r[f.unit.toUpperCase()]);e=t.shiftUnit;e&&r[e]&&(t.shiftUnit=r[e.toUpperCase()])}if(this.isValidPreset(t))this.containsKey(n)&&this.removeAtKey(n),t.name=n,this.add(n,new Sch.preset.ViewPreset(t));else throw"Invalid preset, please check your configuration";},isValidPreset:function(n){var f=Sch.util.Date,t=!0,i=Sch.util.Date.units,u={};for(var r in n.headerConfig)n.headerConfig.hasOwnProperty(r)&&(u[r]=!0,t=t&&Ext.Array.indexOf(i,n.headerConfig[r].unit)>=0);return n.columnLinesFor in u||(n.columnLinesFor="middle"),n.timeResolution&&(t=t&&Ext.Array.indexOf(i,n.timeResolution.unit)>=0),n.shiftUnit&&(t=t&&Ext.Array.indexOf(i,n.shiftUnit)>=0),t},getPreset:function(n){return this.get(n)},deletePreset:function(n){this.removeAtKey(n)},registerDefaults:function(){var i=this,n=this.defaultPresets;for(var t in n)i.registerPreset(t,n[t])}});Ext.define("Sch.view.model.TimeAxis",{extend:Ext.util.Observable,timeAxis:null,availableWidth:0,tickWidth:100,snapToIncrement:!1,forceFit:!1,headerConfig:null,headers:null,mainHeader:0,timeAxisColumnWidth:null,resourceColumnWidth:null,calendarColumnWidth:null,timeColumnWidth:null,rowHeightHorizontal:null,rowHeightVertical:null,mode:"horizontal",suppressFit:!1,refCount:0,columnConfig:{},viewPreset:null,columnLinesFor:"middle",eventStore:null,originalTickWidth:null,constructor:function(n){var t=this,i;Ext.apply(this,n);this.viewPreset&&(this.viewPreset instanceof Sch.preset.ViewPreset?this.consumeViewPreset(this.viewPreset):(i=Sch.preset.Manager.getPreset(this.viewPreset),i&&this.consumeViewPreset(i)));t.timeAxis.on("reconfigure",t.onTimeAxisReconfigure,t);this.callParent(arguments)},destroy:function(){this.timeAxis.un("reconfigure",this.onTimeAxisReconfigure,this)},onTimeAxisReconfigure:function(n,t){t||this.update()},reconfigure:function(n){this.headers=null;Ext.apply(this,n);switch(this.mode){case"horizontal":this.setTickWidth(this.timeColumnWidth);break;case"vertical":this.setTickWidth(this.rowHeightVertical);break;case"calendar":this.setTickWidth(this.rowHeightVertical)}this.fireEvent("reconfigure",this)},getColumnConfig:function(){return this.columnConfig},update:function(n,t){var f=this.timeAxis,r=this.headerConfig,i,u;if(this.availableWidth=Math.max(n||this.availableWidth,0),!Ext.isNumber(this.availableWidth))throw"Invalid available width provided to Sch.view.model.TimeAxis";if(!this.forceFit||!(this.availableWidth<=0)){this.columnConfig={};for(i in r)this.columnConfig[i]=r[i].cellGenerator?r[i].cellGenerator.call(this,f.getStart(),f.getEnd()):this.createHeaderRow(i,r[i]);if(u=this.calculateTickWidth(this.originalTickWidth),!Ext.isNumber(u)||u<=0)throw"Invalid column width calculated in Sch.view.model.TimeAxis";this.updateTickWidth(u);t||this.fireEvent("update",this)}},createHeaderRow:function(n,t){var r=[],i=this,u=t.align,f=Ext.Date.clearTime(new Date);return i.forEachInterval(n,function(n,e,o){var s={align:u,start:n,end:e,headerCls:""};s.header=t.renderer?t.renderer.call(t.scope||i,n,e,s,o,i.eventStore):Ext.Date.format(n,t.dateFormat);t.unit!==Sch.util.Date.DAY||t.increment&&t.increment!==1||(s.headerCls+=" sch-dayheadercell-"+n.getDay(),Ext.Date.clearTime(n,!0)-f==0&&(s.headerCls+=" sch-dayheadercell-today"));r.push(s)}),r},getDistanceBetweenDates:function(n,t){return Math.round(this.getPositionFromDate(t,!0)-this.getPositionFromDate(n))},getPositionFromDate:function(n,t){var i,r;if(this.mode==="calendar"){var u=this.rowHeightCalendar||this.rowHeightVertical,f=this.getHeaders(),e=this.timeAxis.getStart(),o=Sch.util.Date,h=o.mergeDates(e,n,f[1].unit),c=o.getDurationInUnit(e,h,f[1].unit,!0)*u,s=Math.round(c);return s===0&&t?this.calendarRowsAmount*u:s}return i=-1,r=this.timeAxis.getTickFromDate(n),r>=0&&(i=Math.round(this.tickWidth*(r-this.timeAxis.visibleTickStart))),i},getDateFromPosition:function(n,t){var i,f;if(this.mode==="calendar"){var o=this.rowHeightCalendar||this.rowHeightVertical,r=Sch.util.Date,s=this.timeAxis.getStart(),h=this.getHeaders(),c=r.add(s,h[0].splitUnit,Math.floor(n[0]/this.calendarColumnWidth)),e=this.timeAxis.first(),l=(e.get("end")-e.get("start"))/o,u=r.add(c,r.MILLI,Math.round(n[1]*l));return t&&(u=this.timeAxis[t+"Date"](u)),u}return(i=n/this.getTickWidth()+this.timeAxis.visibleTickStart,f=this.timeAxis.getCount(),i<0||i>f)?null:this.timeAxis.getDateFromTick(i,t)},getSingleUnitInPixels:function(n){return Sch.util.Date.getUnitToBaseUnitRatio(this.timeAxis.getUnit(),n)*this.tickWidth/this.timeAxis.increment},getSnapPixelAmount:function(){if(this.snapToIncrement){var n=this.timeAxis.getResolution();return(n.increment||1)*this.getSingleUnitInPixels(n.unit)}return 1},getTickWidth:function(){return this.tickWidth},setTickWidth:function(n,t){this.originalTickWidth=n;this.updateTickWidth(n);this.update(null,t)},updateTickWidth:function(n){this.tickWidth=n;switch(this.mode){case"horizontal":this.timeColumnWidth=n;break;case"vertical":this.rowHeightVertical=n;break;case"calendar":this.rowHeightVertical=n}},getTotalWidth:function(){return Math.round(this.tickWidth*this.timeAxis.getVisibleTickTimeSpan())},calculateTickWidth:function(n){var i=this.forceFit,u=this.timeAxis,r=0,f=u.getUnit(),t=Number.MAX_VALUE,e=Sch.util.Date,o,h,s,c;return this.snapToIncrement?(o=u.getResolution(),t=e.getUnitToBaseUnitRatio(f,o.unit)*o.increment):(h=e.getMeasuringUnit(f),t=Math.min(t,e.getUnitToBaseUnitRatio(f,h))),this.suppressFit?r=n:(s=Math[i?"floor":"round"](this.getAvailableWidth()/u.getVisibleTickTimeSpan()),r=i||n<s?s:n,t>0&&(!i||t<1)&&(c=Ext.versions.touch&&i?"ceil":i?"floor":"round",r=Math.round(Math.max(1,Math[c](t*r))/t))),r},getAvailableWidth:function(){return this.availableWidth},setAvailableWidth:function(n){this.availableWidth=Math.max(0,n);var t=this.calculateTickWidth(this.originalTickWidth);t!==this.tickWidth&&this.update()},fitToAvailableWidth:function(n){var t=Math.floor(this.availableWidth/this.timeAxis.getVisibleTickTimeSpan());this.setTickWidth(t,n)},setForceFit:function(n){n!==this.forceFit&&(this.forceFit=n,this.update())},setSnapToIncrement:function(n){n!==this.snapToIncrement&&(this.snapToIncrement=n,this.update())},getViewRowHeight:function(){var n=this.mode=="horizontal"?this.rowHeightHorizontal:this.rowHeightVertical;if(!n)throw"rowHeight info not available";return n},setViewRowHeight:function(n,t){var r=this.mode==="horizontal",i="rowHeight"+Ext.String.capitalize(this.mode);this[i]!=n&&(this[i]=n,r?t||this.fireEvent("update",this):this.setTickWidth(n,t))},setViewColumnWidth:function(n,t){switch(this.mode){case"horizontal":this.setTickWidth(n,t);break;case"vertical":this.resourceColumnWidth=n;break;case"calendar":this.calendarColumnWidth=n}t||this.fireEvent("columnwidthchange",this,n)},getHeaders:function(){if(this.headers)return this.headers;var n=this.headerConfig;return this.mainHeader=n.top?1:0,this.headers=[].concat(n.top||[],n.middle||[],n.bottom||[])},getMainHeader:function(){return this.getHeaders()[this.mainHeader]},getBottomHeader:function(){var n=this.getHeaders();return n[n.length-1]},forEachInterval:function(n,t,i){var r,u;(i=i||this,r=this.headerConfig,r)&&(n==="top"||n==="middle"&&r.bottom?(u=r[n],this.timeAxis.forEachAuxInterval(u.unit,u.increment,t,i)):this.timeAxis.each(function(n,r){return t.call(i,n.data.start,n.data.end,r)}))},forEachMainInterval:function(n,t){this.forEachInterval("middle",n,t)},getLowestHeader:function(){return"bottom"in this.headerConfig?"bottom":"middle"},consumeViewPreset:function(n){this.headers=null;var t=this.mode=="horizontal";Ext.apply(this,{headerConfig:n.headerConfig,columnLinesFor:n.columnLinesFor||"middle",rowHeightHorizontal:n.rowHeight,tickWidth:t?n.timeColumnWidth:n.timeRowHeight||n.timeColumnWidth||60,timeColumnWidth:n.timeColumnWidth,rowHeightVertical:n.timeRowHeight||n.timeColumnWidth||60,timeAxisColumnWidth:n.timeAxisColumnWidth,resourceColumnWidth:n.resourceColumnWidth||100});this.originalTickWidth=this.tickWidth},setEventStore:function(n){this.eventStore=n}});Ext.define("Sch.mixin.Zoomable",{zoomLevels:[{width:40,increment:1,resolution:1,preset:"manyYears",resolutionUnit:"YEAR"},{width:80,increment:1,resolution:1,preset:"manyYears",resolutionUnit:"YEAR"},{width:30,increment:1,resolution:1,preset:"year",resolutionUnit:"MONTH"},{width:50,increment:1,resolution:1,preset:"year",resolutionUnit:"MONTH"},{width:100,increment:1,resolution:1,preset:"year",resolutionUnit:"MONTH"},{width:200,increment:1,resolution:1,preset:"year",resolutionUnit:"MONTH"},{width:100,increment:1,resolution:7,preset:"monthAndYear",resolutionUnit:"DAY"},{width:30,increment:1,resolution:1,preset:"weekDateAndMonth",resolutionUnit:"DAY"},{width:35,increment:1,resolution:1,preset:"weekAndMonth",resolutionUnit:"DAY"},{width:50,increment:1,resolution:1,preset:"weekAndMonth",resolutionUnit:"DAY"},{width:20,increment:1,resolution:1,preset:"weekAndDayLetter"},{width:50,increment:1,resolution:1,preset:"weekAndDay",resolutionUnit:"HOUR"},{width:100,increment:1,resolution:1,preset:"weekAndDay",resolutionUnit:"HOUR"},{width:50,increment:6,resolution:30,preset:"hourAndDay",resolutionUnit:"MINUTE"},{width:100,increment:6,resolution:30,preset:"hourAndDay",resolutionUnit:"MINUTE"},{width:60,increment:2,resolution:30,preset:"hourAndDay",resolutionUnit:"MINUTE"},{width:60,increment:1,resolution:30,preset:"hourAndDay",resolutionUnit:"MINUTE"},{width:30,increment:15,resolution:5,preset:"minuteAndHour"},{width:60,increment:15,resolution:5,preset:"minuteAndHour"},{width:130,increment:15,resolution:5,preset:"minuteAndHour"},{width:60,increment:5,resolution:5,preset:"minuteAndHour"},{width:100,increment:5,resolution:5,preset:"minuteAndHour"},{width:50,increment:2,resolution:1,preset:"minuteAndHour"},{width:30,increment:10,resolution:5,preset:"secondAndMinute"},{width:60,increment:10,resolution:5,preset:"secondAndMinute"},{width:130,increment:5,resolution:5,preset:"secondAndMinute"}],minZoomLevel:null,maxZoomLevel:null,visibleZoomFactor:5,zoomKeepsOriginalTimespan:!1,cachedCenterDate:null,initializeZooming:function(){this.zoomLevels=this.zoomLevels.slice();this.setMinZoomLevel(this.minZoomLevel||0);this.setMaxZoomLevel(this.maxZoomLevel!==null?this.maxZoomLevel:this.zoomLevels.length-1);this.on("viewchange",this.clearCenterDateCache,this)},getZoomLevelUnit:function(n){return Sch.preset.Manager.getPreset(n.preset).getBottomHeader().unit},getMilliSecondsPerPixelForZoomLevel:function(n,t){var i=Sch.util.Date;return Math.round((i.add(new Date(1,0,1),this.getZoomLevelUnit(n),n.increment)-new Date(1,0,1))/(t?n.width:n.actualWidth||n.width))},presetToZoomLevel:function(n){var t=Sch.preset.Manager.getPreset(n);return{preset:n,increment:t.getBottomHeader().increment||1,resolution:t.timeResolution.increment,resolutionUnit:t.timeResolution.unit,width:t.timeColumnWidth}},zoomLevelToPreset:function(n){var t=Sch.preset.Manager.getPreset(n.preset).clone(),i=t.getBottomHeader();return i.increment=n.increment,t.timeColumnWidth=n.width,(n.resolutionUnit||n.resolution)&&(t.timeResolution={unit:n.resolutionUnit||t.timeResolution.unit||i.unit,increment:n.resolution||t.timeResolution.increment||1}),t},calculateCurrentZoomLevel:function(){var n=this.presetToZoomLevel(this.viewPreset),u=Number.MAX_VALUE,f=this.timeAxisViewModel,e=f.timeColumnWidth,i,o,t,r;for(n.width=e,n.increment=f.getBottomHeader().increment||1,i=0,o=this.zoomLevels.length;i<o;i++)(t=this.zoomLevels[i],t.preset===n.preset)&&(r=Math.abs(t.width-e),r<u&&(u=r,n.actualWidth=t.actualWidth,n.width=t.width));return n},getCurrentZoomLevelIndex:function(){for(var t,u,f=this.calculateCurrentZoomLevel(),i=this.getMilliSecondsPerPixelForZoomLevel(f),r=this.zoomLevels,n=0;n<r.length;n++){if(t=this.getMilliSecondsPerPixelForZoomLevel(r[n]),t==i)return n;if(n===0&&i>t)return-.5;if(n==r.length-1&&i<t)return r.length-1+.5;if(u=this.getMilliSecondsPerPixelForZoomLevel(r[n+1]),t>i&&i>u)return n+.5}throw"Can't find current zoom level index";},setMaxZoomLevel:function(n){if(n<0||n>=this.zoomLevels.length)throw new Error("Invalid range for `setMinZoomLevel`");this.maxZoomLevel=n},setMinZoomLevel:function(n){if(n<0||n>=this.zoomLevels.length)throw new Error("Invalid range for `setMinZoomLevel`");this.minZoomLevel=n},getViewportCenterDateCached:function(){return this.cachedCenterDate?this.cachedCenterDate:this.cachedCenterDate=this.getViewportCenterDate()},clearCenterDateCache:function(){this.cachedCenterDate=null},zoomToLevel:function(n,t,i){var r,c,o,h;n=Ext.Number.constrain(n,this.minZoomLevel,this.maxZoomLevel);i=i||{};var p=this.calculateCurrentZoomLevel(),w=this.getMilliSecondsPerPixelForZoomLevel(p),u=this.zoomLevels[n],b=this.getMilliSecondsPerPixelForZoomLevel(u);if(w==b&&!t)return null;r=this;r.fireEvent("beforezoomchange",r,n);var f=this.getSchedulingView(),v=f.getOuterEl(),l=this.mode=="vertical",s=t?new Date((t.start.getTime()+t.end.getTime())/2):this.getViewportCenterDateCached(),a=l?v.getHeight():v.getWidth(),e=Sch.preset.Manager.getPreset(u.preset).clone(),y=e.getBottomHeader(),k=Boolean(t);t=this.calculateOptimalDateRange(s,a,u,t);e[l?"timeRowHeight":"timeColumnWidth"]=i.customWidth||u.width;y.increment=u.increment;this.isZooming=!0;this.viewPreset=u.preset;c=this.timeAxis;e.increment=u.increment;e.timeResolution.unit=Sch.util.Date.getUnitByName(u.resolutionUnit||e.timeResolution.unit||y.unit);e.timeResolution.increment=u.resolution;this.setViewPreset(e,t.start||this.getStart(),t.end||this.getEnd(),!1,!0);u.actualWidth=this.timeAxisViewModel.getTickWidth();k&&(s=i.centerDate||new Date((c.getStart().getTime()+c.getEnd().getTime())/2));o=null;h=null;f.un("scroll",r.clearCenterDateCache,r);f.on("scroll",function(){f.on("scroll",r.clearCenterDateCache,r,{single:!0})},f,{single:!0});return r.cachedCenterDate=s,l?(h=f.getYFromDate(s,!0)-a/2,f.scrollTo(null,h)):(o=f.getXFromDate(s,!0)-a/2,f.headerCt.scrollTo(o),f.scrollTo(o)),r.isZooming=!1,r.fireEvent("zoomchange",r,n,o,h),n},setZoomLevel:function(){this.zoomToLevel.apply(this,arguments)},zoomToSpan:function(n,t){var e,o,a,p,v,w,y,b;if(t=t||{},(t.leftMargin||t.rightMargin)&&(t.adjustStart=0,t.adjustEnd=0),Ext.applyIf(t,{leftMargin:0,rightMargin:0}),n.start&&n.end){var i=n.start,r=n.end,k=t.adjustStart>=0&&t.adjustEnd>=0;if(k&&(i=Sch.util.Date.add(i,this.timeAxis.mainUnit,-t.adjustStart),r=Sch.util.Date.add(r,this.timeAxis.mainUnit,t.adjustEnd)),i<=r){e=this.getSchedulingView().getTimeAxisViewModel().getAvailableWidth();o=Math.floor(this.getCurrentZoomLevelIndex());o==-1&&(o=0);for(var l=this.zoomLevels,d=r-i||1,h=this.getMilliSecondsPerPixelForZoomLevel(l[o],!0),c=d/h+t.leftMargin+t.rightMargin>e?-1:1,u=o+c,s,f=null;u>=0&&u<=l.length-1;){if(s=l[u],h=this.getMilliSecondsPerPixelForZoomLevel(s,!0),a=d/h+t.leftMargin+t.rightMargin,c==-1){if(a<=e){f=u;break}}else if(a<=e)o!==u-c&&(f=u);else break;u+=c}return(f=f!==null?f:u-c,s=l[f],p=Sch.preset.Manager.getPreset(s.preset).getBottomHeader().unit,(t.leftMargin||t.rightMargin)&&(i=new Date(i.getTime()-h*t.leftMargin),r=new Date(r.getTime()+h*t.rightMargin)),v=Sch.util.Date.getDurationInUnit(i,r,p,!0)/s.increment,v===0)?void 0:(w=Math.floor(e/v),y=new Date((i.getTime()+r.getTime())/2),b=k?{start:i,end:r}:this.calculateOptimalDateRange(y,e,s),this.zoomToLevel(f,b,{customWidth:w,centerDate:y}))}}return null},zoomIn:function(n){n=n||1;var t=this.getCurrentZoomLevelIndex();return t>=this.zoomLevels.length-1?null:this.zoomToLevel(Math.floor(t)+n)},zoomOut:function(n){n=n||1;var t=this.getCurrentZoomLevelIndex();return t<=0?null:this.zoomToLevel(Math.ceil(t)-n)},zoomInFull:function(){return this.zoomToLevel(this.maxZoomLevel)},zoomOutFull:function(){return this.zoomToLevel(this.minZoomLevel)},calculateOptimalDateRange:function(n,t,i,r){var u;if(r)return r;if(u=this.timeAxis,this.zoomKeepsOriginalTimespan)return{start:u.getStart(),end:u.getEnd()};var e=Sch.util.Date,f=this.getZoomLevelUnit(i),o=Math.ceil(t/i.width*i.increment*this.visibleZoomFactor/2),s=e.add(n,f,-o),h=e.add(n,f,o);return{start:u.floorDate(s,!1,f,i.increment),end:u.ceilDate(h,!1,f,i.increment)}}});Ext.define("Sch.mixin.AbstractTimelinePanel",{mixins:[Sch.mixin.Zoomable],orientation:"horizontal",snapToIncrement:!1,readOnly:!1,forceFit:!1,eventResizeHandles:"both",timeAxis:null,autoAdjustTimeAxis:!0,timeAxisViewModel:null,crudManager:null,viewPreset:"weekAndDay",calendarViewPreset:"week",trackHeaderOver:!0,startDate:null,endDate:null,startTime:0,endTime:24,columnLines:!0,getDateConstraints:Ext.emptyFn,snapRelativeToEventStartDate:!1,trackMouseOver:!1,readRowHeightFromPreset:!0,eventBorderWidth:1,getOrientation:function(){return this.getMode.apply(this,arguments)},getMode:function(){return this.mode},isHorizontal:function(){return this.getMode()==="horizontal"},isVertical:function(){return!this.isHorizontal()},cellBorderWidth:1,cellTopBorderWidth:1,cellBottomBorderWidth:1,renderers:null,_initializeTimelinePanel:function(){var t,i,n;if(this.mode=this.mode||this.orientation||"horizontal",this.mode==="calendar"&&(this.oldViewPreset=this.viewPreset,this.viewPreset=this.calendarViewPreset),t=this.viewPreset&&Sch.preset.Manager.getPreset(this.viewPreset),!t)throw"You must define a valid view preset object. See Sch.preset.Manager class for reference";this.initializeZooming();this.renderers=[];this.readRowHeightFromPreset&&(this.readRowHeightFromPreset=!this.rowHeight);this.timeAxis||(this.timeAxis=new Sch.data.TimeAxis({autoAdjust:this.autoAdjustTimeAxis,mode:this.mode==="calendar"?"calendar":"plain"}));this.timeAxisViewModel&&this.timeAxisViewModel instanceof Sch.view.model.TimeAxis||(i=Ext.apply({mode:this.mode,snapToIncrement:this.snapToIncrement,forceFit:this.forceFit,timeAxis:this.timeAxis,eventStore:this.getEventStore(),viewPreset:this.viewPreset},this.timeAxisViewModel||{}),this.timeAxisViewModel=new Sch.view.model.TimeAxis(i));this.timeAxisViewModel.on("update",this.onTimeAxisViewModelUpdate,this);this.timeAxisViewModel.refCount++;this.on("destroy",this.onPanelDestroyed,this);switch(this.mode){case"horizontal":n=["sch-horizontal"];break;case"vertical":n=["sch-vertical","sch-vertical-resource"];break;case"calendar":n=["sch-vertical","sch-calendar"]}this.addCls([].concat.apply(["sch-timelinepanel"],n))},onTimeAxisViewModelUpdate:function(){var n=this.getSchedulingView();n&&n.viewReady&&(n.refreshKeepingScroll(),this.fireEvent("viewchange",this))},onPanelDestroyed:function(){var n=this.timeAxisViewModel;n.un("update",this.onTimeAxisViewModelUpdate,this);n.refCount--;n.refCount<=0&&n.destroy()},getSchedulingView:function(){throw"Abstract method call";},setReadOnly:function(n){this.getSchedulingView().setReadOnly(n)},isReadOnly:function(){return this.getSchedulingView().isReadOnly()},switchViewPreset:function(){this.setViewPreset.apply(this,arguments)},setViewPreset:function(n,t,i,r,u){var f=this.timeAxis,s,e,o;if(this.fireEvent("beforeviewchange",this,n,t,i)!==!1){if(s=this.getMode()==="horizontal",typeof n=="string"&&(this.viewPreset=n,n=Sch.preset.Manager.getPreset(n)),!n)throw"View preset not found";r&&f.isConfigured||(e={weekStartDay:this.weekStartDay!==undefined?this.weekStartDay:this.L?this.L("weekStartDay"):1,startTime:this.startTime,endTime:this.endTime},r?(f.getCount()===0||t)&&(e.start=t||new Date):e.start=t||f.getStart(),e.end=i,f.consumeViewPreset(n),f.reconfigure(e,!0),this.timeAxisViewModel.reconfigure({headerConfig:n.headerConfig,columnLinesFor:n.columnLinesFor||"middle",rowHeightHorizontal:this.readRowHeightFromPreset?n.rowHeight:this.rowHeight||this.timeAxisViewModel.getViewRowHeight(),tickWidth:s?n.timeColumnWidth:n.timeRowHeight||n.timeColumnWidth||60,timeColumnWidth:n.timeColumnWidth,rowHeightVertical:n.timeRowHeight||n.timeColumnWidth||60,timeAxisColumnWidth:n.timeAxisColumnWidth,resourceColumnWidth:this.resourceColumnWidth||n.resourceColumnWidth||100}));o=this.getSchedulingView();o.setDisplayDateFormat(n.displayDateFormat);this.getMode()==="vertical"&&o.setColumnWidth(this.resourceColumnWidth||n.resourceColumnWidth||100,!0);u||(s?o.scrollHorizontallyTo(0):o.scrollVerticallyTo(0))}},getViewPreset:function(){return this.viewPreset},getStart:function(){return this.getStartDate()},getStartDate:function(){return this.timeAxis.getStart()},getEnd:function(){return this.getEndDate()},getEndDate:function(){return this.timeAxis.getEnd()},setTimeColumnWidth:function(n,t){this.timeAxisViewModel.setTickWidth(n,t)},getTimeColumnWidth:function(){return this.timeAxisViewModel.getTickWidth()},getRowHeight:function(){return this.timeAxisViewModel.getViewRowHeight()},shiftNext:function(n){this.suspendLayouts&&this.suspendLayouts();this.timeAxis.shiftNext(n);this.suspendLayouts&&this.resumeLayouts(!0)},shiftPrevious:function(n){this.suspendLayouts&&this.suspendLayouts();this.timeAxis.shiftPrevious(n);this.suspendLayouts&&this.resumeLayouts(!0)},goToNow:function(){this.setTimeSpan(new Date)},setTimeSpan:function(n,t){this.timeAxis&&this.timeAxis.setTimeSpan(n,t)},setStart:function(n){this.setStartDate(n)},setEnd:function(n){this.setEndDate(n)},setStartDate:function(n){this.setTimeSpan(n)},setEndDate:function(n){this.setTimeSpan(null,n)},getTimeAxis:function(){return this.timeAxis},scrollToDate:function(n,t){var i=this.getSchedulingView(),r=i.getCoordinateFromDate(n,!0);this.scrollToCoordinate(r,n,t,!1)},scrollToDateCentered:function(n,t){var i=this.getSchedulingView(),r=0,u;r=this.mode==="horizontal"?i.getBox().width/2:i.getBox().height/2;u=Math.round(i.getCoordinateFromDate(n,!0)-r);this.scrollToCoordinate(u,n,t,!0)},scrollToCoordinate:function(n,t,i,r){var u=this.getSchedulingView(),e=this,f;if(n<0){this.infiniteScroll?u.shiftToDate(t,r):(f=(this.timeAxis.getEnd()-this.timeAxis.getStart())/2,this.setTimeSpan(new Date(t.getTime()-f),new Date(t.getTime()+f)),r?e.scrollToDateCentered(t,i):e.scrollToDate(t,i));return}this.mode==="horizontal"?u.scrollHorizontallyTo(n,i):u.scrollVerticallyTo(n,i)},getViewportCenterDate:function(){return this.getSchedulingView().getViewportCenterDate()},addCls:function(){throw"Abstract method call";},removeCls:function(){throw"Abstract method call";},registerRenderer:function(n,t){this.renderers.push({fn:n,scope:t})},deregisterRenderer:function(n){Ext.each(this.renderers,function(t,i){if(n===t)return Ext.Array.removeAt(this.renderers,i),!1})},getCrudManager:function(){return this.crudManager},setCrudManager:function(n){this.crudManager=n}});Ext.define("Sch.view.Horizontal",{view:null,constructor:function(n){Ext.apply(this,n)},translateToScheduleCoordinate:function(n){var t=this.view;return t.rtl?t.getHorizontalTimeAxisColumn().getEl().getRight()-n:n-t.getEl().getX()+t.getScroll().left},translateToPageCoordinate:function(n){var t=this.view;return n+t.getEl().getX()-t.getScroll().left},getDateFromXY:function(n,t,i){var r=n[0];return i||(r=this.translateToScheduleCoordinate(r)),this.view.timeAxisViewModel.getDateFromPosition(r,t)},getEventRenderData:function(n){var u=n.getStartDate(),f=n.getEndDate()||u,t=this.view,s=t.timeAxis.getStart(),h=t.timeAxis.getEnd(),r=Math,e=t.getXFromDate(Sch.util.Date.max(u,s)),o=t.getXFromDate(Sch.util.Date.min(f,h)),i={};return this.view.rtl?i.right=r.min(e,o):i.left=r.min(e,o),i.width=r.max(1,r.abs(o-e))-t.eventBorderWidth,t.managedEventSizing&&(i.top=r.max(0,t.barMargin-(Ext.isIE&&!Ext.isStrict?0:t.eventBorderWidth-t.cellTopBorderWidth)),i.height=t.timeAxisViewModel.rowHeightHorizontal-2*t.barMargin-t.eventBorderWidth),i.start=u,i.end=f,i.startsOutsideView=u<s,i.endsOutsideView=f>h,i},getScheduleRegion:function(n,t){var i=this.view,r=n?Ext.fly(i.getRowNode(n)).getRegion():i.getTableRegion(),u=i.timeAxis.getStart(),f=i.timeAxis.getEnd(),e=i.getDateConstraints(n,t)||{start:u,end:f},o=this.translateToPageCoordinate(i.getXFromDate(Sch.util.Date.max(u,e.start))),s=this.translateToPageCoordinate(i.getXFromDate(Sch.util.Date.min(f,e.end))),h=r.top+i.barMargin,c=r.bottom-i.barMargin-i.eventBorderWidth;return new Ext.util.Region(h,Math.max(o,s),c,Math.min(o,s))},getResourceRegion:function(n,t,i){var r=this.view,f=r.getRowNode(n),e=Ext.fly(f).getOffsetsTo(r.getEl()),o=r.timeAxis.getStart(),s=r.timeAxis.getEnd(),v=t?Sch.util.Date.max(o,t):o,y=i?Sch.util.Date.min(s,i):s,h=r.getXFromDate(v),c=r.getXFromDate(y),l=e[1]+r.cellTopBorderWidth,a=e[1]+Ext.fly(f).getHeight()-r.cellBottomBorderWidth,u;return Ext.versions.touch||(u=r.getScroll(),l+=u.top,a+=u.top),new Ext.util.Region(l,Math.max(h,c),a,Math.min(h,c))},columnRenderer:function(n,t,i,r){var u=this.view,e=u.getEventStore().filterEventsForResource(i,function(n){return u.timeAxis.isRangeInAxis(n)}),f;if(e.length!==0){if(f=Ext.Array.map(e,function(n){return u.generateTplData(n,i,r)}),u.dynamicRowHeight){var s=u.eventLayout.horizontal,o=s.applyLayout(f,i,this.layoutEventVertically,this),h=o*u.timeAxisViewModel.rowHeightHorizontal-(o-1)*u.barMargin;t.rowHeight=h}return u.eventTpl.apply(f)}},layoutEventVertically:function(n){var t=this.view,i=n===0?t.barMargin:n*t.timeAxisViewModel.rowHeightHorizontal-(n-1)*t.barMargin;return i>=t.cellBottomBorderWidth&&(i-=t.cellBottomBorderWidth),i},resolveResource:function(n){var u=this,t=u.view,i,r;return i=Ext.fly(n).is(t.eventSelector)&&n||Ext.fly(n).up(t.eventSelector,null,!0),i?r=t.getResourceRecordFromDomId(i.id):(n=t.findRowByChild(n),r=n&&t.getRecordForRowNode(n)||null),r},getTimeSpanRegion:function(n,t,i){var u=this.view,f=u.getXFromDate(n),e=t?u.getXFromDate(t):f,o,r;return r=u.getTableRegion(),o=i?Math.max(r?r.bottom-r.top:0,u.getEl().dom.clientHeight):r?r.bottom-r.top:0,new Ext.util.Region(0,Math.max(f,e),o,Math.min(f,e))},getStartEndDatesFromRegion:function(n,t,i){var r=this.view,e=r.rtl,u=r.getDateFromCoordinate(e?n.right:n.left,t),f=r.getDateFromCoordinate(e?n.left:n.right,t);return u&&f||i&&(u||f)?{start:u,end:f}:null},onEventAdd:function(n,t){for(var u=this.view,c={},f,e,o,s,h,i,l,r=0,a=t.length;r<a;r++)if(f=t[r],e=f.getStartDate(),o=f.getEndDate(),e&&o&&u.timeAxis.timeSpanInAxis(e,o))for(s=t[r].getResources(u.getEventStore()),i=0,l=s.length;i<l;i++)h=s[i],c[h.getId()]=h;Ext.Object.each(c,function(n,t){u.repaintEventsForResource(t)})},onEventRemove:function(n,t){var f=this,i=f.view,e=i.getEventStore(),u,r;u=Ext.Array.unique(Ext.Array.flatten(Ext.Array.map(t,function(n){return e.getResourcesForEvent(n)})));r=Ext.Array.flatten(Ext.Array.map(t,function(n){return i.getElementsFromEventRecord(n,null,null,!0)}));r=new Ext.CompositeElementLite(r);r.fadeOut({callback:function(){Ext.Array.forEach(u,function(n){i&&!i.isDestroyed&&i.store.indexOf(n)>=0&&i.repaintEventsForResource(n)})}})},onEventUpdate:function(n,t){var i=t.previous||{},r=this.view,o=r.timeAxis,u=t.getStartDate(),f=t.getEndDate(),s=i.StartDate||u,h=i.EndDate||f,c=s&&h&&o.timeSpanInAxis(s,h),e;t.resourceIdField in i&&c&&(e=n.getResourceStore().getById(i[t.resourceIdField]),e&&r.repaintEventsForResource(e,!0));(u&&f&&o.timeSpanInAxis(u,f)||c)&&Ext.Array.each(t.getResources(),function(n){r.repaintEventsForResource(n,!0)})},setColumnWidth:function(n,t){var i=this.view;i.getTimeAxisViewModel().setViewColumnWidth(n,t)},getVisibleDateRange:function(){var n=this.view,i,t;if(!n.getEl())return null;var r=n.getTableRegion(),f=n.timeAxis.getStart(),e=n.timeAxis.getEnd(),u=n.getWidth();return r.right-r.left<u?{startDate:f,endDate:e}:(i=n.getScroll(),t={startDate:n.getDateFromCoordinate(i.left,null,!0),endDate:n.getDateFromCoordinate(i.left+u,null,!0)||n.timeAxis.getEnd()},t.endDate||(t.endDate=n.timeAxis.getEnd()),t)}});Ext.define("Sch.mixin.AbstractTimelineView",{selectedEventCls:"sch-event-selected",readOnly:!1,horizontalViewClass:"Sch.view.Horizontal",timeCellCls:"sch-timetd",timeCellSelector:".sch-timetd",eventBorderWidth:1,timeAxis:null,timeAxisViewModel:null,eventPrefix:null,rowHeight:null,orientation:"horizontal",mode:"horizontal",horizontal:null,vertical:null,secondaryCanvasEl:null,panel:null,displayDateFormat:null,el:null,constructor:function(n){n&&n.orientation&&(n.mode=this.mode=n.orientation);this.callParent([n])},_initializeTimelineView:function(){this.horizontalViewClass&&(this.horizontal=Ext.create(this.horizontalViewClass,{view:this}));this.verticalViewClass&&(this.vertical=Ext.create(this.verticalViewClass,{view:this}));this.calendarViewClass&&(this.calendar=Ext.create(this.calendarViewClass,{view:this}));this.eventPrefix=(this.eventPrefix||this.getId())+"-"},getTimeAxisViewModel:function(){return this.timeAxisViewModel},getFormattedDate:function(n){return Ext.Date.format(n,this.getDisplayDateFormat())},getFormattedEndDate:function(n,t){var i=this.getDisplayDateFormat();return n.getHours()!==0||n.getMinutes()!==0||t&&n.getYear()===t.getYear()&&n.getMonth()===t.getMonth()&&n.getDate()===t.getDate()||Sch.util.Date.hourInfoRe.test(i.replace(Sch.util.Date.stripEscapeRe,""))||(n=Sch.util.Date.add(n,Sch.util.Date.DAY,-1)),Ext.Date.format(n,i)},getDisplayDateFormat:function(){return this.displayDateFormat},setDisplayDateFormat:function(n){this.displayDateFormat=n},fitColumns:function(n){if(this.mode==="horizontal")this.getTimeAxisViewModel().fitToAvailableWidth(n);else{var t=Math.floor((this.panel.getWidth()-Ext.getScrollbarSize().width-1)/this.headerCt.getColumnCount());this.setColumnWidth(t,n)}},getElementFromEventRecord:function(n,t){var r=this,i;return i=r.getElementsFromEventRecord(n,t),i.length===0?i=null:i.length==1?i=i[0]:r.mode=="calendar"?i=i[0]:Ext.Error.raise("The method getElementFromEventRecord() is deprecated, it can't handle the situation when several DOM elements correspond to a single event record, please use getElementsFromEventRecord() method instead!"),i},getElementsFromEventRecord:function(n,t,i,r){var u=this,f;return r=r||!1,f=t&&i!==null&&i!==undefined?"[id^="+u.eventPrefix+n.internalId+"-"+t.internalId+"-"+i+"]":t?"[id^="+u.eventPrefix+n.internalId+"-"+t.internalId+"-]":"[id^="+u.eventPrefix+n.internalId+"-]",u.getEl().query(f,r)},getStartEndDatesFromRegion:function(n,t,i){return this[this.mode].getStartEndDatesFromRegion(n,t,i)},getTimeResolution:function(){return this.timeAxis.getResolution()},setTimeResolution:function(n,t){this.timeAxis.setResolution(n,t);this.getTimeAxisViewModel().snapToIncrement&&this.refreshKeepingScroll()},getEventIdFromDomNodeId:function(n){return n.substring(this.eventPrefix.length).split("-")[0]},getResourceIdFromDomNodeId:function(n){return n.substring(this.eventPrefix.length).split("-")[1]},getDateFromDomEvent:function(n,t){return this.getDateFromXY(n.getXY(),t)},getSnapPixelAmount:function(){return this.getTimeAxisViewModel().getSnapPixelAmount()},setSnapEnabled:function(n){this.getTimeAxisViewModel().setSnapToIncrement(n)},setReadOnly:function(n){this.readOnly=n;this[n?"addCls":"removeCls"](this._cmpCls+"-readonly")},isReadOnly:function(){return this.readOnly},setOrientation:function(){this.setMode.apply(this,arguments)},setMode:function(n){this.mode=n;this.timeAxisViewModel.mode=n},getOrientation:function(){return this.getMode.apply(this,arguments)},getMode:function(){return this.mode},isHorizontal:function(){return this.getMode()==="horizontal"},isVertical:function(){return!this.isHorizontal()},getDateFromXY:function(n,t,i){return this[this.mode].getDateFromXY(n,t,i)},getDateFromCoordinate:function(n,t,i){return i||(n=this[this.mode].translateToScheduleCoordinate(n)),this.timeAxisViewModel.getDateFromPosition(n,t)},getDateFromX:function(n,t){return this.getDateFromCoordinate(n,t)},getDateFromY:function(n,t){return this.getDateFromCoordinate(n,t)},getCoordinateFromDate:function(n,t){var i=this.timeAxisViewModel.getPositionFromDate(n);return t===!1&&(i=this[this.mode].translateToPageCoordinate(i)),Math.round(i)},getXFromDate:function(n,t){return this.getCoordinateFromDate(n,t)},getYFromDate:function(n,t){return this.getCoordinateFromDate(n,t)},getTimeSpanDistance:function(n,t){return this.timeAxisViewModel.getDistanceBetweenDates(n,t)},getTimeSpanRegion:function(n,t){return this[this.mode].getTimeSpanRegion(n,t)},getScheduleRegion:function(n,t){return this[this.mode].getScheduleRegion(n,t)},getTableRegion:function(){throw"Abstract method call";},getRowNode:function(){throw"Abstract method call";},getRecordForRowNode:function(){throw"Abstract method call";},getVisibleDateRange:function(){return this[this.mode].getVisibleDateRange()},setColumnWidth:function(n,t){this[this.mode].setColumnWidth(n,t)},findRowByChild:function(){throw"Abstract method call";},setBarMargin:function(n,t){this.barMargin=n;t||this.refreshKeepingScroll()},getRowHeight:function(){return this.timeAxisViewModel.getViewRowHeight()},setRowHeight:function(n,t){this.timeAxisViewModel.setViewRowHeight(n,t)},refreshKeepingScroll:function(){throw"Abstract method call";},scrollVerticallyTo:function(){throw"Abstract method call";},scrollHorizontallyTo:function(){throw"Abstract method call";},getVerticalScroll:function(){throw"Abstract method call";},getHorizontalScroll:function(){throw"Abstract method call";},getEl:Ext.emptyFn,getSecondaryCanvasEl:function(){if(!this.rendered)throw"Calling this method too early";return this.secondaryCanvasEl||(this.secondaryCanvasEl=(this.scrollerEl||this.getEl()).createChild({cls:"sch-secondary-canvas"})),this.secondaryCanvasEl},getScroll:function(){throw"Abstract method call";},getOuterEl:function(){return this.getEl()},getRowContainerEl:function(){return this.getEl()},getScheduleCell:function(n,t){return this.getCellByPosition({row:n,column:t})},getScrollEventSource:function(){return this.getEl()},getViewportHeight:function(){return this.getEl().getHeight()},getViewportWidth:function(){return this.getEl().getWidth()},getViewportCenterDate:function(){var n=this.getScroll(),t;return t=this.getMode()==="vertical"?[0,n.top+this.getViewportHeight()/2]:[n.left+this.getViewportWidth()/2,0],this.getDateFromXY(t,null,!0)},getDateConstraints:Ext.emptyFn});Ext.apply(Sch,{VERSION:"4.1.2"});Ext.define("Sch.mixin.FilterableTreeView",{prevBlockRefresh:null,initTreeFiltering:function(){var n=function(){var n=this.store;this.mon(n,"nodestore-datachange-start",this.onFilterChangeStart,this);this.mon(n,"nodestore-datachange-end",this.onFilterChangeEnd,this);n.allowExpandCollapseWhileFiltered||(this.mon(n,"filter-clear",this.onFilterCleared,this),this.mon(n,"filter-set",this.onFilterSet,this))};if(this.rendered)n.call(this);else this.on("beforerender",n,this,{single:!0})},onFilterChangeStart:function(){this.prevBlockRefresh=this.blockRefresh;this.blockRefresh=!0;Ext.suspendLayouts()},onFilterChangeEnd:function(){Ext.resumeLayouts(!0);this.blockRefresh=this.prevBlockRefresh},onFilterCleared:function(){delete this.toggle;var n=this.getEl();n&&n.removeCls("sch-tree-filtered")},onFilterSet:function(){this.toggle=function(){};var n=this.getEl();n&&n.addCls("sch-tree-filtered")}});Ext.define("Sch.mixin.PartnerTimelinePanel",{extend:Ext.Mixin,setupPartnerTimelinePanel:function(){var n=this.partnerTimelinePanel,i=n.lockedGrid,t=this.lockedGrid,r;i.mon(t,"resize",this.onLockedGridResize,i);t.mon(i,"resize",this.onLockedGridResize,t);r=n.isVisible()?n.lockedGrid.getWidth():n.lockedGrid.width;i.getCollapsed()?this.mon(i,"viewready",function(n){t.setWidth(n.getWidth())}):t.setWidth(r);this.on("afterlayout",function(){i.getCollapsed()?t.collapse():(t.expand(),t.setWidth(r))},this,{single:!0});i.on({collapse:this.onPartnerCollapseExpand,expand:this.onPartnerCollapseExpand,scope:this});t.on({collapse:this.onPartnerCollapseExpand,expand:this.onPartnerCollapseExpand,scope:n});this.setupScrollSync();n.mon(this,"beforezoomchange",this.onBeforeZoomChange,this);n.mon(this,"viewchange",this.onViewChange,this);this.mon(n,"beforezoomchange",this.onBeforeZoomChange,this);this.mon(n,"viewchange",this.onViewChange,this)},onLockedGridResize:function(n,t){this.setWidth(t)},onPartnerCollapseExpand:function(n){n.getCollapsed()?this.lockedGrid.collapse():this.lockedGrid.expand()},setupScrollSync:function(){var r=this.partnerTimelinePanel.getSchedulingView(),i=r.getScrollable(),u=this.getSchedulingView(),n=u.getScrollable(),t,e=Ext.Function.createBuffered(function(){t=null},300),f=function(r,u){var o=r===n?n:i,f=r===n?i:n;t||(t=o);e();f!==t&&f.scrollTo(u)};r.mon(n,"scroll",f);u.mon(i,"scroll",f)},onViewChange:function(){this.partnerTimelinePanel.viewPreset=this.viewPreset},onBeforeZoomChange:function(){var i=this.partnerTimelinePanel,t=i.getSchedulingView(),n=t.getScrollable(),r=n.suspendPartnerSync;n.suspendPartnerSync=Ext.emptyFn;n.on("scrollend",function(){n.suspendPartnerSync=r},t,{single:!0})}});Ext.define("Sch.patches.Collection",{extend:Sch.util.Patch,target:"Ext.util.Collection",minVersion:"5.1.0",overrides:{updateKey:function(n,t){var i=this,r=i.map,f=i.indices,e=i.getSource(),u;e&&!e.updating?e.updateKey(n,t):r[t]&&(u=i.getKey(n))!==t&&(t in r||r[u]!==n)&&(t in r&&(r[t]!==n&&Ext.Error.raise('Incorrect oldKey "'+t+'" for item with newKey "'+u+'"'),delete r[t]),i.updating++,i.generation++,r[u]=n,f&&(f[u]=f[t],delete f[t]),i.notify("updatekey",[{item:n,newKey:u,oldKey:t}]),i.updating--)}}});Ext.define("Sch.patches.TouchScroll",{extend:Sch.util.Patch,target:"Ext.scroll.TouchScroller",minVersion:"5.1.0",overrides:{privates:{onEvent:function(n){var t=this;if(t[t.listenerMap[n.type]])return this.callParent(arguments)}}}});Ext.define("Sch.patches.PartnerScroll",{extend:Sch.util.Patch,minVersion:"5.1.0",maxVersion:"5.1.1",applyFn:function(){(Ext.isMac||Ext.isGecko)&&Ext.ClassManager.get("Ext.scroll.Scroller").override({constructor:function(n){var t=this;t.callParent([n]);this.doNotCall={}},privates:{onPartnerScrollEnd:function(){this.doNotCall={}},invokePartners:function(n,t,i){var u=this._partners,r,f;if(!this.suspendSync)for(f in u)r=u[f],r.suspendSync||this.doNotCall[r.scroller.id]?r.scroller.component.isTableView||delete this.doNotCall[r.scroller.id]:r.scroller[n](this,t,i)},onPartnerScroll:function(n,t,i){var r=n._partners[this.getId()].axis;r&&(r==="x"?i=null:r==="y"&&(t=null));this.doNotCall[n.id]=!0;this.doScrollTo(t,i,null,!1)}}})}});Ext.define("Sch.patches.View",{extend:Sch.util.Patch,target:"Ext.view.View",minVersion:"5.1.0",overrides:{handleEvent:function(n){var t=this,r=t.keyEventRe.test(n.type),u=t.getNavigationModel(),i;n.view=t;r&&(n.item=n.getTarget(t.itemSelector),n.record=u.getRecord(n.item));n.item||(i=t.editingPlugin&&t.editingPlugin.getActiveEditor&&t.editingPlugin.getActiveEditor(),i&&i.getEl().contains(n.getTarget())||(n.item=n.getTarget(t.itemSelector)));n.item&&!n.record&&(n.record=t.getRecord(n.item));t.processUIEvent(n)!==!1&&t.processSpecialEvent(n);r&&!Ext.fly(n.target).isInputField()&&(n.getKey()===n.SPACE||n.isNavKeyPress(!0))&&n.preventDefault();n.view=null}}});Ext.define("Sch.patches.ToolTip",{extend:Sch.util.Patch,target:"Ext.tip.ToolTip",minVersion:"5.1.0",overrides:{setTarget:function(n){var t=this,i=Ext.get(n),r;t.target&&(r=Ext.get(t.target),t.mun(r,{mouseover:t.onTargetOver,tap:t.onTargetOver,mouseout:t.onTargetOut,mousemove:t.onMouseMove,scope:t}));t.target=i;i&&t.mon(i,{mouseover:t.onTargetOver,tap:t.onTargetOver,mouseout:t.onTargetOut,mousemove:t.onMouseMove,scope:t});t.anchor&&(t.anchorTarget=t.target)}}});Ext.define("Sch.mixin.TimelineView",{extend:Sch.mixin.AbstractTimelineView,tip:null,overScheduledEventClass:"sch-event-hover",ScheduleBarEvents:["mousedown","mouseup","click","dblclick","longpress","contextmenu"],ResourceRowEvents:["keydown","keyup"],preventOverCls:!1,hoveredEventNode:null,_initializeTimelineView:function(){this.callParent(arguments);this.on("destroy",this._onDestroy,this);this.on("afterrender",this._onAfterRender,this);this.panel.on("viewready",this._onViewReady,this);this.setMode(this.mode);this.enableBubble("columnwidthchange");this.addCls("sch-timelineview");this.readOnly&&this.addCls(this._cmpCls+"-readonly");this.addCls(this._cmpCls);this.eventAnimations&&this.addCls("sch-animations-enabled")},handleScheduleBarEvent:function(n,t){this.fireEvent(this.scheduledEventName+n.type,this,this.resolveEventRecord(t),n)},handleResourceRowEvent:function(n,t){this.fireEvent(this.scheduledEventName+n.type,this,this.resolveEventRecordFromResourceRow(t),n)},_onDestroy:function(){this.tip&&this.tip.destroy()},_onViewReady:function(){this.touchScroll&&this.getSecondaryCanvasEl().insertBefore(this.getNodeContainer())},_onAfterRender:function(){var n,r,u,t,i;if(this.overScheduledEventClass&&this.setMouseOverEnabled(!0),this.tooltipTpl){typeof this.tooltipTpl=="string"&&(this.tooltipTpl=new Ext.XTemplate(this.tooltipTpl));this.el.on("mousemove",this.setupTooltip,this,{single:!0})}n=this.bufferedRenderer;n&&(this.patchBufferedRenderingPlugin(n),this.patchBufferedRenderingPlugin(this.lockingPartner.bufferedRenderer));this.on("bufferedrefresh",this.onBufferedRefresh,this,{buffer:10});this.setupTimeCellEvents();r=this.getSecondaryCanvasEl();r.getStyle("position").toLowerCase()!=="absolute"&&(u=Ext.Msg||window,u.alert("ERROR: The CSS file for the Bryntum component has not been loaded."));t={delegate:this.eventSelector,scope:this};i={delegate:this.rowSelector,scope:this};Ext.Array.each(this.ScheduleBarEvents,function(n){t[n]=this.handleScheduleBarEvent},this);Ext.Array.each(this.ResourceRowEvents,function(n){i[n]=this.handleResourceRowEvent},this);this.el.on(t);this.el.on(i)},patchBufferedRenderingPlugin:function(n){var t=this,i=n.setBodyTop;n.setBodyTop=function(){var n=i.apply(this,arguments);return t.fireEvent("bufferedrefresh",this),n}},onBufferedRefresh:function(){var i=this.body.dom,n,t,r;i&&(n=i.style,Ext.isIE9m?this.getSecondaryCanvasEl().dom.style.top=this.body.dom.style.top:(t=n.transform||n.msTransform||n.webkitTransform,t&&(r=/\(-?\d+px,\s*(-?\d+px),\s*(-?\d+)px\)/.exec(t)),r&&(this.getSecondaryCanvasEl().dom.style.top=t?r[1]:i.style.top)))},setMouseOverEnabled:function(n){this[n?"mon":"mun"](this.el,{mouseover:this.onEventMouseOver,mouseout:this.onEventMouseOut,delegate:this.eventSelector,scope:this})},onEventMouseOver:function(n,t){if(t!==this.hoveredEventNode&&!this.preventOverCls){this.hoveredEventNode=t;Ext.fly(t).addCls(this.overScheduledEventClass);var i=this.resolveEventRecord(t);i&&this.fireEvent("eventmouseenter",this,i,n)}},onEventMouseOut:function(n){this.hoveredEventNode&&(n.within(this.hoveredEventNode,!0,!0)||(Ext.fly(this.hoveredEventNode).removeCls(this.overScheduledEventClass),this.fireEvent("eventmouseleave",this,this.resolveEventRecord(this.hoveredEventNode),n),this.hoveredEventNode=null))},highlightItem:function(n){if(n){var t=this;t.clearHighlight();t.highlightedItem=n;Ext.fly(n).addCls(t.overItemCls)}},setupTooltip:function(){var n=this,t=Ext.apply({delegate:n.eventSelector,target:n.el,anchor:"b",rtl:n.rtl,show:function(){if(Ext.ToolTip.prototype.show.apply(this,arguments),this.triggerElement&&n.getMode()==="horizontal"){var t=Ext.fly(this.triggerElement).getBox(),r=Ext.dom.Element.getViewportWidth(),u=Math.min(Math.max(this.targetXY[0]-10,0),r-this.getWidth()-10),i=t.top-this.getHeight()-10;this.setY(i<0?t.bottom+10:i);this.setX(u)}}},n.tipCfg);n.tip=new Ext.ToolTip(t);n.tip.on({beforeshow:function(n){var t,i,r;if(!n.triggerElement||!n.triggerElement.id||Ext.ComponentQuery.query("window[modal=true]{isVisible()}").length>0||(t=this.resolveEventRecord(n.triggerElement),!t||this.fireEvent("beforetooltipshow",this,t)===!1)||(i=this.getDataForTooltipTpl(t,n.triggerElement),!i)||(r=this.tooltipTpl.apply(i),!r))return!1;n.update(r)},scope:this});Ext.supports.Touch&&n.el.un({touchmove:n.setupTooltip,mousemove:n.setupTooltip,scope:n})},getHorizontalTimeAxisColumn:function(){if(!this.timeAxisColumn&&(this.timeAxisColumn=this.headerCt.down("timeaxiscolumn"),this.timeAxisColumn))this.timeAxisColumn.on("destroy",function(){this.timeAxisColumn=null},this);return this.timeAxisColumn},getDataForTooltipTpl:function(n){return Ext.apply({_record:n},n.data)},refreshKeepingScroll:function(){Ext.suspendLayouts();this.saveScrollState();this.refreshView();Ext.resumeLayouts(!0);(this.scrollState.left!==0||this.scrollState.top!==0||this.infiniteScroll)&&this.restoreScrollState()},setupTimeCellEvents:function(){this.mon(this.el,{click:this.handleScheduleEvent,dblclick:this.handleScheduleEvent,contextmenu:this.handleScheduleEvent,pinch:this.handleScheduleEvent,pinchstart:this.handleScheduleEvent,pinchend:this.handleScheduleEvent,scope:this})},getTableRegion:function(){var n=this.el.down("."+Ext.baseCSSPrefix+"grid-item-container");return(n||this.el).getRegion()},getRowNode:function(n){return this.getNodeByRecord(n)},findRowByChild:function(n){return this.findItemByChild(n)},getRecordForRowNode:function(n){return this.getRecord(n)},refreshKeepingResourceScroll:function(){var n=this.getScroll();this.refreshView();this.getMode()==="horizontal"?this.scrollVerticallyTo(n.top):this.scrollHorizontallyTo(n.left)},scrollHorizontallyTo:function(n,t){this.scrollTo(n,null,t)},scrollVerticallyTo:function(n,t){this.scrollTo(null,n,t)},getVerticalScroll:function(){return this.getScrollY()},getHorizontalScroll:function(){return this.getScrollX()},getScroll:function(){var n=this;return{top:n.getScrollY(),left:n.getScrollX()}},handleScheduleEvent:function(){},scrollElementIntoView:function(n,t,i,r,u,f,e){var s=this,o=n.dom,h=Ext.getDom(s.getEl()),w=n.getOffsetsTo(h),c=s.getScroll(),v=w[0]+c.left,y=w[1]+c.top,b=y+o.offsetHeight,k=v+o.offsetWidth,p=h.clientHeight,d=parseInt(c.top,10),g=parseInt(c.left,10),nt=d+p,tt=g+h.clientWidth,l,a;u=u===null||u===undefined?20:u;o.offsetHeight>p||y<d?a=y-u:b>nt&&(a=b-p+u);t!==!1&&o.offsetWidth>h.clientWidth||v<g?l=v-u:t!==!1&&k>tt&&(l=k-h.clientWidth+u);i=i===!0&&{}||i;r=r===!0&&{}||r;e=e||s;i&&r?i.listeners=Ext.apply(i.listeners||{},{afteranimate:function(){r.listeners=Ext.apply(r.listeners||{},{afteranimate:function(){f&&f.call(e);f=null}});Ext.fly(o).highlight(null,r)}}):i?i.listeners=Ext.apply(i.listeners,{afteranimate:function(){f&&f.call(e);f=null}}):r&&(r.listeners=Ext.apply(r.listeners||{},{afteranimate:function(){f&&f.call(e);f=null}}));a!==undefined&&s.setScrollY(a,i);l!==undefined&&s.setScrollX(l,i);!i&&r&&Ext.fly(o).highlight(null,r);i||r||!f||f.call(e)},disableViewScroller:function(n){var t=this.getScrollable();t&&t.setDisabled(n)}});Ext.define("Sch.view.TimelineGridView",{extend:Ext.grid.View,mixins:[Sch.mixin.TimelineView],infiniteScroll:!1,bufferCoef:5,bufferThreshold:.2,cachedScrollLeftDate:null,boxIsReady:!1,ignoreNextHorizontalScroll:!1,constructor:function(){if(this.callParent(arguments),this.infiniteScroll)this.on("boxready",this.setupInfiniteScroll,this);this.timeAxisViewModel&&this.relayEvents(this.timeAxisViewModel,["columnwidthchange"])},setupInfiniteScroll:function(){var i=this.panel.ownerCt,n,t,r;this.cachedScrollLeftDate=i.startDate||this.timeAxis.getStart();Ext.getVersion().isLessThan("6.0.1")&&Ext.supports.Touch&&Ext.os.is.Windows&&(n=this.panel.headerCt.getScrollable(),t=this.getScrollable(),n.onIdle&&Ext.GlobalEvents.un("idle",n.onIdle,n),t.onIdle&&Ext.GlobalEvents.un("idle",t.onIdle,t));r=this;i.calculateOptimalDateRange=function(n,t,i,u){if(u)return u;var f=Sch.preset.Manager.getPreset(i.preset);return r.calculateInfiniteScrollingDateRange(n,f.getBottomHeader().unit,i.increment,i.width)};this.bindInfiniteScrollListeners()},bindInfiniteScrollListeners:function(){this.getScrollable().on("scroll",this.onHorizontalScroll,this)},unbindInfiniteScrollListeners:function(){this.getScrollable().un("scroll",this.onHorizontalScroll,this);this.infiniteScroll=!1},onHorizontalScroll:function(n,t){if(this.ignoreNextHorizontalScroll||this.cachedScrollLeftDate){this.ignoreNextHorizontalScroll=!1;return}var u=Ext.getScrollbarSize(),i=this.getWidth(),f=this.getScrollable().getMaxPosition().x+i-u.width,r=i*this.bufferThreshold*this.bufferCoef;(f-t-i<r||t<r)&&(this.shiftToDate(this.getDateFromCoordinate(t,null,!0)),this.el.stopAnimation())},refresh:function(){this.callParent(arguments);this.infiniteScroll&&!this.scrollStateSaved&&this.boxIsReady&&this.restoreScrollLeftDate()},onResize:function(n,t,i){this.boxIsReady=!0;this.callParent(arguments);this.infiniteScroll&&n!==i&&this.shiftToDate(this.cachedScrollLeftDate||this.getVisibleDateRange().startDate,this.cachedScrollCentered)},restoreScrollLeftDate:function(){this.cachedScrollLeftDate&&this.boxIsReady&&(this.ignoreNextHorizontalScroll=!0,this.scrollToDate(this.cachedScrollLeftDate),this.cachedScrollLeftDate=null)},scrollToDate:function(n){this.cachedScrollLeftDate=n;this.cachedScrollCentered?this.panel.ownerCt.scrollToDateCentered(n):this.panel.ownerCt.scrollToDate(n);var t=this.getScrollX();this.panel.scrollLeftPos=t;this.headerCt.setScrollX(t)},saveScrollState:function(){this.scrollStateSaved=this.boxIsReady;this.callParent(arguments)},restoreScrollState:function(){if(this.scrollStateSaved=!1,this.infiniteScroll&&this.cachedScrollLeftDate){this.restoreScrollLeftDate();this.setScrollY(this.scrollState.top);return}this.callParent(arguments)},calculateInfiniteScrollingDateRange:function(n,t,i,r){var u=this.timeAxis,o=this.getWidth(),f,e;return r=r||this.timeAxisViewModel.getTickWidth(),i=i||u.increment||1,t=t||u.unit,f=Sch.util.Date,e=Math.ceil(o*this.bufferCoef/r),{start:u.floorDate(f.add(n,t,-e*i),!1,t,i),end:u.ceilDate(f.add(n,t,Math.ceil((o/r+e)*i)),!1,t,i)}},shiftToDate:function(n,t){var i=this.calculateInfiniteScrollingDateRange(n);this.cachedScrollLeftDate=n;this.cachedScrollCentered=t;this.timeAxis.setTimeSpan(i.start,i.end)},destroy:function(){this.infiniteScroll&&this.rendered&&this.unbindInfiniteScrollListeners();this.callParent(arguments)}});Ext.define("Sch.patches.DragDropManager",{extend:Sch.util.Patch,minVersion:"6.0.0",applyFn:function(){Ext.override(Ext.dd.DragDropManager,{fireEvents:function(n,t){var f=this,k=Ext.supports.Touch,u=f.dragCurrent,a=f.currentPoint,tt=a.x,it=a.y,c=[],d=[],o=[],h=[],s=[],l=[],g=k?document.documentElement.clientWidth/window.innerWidth:1,p,r,w,nt,i,e,v,y,b;if(u&&!u.isLocked()){y=!(u.deltaX<0||u.deltaY<0);(k||!f.notifyOccluded&&(!Ext.supports.CSSPointerEvents||Ext.isIE10m||Ext.isOpera)&&y)&&(p=u.getDragEl(),y&&(p.style.visibility="hidden"),b=Ext.getBody().getScroll(),n.target=document.elementFromPoint(tt-b.left/g,it-b.top/g),y&&(p.style.visibility="visible"));for(i in f.dragOvers)(r=f.dragOvers[i],delete f.dragOvers[i],f.isTypeOfDD(r)&&!r.destroyed)&&(f.notifyOccluded?this.isOverTarget(a,r,f.mode)||o.push(r):n.within(r.getEl())||o.push(r),d[i]=!0);for(v in u.groups)if("string"==typeof v)for(i in f.ids[v])if(r=f.ids[v][i],f.isTypeOfDD(r)&&(w=r.getEl())&&r.isTarget&&!r.isLocked()&&Ext.fly(w).isVisible(!0)&&(r!==u||u.ignoreSelf===!1))if(f.notifyOccluded)(r.zIndex=f.getZIndex(w))!==-1&&(nt=!0),c.push(r);else if(n.within(r.getEl())){c.push(r);break}for(nt&&Ext.Array.sort(c,f.byZIndex),i=0,e=c.length;i<e;i++)if(r=c[i],f.isOverTarget(a,r,f.mode)&&(t?s.push(r):(d[r.id]?h.push(r):l.push(r),f.dragOvers[r.id]=r),!f.notifyOccluded))break;if(f.mode){if(o.length){u.b4DragOut(n,o);u.onDragOut(n,o)}if(l.length)u.onDragEnter(n,l);if(h.length){u.b4DragOver(n,h);u.onDragOver(n,h)}if(s.length){u.b4DragDrop(n,s);u.onDragDrop(n,s)}}else{for(i=0,e=o.length;i<e;++i){u.b4DragOut(n,o[i].id);u.onDragOut(n,o[i].id)}for(i=0,e=l.length;i<e;++i)u.onDragEnter(n,l[i].id);for(i=0,e=h.length;i<e;++i){u.b4DragOver(n,h[i].id);u.onDragOver(n,h[i].id)}for(i=0,e=s.length;i<e;++i){u.b4DragDrop(n,s[i].id);u.onDragDrop(n,s[i].id)}}if(t&&!s.length)u.onInvalidDrop(n)}}});var n=Ext.dd.ScrollManager,t=Ext.dd.DragDropManager;t.fireEvents=Ext.Function.createSequence(t.fireEvents,n.onFire,n);t.stopDrag=Ext.Function.createSequence(t.stopDrag,n.onStop,n)}});Ext.define("Sch.patches.NavigationModel",{extend:Sch.util.Patch,target:"Ext.grid.NavigationModel",minVersion:"6.0.0",overrides:{setPosition:function(n,t,i){var r=this,u,f;if(Ext.isIE&&i&&(i.getKey()===i.PAGE_DOWN||i.getKey()===i.PAGE_UP)&&(u=r.lastFocused,i.view.isLockedView&&u&&i.view.getVisibleColumnManager().indexOf(u.column)===-1&&(i.view=i.view.lockingPartner)),f=Ext.getVersion(),f.isLessThan("6.0.1")||f.isGreaterThan("6.0.2"))return r.callParent(arguments);r.patchedSetPosition.apply(this,arguments)},patchedSetPosition:function(n,t,i,r,u){var f=this,e,p,y,h,a,s,c,o,l,v=n==null&&t==null,b=f.record==null&&f.recordIndex==null&&f.item==null,w;if(e=n&&n.isCellContext?n.view:i&&i.view?i.view:f.lastFocused?f.lastFocused.view:f.view,e.getFocusTask().cancel(),!e.destroyed&&e.refreshCounter&&e.ownerCt&&(!v||!b)&&e.all.getCount()){if(y=e.getSelectionModel(),h=e.dataSource,a=e.getVisibleColumnManager(),n&&n.isCellContext)o=n.record,s=n.rowIdx,c=Math.min(n.colIdx,a.getColumns().length-1),l=a.getColumns()[c],h.indexOf(o)===-1&&(p=e.getScrollable(),f.recordIndex=-1,p.getPosition().y>=p.getMaxPosition().y-e.all.last(!0).offsetHeight&&n.rowIdx--,s=Math.min(n.rowIdx,h.getCount()-1),o=h.getAt(s));else{if(v)o=s=null;else if(t==null&&(t=f.lastFocused?f.lastFocused.column:0),typeof n=="number")s=Math.max(Math.min(n,h.getCount()-1),0),o=h.getAt(n);else if(n.isEntity)o=n,s=h.indexOf(o);else if(n.tagName)o=e.getRecord(n),s=h.indexOf(o),s===-1&&(o=null);else{if(b)return;v=!0;o=s=null}o?(s===-1&&(f.recordIndex=-1,o=h.getAt(0),s=0,t=null),t==null?(l=f.column)||(c=0,l=a.getColumns()[0]):typeof t=="number"?(l=a.getColumns()[t],c=t):(l=t,c=a.indexOf(t))):(v=!0,l=c=null)}if(e.actionableMode&&!v)return w=new Ext.grid.CellContext(e).setPosition(o,l),f.focusPosition(w),e.ownerGrid.setActionableMode(!1,w);if(s===f.recordIndex&&c===f.columnIndex&&e===f.position.view)return f.focusPosition(f.position);f.cell&&f.cell.removeCls(f.focusCls);f.previousRecordIndex=f.recordIndex;f.previousRecord=f.record;f.previousItem=f.item;f.previousCell=f.cell;f.previousColumn=f.column;f.previousColumnIndex=f.columnIndex;f.previousPosition=f.position.clone();f.selectionStart=y.selectionStart;f.position.setAll(e,f.recordIndex=s,f.columnIndex=c,f.record=o,f.column=l);v?f.item=f.cell=null:f.focusPosition(f.position,u);r||(y.fireEvent("focuschange",y,f.previousRecord,f.record),e.fireEvent("rowfocus",f.record,f.item,f.recordIndex),e.fireEvent("cellfocus",f.record,f.cell,f.position));i&&!u&&f.cell!==f.previousCell&&f.fireNavigateEvent(i)}}}});Ext.define("Sch.view.Calendar",{view:null,constructor:function(n){Ext.apply(this,n)},getColumnsBy:function(n,t){for(var r=this.view.panel.headerCt.getGridColumns(),u=[],i=0;i<r.length;i++)n.call(this,r[i])&&(t!==!0?u.push(r[i]):u.push({column:r[i],index:i}));return u},getColumnsForDateRange:function(n,t){return this.getColumnsBy(function(t){return!(n.getEndDate()<=t.start||n.getStartDate()>=t.end)},t)},getColumnEvents:function(n){var t=[];return this.view.getEventStore().each(function(i){i.getEndDate()<=n.start||i.getStartDate()>=n.end||t.push(i)}),t},getColumnsByResource:function(n,t){return this.getColumnsBy(function(t){return t.start==n.start},t)[0]},translateToScheduleCoordinate:function(n){var t=this.view;return Ext.isArray(n)?[n[0]-t.getEl().getX()+t.getScroll().left,n[1]-t.getEl().getY()+t.getScroll().top]:n-t.getEl().getY()+t.getScroll().top},translateToPageCoordinate:function(n){var r=this.view,t=r.getEl(),i=r.getScroll();return Ext.isArray(n)?[n[0]+t.getX()-i.left,n[1]+t.getY()-i.top]:n+t.getY()-i.top},getDateFromXY:function(n,t,i){var r=n;return i||(r=this.translateToScheduleCoordinate(r)),this.view.timeAxisViewModel.getDateFromPosition(r,t)},getEventRenderData:function(n,t,i){var o=n.getStartDate(),s=n.getEndDate(),r=this.view,h=r.panel.headerCt.getGridColumns(),c=h[i].start,l=h[i].end,f=Math,a=Math.floor(r.getCoordinateFromDate(Sch.util.Date.max(o,c))),e=Math.floor(r.timeAxisViewModel.getPositionFromDate(Sch.util.Date.min(s,l),!0)),v=this.getCalendarColumnWidth(),u;return e===0&&(e=r.getStore().getCount()*r.getRowHeight()),u={top:f.max(0,f.min(a,e)-r.eventBorderWidth),height:f.max(1,f.abs(a-e))},u.start=o,u.end=s,u.startsOutsideView=o<c,u.endsOutsideView=s>l,u},getScheduleRegion:function(n){var t=this.view,i=n?this.getColumnsByResource(n).getRegion():t.getTableRegion(),r=this.translateToPageCoordinate(0),u=this.translateToPageCoordinate(t.getStore().getCount()*t.getRowHeight()),f=i.left+t.barMargin,e=i.right-t.barMargin;return new Ext.util.Region(Math.min(r,u),e,Math.max(r,u),f)},getCalendarColumnWidth:function(){return this.view.timeAxisViewModel.calendarColumnWidth},getResourceRegion:function(n,t,i){var r=this.view,u=r.getResourceStore().indexOf(n)*this.getCalendarColumnWidth(),f=r.timeAxis.getStart(),e=r.timeAxis.getEnd(),h=t?Sch.util.Date.max(f,t):f,c=i?Sch.util.Date.min(e,i):e,o=Math.max(0,r.getCoordinateFromDate(h)-r.cellTopBorderWidth),s=r.getCoordinateFromDate(c)-r.cellTopBorderWidth,l=u+r.cellBorderWidth,a=u+this.getCalendarColumnWidth()-r.cellBorderWidth;return new Ext.util.Region(Math.min(o,s),a,Math.max(o,s),l)},columnRenderer:function(n,t,i,r,u){var f=this.view,c="",e,s,o,l,h;if(r===0){for(e=[],s=this.getColumnEvents(t.column),o=0,l=s.length;o<l;o++)h=s[o],e.push(f.generateTplData(h,h.getResources()[0]||i,u));t.column.rendered&&this.getCalendarColumnWidth()!==t.column.getWidth()&&this.setColumnWidth(t.column.getWidth(),!0);f.eventLayout.vertical.applyLayout(e,this.getCalendarColumnWidth()-2*f.barMargin-f.cellBorderWidth);c="&#160;"+f.eventTpl.apply(e)}return u%2==1&&(t.tdCls=(t.tdCls||"")+" "+f.altColCls,t.cellCls=(t.cellCls||"")+" "+f.altColCls),c},resolveResource:function(n){var r=this.view,t,i,u;if(n=Ext.fly(n).is(r.timeCellSelector)?n:Ext.fly(n).up(r.timeCellSelector),n){if(t=n.dom?n.dom:n,i=0,Ext.isIE8m)for(t=t.previousSibling;t;)t.nodeType===1&&i++,t=t.previousSibling;else i=Ext.Array.indexOf(Array.prototype.slice.call(t.parentNode.children),t);if(i>=0)return u=r.panel.headerCt.getGridColumns()[i],{start:u.start,end:u.end}}},onEventUpdate:function(n,t){this.renderSingle(t);var i=this.view,r=i.getEventSelectionModel();r.forEachEventRelatedSelection(t,function(n){i.onEventBarSelect(n)})},onEventAdd:function(n,t){var i=this.view;t.length===1?this.renderSingle(t[0]):i.repaintAllEvents()},onEventRemove:function(n,t){var i=this.view;t.length===1?(Ext.Array.each(i.getElementsFromEventRecord(t[0]),function(n){Ext.fly(n).destroy()}),this.relayoutRenderedEvents(t[0])):i.repaintAllEvents()},relayoutRenderedEvents:function(n){var t=this,i=t.getColumnsForDateRange(n,!0);Ext.Array.each(i,function(n){t.repaintEventsForColumn(n.column,n.index)})},renderSingle:function(n){var t=this.view;Ext.Array.each(t.getElementsFromEventRecord(n),function(n){Ext.fly(n).destroy()});var u=n.getResources()[0]||t.getResourceStore().first(),i=n.previous||{},r=Sch.util.Date,f=new Sch.model.Range({StartDate:r.min(i.StartDate||n.getStartDate(),n.getStartDate()),EndDate:r.max(i.EndDate||n.getEndDate(),n.getEndDate())}),e=this.getColumnsForDateRange(f);Ext.Array.each(e,function(i){var r=i.getIndex(),e=this.getColumnEvents(i),f=Ext.Array.map(e,function(f){return f===n?t.generateTplData(n,u,r):{start:f.getStartDate()<i.start?i.start:f.getStartDate(),end:f.getEndDate()>i.end?i.end:f.getEndDate(),event:f}});t.eventLayout.vertical.applyLayout(f,i.getWidth()-2*t.barMargin-t.cellBorderWidth);Ext.Array.each(f,function(i){var u,f;i.event===n?(u=t.getScheduleCell(0,r),u&&(Ext.versions.touch||(u=Ext.fly(u).first()),t.eventTpl.append(u,[i]))):(f=t.getElementsFromEventRecord(i.event,i.event.getResource(),r)[0],f.setStyle({left:i.left+"px",width:Math.max(i.width,0)+"px"}))})},this)},repaintEventsForColumn:function(n,t){for(var c=this,l=c.getColumnEvents(n),f=c.view,e=[],i,u,o,s,h,a,r=0,v=l.length;r<v;r++){if(i=l[r],u=f.getElementsFromEventRecord(i)[0],!u)return;h=u.id.split("-");h.pop();o=i.getStartDate();s=i.getEndDate();e.push({start:o<n.start?n.start:o,end:s>n.end?n.end:s,event:i,id:h.join("-")})}for(f.eventLayout.vertical.applyLayout(e,n.getWidth()-2*f.barMargin-f.cellBorderWidth),a=f.getNode(0),r=0;r<e.length;r++)i=e[r],u=Ext.DomQuery.selectNode("td:nth-child("+(t+1)+") [id^="+i.id+"-]",a),u&&Ext.fly(u).setStyle({left:i.left+"px",width:Math.max(i.width,0)+"px"})},getTimeSpanRegion:function(n,t){var r=this.view,i=r.getCoordinateFromDate(n),u=t?r.getCoordinateFromDate(t,!0,!0):i,f=this.getColumnsBy(function(t){return t.start<=n&&t.end>n})[0],e=this.getColumnsBy(function(n){return n.start<t&&n.end>=t})[0],o=this.translateToScheduleCoordinate([f.getX(),0]),s=this.translateToScheduleCoordinate([e?e.getRegion().right:f.getWidth()+o[0],0]);return new Ext.util.Region(Math.min(i,u),s[0],Math.max(i,u),o[0])},getStartEndDatesFromRegion:function(n,t){var i=this.view.getDateFromCoordinate([n.left,n.top],t),r=this.view.getDateFromCoordinate([n.left,n.bottom],t);return i&&r?{start:Sch.util.Date.min(i,r),end:Sch.util.Date.max(i,r)}:null},setColumnWidth:function(n,t){var i=this.view;i.calendarColumnWidth=n;i.getTimeAxisViewModel().setViewColumnWidth(n,t)},getVisibleDateRange:function(){var n=this.view,t;if(!n.rendered)return null;var i=n.getScroll(),r=n.getHeight(),u=n.getTableRegion(),f=n.timeAxis.getEnd();return u.bottom-u.top<r?(t=n.timeAxis.getStart(),{startDate:t,endDate:f}):{startDate:n.getDateFromCoordinate(i.top,null,!0),endDate:n.getDateFromCoordinate(i.top+r,null,!0)||f}}});Ext.define("Sch.mixin.SchedulerView",{extend:Sch.mixin.AbstractSchedulerView,mixins:[Sch.mixin.Localizable],eventResizeHandles:"end",dndValidatorFn:Ext.emptyFn,resizeValidatorFn:Ext.emptyFn,createValidatorFn:Ext.emptyFn,calendarViewClass:"Sch.view.Calendar",lockedGridDependsOnSchedule:null,_initializeSchedulerView:function(){this.callParent(arguments);this.on({destroy:this._destroy,afterrender:this._afterRender,itemupdate:this.onRowUpdated,scope:this});if(Ext.getVersion().isGreaterThan("5.1.1"))this.on("itemadd",function(n){var t=this.all.item(this.all.endIndex-n.length);t&&(t.dom.style.height="")});var n=this;if(!this.eventPrefix)throw"eventPrefix missing";this.on({resourcestorechange:this.clearRowHeightCache,assignmentstorechange:this.clearRowHeightCache,eventstorechange:this.clearRowHeightCache,scope:this})},inheritables:function(){return{loadingText:this.L("loadingText"),overItemCls:"",trackOver:!1,selectedItemCls:"",setReadOnly:function(n){this.dragCreator&&this.dragCreator.setDisabled(n);this.callParent(arguments)},repaintEventsForResource:function(n,t){var i=this,o=i.getMode(),r=o==="horizontal",u=r?i.indexOf(n):0,f,e;r&&i.eventLayout.horizontal.clearCache(n);u>=0&&(Ext.suspendLayouts(),r?(i.refreshNode(n),i.lockedGridDependsOnSchedule&&i.lockingPartner.refreshNode(n)):(i.refreshNode(u),i.lockingPartner.refreshNode(u)),Ext.resumeLayouts(),t&&(f=i.getEventSelectionModel(),e=i.getEventStore().getEventsForResource(n),Ext.Array.each(e,function(n){f.forEachEventRelatedSelection(n,function(n){i.onEventBarSelect(n,!0)})})))},repaintAllEvents:function(){this.mode==="horizontal"?this.refreshView():this.refreshNode(0)},handleScheduleEvent:function(n){var o=n.getTarget("."+this.eventCls,3),u=!o&&n.getTarget("."+this.timeCellCls,3),t,f,i;if(u){var s=this.getDateFromDomEvent(n,"floor"),e=this.findRowByChild(u),h=this.indexOf(e),r;this.mode=="horizontal"?r=this.getRecordForRowNode(e):(t=n.getTarget(this.timeCellSelector,5),t&&(f=typeof t.cellIndex=="number"?t.cellIndex:t.getAttribute("data-cellIndex"),i=this.headerCt.getGridColumns()[f],r=i&&i.model));n.type.indexOf("pinch")>=0?this.fireEvent("schedule"+n.type,this,n):this.fireEvent("schedule"+n.type,this,s,h,r,n)}},onEventDataRefresh:function(){this.clearRowHeightCache();this.callParent(arguments)},onUnbindStore:function(n){n.un({refresh:this.clearRowHeightCache,clear:this.clearRowHeightCache,load:this.clearRowHeightCache,scope:this});this.callParent(arguments)},bindStore:function(n){n&&n.on({refresh:this.clearRowHeightCache,clear:this.clearRowHeightCache,load:this.clearRowHeightCache,scope:this});this.callParent(arguments)},refreshKeepingScroll:function(){this.lockingPartner.saveScrollState();this.lockingPartner.refreshView();this.callParent(arguments);this.lockingPartner.restoreScrollState()}}},getEventSelectionModel:function(){var t=this,n=t.eventSelModel,i=t.eventSelModelType,r;return n&&n.events?n:(n||(n={}),!i&&t.getEventStore().getAssignmentStore()?i="assignmentmodel":i||(i="eventmodel"),r="SINGLE",t.simpleSelect?r="SIMPLE":t.multiSelect&&(r="MULTI"),Ext.applyIf(n,{allowDeselect:t.allowDeselect,mode:r}),n.events||(n=t.eventSelModel=Ext.create("selection."+i,n)),t.disableSelection&&(n.locked=!0),n)},_afterRender:function(){this.setEventStore(this.eventStore,!0);this.getEventSelectionModel().bindToView(this);this.setupEventListeners();this.configureFunctionality();var n=this.headerCt.resizer;n&&(n.doResize=Ext.Function.createSequence(n.doResize,this.afterHeaderResized,this));this.on("itemupdate",function(){this.hoveredEventNode=null})},_destroy:function(){this.setEventStore(null)},clearRowHeightCache:function(){this.mode==="horizontal"&&this.eventLayout.horizontal.clearCache()},configureFunctionality:function(){var n=this.validatorFnScope||this;this.eventResizeHandles!=="none"&&Sch.feature.ResizeZone&&(this.resizePlug=new Sch.feature.ResizeZone(Ext.applyIf({schedulerView:this,validatorFn:function(t,i,r,u){return(this.allowOverlap||this.isDateRangeAvailable(r,u,i,t))&&this.resizeValidatorFn.apply(n,arguments)},validatorFnScope:this},this.resizeConfig||{})));this.enableEventDragDrop!==!1&&Sch.feature.DragDrop&&(this.dragdropPlug=new Sch.feature.DragDrop(this,{validatorFn:function(t,i,r,u){return(this.allowOverlap||this.isDateRangeAvailable(r,Sch.util.Date.add(r,Sch.util.Date.MILLI,u),t[0],i))&&this.dndValidatorFn.apply(n,arguments)},validatorFnScope:this,dragConfig:this.dragConfig||{}}));this.enableDragCreation!==!1&&Sch.feature.DragCreator&&(this.dragCreator=new Sch.feature.DragCreator(Ext.applyIf({schedulerView:this,disabled:this.readOnly,validatorFn:function(t,i,r){return(this.allowOverlap||this.isDateRangeAvailable(i,r,null,t))&&this.createValidatorFn.apply(n,arguments)},validatorFnScope:this},this.createConfig||{})))},onBeforeDragDrop:function(n,t,i){return!this.readOnly&&!i.getTarget().className.match("sch-resizable-handle")},onDragDropStart:function(){this.dragCreator&&this.dragCreator.setDisabled(!0);this.tip&&(this.tip.hide(),this.tip.disable());this.overScheduledEventClass&&this.setMouseOverEnabled(!1);this.hoveredEventNode=null},onDragDropEnd:function(){this.dragCreator&&this.dragCreator.setDisabled(!1);this.tip&&this.tip.enable();this.overScheduledEventClass&&this.setMouseOverEnabled(!0)},onBeforeDragCreate:function(n,t,i,r){return!this.readOnly&&!r.ctrlKey},onDragCreateStart:function(){this.overScheduledEventClass&&this.setMouseOverEnabled(!1);this.tip&&(this.tip.hide(),this.tip.disable());this.disableViewScroller(!0)},onDragCreateEnd:function(n,t,i){if(!this.getEventEditor()){var r=i?[i]:[];if(this.fireEvent("beforeeventadd",this,t,r)!==!1){this.onEventCreated(t);this.getEventStore().append(t);t.assign(i)}this.dragCreator.getProxy().hide()}this.overScheduledEventClass&&this.setMouseOverEnabled(!0)},onEventCreated:function(){},onAfterDragCreate:function(){this.overScheduledEventClass&&this.setMouseOverEnabled(!0);this.tip&&this.tip.enable();this.disableViewScroller(!1)},onBeforeResize:function(){return!this.readOnly},onResizeStart:function(){this.tip&&(this.tip.hide(),this.tip.disable());this.dragCreator&&this.dragCreator.setDisabled(!0);this.disableViewScroller(!0)},onResizeEnd:function(){this.tip&&this.tip.enable();this.dragCreator&&this.dragCreator.setDisabled(!1);this.disableViewScroller(!1)},setupEventListeners:function(){this.on({beforeeventdrag:this.onBeforeDragDrop,eventdragstart:this.onDragDropStart,aftereventdrop:this.onDragDropEnd,beforedragcreate:this.onBeforeDragCreate,dragcreatestart:this.onDragCreateStart,dragcreateend:this.onDragCreateEnd,afterdragcreate:this.onAfterDragCreate,beforeeventresize:this.onBeforeResize,eventresizestart:this.onResizeStart,eventresizeend:this.onResizeEnd,scope:this})},afterHeaderResized:function(){var n=this.headerCt.resizer,t;n&&this.getMode()!=="horizontal"&&(this.panel.forceFit?this.setColumnWidth(n.origWidth):(t=n.dragHd.getWidth(),this.setColumnWidth(t)))},columnRenderer:function(n,t,i,r,u){return this[this.mode].columnRenderer(n,t,i,r,u)},onRowUpdated:function(n){var t=this,i;t.getMode()==="horizontal"&&t.hasListener("eventrepaint")&&Ext.Array.each(n.getEvents(),function(r){i=t.getElementsFromEventRecord(r,n,null,!0);Ext.Array.each(i,function(n){t.fireEvent("eventrepaint",t,r,n)})})},scrollResourceEventIntoView:function(n,t,i,r,u,f,e){var o=this,c=t.getStartDate(),l=t.getEndDate(),h,s,a=function(){s=o.getElementsFromEventRecord(t,n,i);s=s.length&&s[0]||null;o.scrollElementIntoView(s,!0,u,r,null,f,e)};o.getResourceStore().isTreeStore&&n.bubble(function(n){n.expand()});o.timeAxis.dateInAxis(c)&&o.timeAxis.dateInAxis(l)||(h=o.timeAxis.getEnd()-o.timeAxis.getStart(),o.timeAxis.setTimeSpan(new Date(c.valueOf()-h/2),new Date(l.getTime()+h/2)),o.up("panel").scrollTask.cancel());this.getOrientation()==="horizontal"?o.up("timelinegrid,timelinetree").ensureVisible(n,{callback:function(){this.isLocked===!1&&a()}}):a()}});Ext.define("Sch.view.SchedulerGridView",{extend:Sch.view.TimelineGridView,mixins:[Sch.mixin.SchedulerView,Sch.mixin.Localizable],alias:"widget.schedulergridview"},function(){this.override(Sch.mixin.SchedulerView.prototype.inheritables()||{})});Ext.define("Sch.selection.EventModel",{extend:Ext.selection.Model,alias:"selection.eventmodel",deselectOnContainerClick:!0,selectedOnMouseDown:null,bindToView:function(n){var t=this;t.view=n;t.bindStore(n.getEventStore());n.on({eventclick:t.onEventClick,eventmousedown:t.onEventMouseDown,itemmousedown:t.onItemMouseDown,refresh:function(){t.refresh()},destroy:function(){t.bindStore(null)},scope:t})},bindStore:function(n){this.getStore()&&this.mun(this.getStore(),"load",this.onEventStoreLoad,this);n&&this.mon(n,"load",this.onEventStoreLoad,this);this.callParent(arguments)},onEventStoreLoad:function(){this.deselectAll()},onEventMouseDown:function(n,t,i){this.selectedOnMouseDown=null;this.isSelected(t)||(this.selectedOnMouseDown=t,this.selectWithEvent(t,i))},onEventClick:function(n,t,i){this.selectedOnMouseDown||this.selectWithEvent(t,i)},onItemMouseDown:function(n,t,i,r,u){this.deselectOnContainerClick&&!u.getTarget(this.view.eventSelector)&&this.deselectAll()},onSelectChange:function(n,t,i,r){var u=this,f=u.view,o=u.store,e=t?"select":"deselect";if((i||u.fireEvent("before"+e,u,n))!==!1&&r()!==!1){if(t)f.onEventBarSelect(n,i);else f.onEventBarDeselect(n,i);i||u.fireEvent(e,u,n)}},selectRange:Ext.emptyFn,selectNode:function(n,t,i){var r=this.view.resolveEventRecord(n);r&&this.select(r,t,i)},deselectNode:function(n,t,i){var r=this.view.resolveEventRecord(n);r&&this.deselect(r,i)},getFirstSelectedEventForResource:function(n){for(var u=this.getSelection(),t=null,i,r=0,f=u.length;!t&&r<f;++r)i=u[r],i.isAssignedTo(n)&&(t=i);return t},getDraggableSelections:function(){return Ext.Array.filter(this.getSelection(),function(n){return n.isDraggable()})},forEachEventRelatedSelection:function(n,t){this.isSelected(n)&&t(n)}});Ext.define("Sch.selection.AssignmentModel",{extend:Sch.selection.EventModel,alias:"selection.assignmentmodel",assignmentStoreDetacher:null,destroy:function(){var n=this;Ext.destroyMembers(n,"assignmentStoreDetacher");n.callParent()},onBindStore:function(n){var i,t;this.callParent(arguments);i=n.getAssignmentStore();i&&(t=this,t.assignmentStoreDetacher&&t.assignmentStoreDetacher.destroy(),t.assignmentStoreDetacher=i.on({remove:t.onAssignmentStoreRemove,clear:t.onAssignmentStoreClear,refresh:t.onAssignmentStoreRefresh,scope:t,destroyable:!0}))},selectWithEvent:function(n,t){var r=this,u=r.view,f=u.resolveResource(t.getTarget()),e,i;f&&(e=u.getEventStore().getAssignmentStore(),i=e.getAssignmentForEventAndResource(n,f),i&&r.callParent([i,t]))},getFirstSelectedEventForResource:function(n){for(var u=this.getSelection(),t=null,i,r=0,f=u.length;!t&&r<f;++r)if(i=u[r],i.getEvent().isAssignedTo(n)){t=i;break}return t},getDraggableSelections:function(){return Ext.Array.filter(this.getSelection(),function(n){return n.getEvent().isDraggable()})},forEachEventRelatedSelection:function(n,t){Ext.Array.each(this.getSelection(),function(i){i.getEvent()===n&&t(i)})},onAssignmentStoreRemove:function(n,t){this.deselect(t,!0)},onAssignmentStoreClear:function(){this.clearSelections()},onAssignmentStoreRefresh:function(){this.clearSelections()}});Ext.define("Sch.mixin.SchedulerPanel",{extend:Sch.mixin.AbstractSchedulerPanel,eventSelModelType:null,eventSelModel:null,enableEventDragDrop:!0,enableDragCreation:!0,dragConfig:null,componentCls:"sch-schedulerpanel",lockedGridDependsOnSchedule:!0,verticalListeners:null,horizontalLockedWidth:null,inheritables:function(){return{variableRowHeight:!0,initComponent:function(){var i=this.normalViewConfig=this.normalViewConfig||{},r,n,t;this._initializeSchedulerPanel();this.verticalListeners={clear:this.refreshResourceColumns,datachanged:this.refreshResourceColumns,update:this.refreshResourceColumns,load:this.refreshResourceColumns,scope:this};this.calendarListeners={reconfigure:this.refreshCalendarColumns,priority:1,scope:this};this.normalGridListeners={resize:this.onScheduleResize,scope:this};Ext.apply(i,{eventStore:this.eventStore,resourceStore:this.resourceStore,eventBarTextField:this.eventBarTextField||this.getEventStore().getModel().prototype.nameField});Ext.Array.each(["barMargin","eventBodyTemplate","eventTpl","allowOverlap","dragConfig","eventBarIconClsField","onEventCreated","constrainDragToResource","snapRelativeToEventStartDate","eventSelModelType","eventSelModel","simpleSelect","multiSelect","allowDeselect","lockedGridDependsOnSchedule"],function(n){n in this&&(i[n]=this[n])},this);this.callParent(arguments);this.mode==="vertical"&&this.mon(this.resourceStore,this.verticalListeners);r=this.lockedGrid.getView();n=this.getSchedulingView();this.registerRenderer(n.columnRenderer,n);this.resourceZones&&(t=Ext.StoreManager.lookup(this.resourceZones),t.setResourceStore(this.resourceStore),this.resourceZonesPlug=new Sch.plugin.ResourceZones(Ext.apply({store:t},this.resourceZonesConfig)),this.resourceZonesPlug.init(this));n.on("columnwidthchange",this.onColWidthChange,this);this.relayEvents(n,["eventclick","eventlongpress","eventmousedown","eventmouseup","eventdblclick","eventcontextmenu","eventmouseenter","eventmouseleave","eventkeydown","eventkeyup","beforeeventresize","eventresizestart","eventpartialresize","beforeeventresizefinalize","eventresizeend","beforeeventdrag","eventdragstart","eventdrag","beforeeventdropfinalize","eventdrop","aftereventdrop","beforedragcreate","dragcreatestart","beforedragcreatefinalize","dragcreateend","afterdragcreate","beforeeventadd"]);this.syncRowHeight||this.enableRowHeightInjection(r,n)},applyViewSettings:function(n,t){this.callParent(arguments);var i=this.getSchedulingView(),r;t=t||!this.rendered;this.orientation==="vertical"&&(r=n.timeColumnWidth||60,i.setColumnWidth(n.resourceColumnWidth||100,!0),i.setRowHeight(r,!0))},afterRender:function(){if(this.callParent(arguments),this.mode==="calendar"){this.mon(this.timeAxis,this.calendarListeners);this.normalGrid.on(this.normalGridListeners)}this.getSchedulingView().on({eventdragstart:this.doSuspendLayouts,aftereventdrop:this.doResumeLayouts,eventresizestart:this.doSuspendLayouts,eventresizeend:this.doResumeLayouts,scope:this});if(this.lockedGridDependsOnSchedule)this.normalGrid.getView().on("itemupdate",this.onNormalViewItemUpdate,this);this.relayEvents(this.getEventSelectionModel(),["selectionchange","deselect","select"],"event")},getTimeSpanDefiningStore:function(){return this.eventStore},destroy:function(){this.destroyStores&&(this.eventStore&&this.eventStore.destroy(),this.eventStore=null,this.resourceStore&&this.resourceStore.destroy(),this.resourceStore=null,this.assignmentStore&&this.assignmentStore.destroy(),this.assignmentStore=null);this.callParent(arguments)}}},doSuspendLayouts:function(){var n=this.getSchedulingView();n.infiniteScroll&&n.timeAxis.on({beginreconfigure:this.onBeginReconfigure,endreconfigure:this.onEndReconfigure,scope:this});this.lockedGrid.suspendLayouts();this.normalGrid.suspendLayouts()},doResumeLayouts:function(){var n=this.getSchedulingView();n.infiniteScroll&&n.timeAxis.un({beginreconfigure:this.onBeginReconfigure,endreconfigure:this.onEndReconfigure,scope:this});this.lockedGrid.resumeLayouts();this.normalGrid.resumeLayouts()},onBeginReconfigure:function(){this.normalGrid.resumeLayouts()},onEndReconfigure:function(){this.normalGrid.suspendLayouts()},onColWidthChange:function(n,t){switch(this.getMode()){case"vertical":this.resourceColumnWidth=t;this.refreshResourceColumns();break;case"calendar":this.calendarColumnWidth=t;this.refreshCalendarColumns()}},enableRowHeightInjection:function(n,t){var r=this,u=new Ext.XTemplate("{%","this.processCellValues(values);","this.nextTpl.applyOut(values, out, parent);","%}",{priority:1,processCellValues:function(n){var i,u,f,e;t.mode==="horizontal"&&(i=1,t.dynamicRowHeight&&(u=n.record,f=t.eventLayout.horizontal,i=f.getNumberOfBands(u,function(){return t.getEventStore().filterEventsForResource(u,t.timeAxis.isRangeInAxis,t.timeAxis)})),e=i*r.getRowHeight()-(i-1)*t.barMargin-t.cellTopBorderWidth-t.cellBottomBorderWidth,n.style=(n.style||"")+";height:"+e+"px;")}}),i;n.addCellTpl(u);Ext.Array.each(n.getColumnManager().getColumns(),function(n){n.hasCustomRenderer=!0});i=this.getView().getStoreListeners();i=Ext.apply({},i);i.scope=this.getView();this.store.un(i);this.store.on(i)},getEventSelectionModel:function(){return this.getSchedulingView().getEventSelectionModel()},refreshResourceColumns:function(){var n=this.resourceColumnWidth||this.timeAxisViewModel.resourceColumnWidth;this.reconfigure(this.verticalColumns.concat(this.createResourceColumns(n)))},onScheduleResize:function(){var n=this.normalGrid.down("gridcolumn").getWidth();this.timeAxisViewModel.setViewColumnWidth(n,!0);this.getSchedulingView().refresh()},refreshCalendarColumns:function(){var n=this.createCalendarRows(),t=this.createCalendarColumns();this.reconfigure(n,this.calendarColumns.concat(t))},setOrientation:function(){this.setMode.apply(this,arguments)},setMode:function(n,t){var e;if(!this.normalGrid){this.on("afterrender",function(){this.setMode(n,!0)});return}if(n!==this.mode||t){switch(n){case"horizontal":this.addCls("sch-horizontal");this.removeCls(["sch-vertical","sch-calendar","sch-vertical-resource"]);break;case"vertical":this.addCls(["sch-vertical-resource","sch-vertical"]);this.removeCls(["sch-calendar","sch-horizontal"]);break;case"calendar":this.addCls(["sch-calendar","sch-vertical"]);this.removeCls(["sch-vertical-resource","sch-horizontal"])}this.mode=n;var i=this,u=function(){return!1},o=i.normalGrid,f=i.lockedGrid.getView(),r=i.getSchedulingView(),s=o.headerCt;f.on("beforerefresh",u);r.on("beforerefresh",u);if(r.blockRefresh=f.blockRefresh=!0,Ext.suspendLayouts(),r.setMode(n),s.removeAll(!0),n!=="calendar"?(i.timeAxis.setMode("plain"),i.mun(i.timeAxis,i.calendarListeners),i._oldViewPreset&&(i.setViewPreset.apply(i,i._oldViewPreset),delete i._oldViewPreset)):(i._oldViewPreset=[i.viewPreset,i.timeAxis.getStart(),i.timeAxis.getEnd()],i.timeAxis.setMode("calendar"),i.setViewPreset(i.calendarViewPreset),i.mon(i.timeAxis,i.calendarListeners)),n==="horizontal")i.mun(i.resourceStore,i.verticalListeners),i.normalGrid.un(i.normalGridListeners),r.setRowHeight(i.rowHeight||i.timeAxisViewModel.rowHeightHorizontal,!0),i.reconfigure(i.resourceStore,i.horizontalColumns),this.horizontalLockedWidth!==null&&this.lockedGrid.setWidth(this.horizontalLockedWidth);else if(n==="calendar"){i.mun(i.resourceStore,i.verticalListeners);i.normalGrid.on(i.normalGridListeners);i.refreshCalendarColumns();r.setRowHeight(i.rowHeight||i.timeAxisViewModel.rowHeightVertical,!0);r.setColumnWidth(i.timeAxisViewModel.calendarColumnWidth||100,!0)}else i.normalGrid.un(i.normalGridListeners),e=0,this.horizontalLockedWidth=this.lockedGrid.getWidth(),i.mon(i.resourceStore,i.verticalListeners),i.reconfigure(i.timeAxis,i.verticalColumns.concat(i.createResourceColumns(i.resourceColumnWidth||i.timeAxisViewModel.resourceColumnWidth))),Ext.Array.each(i.lockedGrid.query("gridcolumn"),function(n){e+=n.rendered?n.getWidth():n.width||100}),r.setColumnWidth(i.timeAxisViewModel.resourceColumnWidth||100,!0),i.lockedGrid.setWidth(e);f.un("beforerefresh",u);r.un("beforerefresh",u);r.blockRefresh=f.blockRefresh=!1;i.refreshViews(!1);Ext.resumeLayouts(!0);this.fireEvent("modechange",this,n);this.fireEvent("orientationchange",this,n)}},createCalendarRows:function(){var n=this,t=n.timeAxis.getRowTicks();return n.timeAxisViewModel.calendarRowsAmount=t.length,new Ext.data.Store({model:"Sch.model.TimeAxisTick",data:t})},createCalendarColumns:function(){var n=this,t=n.timeAxis.headerConfig.middle,i=[];return n.timeAxis.forEachAuxInterval(t.splitUnit,null,function(r,u,f){r.setHours(this.startTime);u=new Date(r);u.setHours(this.endTime);var e={xtype:"weekview-day",renderer:n.mainRenderer,scope:n,start:r,end:u};e.text=t.renderer?t.renderer.call(t.scope||n,r,u,e,f,n.getEventStore()):Ext.Date.format(r,t.dateFormat);i.push(e)}),i},setRowHeight:function(n,t){t=t||!this.lockedGrid;this.timeAxisViewModel.setViewRowHeight(n,t)},onNormalViewItemUpdate:function(n){if(this.lockedGridDependsOnSchedule){var t=this.lockedGrid.getView();t.suspendEvents();t.refreshNode(t.indexOf(n));this.syncRowHeight&&this.syncRowHeights();t.resumeEvents()}}});Ext.define("Sch.patches.TableView_HandleUpdate",{extend:Sch.util.Patch,target:"Ext.view.Table",minVersion:"6.0.2",overrides:{handleUpdate:function(n,t,i,r,u,f){i=i||Ext.data.Model.EDIT;var e=this,ct=e.store.indexOf(t),w=e.rowTpl,it=e.markDirty,y=e.dirtyCls,rt=i!==Ext.data.Model.EDIT,c=[],d=e.variableRowHeight,g=0,lt=e.ownerCt,l=e.cellFly||(e.self.prototype.cellFly=new Ext.dom.Fly),s,at,p,nt,vt,ut,b,ft,k,o,tt,a,et,v,yt,h,pt,ot,st,ht;if(e.viewReady&&(s=e.getNodeByRecord(t),s)){if(t.isCollapsedPlaceholder){Ext.fly(s).syncContent(e.createRowElement(t,e.indexOfRow(t)));return}if(ft=e.overItemCls,k=e.ownerCt.getVisibleColumnManager().getColumns(),f)c=k,g=1;else for(a=0,tt=k.length;a<tt;a++)o=k[a],o.preventUpdate?(v=Ext.fly(s).down(o.getCellSelector(),!0),v&&!rt&&it&&(l.attach(v),t.isModified(o.dataIndex)?l.addCls(y):l.removeCls(y))):(et=e.shouldUpdateCell(t,o,r),et&&(g=g|et,c[c.length]=o,d=d||o.variableRowHeight));if(e.fireEvent("beforeitemupdate",t,ct,s,c),e.getRowClass||!e.getRowFromItem(s)||g&1||s.tBodies[0].childNodes.length>1){if(st=s._extData,p=e.createRowElement(t,e.indexOfRow(t),c),Ext.fly(s,"_internal").hasCls(ft)&&Ext.fly(p).addCls(ft),Ext.isIE9m&&s.mergeAttributes)s.mergeAttributes(p,!0);else for(nt=p.attributes,vt=nt.length,b=0;b<vt;b++)ut=nt[b].name,ut!=="id"&&s.setAttribute(ut,nt[b].value);for(st&&(st.isSynchronized=!1),k.length&&(at=e.getRow(s))&&e.updateColumns(at,Ext.fly(p).down(e.rowSelector,!0),c);w;){if(w.syncContent&&w.syncContent(s,p,r?c:null)===!1)break;w=w.nextTpl}}else for(a=0,tt=c.length;a<tt;a++)o=c[a],yt=o.dataIndex,h=t.get(yt),v=Ext.fly(s).down(o.getCellSelector(),!0),l.attach(v),!rt&&it&&(t.isModified(o.dataIndex)?l.addCls(y):l.removeCls(y)),pt=o.usingDefaultRenderer,ot=pt?o:o.scope,o.updater?Ext.callback(o.updater,ot,[v,h,t,e,e.dataSource],0,o,lt):(o.renderer&&(h=Ext.callback(o.renderer,ot,[h,null,t,0,0,e.dataSource,e],0,o,lt)),ht=h==null||h==="",h=ht?o.emptyCellText:h,o.producesHTML||ht?l.down(e.innerSelector,!0).innerHTML=h:l.down(e.innerSelector,!0).childNodes[0].data=h),e.highlightClass&&(Ext.fly(v).addCls(e.highlightClass),e.changedCells||(e.self.prototype.changedCells=[],e.prototype.clearChangedTask=new Ext.util.DelayedTask(e.clearChangedCells,e.prototype),e.clearChangedTask.delay(e.unhighlightDelay)),e.changedCells.push({cell:v,cls:e.highlightClass,expires:Ext.Date.now()+1e3}));rt&&it&&!t.dirty&&Ext.fly(s,"_internal").select("."+y).removeCls(y);d&&Ext.suspendLayouts();e.fireEvent("itemupdate",t,ct,s);d&&(e.ownerGrid.updateLayout(),Ext.resumeLayouts(!0))}}}});Ext.define("Sch.patches.TablePanel",{extend:Sch.util.Patch,target:"Ext.panel.Table",minVersion:"6.0.1",overrides:{ensureVisible:function(n,t){t&&t.column&&this.getVisibleColumns().indexOf(t.column)===-1||this.callParent(arguments)}}});Ext.define("Sch.patches.CellContext",{extend:Sch.util.Patch,target:"Ext.grid.CellContext",minVersion:"6.0.0",applyFn:function(){var n={setAll:function(n,t,i,r,u){var f=this;return u&&i==-1&&n!==f.view&&(n=f.view,i=n.getVisibleColumnManager().indexOf(u)),f.view=n,f.rowIdx=t,f.colIdx=i,f.record=r,f.column=u,f}};Ext.getVersion().isGreaterThanOrEqual("6.0.1")&&(n.setPosition=function(n,t){return n=n||0,t=t||0,this.callParent(arguments)});Ext.override(Ext.grid.CellContext,n)}});Ext.define("Sch.patches.BufferedRenderer",{extend:Sch.util.Patch,target:"Ext.grid.plugin.BufferedRenderer",overrides:{onRangeFetched:function(){return this.tableTopBorderWidth=this.tableTopBorderWidth||0,this.callParent(arguments)},refreshSize:function(){var t=this,n=t.view;n&&n.body.dom&&this.callParent(arguments)}}});Ext.define("Sch.patches.RowSynchronizer",{extend:Sch.util.Patch,target:"Ext.grid.locking.RowSynchronizer",minVersion:"5.1.0",overrides:Ext.versions.extjs.isGreaterThan("5.1.0")?{finish:function(n){if(n)return this.callParent(arguments)}}:{}});Ext.define("Sch.patches.Chrome",{extend:Sch.util.Patch,minVersion:"5.1.0",applyFn:function(){Ext.isChrome&&Ext.browser.version.isGreaterThanOrEqual("43")&&Ext.util.CSS.createStyleSheet(".sch-timelinepanel ."+Ext.baseCSSPrefix+"form-text { display: inherit; }")}});Ext.define("Sch.patches.Explorer",{extend:Sch.util.Patch,minVersion:"6.0.0",applyFn:function(){Ext.isIE9m&&Ext.util.CSS.createStyleSheet("."+Ext.baseCSSPrefix+"column-header-trigger { z-index: 10; }")}});Ext.define("Sch.mixin.TimelinePanel",{extend:Sch.mixin.AbstractTimelinePanel,mixins:[Sch.mixin.Zoomable,Sch.mixin.PartnerTimelinePanel],destroyStores:!1,bufferCoef:5,bufferThreshold:.2,infiniteScroll:!1,showCrudManagerMask:!0,waitingForAutoTimeSpan:!1,columnLinesFeature:null,renderWaitListener:null,schedulePinchThreshold:30,pinchStartDistanceX:null,pinchStartDistanceY:null,pinchDistanceX:null,pinchDistanceY:null,horizontalColumns:null,verticalColumns:null,calendarColumns:null,forceDefineTimeSpanByStore:!1,split:!0,viewRefreshRequested:null,tipCfg:{cls:"sch-tip",showDelay:400,hideDelay:0,autoHide:!0,anchor:"b"},inheritables:function(){return{columnLines:!0,enableLocking:!0,lockable:!0,stateEvents:["viewchange"],syncRowHeight:!1,cellTopBorderWidth:0,initComponent:function(){var r,i,n,t;if(this.partnerTimelinePanel&&(typeof this.partnerTimelinePanel=="string"&&(this.partnerTimelinePanel=Ext.getCmp(this.partnerTimelinePanel)),this.timeAxisViewModel=this.partnerTimelinePanel.timeAxisViewModel,this.timeAxis=this.partnerTimelinePanel.getTimeAxis(),this.startDate=this.timeAxis.getStart(),this.endDate=this.timeAxis.getEnd()),this._initializeTimelinePanel(),this.configureChildGrids(),this.forceFit=!1,this.configureColumns(),r=this.normalViewConfig=this.normalViewConfig||{},i=this.getId(),Ext.apply(this.normalViewConfig,{id:i+"-timelineview",eventPrefix:this.autoGenId?null:i,timeAxisViewModel:this.timeAxisViewModel,eventBorderWidth:this.eventBorderWidth,timeAxis:this.timeAxis,readOnly:this.readOnly,mode:this.mode,rtl:this.rtl,cellBorderWidth:this.cellBorderWidth,cellTopBorderWidth:this.cellTopBorderWidth,cellBottomBorderWidth:this.cellBottomBorderWidth,infiniteScroll:this.infiniteScroll,bufferCoef:this.bufferCoef,bufferThreshold:this.bufferThreshold}),Ext.Array.each(["eventRendererScope","eventRenderer","dndValidatorFn","resizeValidatorFn","createValidatorFn","tooltipTpl","validatorFnScope","eventResizeHandles","enableEventDragDrop","enableDragCreation","resizeConfig","createConfig","tipCfg","getDateConstraints"],function(n){n in this&&(r[n]=this[n])},this),this.callParent(arguments),this.rtl?(this.lockedGrid.view.addCls("sch-locked-column-fixer"),this.addCls("sch-rtl")):this.addCls("sch-ltr"),this.patchNavigationModel(this),Ext.supports.Touch)this.timeAxisViewModel.on("update",this.refreshHeaderContainerScrollable,this);this.setViewPreset(this.viewPreset,this.startDate||this.timeAxis.getStart(),this.endDate||this.timeAxis.getEnd(),!0);this.startDate||(n=this.getTimeSpanDefiningStore(),(n.isTreeStore?n.getRoot().childNodes.length:n.getCount())?this.applyStartEndDatesFromStore():(n.isLoading()||this.forceDefineTimeSpanByStore)&&this.bindAutoTimeSpanListeners());t=this.columnLines;t&&(this.columnLinesFeature=new Sch.feature.ColumnLines(Ext.isObject(t)?t:undefined),this.columnLinesFeature.init(this),this.columnLines=!0);this.relayEvents(this.getSchedulingView(),["beforetooltipshow","scheduleclick","scheduledblclick","schedulecontextmenu","schedulepinch","schedulepinchstart","schedulepinchend"]);this.on("zoomchange",function(){this.normalGrid.scrollTask.cancel()});this.crudManager&&(!this.crudManager.autoSync&&this.showCrudManagerMask&&(this.mon(this.crudManager,{beforesend:this.beforeCrudOperationStart,synccanceled:this.onCrudOperationComplete,loadcanceled:this.onCrudOperationComplete,load:this.onCrudOperationComplete,sync:this.onCrudOperationComplete,requestfail:this.onCrudOperationComplete,scope:this}),this.crudManager.isLoading()&&this.beforeCrudOperationStart(this.crudManager,null,"load")),this.mon(this.crudManager,{beforeloadapply:this.onCrudBeforeLoad,load:this.onCrudLoad,scope:this}));this.afterInitComponent()},refreshHeaderContainerScrollable:function(){var n=this.getSchedulingView().headerCt.getScrollable(),t;Ext.getVersion().isLessThan("6.0.1")?(t=n.isConfiguring,n.isConfiguring=!0,n.doRefresh(),n.refreshAxes(),n.isConfiguring=t):n.doRefresh()},getState:function(){var n=this,t=n.callParent(arguments);return Ext.apply(t,{viewPreset:n.viewPreset,startDate:n.getStart(),endDate:n.getEnd(),zoomMinLevel:n.zoomMinLevel,zoomMaxLevel:n.zoomMaxLevel,currentZoomLevel:n.currentZoomLevel}),t},applyState:function(n){var t=this;t.callParent(arguments);n&&n.viewPreset&&t.setViewPreset(n.viewPreset,n.startDate,n.endDate);n&&n.currentZoomLevel&&t.zoomToLevel(n.currentZoomLevel)},setTimeSpan:function(){this.callParent(arguments);this.waitingForAutoTimeSpan&&(this.unbindAutoTimeSpanListeners(!1),this.getView().refresh());this.normalGrid.getView().viewReady||this.getView().refresh()},onBoxReady:function(){var n=this;if(n.callParent(arguments),n.partnerTimelinePanel)if(n.partnerTimelinePanel.rendered)n.setupPartnerTimelinePanel(n.partnerTimelinePanel);else n.partnerTimelinePanel.on("boxready",n.setupPartnerTimelinePanel,n);n.normalGrid.on({collapse:n.onNormalGridCollapse,expand:n.onNormalGridExpand,scope:n});n.lockedGrid.on({itemdblclick:n.onLockedGridItemDblClick,scope:n});if(Ext.supports.Touch)this.getSchedulingView().on({schedulepinchstart:this.onSchedulePinchStart,schedulepinch:this.onSchedulePinch,schedulepinchend:this.onSchedulePinchEnd,scope:this})}}},bindAutoTimeSpanListeners:function(){var n=this.getTimeSpanDefiningStore();this.waitingForAutoTimeSpan=!0;this.suspendViewsRefresh();this.mon(n,"load",this.applyStartEndDatesFromStore,this);n.isTreeStore?(this.mon(n,"rootchange",this.applyStartEndDatesFromStore,this),this.mon(n,"nodeappend",this.applyStartEndDatesAfterTreeAppend,this)):this.mon(n,"add",this.applyStartEndDatesFromStore,this)},refreshStopper:function(n){return this.viewRefreshRequested=this.viewRefreshRequested||{},this.viewRefreshRequested[n.isLockedView?"locked":"normal"]=!0,!1},suspendViewsRefresh:function(){var n=this.normalGrid.view,t=this.lockedGrid.view;n.on("beforerefresh",this.refreshStopper,this);t.on("beforerefresh",this.refreshStopper,this);n.blockRefresh=!0;t.blockRefresh=!0},resumeViewsRefresh:function(n){var i,r,t;n=n!==!1;i=this.normalGrid.view;r=this.lockedGrid.view;i.un("beforerefresh",this.refreshStopper,this);r.un("beforerefresh",this.refreshStopper,this);i.blockRefresh=!1;r.blockRefresh=!1;t=this.viewRefreshRequested||{};t.locked=t.locked||r.refreshNeeded;t.normal=t.normal||i.refreshNeeded;n&&(t.locked&&t.normal?(Ext.suspendLayouts(),this.getView().relayFn("refreshView"),Ext.resumeLayouts(!0)):t.locked?r.refreshView():t.normal&&i.refreshView());this.viewRefreshRequested=null},getTimeSpanDefiningStore:function(){throw"Abstract method called";},unbindAutoTimeSpanListeners:function(n){this.waitingForAutoTimeSpan=!1;var t=this.getTimeSpanDefiningStore();this.resumeViewsRefresh(n);t.un("load",this.applyStartEndDatesFromStore,this);t.isTreeStore?(t.un("rootchange",this.applyStartEndDatesFromStore,this),t.un("nodeappend",this.applyStartEndDatesAfterTreeAppend,this)):t.un("add",this.applyStartEndDatesFromStore,this)},applyStartEndDatesAfterTreeAppend:function(){var n=this.getTimeSpanDefiningStore();n.isSettingRoot||n.__loading||this.applyStartEndDatesFromStore()},applyStartEndDatesFromStore:function(){var t=this.getTimeSpanDefiningStore(),n=t.getTotalTimeSpan();n.end&&n.start&&n.end-n.start==0&&(n.start=Sch.util.Date.add(n.start,this.timeAxis.mainUnit,-1),n.end=Sch.util.Date.add(n.end,this.timeAxis.mainUnit,1));this.setTimeSpan(n.start||new Date,n.end)},onLockedGridItemDblClick:function(n,t,i,r,u){this.mode==="vertical"&&t&&this.fireEvent("timeheaderdblclick",this,t.get("start"),t.get("end"),r,u)},getSchedulingView:function(){return this.normalGrid&&this.normalGrid.view},getHorizontalTimeAxisColumn:function(){return this.getSchedulingView().getHorizontalTimeAxisColumn()},configureColumns:function(){var n=this.columns||[],t,i;if(n=n.items?n.items:this.columns=n.slice(),t=[],i=[],Ext.Array.each(n,function(n){n.position==="right"?(Ext.isNumber(n.width)||Ext.Error.raise('"Right" columns must have a fixed width'),n.locked=!1,i.push(n)):(n.locked=!0,t.push(n));n.lockable=!1}),n.length===0&&(this.split=!1),Ext.Array.erase(n,0,n.length),Ext.Array.insert(n,0,t.concat({xtype:"timeaxiscolumn",timeAxisViewModel:this.timeAxisViewModel,trackHeaderOver:this.trackHeaderOver,renderer:this.mainRenderer,variableRowHeight:this.variableRowHeight,scope:this}).concat(i)),this.horizontalColumns=Ext.Array.clone(n),this.verticalColumns=[Ext.apply({xtype:"verticaltimeaxis",width:100,timeAxis:this.timeAxis,timeAxisViewModel:this.timeAxisViewModel,cellTopBorderWidth:this.cellTopBorderWidth,cellBottomBorderWidth:this.cellBottomBorderWidth},this.timeAxisColumnCfg||{})],this.calendarColumns=[Ext.apply({xtype:"verticaltimeaxis",width:60,timeAxis:this.timeAxis,timeAxisViewModel:this.timeAxisViewModel,cellTopBorderWidth:this.cellTopBorderWidth,cellBottomBorderWidth:this.cellBottomBorderWidth},this.calendarTimeAxisCfg||{})],this.mode==="vertical")this.columns=this.verticalColumns.concat(this.createResourceColumns(this.resourceColumnWidth||this.timeAxisViewModel.resourceColumnWidth)),this.store=this.timeAxis;else if(this.mode==="calendar"){this.columns=[];this.store=null;this.on("afterrender",this.refreshCalendarColumns,this)}},mainRenderer:function(n,t,i,r,u){var e=this.renderers,c=this.mode==="horizontal"||this.mode==="calendar"?i:this.getResourceStore().getAt(u),s="&nbsp;",f,o,h;for(t.rowHeight=null,f=0;f<e.length;f++)s+=e[f].fn.call(e[f].scope||this,n,t,c,r,u)||"";return this.variableRowHeight&&(o=this.getSchedulingView(),h=this.getRowHeight(),t.style="height:"+((t.rowHeight||h)-o.cellTopBorderWidth-o.cellBottomBorderWidth)+"px"),s},onNormalGridCollapse:function(){var n=this;if(n.normalGrid.reExpander||(n.normalGrid.reExpander=n.normalGrid.placeholder),n.lockedGrid.rendered)n.lockedGrid.flex=1,n.lockedGrid.updateLayout(),n.lockedGrid.collapsed&&n.lockedGrid.expand(),n.addCls("sch-normalgrid-collapsed");else n.lockedGrid.on("render",n.onNormalGridCollapse,n,{delay:1})},onNormalGridExpand:function(){this.removeCls("sch-normalgrid-collapsed");delete this.lockedGrid.flex;this.lockedGrid.updateLayout()},beforeCrudOperationStart:function(n,t,i){this.rendered?this.setLoading({msg:i==="load"?this.L("loadingText"):this.L("savingText")}):(Ext.destroy(this.renderWaitListener),this.renderWaitListener=this.on("render",Ext.Function.bind(this.beforeCrudOperationStart,this,Array.prototype.slice.apply(arguments)),this,{delay:1,destroyable:!0}))},onCrudBeforeLoad:function(){this.suspendViewsRefresh()},onCrudLoad:function(){this.resumeViewsRefresh()},onCrudOperationComplete:function(){Ext.destroy(this.renderWaitListener);this.setLoading(!1)},onSchedulePinchStart:function(n,t){this.pinchStartDistanceX=Math.abs(t.touches[0].pageX-t.touches[1].pageX);this.pinchStartDistanceY=Math.abs(t.touches[0].pageY-t.touches[1].pageY)},onSchedulePinch:function(n,t){this.pinchDistanceX=Math.abs(t.touches[0].pageX-t.touches[1].pageX);this.pinchDistanceY=Math.abs(t.touches[0].pageY-t.touches[1].pageY)},onSchedulePinchEnd:function(n){var i=this.pinchDistanceX,r=this.pinchDistanceY,f=this.getMode()[0]==="h",t,u;Math.abs(i-this.pinchStartDistanceX)>this.schedulePinchThreshold&&(t=Math.abs(i/this.pinchStartDistanceX),f?t>1?this.zoomIn():this.zoomOut():this.timeAxisViewModel.setViewColumnWidth(t*this.timeAxisViewModel.resourceColumnWidth));Math.abs(r-this.pinchStartDistanceY)>this.schedulePinchThreshold&&(u=Math.abs(r/this.pinchStartDistanceY),n.setRowHeight(n.getRowHeight()*u));this.pinchStartDistanceX=this.pinchStartDistanceY=this.pinchDistanceX=this.pinchDistanceY=null},patchNavigationModel:function(n){n.getView().getNavigationModel().focusItem=function(t){t.addCls(this.focusCls);((Ext.isIE||Ext.isEdge)&&!t.hasCls("sch-timetd")||!(Ext.isIE||Ext.isEdge||n.getOrientation()!=="horizontal"))&&t.focus()};var t=n.lockedGrid.getView(),i=n.normalGrid.getView();t.on("rowclick",function(n,t,r,u){i.lastFocused?(i.lastFocused.rowIdx=u,i.lastFocused.record=t):Ext.isIE&&(i.lastFocused=this.lastFocused)});i.on("rowclick",function(n,i,r,u){t.lastFocused?(t.lastFocused.rowIdx=u,t.lastFocused.record=i):Ext.isIE&&(t.lastFocused=this.lastFocused)})},configureChildGrids:function(){var n=this,t,i;n.lockedGridConfig=Ext.apply({},n.lockedGridConfig||{});n.normalGridConfig=Ext.apply({},n.schedulerConfig||n.normalGridConfig||{});t=n.lockedGridConfig;i=n.normalGridConfig;n.lockedXType&&(t.xtype=n.lockedXType);n.normalXType&&(i.xtype=n.normalXType);Ext.applyIf(t,{useArrows:!0,animCollapse:!1,collapseDirection:"left",trackMouseOver:!1});Ext.applyIf(i,{viewType:n.viewType,enableColumnMove:!1,enableColumnResize:!1,enableColumnHide:!1,trackMouseOver:!1,collapseDirection:"right",collapseMode:"placeholder",animCollapse:!1});n.mode==="vertical"&&(t.store=i.store=n.timeAxis);t.width&&(n.syncLockedWidth=Ext.emptyFn,t.scroll=Ext.supports.Touch?"both":"horizontal",t.scrollerOwner=!0)},afterInitComponent:function(){var n=this,t=n.lockedGrid.getView(),r=n.normalGrid.getView(),u=Ext.data.TreeStore&&n.store instanceof Ext.data.TreeStore,i;if(n.normalGrid.collapsed){n.normalGrid.collapsed=!1;r.on("boxready",function(){n.normalGrid.collapse()},n,{delay:10})}if(n.lockedGrid.collapsed){n.lockedGrid.collapsed=!1;t.on("boxready",function(){n.lockedGrid.collapse()},n,{delay:10});t.bufferedRenderer&&(t.bufferedRenderer.disabled=!0)}Ext.getScrollbarSize().width===0&&t.addCls("sch-ganttpanel-force-locked-scroll");u&&this.setupLockableFilterableTree();this.on("afterrender",function(){var t=this.lockedGrid.headerCt.showMenuBy;this.lockedGrid.headerCt.showMenuBy=function(){t.apply(this,arguments);n.showMenuBy.apply(this,arguments)}});i=this.child("splitter");i&&i.addCls("sch-timelinepanel-splitter")},setupLockableFilterableTree:function(){var i=this,n=i.lockedGrid.getView(),t=Sch.mixin.FilterableTreeView.prototype;n.initTreeFiltering=t.initTreeFiltering;n.onFilterChangeStart=t.onFilterChangeStart;n.onFilterChangeEnd=t.onFilterChangeEnd;n.onFilterCleared=t.onFilterCleared;n.onFilterSet=t.onFilterSet;n.initTreeFiltering()},showMenuBy:function(){var n=this.getMenu(),t=n.down("#unlockItem"),i=n.down("#lockItem"),r=t.prev();r.hide();t.hide();i.hide()},zoomToFit:function(n){n=Ext.apply({adjustStart:1,adjustEnd:1},n);var i=this.getEventStore(),t=this.getEventStore().getTotalTimeSpan();this.zoomToSpan(t,n)===null&&this.getSchedulingView().fitColumns()},refreshViews:function(n){if(this.rendered){var i=!1,r=function(){i=!0},u=this.normalGrid.getView(),t=this.lockedGrid.getView(),f={left:t.getScrollX(),top:t.getScrollY()};u.on("refresh",r);t.refreshView();u.un("refresh",r);n!==!1?(i||this.getSchedulingView().refreshKeepingScroll(),t.setScrollX(f.left),t.setScrollY(f.top)):i||this.getSchedulingView().refreshView()}}},function(){var t="6.0.0",n;Ext.apply(Sch,{VERSION:"4.1.2"});Ext.versions.extjs.isLessThan(t)&&(n=console,n&&n.log("The Ext JS version you are using needs to be updated to at least "+t))});Ext.define("Sch.panel.TimelineGridPanel",{extend:Ext.grid.Panel,mixins:[Sch.mixin.Localizable,Sch.mixin.TimelinePanel],alias:["widget.timelinegrid"],subGridXType:"gridpanel",isTimelineGridPanel:!0,initComponent:function(){this.callParent(arguments);this.getSchedulingView()._initializeTimelineView()}},function(){this.override(Sch.mixin.TimelinePanel.prototype.inheritables()||{})});Ext.define("Sch.panel.SchedulerGrid",{extend:Sch.panel.TimelineGridPanel,mixins:[Sch.mixin.SchedulerPanel],alias:["widget.schedulergrid","widget.schedulerpanel"],alternateClassName:"Sch.SchedulerPanel",viewType:"schedulergridview",initComponent:function(){this.callParent(arguments);this.getSchedulingView()._initializeSchedulerView()}},function(){this.override(Sch.mixin.SchedulerPanel.prototype.inheritables()||{})});Ext.define("Sch.patches.TableView",{extend:Sch.util.Patch,target:"Ext.view.Table",minVersion:"6.0.1",maxVersion:"6.0.1.9999",overrides:{suspendCellEditing:function(n){var i=n,t=i.activeEditor;t&&t.editing&&(i.suspendedEditor=t,i.suspendEvents(),t.suspendEvents(),t.cancelEdit(!0),t.resumeEvents(),i.resumeEvents())},resumeCellEditing:function(n,t){var i=n,r=i.activeEditor=i.suspendedEditor,u;return r&&(i.suspendEvents(),r.suspendEvents(),u=i.activateCell(t,!0,!0),r.field&&r.field.focus(!1,!0),r.resumeEvents(),i.resumeEvents()),u},suspendActionableMode:function(){for(var i=this,r=i.grid.actionables,u=r.length,n,t=0;t<u;t++)n=r[t],Ext.grid.plugin.CellEditing&&n instanceof Ext.grid.plugin.CellEditing&&i.suspendCellEditing(n)},resumeActionableMode:function(n){var t=this,f=t.grid.actionables,e=f.length,i,r,u;for(t.toggleChildrenTabbability(!1),i=0;i<e;i++)u=f[i],!r&&Ext.grid.plugin.CellEditing&&u instanceof Ext.grid.plugin.CellEditing&&(r=t.resumeCellEditing(u,n));r||t.activateCell(n)},saveFocusState:function(){var t=this,f=t.dataSource,i=t.actionableMode,r=t.getNavigationModel(),n=i?t.actionPosition:r.getPosition(!0),u=Ext.Element.getActiveElement(!0),e=n&&n.view===t&&n.getCell(),o,s;return e&&e.contains(u)?(n=n.clone(),u.suspendFocusEvents(),i?t.suspendActionableMode():r.setPosition(),u.resumeFocusEvents(),function(){f.getCount()?(o=Math.min(n.rowIdx,t.all.getCount()-1),s=Math.min(n.colIdx,t.getVisibleColumnManager().getColumns().length-1),n=new Ext.grid.CellContext(t).setPosition(f.contains(n.record)?n.record:o,s),i?t.resumeActionableMode(n):r.setPosition(n,null,null,null,!0)):n.column.focus()}):Ext.emptyFn},activateCell:function(){return!0},onFocusEnter:function(n){Ext.fly(n.target).hasCls("sch-event")||this.callParent(arguments)}}});Ext.define("Sch.patches.ColumnResizeTree",{override:"Sch.panel.TimelineTreePanel",afterRender:function(){this.callParent(arguments);var n=this.lockedGrid.headerCt.findPlugin("gridheaderresizer");n&&(n.getConstrainRegion=function(){var n=this,i=n.dragHd.el,t;return n.headerCt.forceFit&&(t=n.dragHd.nextNode("gridcolumn:not([hidden]):not([isGroupHeader])"),n.headerInSameGrid(t)||(t=null)),n.adjustConstrainRegion(Ext.util.Region.getRegion(i),0,n.headerCt.forceFit?t?t.getWidth()-n.minColWidth:0:n.maxColWidth-i.getWidth(),0,n.minColWidth)})}});Ext.define("Sch.patches.TreeNavigationModel",{extend:Sch.util.Patch,target:"Ext.tree.NavigationModel",overrides:{onAsterisk:function(){if(!this.view.ownerCt.expandAll){this.view.lockingPartner.ownerCt.expandAll();return}this.callParent(arguments)}}});Ext.define("Sch.panel.TimelineTreePanel",{extend:Ext.tree.Panel,mixins:[Sch.mixin.Localizable,Sch.mixin.TimelinePanel],alias:["widget.timelinetree"],useArrows:!0,rootVisible:!1,lockedXType:"treepanel",isTimelineTreePanel:!0,initComponent:function(){this.callParent(arguments);this.getSchedulingView()._initializeTimelineView()}},function(){this.override(Sch.mixin.TimelinePanel.prototype.inheritables()||{})});Ext.define("Sch.patches.NodeCollapse",{onClassMixedIn:function(n){Ext.versions.extjs.isLessThan("6.0.1")&&n.override(this.prototype.overridables)},overridables:{initComponent:function(){this.callParent(arguments);var n=this.lockedGrid.getView();this.mon(this.resourceStore,{nodecollapse:function(){n._doNotStoreScrollPosition=!0}});n.syncRowHeightBegin=Ext.Function.createInterceptor(n.syncRowHeightBegin,function(){if(!n._doNotStoreScrollPosition){var t={x:n.getScrollX(),y:n.getScrollY()};this.lockedGrid.on("afterlayout",function(){n.scrollTo(t.x,t.y);delete n._doNotStoreScrollPosition},this,{single:!0})}},this)}}});Ext.define("Sch.panel.SchedulerTree",{extend:Sch.panel.TimelineTreePanel,mixins:[Sch.mixin.SchedulerPanel,Sch.patches.NodeCollapse],alias:["widget.schedulertree"],viewType:"schedulergridview",setOrientation:function(){return this.setMode.apply(this,arguments)},setMode:function(n){n!=="horizontal"&&Ext.Error.raise("Sch.panel.SchedulerTree only support horizontal mode")},initComponent:function(){this.callParent(arguments);this.getSchedulingView()._initializeSchedulerView()}},function(){this.override(Sch.mixin.SchedulerPanel.prototype.inheritables()||{})});Ext.define("Sch.patches.CellEditing",{extend:Sch.util.Patch,target:"Ext.grid.plugin.CellEditing",maxVersion:"6.1.0",overrides:{activateCell:function(n){var i=this.callParent(arguments),t;return!i||(t=this.getEditor(n.record,n.column),t&&(t.el.skipGarbageCollection=!0,t.el.select("*").each(function(n){Ext.get(n).skipGarbageCollection=!0}))),i}}});Ext.define("Sch.plugin.CurrentTimeLine",{extend:Sch.plugin.Lines,alias:"plugin.scheduler_currenttimeline",mixins:[Sch.mixin.Localizable],updateInterval:6e4,showHeaderElements:!0,autoUpdate:!0,expandToFitView:!0,timer:null,init:function(){Ext.getVersion("touch")&&(this.showHeaderElements=!1);var n=new Ext.data.JsonStore({fields:["Date","Cls","Text"],data:[{Date:new Date,Cls:"sch-todayLine",Text:this.L("tooltipText")}]}),t=n.first();this.autoUpdate&&(this.timer=setInterval(function(){t.set("Date",new Date)},this.updateInterval));this.store=n;this.callParent(arguments)},destroy:function(){this.timer&&(clearInterval(this.timer),this.timer=null);this.store.autoDestroy&&this.store.destroy();this.callParent(arguments)}});Ext.define("Sch.plugin.exporter.AbstractExporter",{extend:Ext.util.Observable,mixins:[Sch.mixin.Localizable],pageHeaderHeight:41,pageFooterHeight:0,bufferedHeightMargin:25,isExporter:!0,paperWidth:0,paperHeight:0,printHeight:0,lockedRowsHeight:0,normalRowsHeight:0,iterateTimeout:10,tableSelector:undefined,currentPage:undefined,headerTplDataFn:null,footerTplDataFn:null,headerTplDataFnScope:null,footerTplDataFnScope:null,config:{exporterId:"abstractexporter",name:"",translateURLsToAbsolute:!0,expandAllBeforeExport:!1,headerTpl:'<div class="sch-export-header" style="height:{height}px; width:{width}px"><h2>{pageNo}/{totalPages}<\/h2><\/div>',tpl:'<!DOCTYPE html><html class="'+Ext.baseCSSPrefix+'border-box {htmlClasses}"><head><meta content="text/html; charset=UTF-8" http-equiv="Content-Type" /><title>{title}<\/title>{styles}<\/head><body class="'+Ext.baseCSSPrefix+'webkit sch-export {bodyClasses}">{header}<div class="{componentClasses}" style="height:{bodyHeight}px; width:{totalWidth}px; position: relative !important">{HTML}<\/div>{footer}<\/body><\/html>',footerTpl:"",rowVisibilityThreshold:.6},callbacks:undefined,error:undefined,extractedPages:undefined,numberOfPages:0,firstExportedRowOffset:0,secondaryCanvasOffset:0,constructor:function(n){var t=this;n=n||{};t.callParent(arguments);delete n.getUserHeaderTplData;delete n.getUserFooterTplData;t.initConfig(n);n.tableSelector||(t.tableSelector="."+Ext.baseCSSPrefix+"grid-item-container");n.name||t.setName(t.L("name"))},setHeaderTpl:function(n){this.headerTpl=this.getTplInstance(n)},getHeaderTpl:function(){return this.headerTpl},setTpl:function(n){this.tpl=this.getTplInstance(n)},getTpl:function(){return this.tpl},setFooterTpl:function(n){this.footerTpl=this.getTplInstance(n)},getFooterTpl:function(){return this.footerTpl},getTplInstance:function(n){return n&&!n.isTemplate?new Ext.XTemplate(n,{disableFormats:!0}):n},getBodyClasses:function(){var t=new RegExp(Ext.baseCSSPrefix+"ie\\d?|"+Ext.baseCSSPrefix+"gecko","g"),n=document.body.className.replace(t,"");return Ext.isIE&&(n+=" sch-ie-export"),n},getComponentClasses:function(){return this.getComponent().el.dom.className},setComponent:function(n){var t=this;t.component=n;t.view=n.getSchedulingView();t.normalGrid=n.normalGrid;t.lockedGrid=n.lockedGrid;t.normalView=n.normalGrid.view;t.lockedView=n.lockedGrid.view;t.lockedBodySelector="#"+t.lockedView.getId();t.normalBodySelector="#"+t.normalView.getId();t.lockedHeader=t.lockedGrid.headerCt;t.normalHeader=t.normalGrid.headerCt;t.headerHeight=t.normalHeader.getHeight();t.printHeight=Math.floor(t.paperHeight)-t.headerHeight-(t.exportConfig.showHeader?t.pageHeaderHeight:0)-(t.exportConfig.showFooter?t.pageFooterHeight:0);t.saveComponentState(n)},getComponent:function(){return this.component},setPaperSize:function(n,t){var i=this;t==="landscape"?(i.paperWidth=n.height,i.paperHeight=n.width):(i.paperWidth=n.width,i.paperHeight=n.height)},getPaperFormat:function(){return this.exportConfig.format},isBuffered:function(){return!!this.getBufferedRenderer()},getBufferedRenderer:function(){return this.view.bufferedRenderer},setComponentRange:function(n){var r=this,u=r.getComponent(),f,i,t,e,o;if(n.range!=="complete"){f=r.view;switch(n.range){case"date":i=new Date(n.dateFrom);t=new Date(n.dateTo);Sch.util.Date.getDurationInDays(i,t)<1&&(t=Sch.util.Date.add(t,Sch.util.Date.DAY,1));break;case"current":e=f.getVisibleDateRange();i=e.startDate;t=e.endDate||f.timeAxis.getEnd();break;case"completedata":o=u.getEventStore().getTotalTimeSpan();i=o.start;t=o.end}i&&t&&u.setTimeSpan(i,t)}r.ticks=u.timeAxis.getTicks();n.rowsRange=n.rowsRange=="visible"?r.findVisibleRowsRange():null},getStylesheets:function(){var t=this.getTranslateURLsToAbsolute(),i=Ext.getDoc().select('link[rel="stylesheet"]'),n="";return i.each(function(i){var r=i.dom.cloneNode(!0);t&&r.setAttribute("href",i.dom.href);n+=r.outerHTML}),n},forEachTimeSpanPlugin:function(n,t,i){var e,u,r,o,f;if(Sch.feature&&Sch.feature.AbstractTimeSpan)for(e=this,u=(n.plugins||[]).concat(n.normalGrid.plugins||[]).concat(n.columnLinesFeature||[]),r=0,o=u.length;r<o;r++)f=u[r],f instanceof Sch.feature.AbstractTimeSpan&&t.call(i||e,f)},setCellSize:function(n){var t=this;t.timeColumnWidth=n[0];t.timeColumnWidth&&this.getComponent().setTimeColumnWidth(t.timeColumnWidth);n.length>1&&t.view.setRowHeight(n[1])},findVisibleRowsRange:function(){for(var u,t=this,i=t.lockedView.all,o=i.startIndex,s=i.endIndex,r=!1,f=-1,e=-1,n=o;n<=s;n++)if(u=i.item(n,!0),t.isRowVisible(u,t.lockedBox))r||(f=n,r=!0),e=n;else if(r)break;return[f,e]},prepareComponent:function(n,t){var i=this;n=n||i.getComponent();i.suspendInfiniteScroll(n);i.forEachTimeSpanPlugin(n,function(n){n._renderDelay=n.renderDelay;n.renderDelay=0});n.getSchedulingView().timeAxisViewModel.suppressFit=!0;n.timeAxis.autoAdjust=!1;n.normalGrid.expand();n.lockedGrid.expand();i.lockedBox=i.lockedView.getBox();i.normalBox=i.normalView.getBox();i.setComponentRange(t);t.cellSize&&i.setCellSize(t.cellSize);t.beforeExport&&t.beforeExport(n,i.ticks);i.prepareColumns(t.columns);i.expandAllBeforeExport&&n.expandAll&&n.expandAll();i.fitComponentIntoPage();i.view.timeAxisViewModel.setTickWidth(i.view.timeAxisViewModel.getTickWidth());i.view.timeAxisViewModel.setTickWidth(i.view.timeAxisViewModel.getTickWidth());i.isBuffered()&&Ext.isIE8&&(i.normalView.bufferedRenderer.variableRowHeight=!1,i.lockedView.bufferedRenderer.variableRowHeight=!1)},prepareColumns:function(n){var t=this;n&&t.lockedGrid.headerCt.items.each(function(t){Ext.Array.contains(n,t)?t.show():t.hide()})},restoreComponent:function(n){var t=this;n=n||t.getComponent();t.forEachTimeSpanPlugin(n,function(n){n.renderDelay=n._renderDelay;delete n._renderDelay});t.restoreComponentState(n);t.restoreInfiniteScroll(n);t.exportConfig.afterExport&&t.exportConfig.afterExport(n)},saveComponentState:function(n){n=n||this.getComponent();var u=this,t=n.getSchedulingView(),i=n.normalGrid,r=n.lockedGrid,f=[];r.headerCt.items.each(function(n){f.push({column:n,visible:!n.isHidden()})});u.restoreSettings={width:n.getWidth(),height:n.getHeight(),rowHeight:t.timeAxisViewModel.getViewRowHeight(),columnWidth:t.timeAxisViewModel.getTickWidth(),startDate:n.getStart(),endDate:n.getEnd(),normalWidth:i.getWidth(),normalLeft:i.getEl().getStyle("left"),lockedWidth:r.getWidth(),lockedCollapse:r.collapsed,normalCollapse:i.collapsed,columns:f,autoAdjust:n.timeAxis.autoAdjust,suppressFit:t.timeAxisViewModel.suppressFit,startIndex:t.all.startIndex,lockedScrollX:u.lockedView.getScrollX(),normalScrollX:t.getScrollX(),scrollY:t.getScrollY()}},restoreComponentState:function(n){var i=this,t,r;n=n||i.getComponent();t=i.restoreSettings;r=n.getSchedulingView();n.timeAxis.autoAdjust=t.autoAdjust;n.normalGrid.show();n.setWidth(t.width);n.setHeight(t.height);n.setTimeSpan(t.startDate,t.endDate);n.setTimeColumnWidth(t.columnWidth,!0);r.setRowHeight(t.rowHeight);Ext.Array.each(t.columns,function(n){n.column.setVisible(n.visible)});n.lockedGrid.show();n.normalGrid.setWidth(t.normalWidth);n.normalGrid.getEl().setStyle("left",t.normalLeft);n.lockedGrid.setWidth(t.lockedWidth);r.timeAxisViewModel.suppressFit=t.suppressFit;r.timeAxisViewModel.setTickWidth(t.columnWidth);t.lockedCollapse&&n.lockedGrid.collapse();t.normalCollapse&&n.normalGrid.collapse();i.restoreComponentScroll(t);i.getBufferedRenderer()&&Ext.isIE8&&(i.normalView.bufferedRenderer.variableRowHeight=!0,i.lockedView.bufferedRenderer.variableRowHeight=!0)},restoreComponentScroll:function(n){var t=this;t.lockedView.setScrollX(n.lockedScrollX);t.normalView.scrollTo(n.normalScrollX,n.scrollY)},extractPages:function(n,t,i,r){var u=this;if(!i)throw'Sch.plugin.exporter.AbstractExporter: [extractPages] "callback" has to be provided.';u.enableGarbageCollector=Ext.enableGarbageCollector;Ext.enableGarbageCollector=!1;Ext.dom.GarbageCollector.pause();u.exportConfig=t;u.normalRows=[];u.lockedRows=[];u.extractedPages=[];u.numberOfPages=0;u.lockedRowsHeight=0;u.normalRowsHeight=0;u.firstExportedRowOffset=0;u.secondaryCanvasOffset=0;u.setPaperSize(t.pageSize,t.orientation);u.setComponent(n,t);u.prepareComponent(n,t);u.callbacks={success:i,scope:r||u};setTimeout(function(){u.collectRows(u.onRowsCollected,u,t)},1)},onPagesExtracted:function(n){var t=this;t.restoreComponent();t.submitPages(n)},submitPages:function(n){var t=this,i=t.callbacks;i.success.call(i.scope,t.renderPages(n));Ext.enableGarbageCollector=t.enableGarbageCollector;Ext.dom.GarbageCollector.resume()},getCurrentPage:function(){return this.currentPage},setCurrentPage:function(n){this.currentPage=n},getExpectedNumberOfPages:function(){throw"Sch.plugin.exporter.AbstractExporter: [getExpectedNumberOfPages] Abstract method called.";},commitPage:function(n){var t=this,i,r;t.numberOfPages++;i=t.preparePageToCommit(n);t.fireEvent("beforecommitpage",t,i,t.numberOfPages,t.getExpectedNumberOfPages());r=Ext.apply({html:i.dom.innerHTML,number:t.numberOfPages},n);t.extractedPages.push(r);t.fireEvent("commitpage",t,r,t.numberOfPages,t.getExpectedNumberOfPages())},collectLockedRow:function(n,t){var r=Ext.fly(n).getHeight(),i;return this.lockedRowsHeight+=r,i={height:r,row:n.cloneNode(!0),record:this.lockedView.getRecord(t)},this.lockedRows.push(i),i},collectNormalRow:function(n,t){var r=Ext.fly(n).getHeight(),i;return this.normalRowsHeight+=r,i={height:r,row:n.cloneNode(!0),record:this.normalView.getRecord(t)},this.normalRows.push(i),i},onRowsCollected:function(){throw"Sch.plugin.exporter.AbstractExporter: [onRowsCollected] Abstract method called.";},iterateAsync:function(n,t){var i=this,r;t=t||i;r=function(){var u=arguments,f=setInterval(function(){clearInterval(f);n.apply(t,[].concat.apply([r],u))},i.iterateTimeout)};r.apply(i,Ext.Array.slice(arguments,2))},callAsync:function(n,t){t=t||this;var i=setInterval(function(){clearInterval(i);n.apply(t,Ext.Array.slice(arguments,2))},this.iterateTimeout)},collectRows:function(n,t,i){var r=this,u=0,f=r.isBuffered();i.rowsRange&&(u=i.rowsRange[0],f=!(i.rowsRange[0]>=r.view.all.startIndex&&i.rowsRange[1]<=r.view.all.endIndex));f?setTimeout(function(){r.scrollTo(u,function(){u&&r.initFirstExportedRowOffset(u);r.iterateAsync(r.collectRowsStep,r,u,n,t,i)})},1):(u&&r.initFirstExportedRowOffset(u),setTimeout(function(){r.collectRowsStep(null,u,n,t,i)},1))},initFirstExportedRowOffset:function(n){this.firstExportedRowOffset=this.view.el.getScrollTop()-this.view.el.getTop()+Ext.fly(this.view.getNode(n)).getTop()},isRowVisible:function(n,t){var i=Ext.fly(n),r=i.getTop(),u=i.getHeight(),e=r+u,f=(1-this.getRowVisibilityThreshold())*u;return r+f>t.top&&e-f<t.bottom},collectRowsStep:function(n,t,i,r,u){var f=this,s=f.normalView.all.endIndex,c=f.component.store.getCount(),l=u.rowsRange,a=f.normalView.all.slice(t),v=f.lockedView.all.slice(t),o=0,y,h,e;for(l&&(y=l[1]),h=!1,e=t;o<a.length;o++){if(e>y){h=!0;break}v[o]&&f.collectLockedRow(v[o],e,u);f.collectNormalRow(a[o],e,u);e++}f.fireEvent("collectrows",f,t,e,c);!h&&f.isBuffered()?s+1<c?f.callAsync(function(){f.scrollTo(s+1,function(){n(s+1,i,r,u)})}):f.callAsync(function(){f.scrollTo(0,function(){i.call(r||f,f.lockedRows,f.normalRows)})}):i.call(r||f,f.lockedRows,f.normalRows)},renderPages:function(n){var r=this,t,u,i;for(n=n||r.extractedPages,t=0,u=n.length;t<u;t++)i=n[t],i.html=r.applyPageTpl(i);return n},applyPageTpl:function(n){var t=this;return t.getTpl().apply(t.getPageTplData(n))},applyHeaderTpl:function(n){var t=this,r=t.getHeaderTpl(),i,u;return t.exportConfig.showHeader&&r?(i=t.headerTplDataFn,u=i&&i.call(t.headerTplDataFnScope||t,n),r.apply(Ext.apply(t.getHeaderTplData(n),u))):""},applyFooterTpl:function(n){var t=this,r=t.getFooterTpl(),i,u;return t.exportConfig.showFooter&&r?(i=t.footerTplDataFn,u=i&&i.call(t.footerTplDataFnScope||t,n),r.apply(Ext.apply(t.getFooterTplData(n),u))):""},getHeaderTplData:function(n){var t=this;return{width:t.paperWidth,height:t.pageHeaderHeight,totalPages:t.numberOfPages,pageNo:n.number}},getFooterTplData:function(n){var t=this;return{width:t.paperWidth,height:t.pageFooterHeight,totalPages:t.numberOfPages,pageNo:n.number}},getPageTplData:function(n){var t=this;return{bodyClasses:t.getBodyClasses(),bodyHeight:t.printHeight+t.headerHeight,componentClasses:t.getComponentClasses(),styles:t.getStylesheets(),showHeader:t.exportConfig.showHeader,showFooter:t.exportConfig.showFooter,header:t.applyHeaderTpl(n),HTML:n.html,footer:t.applyFooterTpl(n),totalWidth:t.paperWidth,pageNo:n.number,totalPages:t.numberOfPages,title:n.number+" of "+t.numberOfPages}},fitComponentIntoPage:Ext.emptyFn,getLockedGridBody:function(n){return n=n||this.getCurrentPage(),n.down(this.lockedBodySelector+" "+this.tableSelector,!0)},getNormalGridBody:function(n){return n=n||this.getCurrentPage(),n.down(this.normalBodySelector+" "+this.tableSelector,!0)},emptyLockedGrid:function(n){Ext.fly(this.getLockedGridBody(n)).select(this.lockedView.getItemSelector()).remove()},fillGrids:function(n,t,i,r){var u=this;u.fillLockedGrid(n,i,r);u.fillNormalGrid(t,i,r)},fillLockedGrid:function(n,t,i){var r=this;i||r.emptyLockedGrid();r.appendRows(r.getLockedGridBody(),n||r.lockedRows,t)},fillNormalGrid:function(n,t,i){var r=this;i||r.emptyNormalGrid();r.appendRows(r.getNormalGridBody(),n||r.normalRows,t)},appendRows:function(n,t,i){for(var r=0,u=t.length;r<u;r++)n.appendChild(i?t[r].row.cloneNode(!0):t[r].row)},emptyNormalGrid:function(n){Ext.fly(this.getNormalGridBody(n)).select(this.normalView.getItemSelector()).remove()},getRowHeight:function(){return this.view.timeAxisViewModel.getViewRowHeight()},getTotalSize:function(){return{width:this.getTotalWidth(),height:this.getTotalHeight()}},getTotalHeight:function(){var n=this,t;return t=n.isBuffered()?n.bufferedHeightMargin+n.normalRowsHeight:n.lockedView.getEl().down(n.tableSelector).getHeight(),n.headerHeight+t},getTotalWidth:function(){return this.getLockedGridWidth()+this.normalGrid.body.down(this.tableSelector).getWidth()},getLockedGridWidth:function(){return this.lockedHeader.getEl().first().getWidth()},getNormalGridWidth:function(){return this.normalHeader.getEl().first().getWidth()},preparePageToCommit:function(){var t=this.getCurrentPage(),r=this.component,f=r.lockedGrid,i=r.normalGrid,e=t.down(".sch-secondary-canvas",!0),l,o,s,u,h;t.select(".sch-remove").remove();var n=function(n){return t.down("#"+n,!0)},c=function(n){n&&(n.style.width="100%")},a=function(n){n&&(n.style.height="100%")},v=t.down(this.normalBodySelector,!0);return v.style.top="0px",l=t.down(this.lockedBodySelector,!0),l.style.top="0px",(o=this.getLockedGridBody())&&(Ext.isIE9m?o.style.top="":o.style.transform=""),(s=this.getNormalGridBody())&&(Ext.isIE9m?s.style.top="":s.style.transform=""),e&&(e.style.top=this.secondaryCanvasOffset+"px",Ext.fly(e).select(".sch-column-line").setHeight(this.normalRowsHeight)),u=[n(r.id+"-targetEl"),n(r.id+"-innerCt"),n(f.id),n(f.body.id),n(f.view.el.id)],Ext.Array.each(u,a),c(u[0]),c(u[1]),Ext.isIE?(h=n(i.headerCt.id),h&&(h.style.width="")):c(n(i.headerCt.id)),Ext.Array.each([n(i.id),n(i.body.id),n(i.getView().id)],function(n){n&&(n.style.height=n.style.width="100%")}),t},startPage:function(n){var t=this,i=(n||t.getComponent().body).dom.cloneNode(!0);i.id="";t.setCurrentPage(Ext.get(i))},scrollTo:function(n,t,i){var r=this,u;r.component.ensureVisible?(u=r.component.store.getAt(n),r.component.ensureVisible(u,{callback:function(){t&&this.isLocked===!1&&t.apply(i||r)},select:!1,focus:!1,animate:!1})):r.lockedView.bufferedRenderer.scrollTo(n,!1,function(){r.normalView.bufferedRenderer.scrollTo(n,!1,t,i||r)})},removeNode:function(n){var t,i;if(n&&n.parentNode)n.parentNode.removeChild(n);else if(n.elements)for(t=0;t<n.elements.length;t++)i=n.elements[t],i.parentNode.removeChild(i)},restoreInfiniteScroll:function(n){var t=n.getSchedulingView();n.infiniteScroll&&t.rendered&&(n.timeAxis.setTimeSpan(this._oldStart,this._oldEnd),t.setScrollX(this._oldScrollX),t.bindInfiniteScrollListeners())},suspendInfiniteScroll:function(n){var t=n.getSchedulingView(),i;n.infiniteScroll&&t.rendered&&(t.unbindInfiniteScrollListeners(),this._oldStart=n.timeAxis.getStart(),this._oldEnd=n.timeAxis.getEnd(),this._oldScrollX=t.getScrollX(),i=n.getEventStore().getTotalTimeSpan(),n.setTimeSpan(i.start,i.end))}});Ext.define("Sch.plugin.exporter.SinglePage",{extend:Sch.plugin.exporter.AbstractExporter,config:{exporterId:"singlepage",headerTpl:'<div class="sch-export-header" style="height:{height}px; width:{width}px"><\/div>'},getExpectedNumberOfPages:function(){return 1},getPaperFormat:function(){var n=this,t=n.getTotalSize(),i=n.exportConfig.DPI,r=Ext.Number.toFixed(t.width/i,1),u=Ext.Number.toFixed(t.height/i,1);return r+"in*"+u+"in"},onRowsCollected:function(){var n=this;n.startPage();n.fillGrids();n.commitPage();n.onPagesExtracted()},getPageTplData:function(){var n=this,t=n.getTotalSize();return Ext.apply(n.callParent(arguments),{bodyHeight:t.height,showHeader:!1,totalWidth:t.width})},getHeaderTplData:function(){var n=this;return{width:n.getTotalWidth(),height:n.pageHeaderHeight}},fitComponentIntoPage:function(){var t=this,n=t.lockedGrid;n.setWidth(n.headerCt.getEl().first().getWidth())},preparePageToCommit:function(){var t=this,i=t.callParent(arguments),n=i.select(".sch-secondary-canvas").first(),u=n.select(".sch-zone"),f=n.select(".sch-column-line"),r=t.getTotalHeight();return n.setTop(0),u.setHeight(r),f.setHeight(r),i}});Ext.define("Sch.plugin.exporter.MultiPage",{extend:Sch.plugin.exporter.AbstractExporter,config:{exporterId:"multipage"},rowPageIndex:0,columnPageIndex:0,pagesPerColumn:0,onRowsCollected:function(n,t){var i=this;i.rowPageIndex=0;i.columnPageIndex=0;i.pagesPerColumn=0;i.buildPageFrames(function(){i.buildPages(i.onPagesExtracted,i,n,t)})},buildPages:function(n,t,i,r){var u=this,f=u.pageFrames[0];u.startPage(f,!0);this.iterateAsync(u.rowIteratorStep,u,{rowIndex:0,pageFrame:f,rowsHeight:0,leftHeight:this.printHeight,lockeds:[],normals:[],lockedRows:i,normalRows:r,callback:n,scope:t||u})},rowIteratorStep:function(n,t){var i=this,e=t.rowIndex,c=t.lockedRows,s=t.normalRows,l=t.leftHeight,u=t.lockeds,f=t.normals,h=!0,o,r;if(e<s.length)o=c[e],r=s[e],r.height<=l?(u.push(o),f.push(r),t.leftHeight-=r.height,t.rowsHeight+=r.height,h=!1):(i.fillGrids(u,f,t.pageFrame),i.commitPage({rowsHeight:t.rowsHeight}),i.startPage(t.pageFrame),t.lockeds=[o],t.normals=[r],t.leftHeight=i.printHeight-r.height,t.rowsHeight=r.height),t.rowIndex++;else if(i.columnPageIndex<i.pageFrames.length)i.fillGrids(u,f,t.pageFrame),i.commitPage({rowsHeight:t.rowsHeight}),t.pageFrame=i.pageFrames[i.columnPageIndex],i.startPage(t.pageFrame,!0),t.leftHeight=i.printHeight,t.rowsHeight=0,t.lockeds=[],t.normals=[],t.rowIndex=0;else{i.fillGrids(u,f,t.pageFrame);i.commitPage({rowsHeight:t.rowsHeight});t.callback.call(t.scope);return}h?n(t):i.rowIteratorStep(n,t)},fillGrids:function(n,t,i){var r=this,u=r.lockedColumnPages[r.columnPageIndex-1],f=!u||u&&u.leftWidth;u&&(r.fillLockedGrid(n,!0),r.removeHiddenLockedColumns(u));f&&(r.fillNormalGrid(t,!0),r.removeInvisibleEvents(-i.normalGridOffset,-i.normalGridOffset+i.normalGridWidth))},buildPageFrame:function(n,t){var i=this,u=i.lockedColumnPages[n],r,f;if(u?(i.lockedGrid.setWidth(i.showLockedColumns(u.start,u.end)+(u.startOffset||0)),u.leftWidth?i.normalGrid.show():i.normalGrid.hide()):(i.lockedGrid.setWidth(0),i.lockedGrid.hide(),i.normalGrid.show()),r=i.getComponent().body.dom.cloneNode(!0),r.id="",r=Ext.get(r),r.normalGridOffset=t,r.lockedGridOffset=u&&u.startOffset||0,r.normalGridWidth=i.normalGrid.getWidth(),r.lockedGridWidth=i.lockedGrid.getWidth(),r.down(i.lockedBodySelector,!0).style.position="",r.down("#"+i.lockedView.id,!0).style.overflow="visible",!i.normalGrid.hidden){f=r.select(i.normalBodySelector).first();f.dom.style.position="";f.dom.style.top="0px";var o=i.getNormalGridBody(r),e=r.down("#"+i.normalView.headerCt.id,!0),s=r.down(".sch-secondary-canvas",!0),h=r.down("#"+i.normalView.id,!0);o.style.left=t+"px";e.style.left=t+"px";e.style.overflow="visible";s.style.left=t+"px";h.style.overflow="visible"}return r},buildPageFrames:function(n,t){var i=this,u,r;t=t||i;i.lockedColumnPages=i.calculateLockedColumnPages();u=Math.ceil(i.getTotalWidth()/i.paperWidth);r=i.pageFrames=[];i.iterateAsync(function(f,e,o){if(e>=u){n.call(t,r);return}r.push(i.buildPageFrame(e,o));var s=i.lockedColumnPages[e];o-=s?s.leftWidth||0:i.paperWidth;f(e+1,o)},i,0,0)},startPage:function(n,t){var i=this;t&&(i.columnPageIndex==1&&(i.pagesPerColumn=i.extractedPages.length),i.rowPageIndex=0,i.columnPageIndex++,i.secondaryCanvasOffset=i.firstExportedRowOffset);i.rowPageIndex++;i.callParent(arguments);i.emptyNormalGrid();i.emptyLockedGrid()},commitPage:function(n){var t=this;t.callParent([Ext.apply({row:t.rowPageIndex,column:t.columnPageIndex},n)]);t.secondaryCanvasOffset-=n.rowsHeight},getExpectedPagesPerColumn:function(){return this.pagesPerColumn||Math.ceil((this.normalRowsHeight||this.component.store.count()*this.component.getRowHeight())/this.printHeight)},getExpectedColumnsNumber:function(){return this.pageFrames?this.pageFrames.length:Math.ceil((this.lockedGrid.getWidth()+this.ticks.length*this.view.timeAxisViewModel.getTickWidth())/this.paperWidth)},getExpectedNumberOfPages:function(){return this.getExpectedColumnsNumber()*this.getExpectedPagesPerColumn()},calculateLockedColumnPages:function(){for(var e,r,u=this,f=[],o=u.lockedColumns,i=u.paperWidth,n,t=0,s=o.length;t<s;t++)e=o[t],r=e.width,n=n||{start:t,end:t},i-=r,i<0?(f.push(n),i&&(n={start:t,end:t}),i=u.paperWidth-r+i):n.end=t;return n&&(n.leftWidth=i,f.push(n)),f},getPageTplData:function(n){return Ext.apply(this.callParent(arguments),{title:n.number+" of "+this.numberOfPages+" (column: "+n.column+", row: "+n.row+")"})},showLockedColumns:function(n,t){var e=this,u=e.lockedColumns,f=0,i,r;for(n=n||0,t=t||u.length-1,i=0;i<u.length;i++)r=u[i],i>=n&&i<=t?(r.column.show(),f+=r.width):r.column.hide();return f},removeInvisibleEvents:function(n,t){var i=this,r=i.getNormalGridBody(),u=i.normalView.eventSelector;Ext.Array.each(Ext.fly(r).select(u).elements,function(r){var u=parseInt(r.style.left,10),f=u+parseInt(r.style.width,10);(f<n||u>t)&&i.removeNode(r)})},removeHiddenLockedColumns:function(n){for(var r,u,f,e,o,t=this,s=t.getCurrentPage(),h=t.getLockedGridBody(),i=0;i<t.lockedColumns.length;i++)r=t.lockedColumns[i].column,(i<n.start||i>n.end)&&(u="#"+r.getId(),f=s.select(u),t.removeNode(f),e=r.getCellSelector(),o=Ext.fly(h).select(e),t.removeNode(o))},fitComponentIntoPage:function(){var n=this,t=n.getComponent();t.setWidth(n.paperWidth)},prepareComponent:function(){var n=this,t=n.lockedColumns=[];n.callParent(arguments);n.lockedGrid.headerCt.items.each(function(n){n.hidden||t.push({column:n,width:n.getWidth()})})},restoreComponentState:function(){this.callParent(arguments);this.showLockedColumns()},preparePageToCommit:function(){var n=this,t=n.callParent(arguments),i=t.down("."+Ext.baseCSSPrefix+"splitter",!0),r=n.pageFrames[n.columnPageIndex-1];return i&&(r.lockedHidden?(i.style.display="none",t.down("."+Ext.baseCSSPrefix+"grid-inner-normal",!0).style.left=0):Ext.fly(i).setHeight("100%")),t}});Ext.define("Sch.plugin.exporter.MultiPageVertical",{extend:Sch.plugin.exporter.AbstractExporter,config:{exporterId:"multipagevertical"},minRowHeight:20,minAverageColumnWidth:100,visibleColumns:null,visibleColumnsWidth:0,onRowsCollected:function(n,t){var i=this;i.iterateAsync(function(r,u){if(u===t.length){i.onPagesExtracted();return}var f=u,h=i.printHeight,o=0,c=[],l=[],a=!1,e,s;for(i.startPage();!a&&f<t.length;)e=t[f],s=n[f],h-=e.height,h>0?(o+=e.height,s&&c.push(s),l.push(e),f++):a=!0;i.fillGrids(c,l);i.commitPage({rowIndex:f,rowsHeight:o});i.secondaryCanvasOffset-=o;r(f)},i,0)},startPage:function(){var n=this,t;n.callParent(arguments);t=n.getCurrentPage().select("#"+n.lockedView.id).first();t.dom.style.overflow="visible"},getExpectedNumberOfPages:function(){return Math.ceil(this.normalRowsHeight/this.printHeight)},prepareColumns:function(){this.callParent(arguments);var n=this,t=n.visibleColumns=[];n.visibleColumnsWidth=0;n.lockedGrid.headerCt.items.each(function(i){i.hidden||(t.push({column:i,width:i.getWidth()}),n.visibleColumnsWidth+=i.getWidth())})},fitComponentIntoPage:function(){var n=this,i=n.getComponent(),o=i.getSchedulingView(),s=i.normalGrid,h=i.lockedGrid,c=n.getTotalWidth(),l=n.ticks,a=n.timeColumnWidth||o.timeAxisViewModel.getTickWidth(),t=Math.floor(n.visibleColumnsWidth/c*n.paperWidth),v=n.visibleColumns.length,r=v*n.minAverageColumnWidth;r=r>n.paperWidth/2?Math.floor(n.paperWidth/2):r;t=r>t?r:t;var u=n.paperWidth-t,f=u/l.length,e=f/a*n.getRowHeight();n.view.setRowHeight(e<n.minRowHeight?n.minRowHeight:e);i.setWidth(n.paperWidth);s.setWidth(u);h.setWidth(t);n.fitLockedColumnWidth(t);i.setTimeColumnWidth(f)},fitLockedColumnWidth:function(n){var u=this,i=this.visibleColumns,f=n/u.visibleColumnsWidth,t;if(i.length){for(t=0;t<i.length;t++){var r=i[t],e=r.width,o=Math.floor(e*f);r.column.setWidth(o)}this._restoreColumnWidth=!0}},restoreComponentState:function(n){var u=this,i,t,r;if(n=n||u.getComponent(),this._restoreColumnWidth)for(i=this.visibleColumns,t=0;t<i.length;t++)r=i[t],r.column.setWidth(r.width);this.callParent(arguments)}});Ext.define("Sch.widget.ResizePicker",{extend:Ext.Panel,alias:"widget.dualrangepicker",width:200,height:200,border:!0,collapsible:!1,bodyStyle:"position:absolute; margin:5px",verticalCfg:{height:120,value:24,increment:2,minValue:20,maxValue:80,reverse:!0,disabled:!0},horizontalCfg:{width:120,value:100,minValue:25,increment:5,maxValue:200,disable:!0},initComponent:function(){var n=this;n.horizontalCfg.value=n.dialogConfig.columnWidth;n.verticalCfg.value=n.dialogConfig.rowHeight;n.verticalCfg.disabled=n.dialogConfig.scrollerDisabled||!1;n.dockedItems=[n.vertical=new Ext.slider.Single(Ext.apply({dock:"left",style:"margin-top:10px",vertical:!0,stateful:n.dialogConfig.stateful,stateId:"exporter_resize_vertical",stateEvents:["change"],listeners:{change:n.onSliderChange,changecomplete:n.onSliderChangeComplete,scope:n}},n.verticalCfg)),n.horizontal=new Ext.slider.Single(Ext.apply({dock:"top",style:"margin-left:28px",stateful:n.dialogConfig.stateful,stateId:"exporter_resize_horizontal",stateEvents:["change"],listeners:{change:n.onSliderChange,changecomplete:n.onSliderChangeComplete,scope:n}},n.horizontalCfg))];n.callParent(arguments)},afterRender:function(){var n=this,t;n.addCls("sch-ux-range-picker");n.valueHandle=n.body.createChild({cls:"sch-ux-range-value",cn:{tag:"span"}});n.valueSpan=n.valueHandle.down("span");t=new Ext.dd.DD(n.valueHandle);Ext.apply(t,{startDrag:function(){n.dragging=!0;this.constrainTo(n.body)},onDrag:function(){n.updateValuesFromHandles()},endDrag:function(){n.updateValuesFromHandles();n.dragging=!1}});n.setValues(n.getValues());n.callParent(arguments);n.body.on("click",n.onBodyClick,n)},onBodyClick:function(n){var t=[n.getXY()[0]-8-this.body.getX(),n.getXY()[1]-8-this.body.getY()];this.valueHandle.setLeft(Ext.Number.constrain(t[0],0,this.getAvailableWidth()));this.valueHandle.setTop(Ext.Number.constrain(t[1],0,this.getAvailableHeight()));this.updateValuesFromHandles();this.onSliderChangeComplete()},updateValuesFromHandles:function(){this.setValues(this.getValuesFromXY())},getAvailableWidth:function(){return this.body.getWidth()-18},getAvailableHeight:function(){return this.body.getHeight()-18},getValuesFromXY:function(n){n=n||[this.valueHandle.getLeft(!0),this.valueHandle.getTop(!0)];var t=n[0]/this.getAvailableWidth(),i=n[1]/this.getAvailableHeight(),r=Math.round((this.horizontalCfg.maxValue-this.horizontalCfg.minValue)*t),u=Math.round((this.verticalCfg.maxValue-this.verticalCfg.minValue)*i)+this.verticalCfg.minValue;return[r+this.horizontalCfg.minValue,u]},getXYFromValues:function(n){var t=this.horizontalCfg.maxValue-this.horizontalCfg.minValue,i=this.verticalCfg.maxValue-this.verticalCfg.minValue,r=Math.round((n[0]-this.horizontalCfg.minValue)*this.getAvailableWidth()/t),u=n[1]-this.verticalCfg.minValue,f=Math.round(u*this.getAvailableHeight()/i);return[r,f]},updatePosition:function(){var n=this.getValues(),t=this.getXYFromValues(n);this.valueHandle.setLeft(Ext.Number.constrain(t[0],0,this.getAvailableWidth()));this.verticalCfg.disabled?this.valueHandle.setTop(this.dialogConfig.rowHeight):this.valueHandle.setTop(Ext.Number.constrain(t[1],0,this.getAvailableHeight()));this.positionValueText();this.setValueText(n)},positionValueText:function(){var n=this.valueHandle.getTop(!0),t=this.valueHandle.getLeft(!0);this.valueSpan.setLeft(t>30?-30:10);this.valueSpan.setTop(n>10?-20:20)},setValueText:function(n){this.verticalCfg.disabled&&(n[1]=this.dialogConfig.rowHeight);this.valueSpan.update("["+n.toString()+"]")},setValues:function(n){this.horizontal.setValue(n[0]);this.verticalCfg.reverse?this.verticalCfg.disabled||this.vertical.setValue(this.verticalCfg.maxValue+this.verticalCfg.minValue-n[1]):this.verticalCfg.disabled||this.vertical.setValue(n[1]);this.dragging||this.updatePosition();this.positionValueText();this.setValueText(n)},getValues:function(){if(!this.verticalCfg.disabled){var n=this.vertical.getValue();return this.verticalCfg.reverse&&(n=this.verticalCfg.maxValue-n+this.verticalCfg.minValue),[this.horizontal.getValue(),n]}return[this.horizontal.getValue()]},onSliderChange:function(){this.fireEvent("change",this,this.getValues());this.dragging||this.updatePosition()},onSliderChangeComplete:function(){this.fireEvent("changecomplete",this,this.getValues())},afterLayout:function(){this.callParent(arguments);this.updatePosition()}});Ext.define("Sch.widget.ColumnPicker",{extend:Ext.form.field.ComboBox,multiSelect:!0,valueField:"id",displayField:"name",forceSelection:!0,editable:!1,listConfig:{cls:"sch-columnpicker-list"},columns:null,initComponent:function(){this.store=new Ext.data.Store({proxy:"memory",fields:["id","name","column"],data:this.processColumns(this.columns)});this.callParent(arguments)},processColumns:function(n){var t=[],i=[];return Ext.Array.each(n,function(n){t.push({id:n.id,name:n.text,column:n});n.isHidden()||i.push(n.id)}),this.value=this.value||i,t},getSelectedColumns:function(){var t=this,n=t.getValue();return Ext.isArray(n)||(n=[n]),Ext.Array.map(n,function(n){return t.store.getById(n).get("column")})}});Ext.define("Sch.widget.ExportDialogForm",{extend:Ext.form.Panel,mixins:[Sch.mixin.Localizable],alias:"widget.export_dialog_form",border:!1,bodyPadding:"10 10 0 10",autoHeight:!0,stateful:!0,rangeField:null,resizerHolder:null,resizePicker:null,dateFromField:null,dateToField:null,datesHolder:null,columnPicker:null,rowsRangeField:null,exportersField:null,formatField:null,orientationField:null,dpiField:null,showHeaderField:null,showFooterField:null,dateRangeFormat:"",columnPickerConfig:null,dpiFieldConfig:null,dateRangeRestriction:!0,rangeFieldConfig:null,rowsRangeFieldConfig:null,formatFieldConfig:null,orientationFieldConfig:null,exportersFieldConfig:null,showHeaderFieldConfig:null,showFooterFieldConfig:null,dateFromFieldConfig:null,dateToFieldConfig:null,showResizePicker:!1,showColumnPicker:!0,showDPIField:!0,showShowHeaderField:!0,showShowFooterField:!1,showRowsRangeField:!0,initComponent:function(){var n=this;n.fieldDefaults=Ext.apply({labelAlign:"left",labelWidth:120,anchor:"99%"},n.fieldDefaults);n.items=n.createFields();n.callParent(arguments);n.onRangeChange(n.rangeField,n.rangeField.getValue());n.onExporterChange(n.exportersField,n.exportersField.getValue());n.onOrientationChange(n.orientationField,n.orientationField.getValue());if(!this.rendered)this.on("afterrender",function(){this.onOrientationChange(n.orientationField,n.orientationField.getValue())},this,{single:!0})},isValid:function(){var n=this;return n.rangeField.getValue()=="date"?n.dateFromField.isValid()&&n.dateToField.isValid():!0},getValues:function(n){var t=this.callParent(arguments),i;return t.showHeader=!!t.showHeader,t.showFooter=!!t.showFooter,t.onlyVisibleRows=!!t.onlyVisibleRows,this.resizePicker&&this.rangeField.getValue()=="current"&&(i=this.resizePicker.getValues(),n?t+="&cellSize[0]="+i[0]+"&cellSize[1]="+i[1]:t.cellSize=i),this.columnPicker&&(t.columns=this.columnPicker.getSelectedColumns()),t},createFields:function(){var n=this,i='<table class="sch-fieldcontainer-label-wrap"><td width="1" class="sch-fieldcontainer-label">',r='<td><div class="sch-fieldcontainer-separator"><\/div><\/table>',t;return n.showResizePicker&&(n.resizePicker=new Sch.widget.ResizePicker({dialogConfig:n,margin:"10 20"}),n.resizerHolder=new Ext.form.FieldContainer({fieldLabel:n.scrollerDisabled?n.L("adjustCols"):n.L("adjustColsAndRows"),labelAlign:"top",hidden:!0,labelSeparator:"",beforeLabelTextTpl:i,afterLabelTextTpl:r,layout:"vbox",defaults:{flex:1,allowBlank:!1},items:[n.resizePicker]})),n.dateFromField=Ext.ComponentManager.create(Ext.apply(n.applyStateful({xtype:"datefield",fieldLabel:n.L("dateRangeFromText"),baseBodyCls:"sch-exportdialogform-date",name:"dateFrom",format:n.dateRangeFormat||Ext.Date.defaultFormat,allowBlank:!1,maxValue:n.dateRangeRestriction&&n.endDate||null,minValue:n.dateRangeRestriction&&n.startDate||null,value:n.startDate}),n.dateFromFieldConfig)),n.dateToField=Ext.ComponentManager.create(Ext.apply(n.applyStateful({xtype:"datefield",fieldLabel:n.L("dateRangeToText"),name:"dateTo",format:n.dateRangeFormat||Ext.Date.defaultFormat,baseBodyCls:"sch-exportdialogform-date",allowBlank:!1,maxValue:n.dateRangeRestriction&&n.endDate||null,minValue:n.dateRangeRestriction&&n.startDate||null,value:n.endDate}),n.dateToFieldConfig)),n.datesHolder=new Ext.form.FieldContainer({fieldLabel:n.L("specifyDateRange"),labelAlign:"top",hidden:!0,labelSeparator:"",beforeLabelTextTpl:i,afterLabelTextTpl:r,layout:"vbox",defaults:{flex:1,allowBlank:!1},items:[n.dateFromField,n.dateToField]}),n.showColumnPicker&&(n.columnPicker=new Sch.widget.ColumnPicker(n.applyStateful(Ext.apply({fieldLabel:n.L("columnPickerLabel"),cls:"sch-export-dialog-columns"},n.columnPickerConfig)))),n.showDPIField&&(n.dpiField=Ext.ComponentManager.create(Ext.apply(n.applyStateful({xtype:"numberfield",fieldLabel:n.L("dpiFieldLabel"),cls:"sch-export-dialog-dpi",minValue:65,name:"DPI",value:n.exportConfig.DPI,maxValue:200}),n.dpiFieldConfig))),n.showShowHeaderField&&(n.showHeaderField=Ext.ComponentManager.create(Ext.apply(n.applyStatefulFull({xtype:"checkbox",fieldLabel:n.L("showHeaderLabel"),cls:"sch-export-dialog-header",name:"showHeader",checked:!!n.exportConfig.showHeader,checkedValue:!0,uncheckedValue:!1}),n.showHeaderFieldConfig))),n.showShowFooterField&&(n.showFooterField=Ext.ComponentManager.create(Ext.apply(n.applyStatefulFull({xtype:"checkbox",fieldLabel:n.L("showFooterLabel"),cls:"sch-export-dialog-footer",name:"showFooter",checked:!!n.exportConfig.showFooter,checkedValue:!0,uncheckedValue:!1}),n.showFooterFieldConfig))),n.formatField=Ext.ComponentManager.create(Ext.apply(n.applyStateful({xtype:"combobox",fieldLabel:n.L("formatFieldLabel"),value:n.exportConfig.format,triggerAction:"all",forceSelection:!0,editable:!1,name:"format",queryMode:"local",store:n.pageFormats||["A5","A4","A3","Letter","Legal"]}),n.formatFieldConfig)),n.orientationField=Ext.ComponentManager.create(Ext.apply(n.applyStateful({xtype:"combobox",fieldLabel:n.L("orientationFieldLabel"),value:n.exportConfig.orientation,triggerAction:"all",componentCls:"sch-exportdialogform-orientation",forceSelection:!0,editable:!1,name:"orientation",displayField:"name",valueField:"value",queryMode:"local",store:{fields:["name","value"],data:[{name:n.L("orientationPortraitText"),value:"portrait"},{name:n.L("orientationLandscapeText"),value:"landscape"}]}}),n.orientationFieldConfig)),n.mon(n.orientationField,"change",n.onOrientationChange,n),n.rangeField=Ext.ComponentManager.create(Ext.apply(n.applyStateful({xtype:"combobox",fieldLabel:n.L("rangeFieldLabel"),value:n.exportConfig.range,triggerAction:"all",cls:"sch-export-dialog-range",forceSelection:!0,editable:!1,name:"range",queryMode:"local",displayField:"name",valueField:"value",store:{fields:["name","value"],data:[{name:n.L("completeViewText"),value:"complete"},{name:n.L("completeDataText"),value:"completedata"},{name:n.L("dateRangeText"),value:"date"},{name:n.L("currentViewText"),value:"current"}]}}),n.rangeFieldConfig)),n.mon(n.rangeField,"change",n.onRangeChange,n),n.exportersField=Ext.ComponentManager.create(Ext.apply(n.applyStateful({xtype:"combobox",fieldLabel:n.L("exportersFieldLabel"),value:n.defaultExporter,triggerAction:"all",cls:"sch-export-dialog-exporter",forceSelection:!0,editable:!1,name:"exporterId",queryMode:"local",displayField:"name",valueField:"value",store:{fields:["name","value"],data:Ext.Array.map(n.exporters,function(n){return{name:n.getName(),value:n.getExporterId()}})}}),n.exportersFieldConfig)),n.mon(n.exportersField,"change",n.onExporterChange,n),n.showRowsRangeField&&(n.rowsRangeField=Ext.ComponentManager.create(Ext.apply(n.applyStateful({xtype:"combobox",fieldLabel:n.L("rowsRangeLabel"),value:n.exportConfig.rowsRange,triggerAction:"all",cls:"sch-export-dialog-rowsrange",forceSelection:!0,editable:!1,name:"rowsRange",queryMode:"local",displayField:"name",valueField:"value",store:{fields:["name","value"],data:[{name:n.L("allRowsLabel"),value:"all"},{name:n.L("visibleRowsLabel"),value:"visible"}]}}),n.rowsRangeFieldConfig))),t=[],t.push(n.rangeField),n.resizerHolder&&t.push(n.resizerHolder),t.push(n.datesHolder),n.columnPicker&&t.push(n.columnPicker),n.rowsRangeField&&t.push(n.rowsRangeField),t.push(n.exportersField,n.formatField,n.orientationField),n.dpiField&&t.push(n.dpiField),n.showHeaderField&&t.push(n.showHeaderField),n.showFooterField&&t.push(n.showFooterField),t},applyStateful:function(n){if(!this.stateful)return n;var t=this,i=t.stateId||"exporter";return Ext.applyIf(n,{stateful:!0,stateId:i+"_"+n.name})},applyStatefulFull:function(n){if(!this.stateful)return n;var t=this;return Ext.apply(t.applyStateful(n),{stateEvents:["change"],applyState:t.applyFieldState,getState:t.getFieldState})},getFieldState:function(){return{value:this.getValue()}},applyFieldState:function(n){"value"in n&&this.setValue(n.value)},onOrientationChange:function(n,t){if(this.rendered){var i=n.bodyEl;i.removeCls(["sch-exportdialog-portrait","sch-exportdialog-landscape"]);n.bodyEl.addCls("sch-exportdialog-"+t)}},onRangeChange:function(n,t){switch(t){case"complete":case"completedata":this.datesHolder.hide();this.resizerHolder&&this.resizerHolder.hide();break;case"date":this.datesHolder.show();this.resizerHolder&&this.resizerHolder.hide();break;case"current":this.datesHolder.hide();this.resizerHolder&&(this.resizerHolder.show(),this.resizePicker.expand(!0))}},onExporterChange:function(n,t){switch(t){case"singlepage":this.disableFields(!0);break;default:this.disableFields(!1)}},disableFields:function(n){var t=this;t.showHeaderField&&t.showHeaderField.setDisabled(n);t.formatField.setDisabled(n);t.orientationField.setDisabled(n)}});Ext.define("Sch.widget.ExportDialog",{alternateClassName:"Sch.widget.PdfExportDialog",extend:Ext.window.Window,mixins:[Sch.mixin.Localizable],alias:"widget.exportdialog",width:450,cls:"sch-exportdialog",frame:!1,layout:"fit",draggable:!0,progressBar:null,buttonsPanel:null,buttonsPanelScope:null,form:null,defaultFormXType:"export_dialog_form",exportButtonConfig:null,cancelButtonConfig:null,formConfigs:"pageFormats,startDate,endDate,rowHeight,columnWidth,defaultExporter,exporters,dateRangeFormat,exportConfig,showColumnPicker,columnPickerConfig,showShowHeaderField,showShowFooterField,showResizePicker,stateful,stateId,dateRangeRestriction,showRowsRangeField,rowsRangeFieldConfig,rangeFieldConfig,formatFieldConfig,orientationFieldConfig,exportersFieldConfig",constructor:function(n){Ext.apply(this,n);this.title=this.title||this.L("title");this.callParent(arguments)},mapFormConfigs:function(){var n,r,i,u,t;for(this.form=this.form||{},n=this.form,r=this.formConfigs.split(","),i=0,u=r.length;i<u;i++)t=r[i],this.hasOwnProperty(t)&&!n.hasOwnProperty(t)&&(n[t]=this[t]);this.hasOwnProperty("showFooterField")&&!n.hasOwnProperty("showShowFooterField")&&(n.showShowFooterField=this.showFooterField);this.hasOwnProperty("showHeaderField")&&!n.hasOwnProperty("showShowHeaderField")&&(n.showShowHeaderField=this.showHeaderField)},initComponent:function(){var n=this;n.form&&n.form.isForm||(n.mapFormConfigs(),n.form=n.buildForm());Ext.apply(n,{items:{items:[n.form,n.progressBar||n.buildProgressBar()]},fbar:n.buildButtons(n.buttonsPanelScope||n)});n.callParent(arguments)},afterRender:function(){var n=this;n.form.resizePicker&&n.relayEvents(n.form.resizePicker,["change","changecomplete","select"]);n.callParent(arguments)},buildButtons:function(n){var t=this;return[Ext.apply({xtype:"button",scale:"medium",itemId:"export",text:t.L("exportButtonText"),handler:t.onExportButtonPress,scope:n||t},t.exportButtonConfig),Ext.apply({xtype:"button",scale:"medium",itemId:"cancel",text:t.L("cancelButtonText"),handler:t.onCancelButtonPress,scope:n||t},t.cancelButtonConfig)]},onExportButtonPress:function(){var n,t;this.form.isValid()&&(n=this.form.getValues(),this.beforeExport(),t=this.dateRangeFormat||Ext.Date.defaultFormat,n.dateFrom&&!Ext.isDate(n.dateFrom)&&(n.dateFrom=Ext.Date.parse(n.dateFrom,t)),n.dateTo&&!Ext.isDate(n.dateTo)&&(n.dateTo=Ext.Date.parse(n.dateTo,t)),this.doExportFn.call(this.doExportFnScope||this,n,this.onExportSuccess,this.onExportFailure))},afterExport:function(){var n=this.down("#export");n&&n.enable();this.progressBar&&this.progressBar.hide()},beforeExport:function(){var n=this.down("#export");n&&n.disable();this.progressBar&&this.progressBar.show()},onExportSuccess:function(){this.afterExport()},onExportFailure:function(){this.afterExport()},onCancelButtonPress:function(){this.destroy()},buildForm:function(n){return this.form=Ext.apply(this.form||{},n),Ext.ComponentManager.create(this.form,this.defaultFormXType)},buildProgressBar:function(){return this.progressBar=new Ext.ProgressBar({text:this.L("progressBarText"),animate:!0,hidden:!0,margin:"4px 10px 10px 10px"})}});Ext.define("Sch.plugin.Export",{extend:Ext.util.Observable,alternateClassName:"Sch.plugin.PdfExport",alias:"plugin.scheduler_export",mixins:[Ext.AbstractPlugin,Sch.mixin.Localizable],lockableScope:"top",pageSizes:{A5:{width:5.8,height:8.3},A4:{width:8.3,height:11.7},A3:{width:11.7,height:16.5},Letter:{width:8.5,height:11},Legal:{width:8.5,height:14}},DPI:72,printServer:undefined,timeout:6e4,headerTpl:null,headerTplDataFn:null,headerTplDataFnScope:null,tpl:null,footerTpl:null,footerTplDataFn:null,footerTplDataFnScope:null,exportDialogClassName:"Sch.widget.ExportDialog",exportDialogConfig:{},exporterConfig:null,exportConfig:{format:"A4",orientation:"portrait",range:"complete",rowsRange:"all",showHeader:!0,showFooter:!1},expandAllBeforeExport:!1,translateURLsToAbsolute:!0,openAfterExport:!0,beforeExport:function(){},afterExport:function(){},fileFormat:"pdf",defaultExporter:"multipage",exporters:undefined,callbacks:undefined,currentAjaxRequest:undefined,hideExportDialogTimeout:1e3,constructor:function(n){var t=this;n=n||{};t.exportersIndex={};n.exportDialogConfig&&Ext.Object.each(this.exportConfig,function(t,i,r){var u=n.exportDialogConfig[t];u&&(r[t]=u)});t.callParent([n]);t.setFileFormat(t.fileFormat);t.exporters||(t.exporters=t.buildExporters());t.initExporters();t.bindExporters()},init:function(n){var t=this;n.showExportDialog=Ext.Function.bind(t.showExportDialog,t);n.doExport=Ext.Function.bind(t.doExport,t);t.scheduler=n},initExporters:function(){for(var i=this,t=i.exporters,n=0;n<t.length;n++)t[n].isExporter||(t[n]=i.createExporter(t[n]))},bindExporters:function(){for(var t=this.exporters,n=0;n<t.length;n++)this.bindExporter(t[n])},bindExporter:function(n){var t=this;t.mon(n,{commitpage:t.onPageCommit,collectrows:t.onRowCollected,scope:t})},unbindExporter:function(n){var t=this;t.mun(n,{commitpage:t.onPageCommit,collectrows:t.onRowCollected,scope:t})},buildExporters:function(){return["Sch.plugin.exporter.SinglePage","Sch.plugin.exporter.MultiPage","Sch.plugin.exporter.MultiPageVertical"]},getExporterConfig:function(){var n=this,t=Ext.apply({translateURLsToAbsolute:n.translateURLsToAbsolute,expandAllBeforeExport:n.expandAllBeforeExport,DPI:n.DPI},n.exporterConfig);return n.headerTpl&&(t.headerTpl=n.headerTpl),n.headerTplDataFn&&(t.headerTplDataFn=n.headerTplDataFn,t.headerTplDataFnScope=n.headerTplDataFnScope),n.tpl&&(t.tpl=n.tpl),n.footerTpl&&(t.footerTpl=n.footerTpl),n.footerTplDataFn&&(t.footerTplDataFn=n.footerTplDataFn,t.footerTplDataFnScope=n.footerTplDataFnScope),t},createExporter:function(n,t){var r=this,i=r.getExporterConfig(n,t);return Ext.isObject(n)?Ext.create(Ext.apply(i,n)):Ext.create(n,Ext.apply(i,t))},registerExporter:function(n){n instanceof Sch.plugin.exporter.AbstractExporter||(n=this.createExporter.apply(this,arguments));this.exporters.push(n);this.bindExporter(n)},getExporter:function(n){if(n){var t=this.exportersIndex[n];return t?t:this.exportersIndex[n]=Ext.Array.findBy(this.exporters,function(t){return t.getExporterId()==n})}},getExporters:function(){return this.exporters},setFileFormat:function(n){this.fileFormat=n},showExportDialog:function(){var n=this,i=n.scheduler.getSchedulingView(),t=n.getActiveExportDialog();t&&t.destroy();n.setActiveExportDialog(Ext.create(n.exportDialogClassName,Ext.apply({doExportFn:n.doExport,doExportFnScope:n,startDate:n.scheduler.getStart(),endDate:n.scheduler.getEnd(),rowHeight:i.timeAxisViewModel.getViewRowHeight(),columnWidth:i.timeAxisViewModel.getTickWidth(),defaultExporter:n.defaultExporter,exportConfig:Ext.apply(n.exportConfig,{DPI:n.DPI}),exporters:n.exporters,pageFormats:n.getPageFormats(),columnPickerConfig:{columns:n.scheduler.lockedGrid.query("gridcolumn")}},n.exportDialogConfig)));t=n.getActiveExportDialog();t.on("destroy",n.onExportDialogDestroy,n);t.progressBar&&t.mon(n,{updateprogressbar:n.onExportProgress,scope:n});t.show()},onExportDialogDestroy:function(){this.cancelExport();this.setActiveExportDialog()},onExportProgress:function(n,t){var r=this.getActiveExportDialog(),i=r&&r.progressBar;i&&(i.updateProgress(n),typeof t=="string"&&i.updateText(t))},showError:function(n){Ext.Msg.alert("",n||this.L("generalError"))},getPageFormats:function(){var t=this.pageSizes,n=[];return Ext.Object.each(t,function(t,i){n.push({width:i.width,height:i.height,name:t})}),Ext.Array.map(n.sort(function(n,t){return n.width-t.width}),function(n){return n.name})},getExportConfig:function(n){var t=this,i=Ext.apply({fileFormat:t.fileFormat,exporterId:t.defaultExporter,beforeExport:Ext.Function.bind(t.beforeExport,t),afterExport:Ext.Function.bind(t.afterExport,t)},n,t.exportConfig);return i.DPI=i.DPI||t.DPI,i.pageSize=Ext.apply({},t.pageSizes[i.format]),i.pageSize.width*=i.DPI,i.pageSize.height*=i.DPI,i},doExport:function(n,t,i,r){var u=this,e=u.scheduler,f=u.getExportConfig(n),o;u.callbacks={success:t,failure:i,scope:r||u};o=u.exporter=u.getExporter(f.exporterId);u.fireEvent("beforeexport",e,o,f)!==!1&&(u.myBeforeExport(),u.exporter.extractPages(e,f,function(n){u.onPagesExtracted(n,e,o,f)},u))},cancelExport:function(){this.currentAjaxRequest&&(Ext.Ajax.abort(this.currentAjaxRequest),this.currentAjaxRequest=null);Ext.getBody().unmask()},onPagesExtracted:function(n,t,i,r){this.fireEvent("updateprogressbar",.8,this.L("requestingPrintServer"));this.doRequest(n,r)},onRowCollected:function(n,t,i,r){this.fireEvent("updateprogressbar",.2*(i+1)/r,Ext.String.format(this.L("fetchingRows"),i+1,r))},onPageCommit:function(n,t,i,r){r=Math.max(i,r);this.fireEvent("updateprogressbar",.2+.6*i/r,Ext.String.format(this.L("builtPage"),i,r))},onExportSuccess:function(n){var t=this,r=t.getActiveExportDialog(),i=t.callbacks,u=i&&i.success,f=i&&i.scope||t;t.fireEvent("updateprogressbar",1);t.myAfterExport();u&&u.apply(f,arguments);setTimeout(function(){t.fireEvent("hidedialogwindow",n);r&&r.destroy()},t.hideExportDialogTimeout);t.openAfterExport&&setTimeout(function(){window.open(n.url,"ExportedPanel")},0)},onExportFailure:function(n,t){var i=this,f=this.getActiveExportDialog(),r=i.callbacks,u=r&&r.failure,e=r&&r.scope||i;u&&u.call(e,n);i.fireEvent("showdialogerror",f,n,t);i.showError(n);i.myAfterExport()},doRequest:function(n,t){var i=this,o=i.scheduler,r,f,u,s,e;if(i.test||i.debug){if(i.debug)for(f=n||[],u=0,s=f.length;u<s;u++)e=window.open(),e.document.write(f[u].html),e.document.close();i.onExportSuccess(i.testResponse||{success:!0,url:"foo",htmlArray:n})}else if(i.printServer)r={method:"POST",url:i.printServer,timeout:i.timeout,params:Ext.apply({html:{array:Ext.JSON.encode(n)},startDate:o.getStartDate(),endDate:o.getEndDate(),format:i.exporter.getPaperFormat(),orientation:t.orientation,range:t.range,fileFormat:i.fileFormat},this.getParameters()),success:i.onRequestSuccess,failure:i.onRequestFailure,scope:i},Ext.apply(r,this.getAjaxConfig(r)),this.currentAjaxRequest=Ext.Ajax.request(r);else i.onExportFailure("Print server URL is not defined, please specify printServer config")},onRequestSuccess:function(n){this.currentAjaxRequest=null;var i=this,t;try{t=Ext.JSON.decode(n.responseText)}catch(r){i.onExportFailure("Wrong server response received");return}if(t.success)i.onExportSuccess(t);else i.onExportFailure(t.msg,t)},onRequestFailure:function(n){this.currentAjaxRequest=null;var t=this,i=n.status===200?n.responseText:n.statusText;t.onExportFailure(i,n)},getParameters:function(){return{}},getAjaxConfig:function(){return{}},getActiveExportDialog:function(){return this.win},setActiveExportDialog:function(n){this.win=n},myBeforeExport:function(){var i,n,t;this.fireEvent("exportstart",this);i=Ext.getBody().mask();i.addCls("sch-export-mask");n=this.getActiveExportDialog();t=n&&n.progressBar;t&&t.show()},myAfterExport:function(){this.fireEvent("afterexport",this);Ext.getBody().unmask()},destroy:function(){this.callParent(arguments);this.getActiveExportDialog()&&this.getActiveExportDialog().destroy()}});Ext.define("Sch.plugin.Pan",{extend:Ext.AbstractPlugin,alias:"plugin.scheduler_pan",lockableScope:"top",enableVerticalPan:!0,statics:{KEY_SHIFT:1,KEY_CTRL:2,KEY_ALT:4,KEY_ALL:7},disableOnKey:0,constructor:function(n){Ext.apply(this,n)},init:function(n){if(!Ext.supports.Touch){this.view=n.getSchedulingView();this.view.on("afterrender",this.onRender,this)}},onRender:function(){this.view.el.on("mousedown",this.onMouseDown,this)},onMouseDown:function(n){var t=this.self,i=this.disableOnKey;if((!n.shiftKey||!(i&t.KEY_SHIFT))&&(!n.ctrlKey||!(i&t.KEY_CTRL))&&(!n.altKey||!(i&t.KEY_ALT))&&n.getTarget(this.view.timeCellSelector,10)&&!n.getTarget(this.view.timeCellSelector+" > div > *")){this.mouseX=n.getX();this.mouseY=n.getY();Ext.getBody().on("mousemove",this.onMouseMove,this);Ext.getDoc().on("mouseup",this.onMouseUp,this);if(Ext.isIE||Ext.isGecko)Ext.getBody().on("mouseenter",this.onMouseUp,this);n.stopEvent()}},onMouseMove:function(n){if(!this.disabled){n.stopEvent();var i=n.getX(),r=n.getY(),t=0,u=this.mouseX-i;this.enableVerticalPan&&(t=this.mouseY-r);this.mouseX=i;this.mouseY=r;this.view.scrollBy(u,t,!1);this.view.headerCt.getScrollable().scrollBy(u,t,!1)}},onMouseUp:function(){Ext.getBody().un("mousemove",this.onMouseMove,this);Ext.getDoc().un("mouseup",this.onMouseUp,this);(Ext.isIE||Ext.isGecko)&&Ext.getBody().un("mouseenter",this.onMouseUp,this)}});Ext.define("Sch.plugin.Printable",{extend:Sch.plugin.Export,alternateClassName:["Sch.plugin.Print"],alias:["plugin.scheduler_printable","plugin.scheduler_print"],docType:"<!DOCTYPE HTML>",beforePrint:function(){},afterPrint:function(){},exportDialogConfig:{showDPIField:!0},removeSecondaryCanvas:!1,wrapHeaders:!1,autoPrintAndClose:!0,mainTpl:'{docType}<html class="'+Ext.baseCSSPrefix+'border-box {htmlClasses}"><head><meta content="text/html; charset=UTF-8" http-equiv="Content-Type" /><title>{title}<\/title>{styles}<\/head><body class="sch-print-body {bodyClasses}"><div class="sch-print-ct" style="width:{totalWidth}px"><tpl for="pages">{html}<\/tpl><\/div><script type="text/javascript">{setupScript}<\/script><\/body><\/html>',pageTpl:'{header}<div class="{componentClasses}" style="height:{bodyHeight}px; width:{totalWidth}px; position: relative !important">{HTML}<\/div>{footer}<div style="page-break-after:always;"><\/div>',openAfterExport:!1,DPI:72,fakeBackgroundColor:!1,doRequest:function(){},constructor:function(n){Ext.apply(this,n);this.mainTpl.isTemplate||(this.mainTpl=new Ext.XTemplate(this.mainTpl));this.callParent(arguments);this.exportDialogConfig=Ext.applyIf({l10n:{title:this.L("dialogTitle"),exportButtonText:this.L("exportButtonText")}},this.exportDialogConfig)},init:function(n){this.callParent(arguments);n.print=Ext.Function.bind(this.print,this)},getExporterConfig:function(){var n=this,t=n.callParent(arguments);return Ext.apply(t,{tpl:n.pageTpl})},getExportConfig:function(){var n=this,t=n.callParent(arguments);return Ext.apply(t,{beforeExport:Ext.Function.bind(n.beforePrint,n),afterExport:Ext.Function.bind(n.afterPrint,n)})},buildExporters:function(){return["Sch.plugin.exporter.MultiPage","Sch.plugin.exporter.MultiPageVertical"]},onPagesExtracted:function(n,t,i,r){this.fireEvent("updateprogressbar",.8,this.L("requestingPrintServer"));this.printPages(n,t,i,r)},print:function(){this.showExportDialog()},onBeforePageCommit:function(n,t){var i=this.scheduler,s=i.lockedGrid,h=i.normalGrid,r=function(n){return t.select("#"+n).first()},u=t.select(n.normalBodySelector).first(),f=r(h.headerCt.id),c=t.select(n.lockedBodySelector).first(),e=r(s.headerCt.id),o;u.addCls(["sch-print-normal-rows-ct",this.fakeBackgroundColor?" sch-print-fake-background":""]);c.addCls("sch-print-locked-rows-ct");this.removeSecondaryCanvas&&t.select(".sch-secondary-canvas").remove();this.fakeBackgroundColor&&(o=u.select(".sch-event"),o.each(function(n){n.setStyle("border-right-width",n.dom.style.width)}));f.addCls("sch-print-normalheader");e.addCls("sch-print-lockedheader");this.wrapHeaders&&(f.wrap('<div class="sch-print-header-wrap"><\/div>'),e.wrap('<div class="sch-print-header-wrap"><\/div>'))},prepareMainTplData:function(n){return n},printPages:function(n,t,i){this.mainTpl&&this.mainTpl.isTemplate||(this.mainTpl=new Ext.XTemplate(this.mainTpl,{compiled:!0,disableFormats:!0}));var e=i.getStylesheets(),u=document.body,f=this.mainTpl.apply(this.prepareMainTplData({docType:this.docType,htmlClasses:u.parentNode.className,bodyClasses:u.className,title:t.title||"",styles:e,totalWidth:i.paperWidth,setupScript:"window.onload = function(){ ("+this.setupScript.toString()+")("+[!!this.autoPrintAndClose,!!Ext.isChrome]+"); };",pages:n})),r=window.open("","printgrid");if(!r||!r.document)return!1;this.printWindow=r;r.document.write(f);r.document.close();this.onExportSuccess({success:!0,url:"foo",htmlArray:[f]})},bindExporter:function(n){var t=this;t.callParent(arguments);t.mon(n,{beforecommitpage:t.onBeforePageCommit,scope:t})},unbindExporter:function(n){var t=this;t.callParent(arguments);t.mun(n,{beforecommitpage:t.onBeforePageCommit,scope:t})},setupScript:function(n,t){document._loaded=!0;n&&(window.print(),t||window.close())}});Ext.define("Sch.plugin.TreeCellEditing",{extend:Ext.grid.plugin.CellEditing,alias:"plugin.scheduler_treecellediting",lockableScope:"locked",editorsStarted:0,init:function(){this.on("beforeedit",this.onMyBeforeEdit,this);this.callParent(arguments)},activateCell:function(n){var i=this.callParent(arguments),t;return i&&(t=this.getEditor(n.record,n.column),t._cancelEdit||(t._cancelEdit=t.cancelEdit,t.cancelEdit=this.myCancelEdit),this.fireEvent("editingstart",this,t)),i},checkReadOnly:function(){var n=this.getCmp();if(n)return n.isTimelineTreePanel||n.isTimelineGridPanel||(n=n.up("tablepanel")),!n.isReadOnly()},onEditComplete:function(n,t,i){var r=this;return n.field.applyChanges?(t!==i&&n.field.applyChanges(n.field.task||r.context.record),r.callParent([n,t,t])):r.callParent([n,t,i])},myCancelEdit:function(){var t=this,n=t.field,i,r;return n&&n.applyChanges?(i=n.instantUpdate,n.instantUpdate=!0,r=t._cancelEdit.apply(this,arguments),n.instantUpdate=i,r):t._cancelEdit.apply(this,arguments)},onMyBeforeEdit:function(n,t){var i=t.column.getEditor();return i&&i.setTask&&(i.setTask(t.record),t.value=t.originalValue=i.getValue()),this.checkReadOnly()}});Ext.define("Gnt.locale.En",{extend:Sch.locale.Locale,singleton:!0,l10n:{"Gnt.util.DurationParser":{unitsRegex:{MILLI:/^ms$|^mil/i,SECOND:/^s$|^sec/i,MINUTE:/^m$|^min/i,HOUR:/^h$|^hr$|^hour/i,DAY:/^d$|^day/i,WEEK:/^w$|^wk|^week/i,MONTH:/^mo|^mnt/i,QUARTER:/^q$|^quar|^qrt/i,YEAR:/^y$|^yr|^year/i}},"Gnt.util.DependencyParser":{typeText:{SS:"SS",SF:"SF",FS:"FS",FF:"FF"}},"Gnt.panel.Timeline":{start:"Start",end:"End"},"Gnt.field.ShowInTimeline":{yes:"Yes",no:"No"},"Gnt.column.ShowInTimeline":{text:"Show in timeline"},"Gnt.field.ConstraintType":{none:"None",invalidText:"Invalid value"},"Gnt.field.Duration":{invalidText:"Invalid value"},"Gnt.field.Effort":{invalidText:"Invalid value"},"Gnt.field.Percent":{invalidText:"Invalid value"},"Gnt.field.SchedulingMode":{Normal:"Normal",FixedDuration:"Fixed duration",EffortDriven:"Effort driven",DynamicAssignment:"Dynamic assignment",invalidText:"Invalid value"},"Gnt.feature.DependencyDragDrop":{fromText:"From",toText:"To",startText:"Start",endText:"End"},"Gnt.template.Deadline":{deadline:"Deadline"},"Gnt.column.DeadlineDate":{text:"Deadline"},"Gnt.Tooltip":{startText:"Starts: ",endText:"Ends: ",durationText:"Duration: "},"Gnt.plugin.TaskContextMenu":{taskInformation:"Task information...",projectInformation:"Project information...",newTaskText:"New task",deleteTask:"Delete task(s)",editLeftLabel:"Edit left label",editRightLabel:"Edit right label",add:"Add...",deleteDependency:"Delete dependency...",addTaskAbove:"Task above",addTaskBelow:"Task below",addMilestone:"Milestone",addSubtask:"Sub-task",addSuccessor:"Successor",addPredecessor:"Predecessor",convertToMilestone:"Convert to milestone",convertToRegular:"Convert to regular task",splitTask:"Split task"},"Gnt.plugin.DependencyEditor":{fromText:"From",toText:"To",typeText:"Type",lagText:"Lag",endToStartText:"Finish-To-Start",startToStartText:"Start-To-Start",endToEndText:"Finish-To-Finish",startToEndText:"Start-To-Finish",okButtonText:"Ok",cancelButtonText:"Cancel",deleteButtonText:"Delete"},"Gnt.widget.calendar.Calendar":{dayOverrideNameHeaderText:"Name",overrideName:"Name",startDate:"Start Date",endDate:"End Date",error:"Error",dateText:"Date",addText:"Add",editText:"Edit",removeText:"Remove",workingDayText:"Working day",weekendsText:"Weekends",overriddenDayText:"Overridden day",overriddenWeekText:"Overridden week",workingTimeText:"Working time",nonworkingTimeText:"Non-working time",dayOverridesText:"Day overrides",weekOverridesText:"Week overrides",okText:"OK",cancelText:"Cancel",parentCalendarText:"Parent calendar",noParentText:"No parent",selectParentText:"Select parent",newDayName:"[Without name]",calendarNameText:"Calendar name",tplTexts:{tplWorkingHours:"Working hours for",tplIsNonWorking:"is non-working",tplOverride:"override",tplInCalendar:"in calendar",tplDayInCalendar:"standard day in calendar",tplBasedOn:"Based on"},overrideErrorText:"There is already an override for this day",overrideDateError:"There is already a week override on this date: {0}",startAfterEndError:"Start date should be less than end date",weeksIntersectError:"Week overrides should not intersect"},"Gnt.widget.calendar.AvailabilityGrid":{startText:"Start",endText:"End",addText:"Add",removeText:"Remove",error:"Error"},"Gnt.widget.calendar.DayEditor":{workingTimeText:"Working time",nonworkingTimeText:"Non-working time"},"Gnt.widget.calendar.WeekEditor":{defaultTimeText:"Default time",workingTimeText:"Working time",nonworkingTimeText:"Non-working time",error:"Error",noOverrideError:"Week override contains only 'default' days - can't save it"},"Gnt.widget.calendar.ResourceCalendarGrid":{name:"Name",calendar:"Calendar"},"Gnt.widget.calendar.CalendarWindow":{ok:"Ok",cancel:"Cancel"},"Gnt.widget.calendar.CalendarManager":{addText:"Add",removeText:"Remove",add_child:"Add child",add_node:"Add calendar",add_sibling:"Add sibling",remove:"Remove",calendarName:"Calendar",confirm_action:"Confirm action",confirm_message:"Calendar has unsaved changes. Would you like to save your changes?"},"Gnt.widget.calendar.CalendarManagerWindow":{title:"Calendar manager",ok:"Apply changes",cancel:"Close",confirm_action:"Confirm action",confirm_message:"Calendar has unsaved changes. Would you like to save your changes?"},"Gnt.field.Assignment":{cancelText:"Cancel",closeText:"Save and Close"},"Gnt.column.AssignmentUnits":{text:"Units"},"Gnt.column.Duration":{text:"Duration"},"Gnt.column.Effort":{text:"Effort"},"Gnt.column.EndDate":{text:"Finish"},"Gnt.column.PercentDone":{text:"% Done"},"Gnt.column.ResourceAssignment":{text:"Assigned Resources"},"Gnt.column.ResourceName":{text:"Resource Name"},"Gnt.column.Rollup":{text:"Rollup task",no:"No",yes:"Yes"},"Gnt.field.ManuallyScheduled":{yes:"Yes",no:"No"},"Gnt.field.ReadOnly":{yes:"Yes",no:"No"},"Gnt.column.ManuallyScheduled":{text:"Manual mode"},"Gnt.column.SchedulingMode":{text:"Mode"},"Gnt.column.Predecessor":{text:"Predecessors"},"Gnt.column.Successor":{text:"Successors"},"Gnt.column.StartDate":{text:"Start"},"Gnt.column.WBS":{text:"WBS"},"Gnt.column.Sequence":{text:"#"},"Gnt.column.Calendar":{text:"Calendar"},"Gnt.column.ReadOnly":{text:"Read Only"},"Gnt.widget.taskeditor.ProjectForm":{projectText:"Project",nameText:"Name",datesText:"Dates",startText:"Start",finishText:"Finish",calendarText:"Calendar",readOnlyText:"Read Only",allowDependenciesText:"Allow cross-project dependencies"},"Gnt.widget.taskeditor.TaskForm":{taskNameText:"Name",durationText:"Duration",datesText:"Dates",baselineText:"Baseline",startText:"Start",finishText:"Finish",percentDoneText:"Percent Complete",baselineStartText:"Start",baselineFinishText:"Finish",baselinePercentDoneText:"Percent Complete",effortText:"Effort",invalidEffortText:"Invalid effort value",calendarText:"Calendar",manuallyScheduledText:"Manually Scheduled",schedulingModeText:"Scheduling Mode",rollupText:"Rollup",wbsCodeText:"WBS code","Constraint Type":"Constraint Type","Constraint Date":"Constraint Date",readOnlyText:"Read Only"},"Gnt.widget.DependencyGrid":{idText:"ID",snText:"SN",taskText:"Task Name",blankTaskText:"Please select task",invalidDependencyText:"Invalid dependency",parentChildDependencyText:"Dependency between child and parent found",duplicatingDependencyText:"Duplicate dependency found",transitiveDependencyText:"Transitive dependency",cyclicDependencyText:"Cyclic dependency",typeText:"Type",lagText:"Lag",clsText:"CSS class",endToStartText:"Finish-To-Start",startToStartText:"Start-To-Start",endToEndText:"Finish-To-Finish",startToEndText:"Start-To-Finish",predecessorsText:"Predecessors",successorsText:"Successors"},"Gnt.widget.AssignmentEditGrid":{confirmAddResourceTitle:"Confirm",confirmAddResourceText:"Resource &quot;{0}&quot; not found in list. Would you like to add it?",noValueText:"Please select resource to assign",noResourceText:"No resource &quot;{0}&quot; found in the list"},"Gnt.widget.taskeditor.TaskEditor":{generalText:"General",resourcesText:"Resources",addDependencyText:"Add new",dropDependencyText:"Remove",notesText:"Notes",advancedText:"Advanced",addAssignmentText:"Add new",dropAssignmentText:"Remove"},"Gnt.widget.taskeditor.ProjectEditor":{generalText:"General",descriptionText:"Description"},"Gnt.plugin.taskeditor.BaseEditor":{title:"Task Information",alertCaption:"Information",alertText:"Please correct marked errors to save changes",okText:"Ok",cancelText:"Cancel"},"Gnt.plugin.taskeditor.ProjectEditor":{title:"Project Information"},"Gnt.field.EndDate":{endBeforeStartText:"End date is before start date"},"Gnt.column.Note":{text:"Note"},"Gnt.column.AddNew":{text:"Add new column..."},"Gnt.column.EarlyStartDate":{text:"Early Start"},"Gnt.column.EarlyEndDate":{text:"Early Finish"},"Gnt.column.LateStartDate":{text:"Late Start"},"Gnt.column.LateEndDate":{text:"Late Finish"},"Gnt.field.Calendar":{calendarNotApplicable:"Task calendar has no overlapping with assigned resources calendars",invalidText:"Invalid value"},"Gnt.column.Slack":{text:"Slack"},"Gnt.column.Name":{text:"Task Name"},"Gnt.column.BaselineStartDate":{text:"Baseline Start Date"},"Gnt.column.BaselineEndDate":{text:"Baseline End Date"},"Gnt.column.Milestone":{text:"Milestone"},"Gnt.field.Milestone":{yes:"Yes",no:"No"},"Gnt.field.Dependency":{invalidFormatText:"Invalid dependency format",invalidDependencyText:"Invalid dependency found, please make sure you have no cyclic paths between your tasks",invalidDependencyType:"Invalid dependency type {0}. Allowed values are: {1}."},"Gnt.constraint.Base":{name:"A constraint","Remove the constraint":"Remove the constraint","Cancel the change and do nothing":"Cancel the change and do nothing"},"Gnt.constraint.FinishNoEarlierThan":{name:"Finish no earlier than","Move the task to finish on {0}":"Move the task to finish on {0}"},"Gnt.constraint.FinishNoLaterThan":{name:"Finish no later than","Move the task to finish on {0}":"Move the task to finish on {0}"},"Gnt.constraint.MustFinishOn":{name:"Must finish on","Move the task to finish on {0}":"Move the task to finish on {0}"},"Gnt.constraint.MustStartOn":{name:"Must start on","Move the task to start at {0}":"Move the task to start at {0}"},"Gnt.constraint.StartNoEarlierThan":{name:"Start no earlier than","Move the task to start at {0}":"Move the task to start at {0}"},"Gnt.constraint.StartNoLaterThan":{name:"Start no later than","Move the task to start at {0}":"Move the task to start at {0}"},"Gnt.column.ConstraintDate":{text:"Constraint date"},"Gnt.column.ConstraintType":{text:"Constraint"},"Gnt.widget.ConstraintResolutionForm":{dateFormat:"m/d/Y",OK:"OK",Cancel:"Cancel","Resolution options":"Resolution options","Don't ask again":"Don't ask again","Task {0} violates constraint {1}":'Task "{0}" violates constraint {1}',"Task {0} violates constraint {1} {2}":'Task "{0}" violates constraint {1} {2}'},"Gnt.widget.ConstraintResolutionWindow":{"Constraint violation":"Constraint violation"},"Gnt.panel.ResourceHistogram":{resourceText:"Resource"}},apply:function(n){Sch.locale.En.apply(n);this.callParent(arguments)}});Ext.define("Gnt.mixin.Localizable",{extend:Sch.mixin.Localizable});Ext.define("Gnt.Tooltip",{extend:Ext.ToolTip,alias:"widget.gantt_task_tooltip",mixins:[Gnt.mixin.Localizable],mode:"startend",autoHide:!1,anchor:"b-tl",maskOnDisable:!1,template:null,gantt:null,initComponent:function(){this.rtl=this.gantt.rtl;this.startLabel=this.L("startText");this.endLabel=this.L("endText");this.durationLabel=this.L("durationText");this.template||(this.template=new Ext.Template('<div class="sch-timetipwrap {cls}"><table cellpadding="0" cellspacing="0"><tpl if="value1"><tr><td class="sch-gantt-tip-desc">{label1}<\/td><td class="sch-gantt-tip-value">{value1}<\/td><\/tr><\/tpl><tr><td class="sch-gantt-tip-desc">{label2}<\/td><td class="sch-gantt-tip-value">{value2}<\/td><\/tr><\/table><\/div>').compile());this.callParent(arguments);this.update(this.template.apply({value1:"",value2:""}));this.addCls("gnt-tooltip")},updateContent:function(n,t,i,r){var u;u=this.mode==="duration"?this.getDurationContent(n,t,i,r):this.getStartEndContent(n,t,i,r);this.update(u)},getStartEndContent:function(n,t,i,r){var u=this.gantt,o=n&&u.getFormattedDate(n),e,f;return e=n?t-n>0?u.getFormattedEndDate(t,n):o:u.getFormattedEndDate(t),f={cls:i?"sch-tip-ok":"sch-tip-notok",label2:this.endLabel,value2:e,task:r},n&&(f.label1=this.startLabel,f.value1=n&&u.getFormattedDate(n)),this.template.apply(f)},getDurationContent:function(n,t,i,r){var u=r.getDurationUnit()||Sch.util.Date.DAY,f=r.calculateDuration(n,t,u);return this.template.apply({cls:i?"sch-tip-ok":"sch-tip-notok",label1:this.startLabel,value1:this.gantt.getFormattedDate(n),label2:this.endLabel,value2:parseFloat(Ext.Number.toFixed(f,1))+" "+Sch.util.Date.getReadableNameOfUnit(u,f>1),task:r})},show:function(n,t){n&&(n.dom||n.className)&&this.setTarget(n);this.callParent([]);t!==undefined&&this.setX(t)}});Ext.define("Gnt.column.AddNew",{extend:Ext.grid.column.Column,alias:["widget.addnewcolumn","widget.ganttcolumn.addnew"],mixins:[Gnt.mixin.Localizable],text:"",width:100,resizable:!1,menuDisabled:!0,sortable:!1,draggable:!1,colEditor:null,colEditorStore:null,layout:"fit",columnList:null,initComponent:function(){this.addCls("gnt-addnewcolumn");this.items=this.getColEditor();this.callParent(arguments)},getGantt:function(){return this.gantt||(this.gantt=this.up("ganttpanel")),this.gantt},getColEditor:function(){var n=this,t;if(!n.colEditor&&(t=n.colEditor=new Ext.form.field.ComboBox({itemId:"addNewEditor",displayField:"text",valueField:"clsName",hideTrigger:!0,queryMode:"local",multiSelect:!1,value:this.L("text"),listConfig:{itemId:"addNewEditorComboList",minWidth:150},store:n.getColEditorStore(),pickerAlign:"tl-bl",listeners:{focus:n.onInputFocus,blur:n.onFieldBlur,select:n.onSelect,scope:n}}),Ext.isIE8m))t.on("resize",function(n,t,i){n.inputEl.setStyle("line-height",+i+"px");n.setValue(n.getValue()+" ")});return n.colEditor},onFieldBlur:function(n,t){var i=n.getPicker(),r=i.el&&i.el.dom;t.relatedTarget&&t.relatedTarget===r||this.resetField()},resetField:function(){this.getColEditor().setValue(this.L("text"));this.getColEditor().collapse()},getColEditorStore:function(){var n=this;return n.colEditorStore||(n.columnList=n.columnList||Gnt.column.AddNew.buildDefaultColumnList(),n.colEditorStore=new Ext.data.Store({fields:["text","clsName","config"],data:n.columnList,sorters:[{property:"text",direction:"ASC"}]})),n.colEditorStore},onInputFocus:function(n){n.setValue();n.expand()},onSelect:function(n,t){this.resetField();this.getColEditor().blur();this.addColumn(Ext.isArray(t)?t[0]:t)},addColumn:function(n){var t=this,i=n,u=t.up("headercontainer"),e=i.get("text"),f=i.get("config")||{},r=i.get("clsName")||f.xclass||"Ext.grid.column.Column";Ext.require(r,function(){var n=Ext.ClassManager.get(r),i=Ext.create(Ext.applyIf(f,{xclass:r,text:e,dataIndex:t.getGantt().taskStore.model.prototype[n.prototype.fieldProperty]}));u.insert(u.items.indexOf(t),i)})},destroy:function(){this.colEditorStore&&this.colEditorStore.destroy();this.callParent(arguments)},statics:{buildDefaultColumnList:function(){var n=[];return Ext.Array.each(Ext.ClassManager.getNamesByExpression("widget.ganttcolumn.*"),function(t){var i=Ext.ClassManager.get(t);i&&i!==Gnt.column.AddNew&&!Gnt.column.AddNew.prototype.isPrototypeOf(i.prototype)&&n.push({clsName:t,text:i.prototype.localize?i.prototype.localize("text"):i.prototype.text})}),n.sort(function(n,t){return n.text>t.text?1:-1})}}});Ext.define("Gnt.field.Percent",{extend:Ext.form.field.Number,alias:"widget.percentfield",mixins:[Gnt.mixin.Localizable],alternateClassName:"Gnt.widget.PercentField",disableKeyFilter:!1,minValue:0,maxValue:100,allowExponential:!1,baseChars:"0123456789%",constructor:function(){this.callParent(arguments);this.invalidText=this.L("invalidText")},valueToRaw:function(n){return Ext.isNumber(n)?parseFloat(Ext.Number.toFixed(n,this.decimalPrecision))+"%":""},getErrors:function(n){var t=this.parseValue(n);if(t===null){if(n!==null&&n!=="")return[this.invalidText];t=""}return this.callParent([t])}});Ext.define("Gnt.column.AssignmentUnits",{extend:Ext.grid.column.Number,mixins:[Gnt.mixin.Localizable],alias:"widget.assignmentunitscolumn",dataIndex:"Units",format:"0 %",align:"left",editor:{xtype:"percentfield",minValue:0,step:10,selectOnFocus:Ext.isIE?!1:!0},constructor:function(n){n=n||{};this.text=n.text||this.L("text");this.scope=this;this.callParent(arguments)},renderer:function(n){if(n)return Ext.util.Format.number(n,this.format)}});Ext.define("Gnt.field.mixin.TaskField",{extend:Ext.Mixin,taskField:"",fieldProperty:"",getTaskValueMethod:"",setTaskValueMethod:"",isTaskField:!0,task:null,taskStore:null,suppressTaskUpdate:0,highlightTaskUpdates:!0,highlightColor:"#009900",lastHighlight:0,instantUpdate:!0,originalInstantUpdate:null,mixinConfig:{before:{constructor:"beforeConstructed",destroy:"beforeDestroyed"},after:{constructor:"afterConstructed"}},beforeConstructed:function(){this.setSuppressTaskUpdate(!0)},afterConstructed:function(){this.taskField=this.taskField||this.fieldProperty;this.task&&this.setTask(this.task);this.setSuppressTaskUpdate(!1)},setInstantUpdate:function(n){this.instantUpdate=n},beforeDestroyed:function(){this.destroyTaskListener()},setTask:function(n){if(n){this.destroyTaskListener();this.updateReadOnly(n);this.task=n;n.on("taskupdated",this.onTaskUpdateProcess,this);if(!n.getCalendar(!0)&&!n.getTaskStore(!0)){if(n.taskStore=n.getTaskStore(!0)||this.taskStore,!n.taskStore)throw"Configuration issue: Gnt.data.taskStore instance should be provided.";if(!n.getCalendar(!0)&&!n.taskStore.getCalendar())throw"Configuration issue: Gnt.data.Calendar instance should be provided.";}this.setSuppressTaskUpdate(!0);this.onSetTask(n);this.setSuppressTaskUpdate(!1)}},onSetTask:function(n){n=n||this.task;this.setValue(this.getTaskValue(n))},setSuppressTaskUpdate:function(n){n?this.suppressTaskUpdate++:this.suppressTaskUpdate--},getSuppressTaskUpdate:function(){return this.suppressTaskUpdate},updateReadOnly:function(n){this.disabled||this.forceReadOnly||(this.editable===!1?n.isEditable(n[this.taskField])?this.inputEl&&(this.setReadOnly(!1),this.inputEl.dom.readOnly=!0):this.setReadOnly(!0):this.setReadOnly(!n.isEditable(n[this.taskField])))},onTaskUpdateProcess:function(n,t){var i,r,u;if(t!==this){if(i=this.getValue(),this.updateReadOnly(n),this.setSuppressTaskUpdate(!0),this.onTaskUpdate)this.onTaskUpdate(n,t);else this.onSetTask(n);this.setSuppressTaskUpdate(!1);this.highlightTaskUpdates&&(r=this.getValue(),u=Ext.isDate(i),(u&&i-r!=0||!u&&String(i)!==String(r))&&this.highlightField())}},highlightField:function(n,t){this.rendered&&new Date-this.lastHighlight>1e3&&(this.lastHighlight=new Date,this.inputEl.highlight(n||this.highlightColor,t||{attr:"color"}))},destroyTaskListener:function(){this.task&&this.task.un("taskupdated",this.onTaskUpdateProcess,this)},callTaskMethod:function(n,t,i){return n=n||this.task,n&&n[t].apply(n,i)},getTaskValue:function(n){return this.callTaskMethod(n,this.getTaskValueMethod,Ext.Array.slice(arguments,1))},setTaskValue:function(n){if(!n.propagating)return this.callTaskMethod(n,this.setTaskValueMethod,Ext.Array.slice(arguments,1))},applyChanges:function(n){n=n||this.task;this.setTaskValue(n,this.getValue());n.fireEvent("taskupdated",n,this)}});Ext.define("Gnt.field.Date",{extend:Ext.form.field.Date,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],adjustMilestones:!0,keepDuration:!1,reAssertValue:!0,keepTime:!0,onExpand:function(){var n=this.valueToVisible(this.getValue());this._expanding=!1;this.isValid()||(n=this.getRawValue(),n&&(n=Ext.Date.parse(n,this.format)));this.picker.setValue(Ext.isDate(n)?n:new Date)},applyKeptTimeToValue:function(n){return this.keepTime&&!Ext.Date.formatContainsHourInfo(this.format)&&this.applyTimeToValue(n,this.getTaskValue()),n},applyTimeToValue:function(n,t){return t=t||this.getTaskValue(),Ext.isDate(n)&&t&&(n.setHours(t.getHours()),n.setMinutes(t.getMinutes())),n},onSelect:function(n,t){var i=this;(this.keepTime||Ext.Date.formatContainsHourInfo(this.format))&&i.applyTimeToValue(t,this.getTaskValue());var f=i.getValue(),r=this.visibleToValue(t),u=Ext.Date.format(t,this.format);if(f!=r)if(this.getErrors(u).length>0)i.setRawValue(u),i.collapse(),i.validate();else if(i.setValue(r,!0),i.fireEvent("select",i,r),Ext.getVersion().isGreaterThan("6.0.1"))i.onTabOut(n);else i.inputEl.focus(),i.collapse()},setValue:function(n,t){var i,r;this._expanding||(this.callParent([n]),i=this.task,!this.readOnly&&(t||this.instantUpdate)&&!this.getSuppressTaskUpdate()&&i&&i.taskStore&&n&&(this.applyChanges(),this.reAssertValue&&(r=this.getTaskValue(),r-this.getValue()!=0&&this.callParent([r])),i.fireEvent("taskupdated",i,this)))},rawToValue:function(n){if(!n)return null;var t=this.applyKeptTimeToValue(this.parseDate(n));return this.visibleToValue(t)||n||null},valueToRaw:function(n){return n?Ext.Date.format(this.valueToVisible(n),this.format):n},getValue:function(){return Ext.isEmpty(this.value)?null:this.value},visibleToValue:function(){throw"Abstract visibleToValue method called";},valueToVisible:function(){throw"Abstract valueToVisible method called";},checkChange:function(){if(!this.suspendCheckChange){var n=this,t=n.rawToValue(n.inputEl?n.inputEl.getValue():Ext.valueFrom(n.rawValue,"")),i=n.lastValue;if(!n.isEqual(t,i)&&!n.isDestroyed){n.lastValue=t;n.fireEvent("change",n,t,i);n.onChange(t,i)}}},assertValue:function(){var n=this,u=n.rawValue,t=n.getRawValue(),f=n.getValue(),i=n.rawToValue(t),r=n.focusTask;r&&r.cancel();(u!=t||i-f!=0)&&(!n.validateOnBlur||n.isValid())&&n.setValue(i,!0)},applyChanges:function(n){n=n||this.task;var t=n.getTaskStore(!0)||this.taskStore;this.value?this.setTaskValue(n,this.value,this.keepDuration,t.skipWeekendsDuringDragDrop):this.setTaskValue(n,null)},expand:function(){this._expanding=!0;this.callParent(arguments)},beforeBlur:function(){this.assertValue()}});Ext.define("Gnt.field.EndDate",{extend:Gnt.field.Date,alias:"widget.enddatefield",taskField:"endDateField",getTaskValueMethod:"getEndDate",setTaskValueMethod:"setEndDate",validateStartDate:!0,valueToVisible:function(n,t){return t=t||this.task,t.getDisplayEndDate(this.format,this.adjustMilestones,n,!0)},visibleToValue:function(n){return n&&this.task?Ext.Date.formatContainsHourInfo(this.format)||n-Ext.Date.clearTime(n,!0)!=0||(n=this.task.getCalendar().getCalendarDay(n).getAvailabilityEndFor(n)||Sch.util.Date.add(n,Sch.util.Date.DAY,1)):n=null,n},isValidAgainstStartDate:function(n){return!this.task||!n||n>=this.task.getStartDate()},getErrors:function(n){var t=this.callParent(arguments);return t&&t.length?t:this.validateStartDate&&!this.isValidAgainstStartDate(this.rawToValue(n))?[this.L("endBeforeStartText")]:[]}});Ext.define("Gnt.patches.TreeColumn",{extend:Sch.util.Patch,target:"Ext.tree.Column",minVersion:"5.1.1",overrides:{initComponent:function(){var n=this;n._rendererScope=n.scope||n;n.callParent(arguments);n.rendererScope=n._rendererScope}}});Ext.define("Gnt.column.mixin.TaskFieldColumn",{extend:Ext.Mixin,mixins:[Gnt.mixin.Localizable],instantUpdate:!1,field:null,fieldProperty:"",fieldConfigs:"instantUpdate,fieldProperty",defaultEditor:"textfield",mixinConfig:{after:{initComponent:"afterInitComponent",onRender:"_beforeRender"},afterIf:{applyColumnCls:"applyColumnCls"}},_beforeRender:function(){var n=this.getEditor&&this.getEditor();n&&n.setInstantUpdate&&(n.originalInstantUpdate=n.instantUpdate,n.setInstantUpdate(!1))},initTaskFieldColumn:function(n){this.text=this.config.text||this.L("text");this.initColumnEditor(n);this.scope=this.scope||this;this.renderer=this.renderer||this.taskFieldRenderer;this.on("added",this.onColumnAdded,this)},applyColumnCls:function(n,t,i){i.isEditable(this.dataIndex)||(t.tdCls=(t.tdCls||"")+" sch-column-readonly")},afterInitComponent:function(){this.hasCustomRenderer=!0},initColumnEditor:function(n){var t=this.editor,i;t&&("string"==typeof t&&(t={xtype:t}),t.isInstance||(t.xtype||t.xclass||(t.xtype=this.defaultEditor),i=Ext.copyTo(Ext.apply({},n),this,this.fieldConfigs,!0),this.editor=Ext.ComponentManager.create(Ext.apply(i,t))),this.field=this.editor)},onColumnAdded:function(){var n=this.up("[taskStore]"),t=n.taskStore;this.dataIndex||(this.dataIndex=t.model.prototype[this.fieldProperty]);this.onReadOnlySet&&this.mon(n,"setreadonly",this.onReadOnlySet,this)},getValueToRender:function(n,t,i){var r=this.field;return r&&r.valueToVisible&&r.valueToVisible(n,i)||n},taskFieldRenderer:function(n,t,i){var r=Ext.util.Format.htmlEncode(this.getValueToRender.apply(this,arguments));return this.applyColumnCls(n,t,i),r},afterClassMixedIn:function(n){var t=this.prototype,i=t.mixinConfig,r=i&&i.beforeIf,u=i&&i.afterIf;r&&Ext.Object.each(r,function(i,r){i in n.prototype?n.addMember(i,function(){if(t[r].apply(this,arguments)!==!1)return this.callParent(arguments)}):n.addMember(i,function(){t[r].apply(this,arguments)})});u&&Ext.Object.each(u,function(i,r){i in n.prototype?n.addMember(i,function(){this.callParent(arguments);t[r].apply(this,arguments)}):n.addMember(i,function(){t[r].apply(this,arguments)})})}});Ext.define("Gnt.column.EndDate",{extend:Ext.grid.column.Date,alias:["widget.enddatecolumn","widget.ganttcolumn.enddate"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:100,align:"left",editorFormat:null,adjustMilestones:!0,validateStartDate:!0,keepDuration:!1,fieldProperty:"endDateField",fieldConfigs:["instantUpdate","adjustMilestones","keepDuration","validateStartDate","fieldProperty"],editor:"enddatefield",defaultEditor:"enddatefield",initComponent:function(){this.initTaskFieldColumn({format:this.editorFormat||this.format||Ext.Date.defaultFormat});this.callParent(arguments)},getValueToRender:function(n,t,i){return n&&Ext.Date.format(this.field.valueToVisible(n,i),this.format)||""},putRawData:function(n,t){!n||n instanceof Date||(n=Ext.Date.parse(n,this.format));n&&t.getStartDate()&&t.getStartDate()>n&&t.setDuration(0);t.setEndDate(n,t.isMilestone(),!1)}});Ext.define("Gnt.field.BaselineEndDate",{extend:Gnt.field.EndDate,alias:"widget.baselineenddatefield",taskField:"baselineEndDateField",getTaskValueMethod:"getBaselineEndDate",setTaskValueMethod:"setBaselineEndDate",isValidAgainstStartDate:function(n){return!this.task||!n||n>=this.task.getBaselineStartDate()},applyChanges:function(n,t){n=n||this.task;this.setTaskValue(n,this.value||null);t||n.fireEvent("taskupdated",n,this)}});Ext.define("Gnt.column.BaselineEndDate",{extend:Gnt.column.EndDate,alias:["widget.baselineenddatecolumn","widget.ganttcolumn.baselineenddate"],width:100,fieldProperty:"baselineEndDateField",fieldConfigs:["instantUpdate","adjustMilestones","keepDuration","validateStartDate","fieldProperty"],editor:"baselineenddatefield",defaultEditor:"baselineenddatefield",putRawData:function(n,t){!n||n instanceof Date||(n=Ext.Date.parse(n,this.format));t.setBaselineEndDate(n)}});Ext.define("Gnt.field.StartDate",{extend:Gnt.field.Date,alias:"widget.startdatefield",keepDuration:!0,taskField:"startDateField",getTaskValueMethod:"getStartDate",setTaskValueMethod:"setStartDate",isBaseline:!1,valueToVisible:function(n,t){return t=t||this.task,t.getDisplayStartDate(this.format,this.adjustMilestones,n,!0,this.isBaseline)},visibleToValue:function(n){var t=this.task,i;return t&&n&&(i=!Ext.isDate(this.lastValue)||this.lastValue-Ext.Date.clearTime(this.lastValue,!0)==0,this.adjustMilestones&&t.isMilestone(this.isBaseline)&&n-Ext.Date.clearTime(n,!0)==0&&i&&(n=t.getCalendar().getCalendarDay(n).getAvailabilityEndFor(n)||n)),n}});Ext.define("Gnt.column.StartDate",{extend:Ext.grid.column.Date,alias:["widget.startdatecolumn","widget.ganttcolumn.startdate"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:100,align:"left",editorFormat:null,adjustMilestones:!0,keepDuration:!0,fieldProperty:"startDateField",fieldConfigs:["instantUpdate","adjustMilestones","keepDuration","fieldProperty"],editor:"startdatefield",defaultEditor:"startdatefield",initComponent:function(){this.initTaskFieldColumn({format:this.editorFormat||this.format||Ext.Date.defaultFormat});this.callParent(arguments)},getValueToRender:function(n,t,i){return n&&Ext.Date.format(this.field.valueToVisible(n,i),this.format)||""},putRawData:function(n,t){!n||n instanceof Date||(n=Ext.Date.parse(n,this.format));t.setStartDate(n)}});Ext.define("Gnt.field.BaselineStartDate",{extend:Gnt.field.StartDate,alias:"widget.baselinestartdatefield",taskField:"baselineStartDateField",getTaskValueMethod:"getBaselineStartDate",setTaskValueMethod:"setBaselineStartDate",isBaseline:!0,applyChanges:function(n,t){n=n||this.task;this.setTaskValue(n,this.value);t||n.fireEvent("taskupdated",n,this)}});Ext.define("Gnt.column.BaselineStartDate",{extend:Gnt.column.StartDate,alias:["widget.baselinestartdatecolumn","widget.ganttcolumn.baselinestartdate"],width:100,fieldProperty:"baselineStartDateField",fieldConfigs:["instantUpdate","adjustMilestones","fieldProperty"],editor:"baselinestartdatefield",defaultEditor:"baselinestartdatefield",putRawData:function(n,t){!n||n instanceof Date||(n=Ext.Date.parse(n,this.format));t.setBaselineStartDate(n)}});Ext.define("Gnt.model.Calendar",{extend:Sch.model.Customizable,idProperty:"Id",calendar:null,nameField:"Name",daysPerMonthField:"DaysPerMonth",daysPerWeekField:"DaysPerWeek",hoursPerDayField:"HoursPerDay",weekendsAreWorkdaysField:"WeekendsAreWorkdays",weekendFirstDayField:"WeekendFirstDay",weekendSecondDayField:"WeekendSecondDay",defaultAvailabilityField:"DefaultAvailability",daysField:"Days",calendarClassField:"CalendarClass",phantomIdField:"PhantomId",phantomParentIdField:"PhantomParentId",customizableFields:[{name:"Name"},{name:"DaysPerMonth",type:"number"},{name:"DaysPerWeek",type:"number"},{name:"HoursPerDay",type:"number"},{name:"WeekendsAreWorkdays",type:"boolean"},{name:"WeekendFirstDay",type:"integer"},{name:"WeekendSecondDay",type:"integer"},{name:"DefaultAvailability"},{name:"Days"},{name:"CalendarClass",defaultValue:"Gnt.data.Calendar"},{name:"PhantomId"},{name:"PhantomParentId"}],constructor:function(n,t,i){var r=n||i||{},u=r.calendar||r.Days;n&&delete n.calendar;i&&delete i.calendar;this.rawConfig=Ext.apply({},n);this.callParent(arguments);this.setDays(u);this.data[this.phantomIdField]=this.getId()},get:function(n){return n==="Days"?this.getCalendar()||this.data[this.daysField]:this.callParent(arguments)},set:function(n,t){if(n==="Days")t instanceof Gnt.data.Calendar?this.setCalendar(t):this.data[this.daysField]=t;else return this.callParent(arguments)},getCalendar:function(){return this.calendar},setCalendar:function(n){this.calendar=n},getCalendarConfig:function(){for(var t,r,n=this,u={calendarId:n.getId(),parent:n.parentNode&&n.parentNode.getCalendar()},f=["daysPerMonth","daysPerWeek","hoursPerDay","name","weekendFirstDay","weekendSecondDay","weekendsAreWorkdays","defaultAvailability"],i=0,e=f.length;i<e;i++)t=f[i],n[t+"Field"]in n.rawConfig&&(r="get"+Ext.String.capitalize(t),u[t]=n[r]());return u},getModelConfig:function(n,t){var i={};return t||(i.parentId=n.parent&&n.parent.calendarId,i.calendar=n),i[this.daysPerMonthField]=n.daysPerMonth,i[this.daysPerWeekField]=n.daysPerWeek,i[this.hoursPerDayField]=n.hoursPerDay,i[this.nameField]=n.name,i[this.weekendFirstDayField]=n.weekendFirstDay,i[this.weekendSecondDayField]=n.weekendSecondDay,n.hasOwnProperty("weekendsAreWorkdays")&&(i[this.weekendsAreWorkdaysField]=n.weekendsAreWorkdays),n.hasOwnProperty("defaultAvailability")&&(i[this.defaultAvailabilityField]=n.defaultAvailability),i[this.calendarClassField]=Ext.getClassName(n),i},setCalendarManager:function(n){this.calendarManager=n},getCalendarManager:function(){return this.calendarManager},getParentCalendarClass:function(){for(var n=this.parentNode,t;n&&!t;)t=n.getCalendarClass(),n=n.parentNode;return t},fillDataFromPrototype:function(n){var r=n[this.calendarClassField]||this.treeStore&&this.treeStore.getCalendarClass()||this.getCalendarClass()||this.getParentCalendarClass()||this.getField(this.calendarClassField).getDefaultValue(),t,i;if(r&&(n[this.calendarClassField]||(n[this.calendarClassField]=r),t=n.children,t&&t.length))for(i=0;i<t.length;i++)this.fillDataFromPrototype(t[i])},prepareCalendarNode:function(n){return n instanceof Gnt.data.Calendar?n=this.getModelConfig(n):!Ext.isObject(n)||n instanceof Gnt.model.Calendar||this.fillDataFromPrototype(n),n=this.createNode(n),this.phantom&&this.getId()!==n.data[this.phantomParentIdField]&&(n.modified=n.modified||{},n.modified[this.phantomParentIdField]=n.data[this.phantomParentIdField],n.data[this.phantomParentIdField]=this.getId()),n}},function(){Ext.data.NodeInterface.decorate(this);this.override({insertBefore:function(n){return n=this.prepareCalendarNode(n),this.callParent(arguments)},appendChild:function(n){if(n instanceof Array)for(var t=0;t<n.length;t++)n[t]=this.prepareCalendarNode(n[t]);else n=this.prepareCalendarNode(n);return this.callParent(arguments)}})});Ext.define("Gnt.model.CalendarDay",{extend:Sch.model.Customizable,idProperty:"Id",customizableFields:[{name:"Date",type:"date",dateFormat:"c",persist:!0,convert:function(n){if(n){var t=Ext.data.Types.DATE.convert.call(this,n);return t&&Ext.Date.clearTime(t),t}}},{name:"Weekday",type:"int"},{name:"OverrideStartDate",type:"date",dateFormat:"c"},{name:"OverrideEndDate",type:"date",dateFormat:"c"},{name:"Type",defaultValue:"DAY"},{name:"IsWorkingDay",type:"boolean",defaultValue:!1},{name:"Cls",defaultValue:"gnt-holiday"},"Name",{name:"Availability",persist:!0,convert:function(n){return n?typeof n=="string"?[n]:n:[]}}],availabilityCache:null,weekDayField:"Weekday",overrideStartDateField:"OverrideStartDate",overrideEndDateField:"OverrideEndDate",typeField:"Type",dateField:"Date",isWorkingDayField:"IsWorkingDay",clsField:"Cls",nameField:"Name",availabilityField:"Availability",setDate:function(n){n&&(n=Ext.Date.clearTime(n,!0));this.set(this.dateField,n)},clearDate:function(){this.set(this.dateField,null)},getAvailability:function(n){var i=this,t;return n?this.get(this.availabilityField):this.availabilityCache?this.availabilityCache:(t=Ext.Array.map(this.get(this.availabilityField),function(n){return typeof n=="string"?i.parseInterval(n):n}),this.verifyAvailability(t),this.availabilityCache=t)},setAvailability:function(n){this.availabilityCache=null;this.set(this.availabilityField,this.stringifyIntervals(n));this.getAvailability()},verifyAvailability:function(n){var t=this;n.sort(function(n,t){return n.startTime-t.startTime});Ext.Array.each(n,function(i,r){if(i.startTime>i.endTime)throw new Error("Start time "+Ext.Date.format(i.startTime,"H:i")+" is greater than end time "+Ext.Date.format(i.endTime,"H:i"));if(r>0&&n[r-1].endTime>i.startTime)throw new Error("Availability intervals should not intersect: ["+t.stringifyInterval(n[r-1])+"] and ["+t.stringifyInterval(i)+"]");})},prependZero:function(n){return n<10?"0"+n:n},stringifyInterval:function(n){var i=n.startTime,t=n.endTime;return this.prependZero(i.getHours())+":"+this.prependZero(i.getMinutes())+"-"+(t.getDate()==1?24:this.prependZero(t.getHours()))+":"+this.prependZero(t.getMinutes())},stringifyIntervals:function(n){var t=this;return Ext.Array.map(n,function(n){return typeof n=="string"?n:t.stringifyInterval(n)})},parseInterval:function(n){var t=/(\d\d):(\d\d)-(\d\d):(\d\d)/.exec(n);if(!t)throw"Invalid format for availability string: "+n+". It should have exact format: hh:mm-hh:mm";return{startTime:new Date(0,0,0,t[1],t[2]),endTime:new Date(0,0,0,t[3],t[4])}},getTotalHours:function(){return this.getTotalMS()/36e5},getTotalMS:function(){var n=0;return Ext.Array.each(this.getAvailability(),function(t){n+=t.endTime-t.startTime}),n},addAvailabilityInterval:function(n,t){var r,i;r=n instanceof Date?{startTime:n,endTime:t}:this.parseInterval(n+(t?"-"+t:""));i=this.getAvailability().concat(r);this.verifyAvailability(i);this.setAvailability(i)},removeAvailabilityInterval:function(n){var t=this.getAvailability();t.splice(n,1);this.setAvailability(t)},getAvailabilityIntervalsFor:function(n){n=typeof n=="number"?new Date(n):n;var t=n.getFullYear(),i=n.getMonth(),r=n.getDate();return Ext.Array.map(this.getAvailability(),function(n){var u=n.endTime.getDate();return{startDate:new Date(t,i,r,n.startTime.getHours(),n.startTime.getMinutes()),endDate:new Date(t,i,r+(u==1?1:0),n.endTime.getHours(),n.endTime.getMinutes())}})},getAvailabilityStartFor:function(n){var t=this.getAvailabilityIntervalsFor(n);return t.length?t[0].startDate:null},getAvailabilityEndFor:function(n){var t=this.getAvailabilityIntervalsFor(n);return t.length?t[t.length-1].endDate:null}});Ext.define("Gnt.data.Calendar",{extend:Ext.data.Store,mixins:[Sch.data.mixin.UniversalModelGetter,Robo.data.Store],model:"Gnt.model.CalendarDay",daysPerMonth:30,daysPerWeek:7,hoursPerDay:24,unitsInMs:null,defaultNonWorkingTimeCssCls:"gnt-holiday",weekendsAreWorkdays:!1,weekendFirstDay:6,weekendSecondDay:0,holidaysCache:null,availabilityIntervalsCache:null,daysIndex:null,weekAvailability:null,defaultWeekAvailability:null,nonStandardWeeksByStartDate:null,nonStandardWeeksStartDates:null,calendarId:null,parent:null,defaultAvailability:["00:00-24:00"],name:null,suspendCacheUpdate:0,availabilitySearchLimit:1825,statics:{getCalendar:function(n){return n instanceof Gnt.data.Calendar?n:Ext.data.StoreManager.lookup("GNT_CALENDAR:"+n)},getAllCalendars:function(){var n=[];return Ext.data.StoreManager.each(function(t){t instanceof Gnt.data.Calendar&&n.push(t)}),n},removeAll:function(){var n=Ext.data.StoreManager;n.each(function(t){t instanceof Gnt.data.Calendar&&(n.unregister(t),Ext.destroy(t))})}},constructor:function(n){var t,i;n=n||{};t=n.parent;delete n.parent;i=n.calendarId;delete n.calendarId;this.callParent(arguments);this.setParent(t);this.setCalendarId(i);this.unitsInMs={MILLI:1,SECOND:1e3,MINUTE:6e4,HOUR:36e5,DAY:this.hoursPerDay*36e5,WEEK:this.daysPerWeek*this.hoursPerDay*36e5,MONTH:this.daysPerMonth*this.hoursPerDay*36e5,QUARTER:2592e5*this.daysPerMonth,YEAR:10368e5*this.daysPerMonth};this.defaultWeekAvailability=this.getDefaultWeekAvailability();this.on({update:this.clearCache,datachanged:this.clearCache,clear:this.clearCache,scope:this});this.clearCache()},getCalendarId:function(){return this.calendarId},setCalendarId:function(n){this.calendarId!=null&&Ext.data.StoreManager.unregister(this);this.calendarId=n;n!=null?(this.storeId="GNT_CALENDAR:"+n,Ext.data.StoreManager.register(this)):this.storeId=null;var t=this.proxy;t&&t.extraParams&&(t.extraParams.calendarId=n)},getDefaultWeekAvailability:function(){for(var t=this.defaultAvailability,r=this.weekendFirstDay,u=this.weekendSecondDay,i=[],n=0;n<7;n++)i.push(this.weekendsAreWorkdays||n!=r&&n!=u?new this.model({Type:"WEEKDAY",Weekday:n,Availability:t&&t.slice()||[],IsWorkingDay:!0}):new this.model({Type:"WEEKDAY",Weekday:n,Availability:[]}));return i},clearCache:function(){if(!(this.suspendCacheUpdate>0)){this.holidaysCache={};this.availabilityIntervalsCache={};var i=this.daysIndex={},r=this.weekAvailability=[],t=this.nonStandardWeeksStartDates=[],n=this.nonStandardWeeksByStartDate={};this.each(function(u){var v=u.getId(),o=/^(\d)-(\d\d\d\d\/\d\d\/\d\d)-(\d\d\d\d\/\d\d\/\d\d)$/.exec(v),c=/^WEEKDAY:(\d+)$/.exec(v),l=u.getType(),f=u.getWeekday(),s,h,e,a;if(l=="WEEKDAYOVERRIDE"||o)l=="WEEKDAYOVERRIDE"&&(s=u.getOverrideStartDate(),h=u.getOverrideEndDate()),o&&(s=Ext.Date.parse(o[2],"Y/m/d"),h=Ext.Date.parse(o[3],"Y/m/d"),f=o[1]),s&&h&&f!=null&&(e=+s,n[e]||(n[e]={startDate:new Date(s),endDate:new Date(h),name:u.getName(),weekAvailability:[],mainDay:null},t.push(e)),f>=0?n[e].weekAvailability[f]=u:n[e].mainDay=u);else if(l=="WEEKDAY"||c){if(c&&(f=c[1]),f!=null){if(f<0||f>6)throw new Error("Incorrect week day index");r[f]=u}}else a=u.getDate(),a&&(i[+a]=u)});t.sort(function(n,t){return n-t});this.fireEvent("calendarchange",this)}},intersectsWithCurrentWeeks:function(n,t){var i=!1;return this.forEachNonStandardWeek(function(r){var u=r.startDate,f=r.endDate;if(u<=n&&n<f||u<t&&t<=f)return i=!0,!1}),i},addNonStandardWeek:function(n,t,i,r){var e,f,u;if(n=Ext.Date.clearTime(new Date(n)),t=Ext.Date.clearTime(new Date(t)),this.intersectsWithCurrentWeeks(n,t))throw new Error("Can not add intersecting week");e=this.model;f=[];Ext.Array.each(i,function(i,u){if(i instanceof Gnt.model.CalendarDay)i.setType("WEEKDAYOVERRIDE"),i.setOverrideStartDate(n),i.setOverrideEndDate(t),i.setWeekday(u),i.setName(r||"Week override"),f.push(i);else if(Ext.isArray(i)){var o=new e;o.setType("WEEKDAYOVERRIDE");o.setOverrideStartDate(n);o.setOverrideEndDate(t);o.setWeekday(u);o.setName(r||"Week override");o.setAvailability(i);f.push(o)}});u=new e;u.setType("WEEKDAYOVERRIDE");u.setOverrideStartDate(n);u.setOverrideEndDate(t);u.setWeekday(-1);u.setName(r||"Week override");f.push(u);this.add(f)},getNonStandardWeekByStartDate:function(n){return this.nonStandardWeeksByStartDate[Ext.Date.clearTime(new Date(n))-0]||null},getNonStandardWeekByDate:function(n){var r,u,i,t;for(n=Ext.Date.clearTime(new Date(n))-0,r=this.nonStandardWeeksStartDates,u=this.nonStandardWeeksByStartDate,i=0;i<r.length;i++){if(t=u[r[i]],t.startDate>n)break;if(t.startDate<=n&&n<=t.endDate)return t}return null},removeNonStandardWeek:function(n){n=Ext.Date.clearTime(new Date(n))-0;var t=this.getNonStandardWeekByStartDate(n);t&&this.remove(Ext.Array.clean(t.weekAvailability).concat(t.mainDay))},forEachNonStandardWeek:function(n,t){for(var u=this,r=this.nonStandardWeeksStartDates,f=this.nonStandardWeeksByStartDate,i=0;i<r.length;i++)if(n.call(t||u,f[r[i]])===!1)return!1},setWeekendsAreWorkDays:function(n){n!==this.weekendsAreWorkdays&&(this.weekendsAreWorkdays=n,this.defaultWeekAvailability=this.getDefaultWeekAvailability(),this.clearCache())},areWeekendsWorkDays:function(){return this.weekendsAreWorkdays},getCalendarDay:function(n){return n=typeof n=="number"?new Date(n):n,this.getOverrideDay(n)||this.getWeekDay(n.getDay(),n)||this.getDefaultCalendarDay(n.getDay())},getOverrideDay:function(n){return this.getOwnCalendarDay(n)||this.parent&&this.parent.getOverrideDay(n)||null},getOwnCalendarDay:function(n){return n=typeof n=="number"?new Date(n):n,this.daysIndex[Ext.Date.clearTime(n,!0)-0]},getWeekDay:function(n,t){if(t){var i=this.getNonStandardWeekByDate(t);if(i&&i.weekAvailability[n])return i.weekAvailability[n]}return this.weekAvailability[n]||this.parent&&this.parent.getWeekDay(n,t)||null},getDefaultCalendarDay:function(n){return!this.hasOwnProperty("defaultAvailability")&&!this.hasOwnProperty("weekendsAreWorkdays")&&this.parent?this.parent.getDefaultCalendarDay(n):this.defaultWeekAvailability[n]},isHoliday:function(n){var t=+n,i=this.holidaysCache,r;if(i[t]!=null)return i[t];if(n=typeof n=="number"?new Date(n):n,r=this.getCalendarDay(n),!r)throw"Can't find day for "+n;return i[t]=!r.getIsWorkingDay()},isWeekend:function(n){var t=n.getDay();return t===this.weekendFirstDay||t===this.weekendSecondDay},isWorkingDay:function(n){return!this.isHoliday(n)},convertMSDurationToUnit:function(n,t){return n/this.unitsInMs[Sch.util.Date.getNameOfUnit(t)]},convertDurationToMs:function(n,t){return n*this.unitsInMs[Sch.util.Date.getNameOfUnit(t)]},getHolidaysRanges:function(n,t,i){var f,r,u;for(n>t&&Ext.Error.raise("startDate can't be bigger than endDate"),n=Ext.Date.clearTime(n,!0),t=Ext.Date.clearTime(t,!0),f=[],u=n;u<t;u=Sch.util.Date.getNext(u,Sch.util.Date.DAY,1))if(this.isHoliday(u)||this.weekendsAreWorkdays&&i&&this.isWeekend(u)){var s=this.getCalendarDay(u),e=s&&s.getCls()||this.defaultNonWorkingTimeCssCls,o=Sch.util.Date.getNext(u,Sch.util.Date.DAY,1);r?r.getCls()==e?r.setEndDate(o):(f.push(r),r=new Sch.model.Range({StartDate:u,EndDate:o,Cls:e})):r=new Sch.model.Range({StartDate:u,EndDate:o,Cls:e})}else r&&(f.push(r),r=null);return r&&f.push(r),f},forEachAvailabilityInterval:function(n,t,i){var e,s,h,c,o,v,y;i=i||this;var w=this,u=n.startDate,f=n.endDate,r=n.isForward!==!1;if(r?!u:!f)throw new Error("At least `startDate` or `endDate` is required, depending from the `isForward` option");for(e=new Date(r?u:f),s=Sch.util.Date,r?f||(f=s.add(u,"d",n.availabilitySearchLimit||this.availabilitySearchLimit||1825)):u||(u=s.add(f,"d",-(n.availabilitySearchLimit||this.availabilitySearchLimit||1825))),h=!1;r?e<f:e>u;){for(c=this.getAvailabilityIntervalsFor(e-(r?0:1),r?h:!1),o=r?0:c.length-1;r?o<c.length:o>=0;r?o++:o--){var p=c[o],l=p.startDate,a=p.endDate;if(!(l>=f)&&!(a<=u)&&(v=l<u?u:l,y=a>f?f:a,t.call(i,v,y)===!1))return!1}e=r?s.getStartOfNextDay(e,!1,h):s.getEndOfPreviousDay(e,h);h=!0}},calculateDuration:function(n,t,i){var r=0;return this.forEachAvailabilityInterval({startDate:n,endDate:t},function(n,t){var i=n.getTimezoneOffset()-t.getTimezoneOffset();r+=t-n+i*6e4}),this.convertMSDurationToUnit(r,i)},calculateEndDate:function(n,t,i){var r,u,f;return t?(r=Sch.util.Date,t=this.convertDurationToMs(t,i),f=t===0&&Ext.Date.clearTime(n,!0)-n==0?r.add(n,Sch.util.Date.DAY,-1):n,this.forEachAvailabilityInterval({startDate:f},function(n,i){var r=i-n,f=n.getTimezoneOffset()-i.getTimezoneOffset();if(r>=t)return u=new Date(+n+t),!1;t-=r+f*6e4}),u):new Date(n)},calculateStartDate:function(n,t,i){if(!t)return new Date(n);var r;return t=this.convertDurationToMs(t,i),this.forEachAvailabilityInterval({endDate:n,isForward:!1},function(n,i){var u=i-n;if(u>=t)return r=new Date(i-t),!1;t-=u}),r},skipNonWorkingTime:function(n,t){var i=!1;if(this.forEachAvailabilityInterval(t?{startDate:n}:{endDate:n,isForward:!1},function(r,u){return n=t?r:u,i=!0,!1}),!i)throw"skipNonWorkingTime: Cannot skip non-working time, please ensure that this calendar has any working period of time specified";return new Date(n)},skipWorkingTime:function(n,t,i){return t>=0?this.calculateEndDate(n,t,i):this.calculateStartDate(n,-t,i)},getAvailabilityIntervalsFor:function(n,t){return n=t?n.valueOf():n instanceof Date?new Date(n.getFullYear(),n.getMonth(),n.getDate()).valueOf():Ext.Date.clearTime(new Date(n)).valueOf(),this.availabilityIntervalsCache[n]=this.availabilityIntervalsCache[n]||this.getCalendarDay(n).getAvailabilityIntervalsFor(n)},isChildOf:function(n){for(var t=this,i=!1;t&&!i;)i=t===n,t=t.parent;return i},getParentableCalendars:function(){var n=this,t=[],i=Gnt.data.Calendar.getAllCalendars();return Ext.Array.each(i,function(i){i===n||i.isChildOf(n)||t.push({Id:i.calendarId,Name:i.name||i.calendarId})}),t},setParent:function(n){var t=Gnt.data.Calendar.getCalendar(n);if(n&&!t)throw new Error("Invalid parent specified for the calendar");if(this.parent!=t){var i=this.proxy,u={calendarchange:this.clearCache,destroy:this.onParentDestroy,scope:this},r=this.parent;if(r&&r.un(u),this.parent=t,t)t.on(u);i&&i.extraParams&&(i.extraParams.parentId=t?t.calendarId:null);this.clearCache();this.fireEvent("parentchange",this,t,r)}},onParentDestroy:function(){this.setParent(null)},isAvailabilityIntersected:function(n,t,i){for(var u,l,f,a,s,h,e,c,o,r=0;r<7;r++)if(h=this.getWeekDay(r)||this.getDefaultCalendarDay(r),c=n.getWeekDay(r)||n.getDefaultCalendarDay(r),h&&c)for(e=h.getAvailability(),o=c.getAvailability(),u=0,l=e.length;u<l;u++)for(f=0,a=o.length;f<a;f++)if(o[f].startTime<e[u].endTime&&o[f].endTime>e[u].startTime)return!0;return s=!1,this.forEachNonStandardWeek(function(n){return n.startDate>=i?!1:t<n.endDate?(s=!0,!1):void 0}),s}});Ext.define("Gnt.field.Calendar",{extend:Ext.form.field.ComboBox,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.calendarfield",alternateClassName:"Gnt.widget.CalendarField",taskField:"calendarIdField",getTaskValueMethod:"getCalendarId",setTaskValueMethod:"setCalendarId",pickerAlign:"tl-bl?",matchFieldWidth:!0,editable:!0,triggerAction:"all",valueField:"Id",displayField:"Name",queryMode:"local",forceSelection:!0,allowBlank:!0,initComponent:function(){var n=this,t=n.getInitialConfig();(!t.store||n.store.isEmptyStore)&&(n.store={xclass:"Ext.data.Store",autoDestroy:!0,model:"Gnt.model.Calendar"});n.store instanceof Ext.data.Store||(n.store=Ext.create(n.store));n.callParent(arguments);n.updateCalendarsStore();n.mon(Ext.data.StoreManager,{add:function(n,t){t instanceof Gnt.data.Calendar&&this.updateCalendarsStore()},remove:function(n,t){t instanceof Gnt.data.Calendar&&this.updateCalendarsStore()},scope:n});n.on({show:function(){n.setReadOnly(n.readOnly)}});n.on("change",n.onFieldChange,n)},updateCalendarsStore:function(){this.store.loadData(this.getCalendarData())},setReadOnly:function(n){n=n||this.store.count()===0;this.callParent([n])},getCalendarData:function(){return Ext.Array.map(Gnt.data.Calendar.getAllCalendars(),function(n){return{Id:n.calendarId,Name:n.name||n.calendarId}})},onSetTask:function(){this.setReadOnly(this.readOnly);this.setValue(this.getTaskValue())},valueToVisible:function(n){var t=this,i=[],r=this.findRecordByValue(n);return r?i.push(r.data):Ext.isDefined(t.valueNotFoundText)&&typeof t.valueNotFoundText=="string"&&i.push(t.valueNotFoundText),t.displayTpl.apply(i)},getValue:function(){return this.value||""},getErrors:function(n){var i,t;return n&&(i=this.findRecordByDisplay(n),i&&this.task&&!this.task.isCalendarApplicable(i.getId()))?[this.L("calendarNotApplicable")]:(t=this.callParent(arguments),t&&t.length)?t:Ext.isEmpty(n)||this.findRecordByDisplay(n)||this.findRecordByValue(n)?[]:[this.L("invalidText")]},onFieldChange:function(n,t){this.setValue(t)},setValue:function(n){this.callParent([n]);(undefined===n||null===n||""===n)&&(this.value="");this.instantUpdate&&!this.getSuppressTaskUpdate()&&this.task&&this.getTaskValue()!=this.value&&this.applyChanges()},assertValue:function(){var n=this.getRawValue();!n&&this.value?this.setValue(""):this.callParent(arguments)}});Ext.define("Gnt.column.Calendar",{extend:Ext.grid.column.Column,alias:["widget.calendarcolumn","widget.ganttcolumn.calendar"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:100,align:"left",instantUpdate:!0,store:null,fieldProperty:"calendarIdField",fieldConfigs:["instantUpdate","store","fieldProperty"],editor:"calendarfield",defaultEditor:"calendarfield",initComponent:function(){this.initTaskFieldColumn({format:this.editorFormat||this.format||Ext.Date.defaultFormat});this.callParent(arguments)},applyColumnCls:function(n,t){n||(t.tdCls=(t.tdCls||"")+" gnt-default")},getValueToRender:function(n,t,i,r,u,f){return n=n||(f.calendar?f.calendar.calendarId:""),this.field.valueToVisible(n,i)||n}});Ext.define("Gnt.field.ConstraintDate",{extend:Gnt.field.Date,alias:"widget.constraintdatefield",taskField:"constraintDateField",getTaskValueMethod:"getConstraintDate",setTaskValueMethod:"setConstraintDate",reAssertValue:!1,valueToVisible:function(n,t){t=t||this.task;var r=this,i=t&&t.getConstraintClass(),u=r.format||Ext.Date.defaultFormat;return i?i.getDisplayableConstraintDateForFormat(n,u,t):n},visibleToValue:function(n){var i=this,u=i.format||Ext.Date.defaultFormat,t=i.task,r=t&&t.getConstraintClass();return r&&!Ext.isEmpty(n)&&(n=r.adjustConstraintDateFromDisplayableWithFormat(n,u,t)),n}});Ext.define("Gnt.column.ConstraintDate",{extend:Ext.grid.column.Date,alias:["widget.constraintdatecolumn","widget.ganttcolumn.constraintdate"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:100,align:"left",fieldProperty:"constraintDateField",editor:"constraintdatefield",defaultEditor:"constraintdatefield",initComponent:function(){this.initTaskFieldColumn({format:this.editorFormat||this.format||Ext.Date.defaultFormat,taskField:this.fieldProperty});this.callParent(arguments)},getValueToRender:function(n,t,i){return n&&Ext.Date.format(this.field.valueToVisible(n,i),this.format)||""}});Ext.define("Gnt.field.ConstraintType",{extend:Ext.form.field.ComboBox,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.constrainttypefield",alternateClassName:"Gnt.widget.ConstraintType.Field",taskField:"constraintTypeField",getTaskValueMethod:"getConstraintType",setTaskValueMethod:"setConstraint",pickerAlign:"tl-bl?",matchFieldWidth:!1,forceSelection:!0,triggerAction:"all",initComponent:function(){var n=this,t=n.L("none");n.store=n.store||Gnt.field.ConstraintType.buildDefaultConstraintTypeList(t);n.emptyText=n.emptyText||t;this.on("change",this.onFieldChange,this);n.callParent(arguments)},getErrors:function(n){var t=this.callParent(arguments);return t&&t.length?t:Ext.isEmpty(n)||this.findRecordByDisplay(n)||this.findRecordByValue(n)?[]:[this.L("invalidText")]},valueToVisible:function(n){var t=this,i=[],r=this.findRecordByValue(Ext.isEmpty(n)?null:n);return r?i.push(r.data):Ext.isDefined(t.valueNotFoundText)&&i.push(t.valueNotFoundText||""),t.displayTpl.apply(i)},applyChanges:function(n){var t=this,r=t.getValue(),i;n=n||t.task;i=Gnt.constraint.Base.getConstraintClass(r);t.setTaskValue(n,r,i&&i.getInitialConstraintDate(n)||null);n.fireEvent("taskupdated",n,t)},findRecordByDisplay:function(n){return n?this.callParent(arguments):this.store.first()},onFieldChange:function(n,t){var i=this;i.getSuppressTaskUpdate()||!i.task||!t&&this.getRawValue()!=i.L("none")&&(t||this.getRawValue())||i.applyChanges()},statics:{buildDefaultConstraintTypeList:function(n){var t=[];return Ext.Array.each(Ext.ClassManager.getNamesByExpression("gntconstraint.*"),function(n){var i=Ext.ClassManager.get(n),r=i.alias[0],u=r.split(".").pop();i&&t.push([u,i.L("name")])}),t=Ext.Array.sort(t,function(n,t){return n[1]>t[1]?1:-1}),n&&t.unshift([null,n]),t}}});Ext.define("Gnt.column.ConstraintType",{extend:Ext.grid.column.Column,mixins:[Gnt.column.mixin.TaskFieldColumn],alias:["widget.constrainttypecolumn","widget.ganttcolumn.constrainttype"],width:100,align:"left",data:null,fieldProperty:"constraintTypeField",editor:"constrainttypefield",defaultEditor:"constrainttypefield",initComponent:function(){this.initTaskFieldColumn({store:this.data,taskField:this.fieldProperty});this.callParent(arguments)},getValueToRender:function(n,t,i){return n&&this.field.valueToVisible(n,i)||""}});Ext.define("Gnt.field.DeadlineDate",{extend:Gnt.field.Date,alias:"widget.deadlinedatefield",taskField:"deadlineDateField",getTaskValueMethod:"getDeadlineDate",setTaskValueMethod:"setDeadlineDate",valueToVisible:function(n,t){return t=t||this.task,t.getDisplayEndDate(this.format,!0,n,!0)},visibleToValue:function(n){return n&&n-Ext.Date.clearTime(n,!0)==0&&(n=Sch.util.Date.add(n,Sch.util.Date.DAY,1)),n}});Ext.define("Gnt.column.DeadlineDate",{extend:Ext.grid.column.Date,alias:["widget.deadlinecolumn","widget.ganttcolumn.deadline"],mixins:[Gnt.column.mixin.TaskFieldColumn],draggable:!0,fieldProperty:"deadlineDateField",editor:"deadlinedatefield",initComponent:function(){this.initTaskFieldColumn();this.callParent(arguments)},getValueToRender:function(n,t,i){return n&&Ext.Date.format(this.field.valueToVisible(n,i),this.format)||""}});Ext.define("Gnt.util.DurationParser",{mixins:[Gnt.mixin.Localizable],parseNumberFn:null,durationRegex:null,allowDecimals:!0,constructor:function(n){Ext.apply(this,n);this.unitsRegex&&Ext.apply(this.l10n.unitsRegex,this.unitsRegex);this.durationRegex||(this.durationRegex=this.allowDecimals?/^\s*([\-+]?\d+(?:[.,]\d*)?|[\-+]?(?:[.,]\d+))\s*(\w+)?/i:/^\s*([\-+]?\d+)(?![.,])\s*(\w+)?/i)},parse:function(n){var t=this.durationRegex.exec(n),u,i,r;return n==null||!t?null:(u=this.parseNumberFn(t[1]),i=t[2],i&&(Ext.iterate(this.L("unitsRegex"),function(n,t){if(t.test(i))return r=Sch.util.Date.getUnitByName(n),!1}),!r))?null:{value:u,unit:r}}});Ext.define("Gnt.util.DependencyParser",{mixins:[Gnt.mixin.Localizable],separator:/\s*;\s*/,parseNumberFn:null,dependencyRegex:null,types:null,constructor:function(n){var i,t,r;for(Ext.apply(this,n),this.initTypes(),i=this.L("typeText"),t=0;t<this.types.length;t++)this.types[t]=i[this.types[t]]||this.types[t];r="(-?\\d+)("+this.types.join("|")+")?([\\+\\-].*)?";this.dependencyRegex=this.dependencyRegex||new RegExp(r,"i");this.durationParser=new Gnt.util.DurationParser({parseNumberFn:this.parseNumberFn})},initTypes:function(){this.types=this.types||["SS","SF","FS","FF"]},parse:function(n){var i,f,r,t,e,u;if(!n)return[];var o=n.split(this.separator),s=[],h=this.dependencyRegex;for(i=0;i<o.length;i++)if(f=o[i],f||i!=o.length-1){if(r=h.exec(f),t={},!r)return null;if(t.taskId=parseInt(r[1],10),t.type=Ext.Array.indexOf(this.types,(r[2]||this.types[2]).toUpperCase()),e=r[3],e){if(u=this.durationParser.parse(e),!u)return null;t.lag=u.value;t.lagUnit=u.unit||"d"}s.push(t)}return s}});Ext.define("Gnt.field.Dependency",{extend:Ext.form.field.Text,alternateClassName:"Gnt.widget.DependencyField",alias:"widget.dependencyfield",mixins:[Gnt.mixin.Localizable],type:"predecessors",separator:";",task:null,dependencyParser:null,dependencyParserConfig:null,useSequenceNumber:!1,constructor:function(n){var t=this;Ext.apply(this,n);this.dependencyParser=new Gnt.util.DependencyParser(Ext.apply({parseNumberFn:function(){return Gnt.widget.DurationField.prototype.parseValue.apply(t,arguments)}},this.dependencyParserConfig));this.callParent(arguments);this.addCls("gnt-field-dependency")},isPredecessor:function(){return this.type==="predecessors"},setTask:function(n){this.task=n;this.setRawValue(this.getFieldDisplayValue(n))},getDependencies:function(){return this.dependencyParser.parse(this.getRawValue())},getTaskIdFromDependency:function(n){var r=this.task.getTaskStore(),t=n.taskId,i;return this.useSequenceNumber&&(i=r.getBySequenceNumber(t),t=i&&i.getId()),t},getErrors:function(n){var c,t,i,f,e,a,r;if(!n)return[];if(c=this.dependencyParser.parse(n),!c)return[this.L("invalidFormatText")];var v=this.getDependencies(),l=this.isPredecessor(),o=this.task,u=o.getTaskStore().dependencyStore,w=o[l?"predecessors":"successors"],y=this.dependencyParser.types,p=u.allowedDependencyTypes,b=u.model.Type,s,h=[];for(t=0;t<v.length;t++){if(i=v[t],s=this.getTaskIdFromDependency(i),!s)return[this.L("invalidDependencyText")];if(u.allowedDependencyTypes&&!u.isValidDependencyType(i.type)){for(f="",e=0,a=p.length;e<a;e++)f+=y[b[p[e]]]+",";return[Ext.String.format(this.L("invalidDependencyType"),y[i.type],f.substring(0,f.length-1))]}r=new u.model;r.setSourceId(l?s:o.getId());r.setTargetId(l?o.getId():s);r.setType(i.type);r.setLag(i.lag,i.lagUnit);h.push(r)}for(t=0;t<h.length;t++)if(!u.isValidDependency(h[t],h,w))return[this.invalidDependencyText];return this.callParent([c.value])},getFieldDisplayValue:function(n){for(var t,f=this.isPredecessor(),e=f?n.getIncomingDependencies(!0):n.getOutgoingDependencies(!0),c=this.dependencyParser.types,l=Gnt.model.Dependency.Type.EndToStart,o=[],i,u=0;u<e.length;u++)if(t=e[u],i=f?t.getSourceTask():t.getTargetTask(),i&&t.isValid(!1)){var s=t.getType(),r=t.getLag(),h=t.getLagUnit();o.push(Ext.String.format("{0}{1}{2}{3}{4}",this.useSequenceNumber?i.getSequenceNumber():i.getId(),r||s!==l?c[s]:"",r>0?"+":"",r||"",r&&h!=="d"?h:""))}return o.join(this.separator)},isDirty:function(n){var t,r,u;if(n=n||this.task,!n)return!1;var f=this.isPredecessor(),e=n.getTaskStore().dependencyStore,i=f?n.getIncomingDependencies():n.getOutgoingDependencies(),o=n.getId();for(t=0,r=i.length;t<r;t++)if(i[t].dirty||i[t].phantom)return!0;if(e)for(u=f?"getTargetId":"getSourceId",i=e.getRemovedRecords(),t=0,r=i.length;t<r;t++)if(i[t][u]()==o)return!0;return!1},applyChanges:function(n){var u;n=n||this.task;for(var f=n.getTaskStore().dependencyStore,o=this.getDependencies(),e=this.isPredecessor(),s=e?n.getIncomingDependencies(!0):n.getOutgoingDependencies(!0),h=[],l=Ext.Array.map(o,function(n){return this.getTaskIdFromDependency(n)},this),i=0;i<s.length;i++)Ext.Array.contains(l,s[i][e?"getSourceId":"getTargetId"]())||h.push(s[i]);for(h.length>0&&f.remove(h),u=[],i=0;i<o.length;i++){var r=o[i],c=this.getTaskIdFromDependency(r),t=f.getByTaskIds(c,n.getId());t?(t.beginEdit(),t.setType(r.type),t.setLag(r.lag,r.lagUnit),t.endEdit()):(t=new f.model,t.setSourceId(e?c:n.getId()),t.setTargetId(e?n.getId():c),t.setType(r.type),t.setLag(r.lag,r.lagUnit),u.push(t))}u.length>0&&f.add(u)}});Ext.define("Gnt.column.Dependency",{extend:Ext.grid.column.Column,separator:";",type:"predecessors",field:null,useSequenceNumber:!1,constructor:function(n){n=n||{};var t=n.editor;delete n.editor;Ext.apply(this,n);n.editor=t||Ext.create("Gnt.field.Dependency",{type:this.type,separator:this.separator,useSequenceNumber:this.useSequenceNumber});n.editor instanceof Gnt.widget.DependencyField||(n.editor=Ext.ComponentManager.create(n.editor,"dependencyfield"));n.field=n.editor;this.scope=this;this.callParent([n])},afterRender:function(){var n=this.up("ganttpanel");n.registerLockedDependencyListeners();this.callParent(arguments)},getContainingPanel:function(){return this.panel||(this.panel=this.up("tablepanel")),this.panel},setDirtyClass:function(n,t){var i=this.getContainingPanel().getView();i.markDirty&&this.field.isDirty(t)&&(n.tdCls=i.dirtyCls)},isEditable:function(n){var t=this.gantt||this.up("ganttpanel");return n.isProject?!1:!n.isProject&&(t&&t.allowParentTaskDependencies||n.isLeaf())},getRawData:function(n){var t;return t=this.type==="predecessors"?n.getIncomingDependencies(!0):n.getOutgoingDependencies(!0),Ext.Array.map(t,function(n){var t=n.copy(null).data;return delete t[n.idProperty],t})},renderer:function(n,t,i){return i.isEditable(this.dataIndex)&&this.isEditable(i)?this.setDirtyClass(t,i):t.tdCls=(t.tdCls||"")+" sch-column-readonly",this.field.getFieldDisplayValue(i)}});Ext.define("Gnt.field.trigger.DurationSpinner",{extend:Ext.form.trigger.Spinner,alias:"trigger.gantt_durationspinner",initEvents:function(){var n=this,t=n.isFieldEnabled,i=n.getStateEl(),r=n.el;i.addClsOnOver(n.overCls,t,n);i.addClsOnClick(n.clickCls,t,n);n.repeatClick?n.clickRepeater=new Ext.util.ClickRepeater(r,Ext.apply({preventDefault:!0,handler:n.onClick,delay:Ext.isIE?1e3:250,listeners:{mousedown:n.onClickRepeaterMouseDown,scope:n},scope:n},this.repeaterConfig)):n.field.mon(r,{click:n.onClick,mousedown:n.onMouseDown,scope:n})},onClick:function(){var n=this,r=arguments,i=n.clickRepeater?r[1]:r[0],t=n.field;t.readOnly||t.disabled||(n.upEl.contains(i.target)?Ext.callback(n.upHandler,n.scope,[t,n,i],0,t):n.downEl.contains(i.target)&&Ext.callback(n.downHandler,n.scope,[t,n,i],0,t));Ext.isIE||t.inputEl.focus()}});Ext.define("Gnt.field.Duration",{extend:Ext.form.field.Number,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.durationfield",alternateClassName:"Gnt.widget.DurationField",disableKeyFilter:!0,allowExponential:!1,minValue:0,durationUnit:"h",config:{triggers:{spinner:{type:"gantt_durationspinner",upHandler:"onSpinnerUpClick",downHandler:"onSpinnerDownClick",scope:"this"}}},useAbbreviation:!1,getDurationUnitMethod:"getDurationUnit",setTaskValueMethod:"setDuration",getTaskValueMethod:"getDuration",taskField:"durationField",durationParser:null,durationParserConfig:null,constructor:function(n){var t=this;Ext.apply(this,n);this.durationParser=new Gnt.util.DurationParser(Ext.apply({parseNumberFn:function(){return t.parseValue.apply(t,arguments)},allowDecimals:this.decimalPrecision>0},this.durationParserConfig));this.callParent(arguments);this.invalidText=this.L("invalidText")},onSetTask:function(){this.durationUnit=this.task[this.getDurationUnitMethod]();var n=this.getTaskValueMethod?this.getTaskValue():this.task.get(this.task[this.taskField]);this.setValue(n);this.setSpinUpEnabled(n==null||n<this.maxValue,!0);this.setSpinDownEnabled(n>this.minValue,!0)},rawToValue:function(n){var t=this.parseDuration(n);return t?(this.durationUnit=t.unit,t.value!=null?t.value:null):null},valueToVisible:function(n,t){if(Ext.isNumber(n)){var i=parseInt(n,10),r=Ext.Number.toFixed(n,this.decimalPrecision);return String(i==r?i:r).replace(".",this.decimalSeparator)+" "+Sch.util.Date[this.useAbbreviation?"getShortNameOfUnit":"getReadableNameOfUnit"](t||this.durationUnit,n!==1)}return""},valueToRaw:function(n){return this.valueToVisible(n,this.durationUnit,this.decimalPrecision,this.useAbbreviation)},parseDuration:function(n){if(n==null)return null;var t=this.durationParser.parse(n);return t?(t.unit=t.unit||this.durationUnit,t):null},getDurationValue:function(){return this.parseDuration(this.getRawValue())},getErrors:function(n){var t;if(n){if(t=this.parseDuration(n),!t)return[this.L("invalidText")];n=t.value}return arguments.length>0&&n==null&&(n=""),this.callParent(arguments)},checkChange:function(){if(!this.suspendCheckChange){var t=this,n=t.getDurationValue(),i=t.lastValue,r=n&&!i||!n&&i||n&&i&&(n.value!=i.value||n.unit!=i.unit);if(r&&!t.isDestroyed){t.lastValue=n;t.fireEvent("change",t,n,i);t.onChange(n,i)}}},getValue:function(){return this.value},applyChanges:function(n){n=n||this.task;this.setTaskValue(n,this.getValue(),this.durationUnit);n.fireEvent("taskupdated",n,this)},setValue:function(n,t){var i=n;Ext.isObject(n)&&(this.durationUnit=n.unit,i=n.value);this.callParent([i]);!this.readOnly&&(t||this.instantUpdate)&&!this.getSuppressTaskUpdate()&&this.task&&this.applyChanges()},assertValue:function(){var t=this,i=t.getValue(),u=t.durationUnit,n=t.getDurationValue(),r;this.isValid()&&(r=!n&&i||n&&(n.value!=i||n.unit!=u),r&&t.setValue(n,!0))},beforeBlur:function(){this.assertValue()},onSpinUp:function(){var n=this,t;n.readOnly||(t=n.getValue()||0,n.setSpinValue(Ext.Number.constrain(t+n.step,n.minValue,n.maxValue)))},onSpinDown:function(){var n=this,t;n.readOnly||(t=n.getValue()||0,n.setSpinValue(Ext.Number.constrain(t-n.step,n.minValue,n.maxValue)))}});Ext.define("Gnt.column.Duration",{extend:Ext.grid.column.Column,alias:["widget.durationcolumn","widget.ganttcolumn.duration"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:80,align:"left",decimalPrecision:2,useAbbreviation:!1,instantUpdate:!0,fieldProperty:"durationField",fieldConfigs:["instantUpdate","useAbbreviation","decimalPrecision","fieldProperty"],editor:"durationfield",defaultEditor:"durationfield",initComponent:function(){this.initTaskFieldColumn();this.callParent(arguments)},getValueToRender:function(n,t,i){return Ext.isNumber(n)?this.field.valueToVisible(n,i.getDurationUnit()):""},putRawData:function(n,t){t.setDuration(n)}});Ext.define("Gnt.column.EarlyEndDate",{extend:Ext.grid.column.Date,mixins:[Gnt.mixin.Localizable],alias:["widget.earlyenddatecolumn","widget.ganttcolumn.earlyenddate"],width:100,align:"left",adjustMilestones:!0,constructor:function(n){n=n||{};this.text=n.text||this.L("text");this.callParent(arguments);this.renderer=n.renderer||this.rendererFunc;this.scope=n.scope||this;this.hasCustomRenderer=!0},afterRender:function(){var n=this.up("ganttpanel");n.registerLockedDependencyListeners();this.callParent(arguments)},rendererFunc:function(n,t,i){return t.tdCls=(t.tdCls||"")+" sch-column-readonly",i.getDisplayEndDate(this.format,this.adjustMilestones,i.getEarlyEndDate())}});Ext.define("Gnt.column.EarlyStartDate",{extend:Ext.grid.column.Date,mixins:[Gnt.mixin.Localizable],alias:["widget.earlystartdatecolumn","widget.ganttcolumn.earlystartdate"],width:100,align:"left",adjustMilestones:!0,constructor:function(n){n=n||{};this.text=n.text||this.L("text");this.callParent(arguments);this.renderer=n.renderer||this.rendererFunc;this.scope=n.scope||this;this.hasCustomRenderer=!0},afterRender:function(){var n=this.up("ganttpanel");n.registerLockedDependencyListeners();this.callParent(arguments)},rendererFunc:function(n,t,i){return t.tdCls=(t.tdCls||"")+" sch-column-readonly",i.getDisplayStartDate(this.format,this.adjustMilestones,i.getEarlyStartDate())}});Ext.define("Gnt.field.Effort",{extend:Gnt.field.Duration,alias:"widget.effortfield",alternateClassName:"Gnt.widget.EffortField",mixins:[Gnt.mixin.Localizable],taskField:"effortField",getDurationUnitMethod:"getEffortUnit",setTaskValueMethod:"setEffort",getTaskValueMethod:"getEffort",applyChanges:function(n){n=n||this.task;this.setTaskValue(n,this.getValue()||null,this.durationUnit);n.fireEvent("taskupdated",n,this)}});Ext.define("Gnt.column.Effort",{extend:Gnt.column.Duration,alias:["widget.effortcolumn","widget.ganttcolumn.effort"],fieldProperty:"effortField",editor:"effortfield",defaultEditor:"effortfield",getValueToRender:function(n,t,i){return Ext.isNumber(n)?this.field.valueToVisible(n,i.getEffortUnit()):""},putRawData:function(n,t){t.setEffort(n)}});Ext.define("Gnt.column.LateEndDate",{extend:Ext.grid.column.Date,mixins:[Gnt.mixin.Localizable],alias:["widget.lateenddatecolumn","widget.ganttcolumn.lateenddate"],width:100,align:"left",adjustMilestones:!0,constructor:function(n){n=n||{};this.text=n.text||this.L("text");this.callParent(arguments);this.renderer=n.renderer||this.rendererFunc;this.scope=n.scope||this;this.hasCustomRenderer=!0},afterRender:function(){var n=this.up("ganttpanel");n.registerLockedDependencyListeners();this.callParent(arguments)},rendererFunc:function(n,t,i){return t.tdCls=(t.tdCls||"")+" sch-column-readonly",i.getDisplayEndDate(this.format,this.adjustMilestones,i.getLateEndDate())}});Ext.define("Gnt.column.LateStartDate",{extend:Ext.grid.column.Date,mixins:[Gnt.mixin.Localizable],alias:["widget.latestartdatecolumn","widget.ganttcolumn.latestartdate"],width:100,align:"left",adjustMilestones:!0,constructor:function(n){n=n||{};this.text=n.text||this.L("text");this.callParent(arguments);this.renderer=n.renderer||this.rendererFunc;this.scope=n.scope||this;this.hasCustomRenderer=!0},afterRender:function(){var n=this.up("ganttpanel");n.registerLockedDependencyListeners();this.callParent(arguments)},rendererFunc:function(n,t,i){return t.tdCls=(t.tdCls||"")+" sch-column-readonly",i.getDisplayStartDate(this.format,this.adjustMilestones,i.getLateStartDate())}});Ext.define("Gnt.field.ManuallyScheduled",{extend:Ext.form.field.Checkbox,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.manuallyscheduledfield",alternateClassName:["Gnt.widget.ManuallyScheduledField"],taskField:"manuallyScheduledField",setTaskValueMethod:"setManuallyScheduled",getTaskValueMethod:"isManuallyScheduled",valueToVisible:function(n){return n?this.L("yes"):this.L("no")},getValue:function(){return this.value},setValue:function(n){this.callParent([n]);this.instantUpdate&&!this.getSuppressTaskUpdate()&&this.task&&this.applyChanges()}});Ext.define("Gnt.column.ManuallyScheduled",{extend:Ext.grid.Column,alias:["widget.manuallyscheduledcolumn","widget.ganttcolumn.manuallyscheduledcolumn"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:50,align:"center",instantUpdate:!1,fieldProperty:"manuallyScheduledField",editor:"manuallyscheduledfield",defaultEditor:"manuallyscheduledfield",initComponent:function(){this.initTaskFieldColumn();this.callParent(arguments)},getValueToRender:function(n,t,i){return this.field.valueToVisible(i.isManuallyScheduled())}});Ext.define("Gnt.field.Milestone",{extend:Ext.form.field.ComboBox,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.milestonefield",instantUpdate:!1,allowBlank:!1,forceSelection:!0,displayField:"text",valueField:"value",queryMode:"local",constructor:function(n){Ext.apply(this,n);this.store=new Ext.data.JsonStore({fields:["value","text"],autoDestroy:!0,data:[{value:0,text:this.L("no")},{value:1,text:this.L("yes")}]});this.callParent(arguments);this.on("change",this.onFieldChange,this)},onSetTask:function(){this.setValue(this.task.isMilestone()?1:0)},valueToVisible:function(n){return n?this.L("yes"):this.L("no")},onFieldChange:function(){this.instantUpdate&&!this.getSuppressTaskUpdate()&&this.task&&this.task.isMilestone()!=Boolean(this.value)&&this.applyChanges()},getValue:function(){return this.value},applyChanges:function(n){n=n||this.task;this.getValue()?n.convertToMilestone():n.convertToRegular();n.fireEvent("taskupdated",n,this)}});Ext.define("Gnt.column.Milestone",{extend:Ext.grid.column.Column,alias:["widget.milestonecolumn","widget.ganttcolumn.milestone"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:50,align:"center",editor:"milestonefield",defaultEditor:"milestonefield",initComponent:function(){this.initTaskFieldColumn();this.callParent(arguments)},getValueToRender:function(n,t,i){return this.field.valueToVisible(i.isMilestone())},applyColumnCls:function(n,t,i){i.isEditable(i.durationField)||i.isEditable(i.endDateField)||(t.tdCls=(t.tdCls||"")+" sch-column-readonly")}});Ext.define("Gnt.column.Name",{extend:Ext.tree.Column,alias:["widget.namecolumn","widget.ganttcolumn.name"],mixins:[Gnt.column.mixin.TaskFieldColumn],draggable:!0,fieldProperty:"nameField",editor:"textfield",initComponent:function(){this.initTaskFieldColumn();this.callParent(arguments)},applyColumnCls:function(n,t,i){t.tdCls=t.tdCls||"";i.isProject&&(t.tdCls+=" sch-gantt-project-name");i.isLeaf()||(t.tdCls+=" sch-gantt-parent-cell")}});Ext.define("Gnt.field.Note",{extend:Ext.form.field.Picker,alias:["widget.notefield","widget.noteeditor"],alternateClassName:"Gnt.widget.NoteField",mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],matchFieldWidth:!1,editable:!1,pickerConfig:null,previewFn:null,previewFnScope:null,taskField:"noteField",getTaskValueMethod:"getNote",setTaskValueMethod:"setNote",afterRender:function(){this.callParent(arguments);this.on("collapse",this.onPickerCollapse,this)},valueToVisible:function(n){return this.previewFn?this.previewFn.call(this.previewFnScope||this,n):Ext.util.Format.stripTags(n)},createPicker:function(){return new Ext.form.field.HtmlEditor(Ext.apply({frame:!0,shadow:!1,floating:!0,height:200,width:300,listeners:{change:this.onPickerChange,initialize:this.onPickerInit,scope:this}},this.pickerConfig||{}))},onPickerInit:function(n){n.win.focus=Ext.emptyFn},onPickerChange:function(n,t){this.setRawValue(this.valueToVisible(t))},getValue:function(){return this.getPicker().getValue()},setValue:function(n){this.callParent([this.valueToVisible(n)]);this.getPicker().setValue(n);this.instantUpdate&&!this.getSuppressTaskUpdate()&&this.task&&this.applyChanges()},onPickerCollapse:function(){this.setValue(this.getPicker().getValue())},onTriggerClick:function(){var n=this;n.readOnly||n.disabled||(n.isExpanded?n.collapse():n.expand())}});Ext.define("Gnt.column.Note",{extend:Ext.grid.column.Column,mixins:[Gnt.column.mixin.TaskFieldColumn],alias:["widget.notecolumn","widget.ganttcolumn.note"],editor:"notefield",defaultEditor:"notefield",fieldProperty:"noteField",previewFn:null,previewFnScope:null,fieldConfigs:["instantUpdate","previewFn","previewFnScope","fieldProperty"],initComponent:function(){this.initTaskFieldColumn();this.callParent(arguments)}});Ext.define("Gnt.column.PercentDone",{extend:Ext.grid.column.Number,alias:["widget.percentdonecolumn","widget.ganttcolumn.percentdone"],mixins:[Gnt.column.mixin.TaskFieldColumn],width:50,format:"0",align:"center",editor:"percentfield",defaultEditor:"percentfield",fieldProperty:"percentDoneField",initComponent:function(){this.initTaskFieldColumn({decimalPrecision:0});this.callParent(arguments)},getValueToRender:function(n,t,i){return this.defaultRenderer(n,t,i)}});Ext.define("Gnt.column.Predecessor",{extend:Gnt.column.Dependency,mixins:[Gnt.mixin.Localizable],alias:["widget.predecessorcolumn","widget.ganttcolumn.predecessor"],type:"predecessors",constructor:function(n){n=n||{};this.text=n.text||this.L("text");this.callParent(arguments)},putRawData:function(n,t){var i=t.getDependencyStore(),r=[];i.remove(t.getIncomingDependencies(!0));Ext.isArray(n)&&Ext.Array.each(n,function(n){if(t.getTaskStore().getById(n[i.model.prototype.fromField])){var u=new i.model(n);u.setTargetId(t.getId());i.isValidDependency(u)&&r.push(u)}});i.add(r)}});Ext.define("Gnt.column.ReadOnly",{extend:Ext.grid.Column,alias:["widget.readonlycolumn","widget.ganttcolumn.readonly"],mixins:[Gnt.column.mixin.TaskFieldColumn],fieldProperty:"readOnlyField",defaultEditor:"readonlyfield",editor:"readonlyfield",initComponent:function(){this.initTaskFieldColumn();this.callParent(arguments)},getValueToRender:function(n){return this.field.valueToVisible(n)}});Ext.define("Gnt.column.ResourceName",{extend:Ext.grid.column.Column,alias:"widget.resourcenamecolumn",mixins:[Gnt.mixin.Localizable],flex:1,align:"left",constructor:function(n){n=n||{};this.text=n.text||this.L("text");Ext.apply(this,n);this.callParent(arguments)}});Ext.define("Gnt.widget.AssignmentGrid",{extend:Ext.grid.Panel,alias:"widget.assignmentgrid",assignmentStore:null,resourceStore:null,readOnly:!1,cls:"gnt-assignmentgrid",taskId:null,cellEditing:null,sortResourcesFn:null,assignmentUnitsEditor:null,selModel:{selType:"checkboxmodel",mode:"MULTI",checkOnly:!0},initComponent:function(){var n=this;this.readOnly||(this.plugins=this.buildPlugins());this.store=this.store||new Ext.data.Store({proxy:"memory",autoDestroy:!0,model:this.assignmentStore.getModel()});this.columns=this.columns||this.buildColumns();this.sortResourcesFn=this.sortResourcesFn||function(t,i){var r=t.getUnits(),u=i.getUnits();return!r&&!u||r&&u?t.getResource(n.resourceStore).getName()<i.getResource(n.resourceStore).getName()?-1:1:r?-1:1};this.loadResources();this.mon(this.resourceStore,{datachanged:this.loadResources,scope:this});this.callParent(arguments);this.getSelectionModel().on({select:this.onSelect,deselect:this.onDeselect,scope:this})},onSelect:function(n,t){this.cellEditing&&this.cellEditing.getActiveEditor()||t.getUnits()||t.setUnits(t.getField(t.unitsField).defaultValue)},onDeselect:function(n,t){t.setUnits(0)},loadResources:function(){var n=this.assignmentStore.getModel().prototype.resourceIdField,t=this.assignmentStore.getModel().prototype.unitsField,i=Ext.Array.map(this.resourceStore.getRange(),function(i){var r={};return r[n]=i.getId(),r[t]="",r});this.store.loadData(i)},buildPlugins:function(){var n=this.cellEditing=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1});n.on("edit",this.onEditingDone,this);return[n]},hide:function(){this.cellEditing.cancelEdit();this.callParent(arguments)},onEditingDone:function(n,t){t.value?this.getSelectionModel().select(t.record,!0):(this.getSelectionModel().deselect(t.record),t.record.reject())},buildColumns:function(){return[{xtype:"resourcenamecolumn",resourceStore:this.resourceStore,renderer:function(n,t,i){var r=i.getResource(this.resourceStore);return Ext.String.htmlEncode(r&&r.getName()||n)}},{xtype:"assignmentunitscolumn"}]},setEditableFields:function(n){var t,i,r;if(this.assignmentUnitsEditor||(t=this.down("assignmentunitscolumn"),this.assignmentUnitsEditor=t&&t.getEditor()),this.assignmentUnitsEditor&&(i=this.assignmentStore&&this.assignmentStore.getTaskStore(),r=i&&i.getModelById(n),r))switch(r.getSchedulingMode()){case"DynamicAssignment":this.assignmentUnitsEditor.setReadOnly(!0);break;default:this.assignmentUnitsEditor.setReadOnly(!1)}},loadTaskAssignments:function(n){var i=this.store,u=this.getSelectionModel(),r,f,t,e;for(this.taskId=n,u.deselectAll(!0),r=0,f=i.getCount();r<f;r++)t=i.getAt(r),t.data[t.unitsField]=0,t.data[t.idProperty]=null,delete t.__id__;e=this.assignmentStore.getAssignmentsForTask(n);Ext.Array.each(e,function(n){var t=i.findRecord(n.resourceIdField,n.getResourceId(),0,!1,!0,!0),r;t&&(r=Ext.apply({},n.data),delete r[n.idProperty],t.set(r),t.__id__=n.getId(),u.select(t,!0,!0))});Ext.isSafari&&this.focus();i.sort({sorterFn:this.sortResourcesFn});i.getSorters().removeAll();this.setEditableFields(n)},saveTaskAssignments:function(){var n=this.assignmentStore,t=this.taskId,r={},i=[],u;this.getSelectionModel().selected.each(function(u){var s=u.getUnits(),f,o,e;s>0&&(f=u.__id__,f?(o=Ext.apply({},u.data),delete o[u.idProperty],r[f]=!0,n.getModelById(f).set(o)):(e=u.copy(),e.setTaskId(t),r[e.internalId]=!0,i.push(e)))});u=[];n.each(function(n){n.getTaskId()!=t||r[n.getId()||n.internalId]||u.push(n)});n.fireEvent("beforetaskassignmentschange",n,t,i);n.suspendAutoSync();n.remove(u);n.add(i);n.resumeAutoSync();n.fireEvent("taskassignmentschanged",n,t,i);n.autoSync&&n.sync()},isDataChanged:function(){var n=this;return n.store&&n.store.getUpdatedRecords().length>0||n.store.getNewRecords().length>0||n.store.getRemovedRecords().length>0},isDataValid:function(){return this.store.findBy(function(n){return!n.isValid()})<0}});Ext.define("Gnt.patches.CheckboxModel",{extend:Sch.util.Patch,target:"Ext.selection.CheckboxModel",overrides:{renderer:function(){return'<div class="'+Ext.baseCSSPrefix+'grid-row-checker" role="button" tabIndex="-1">&#160;<\/div>'}}});Ext.define("Gnt.patches.NavigationModel",{extend:Sch.util.Patch,target:"Ext.grid.NavigationModel",overrides:{onCellMouseDown:function(n,t,i,r,u,f,e){var o=Ext.Component.fromElement(e.target,t),s;n.actionableMode&&(e.getTarget(null,null,!0).isTabbable()||(s=Ext.ComponentManager.getActiveComponent())&&s.owns(e))||(e.pointerType!=="touch"&&(e.preventDefault(),this.setPosition(e.position,null,e)),o&&o.isFocusable&&o.isFocusable()&&(n.setActionableMode(!0,e.position),o.focus()))},fireNavigateEvent:function(){var n=this,t;return Ext.isIE||(n.previousRecord&&(t=n.view.dataSource.indexOf(n.previousRecord),n.previousRecordIndex=t==-1?null:t),n.record&&(t=n.view.dataSource.indexOf(n.record),n.recordIndex=t==-1?null:t)),this.callParent(arguments)}}});Ext.define("Gnt.field.Assignment",{extend:Ext.form.field.Picker,alias:["widget.assignmentfield","widget.assignmenteditor"],alternateClassName:"Gnt.widget.AssignmentField",mixins:[Gnt.mixin.Localizable],matchFieldWidth:!1,editable:!1,task:null,assignmentStore:null,resourceStore:null,gridConfig:null,formatString:"{0} [{1}%]",expandPickerOnFocus:!1,afterRender:function(){this.callParent(arguments);this.on("expand",this.onPickerExpand,this);if(this.expandPickerOnFocus)this.on("focus",function(){this.expand();this.picker.getView().focusCell({row:0,column:0})},this,{delay:1})},createPicker:function(){return new Gnt.widget.AssignmentGrid(Ext.apply({frame:!0,floating:!0,ownerCmp:this,height:200,width:300,resourceStore:this.task.getResourceStore(),assignmentStore:this.task.getAssignmentStore(),fbar:this.buildButtons()},this.gridConfig||{}))},buildButtons:function(){return["->",{text:this.L("closeText"),handler:function(){Ext.Function.defer(this.onSaveClick,Ext.isIE&&!Ext.isIE9?60:30,this)},scope:this},{text:this.L("cancelText"),handler:function(){this.collapse()},scope:this}]},setTask:function(n){this.task=n;this.setRawValue(this.getFieldDisplayValue(n))},onPickerExpand:function(){this.picker.loadTaskAssignments(this.task.getId())},onSaveClick:function(){var n=this.picker.getSelectionModel(),t=n.selected;this.collapse();this.fireEvent("select",this,t);this.picker.saveTaskAssignments()},isDirty:function(n){var u,i,t,r;if(n=n||this.task,!n)return!1;for(u=this.picker&&this.picker.assignmentStore||n.getAssignmentStore(),i=n.getAssignments(),t=0,r=i.length;t<r;t++)if(i[t].dirty||i[t].phantom)return!0;if(u)for(i=u.getRemovedRecords(),t=0,r=i.length;t<r;t++)if(i[t].getTaskId()==n.getId())return!0;return!1},getFieldDisplayValue:function(n){n=n||this.task;var t=Ext.Array.map(n.getAssignments(),function(n){var t=Ext.String.format(this.formatString,n.getResourceName(),n.getUnits());return Ext.String.htmlEncode(t)},this);return t.join(", ")}});Ext.define("Gnt.column.ResourceAssignment",{extend:Ext.grid.column.Column,alias:["widget.resourceassignmentcolumn","widget.ganttcolumn.resourceassignment"],mixins:[Gnt.mixin.Localizable],tdCls:"sch-assignment-cell",showUnits:!0,field:null,dirtyCls:null,constructor:function(n){n=n||{};this.text=n.text||this.L("text");var t=n.editor,i=n.showUnits||this.showUnits;if(delete n.editor,n.editor=t||{},n.editor instanceof Ext.form.Field||(n.editor=Ext.ComponentManager.create(Ext.applyIf(n.editor,{expandPickerOnFocus:!0,formatString:"{0}"+(i?" [{1}%]":"")}),"assignmentfield")),n.field=n.editor,this.callParent([n]),this.scope=this,this.field)this.field.on("collapse",function(){this.up("treepanel").getView().setActionableMode(!1)},this)},afterRender:function(){var n=this.up("treepanel").getView();n.markDirty&&(this.dirtyCls=n.dirtyCls);this.callParent(arguments)},getRawData:function(n){return Ext.Array.map(n.getAssignments(),function(n){var t=n.copy(null).data;return delete t[n.idProperty],t})},putRawData:function(n,t){var i=t.getAssignmentStore(),r=[];i.removeAssignmentsForTask(t);Ext.isArray(n)&&Ext.Array.each(n,function(n){t.getResourceStore().getById(n[i.model.prototype.resourceIdField])&&(n[i.model.prototype.taskIdField]=t.getId(),r.push(n))});i.add(r)},renderer:function(n,t,i){return this.dirtyCls&&this.field.isDirty(i)&&(t.tdCls=this.dirtyCls),this.field.getFieldDisplayValue(i)}});Ext.define("Gnt.column.Rollup",{extend:Ext.grid.Column,alias:["widget.rollupcolumn","widget.ganttcolumn.rollup"],mixins:[Gnt.column.mixin.TaskFieldColumn],fieldProperty:"rollupField",editor:"combobox",defaultEditor:"combobox",initComponent:function(){this.initTaskFieldColumn({store:[[!1,this.L("no")],[!0,this.L("yes")]]});this.callParent(arguments)},getValueToRender:function(n){return this.L(n?"yes":"no")}});Ext.define("Gnt.column.Scale",{extend:Ext.grid.column.Template,alias:"widget.scalecolumn",sortable:!1,scalePoints:null,scaleStep:2,scaleLabelStep:4,scaleMin:0,scaleMax:24,width:40,availableHeight:48,scaleCellCls:"gnt-scalecolumn",tpl:'<div class="gnt-scalecolumn-wrap" style="height:{scaleHeight}px;"><tpl for="scalePoints"><tpl if="label !== \'\'"><span class="gnt-scalecolumn-label-line {cls}" style="top:{top}px"><span class="gnt-scalecolumn-label">{label}<\/span><\/span><tpl else><span class="gnt-scalecolumn-line {cls}" style="top:{top}px"><\/span><\/tpl><\/tpl><\/div>',initComponent:function(){this.tdCls=(this.tdCls||"")+" "+this.scaleCellCls;this.setAvailableHeight(this.availableHeight,!0);this.callParent(arguments)},setAvailableHeight:function(n,t){this.availableHeight=n;this.scalePoints?(t&&(this.scalePoints.sort(function(n,t){return n.value-t.value}),this.scaleMin=this.scalePoints[0].value,this.scaleMax=this.scalePoints[this.scalePoints.length-1].value,this.scaleStep=(this.scaleMax-this.scaleMin)/10),this.scaleStepHeight=this.availableHeight/(this.scaleMax-this.scaleMin+this.scaleStep),this.updateScalePointsTops()):(this.scaleStepHeight=this.availableHeight/(this.scaleMax-this.scaleMin+this.scaleStep),this.scalePoints=this.buildScalePoints())},defaultRenderer:function(n,t,i){var r={record:Ext.apply({},i.data,i.getAssociatedData()),scaleHeight:this.availableHeight,scalePoints:this.scalePoints};return this.tpl.apply(r)},buildScalePoints:function(){for(var t=this.scaleMin,n=t,e=this.scaleStep,o=this.scaleLabelStep,s=this.scaleStepHeight,h=this.availableHeight,r=this.scaleCellCls,u=r+"-min",i=[],f=function(n,i,r){return{top:Math.round(h-(n-t)*s),value:n,label:i!="undefined"?i:"",cls:r||""}};n<this.scaleMax;)i.push(f(n,n%o||n===t?"":n,u)),u="",n+=e;return i.push(f(this.scaleMax,this.scaleMax,r+"-max")),i},updateScalePointsTops:function(){var n=this.scaleStepHeight,t=this.availableHeight;Ext.Array.each(this.scalePoints,function(i){i.top=Math.round(t-i.value*n)})}});Ext.define("Gnt.field.SchedulingMode",{extend:Ext.form.field.ComboBox,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.schedulingmodefield",alternateClassName:"Gnt.widget.SchedulingmodeField",taskField:"schedulingModeField",setTaskValueMethod:"setSchedulingMode",getTaskValueMethod:"getSchedulingMode",pickerAlign:"tl-bl?",matchFieldWidth:!0,editable:!1,forceSelection:!0,triggerAction:"all",constructor:function(n){n=n||{};n.store||this.initStore(n);this.callParent([n]);this.on("change",this.onFieldChange,this)},initStore:function(n){var t=this;n.store=t.getDefaultSchedulingModes()},getDefaultSchedulingModes:function(){var n=this;return[["Normal",n.L("Normal")],["FixedDuration",n.L("FixedDuration")],["EffortDriven",n.L("EffortDriven")],["DynamicAssignment",n.L("DynamicAssignment")]]},valueToVisible:function(n){var t=this,i=[],r=this.findRecordByValue(n);return r?i.push(r.data):Ext.isDefined(t.valueNotFoundText)&&i.push(t.valueNotFoundText),t.displayTpl.apply(i)},getErrors:function(n){var t=this.callParent(arguments);return t&&t.length?t:Ext.isEmpty(n)||this.findRecordByDisplay(n)||this.findRecordByValue(n)?[]:[this.L("invalidText")]},getValue:function(){return this.value},onFieldChange:function(){this.instantUpdate&&!this.getSuppressTaskUpdate()&&this.task&&this.value&&this.applyChanges()}});Ext.define("Gnt.column.SchedulingMode",{extend:Ext.grid.column.Column,mixins:[Gnt.column.mixin.TaskFieldColumn],alias:["widget.schedulingmodecolumn","widget.ganttcolumn.schedulingmode"],width:100,align:"left",data:null,fieldProperty:"schedulingModeField",editor:"schedulingmodefield",defaultEditor:"schedulingmodefield",instantUpdate:!1,initComponent:function(){this.initTaskFieldColumn({store:this.data});this.callParent(arguments)}});Ext.define("Gnt.column.Sequence",{extend:Ext.grid.column.Column,alias:["widget.sequencecolumn","widget.ganttcolumn.sequence"],mixins:[Gnt.mixin.Localizable],width:40,align:"right",sortable:!1,dataIndex:"index",constructor:function(n){n=n||{};this.text=n.text||this.L("text");this.callParent(arguments)},renderer:function(n,t,i){return i.getSequenceNumber()}});Ext.define("Gnt.column.ShowInTimeline",{extend:Ext.grid.column.Check,alias:["widget.showintimelinecolumn","widget.ganttcolumn.showintimeline"],mixins:[Gnt.column.mixin.TaskFieldColumn],fieldProperty:"showInTimelineField",initComponent:function(n){this.initTaskFieldColumn();this.callParent([n]);this.tdCls=(this.tdCls||"")+" gnt-showintimeline-cell"},onReadOnlySet:function(n,t){this.setDisabled(t)},taskFieldRenderer:function(){var n=this.defaultRenderer.apply(this,arguments);return this.applyColumnCls.apply(this,arguments),n}});Ext.define("Gnt.column.Slack",{extend:Ext.grid.column.Column,mixins:[Gnt.mixin.Localizable],alias:["widget.slackcolumn","widget.ganttcolumn.slack"],decimalPrecision:2,useAbbreviation:!1,slackUnit:"d",width:100,align:"left",constructor:function(n){n=n||{};this.text=n.text||this.L("text");this.callParent(arguments);this.renderer=n.renderer||this.rendererFunc;this.scope=n.scope||this;this.hasCustomRenderer=!0},afterRender:function(){var n=this.up("ganttpanel");n.registerLockedDependencyListeners();this.callParent(arguments)},rendererFunc:function(n,t,i){return(t.tdCls=(t.tdCls||"")+" sch-column-readonly",n=i.getSlack(),Ext.isNumber(n))?parseFloat(Ext.Number.toFixed(n,this.decimalPrecision))+" "+Sch.util.Date[this.useAbbreviation?"getShortNameOfUnit":"getReadableNameOfUnit"](this.slackUnit,n!==1):""}});Ext.define("Gnt.column.Successor",{extend:Gnt.column.Dependency,mixins:[Gnt.mixin.Localizable],alias:["widget.successorcolumn","widget.ganttcolumn.successor"],type:"successors",constructor:function(n){n=n||{};this.text=n.text||this.L("text");this.callParent(arguments)},putRawData:function(n,t){var i=t.getDependencyStore(),r=[];i.remove(t.getOutgoingDependencies(!0));Ext.isArray(n)&&Ext.Array.each(n,function(n){if(t.getTaskStore().getById(n[i.model.prototype.toField])){var u=new i.model(n);u.setSourceId(t.getId());i.isValidDependency(u)&&r.push(u)}});i.add(r)}});Ext.define("Gnt.column.WBS",{extend:Ext.grid.column.Column,alias:["widget.wbscolumn","widget.ganttcolumn.wbs"],mixins:[Gnt.mixin.Localizable],width:40,align:"left",sortable:!1,dataIndex:"index",constructor:function(n){n=n||{};this.text=n.text||this.L("text");this.callParent(arguments)},renderer:function(n,t,i){return i.getWBSCode()}});Ext.define("Gnt.constraint.Base",{mixins:[Gnt.mixin.Localizable],isSatisfied:function(){throw"Abstract method";},getResolution:function(n,t,i){var f=this,u=!1,r;return i=i||t.getConstraintDate(),r=function(){u||(u=!0,n.apply(this,arguments))},{title:f.L("name"),task:t,date:i,resolutions:this.getResolutionOptions(r,t,i),getCancelActionOption:function(){return this.resolutions[0]},cancelAction:function(){return this.getCancelActionOption().resolve()},proceedAction:function(){r()},getResolution:function(n){return Ext.Array.findBy(this.resolutions,function(t){return t.id==n})}}},getResolutionOptions:function(n,t,i){i=i||t.getConstraintDate();var r=this,u=[{id:"cancel",title:r.L("Cancel the change and do nothing"),resolve:function(){n(!0)}}];return r.hasThisConstraintApplied(t)&&u.push({id:"remove-constraint",title:r.L("Remove the constraint"),resolve:function(){t.setConstraintType("");n()}}),u},hasThisConstraintApplied:function(n){return n.getConstraintClass()===this},getInitialConstraintDate:function(n){return n.getConstraintDate()},getDisplayableConstraintDateForFormat:function(n){return n},adjustConstraintDateFromDisplayableWithFormat:function(n){return n},shiftToNearestValidConstraintDate:function(n){return n},statics:{getConstraintClass:function(n){var t=!Ext.isEmpty(n)&&Ext.ClassManager.getByAlias("gntconstraint."+n);return Ext.isEmpty(n)||t||Ext.Error.raise("Can't get constraint class, unrecognized constraint type: "+n),t||null}}});Ext.define("Gnt.constraint.AsLateAsPossible",{extend:Gnt.constraint.Base,singleton:!0,isSatisfied:function(){throw"Abstract method";}});Ext.define("Gnt.constraint.AsSoonAsPossible",{extend:Gnt.constraint.Base,singleton:!0,isSatisfied:function(){throw"Abstract method";}});Ext.define("Gnt.constraint.FinishNoEarlierThan",{extend:Gnt.constraint.Base,alias:"gntconstraint.finishnoearlierthan",singleton:!0,isSatisfied:function(n,t){var i=n.getEndDate();return t=t||n.getConstraintDate(),!t||!i||i>=t},getResolutionOptions:function(n,t,i){var r=this,u=r.callParent(arguments);return i=i||t.getConstraintDate(),u.push({id:"move-task",title:r.L("Move the task to finish on {0}"),resolve:function(){t.setEndDateWithoutPropagation(i,!0);n()}}),u},getInitialConstraintDate:function(n){return n.getEndDate()},getDisplayableConstraintDateForFormat:function(n,t){return n&&!Ext.Date.formatContainsHourInfo(t)&&n-Ext.Date.clearTime(n,!0)==0&&(n=Sch.util.Date.add(n,Sch.util.Date.DAY,-1)),n},adjustConstraintDateFromDisplayableWithFormat:function(n,t){return n&&!Ext.Date.formatContainsHourInfo(t)&&n-Ext.Date.clearTime(n,!0)==0&&(n=Sch.util.Date.add(n,Sch.util.Date.DAY,1)),n}});Ext.define("Gnt.constraint.FinishNoLaterThan",{extend:Gnt.constraint.Base,alias:"gntconstraint.finishnolaterthan",singleton:!0,isSatisfied:function(n,t,i){var r=n.getEndDate();return t=t||n.getConstraintDate(),!t||!r||Sch.util.Date.compareWithPrecision(r,t,i)!==1},getResolutionOptions:function(n,t,i){var r=this,u=r.callParent(arguments);return i=i||t.getConstraintDate(),u.push({id:"move-task",title:r.L("Move the task to finish on {0}"),resolve:function(){t.setEndDateWithoutPropagation(i,!0);n()}}),u},getInitialConstraintDate:function(n){return n.getEndDate()},getDisplayableConstraintDateForFormat:function(n,t){return n&&!Ext.Date.formatContainsHourInfo(t)&&n-Ext.Date.clearTime(n,!0)==0&&(n=Sch.util.Date.add(n,Sch.util.Date.DAY,-1)),n},adjustConstraintDateFromDisplayableWithFormat:function(n,t){return n&&!Ext.Date.formatContainsHourInfo(t)&&n-Ext.Date.clearTime(n,!0)==0&&(n=Sch.util.Date.add(n,Sch.util.Date.DAY,1)),n}});Ext.define("Gnt.constraint.MustFinishOn",{extend:Gnt.constraint.Base,alias:"gntconstraint.mustfinishon",singleton:!0,isSatisfied:function(n,t,i){var r=n.getEndDate();return t=t||n.getConstraintDate(),!t||!r||Sch.util.Date.compareWithPrecision(r,t,i)===0},getResolutionOptions:function(n,t,i){var r=this,u=r.callParent(arguments);return i=i||t.getConstraintDate(),u.push({id:"move-task",title:r.L("Move the task to finish on {0}"),resolve:function(){t.setEndDateWithoutPropagation(i,!0);n()}}),u},getInitialConstraintDate:function(n){return n.getEndDate()},getDisplayableConstraintDateForFormat:function(n,t){return n&&!Ext.Date.formatContainsHourInfo(t)&&n-Ext.Date.clearTime(n,!0)==0&&(n=Sch.util.Date.add(n,Sch.util.Date.DAY,-1)),n},adjustConstraintDateFromDisplayableWithFormat:function(n,t){return n&&!Ext.Date.formatContainsHourInfo(t)&&n-Ext.Date.clearTime(n,!0)==0&&(n=Sch.util.Date.add(n,Sch.util.Date.DAY,1)),n}});Ext.define("Gnt.constraint.MustStartOn",{extend:Gnt.constraint.Base,alias:"gntconstraint.muststarton",singleton:!0,isSatisfied:function(n,t,i){var r=n.getStartDate();return t=t||n.getConstraintDate(),!t||!r||Sch.util.Date.compareWithPrecision(r,t,i)===0},getResolutionOptions:function(n,t,i){var r=this,u=r.callParent(arguments);return i=i||t.getConstraintDate(),u.push({id:"move-task",title:r.L("Move the task to start at {0}"),resolve:function(){t.setStartDateWithoutPropagation(i,!0);n()}}),u},getInitialConstraintDate:function(n){return n.getStartDate()}});Ext.define("Gnt.constraint.StartNoEarlierThan",{extend:Gnt.constraint.Base,alias:"gntconstraint.startnoearlierthan",singleton:!0,isSatisfied:function(n,t,i){var r=n.getStartDate();return t=t||n.getConstraintDate(),!t||!r||Sch.util.Date.compareWithPrecision(r,t,i)!==-1},getResolutionOptions:function(n,t,i){var r=this,u=r.callParent(arguments);return i=i||t.getConstraintDate(),u.push({id:"move-task",title:r.L("Move the task to start at {0}"),resolve:function(){t.setStartDateWithoutPropagation(i,!0);n()}}),u},getInitialConstraintDate:function(n){return n.getStartDate()}});Ext.define("Gnt.constraint.StartNoLaterThan",{extend:Gnt.constraint.Base,alias:"gntconstraint.startnolaterthan",singleton:!0,isSatisfied:function(n,t,i){var r=n.getStartDate();return t=t||n.getConstraintDate(),!t||!r||Sch.util.Date.compareWithPrecision(r,t,i)!==1},getResolutionOptions:function(n,t,i){var r=this,u=r.callParent(arguments);return i=i||t.getConstraintDate(),u.push({id:"move-task",title:r.L("Move the task to start at {0}"),resolve:function(){t.setStartDateWithoutPropagation(i,!0);n()}}),u},getInitialConstraintDate:function(n){return n.getStartDate()}});Ext.define("Gnt.model.Assignment",{extend:Sch.model.Assignment,customizableFields:[{name:"TaskId"},{name:"Units",type:"float",defaultValue:100}],taskIdField:"TaskId",eventIdField:"TaskId",constructor:function(n,t){var i=this;i.eventIdField=i.taskIdField;i.callParent([n,t])},getEventId:function(){var n=this;return n.get(n.taskIdField)},setEventId:function(n){var t=this;return t.set(t.taskIdField,n)},unitsField:"Units",getTaskStore:function(){return this.store&&this.store.getTaskStore()||null},getEventStore:function(){return this.getTaskStore()},getUnits:function(){var n=this;return Math.max(0,n.get(n.unitsField))},setUnits:function(n){var t=this;n<0&&Ext.Error.raise("`Units` value for an assignment can't be less than 0");t.set(t.unitsField,n)},getTask:function(n){var t=this;return t.getEvent(n)},getTaskName:function(n){var t=this.getTask(n);return t&&t.getName()||""},getEffort:function(n){var i=this,t=i.getTask(),r=0;return t.forEachAvailabilityIntervalWithResources({startDate:t.getStartDate(),endDate:t.getEndDate(),resources:[i.getResource()]},function(n,t,i){var u,f;for(u in i)f=i[u].units;r+=(t-n)*f/100}),t.getProjectCalendar().convertMSDurationToUnit(r,n||t.getEffortUnit())},getEffortAtDate:function(n,t){var s=Sch.util.Date,f=this,i=f.getTask(),u=i&&i.getStartDate(),e=i&&i.getEndDate(),o=f.getResource(),r=0;return i&&o&&u&&e&&(n=s.constrain(n,u,e),i.forEachAvailabilityIntervalWithResources({startDate:u,endDate:n,resources:[o]},function(n,t,i){var u=0;for(var f in i)u=i[f].units;r+=(t-n)*u/100}),r=i.getCalendar().convertMSDurationToUnit(r,t||i.getEffortUnit())),r}});Ext.define("Gnt.data.AssignmentStore",{extend:Sch.data.AssignmentStore,model:"Gnt.model.Assignment",alias:"store.gantt_assignmentstore",storeId:"assignments",attachToEventStore:Ext.emptyFn,attachToResourceStore:Ext.emptyFn,getTaskStore:function(){return this.getEventStore()},setTaskStore:function(n){return this.setEventStore(n)},mapAssignmentsForTask:function(n,t,i){return this.mapAssignmentsForEvent(n,t,i)},getAssignmentsForTask:function(n){return this.getAssignmentsForEvent(n)},removeAssignmentsForTask:function(n){return this.removeAssignmentsForEvent(n)},getResourcesForTask:function(n){return this.getResourcesForEvent(n)},getTasksForResource:function(n){return this.getEventsForResource(n)},assignTaskToResource:function(n,t,i){return this.assignEventToResource(n,t,function(n){return n.setUnits(i),n})},unassignTaskFromResource:function(n,t){return this.unassignEventFromResource(n,t)},isTaskAssignedToResource:function(n,t,i){return this.isEventAssignedToResource(n,t,i)},getAssignmentForTaskAndResource:function(n,t){return this.getAssignmentForEventAndResource(n,t)}});Ext.define("Gnt.data.CalendarManager",{extend:Ext.data.TreeStore,mixins:[Robo.data.Store,Sch.data.mixin.UniversalModelGetter],model:"Gnt.model.Calendar",alias:"store.calendarmanager",storeId:"calendars",calendarClass:"Gnt.data.Calendar",calendarConfig:null,projectCalendar:null,myListeners:null,proxy:"memory",constructor:function(){this.callParent(arguments);this.myListeners=this.on({idchanged:this.onChangeId,rootchange:this.onNewRoot,nodeappend:this.onNewNode,nodeinsert:this.onNewNode,noderemove:this.onRemoveNode,destroyable:!0,scope:this});var n=this.getRoot();n?this.bindCalendars(n):this.setRoot({expanded:!0})},destroy:function(){this.myListeners.destroy();this.callParent(arguments)},onChangeId:function(n,t,i,r,u){if(t instanceof Gnt.model.Calendar){var f=this.getCalendar(i||u);f.setCalendarId(r)}},onNewNode:function(n,t){this.bindCalendars(t);t!==this.getRoot()&&this.fixCalendarParent(t);var i=this;t.cascadeBy(function(n){n.setCalendarManager(i)})},onNewRoot:function(n){this.onNewNode(null,n)},onRemoveNode:function(n,t,i){if(!i){var r=t.calendar;r&&(this.unbindCalendarEvents(r),this.__loading||(r.destroy(),Ext.data.StoreManager.unregister(r)),t.setCalendarManager(null))}},suspendCalendarsEvents:function(n){this.getRoot().cascadeBy(function(t){var i=t.getCalendar();i&&i.suspendEvents(n)},this)},resumeCalendarsEvents:function(){this.getRoot().cascadeBy(function(n){var t=n.getCalendar();t&&t.resumeEvents()},this)},getCalendarClass:function(){return this.calendarClass},getProjectCalendar:function(){return this.projectCalendar},setProjectCalendar:function(n){this.settingProjectCalendar||(typeof n!="object"&&(n=this.getCalendar(n)||Gnt.data.Calendar.getCalendar(n)),n)&&(this.settingProjectCalendar=!0,this.projectCalendar=n,this.fireEvent("projectcalendarset",this,n),this.settingProjectCalendar=!1)},getCalendar:function(n){var t=this.getModelById(n);return t&&t.getCalendar()},getNodeByCalendar:function(n){if(!n)return this.getRoot();var t=this.getModelById(n.calendarId);return t||this.getRoot().cascadeBy(function(i){var r=i.getCalendar();if(r===n)return t=i,!1},this),t},onParentChange:function(n){var t=this.getNodeByCalendar(n);t&&!t.syncingCalendarParent&&this.fixNodeParent(t)},bindCalendarEvents:function(n){this.relayEvents(n,["load"],"calendar");this.relayEvents(n,["add","update","remove","bulkremove"],"day");this.relayEvents(n,["calendarchange"]);n.on("parentchange",this.onParentChange,this);this.on({dayadd:this.onDayAdd,dayupdate:this.onDayUpdate,dayremove:this.onDayRemove,scope:this})},unbindCalendarEvents:function(n){this.un({dayadd:this.onDayAdd,dayupdate:this.onDayUpdate,dayremove:this.onDayRemove,scope:this});n&&n.un({parentchange:this.onParentChange,scope:this})},onDayAdd:function(n){this.getModelById(n.getCalendarId()).dirty=!0},onDayUpdate:function(n){this.getModelById(n.getCalendarId()).dirty=!0},onDayRemove:function(n){this.getModelById(n.getCalendarId()).dirty=!0},fixCalendarParent:function(n){if(!n.syncingCalendarParent){var t=n.parentNode.getCalendar(),i=n.getCalendar();t!==i.parent&&(n.syncingCalendarParent=!0,i.setParent(t),n.syncingCalendarParent=!1)}},fixNodeParent:function(n){var r=n.parentNode.getCalendar(),i=n.getCalendar().parent,t;r!==i&&(t=this.getNodeByCalendar(i),t&&t.appendChild(n))},bindCalendar:function(n){if(n&&this.getRoot()!==n){var t=n.getCalendar(),i=n.getDays(),r=n.getId()||n.internalId;if(i=Ext.isArray(i)&&i,!t||i){if(t||(t=Gnt.data.Calendar.getCalendar(r)),!t){var u=n.parentNode&&n.parentNode.getCalendar(),f=Ext.ClassManager.get(n.getCalendarClass()||this.calendarClass),e=Ext.applyIf(n.getCalendarConfig(),{data:i,parent:u});t=Ext.create(f,Ext.apply(e,this.calendarConfig))}n.setCalendar(t);this.bindCalendarEvents(t)}else this.getCalendar(t.calendarId)||this.bindCalendarEvents(t);this.fireEvent("calendarbound",this,t,n)}},unbindCalendar:function(n){if(n&&this.getRoot()!==n){var t=n.getCalendar();t&&(this.unbindCalendarEvents(t),this.fireEvent("calendarunbound",this,t,n))}},bindCalendars:function(n){var t=this;n&&Ext.Array.each([].concat(n),function(n){n.cascadeBy(t.bindCalendar,t)})},unbindCalendars:function(n){var t=this;n&&Ext.Array.each([].concat(n),function(n){n.cascadeBy(t.unbindCalendar,t)})}});Ext.define("Gnt.data.CrudManager",{extend:Sch.crud.AbstractManager,mixins:[Sch.crud.encoder.Json,Sch.crud.transport.Ajax],calendarManager:null,taskStore:null,dependencyStore:null,resourceStore:null,assignmentStore:null,addRelatedStores:!0,constructor:function(n){var h,t,s;n=n||{};var i=n.calendarManager||this.calendarManager,r=n.taskStore||this.taskStore||new Gnt.data.TaskStore({proxy:"memory"}),u=n.assignmentStore||this.assignmentStore,f=n.resourceStore||this.resourceStore,e=n.dependencyStore||this.dependencyStore,o=[];r&&n.addRelatedStores!==!1&&(h=this.getTaskStoreInfo(r,n),i=i||h.calendarManager,u=u||h.assignmentStore,f=f||h.resourceStore,e=e||h.dependencyStore);i&&(this.mixins.observable.constructor.call(this,n),this.addCalendarManager(i,o));f&&o.push(f);u&&o.push(u);e&&o.push(e);r&&o.push(r);o.length&&(t=[],i&&t.push(i),f&&t.push(f),r&&t.push(r),u&&t.push(u),e&&t.push(e),t.length&&(n.syncApplySequence=(n.syncApplySequence||n.stores||[]).concat(t)),s=n.stores||this.stores,s&&!Ext.isArray(s)&&(s=[s]),n.stores=(s||[]).concat(o));this.callParent([n]);this.calendarManager=this.getStoreDescriptor(i);this.resourceStore=this.getStoreDescriptor(f);this.assignmentStore=this.getStoreDescriptor(u);this.dependencyStore=this.getStoreDescriptor(e);this.taskStore=this.getStoreDescriptor(r)},getTaskStoreInfo:function(n,t){n instanceof Ext.data.AbstractStore||(n=typeof n=="string"?Ext.data.StoreManager.get(n):n.store);var i={},r=t.calendarManager,u=t.assignmentStore,f=t.resourceStore,e=t.dependencyStore;return r||(i.calendarManager=n.calendarManager),u||(i.assignmentStore=n.getAssignmentStore()),f||(i.resourceStore=n.getResourceStore()),e||(i.dependencyStore=n.getDependencyStore()),i},addCalendarManager:function(n,t){var i,r,u;n instanceof Ext.data.AbstractStore?(i=n,r={store:n}):typeof n=="object"?(i=n.store,r=n):(n=Ext.data.StoreManager.get(n),i=n,r={store:n});u=(i.getModel&&i.getModel()||i.model).prototype;r.stores||(r.stores=[{storeId:u.daysField,idProperty:u.idProperty}]);this.calendarManager=r;i.on("load",this.onCalendarManagerLoad,this);this.mon(i,{dayadd:this.onStoreChange,dayupdate:this.onStoreChange,dayremove:this.onStoreChange,daybulkremove:this.onStoreChange,scope:this});t.push(r)},onCalendarManagerLoad:function(n){var t=n.getProjectCalendar(),r=t&&t.getCalendarId(),i=n.metaData&&n.metaData.projectCalendar;r!=i&&n.setProjectCalendar(i)},applyLoadResponse:function(){var n=this.getCalendarManager();n&&n.suspendCalendarsEvents();this.callParent(arguments);n&&n.resumeCalendarsEvents()},getCalendarManager:function(){return this.calendarManager&&this.calendarManager.store},getResourceStore:function(){return this.resourceStore&&this.resourceStore.store},getDependencyStore:function(){return this.dependencyStore&&this.dependencyStore.store},getAssignmentStore:function(){return this.assignmentStore&&this.assignmentStore.store},getTaskStore:function(){return this.taskStore&&this.taskStore.store},prepareUpdated:function(n,t,i){var r,u,f,e,o;if(n[0]instanceof Gnt.model.Task){if(n=Ext.Array.filter(n,function(n){return!n.isRoot()}),r=this.callParent([n,t,i]),this.resetIdsBeforeSync){var h=n[0].segmentsField,s=Ext.ClassManager.get(n[0].segmentClassName).prototype,c=s.idProperty,l=s.phantomIdField;for(u=0;u<r.length;u++)if(f=r[u][h],f)for(e=0;e<f.length;e++)o=f[e],o[l]&&delete o[c]}return r}return this.callParent(arguments)},prepareAdded:function(n){var u=this.callParent(arguments),f,e,t,i,r;if(this.resetIdsBeforeSync&&n[0]instanceof Gnt.model.Task)for(f=n[0].segmentsField,e=Ext.ClassManager.get(n[0].segmentClassName).prototype.idProperty,t=0;t<u.length;t++)if(i=u[t][f],i)for(r=0;r<i.length;r++)delete i[r][e];return u},applyChangesToTask:function(n,t){var r,u;if(t.hasOwnProperty(n.segmentsField)){var i=n.getSegments(),s=n.segmentsField,h=i&&i[0].phantomIdField,c=i&&i[0].idProperty,e=t[s];if(i){if(e)for(r=e.length-1;r>=0;r--){var o=e[r],l=o[h],a=o[c],f=null;for(u=0;u<i.length;u++)if(f=i[u],f.get(h)==l||f.getId()==a){this.applyChangesToRecord(f,o);break}}delete t[s]}}},applyChangesToRecord:function(n){n instanceof Gnt.model.Task&&(this.ignoreUpdates++,this.applyChangesToTask.apply(this,arguments),this.ignoreUpdates--);this.callParent(arguments)}});Ext.define("Gnt.model.Dependency",{extend:Sch.model.Customizable,inheritableStatics:{Type:{StartToStart:0,StartToEnd:1,EndToStart:2,EndToEnd:3}},idProperty:"Id",customizableFields:[{name:"From"},{name:"To"},{name:"Type",type:"int",defaultValue:2},{name:"Lag",type:"number",defaultValue:0},{name:"LagUnit",type:"string",defaultValue:"d",convert:function(n){return n||"d"}},{name:"Cls",defaultValue:""}],fromField:"From",toField:"To",typeField:"Type",lagField:"Lag",lagUnitField:"LagUnit",clsField:"Cls",isHighlighted:!1,constructor:function(n){this.callParent(arguments);n&&(n[this.fromField]&&n[this.fromField]instanceof Gnt.model.Task&&(this.setSourceTask(n[this.fromField]),delete n.fromField),n[this.toField]&&n[this.toField]instanceof Gnt.model.Task&&(this.setTargetTask(n[this.toField]),delete n.toField))},getTaskStore:function(){return this.store.taskStore},getSourceTask:function(n){return(n||this.getTaskStore()).getModelById(this.getSourceId())},setSourceTask:function(n){this.setSourceId(n.getId()||n.internalId)},getTargetTask:function(n){return(n||this.getTaskStore()).getModelById(this.getTargetId())},setTargetTask:function(n){this.setTargetId(n.getId()||n.internalId)},getSourceId:function(){return this.get(this.fromField)},setSourceId:function(n){this.set(this.fromField,n)},getTargetId:function(){return this.get(this.toField)},setTargetId:function(n){this.set(this.toField,n)},setLag:function(n,t){this.beginEdit();this.set(this.lagField,n);arguments.length>1&&this.setLagUnit(t);this.endEdit()},getLagUnit:function(){return this.get(this.lagUnitField)||"d"},isPersistable:function(){var n=this.getSourceTask(),t=this.getTargetTask();return n&&!n.phantom&&t&&!t.phantom},isValid:function(n){var t=this.callParent(arguments),i=this.getSourceId(),r=this.getTargetId(),u=this.getType();return t&&(t=Ext.isNumber(u)&&!Ext.isEmpty(i)&&!Ext.isEmpty(r)&&i!=r),t&&n!==!1&&this.store&&(t=this.store.isValidDependency(i,r,u,null,null,this)),t}});Ext.define("Gnt.data.DependencyStore",{extend:Ext.data.Store,mixins:[Sch.data.mixin.UniversalModelGetter,Robo.data.Store],model:"Gnt.model.Dependency",storeId:"dependencies",alias:"store.gantt_dependencystore",taskStore:null,methodsCache:null,strictDependencyValidation:!1,transitiveDependencyValidation:!1,ignoreInitial:!0,isLoadingRecords:!1,allowedDependencyTypes:null,allowParentTaskDependencies:!0,constructor:function(n){n=n||{};this.callParent([n]);this.init();this.ignoreInitial=!1},init:function(){this.methodsCache={};this.on({add:this.onDependencyAdd,update:this.onDependencyUpdate,load:this.onDependencyLoad,datachanged:this.onDependencyDataChanged,remove:this.onDependencyRemove,clear:this.onDependencyStoreClear,priority:100,scope:this})},onDependencyLoad:function(){var n=this.getTaskStore();n&&n.fillTasksWithDepInfo()},onDependencyDataChanged:function(){var n=this.getTaskStore();this.isLoadingRecords&&n&&n.fillTasksWithDepInfo()},loadRecords:function(){this.isLoadingRecords=!0;this.callParent(arguments);this.isLoadingRecords=!1},scheduleTask:function(n){var r=this.getTaskStore(),t=n.getStartDate(),i=n.getEndDate();t&&i||(n.beginEdit(),t||n.setStartDateWithoutPropagation(r.getProjectStartDate(),undefined!==n.getDuration()),i||n.setDurationWithoutPropagation(1),n.endEdit())},scheduleLinkedTasks:function(n,t){this.scheduleTask(n);t.getStartDate()||n.getTaskStore().cascadeChanges||t.alignByIncomingDependencies();this.scheduleTask(t)},onDependencyAdd:function(n,t){n.ignoreInitial||Ext.Array.each(t,function(t){var i,r;if(!n.isValidDependencyType(t.getType()))throw"This dependency type is invalid. Check Gnt.data.DependencyStore#allowedDependencyTypes value";i=t.getSourceTask();r=t.getTargetTask();i&&r&&(Ext.Array.contains(i.successors,t)||i.successors.push(t),Ext.Array.contains(r.predecessors,t)||r.predecessors.push(t),n.isUndoingOrRedoing()||n.scheduleLinkedTasks(i,r))});n.resetMethodsCache()},onDependencyRemove:function(n,t){var i=this.getTaskStore(),r=[];Ext.Array.each(t,function(t){var f=t.getSourceTask(i),u=t.getTargetTask(i);f&&Ext.Array.remove(f.successors,t);u&&(Ext.Array.remove(u.predecessors,t),n.isUndoingOrRedoing()||u.isManuallyScheduled()||!u.isTaskStored()||r.push(u))});n.resetMethodsCache();n.isUndoingOrRedoing()||Ext.Array.each(r,function(n){n.adjustToCalendarWithoutPropagation()})},onDependencyUpdate:function(n,t,i){var e,o;if(i!=Ext.data.Model.COMMIT){var s=this.getTaskStore(),r=t.previous,u=t.getSourceTask(),f=t.getTargetTask(),h=r&&t.fromField in r,c=r&&t.toField in r;h&&(e=s.getModelById(r[t.fromField]),e&&Ext.Array.remove(e.successors,t),u&&Ext.Array.indexOf(u.successors,t)<0&&u.successors.push(t));c&&(o=s.getModelById(r[t.toField]),o&&Ext.Array.remove(o.predecessors,t),f&&Ext.Array.indexOf(f.predecessors,t)<0&&f.predecessors.push(t));(h||c)&&u&&f&&!n.isUndoingOrRedoing()&&this.scheduleLinkedTasks(u,f);this.resetMethodsCache()}},onDependencyStoreClear:function(n){var t=n.getTaskStore();t&&t.fillTasksWithDepInfo()},getDependenciesForTask:function(n){return n.successors.concat(n.predecessors)},getIncomingDependenciesForTask:function(n,t){return t?n.predecessors:n.predecessors.slice()},getOutgoingDependenciesForTask:function(n,t){return t?n.successors:n.successors.slice()},getKeyByDeps:function(n,t,i){var f,u,e,r;if(!n||!n.length)return"";for(f="",u=0,e=n.length;u<e;u++)r=n[u],f+=(r.getSourceId&&r.getSourceId()||r[t])+":"+(r.getTargetId&&r.getTargetId()||r[i])+",";return f},buildCacheKey:function(n,t,i,r,u){var f=u.fromField||(u.fromField=this.model.prototype.fromField),e=u.toField||(u.toField=this.model.prototype.toField),o=u.ignoreDepKey,s=u.addDepKey;return u.hasOwnProperty("ignoreDepKey")||(u.ignoreDepKey=o=i&&this.getKeyByDeps(i,f,e)||"",u.addDepKey=s=r&&this.getKeyByDeps(r,f,e)||""),n+"-"+t+"-"+o+"-"+s},hasTransitiveDependency:function(n,t,i,r,u){var o,c,s,h,v;u=u||{visitedTasks:{}};var l=this.buildCacheKey(n,t,i,r,u),y=u.visitedTasks,f=u.extraSuccessors;if(this.isCachedResultAvailable("hasTransitiveDependency",l))return this.methodsCache.hasTransitiveDependency[l];var w=this,b=u.fromField,k=u.toField,p=this.getTaskById(n),e,a;if(y[n])return!1;if(y[n]=!0,p){if(r&&!f)for(f=u.extraSuccessors={},e=0,a=r.length;e<a;e++)o=r[e],c=o.getSourceId&&o.getSourceId()||o[b],f[c]=f[c]||[],f[c].push(o);for(h=p.successors,f&&f[n]&&(h=h.concat(f[n])),e=0,a=h.length;e<a;e++)if(s=h[e],v=s.getTargetId&&s.getTargetId()||s[k],(!i||Ext.Array.indexOf(i,s)==-1)&&(v===t||w.hasTransitiveDependency(v,t,i,r,u)))return this.setCachedResult("hasTransitiveDependency",l,!0)}return this.setCachedResult("hasTransitiveDependency",l,!1)},successorsHaveTransitiveDependency:function(n,t,i,r,u){var f,s,e,h,o;if(u=u||{},f=this.buildCacheKey(n,t,i,r,u),s=t instanceof Gnt.model.Task?t:this.getTaskById(t),this.isCachedResultAvailable("successorsHaveTransitiveDependency",f))return this.methodsCache.successorsHaveTransitiveDependency[f];for(e=0,h=s.successors.length;e<h;e++)if(o=s.successors[e].getTargetId(),this.hasTransitiveDependency(n,o,i,r)||this.predecessorsHaveTransitiveDependency(n,o,i,r)||this.successorsHaveTransitiveDependency(n,o,i,r,u))return this.setCachedResult("successorsHaveTransitiveDependency",f,!0);return this.setCachedResult("successorsHaveTransitiveDependency",f,!1)},predecessorsHaveTransitiveDependency:function(n,t,i,r,u){var f,s,e,h,o;if(u=u||{},f=this.buildCacheKey(n,t,i,r,u),s=n instanceof Gnt.model.Task?n:this.getTaskById(n),this.isCachedResultAvailable("predecessorsHaveTransitiveDependency",f))return this.methodsCache.predecessorsHaveTransitiveDependency[f];for(e=0,h=s.predecessors.length;e<h;e++)if(o=s.predecessors[e].getSourceId(),this.hasTransitiveDependency(o,t,i,r)||this.successorsHaveTransitiveDependency(o,t,i,r)||this.predecessorsHaveTransitiveDependency(o,t,i,r,u))return this.setCachedResult("predecessorsHaveTransitiveDependency",f,!0);return this.setCachedResult("predecessorsHaveTransitiveDependency",f,!1)},isPartOfTransitiveDependency:function(n){var t=n instanceof Gnt.model.Task?n:this.getTaskById(n);return!t.predecessors.length&&!t.successors.length?!1:t.predecessors.length?this.predecessorsHaveTransitiveDependency.apply(this,arguments):this.successorsHaveTransitiveDependency.apply(this,arguments)},getCycle:function(n){var r,t,s,u;n=n||{};Ext.applyIf(n,{ignoreTasks:{},visitedTasks:{},path:[],task:this.getAt(0).getSourceTask()});var f=n.visitedTasks,h=n.ignoreTasks,e=n.path,o=n.task,i=o.getId();if(!h[i]){if(e.push(o),f[i])return e;for(f[i]=!0,r=o.successors,t=0,s=r.length;t<s;t++)if(n.task=r[t].getTargetTask(),u=this.getCycle(n),u)return u;e.pop();delete f[i]}},getCycles:function(){var i=this,n=[],t={};return this.each(function(r){var u=i.getCycle({task:r.getSourceTask(),ignoreTasks:t}),f,e;if(u){for(f=0,e=u.length;f<e;f++)t[u[f]]=!0;n.push(u)}}),n},resetMethodsCache:function(){this.methodsCache={}},isCachedResultAvailable:function(n,t){return this.methodsCache[n]&&this.methodsCache[n].hasOwnProperty(t)},getCachedResult:function(n,t){return this.methodsCache[n][t]},setCachedResult:function(n,t,i){return this.methodsCache[n]=this.methodsCache[n]||{},this.methodsCache[n][t]=i,i},getGroupTopTasks:function(n,t){var e=n.length,o=t.length,i=e,r=o,u,f;do u=n[i],f=t[r],i--,r--;while(u==f&&i>=0&&r>=0);return[u,f]},groupsHasTransitiveDependency:function(n,t,i,r,u){var f=u||{targets:null,visitedTasks:{}},rt=this.getTaskStore().getRootNode(),k=!1,ut=this,a=this.getTaskById(n),v=this.getTaskById(t),d=f.visitedTasks,y=f.targets,h,e,c,g,o,l;f.targetGroup||(f.targetGroup=v.getTopParent(!0));var p=f.fromField||(f.fromField=this.model.prototype.fromField),w=f.toField||(f.toField=this.model.prototype.toField),nt=f.ignoreDepKey,tt=f.addDepKey,it=this.getGroupTopTasks(a.getTopParent(!0),f.targetGroup),b=it[0],s=it[1];if(b===a&&s===v&&a.isLeaf()&&v.isLeaf())return this.hasTransitiveDependency(n,t,i);if(f.hasOwnProperty("ignoreDepKey")||(f.ignoreDepKey=nt=i&&this.getKeyByDeps(i,p,w)||"",f.addDepKey=tt=r&&this.getKeyByDeps(r,p,w)||""),h=b.getId()+"-"+s.getId()+"-"+nt+"-"+tt,this.isCachedResultAvailable("groupsHasTransitiveDependency",h))return this.methodsCache.groupsHasTransitiveDependency[h];if(s!==f.targetTopParent&&(f.targetTopParent=s,y=f.targets={},s.cascadeBy(function(n){y[n.getId()]=!0})),e=f.extraSuccessors,r&&!e)for(e=f.extraSuccessors={},c=0,g=r.length;c<g;c++)o=r[c],l=o.getSourceId&&o.getSourceId()||o[p],e[l]=e[l]||[],e[l].push(o);return b.cascadeBy(function(n){var u,o,h,l,s,c;if(n!==rt){if(u=n.getId(),d[u])return!1;for(d[u]=!0,o=n.successors,e&&e[u]&&(o=o.concat(e[u])),h=0,l=o.length;h<l;h++)if(s=o[h],c=s.getTargetId&&s.getTargetId()||s[w],(!i||Ext.Array.indexOf(i,s)==-1)&&(y[c]||ut.groupsHasTransitiveDependency(c,t,i,r,f)))return k=!0,!1}}),this.setCachedResult("groupsHasTransitiveDependency",h,k)},getDependencyError:function(n,t,i,r,u,f){var e,s,h,v=n instanceof Gnt.model.Dependency,a,o,c,l;if(v?(e=n.getSourceId(),s=this.getTaskById(e),r=t,u=i,r&&Ext.Array.contains(r,n)&&(r=r.slice(),Ext.Array.remove(r,n)),i=n.getType(),t=n.getTargetId(),h=this.getTaskById(t),n.store&&(f=n)):(e=n,s=this.getTaskById(e),h=this.getTaskById(t),i===undefined&&(a=this.model.getField(this.model.prototype.typeField).defaultValue,i=a!==undefined?a:this.model.Type.EndToStart)),f||!v||n.isValid()){if(!e||!t||e==t)return-1}else return-1;if(!s||!h)return-2;if(!this.isValidDependencyType(i))return-10;if(s.contains(h)||h.contains(s))return-9;if((u||f)&&(o=[],f&&o.push(f),u&&(o=o.concat(u))),this.transitiveDependencyValidation){if(this.hasTransitiveDependency(e,t,o,r))return-3}else if(this.areTasksLinkedForward(e,t,o,r))return-3;if(this.hasTransitiveDependency(t,e,o,r))return-4;if(this.transitiveDependencyValidation&&this.isPartOfTransitiveDependency(e,t,o,r))return-5;if(this.strictDependencyValidation){if(this.groupsHasTransitiveDependency(t,e,o,r))return-7;if(this.transitiveDependencyValidation&&this.groupsHasTransitiveDependency(e,t,o,r))return-8}return!this.allowParentTaskDependencies&&(!s.isLeaf()||!h.isLeaf())?-11:h.isProject||s.isProject?-12:(c=h.getProject(),l=s.getProject(),c!=l&&(c&&!c.getAllowDependencies()||l&&!l.getAllowDependencies()))?-13:0},isValidDependencyType:function(n){if(this.allowedDependencyTypes){var t=!1,i=this.model;return Ext.each(this.allowedDependencyTypes,function(r){if(i.Type[r]==n)return t=!0,!1}),t}return!0},isValidDependency:function(n,t,i,r,u,f){return!this.getDependencyError(n,t,i,r,u,f)},areTasksLinkedForward:function(n,t,i,r){var o=n instanceof Gnt.model.Task?n:this.getTaskById(n),s=t instanceof Gnt.model.Task?t:this.getTaskById(t),c,v,u,f,h,y,p;if(!o||!s)return!1;var w=this.model.prototype,l=w.fromField,a=w.toField,e=o.getId()+"-"+s.getId()+"-"+(this.getKeyByDeps(i,l,a)||"")+"-"+(this.getKeyByDeps(r,l,a)||"");if(this.isCachedResultAvailable("areTasksLinkedForward",e))return this.methodsCache.areTasksLinkedForward[e];for(c=o.successors,v=s.predecessors,f=0,h=c.length;f<h;f++)if(u=c[f],(!i||!Ext.Array.contains(i,u))&&Ext.Array.contains(v,u))return this.setCachedResult("areTasksLinkedForward",e,!0);if(r)for(f=0,h=r.length;f<h;f++)if(u=r[f],y=u.getSourceId&&u.getSourceId()||u[l],p=u.getTargetId&&u.getTargetId()||u[a],y==o.getId()&&p==s.getId())return this.setCachedResult("areTasksLinkedForward",e,!0);return this.setCachedResult("areTasksLinkedForward",e,!1)},areTasksLinked:function(n,t){var i=n instanceof Gnt.model.Task?n:this.getTaskById(n),r=t instanceof Gnt.model.Task?t:this.getTaskById(t),u;return!i||!r?!1:(u=i.getId()+"-"+r.getId(),this.isCachedResultAvailable("areTasksLinked",u))?this.methodsCache.areTasksLinked[u]:this.setCachedResult("areTasksLinked",u,this.areTasksLinkedForward(i,r)||this.areTasksLinkedForward(r,i))},getByTaskIds:function(n,t){var i=this.findBy(function(i){var r=i.getTargetId(),u=i.getSourceId();if(u===n&&r===t||u===t&&r===n)return!0});return this.getAt(i)},getTaskById:function(n){var t=this.getTaskStore();return t&&t.getModelById(n)||null},getSourceTask:function(n){var t=n instanceof Gnt.model.Dependency?n.getSourceId():n;return this.getTaskById(t)},getTargetTask:function(n){var t=n instanceof Gnt.model.Dependency?n.getTargetId():n;return this.getTaskById(t)},getTaskStore:function(){return this.taskStore},setTaskStore:function(n){this.taskStore=n}});Ext.define("Gnt.data.linearizator.CycleResolvers",function(){function u(){return!1}function f(){Ext.Error.raise("Can't linearize dependent tasks, there's a cycle in the dependency chain!")}function e(t,i){var f=o(t,i),r={},u=function(n,t){(r[n]||(r[n]=[])).push(t)};return n(f,function(n){n.prevSibling&&(n.foldedDeps=c(n.prevSibling.foldedDeps,n.foldedDeps,u));!n.nextSibling&&n.parentNode&&(n.parentNode.foldedDeps=l(n.foldedDeps,n.parentNode.foldedDeps,u))}),a(i.fromById,r),!0}function o(n,t){var u=[],r={},i,f;for(i in n)n.hasOwnProperty(i)&&(f=r[i]=s(n[i].task,n,t),n.hasOwnProperty(f.parentNode)||u.push(f));for(i in r)r.hasOwnProperty(i)&&(r[i]=h(r[i],r));return u.length==1?u[0]:{parentNode:null,prevSibling:null,nextSibling:null,children:u,foldedDeps:{}}}function s(n,t,i){var y=Ext.Object,p=i.fromById,c={},l=n.internalId,e,a,r,u,o,s,h,f,v;for(e=y.getKeys(p[l]),c[l]=e.length?e:{},a=n.parentNode&&t.hasOwnProperty(n.parentNode.internalId)&&n.parentNode.internalId,o=n.childNodes||[],h=[],f=0,v=o.length;f<v;f++)s=o[f].internalId,t.hasOwnProperty(s)&&h.push(s);for(u=n.previousSibling;u&&!t.hasOwnProperty(u.internalId);)u=u.previousSibling;for(u=u&&u.internalId,r=n.nextSibling;r&&!t.hasOwnProperty(r.internalId);)r=r.nextSibling;return r=r&&r.internalId,{parentNode:a,prevSibling:u,nextSibling:r,children:h,foldedDeps:c}}function h(n,t){for(var r=n.children,i=0,u=r.length;i<u;i++)r[i]=t[r[i]];return n.parentNode=(n.parentNode||n.parentNode===0)&&t[n.parentNode]||null,n.prevSibling=(n.prevSibling||n.prevSibling===0)&&t[n.prevSibling]||null,n.nextSibling=(n.nextSibling||n.nextSibling===0)&&t[n.nextSibling]||null,n}function n(t,i){for(var u=t.children,r=0,f=u.length;r<f;r++)n(u[r],i);return i(t),t}function c(n,u,f){var e=t(n,u),c=e.fromAtoB,l=e.fromBtoA,s=e.fromAtoBtotal,h=e.fromBtoAtotal,o={};return s>0&&h>0&&(o=s<h?c:l),i(o,f),r(n,u,o)}function l(n,u,f){var s=Ext.Object,o=t(n,u),h=o.fromAtoB,c=o.fromBtoA,e;return e=s.merge({},h,c),i(e,f),r(n,u,e)}function t(n,t){for(var s=Ext.Object,h=Ext.Array,f=s.getKeys(n),e=s.getKeys(t),c={},l={},a=0,v=0,u,i,r=0,o=f.length;r<o;++r)u=f[r],i=h.intersect(e,n[u]),i.length&&(c[u]=i,a+=i.length);for(r=0,o=e.length;r<o;++r)u=e[r],i=h.intersect(f,t[u]),i.length&&(l[u]=i,v+=i.length);return{fromAtoB:c,fromBtoA:l,fromAtoBtotal:a,fromBtoAtotal:v}}function i(n,t){var i,r,f,u;for(i in n)if(n.hasOwnProperty(i))for(u=n[i],r=0,f=u.length;r<f;++r)t(i,u[r])}function r(n,t,i){var f=Ext.Object,e=Ext.Array,u,r;u=f.merge({},n,t);for(r in i)i.hasOwnProperty(r)&&u.hasOwnProperty(r)&&(u[r]=e.difference(u[r],i[r]));return u}function a(n,t){var i,u,f,r,e;for(i in t)if(t.hasOwnProperty(i))for(u=t[i],r=0,e=u.length;r<e;++r)f=u[r],n[i][f][0]="green";return n}return{singleton:!0,none:u,exception:f,cut:e}});Ext.define("Gnt.data.Linearizator",function(){function u(n,t,i){return Ext.isObject(n)||Ext.isArray(n)||Ext.Error.raise("Invalid arguments, source task list must be either a task or array of tasks!"),Ext.isFunction(t)||Ext.Error.raise("Invalid arguments, processor function must be a function!"),Ext.isObject(i)||Ext.Error.raise("Invalid arguments, walking specification must be an object!"),i=e(i),f([].concat(n),t,i.tasksDepsCollectingFn,i.cycleSolverFn)}function f(t,i,r,u){var s=!1,o=!0,f,e,h,c,l;for(f=v(),e=y(),n(t,r,f,e);o;){for(s=!1;!s;){s=!0;o=!1;for(h in f)f.hasOwnProperty(h)&&f[h].color!="green"&&(c=f[h].task,l=b(c,e),l!="red"?(k(l,c,f,e),i(c,l,f,e),s=!1):o=!0)}o&&(o=u&&u(f,e))}}function e(n){var f=o(n),u,t,i;return i=r[f],i||(u=Gnt.data.linearizator.CycleResolvers[n.cycles||"none"],u||Ext.Error.raise("Can't resolve cycle resolution function, "+n.cycles+" is unknown!"),t=[],n.self&&t.push(h),n.ancestors&&t.push(c),n.descendants&&t.push(l),n.successors&&t.push(a),t=s(t),i={tasksDepsCollectingFn:t,cycleSolverFn:u},r[f]=i),i}function o(n){var i=[];for(var t in n)n.hasOwnProperty(t)&&i.push(t,"=",String(n[t]));return i.join(";")}function s(n){return function(t,i,r){var u=[];return Ext.Array.each(n,function(n){u=u.concat(n(t,i,r))}),u}}function n(t,i,r,u){Ext.Array.each(t,function(t){var f=i(t,r,u);f.length>0&&n(f,i,r,u)})}function h(n,t){var i=[],r=n.internalId;return t.hasOwnProperty(r)||(t[r]={task:n,color:"red"},i=[n]),i}function c(n,t,i){var c=[],e=i.downFromById,l=i.downToById,a=i.upFromById,o=i.upToById,u=n.internalId,f=n.parentNode,r=f&&f.internalId,s,h;return f&&!t.hasOwnProperty(r)&&(t[r]={task:f,color:"red"},c.push(f)),f&&(s=["red"],h=["red"],e[r]||(e[r]={}),e[r][u]||(e[r][u]=s),l[u]||(l[u]=s),o[r]||(o[r]={}),o[r][u]||(o[r][u]=h),a[u]||(a[u]=h)),c}function l(n,t,i){var e=[],u=i.downFromById,o=i.downToById,s=i.upFromById,f=i.upToById,h=!n.isRoot()&&n.childNodes,r=n.internalId;return h&&Ext.Array.each(h,function(n){var i=n.internalId,h,c;t.hasOwnProperty(i)||(t[i]={task:n,color:"red"},e.push(n));h=["red"];c=["red"];u[r]||(u[r]={});u[r][i]||(u[r][i]=h);o[i]||(o[i]=h);f[r]||(f[r]={});f[r][i]||(f[r][i]=c);s[i]||(s[i]=c)}),e}function a(n,t,i){var e=[],u=i.fromById,f=i.toById,o=n.getSuccessors(),r=n.internalId;return Ext.Array.each(o,function(n){var i=n.internalId,o;t.hasOwnProperty(i)||(t[i]={task:n,color:"red"},e.push(n));o=["red"];u[r]||(u[r]={});u[r][i]||(u[r][i]=o);f[i]||(f[i]={});f[i][r]||(f[i][r]=o)}),e}function v(){return{}}function y(){return{fromById:{},toById:{},downFromById:{},downToById:{},upFromById:{},upToById:{}}}function t(n,t){var i=t.toById[n.internalId],u=!1;for(var r in i)if(i.hasOwnProperty(r)&&i[r]&&i[r][0]=="red"){u=!0;break}return u}function i(n,t){var i=t.downToById,r=n.internalId;return i[r]&&i[r][0]=="red"}function p(n,t){var i=t.downFromById[n.internalId],u=!1;for(var r in i)if(i.hasOwnProperty(r)&&i[r]&&i[r][0]=="red"){u=!0;break}return u}function w(n,t){var i=t.upToById[n.internalId],u=!1;for(var r in i)if(i.hasOwnProperty(r)&&i[r]&&i[r][0]=="red"){u=!0;break}return u}function b(n,r){return t(n,r)||i(n,r)||w(n,r)?t(n,r)||i(n,r)||!p(n,r)?"red":"yellow":"green"}function k(n,t,i,r){var e=t.internalId,o=r.fromById[e],f=r.downFromById[e],s=r.upFromById[e],u;if(i[e].color=n,n=="green"){if(o)for(u in o)o.hasOwnProperty(u)&&(o[u][0]=n);if(f)for(u in f)f.hasOwnProperty(u)&&(f[u][0]=n);s&&(s[0]=n)}else if(n=="yellow"&&f)for(u in f)f.hasOwnProperty(u)&&(f[u][0]=n)}var r={};return{singleton:!0,linearWalkBySpecification:u}});Ext.define("Gnt.model.Resource",{extend:Sch.model.Resource,customizableFields:["CalendarId"],calendarIdField:"CalendarId",normalized:!1,calendarWaitingListener:null,getTaskStore:function(){return this.store.getTaskStore()},getEventStore:function(){return this.getTaskStore()},getTasks:function(){return this.getEvents()},getCalendar:function(n){var t=this;return n?t.getOwnCalendar():t.getOwnCalendar()||t.getProjectCalendar()},getOwnCalendar:function(){var n=this.getCalendarId();return n?Gnt.data.Calendar.getCalendar(n):null},getProjectCalendar:function(){return this.getTaskStore().getCalendar()},setCalendar:function(n){var t=n instanceof Gnt.data.Calendar;if(t&&!n.calendarId)throw new Error("Can't set calendar w/o `calendarId` property");this.setCalendarId(t?n.calendarId:n)},setCalendarId:function(n,t){var u,r,f,i;if(n instanceof Gnt.data.Calendar&&(n=n.calendarId),u=this.getCalendarId(),u!=n||t)if(this.calendarWaitingListener&&(this.calendarWaitingListener.destroy(),this.calendarWaitingListener=null),r={calendarchange:this.onCalendarChange,scope:this},f=this.calendar||Gnt.data.Calendar.getCalendar(u),this.calendar=null,f&&f.un(r),this.set(this.calendarIdField,n),i=Gnt.data.Calendar.getCalendar(n),i){i.on(r);t||this.onCalendarChange()}else this.calendarWaitingListener=Ext.data.StoreManager.on("add",function(){if(i=Gnt.data.Calendar.getCalendar(n),i){this.calendarWaitingListener.destroy();this.calendarWaitingListener=null;i.on(r);this.onCalendarChange()}},this,{destroyable:!0})},onCalendarChange:function(){this.inOnCalendarChange=!0;this.adjustToCalendar();this.inOnCalendarChange=!1},adjustToCalendar:function(){this.getTaskStore()&&this.forEachTask(function(n){n.adjustToCalendar()})},assignTo:function(n,t,i){var r=n instanceof Gnt.model.Task?n:this.getTaskStore().getModelById(n);return r.assign(this,t,i)},unAssignFrom:function(n,t){var i=n instanceof Gnt.model.Task?n:this.getTaskStore().getModelById(n);return i.unAssign(this,t)},unassignFrom:function(){return this.unAssignFrom.apply(this,arguments)},forEachAssignment:function(n,t){var u=this,f=u.getTaskStore(),e=f&&f.getAssignmentStore(),o=e&&e.getAssignmentsForResource(u)||[],i,s,r;for(t=t||this,r=!1,i=0,s=o.length;!r&&i<s;++i)r=!1===n.call(t,o[i])},forEachTask:function(n,t){var f=this,e=f.getTaskStore(),o=e&&e.getAssignmentStore(),s=o&&o.getAssignmentsForResource(f)||[],i,h,r,u;for(t=t||this,r=!1,i=0,h=s.length;!r&&i<h;++i)u=s[i].getTask(),u&&(r=!1===n.call(t,u))},collectAvailabilityIntervalPoints:function(n,t,i,r,u){for(var f=0,s=n.length;f<s;f++){var h=n[f],e=h.startDate-0,o=h.endDate-0;r[e]||(r[e]=[],u.push(e));r[e].push(t);r[o]||(r[o]=[],u.push(o));r[o].push(i)}},forEachAvailabilityIntervalWithTasks:function(n,t,i){var it,r,l,k,st,a,v,rt,o;i=i||this;var f=n.startDate,e=n.endDate,ut=n.task;if(!f||!e)throw"Both `startDate` and `endDate` are required for `forEachAvailabilityIntervalWithTasks`";var h=new Date(f),ft=n.includeAllIntervals,et=n.includeResCalIntervals,ht=this.getCalendar(),ct=[],d=[],g=[],u=[+f,+e],s={};if(s[+f]=[{type:"00-intervalStart"}],s[+e]=[{type:"00-intervalEnd"}],this.forEachAssignment(function(n){var t=n.getTask(),r;if(t&&(!ut||t===ut)){var h=t.getStartDate(),c=t.getEndDate(),i=t.getId();if(!(h>e)&&!(c<f)){if(d.push(t),g.push(t.getOwnCalendar()||this.getCalendar()),t.isSegmented())for(var l=t.getSegments(),o=0,a=l.length;o<a;o++)r=l[o],this.collectAvailabilityIntervalPoints([{startDate:r.getStartDate(),endDate:r.getEndDate()}],{type:"05-taskStart",assignment:n,taskId:i,units:n.getUnits()},{type:"04-taskEnd",taskId:i},s,u);else this.collectAvailabilityIntervalPoints([{startDate:h,endDate:c}],{type:"05-taskStart",assignment:n,taskId:i,units:n.getUnits()},{type:"04-taskEnd",taskId:i},s,u);ct.push(n)}}}),d.length||ft||et){for(it=Sch.util.Date,st={};h<e;){for(this.collectAvailabilityIntervalPoints(ht.getAvailabilityIntervalsFor(h),{type:"00-resourceAvailabilityStart"},{type:"01-resourceAvailabilityEnd"},s,u),r=0,l=g.length;r<l;r++)k=d[r].getId(),this.collectAvailabilityIntervalPoints(g[r].getAvailabilityIntervalsFor(h),{type:"02-taskAvailabilityStart",taskId:k},{type:"03-taskAvailabilityEnd",taskId:k},s,u);h=it.getStartOfNextDay(h)}u.sort(function(n,t){return n-t});var ot=!1,c=!1,nt={},y=0,p=0,tt={};for(r=0,l=u.length-1;r<l;r++){for(a=s[u[r]],a.sort(function(n,t){return n.type<t.type?1:-1}),v=0,rt=a.length;v<rt;v++){o=a[v];switch(o.type){case"00-resourceAvailabilityStart":c=!0;break;case"01-resourceAvailabilityEnd":c=!1;break;case"02-taskAvailabilityStart":y++;tt[o.taskId]=!0;break;case"03-taskAvailabilityEnd":y--;delete tt[o.taskId];break;case"05-taskStart":nt[o.taskId]=o;p++;break;case"04-taskEnd":delete nt[o.taskId];p--;break;case"00-intervalStart":ot=!0;break;case"00-intervalEnd":return}}if(ot&&(ft||et&&c||c&&y&&p)){var lt={inResourceCalendar:!!c,inTasksCalendar:!!y,inTask:p,inTaskCalendarHash:Ext.apply({},tt)},w=u[r],b=u[r+1];if(w>e||b<f)continue;if(w<f&&(w=+f),b>e&&(b=+e),t.call(i,w,b,nt,lt)===!1)return!1}}}},getAllocationInfo:function(n){var t=[];return this.forEachAvailabilityIntervalWithTasks(n,function(n,i,r,u){var e=0,o=[],s={},h=0,c=[],l={},v=i-n,a=0,f;if(u.inResourceCalendar&&u.inTasksCalendar&&u.inTask)for(f in r)u.inTaskCalendarHash[f]&&(a+=v*r[f].units*.01,e+=r[f].units,s[f]=r[f].assignment,o.push(r[f].assignment)),h+=r[f].units,l[f]=r[f].assignment,c.push(r[f].assignment);t.push(Ext.apply({startDate:new Date(n),endDate:new Date(i),effectiveTotalAllocation:e,effectiveAssignmentsHash:s,effectiveAssignments:o,totalAllocationMS:a,totalAllocation:h,assignments:c,assignmentsHash:l},u))}),t},getUtilizationInfo:function(n,t,i,r){var c=this,f=0,e=!1,o=!1,u={},s={},h;return arguments.length<3&&(i=r=100),h=c.getAllocationInfo({includeResCalIntervals:!0,startDate:n,endDate:t}),Ext.Array.each(h,function(n){f+=n.totalAllocationMS;n.effectiveTotalAllocation>r?(e=!0,o=!1):!e&&n.effectiveTotalAllocation<i&&(o=!0);Ext.Array.each(n.effectiveAssignments,function(t){var e=t.getId(),v=t.getTaskId(),o=t.getUnits(),h=Math.floor((n.endDate-n.startDate)*o/100),c=0,l=o>r,a=o<i,f;u[e]?(f=u[e],f.allocationMs+=h,f.allocationDeltaMs+=c,f.isOverallocated=f.isOverallocated||l,f.isUnderallocated=f.isUnderallocated||a):(f={isUtilized:!0,allocationMs:h,allocationDeltaMs:c,isOverallocated:l,isUnderallocated:a},u[e]=f,s[v]=f)})}),{isUtilized:f>0,allocationMs:f,allocationDeltaMs:0,isOverallocated:e,isUnderallocated:o,assignmentInfo:u,taskInfo:s}}});Ext.define("Gnt.data.ResourceStore",{extend:Sch.data.ResourceStore,storeId:"resources",model:"Gnt.model.Resource",alias:"store.gantt_resourcestore",taskStore:null,constructor:function(n){this.callParent([n]);this.on({load:this.normalizeResources,remove:this.onResourceRemoved,priority:100})},normalizeResources:function(){this.each(function(n){if(!n.normalized){var t=n.getCalendarId();t&&n.setCalendarId(t,!0);n.normalized=!0}})},onResourceRemoved:function(n,t){var i=this.getAssignmentStore();Ext.Array.each(t,function(n){i.removeAssignmentsForResource(n)})},getTaskStore:function(){return this.taskStore},setTaskStore:function(n){this.taskStore=n},getAssignmentStore:function(){var n=this.getTaskStore();return n&&n.getAssignmentStore()||null},getDependencyStore:function(){var n=this.getTaskStore();return n&&n.getDependencyStore()||null}});Ext.define("Gnt.model.utilization.UtilizationNegotiationStrategyMixin",{utilizationNegotiationStrategyClass:"Gnt.model.utilization.DefaultUtilizationNegotiationStrategy",utilizationNegotiationStrategy:null,initUtilizationNegotiationStrategyMixin:function(n){var t=this;return n&&n.hasOwnProperty("utilizationNegotiationStrategy")?(t.utilizationNegotiationStrategy=n.utilizationNegotiationStrategy,delete n.utilizationNegotiationStrategy):t.utilizationNegotiationStrategy=Ext.create(t.utilizationNegotiationStrategyClass),n},getUtilizationNegotiationStrategy:function(){return this.utilizationNegotiationStrategy},setUtilizationNegotiationStrategy:function(n){var t=this;t.utilizationNegotiationStrategy!==n&&n&&(t.utilizationNegotiationStrategy=n)}});Ext.define("Gnt.model.UtilizationEvent",{extend:Sch.model.Event,mixins:[Gnt.model.utilization.UtilizationNegotiationStrategyMixin],originalResource:null,originalAssignment:null,customizableFields:[{name:"utilizationInfo",type:"auto",persist:!1,defaultValue:null}],utilizationInfoField:"utilizationInfo",constructor:function(n){var t=this,i,r;n=t.initUtilizationNegotiationStrategyMixin(n);n.originalResource&&(i=n.originalResource,delete n.originalResource);n.originalAssignment&&(r=n.originalAssignment,delete n.originalAssignment);t.callParent(arguments);i&&t.setOriginalResource(i);r&&t.setOriginalAssignment(r)},isSurrogateAssignment:function(){return!!this.originalAssignment},isSurrogateSummary:function(){return!!this.originalResource},getOriginalAssignment:function(){return this.originalAssignment},setOriginalAssignment:function(n){var t=this;t.originalAssignment!==n&&(t.originalAssignment=n,t.isInSyncWithOriginal()||t.syncFromOriginal())},getOriginalResource:function(){var n=this,i=n.originalResource,t=n.originalAssignment;return i||t&&t.getResource()||null},setOriginalResource:function(n){var t=this;t.originalResource!==n&&(t.originalResource=n,t.isInSyncWithOriginal()||t.syncFromOriginal())},getOriginalTask:function(){var t=this,n=t.originalAssignment;return n&&n.getTask()||null},isInSyncWithOriginal:function(){var n=this,t=!0,r,f,i,u,e;return n.isSurrogateAssignment()?(r=n.getOriginalAssignment(),i=n.getOriginalTask(),r&&(t=t&&n.getId()==n.self.getSurrogateIdFor(r)),i&&!i.isUnscheduled()&&(t=t&&n.getStartDate()-n.adjustStartDateToTick(i.getStartDate())==0,t=t&&n.getEndDate()-n.adjustEndDateToTick(i.getEndDate())==0)):n.isSurrogateSummary()?(f=n.getOriginalResource(),u=n.calculateSurrogateSummaryTimeSpan(),t=t&&n.getId()==n.self.getSurrogateIdFor(f),t=t&&n.getStartDate()-u.startDate==0,t=t&&n.getEndDate()-u.endDate==0):Ext.Error.raise("Unknown surrogate type"),t&&(e=n.getUtilizationNegotiationStrategy().getUtilizationInfoForUtilizationEvent(n),t=Ext.Object.equals(n.getUtilizationInfo(),e)),t},syncFromOriginal:function(){var n=this,i,r,t,u,f;n.beginEdit();n.isSurrogateAssignment()?(i=n.getOriginalAssignment(),t=n.getOriginalTask(),i&&n.setId(n.self.getSurrogateIdFor(i)),t&&!t.isUnscheduled()&&n.setStartEndDate(n.adjustStartDateToTick(t.getStartDate()),n.adjustEndDateToTick(t.getEndDate()))):n.isSurrogateSummary()&&(r=n.getOriginalResource(),r&&n.setId(n.self.getSurrogateIdFor(r)),u=n.calculateSurrogateSummaryTimeSpan(),n.setStartEndDate(u.startDate,u.endDate));f=n.getUtilizationNegotiationStrategy().getUtilizationInfoForUtilizationEvent(n);Ext.Object.equals(n.getUtilizationInfo(),f)||n.setUtilizationInfo(f);n.endEdit()},getUtilizationInfo:function(){var n=this,t=n.get(n.utilizationInfoField);return t||(t=n.getUtilizationNegotiationStrategy().getUtilizationInfoForUtilizationEvent(n),n.set(n.utilizationInfoField,t)),t},syncToOriginal:function(){var n=this,t;n.isSurrogateAssignment()&&(t=n.getOriginalTask(),t&&t.setStartEndDate(n.getStartDate(),n.getEndDate(),!0))},isInSyncWithSurrogate:function(n){var t=this;return t.getOriginalResource()===n.getOriginalResource()&&t.getOriginalAssignment()===n.getOriginalAssignment()&&t.getId()===n.getId()&&t.getStartDate()-n.getStartDate()==0&&t.getEndDate()-n.getEndDate()==0&&Ext.Object.equals(t.getUtilizationInfo(),n.getUtilizationInfo())},syncFromSurrogate:function(n){var t=this;t.originalResource=n.originalResource;t.originalAssignment=n.originalAssignment;t.beginEdit();t.setId(n.getId());t.setStartEndDate(n.getStartDate(),n.getEndDate());Ext.Object.equals(t.getUtilizationInfo(),n.getUtilizationInfo())||t.setUtilizationInfo(n.getUtilizationInfo());t.endEdit()},getUtilizationInfoForInterval:function(n){var t=this;return t.getUtilizationNegotiationStrategy().getUtilizationInfoForAssignmentEventInterval(t,n)},forEachInterval:function(n){var t=this;return t.getUtilizationNegotiationStrategy().forEachTimeSpanInterval(t,n)},calculateSurrogateSummaryTimeSpan:function(){var n=this;return n.getUtilizationNegotiationStrategy().calculateResourceAssignmentsTimespan(n.getOriginalResource())},adjustStartDateToTick:function(n){var t=this;return t.getUtilizationNegotiationStrategy().adjustStartDateToTick(n)},adjustEndDateToTick:function(n){var t=this;return t.getUtilizationNegotiationStrategy().adjustEndDateToTick(n)},clone:function(n){var t=this,i=t.callParent([n]);return i.setUtilizationNegotiationStrategy(t.getUtilizationNegotiationStrategy()),i},inheritableStatics:{getSurrogateIdFor:function(n){var t=n.getId();return n instanceof Gnt.model.Resource?t="resource-"+t:n instanceof Gnt.model.Assignment?t="assignment-"+t:Ext.Error.raise("Wrong original record type"),t}}});Ext.define("Gnt.data.ResourceUtilizationEventStore",{extend:Sch.data.EventStore,model:"Gnt.model.UtilizationEvent",storeId:null,getModelByOriginal:function(n){var t=this;return t.getModelById(t.model.getSurrogateIdFor(n))}});Ext.define("Gnt.model.UtilizationResource",{extend:Sch.model.Resource,customizableFields:[{name:"TaskName"},{name:"TaskSequenceNumber"}],taskNameField:"TaskName",taskSequenceNumberField:"TaskSequenceNumber",originalResource:null,originalAssignment:null,constructor:function(n){var t=this,i,r;n.originalResource&&(i=n.originalResource,delete n.originalResource);n.originalAssignment&&(r=n.originalAssignment,delete n.originalAssignment);t.callParent(arguments);i&&t.setOriginalResource(i);r&&t.setOriginalAssignment(r)},getOriginalResource:function(){return this.originalResource||this.originalAssignment&&this.originalAssignment.getResource()},setOriginalResource:function(n){var t=this;t.originalResource!==n&&(t.originalResource=n,t.isInSyncWithOriginal()||t.syncFromOriginal())},getOriginalAssignment:function(){return this.originalAssignment},setOriginalAssignment:function(n){var t=this;t.originalAssignment!==n&&(t.originalAssignment=n,t.isInSyncWithOriginal()||t.syncFromOriginal())},getOriginalTask:function(){var n=this.getOriginalAssignment();return n&&n.getTask()||null},isSurrogateResource:function(){return!this.getOriginalAssignment()},isSurrogateAssignment:function(){return!!this.getOriginalAssignment()},isInSyncWithOriginal:function(){var t=this,i=t.getOriginalResource(),u=t.getOriginalAssignment(),r=t.getOriginalTask(),n=!0;return u?(n=n&&t.getId()==t.self.getSurrogateIdFor(u),r&&(n=n&&t.getTaskName()==r.getName(),n=n&&t.getTaskSequenceNumber()==r.getSequenceNumber())):i&&(n=n&&t.getId()==t.self.getSurrogateIdFor(i),n=n&&t.getName()==i.getName()),n},syncFromOriginal:function(){var n=this,t=n.getOriginalResource(),i=n.getOriginalAssignment(),r=n.getOriginalTask();n.beginEdit();t&&!i&&n.setId(n.self.getSurrogateIdFor(t));i&&!t&&n.setId(n.self.getSurrogateIdFor(i));t&&n.setName(t.getName());r&&(n.setTaskName(r.getName()),n.setTaskSequenceNumber(r.getSequenceNumber()));n.endEdit()},syncToOriginal:function(){Ext.Error.raise("Not implmented")},isInSyncWithSurrogate:function(n){var t=this;return t.originalResource===n.originalResource&&t.originalAssignment===n.originalAssignment&&t.getName()===n.getName()&&t.getTaskName()===n.getTaskName()&&t.getTaskSequenceNumber()===n.getTaskSequenceNumber()},syncFromSurrogate:function(n){var t=this;t.originalResource=n.originalResource;t.originalAssignment=n.originalAssignment;t.beginEdit();t.setId(n.getId());t.setName(n.getName());t.setTaskName(n.getTaskName());t.setTaskSequenceNumber(n.getTaskSequenceNumber());t.endEdit()},inheritableStatics:{getSurrogateIdFor:function(n){var t=n.getId();return n instanceof Gnt.model.Resource?t="resource-"+t:n instanceof Gnt.model.Assignment?t="assignment-"+t:Ext.Error.raise("Wrong original record type"),t}},getResourceStore:function(){return this.store}},function(){Ext.data.NodeInterface.decorate(this)});Ext.define("Gnt.data.ResourceUtilizationStore",{extend:Sch.data.ResourceTreeStore,mixins:[Gnt.model.utilization.UtilizationNegotiationStrategyMixin],model:"Gnt.model.UtilizationResource",eventModel:"Gnt.model.UtilizationEvent",autoDestroy:!0,storeId:null,root:{expanded:!0},proxy:"memory",config:{defaultResourceExpandedState:!1,taskStore:null,resourceStore:null,assignmentStore:null,timeAxis:null,underUtilizationThreshold:null,overUtilizationThreshold:null},folderSort:!1,taskStoreDetacher:null,resourceStoreDetacher:null,assignmentStoreDetacher:null,eventStoreDetacher:null,timeAxisDetacher:null,utilizationInfoCache:null,syncingWithOriginal:!1,utilizationNegotiationStrategyClass:"Gnt.model.utilization.ResourceStoreUtilizationNegotiationStrategy",constructor:function(n){var t=this;t.eventModel=Ext.ClassManager.get(this.eventModel);t.utilizationInfoCache={};t.callParent([n]);t.initUtilizationNegotiationStrategyMixin({utilizationNegotiationStrategy:Ext.create(t.utilizationNegotiationStrategyClass,{underUtilizationThreshold:t.getUnderUtilizationThreshold(),overUtilizationThreshold:t.getOverUtilizationThreshold(),resourceUtilizationStore:t})});t.getEventStore()||t.setEventStore(new Gnt.data.ResourceUtilizationEventStore({model:t.eventModel,resourceStore:t}));t.setupSorters()},destroy:function(){var n=this;n.callParent(arguments);Ext.destroy(n.getEventStore());n.setEventStore(null)},setupSorters:function(){var n=this;n.setSorters([{sorterFn:function(t,i){return t.isSurrogateResource()&&i.isSurrogateResource()&&t.getName()>i.getName()?1:t.isSurrogateResource()&&i.isSurrogateResource()&&t.getName()<i.getName()?-1:t.isSurrogateResource()&&i.isSurrogateResource()?0:t.isSurrogateResource()&&i.isSurrogateAssignment()?1:t.isSurrogateAssignment()&&i.isSurrogateResource()?-1:t.isSurrogateAssignment()&&i.isSurrogateAssignment()?n.getUtilizationNegotiationStrategy().assignmentsComparator(t.getOriginalAssignment(),i.getOriginalAssignment()):0}}])},updateTaskStore:function(n,t){var i=this;t&&Ext.destroy(i.taskStoreDetacher);n&&(i.setResourceStore(n.getResourceStore()||i.setResourceStore()),i.setAssignmentStore(n.getAssignmentStore()||i.getAssignmentStore()),i.taskStoreDetacher=i.mon(n,{load:i.onSourceDataTouch,refresh:i.onSourceDataTouch,clear:i.onSourceDataTouch,add:i.onSourceDataTouch,append:i.onSourceDataTouch,update:i.onSourceDataTouch,remove:i.onSourceDataTouch,bulkremove:i.onSourceDataTouch,move:i.onSourceDataTouch,scope:i,destroyable:!0}))},updateResourceStore:function(n,t){var i=this;t&&Ext.destroy(i.resourceStoreDetacher);n&&(i.resourceStoreDetacher=i.mon(n,{load:i.onSourceDataTouch,refresh:i.onSourceDataTouch,clear:i.onSourceDataTouch,add:i.onSourceDataTouch,update:i.onSourceDataTouch,remove:i.onSourceDataTouch,bulkremove:i.onSourceDataTouch,scope:i,destroyable:!0}))},updateAssignmentStore:function(n,t){var i=this;t&&Ext.destroy(i.assignmentStoreDetacher);n&&(i.assignmentStoreDetacher=i.mon(n,{load:i.onSourceDataTouch,refresh:i.onSourceDataTouch,clear:i.onSourceDataTouch,add:i.onSourceDataTouch,update:i.onSourceDataTouch,remove:i.onSourceDataTouch,bulkremove:i.onSourceDataTouch,scope:i,destroyable:!0}))},setEventStore:function(n){var t=this,i=t.eventStore;t.callParent([n]);i!=n&&(i&&Ext.destroy(t.eventStoreDetacher),n&&(t.utilizationEventStoreDetacher=t.mon(n,{update:t.onUtilizationEventStoreUpdate,scope:t})))},updateTimeAxis:function(n,t){var i=this;t&&Ext.destroy(i.timeAxisDetacher);n&&(i.timeAxisDetacher=i.mon(n,{reconfigure:i.onSourceDataTouch,scope:i,destroyable:!0}))},makeSurrogateResource:function(n){var t=this,i=t.model;return new t.model({Id:i.getSurrogateIdFor(n),originalResource:n,expanded:t.getDefaultResourceExpandedState()})},makeSurrogateAssignment:function(n){var t=this.model;return new t({Id:t.getSurrogateIdFor(n),originalAssignment:n,leaf:!0})},makeSurrogateAssignmentEvent:function(n){var t=this,i=t.eventModel,r=i.getSurrogateIdFor(n);return new i({Id:r,ResourceId:r,originalResource:n instanceof Gnt.model.Resource&&n||null,originalAssignment:n instanceof Gnt.model.Assignment&&n||null,utilizationNegotiationStrategy:t.getUtilizationNegotiationStrategy()})},makeSurrogateResourceBranch:function(n){var t=this,r=t.makeSurrogateResource(n),i=[],u;return n.forEachAssignment(function(n){var u=n.getTask();u&&!u.isUnscheduled()&&(r.appendChild(t.makeSurrogateAssignment(n)),i.push(t.makeSurrogateAssignmentEvent(n)))}),i.length>0&&(u=t.makeSurrogateAssignmentEvent(n),i.push(u)),{resource:r,events:i}},fillStore:function(){var n=this,t=n.getRoot(),r=n.getResourceStore(),u=n.getEventStore(),f=r&&r.getRange(),e=[],i=[];n.syncingWithOriginal=!0;t.removeAll();u.removeAll();f&&Ext.Array.each(f,function(t){var r=n.makeSurrogateResourceBranch(t);e.push(r.resource);i=i.concat(r.events)});u.add(i);t.appendChild(e);n.sorters&&n.sorters.getCount()&&t.sort();n.syncingWithOriginal=!1},diffSyncStore:function(){var n=this,t;n.syncingWithOriginal=!0;n.fireEvent("sync-start",n);n.suspendEvents();t=new n.self({underUtilizationThreshold:n.getUnderUtilizationThreshold(),overUtilizationThreshold:n.getOverUtilizationThreshold()});t.suspendEvents();t.setTimeAxis(n.getTimeAxis());t.setTaskStore(n.getTaskStore());t.fillStore();n.removeOutdatedSurrogateAssignments(n,t);n.removeOutdatedSurrogateResources(n,t);n.addNewSurrogateResources(n,t);n.addNewSurrogateAssignments(n,t);n.updatePresentSurrogates(n,t);n.rearrangePresentSurrogates(n,t);n.utilizationInfoCache=t.utilizationInfoCache;Ext.destroy(t);n.resumeEvents();n.fireEvent("sync-complete",n);n.fireEvent("refresh",n);n.syncingWithOriginal=!1},removeOutdatedSurrogateAssignments:function(n,t){var u=n.getRoot(),r=[],i=[];u.cascadeBy(function(n){var u=t.getModelById(n.getId());!n.isRoot()&&n.isSurrogateAssignment()?u&&u.parentNode.getId()==n.parentNode.getId()||(r.push(n),i=i.concat(n.getEvents())):!n.isRoot()&&n.isSurrogateResource()&&(i=i.concat(Ext.Array.filter(n.getEvents(),function(n){return n.isSurrogateAssignment()||u&&u.childNodes.length===0})))});n.getEventStore().remove(i);Ext.Array.each(r,function(n){n.remove()})},removeOutdatedSurrogateResources:function(n,t){var u=n.getRoot(),r=[],i=[];u.cascadeBy(function(n){var u;!n.isRoot()&&n.isSurrogateResource()&&(u=t.getModelById(n.getId()),u||(r.push(n),i=i.concat(n.getEvents())))});n.getEventStore().remove(i);Ext.Array.each(r,function(n){n.remove()})},addNewSurrogateResources:function(n,t){var r=t.getRoot(),u=n.getRoot(),f=n.getEventStore(),i=[];r.cascadeBy(function(t){var r;!t.isRoot()&&t.isSurrogateResource()&&(r=n.getModelById(t.getId()),r||(u.insertChild(t.get("index"),n.makeSurrogateResource(t.getOriginalResource())),i.push(n.makeSurrogateAssignmentEvent(t.getOriginalResource()))))});f.add(i)},addNewSurrogateAssignments:function(n,t){var r=t.getRoot(),u=n.getEventStore(),i=[];r.cascadeBy(function(t){var u,f,r;!t.isRoot()&&t.isSurrogateAssignment()&&(u=n.getModelById(t.getId()),u||(f=t.parentNode,r=n.getModelById(f.getId()),r&&(r.insertChild(t.get("index"),n.makeSurrogateAssignment(t.getOriginalAssignment())),i=i.concat(Ext.Array.map(t.getEvents(),function(n){return n.clone()})))))});u.add(i)},updatePresentSurrogates:function(n,t){var i=n.getRoot();i.cascadeBy(function(i){var r,u,f;i.isRoot()||(r=t.getModelById(i.getId()),r&&(i.isInSyncWithSurrogate(r)||i.syncFromSurrogate(r),u=r.getEvents()[0],u?(f=n.getEventStore().getModelById(u.getId()),f&&!f.isInSyncWithSurrogate(u)&&f.syncFromSurrogate(u)):i.syncFromOriginal(r)))})},rearrangePresentSurrogates:function(n,t){var i=t.getRoot();i.cascadeBy(function(t){var i;t.isRoot()||(i=n.getModelById(t.getId()),i&&i.get("index")!=t.get("index")&&i.parentNode.insertChild(t.get("index"),i))})},clearUtilizationInfoCache:function(){this.utilizationInfoCache={}},getModelByOriginal:function(n){var t=this;return t.getModelById(t.model.getSurrogateIdFor(n))},onSourceDataTouch:Ext.Function.createBuffered(function(){var n=this;n.isDestroyed||(n.clearUtilizationInfoCache(),n.diffSyncStore())},10),onUtilizationEventStoreUpdate:function(n,t,i,r){var u=this,f;u.syncingWithOriginal||(t.isInSyncWithOriginal()||t.syncToOriginal(),Ext.Array.contains(r,t.resourceIdField)&&(f=t.getResource(),Ext.Function.defer(function(){u.fireEvent("reassign",u,f.getOriginalResource(),f.getOriginalTask(),t.getOriginalResource(),t.getOriginalTask(),t.getOriginalAssignment())},1)))}});Ext.define("Gnt.data.util.IdConsistencyManager",{extend:Sch.data.util.IdConsistencyManager,config:{dependencyStore:null},onEventIdChanged:function(n,t,i,r){var u=this,f=u.getDependencyStore(),e;if(u.callParent([n,t,i,r]),f){e=u.getUpdateDependencyFromToFieldsFn(f,i,r);n.on("update",e,null,{single:!0,priority:200})}},getUpdateDependencyFromToFieldsFn:function(n,t,i){var r=n.getRange();return function(){Ext.Array.each(r,function(n){n.getFrom()==t?n.setFrom(i):n.getTo()==t&&n.setTo(i)})}}});Ext.define("Gnt.data.util.ModelPersistencyManager",{extend:Sch.data.util.ModelPersistencyManager,config:{dependencyStore:null},dependencyStoreDetacher:null,updateDependencyStore:function(n){var t=this;Ext.destroyMembers(t,"dependencyStoreDetacher");n&&n.autoSync&&(t.dependencyStoreDetacher=n.on({beforesync:t.onDependencyStoreBeforeSync,scope:t,destroyable:!0,priority:100}))},onDependencyStoreBeforeSync:function(n){var t=this;return t.removeNonPersistableRecordsToCreate(n),t.shallContinueSync(n)}});Ext.define("Gnt.model.mixin.ProjectableModel",function(){function t(){Ext.override(this,n)}function i(n){return this.data[n]}function r(){var n=this,t=n.getTreeStore&&n.getTreeStore()||n.store,i=t&&t.getProjection&&t.getProjection();return i&&i.hasOwnProperty(n.internalId)?!0:!1}var n={};return n.get=function(n){var t=this,i=t.getTreeStore&&t.getTreeStore()||t.store,r=i&&i.getProjection&&i.getProjection(),e=t.internalId,u,f;return r&&r.hasOwnProperty(e)?(u=r[e],f=n in u?u[n]:t.callParent([n])):f=t.callParent([n]),f},n.set=function(n,t){var u=this,l=u.getTreeStore&&u.getTreeStore()||u.store,f=l&&l.getProjection&&l.getProjection(),e=u.internalId,c,o,h,i,s,r;if(f)if(h=[],arguments.length==1)for(o in n)n.hasOwnProperty(o)&&(t=n[o],i=u.get(o),r=t!==undefined&&t!==null?t.valueOf():t,s=i!==undefined&&i!==null?i.valueOf():i,((r===undefined||r===null)&&r!==s||r!=s)&&(c=f[e]=f.hasOwnProperty(e)&&f[e]||{},c[o]=t,h.push(o)));else arguments.length>1&&(i=u.get(n),r=t!==undefined&&t!==null?t.valueOf():t,s=i!==undefined&&i!==null?i.valueOf():i,((r===undefined||r===null)&&r!==s||r!=s)&&(c=f[e]=f.hasOwnProperty(e)&&f[e]||{},c[n]=t,h.push(n)));else h=u.callParent(arguments);return h},{initProjectable:t,getUnprojected:i,isProjected:r}});Ext.define("Gnt.model.task.More",{propagating:!1,indent:function(n){var t=this,r=t.previousSibling,i;r?t.propagateChanges(function(){return t.indentWithoutPropagation(function(n){i=n})},function(t,u){t?i&&i():r.expand();n&&n(t,u)}):n&&n(!1,{})},indentWithoutPropagation:function(n){var t=this,i=t.previousSibling,r,u,o,f,e,s;return s={parentNode:t.parentNode,previousSibling:t.previousSibling,nextSibling:t.nextSibling},r=t.getTaskStore(),r.beginIndent(t),u=t.parentNode,o=u.indexOf(t),f=i.get("leaf"),f&&(e=i.getSegments(),i.markAsParent()),i.appendChild(t),t.getParentsIncomingDependencies().length&&t.alignByIncomingDependenciesWithoutPropagation(),t.removeContext=s,r.endIndent(t),n&&n(function(){u.insertChild(o,t);f&&(i.set("leaf",!0),e&&i.setSegmentsWithoutPropagation(e))}),t},outdent:function(n){var t=this,r=t.parentNode,i;r&&!r.isRoot()?t.propagateChanges(function(){return t.outdentWithoutPropagation(function(n){i=n})},function(t,r){t&&i&&i();n&&n(t,r)}):n&&n(!1,{})},outdentWithoutPropagation:function(n){var t=this,i,u,r,f;return f={parentNode:t.parentNode,previousSibling:t.previousSibling,nextSibling:t.nextSibling},r=t.getTaskStore(),r.beginIndent(t),i=t.parentNode,u=i.indexOf(t),i.nextSibling?i.parentNode.insertBefore(t,i.nextSibling):i.parentNode.appendChild(t),t.removeContext=f,r.endIndent(t),n&&n(function(){i.insertChild(u,t)}),i},removeInvalidDependencies:function(){for(var i=this.getDependencyStore(),t=this.getAllDependencies(),n=0;n<t.length;n++)t[n].isValid()||i.remove(t[n])},removeDependenciesToParents:function(n){var t=this,i=t.getSuccessors().concat(t.getPredecessors());n.bubble(function(n){Ext.Array.indexOf(i,n)>=0&&t.removeLinkToTask(n)})},hasDependencies:function(){return this.hasIncomingDependencies()||this.hasOutgoingDependencies()},getAllDependencies:function(){return this.predecessors.concat(this.successors)},hasIncomingDependencies:function(){return this.predecessors.length>0},hasOutgoingDependencies:function(){return this.successors.length>0},getIncomingDependencies:function(n){return n?this.predecessors:this.predecessors.slice()},getParentsIncomingDependencies:function(n){for(var t=this.parentNode,i=[],r;t;)r=n?Ext.Array.filter(t.getIncomingDependencies(),function(t){var i=t.getSourceTask();return i&&i.isAncestor(n)}):t.getIncomingDependencies(),i=i.concat(r),t=t.parentNode;return i},getOutgoingDependencies:function(n){return n?this.successors:this.successors.slice()},alignByIncomingDependencies:function(n,t,i){var r=this.alignByIncomingDependenciesWithoutPropagation(n,t);return this.propagateChanges(null,i,!0),r},alignByIncomingDependenciesWithoutPropagation:function(n,t,i){var r,u,f,e;return this.isManuallyScheduled()||this.isReadOnly()?!1:(r=!1,n=n||this.getTaskStore(),u=this.getIncomingDependenciesConstraintContext(n,i),u&&(f=u.startDate,e=u.endDate,f&&f-this.getStartDate()!=0?(t&&t.addAffected(this),this.setStartDateWithoutPropagation(f,!0,n.skipWeekendsDuringDragDrop),r=!0):e&&e-this.getEndDate()!=0&&(t&&t.addAffected(this),this.setEndDateWithoutPropagation(e,!0,n.skipWeekendsDuringDragDrop),r=!0)),r)},getDependencyCalendar:function(n,t,i){t||(t=(i||this.getTaskStore()).dependenciesCalendar);var u=this.getProjectCalendar(),f=n.getSourceTask(i),e=n.getTargetTask(i),r;switch(t){case"project":r=u;break;case"source":r=f.getCalendar();break;case"target":r=e.getCalendar();break;default:throw"Unsupported value for `dependenciesCalendar` config option";}return r},getIncomingDependenciesConstraintContext:function(n,t){var c=this,h=this.getIncomingDependencies(!0).concat(this.getParentsIncomingDependencies(t)),u,o;if(!h.length||this.isUnscheduled())return null;var f=Gnt.model.Dependency.Type,i=new Date(0),r=new Date(0),s,e,l=(n||this.getTaskStore()).dependenciesCalendar;return Ext.Array.each(h,function(u){var o=u.getSourceTask(n);if(o&&(!t||o.isAncestor(t))){var v=c.getDependencyCalendar(u,l,n),y=u.getLag()||0,p=u.getLagUnit(),h=o.getStartDate(),a=o.getEndDate();switch(u.getType()){case f.StartToEnd:h=v.skipWorkingTime(h,y,p);r<h&&(r=h,e=o);break;case f.StartToStart:h=v.skipWorkingTime(h,y,p);i<h&&(i=h,s=o);break;case f.EndToStart:a=v.skipWorkingTime(a,y,p);i<a&&(i=a,s=o);break;case f.EndToEnd:a=v.skipWorkingTime(a,y,p);r<a&&(r=a,e=o);break;default:throw"Invalid dependency type: "+u.getType();}}}),u={startDate:i>0?i:null,endDate:r>0?r:null,constrainingTask:s||e},i&&r&&(o=this.calculateStartDate(r,this.getDuration()),o>i&&(u.startDate=o,u.constrainingTask=e),u.endDate=null),u},getCriticalPaths:function(){for(var t=[this],n=this.getIncomingDependenciesConstraintContext();n;)t.push(n.constrainingTask),n=n.constrainingTask.getIncomingDependenciesConstraintContext();return t},addSubtask:function(n,t){var r=this,u,i;return r.propagateChanges(function(){return r.addSubtaskWithoutPropagation(n,function(n,t){i=n;u=t})},function(n,r){n&&i&&i();t&&t(n,r)}),u},addSubtaskWithoutPropagation:function(n,t){var i=this,r,o,f,u,e;return r=n.parentNode,o=r&&r.indexOf(i),u=i.get("leaf"),u&&(i.markAsParent(),e=i.getSegments()),n=i.appendChild(n),i.expand(),t&&t(function(){r?r.insertChild(o,n):i.removeChild(n);u&&i.set("leaf",!0);u&&e&&i.setSegmentsWithoutPropagation(e)},n),r?i!==r&&i.getTaskStore(!0)===r.getTaskStore(!0)&&(f=[n,r]):f=n,f},insertSubtask:function(n,t,i){var u=this,f,r;return u.propagateChanges(function(){return u.insertSubtaskWithoutPropagation(n,t,function(n,t){r=n;f=t})},function(n,t){n&&r&&r();i&&i(n,t)}),f},insertSubtaskWithoutPropagation:function(n,t,i){var r=this,u,s,e,f,o;return u=t.parentNode,s=u&&u.indexOf(r),f=r.get("leaf"),f&&(r.markAsParent(),o=r.getSegments()),t=r.insertChild(n,t),r.expand(),i&&i(function(){u?u.insertChild(s,t):r.removeChild(t);f&&r.set("leaf",!0);f&&o&&r.setSegmentsWithoutPropagation(o)},t),u?r!==u&&r.getTaskStore(!0)===u.getTaskStore(!0)&&(e=[t,u]):e=t,e},removeSubtask:function(n,t){var i=this,r;i.indexOf(n)!==-1?i.propagateChanges(function(){return i.removeSubtaskWithoutPropagation(n,function(n){r=n})},function(n,i){n&&r&&r();t&&t(n,i)}):t&&t(!1,{})},removeSubtaskWithoutPropagation:function(n,t){var o=this,v=o.indexOf(n),h,r,f,u,e,c,l,i,s,a;for(v!=-1||Ext.Error.raise("Can't remove subtask `"+n.getId()+"` from task `"+o.getId()+"` subtask is not a child of the task!"),r=o.getDependencyStore(),f=o.getAssignmentStore(),u=r&&r.getDependenciesForTask(n),e=f&&n.getAssignments(),h=[],c=[],l=[],n.cascadeBy(function(n){h.push(n)}),i=0,s=h.length;(r||f)&&i<s;i++)a=h[i],r&&(u=u.concat(r.getDependenciesForTask(a))),f&&(e=e.concat(a.getAssignments()));for(u=r&&Ext.Array.unique(u),u=r&&Ext.Array.sort(u,function(n,t){return r.indexOf(n)<r.indexOf(t)?-1:1}),i=0,s=u&&u.length;r&&i<s;i++)c.push(r.indexOf(u[i]));for(e=f&&Ext.Array.sort(e,function(n,t){return f.indexOf(n)<f.indexOf(t)?-1:1}),i=0,s=e&&e.length;f&&i<s;i++)l.push(f.indexOf(e[i]));return n=o.removeChild(n),f&&f.remove(e),r&&r.remove(u),o.childNodes.length===0&&o.convertEmptyParentToLeaf&&o.set("leaf",!0),t&&t(function(){for(o.insertChild(v,n),i=0,s=e&&e.length;f&&i<s;i++)f.insert(l[i],e[i]);for(i=0,s=u&&u.length;r&&i<s;i++)r.insert(c[i],u[i])}),o},addSuccessor:function(n,t){var r=this,u,i;return r.propagateChanges(function(){return r.addSuccessorWithoutPropagation(n,function(n,t){i=n;u=t})},function(n,r){n&&i&&i();t&&t(n,r)}),u},addSuccessorWithoutPropagation:function(n,t){var i=this,r=i.parentNode,e=r.indexOf(i),u,f;return n=n||new i.self,n.calendar=n.calendar||i.getCalendar(),n.taskStore=n.taskStore||i.getTaskStore(!0),i.getEndDate()&&(n.beginEdit(),n.set(i.startDateField,i.getEndDate()),n.set(i.endDateField,n.calculateEndDate(i.getEndDate(),1,Sch.util.Date.DAY)),n.set(i.durationField,1),n.set(i.durationUnitField,Sch.util.Date.DAY),n.endEdit()),r.insertSubtaskWithoutPropagation(e+1,n,function(t,i){u=t;n=i}),i.linkToWithoutPropagation(n,Gnt.model.Dependency.Type.EndToStart,function(n){f=n}),t&&t(function(){f();u()},n),i},addMilestone:function(n,t){var i=this,r=i.getEndDate();return n?!Ext.isObject(n)||n instanceof Gnt.model.Task||(n=new i.self(n)):n=new i.self,r&&!n.isMilestone()&&(n.calendar=n.calendar||i.getCalendar(),n.setStartEndDate(r,r)),i.addTaskBelow(n,t)},addPredecessor:function(n,t){var i=this,r,u;return i.propagateChanges(function(){return i.addPredecessorWithoutPropagation(n,function(n,t){u=n;r=t})},function(n,i){n&&u();t&&t(n,i)}),r},addPredecessorWithoutPropagation:function(n,t){var i=this,r=i.parentNode,e=r.indexOf(i),u,f;return n=n||new i.self,n.calendar=n.calendar||i.getCalendar(),n.taskStore=n.taskStore||i.getTaskStore(!0),i.getStartDate()&&(n.beginEdit(),n.set(i.startDateField,n.calculateStartDate(i.getStartDate(),1,Sch.util.Date.DAY)),n.set(i.endDateField,i.getStartDate()),n.set(i.durationField,1),n.set(i.durationUnitField,Sch.util.Date.DAY),n.endEdit()),r.insertSubtaskWithoutPropagation(e,n,function(t,i){u=t;n=i}),n.linkToWithoutPropagation(i,Gnt.model.Dependency.Type.EndToStart,function(n){f=n}),t&&t(function(){f();u()},n),n},getSuccessors:function(){for(var n,i=this.successors,r=[],t=0,u=i.length;t<u;t++)n=i[t].getTargetTask(),n&&r.push(n);return r},getPredecessors:function(){for(var n,i=this.predecessors,r=[],t=0,u=i.length;t<u;t++)n=i[t].getSourceTask(),n&&r.push(n);return r},addTaskAbove:function(n,t){var i=this,r=i.parentNode,e=r.indexOf(i),u,f;return n=n||new i.self,i.propagateChanges(function(){return r.insertSubtaskWithoutPropagation(e,n,function(n,t){f=n;u=t})},function(n,i){n&&f();t&&t(n,i)}),u},addTaskBelow:function(n,t){var i=this,r=i.parentNode,e=r.indexOf(i)+1,u,f;return n=n||new i.self,i.propagateChanges(function(){return r.insertSubtaskWithoutPropagation(e,n,function(n,t){f=n;u=t})},function(n,i){n&&f();t&&t(n,i)}),u},isAbove:function(n){for(var i=this,r=Math.min(i.data.depth,n.data.depth),t=this;t.data.depth>r;)if(t=t.parentNode,t==n)return!1;while(n.data.depth>r)if(n=n.parentNode,n==i)return!0;while(n.parentNode!==t.parentNode)n=n.parentNode,t=t.parentNode;return n.data.index>t.data.index},cascadeChildren:function(n,t){var f=this,r,i,u;if(!f.isLeaf())for(r=this.childNodes,i=0,u=r.length;i<u;i++)r[i].cascadeBy(n,t)},getSlack:function(n){n=n||Sch.util.Date.DAY;var t=this.getEarlyStartDate(),i=this.getLateStartDate();return!t||!i?null:this.getCalendar().calculateDuration(t,i,n)},getEarlyStartDate:function(){var r=this.getTaskStore(!0),u,n,t,i,s,h,f,c,l;if(!r)return this.getStartDate();if(u=this.internalId,r.earlyStartDates[u])return r.earlyStartDates[u];if(t=0,this.childNodes.length){for(i=0,s=this.childNodes.length;i<s;i++)n=this.childNodes[i].getEarlyStartDate(),(n<t||!t)&&(t=n);return r.earlyStartDates[u]=t,t}if(this.isManuallyScheduled()||(h=this.getIncomingDependencies(!0),!h.length))return r.earlyStartDates[u]=this.getStartDate();for(f=Gnt.model.Dependency.Type,c=this.getCalendar(),i=0,s=h.length;i<s;i++){var e=h[i],o=e.getSourceTask(),a=this.getDependencyCalendar(e);if(o){switch(e.getType()){case f.StartToStart:n=o.getEarlyStartDate();break;case f.StartToEnd:n=o.getEarlyStartDate();n=c.calculateStartDate(n,this.getDuration(),this.getDurationUnit());break;case f.EndToStart:n=o.getEarlyEndDate();break;case f.EndToEnd:n=o.getEarlyEndDate();n=c.calculateStartDate(n,this.getDuration(),this.getDurationUnit())}l=e.getLag();n&&l&&(n=a.skipWorkingTime(n,l,e.getLagUnit()));n&&(n=c.skipNonWorkingTime(n,!0))}n>t&&(t=n)}return r.earlyStartDates[u]=t,t},getEarlyEndDate:function(){var n=this.getTaskStore(!0),t,i,u,r,e,f;if(!n)return this.getEndDate();if(t=this.internalId,n.earlyEndDates[t])return n.earlyEndDates[t];if(i=0,this.childNodes.length){for(r=0,e=this.childNodes.length;r<e;r++)u=this.childNodes[r].getEarlyEndDate(),u>i&&(i=u);return n.earlyEndDates[t]=i,i}return this.isManuallyScheduled()?n.earlyEndDates[t]=this.getEndDate():(f=this.getEarlyStartDate(),!f)?null:n.earlyEndDates[t]=this.getCalendar().calculateEndDate(f,this.getDuration(),this.getDurationUnit())},getLateEndDate:function(){var t=this.getTaskStore(!0),r,n,i,u,s,h,f,c,l;if(!t)return this.getEndDate();if(r=this.internalId,t.lateEndDates[r])return t.lateEndDates[r];if(i=0,this.childNodes.length){for(u=0,s=this.childNodes.length;u<s;u++)n=this.childNodes[u].getLateEndDate(),n>i&&(i=n);return t.lateEndDates[r]=i,i}if(this.isManuallyScheduled())return t.lateEndDates[r]=this.getEndDate();if(h=this.getOutgoingDependencies(!0),!h.length)return t.lateEndDates[r]=t.getProjectEndDate();for(f=Gnt.model.Dependency.Type,c=this.getCalendar(),u=0,s=h.length;u<s;u++){var e=h[u],o=e.getTargetTask(),a=this.getDependencyCalendar(e);if(o){switch(e.getType()){case f.StartToStart:n=o.getLateStartDate();n=c.calculateEndDate(n,this.getDuration(),this.getDurationUnit());break;case f.StartToEnd:n=o.getLateEndDate();n=c.calculateEndDate(n,this.getDuration(),this.getDurationUnit());break;case f.EndToStart:n=o.getLateStartDate();break;case f.EndToEnd:n=o.getLateEndDate()}l=e.getLag();l&&(n=a.skipWorkingTime(n,-l,e.getLagUnit()));n=c.skipNonWorkingTime(n,!1);(n<i||!i)&&(i=n)}}return t.lateEndDates[r]=i||t.getProjectEndDate(),t.lateEndDates[r]},getLateStartDate:function(){var n=this.getTaskStore(!0),t,i,u,r,e,f;if(!n)return this.getStartDate();if(t=this.internalId,n.lateStartDates[t])return n.lateStartDates[t];if(this.childNodes.length){for(r=0,e=this.childNodes.length;r<e;r++)u=this.childNodes[r].getLateStartDate(),(u<i||!i)&&(i=u);return n.lateStartDates[t]=i,i}return this.isManuallyScheduled()?n.lateStartDates[t]=this.getStartDate():(f=this.getLateEndDate(),!f)?null:n.lateStartDates[t]=this.getCalendar().calculateStartDate(f,this.getDuration(),this.getDurationUnit())},getTopParent:function(n){for(var u=this.getTaskStore().getRoot(),t=this,i=[this],r;t;){if(t===u)return n?i:r;i.push(t);r=t;t=t.parentNode}},getInDepthWalker:function(n){var t=n?this:this.childNodes&&this.childNodes[0],r=this,i={},u=function(n){var t=n,f=t.internalId;if(t.isLeaf()||!t.childNodes.length?t=t.nextSibling:i[f]===!0?(i[f]=!1,t=t.nextSibling):(i[f]=!0,t=t.childNodes[0]),!t){t=n;do if(t===r||(t=t.parentNode,t===r))return null;while(i[t.internalId]===!1);return u(t)}return t};return function(){var n=t;return t&&(t=u(t)),n}},propagateChanges:function(n,t,i){var u=this,f,e,r,o;if(!n||Ext.isFunction(n)||Ext.Error.raise("Can't propagate changes to a task, invalid changer function given"),!t||Ext.isFunction(t)||Ext.Error.raise("Can't propagate changes to a task, invalid callback function given"),r=u.getTaskStore(!0),i=arguments.length==3?i:r&&r.cascadeChanges,!u.propagating&&r){u.propagating=!0;e={};r.suspendAutoSync();o=r.startBatchCascade();r.startProjection();try{f=n&&n!==Ext.emptyFn?n(u):[u]}catch(s){r.rejectProjection();r.endBatchCascade();r.resumeAutoSync(r.autoSync);u.propagating=!1;throw s;}f===!0?f=u.isProjected()&&[u]||!1:f&&(f=[].concat(f));f?u.propagateChangesThroughDependentTasks(r.getLinearWalkingSequenceForDependentTasks(f,{self:!0,ancestors:r.recalculateParents,descendants:r.moveParentAsGroup,successors:i,cycles:r.cycleResolutionStrategy}),r,o,f,i,e,function(n,i){n?(r.rejectProjection(),i={}):r.commitProjection();r.endBatchCascade();u.propagating=!1;t&&t(n,i);r.resumeAutoSync(r.autoSync&&!n&&!Ext.Object.isEmpty(i))}):(r.rejectProjection(),r.endBatchCascade(),u.propagating=!1,t&&t(!1,{}),r.resumeAutoSync(r.autoSync))}else if(u.propagating)t&&t(!0,{});else{u.propagating=!0;try{n&&n(u)}catch(s){u.propagating=!1;throw s;}u.verifyConstraint(function(n,i){e={};i=!!i;i||(e[u.getId()]=u);u.propagating=!1;t&&t(i,e)})}},propagateChangesThroughDependentTasks:function(n,t,i,r,u,f,e,o){var l=this,s,h,c;for(o=o||0,c=!0,s=o,h=n.length;c&&s<h;++s)c=l.processTaskConstraints(n,s,t,i,r,u,f,function(f,o,s,c){s||f==h-1?e(s,c):o||l.propagateChangesThroughDependentTasks(n,t,i,r,u,c,e,f+1)})},processTaskConstraints:function(n,t,i,r,u,f,e,o){function b(n,t,i){for(var e=n.getIncomingDependencies(!0),u=!1,o,r,f=0,s=e.length;!u&&f<s;++f)o=e[f],r=o.getSourceTask(),u=r&&t.hasOwnProperty(r.getId())||Ext.Array.contains(i,r);return u}var rt=this,k=n[t],s=k[0],c=k[1],l=s.hasChildNodes(),d=!l,a=!(s.isManuallyScheduled()||s.isReadOnly()||Ext.Array.contains(u,s)),g=f||i.cascadeChanges,it=i.recalculateParents,nt=i.moveParentAsGroup,h=s.parentNode,v=h&&h.getStartDate(),y=h&&h.getUnprojected(h.startDateField),tt=h&&v-y,p,w;switch(!0){case a&&d&&c=="green"&&tt&&nt:case a&&l&&c=="yellow"&&tt&&nt:v&&(w=s.getStartDate(),w>=y?(p=s.calculateDuration(y,w,null,{segments:!1}),s.setStartDateWithoutPropagation(s.calculateEndDate(v,p,null,{segments:!1}),!0,i.skipWeekendsDuringDragDrop)):(p=s.calculateDuration(w,y,null,{segments:!1}),s.setStartDateWithoutPropagation(s.calculateStartDate(v,p,null,{segments:!1}),!0,i.skipWeekendsDuringDragDrop)),b(s,e,u)&&s.alignByIncomingDependenciesWithoutPropagation(i,null,h));break;case a&&d&&c=="green"&&g:case a&&l&&c=="yellow"&&g:b(s,e,u)&&s.alignByIncomingDependenciesWithoutPropagation(i,null);break;case l&&c=="green"&&it:s.refreshCalculatedParentNodeData()}return s.isProjected()&&(r.addAffected(s),e[s.getId()]=s),s.verifyConstraint(function(r,u){var h,f;!r&&l&&a&&i.recalculateParents&&c=="green"?(h=Ext.Array.findBy(n,function(n,t){var i=n[0],r=n[1];return f=t,s===i&&r=="yellow"}),o(f,r,!!u,e)):o(t,r,!!u,e)})},removeLinkToTask:function(n){var r=this.getDependencyStore(),t=this.getId(),i=n.getId();Ext.Array.each(this.getAllDependencies(),function(n){if(n.getSourceId()===t&&n.getTargetId()===i||n.getSourceId()===i&&n.getTargetId()===t)return r.remove(n),!1})},convertEmptyParentToLeafTask:function(){this.beginEdit();this.set("leaf",!0);this.setDurationWithoutPropagation(1,Sch.util.Date.DAY);this.endEdit()},hasEndPredecessorsButNoStartPredecessors:function(){var n=this.getIncomingDependencies(),t=n.length>0,i=Gnt.model.Dependency.Type;return Ext.Array.each(n,function(n){if(n.getType()===i.StartToStart||n.getType()===i.EndToStart)return t=!1}),t},isCompleted:function(){return this.getPercentDone()>=100}});Ext.define("Gnt.model.task.Constraints",{setConstraint:function(n,t,i){function r(){return u.setConstraintWithoutPropagation(n,t)}var u=this;n?u.propagateChanges(r,i):(r(),i&&i(!1,{}))},setConstraintWithoutPropagation:function(n,t){var i=this,r;return n&&(r=Gnt.constraint.Base.getConstraintClass(n)),!t&&r&&(t=r.getInitialConstraintDate(i)),i.beginEdit(),i.set(i.constraintTypeField,n||""),i.set(i.constraintDateField,t),i.endEdit(),!0},setConstraintType:function(n,t){this.setConstraint(n,this.getConstraintDate(),t)},setConstraintTypeWithoutPropagation:function(n,t){this.setConstraintWithoutPropagation(n,this.getConstraintDate(),t)},setConstraintDate:function(n,t){this.setConstraint(this.getConstraintType(),n,t)},setConstraintDateWithoutPropagation:function(n){this.setConstraintWithoutPropagation(this.getConstraintType(),n)},hasConstraint:function(){return!!this.getConstraintType()},getConstraintClass:function(){return Gnt.constraint.Base.getConstraintClass(this.getConstraintType())},isConstraintSatisfied:function(){var n=this;return!n.hasConstraint()||n.getConstraintClass().isSatisfied(n,n.getConstraintDate())},verifyConstraint:function(n){var r=this,t,f,u,i,e;return!n||Ext.isFunction(n)||Ext.Error.raise("Can't verify task's constraint, resultion callback is invalid!"),i=r.isConstraintSatisfied(),n=n&&Ext.Function.pass(n,[i]),t=r.getTaskStore(!0),e=t&&t.hasListener("constraintconflict"),f=t&&t.constraintDatePrecision||Sch.util.Date.DAY,u=!i&&r.getConstraintClass().getResolution(n,r,null,f),!i&&t&&e?t.fireEvent("constraintconflict",r,u):i?n&&n(!1):u.cancelAction(),i},getWorkingTimeStartForDate:function(n){var u=this,i=!1,t,r;return n instanceof Date||Ext.Error.raise("Can't get working time start for a date, invalid date given!"),t=Ext.Date.clearTime(n,!0),r=Sch.util.Date.add(t,Sch.util.Date.DAY,1),u.forEachAvailabilityInterval({isForward:!0,startDate:t,endDate:r,segments:!1,resources:!0,fn:function(n){return i=new Date(n),!1}}),i},getWorkingTimeEndForDate:function(n){var u=this,i=!1,t,r;return n instanceof Date||Ext.Error.raise("Can't get working time end for a date, invalid date given!"),t=Ext.Date.clearTime(n,!0),r=Sch.util.Date.add(t,Sch.util.Date.DAY,1),u.forEachAvailabilityInterval({isForward:!1,startDate:t,endDate:r,segments:!1,resources:!0,fn:function(n,t){return i=new Date(t),!1}}),i},getNearestWorkingTimeStartForDate:function(n,t,i){var u=this,f,r;for(n instanceof Date||Ext.Error.raise("Can't get nearest working time start for a date, invalid date given!"),t=t||!1,i=i||365,f=t?-1:1,r=u.getWorkingTimeStartForDate(n);!r&&i--;)n=Sch.util.Date.add(n,Sch.util.Date.DAY,f),r=u.getWorkingTimeStartForDate(n);return r},getNearestWorkingTimeEndForDate:function(n,t,i){var u=this,f,r;for(n instanceof Date||Ext.Error.raise("Can't get nearest working time end for a date, invalid date given!"),t=t||!1,i=i||365,f=t?-1:1,r=u.getWorkingTimeEndForDate(n);!r&&i--;)n=Sch.util.Date.add(n,Sch.util.Date.DAY,f),r=u.getWorkingTimeEndForDate(n);return r},getWorkingTimeIntervalForDateTime:function(n){var u=this,t=!1,i,r;return n instanceof Date||Ext.Error.raise("Can't get task's working time intarval for a datetime, invalid datetime given!"),i=Ext.Date.clearTime(n,!0),r=Sch.util.Date.add(i,Sch.util.Date.DAY,1),n=n.valueOf(),u.forEachAvailabilityInterval({isForward:!0,startDate:i,endDate:r,segments:!1,resources:!0,fn:function(i,r){return i<=n&&n<=r&&(t={startDate:new Date(i),endDate:new Date(r)}),!t}}),t},isDateTimeWithinWorkingTimeInterval:function(n){var t=this;return n instanceof Date||Ext.Error.raise("Can't check if datetime is within working time intarval for a task, invalid datetime given!"),t.getWorkingTimeIntervalForDateTime(n)!==!1}});Ext.define("Gnt.model.task.Splittable",{segmentsTrackingSuspended:0,changingTaskBySegments:!1,segmentsSnapshot:null,segmentsProjection:null,getFirstSegment:function(){var n=this.getSegments();return n&&n[0]},getLastSegment:function(){var n=this.getSegments();return n&&n[n.length-1]},normalizeSegments:function(){var n=this.getSegments();this.suspendSegmentsTracking();n.sort(function(n,t){return n.normalized||n.normalize(),t.normalized||t.normalize(),n.getStartDate()>t.getStartDate()?1:-1});this.mergeOverlappedSegments();(n=this.getSegments())&&(this.data[this.durationField]=this.getSegmentsDuration());this.resumeSegmentsTracking()},updateSegmentsDates:function(n){if(n=n||{},this.isSegmented()){this.suspendSegmentsTracking();n=Ext.apply({useAbsoluteOffset:!1},n);n.isForward=n.isForward!==!1;var t=!1;this.forEachSegment(function(i){i.updateDatesByOffsets(n);t=t||Boolean(i.modified)},n.isForward);t&&this.set(this.segmentsField,this.getSegments().slice());this.resumeSegmentsTracking()}},getSegmentIntervalsForRange:function(n,t,i){var r,u,f,e;if(i=i||this.getSegments(),i){for(r=Sch.util.Date,u=[],f=0,e=i.length;f<e;f++){var o=i[f],s=o.getStartDate(),h=o.getEndDate();r.intersectSpans(n,t,s,h)&&u.push([r.constrain(s,n,t)-0,r.constrain(h,n,t)-0])}return u.length&&u||null}},getSegmentByDate:function(n,t){var i,u,r;if(t=t||this.getSegments(),t)for(i=0,u=t.length;i<u;i++)if(r=t[i],n>=r.getStartDate()&&n<r.getEndDate())return r},constrainSegments:function(n){var i,u,f,s,w,l,e,a,r,h,c,v;if(!this.changingTaskBySegments&&(n=n||{},i=this.getSegments(),i)){var y=this.getDuration("MILLI"),b=n.unit||this.getDurationUnit(),t=n.duration,k=this.getStartDate(),o=this.getEndDate(),p=this.getUnitConverter();if(!k||!o&&!y&&!t){this.set(this.segmentsField,null);return}for(t?t=p.convertDurationToMs(t,b):o||(t=y),this.suspendSegmentsTracking(),i[0].setStartDateWithoutPropagation(this.getStartDate(),!1),u=[],f=t,l=t?function(){return f<=0}:function(n){return n.getStartDate()>=o},e=0,a=i.length;e<a;e++){if(s=i[e],l(s)){u.push.apply(u,i.slice(e));break}f-=s.getDuration("MILLI");w=s}this.removeSegments(u);i.length<2?this.set(this.segmentsField,null):(r=this.getLastSegment(),h=!1,t?f&&(r.setDurationWithoutPropagation(p.convertMSDurationToUnit(r.getEndOffset()-r.getStartOffset()+f,r.getDurationUnit())),h=!0):r.getEndDate()-o&&(r.setEndDateWithoutPropagation(o,!1),h=!0),c=this.getTaskStore(!0),v=c&&c.isProjecting(),(u.length||h)&&(v||!this.modified||!this.modified[this.segmentsField])&&this.set(this.segmentsField,this.getSegments().slice()));this.resumeSegmentsTracking()}},forEachSegment:function(n,t,i,r){if(n){r=r||this;var f,u;for(t!==!1?(f="getNextSegment",u=i||this.getFirstSegment()):(f="getPrevSegment",u=i||this.getLastSegment());u;){if(n.call(r,u)===!1)return;u=u[f].call(u)}}},split:function(n,t,i,r,u){var e=this,f;e.propagateChanges(function(){return e.splitWithoutPropagation(n,t,i,r,function(n){f=n})},function(n,t){n&&f&&f();u&&u(n,t)})},splitWithoutPropagation:function(n,t,i,r,u){var f=this,b,a,k,o,e,tt,v,h,l,d,s,p,w,g;if((r!==!0&&r!==!1&&(b=f.getTaskStore(!0),r=b?b.skipWeekendsDuringDragDrop:!1),n&&f.isLeaf()&&!f.isMilestone())&&(a=f.getStartDate(),k=f.getEndDate(),a&&k&&!(a>=n)&&!(n>=k))){if(o=f.getSegments(),tt=f.buildSegmentsSnapshot(o),o){if(e=f.getSegmentByDate(n),!e)return}else o=[];t=t||1;i=i||this.getDurationUnit();var it=new Date(n),y=it,c=it,nt=f.getUnitConverter().convertDurationToMs(t,i);if(r&&(c=f.skipNonWorkingTime(c,!0,!0),y=f.skipNonWorkingTime(y,!1,!0)),v=f.getDurationUnit(),h=Ext.ClassManager.get(f.segmentClassName).prototype,f.suspendSegmentsTracking(),p=!0,e?(l=f.calculateDuration(e.getStartDate(),y,v),d=e.getDuration(v)-l,p=!!l,p?(e.setEndDateWithoutPropagation(y,!1,r),w=e.getNextSegment()):w=e,w&&f.forEachSegment(function(n){n.setStartEndOffset(n.getStartOffset()+nt,n.getEndOffset()+nt);n.updateDatesByOffsets()},!0,w)):(l=f.calculateDuration(a,y),d=f.getDuration()-l,s={task:f},s[h.startDateField]=a,s[h.durationField]=l,s[h.durationUnitField]=v,o.push(Ext.create(f.segmentClassName,s))),p&&(c=f.skipWorkingTime(c,nt),r&&(c=f.skipNonWorkingTime(c)),s={prevSegment:e||o[0],task:f},s[h.startDateField]=c,s[h.durationField]=d,s[h.durationUnitField]=v,g=Ext.create(f.segmentClassName,s),e?Ext.Array.insert(o,Ext.Array.indexOf(o,e)+1,[g]):o.push(g)),f.resumeSegmentsTracking(),u&&u(function(){f.rollbackSegmentsToSnapshot(tt)}),e)f.onSegmentsChanged(null,null);else f.setSegmentsWithoutPropagation(o);return!0}},merge:function(n,t,i){var r=this;r.propagateChanges(function(){return r.mergeWithoutPropagation(n,t)},i)},mergeWithoutPropagation:function(n,t){if(this.isSegmented()&&n&&t){var i,r;return n.getStartOffset()>t.getStartOffset()?(i=t,r=n):(i=n,r=t),i.setEndDateWithoutPropagation(r.getEndDate(),!1),!0}},suspendSegmentsTracking:function(){this.segmentsTrackingSuspended++},resumeSegmentsTracking:function(){this.segmentsTrackingSuspended--},getSegmentsDuration:function(n){var i,r,t,f,u;for(n=n||this.getDurationUnit(),i=this.getSegments(),r=0,t=0,f=i.length;t<f;t++)u=i[t],r+=u.getEndOffset()-u.getStartOffset();return this.getUnitConverter().convertMSDurationToUnit(r,n)},mergeOverlappedSegments:function(n){var i=this.getSegments(),f,r,t,u,e;if(i){for(f=[],r=i[0],u=1,e=i.length;u<e;u++)t=i[u],t.getStartOffset()<=r.getEndOffset()?(f.push(t),t.getEndOffset()>r.getEndOffset()&&r.setEndDateWithoutPropagation(t.getEndDate(),!1)):r=t;this.removeSegments(f);i.length<2&&!n&&this.setSegmentsWithoutPropagation(null)}},onSegmentEditBegin:function(n){this.getTreeStore().onSegmentEditBegin(this,n);this.snapshotSegments()},onSegmentEditEnd:function(n){this.getTreeStore().onSegmentEditEnd(this,n)},onSegmentsChanged:function(n,t){if(!this.segmentsTrackingSuspended){var i=this.getSegments();this.changingTaskBySegments=!0;this.suspendSegmentsTracking();this.mergeOverlappedSegments(!0);i=this.getSegments();n&&t&&n.durationField in t?this.setDurationWithoutPropagation(this.getSegmentsDuration()):this.setStartDateWithoutPropagation(this.getStartDate(),!0);i=this.getSegments();this.set(this.segmentsField,i&&i.slice()||null);this.resumeSegmentsTracking();this.changingTaskBySegments=!1}},removeSegments:function(n){var i=this.getSegments(),t,r;if(i&&n&&n.length){for(Ext.isArray(n)||(n=[n]),t=0,r=n.length;t<r;t++)Ext.Array.remove(i,n[t]);this.onSegmentsChanged()}},setSegments:function(n,t){var i=this;i.propagateChanges(function(){return i.setSegmentsWithoutPropagation(n)},t)},setSegmentsWithoutPropagation:function(n){return this.onSegmentEditBegin(),this.suspendSegmentsTracking(),this.set(this.segmentsField,this.processSegmentsValue(n)),this.resumeSegmentsTracking(),this.onSegmentsChanged(),this.onSegmentEditEnd(),!0},processSegmentsValue:function(n){var i,t,f,r,u;if(n){for(n=[].concat(n),i=[],r=0,u=n.length;r<u;r++)t=n[r],t instanceof Gnt.model.TaskSegment||(t=Ext.create(this.segmentClassName,Ext.apply(t,{task:this}))),i.push(t),f=t;n=i&&i.length>1&&i||null}return n},isSegmented:function(){return Boolean(this.getSegments())},getSegment:function(n){return this.getSegments()[n]},rejectSegmentsProjection:function(){var r=this.getTaskStore(!0).getProjectionLevel(),t,n,i;if(this.segmentsProjection){for(n=r;n>=0;n--)if(t=this.segmentsProjection[n]){i=n;break}i===r&&delete this.segmentsProjection[i]}t&&this.rollbackSegmentsToSnapshot(t)},commitSegmentsProjection:function(){var n=this.getTaskStore(!0),t=n&&n.getProjectionLevel();this.segmentsProjection&&delete this.segmentsProjection[t]},rollbackSegmentsToSnapshot:function(n){this.data[this.segmentsField]=n&&Ext.Array.map(n,function(n){return n&&n[0].readSnapshot(n)})},buildSegmentsSnapshot:function(n){return n=n||this.getSegments(),n&&Ext.Array.map(n,function(n){return n&&n.buildSnapshot()})},snapshotSegments:function(){var i=this.getTaskStore(!0),r=this.getSegments(),t=i&&i.getProjectionLevel(),n;t&&(this.segmentsProjection=this.segmentsProjection||{},n=this.segmentsProjection[t-1],n||(n=this.buildSegmentsSnapshot(r),this.segmentsProjection[t-1]=n));this.segmentsSnapshot||(this.segmentsSnapshot=n||this.buildSegmentsSnapshot(r))},commitSegments:function(){var n,t,i;if(!this.rejecting&&(this.segmentsSnapshot=null,n=this.getSegments(),n))for(t=0,i=n.length;t<i;t++)n[t].commit()},rejectSegments:function(){var n,t,i;if(this.rollbackSegmentsToSnapshot(this.segmentsSnapshot),this.segmentsSnapshot=null,n=this.getSegments(),n)for(t=0,i=n.length;t<i;t++)n[t].reject()}});Ext.define("Gnt.model.Task",{extend:Sch.model.Range,alias:"gntmodel.event",mixins:[Gnt.model.mixin.ProjectableModel,Gnt.model.task.More,Gnt.model.task.Constraints,Gnt.model.task.Splittable],segmentClassName:"Gnt.model.TaskSegment",idProperty:"Id",customizableFields:[{name:"Duration",type:"number",allowNull:!0},{name:"Effort",type:"number",allowNull:!0},{name:"EffortUnit",type:"string",defaultValue:"h"},{name:"CalendarId",type:"string"},{name:"Note",type:"string"},{name:"DurationUnit",type:"string",defaultValue:"d",convert:function(n){return n||"d"}},{name:"PercentDone",type:"number",defaultValue:0},{name:"ConstraintType",type:"string",defaultValue:""},{name:"ConstraintDate",type:"date",dateFormat:"c"},{name:"ManuallyScheduled",type:"boolean",defaultValue:!1},{name:"SchedulingMode",type:"string",defaultValue:"Normal"},{name:"BaselineStartDate",type:"date",dateFormat:"c"},{name:"BaselineEndDate",type:"date",dateFormat:"c"},{name:"BaselinePercentDone",type:"int",defaultValue:0},{name:"Draggable",type:"boolean",persist:!1,defaultValue:!0},{name:"Resizable",persist:!1,defaultValue:""},{name:"ReadOnly",persist:!1,type:"bool",defaultValue:!1},{name:"Rollup",type:"boolean",defaultValue:!1},{name:"Segments",persist:!0,convert:function(n,t){return t.processSegmentsValue(n,t)},serialize:function(n){return n?Ext.Array.map([].concat(n),function(n){return n.serialize()}):null}},{name:"PhantomId",type:"string"},{name:"PhantomParentId",type:"string"},{name:"ShowInTimeline",type:"bool"},{name:"DeadlineDate",type:"date",dateFormat:"c"},{name:"index",type:"int",persist:!0}],constraintTypeField:"ConstraintType",constraintDateField:"ConstraintDate",draggableField:"Draggable",resizableField:"Resizable",nameField:"Name",durationField:"Duration",durationUnitField:"DurationUnit",effortField:"Effort",effortUnitField:"EffortUnit",percentDoneField:"PercentDone",manuallyScheduledField:"ManuallyScheduled",schedulingModeField:"SchedulingMode",rollupField:"Rollup",calendarIdField:"CalendarId",baselineStartDateField:"BaselineStartDate",baselineEndDateField:"BaselineEndDate",baselinePercentDoneField:"BaselinePercentDone",noteField:"Note",segmentsField:"Segments",readOnlyField:"ReadOnly",calendar:null,dependencyStore:null,taskStore:null,phantomIdField:"PhantomId",phantomParentIdField:"PhantomParentId",showInTimelineField:"ShowInTimeline",deadlineDateField:"DeadlineDate",normalized:!1,recognizedSchedulingModes:["Normal","FixedDuration","EffortDriven","DynamicAssignment"],convertEmptyParentToLeaf:!0,autoCalculateEffortForParentTask:!0,autoCalculatePercentDoneForParentTask:!0,isHighlighted:!1,calendarWaitingListener:null,childTasksDuration:null,completedChildTasksDuration:null,totalCount:null,predecessors:null,successors:null,removeChildIsCalledFromReplaceChild:!1,savedDirty:null,useOwnCalendarAsConverter:!1,constructor:function(){this._singleProp={};this.initProjectable();this.callParent(arguments);this.phantom&&(this.data[this.phantomIdField]=this.getId());this.id==="root"&&(this.convertEmptyParentToLeaf=!1);this.predecessors=[];this.successors=[]},normalize:function(){var f=this.getDurationUnit(),t=this.getStartDate(),n=this.getEndDate(),i=this.data,y=this.getTaskStore(!0),o=this.getSchedulingMode(),u,a,r,s,c,v,e,h,l;o=="Manual"&&(o=i[this.schedulingModeField]="Normal",i[this.manuallyScheduledField]=!0);u=this.endDateField;y&&this.isSegmented()&&(this.normalizeSegments(),(a=this.getLastSegment())&&(n=i[u]=a.getEndDate()));r=this.getDuration();s=this.effortField;n&&this.inclusiveEndDate&&(c=this.getField(u).dateFormat,v=c&&!Ext.Date.formatContainsHourInfo(c)||n.getHours()===0&&n.getMinutes()===0&&n.getSeconds()===0&&n.getMilliseconds()===0,v&&(n=i[u]=Ext.isNumber(r)?this.calculateEndDate(t,r,f):Ext.Date.add(n,Ext.Date.DAY,1)));r==null&&t&&n&&(r=i[this.durationField]=this.calculateDuration(t,n,f));(o=="Normal"||this.isManuallyScheduled())&&n==null&&t&&Ext.isNumber(r)&&(n=i[u]=this.calculateEndDate(t,r,f));e=this.get(s);h=this.getEffortUnit();switch(o){case"FixedDuration":n==null&&t&&Ext.isNumber(r)&&(n=i[u]=this.calculateEndDate(t,r,f));e==null&&t&&n&&(i[s]=this.calculateEffort(t,n,h));break;case"EffortDriven":e==null&&t&&n&&(i[s]=this.calculateEffort(t,n,h));n==null&&t&&e&&(i[u]=this.calculateEffortDrivenEndDate(t,e,h),r==null&&(i[this.durationField]=this.calculateDuration(t,i[u],f)));break;default:n==null&&t&&Ext.isNumber(r)&&(n=i[u]=this.calculateEndDate(t,r,f))}l=this.getCalendarId();l&&this.setCalendarId(l,!0);this.normalized=!0},getUnitConverter:function(){return this.useOwnCalendarAsConverter&&this.getCalendar()||this.getProjectCalendar()},normalizeParent:function(){for(var n,t,r,u,s=this.childNodes,f=0,i=0,e=0,h=this.autoCalculatePercentDoneForParentTask,c=this.autoCalculateEffortForParentTask,o=0;o<s.length;o++)n=s[o],t=n.isLeaf(),t||n.normalizeParent(),c&&(f+=n.getEffort("MILLI")),h&&(r=t?n.getDuration("MILLI")||0:n.childTasksDuration,i+=r,e+=t?r*(n.getPercentDone()||0):n.completedChildTasksDuration);h&&(this.childTasksDuration=i,this.completedChildTasksDuration=e,u=i?e/i:0,this.getPercentDone()!=u&&(this.data[this.percentDoneField]=u));c&&this.getEffort("MILLI")!=f&&(this.data[this.effortField]=this.getUnitConverter().convertMSDurationToUnit(f,this.getEffortUnit()))},getCalendar:function(n){return n?this.getOwnCalendar():this.getOwnCalendar()||this.parentNode&&this.parentNode.getCalendar()||this.getProjectCalendar()},getOwnCalendar:function(){var n=this.get(this.calendarIdField);return n?Gnt.data.Calendar.getCalendar(n):this.calendar},getProject:function(){var t=this,n=null;return this.bubble(function(i){if(t!==i&&i.isProject)return n=i,!1},this),n},getProjectCalendar:function(){var n=this.getTaskStore(!0),t=n&&n.getCalendar()||this.parentNode&&this.parentNode.getProjectCalendar()||this.isRoot()&&this.calendar;return t||Ext.Error.raise("Can't find a project calendar in `getProjectCalendar`"),t},setCalendar:function(n,t){var r=this,i=n instanceof Gnt.data.Calendar;if(i&&!n.calendarId)throw new Error("Can't set calendar w/o `calendarId` property");return r.setCalendarId(i?n.calendarId:n,!1,t)},setCalendarId:function(n,t,i){var r=this;t?r.setCalendarIdWithoutPropagation(n,t):r.propagateChanges(function(){return r.setCalendarIdWithoutPropagation(n,t)},i)},onCalendarChange:function(){this.isReadOnly()||this.adjustToCalendarWithoutPropagation()},setCalendarIdWithoutPropagation:function(n,t){var e=!1,u,r,f,i;if(n instanceof Gnt.data.Calendar&&(n=n.calendarId),u=this.getCalendarId(),u!=n||t)if(e=!0,this.calendarWaitingListener&&(this.calendarWaitingListener.destroy(),this.calendarWaitingListener=null),r={calendarchange:this.onCalendarChange,scope:this},f=this.calendar||Gnt.data.Calendar.getCalendar(u),this.calendar=null,f&&f.un(r),this.set(this.calendarIdField,n),i=Gnt.data.Calendar.getCalendar(n),i){i.on(r);t||this.onCalendarChange()}else this.calendarWaitingListener=Ext.data.StoreManager.on("add",function(){if(i=Gnt.data.Calendar.getCalendar(n),i){this.calendarWaitingListener.destroy();this.calendarWaitingListener=null;i.on(r);this.onCalendarChange()}},this,{destroyable:!0});return e},getDependencyStore:function(){var n=this.getTaskStore(!0);return n&&n.getDependencyStore()},getResourceStore:function(){var n=this.getTaskStore(!0);return n&&n.getResourceStore()},getAssignmentStore:function(){var n=this.getTaskStore(!0);return n&&n.getAssignmentStore()},getTaskStore:function(n){var t=this;return t.taskStore||(t.taskStore=t.getTreeStore()||t.parentNode&&t.parentNode.getTaskStore(n)),t.taskStore||n||Ext.Error.raise("Can't find a taskStore in `getTaskStore`"),t.taskStore},getEventStore:function(){return this.getTaskStore()},setTaskStore:function(n){this.taskStore=n},isManuallyScheduled:function(){return this.get(this.schedulingModeField)==="Manual"||this.get(this.manuallyScheduledField)},isShowInTimeline:function(){return Boolean(this.getShowInTimeline())},setManuallyScheduled:function(n,t){var i=this;i.propagateChanges(function(){return i.setManuallyScheduledWithoutPropagation(n)},t)},setManuallyScheduledWithoutPropagation:function(n){var t=this,i;return t.isManuallyScheduled()!=n&&(this.set(t.manuallyScheduledField,n),n||(i=t.getPredecessors()[0]),i=i||t),i},setSchedulingMode:function(n,t){var i=this;i.propagateChanges(function(){return i.setSchedulingModeWithoutPropagation(n)},t)},setSchedulingModeWithoutPropagation:function(n){var t=this,r,i;if(Ext.Array.contains(t.recognizedSchedulingModes,n)||Ext.Error.raise("Unrecognized scheduling mode: "+n),t.getSchedulingMode()!=n){t.set(this.schedulingModeField,n);switch(n){case"FixedDuration":t.updateEffortBasedOnDuration();break;case"EffortDriven":t.updateSpanBasedOnEffort()}i=t.getPredecessors();r=i.length?i[0]:t}return r},skipWorkingTime:function(n,t,i,r){var e,f,u;return(i=i!==!1,u={isForward:i,segments:r||!1,resources:this.hasResources(),fn:function(n,t){var r=t-n,u=new Date(n).getTimezoneOffset()-new Date(t).getTimezoneOffset();if(r>=f)return e=new Date((i?n:t)-0+(i?1:-1)*f),!1;f-=r+u*6e4}},Ext.isObject(n)?Ext.apply(u,n):i?u.startDate=n:u.endDate=n,f=t||u.duration,!f)?n:(this.forEachAvailabilityInterval(u),e)},skipNonWorkingTime:function(n,t,i){var u=!1,r;return t=t!==!1,r={isForward:t,segments:i||!1,resources:this.hasResources(),fn:function(i,r){if(i!==r)return n=t?i:r,u=!0,!1}},Ext.isObject(n)?Ext.apply(r,n):t?r.startDate=n:r.endDate=n,this.forEachAvailabilityInterval(r),u?new Date(n):this.getCalendar().skipNonWorkingTime(n,t)},setStartDate:function(n,t,i,r){var u=this;u.propagateChanges(function(){return u.setStartDateWithoutPropagation(n,t,i)},r)},setStartDateWithoutPropagation:function(n,t,i){var r=this,f=r.getTaskStore(!0),e,u;return t=t!==!1,f&&i!==!0&&i!==!1?i=f.skipWeekendsDuringDragDrop:i!==!0&&i!==!1&&(i=!1),r.beginEdit(),n?(i&&(n=r.skipNonWorkingTime(n,!r.isMilestone())),r.set(r.startDateField,n),f&&r.isSegmented()&&r.updateSegmentsDates(),t!==!1?r.set(r.endDateField,r.recalculateEndDate(n)):(u=this.getEndDate(),u&&(this.constrainSegments(),r.set(r.durationField,r.calculateDuration(n,u,r.getDurationUnit()))))):(r.set(r.durationField,null),r.set(r.startDateField,null),r.setSegmentsWithoutPropagation(null)),e=r.getDuration(),u=r.getEndDate(),n&&u&&(e===undefined||e===null)&&r.set(r.durationField,r.calculateDuration(n,u,r.getDurationUnit())),r.onPotentialEffortChange(),r.endEdit(),!0},setEndDate:function(n,t,i,r){var u=this;u.propagateChanges(function(){return u.setEndDateWithoutPropagation(n,t,i)},r)},setEndDateWithoutPropagation:function(n,t,i){var r=this,e=r.getTaskStore(!0),f,u,s,h,o;return t=t!==!1,i!==!0&&i!==!1&&e?i=e.skipWeekendsDuringDragDrop:i!==!0&&i!==!1&&(i=!1),r.beginEdit(),s=r.getEndDate(),n?(u=r.getStartDate(),n<u&&t===!1&&(n=u),i&&(n=r.skipNonWorkingTime(n,!1)),t!==!1?(f=r.getDuration(),Ext.isNumber(f)?(e&&r.isSegmented()&&n-s&&r.updateSegmentsDates({isForward:!1,endDate:n}),r.set(r.startDateField,r.calculateStartDate(n,f,r.getDurationUnit())),r.set(r.endDateField,n)):r.set(r.endDateField,n)):(h=r.isMilestone(),n<u&&r.set(r.startDateField,n),r.set(r.endDateField,n),r.constrainSegments(),u&&(r.set(r.durationField,r.calculateDuration(u,n,r.getDurationUnit())),h&&!r.isMilestone()&&(o=r.skipNonWorkingTime(u,!0),o-u!=0&&r.set(r.startDateField,o))))):(r.set(r.durationField,null),r.set(r.endDateField,null),r.setSegments(null)),f=r.getDuration(),u=r.getStartDate(),n&&u&&(f===undefined||f===null)&&r.set(r.durationField,r.calculateDuration(u,n,r.getDurationUnit())),r.onPotentialEffortChange(),r.endEdit(),!0},setStartEndDate:function(n,t,i,r){var u=this;i=i||!1;u.propagateChanges(function(){return u.setStartEndDateWithoutPropagation(n,t,i)},r)},setStartEndDateWithoutPropagation:function(n,t,i){var r=this,f=r.getTaskStore(!0),e,u;return i!==!0&&i!==!1&&f?i=f.skipWeekendsDuringDragDrop:i!==!0&&i!==!1&&(i=!1),i&&(n=n&&r.skipNonWorkingTime(n,!0),t=t&&r.skipNonWorkingTime(t,!1),t<n&&(n=t)),e=r.getStartDate(),u=r.getEndDate(),r.beginEdit(),r.set(r.startDateField,n),r.set(r.endDateField,t),r.getTaskStore(!0)&&r.isSegmented()&&(n-e||t-u)&&r.updateSegmentsDates(),t-u&&r.constrainSegments(),r.set(r.durationField,r.calculateDuration(n,t,r.getDurationUnit())),r.onPotentialEffortChange(),r.endEdit(),!0},shift:function(n,t,i){var r=this;r.setStartEndDate(Sch.util.Date.add(r.getStartDate(),n,t),Sch.util.Date.add(r.getEndDate(),n,t),undefined,i)},getDuration:function(n){if(!n)return this.get(this.durationField);var t=this.getUnitConverter(),i=t.convertDurationToMs(this.get(this.durationField),this.get(this.durationUnitField));return t.convertMSDurationToUnit(i,n)},getEffort:function(n){var i=this.get(this.effortField)||0,t,r;return n?(t=this.getUnitConverter(),r=t.convertDurationToMs(i,this.getEffortUnit()),t.convertMSDurationToUnit(r,n)):i},setEffort:function(n,t,i){var r=this;r.propagateChanges(function(){return r.setEffortWithoutPropagation(n,t)},i)},setEffortWithoutPropagation:function(n,t){var i=this;t=t||i.getEffortUnit();i.beginEdit();i.set(i.effortField,n);i.set(i.effortUnitField,t);switch(i.getSchedulingMode()){case"EffortDriven":i.updateSpanBasedOnEffort();break;case"DynamicAssignment":i.updateAssignments()}return i.endEdit(),!0},getCalendarDuration:function(n){return this.getUnitConverter().convertMSDurationToUnit(this.getEndDate()-this.getStartDate(),n||this.get(this.durationUnitField))},setDuration:function(n,t,i){var r=this;r.propagateChanges(function(){return r.setDurationWithoutPropagation(n,t)},i)},setDurationWithoutPropagation:function(n,t){var i=this,f=!i.isManuallyScheduled()&&i.hasEndPredecessorsButNoStartPredecessors(),r=null,u=null,l=i.getEndDate(),s,h,e,c,o;return t=t||i.getDurationUnit(),s=i.isMilestone(),i.beginEdit(),Ext.isNumber(n)&&!i.getStartDate()&&(l?f=!0:(h=i.getTaskStore(!0),u=h&&h.getProjectStartDate()||Ext.Date.clearTime(new Date),i.setStartDateWithoutPropagation(u))),this.constrainSegments({duration:n,unit:t}),Ext.isNumber(n)&&(f&&i.getEndDate()?u=i.calculateStartDate(i.getEndDate(),n,t):r=i.calculateEndDate(i.getStartDate(),n,t)),!f&&(r||this.getStartDate())&&i.set(i.endDateField,r),f&&(u||this.getEndDate())&&i.set(i.startDateField,u),i.set(i.durationField,n),i.set(i.durationUnitField,t),i.isMilestone()!=s&&(s?(e=i.getStartDate(),e&&(c=i.skipNonWorkingTime(e,!0),c-e!=0&&i.set(i.startDateField,c))):r&&(o=i.skipNonWorkingTime(r,!1),o-r!=0&&(i.set(i.startDateField,o),i.set(i.endDateField,o)))),i.onPotentialEffortChange(),i.endEdit(),!0},calculateStartDate:function(n,t,i,r){var u,e,f,o;return t?(i=i||this.getDurationUnit(),u=this.getSchedulingMode(),e=u!="FixedDuration"&&u!="DynamicAssignment"&&u!="EffortDriven",r=Ext.apply({endDate:n,isForward:!1,resources:e&&this.hasResources()},r),this.getTaskStore(!0)&&(this.isSegmented()||e)?(f=this.getUnitConverter().convertDurationToMs(t,i),this.forEachAvailabilityInterval(r,function(n,t){var i=t-n,r;if(i>=f)return o=new Date(t-f),!1;r=new Date(t).getTimezoneOffset()-new Date(n).getTimezoneOffset();f-=i+r*6e4}),o):this.getCalendar().calculateStartDate(n,t,i)):n},recalculateEndDate:function(n){var t=this,i,r;return n=n||t.getStartDate(),n&&t.getSchedulingMode()=="EffortDriven"?i=t.calculateEffortDrivenEndDate(n,t.getEffort()):(r=t.getDuration(),i=n&&Ext.isNumber(r)?t.calculateEndDate(n,r,t.getDurationUnit()):t.getEndDate()),i},calculateEndDate:function(n,t,i,r){var u,o,e,f;if(i=i||this.getDurationUnit(),!t)return n;if(r=Ext.apply({startDate:n},r),u=this.getSchedulingMode(),e=u!="FixedDuration"&&u!="DynamicAssignment"&&u!="EffortDriven",this.getTaskStore(!0)&&(this.isSegmented()||e))f=this.getUnitConverter().convertDurationToMs(t,i),r.resources=e&&this.hasResources(),this.forEachAvailabilityInterval(r,function(n,t){var i=t-n,r;if(i>=f)return o=new Date(n+f),!1;r=new Date(n).getTimezoneOffset()-new Date(t).getTimezoneOffset();f-=i+r*6e4});else return this.getCalendar().calculateEndDate(n,t,i);return o},calculateDuration:function(n,t,i,r){if(i=i||this.getDurationUnit(),!n||!t)return 0;if(this.getTaskStore(!0)){var u=0;return this.forEachAvailabilityInterval(Ext.apply({startDate:n,endDate:t,resources:this.hasResources()},r),function(n,t){var i=new Date(n).getTimezoneOffset()-new Date(t).getTimezoneOffset();u+=t-n+i*6e4}),this.getUnitConverter().convertMSDurationToUnit(u,i)}return this.getCalendar().calculateDuration(n,t,i)},isCalendarApplicable:function(n){var u=this.getStartDate(),t,f,i,e;if(!u||(t=this.getTaskStore(!0),!t))return!0;var o=Sch.util.Date.add(u,"d",t&&t.availabilitySearchLimit||1825),s=this.getAssignments(),r=[];if(Ext.Array.each(s,function(n){var t=n.getResource();t&&r.push(t.getCalendar())}),!r.length)return!0;for(f=Gnt.data.Calendar.getCalendar(n),i=0,e=r.length;i<e;i++)if(f.isAvailabilityIntersected(r[i],u,o))return!0;return!1},forEachAvailabilityInterval:function(n,t,i){var f,h,y,k,r,u,ct,lt,at,ft,s,vt,yt;t=t||n.fn;i=i||n.scope||this;var ti=this,l=n.startDate,a=n.endDate,bt=n.includeEmptyIntervals,et=n.resources,pt=n.segments||n.segments!==!1,d=n.isForward!==!1,g=Sch.util.Date,v,ot,st=this.getTaskStore(!0);if(d){if(!l)throw new Error("forEachAvailabilityInterval: `startDate` is required when `isForward` is true");a||(a=g.add(l,"d",n.availabilitySearchLimit||st&&st.availabilitySearchLimit||1825));v=new Date(l)}else{if(!a)throw new Error("forEachAvailabilityInterval: `endDate` is required when `isForward` is false");l||(l=g.add(a,"d",-(n.availabilitySearchLimit||st&&st.availabilitySearchLimit||1825)));v=new Date(a)}var nt=this.getOwnCalendar(),ii=this.getProjectCalendar(),ht={},wt=[];if(et){var kt=!1,dt=n.assignments,gt=function(n){var r=n.getId(),t=dt&&Ext.Array.findBy(dt,function(n){return n.getResourceId()==r})||ti.getAssignmentFor(n),u=n.getCalendar(),i=u.getCalendarId();ht[i]||(ht[i]=[],wt.push(u));ht[i].push({assignment:t,resourceId:r,units:t&&t.getUnits()});kt=!0};if(et!==!0?Ext.each(et,gt):Ext.Array.each(this.getAssignments(),function(n){var t=n.getResource();t&&gt(t)}),!kt)return}else nt=nt||ii;for(pt&&(ot=Ext.isArray(pt)?pt:this.getSegments());d?v<a:v>l;){var e={},c=[],ni=v-(d?0:1);if(nt)for(ct=nt.getAvailabilityIntervalsFor(ni),h=0,y=ct.length;h<y;h++)k=ct[h],r=k.startDate-0,u=k.endDate-0,e[r]||(e[r]=[],c.push(r)),e[r].push({type:"00-taskAvailailabilityStart",typeBackward:"01-taskAvailailabilityStart"}),c.push(u),e[u]=e[u]||[],e[u].push({type:"01-taskAvailailabilityEnd",typeBackward:"00-taskAvailailabilityEnd"});if(ot&&(d?(lt=v,at=g.getStartOfNextDay(v)):(lt=g.getEndOfPreviousDay(v),at=v),ft=this.getSegmentIntervalsForRange(lt,at,ot),ft))for(f=0,y=ft.length;f<y;f++)r=ft[f][0],u=ft[f][1],e[r]||(e[r]=[],c.push(r)),e[r].push({type:"04-taskSegmentStart",typeBackward:"05-taskSegmentStart"}),c.push(u),e[u]=e[u]||[],e[u].push({type:"05-taskSegmentEnd",typeBackward:"04-taskSegmentEnd"});for(f=0,y=wt.length;f<y;f++)for(vt=wt[f],yt=vt.getAvailabilityIntervalsFor(ni),s=ht[vt.getCalendarId()],h=0;h<yt.length;h++)k=yt[h],r=k.startDate-0,u=k.endDate-0,e[r]||(e[r]=[],c.push(r)),e[r].push({type:"02-resourceAvailailabilityStart",typeBackward:"03-resourceAvailailabilityStart",resources:s}),e[u]||(e[u]=[],c.push(u)),e[u].push({type:"03-resourceAvailailabilityEnd",typeBackward:"02-resourceAvailailabilityEnd",resources:s});c.sort(function(n,t){return n-t});var tt=!1,it=!1,rt={},ut=0,p,w,o,b;if(d)for(f=0,y=c.length;f<y;f++){for(p=e[c[f]],p.sort(function(n,t){return n.type<t.type?1:-1}),h=0;h<p.length;h++){w=p[h];switch(w.type){case"00-taskAvailailabilityStart":tt=!0;break;case"01-taskAvailailabilityEnd":tt=!1;break;case"02-resourceAvailailabilityStart":for(s=w.resources,o=0,b=s.length;o<b;o++)rt[s[o].resourceId]=s[o],ut++;break;case"03-resourceAvailailabilityEnd":for(s=w.resources,o=0,b=s.length;o<b;o++)delete rt[s[o].resourceId],ut--;break;case"04-taskSegmentStart":it=!0;break;case"05-taskSegmentEnd":it=!1}}if((tt||!nt)&&(!ot||it)&&(!et||ut||bt)){if(r=c[f],u=c[f+1],r>=a||u<=l)continue;if(r<l&&(r=+l),u>a&&(u=+a),t.call(i,r,u,rt)===!1)return!1}}else for(f=c.length-1;f>=0;f--){for(p=e[c[f]],p.sort(function(n,t){return n.typeBackward<t.typeBackward?1:-1}),h=0;h<p.length;h++){w=p[h];switch(w.typeBackward){case"00-taskAvailailabilityEnd":tt=!0;break;case"01-taskAvailailabilityStart":tt=!1;break;case"02-resourceAvailailabilityEnd":for(s=w.resources,o=0,b=s.length;o<b;o++)rt[s[o].resourceId]=s[o],ut++;break;case"03-resourceAvailailabilityStart":for(s=w.resources,o=0,b=s.length;o<b;o++)delete rt[s[o].resourceId],ut--;break;case"04-taskSegmentEnd":it=!0;break;case"05-taskSegmentStart":it=!1}}if((tt||!nt)&&(!ot||it)&&(!et||ut||bt)){if(r=c[f-1],u=c[f],r>a||u<=l)continue;if(r<l&&(r=+l),u>a&&(u=+a),t.call(i,r,u,rt)===!1)return!1}}v=d?g.getStartOfNextDay(v):g.getEndOfPreviousDay(v)}},forEachAvailabilityIntervalWithResources:function(n){n.resources||(n.resources=!0);this.forEachAvailabilityInterval.apply(this,arguments)},calculateEffortDrivenEndDate:function(n,t,i){if(!t)return n;var r=this.getUnitConverter().convertDurationToMs(t,i||this.getEffortUnit()),u=new Date(n);return this.forEachAvailabilityIntervalWithResources({startDate:n},function(n,t,i){var o=0,s,e,f;for(s in i)o+=i[s].units;if(e=t-n,f=o*e/100,f>=r)return u=new Date(n+r/f*e),!1;r-=f}),u},refreshCalculatedParentNodeData:function(){var s=this.autoCalculatePercentDoneForParentTask,h=this.autoCalculateEffortForParentTask,c=this.childNodes,u=c.length,r={},f,i,l,a,v,y,p,e,w,d;if(u>0&&(h||s)){var b=0,o=0,k=0;for(f=0;f<u;f++)i=c[f],i.parentNode&&(l=i.isLeaf(),h&&(b+=i.getEffort("MILLI")),s&&(a=l?i.getDuration("MILLI")||0:i.childTasksDuration,o+=a,k+=l?a*(i.getPercentDone()||0):i.completedChildTasksDuration));h&&this.getEffort("MILLI")!=b&&(r.Effort=!0,this.setEffortWithoutPropagation(this.getUnitConverter().convertMSDurationToUnit(b,this.getEffortUnit())));s&&(this.childTasksDuration=o,this.completedChildTasksDuration=k,v=o?k/o:0,this.getPercentDone()!=v&&(r.PercentDone=!0,this.setPercentDone(v)))}if(!this.isRoot()&&u>0&&!this.isManuallyScheduled()&&!this.isReadOnly()){var g=new Date(-864e13),nt=new Date(864e13),n=new Date(864e13),t=new Date(-864e13);for(e=0;e<u;e++)w=c[e],n=Sch.util.Date.min(n,w.getStartDate()||n),t=Sch.util.Date.max(t,w.getEndDate()||t);t<n&&n<nt&&t>g&&(d=t,t=n,n=d);y=r.StartDate=n-nt!=0&&this.getStartDate()-n!=0;p=r.EndDate=t-g!=0&&this.getEndDate()-t!=0;y&&p?this.setStartEndDateWithoutPropagation(n,t,!1):y?this.setStartDateWithoutPropagation(n,!1,!1):p&&this.setEndDateWithoutPropagation(t,!1,!1)}return r},recalculateParents:function(){var n=this.parentNode;n&&(n.refreshCalculatedParentNodeData(),!this.getTaskStore().cascading&&n.recalculateParents())},isMilestone:function(n){if(n)return this.isBaselineMilestone();if(!this.get("leaf")){var t=this.getStartDate(),i=this.getEndDate();if(t&&i)return i-t==0}return this.getDuration()===0},convertToMilestone:function(n){var t=this;t.propagateChanges(function(){return t.convertToMilestoneWithoutPropagation()},n)},convertToMilestoneWithoutPropagation:function(){var n=this,t=!1;return n.isMilestone()||(t=n.setStartDateWithoutPropagation(n.getEndDate(),!1),t=t&&n.setDurationWithoutPropagation(0)),t},convertToRegular:function(n){var t=this;t.propagateChanges(function(){return t.convertToRegularWithoutPropagation()},n)},convertToRegularWithoutPropagation:function(){var n=this,t=!1,i,r;return n.isMilestone()&&(i=n.get(n.durationUnitField),r=n.calculateStartDate(n.getStartDate(),1,i),t=n.setDurationWithoutPropagation(1,i),t=t&&n.setStartDateWithoutPropagation(r,!0,!1,!1)),t},isBaselineMilestone:function(){var n=this.getBaselineStartDate(),t=this.getBaselineEndDate();return n&&t?t-n==0:!1},markAsParent:function(){var n=this;n.isSegmented()&&n.setSegmentsWithoutPropagation(null);n.set("leaf",!1)},getDurationUnit:function(){return this.get(this.durationUnitField)||"d"},getEffortUnit:function(){return this.get(this.effortUnitField)||"h"},getBaselinePercentDone:function(){return this.get(this.baselinePercentDoneField)||0},isPersistable:function(){var n=this.parentNode;return!n||!n.phantom||n.isRoot()},getResources:function(){var n=this,t=n.getAssignmentStore();return t&&t.getResourcesForEvent(n)||[]},getAssignments:function(){var n=this,t=n.getAssignmentStore();return t&&t.getAssignmentsForTask(n)||[]},hasAssignments:function(){return this.getAssignments().length>0},hasResources:function(){for(var i=this.getAssignments(),n=!1,t=0,r=i.length;!n&&t<r;t++)n=!!i[t].getResource();return n},getAssignmentFor:function(n){var t=this,i=t.getAssignmentStore();return i&&i.getAssignmentForEventAndResource(t,n)||null},isAssignedTo:function(n){var t=this,i=t.getAssignmentStore();return i&&i.isTaskAssignedToResource(t,n)||!1},assign:function(n,t,i){var u=this,f,r;return u.propagateChanges(function(){return u.assignWithoutPropagation(n,t,function(n,t){r=n;f=t})},function(n,t){n&&r&&r();i&&i(n,t)}),f},assignWithoutPropagation:function(n,t,i){var u=this,e=[],o=u.getTaskStore(),s=o.getAssignmentStore(),f=o.getResourceStore(),h,r;return t=t||100,u.getAssignmentFor(n)&&Ext.Error.raise("Resource can't be assigned twice to the same task"),n instanceof Gnt.model.Resource&&f.indexOf(n)==-1?(r=n.getId(),f.add(n),e.push(function(){f.remove(n)})):n instanceof Gnt.model.Resource?r=n.getId():f.indexOfId(n)>=0?r=n:Ext.Error.raise("Can't assign resource to a task, task's resource store doesn't contain resource id given"),h=s.assignTaskToResource(u,r,t),e.push(function(){s.unassignTaskFromResource(u,r)}),i&&i(function(){Ext.Array.each(e,function(n){n()})},h[0]),!0},unassign:function(){return this.unAssign.apply(this,arguments)},unAssign:function(n,t){var r=this,i;r.propagateChanges(function(){return r.unassignWithoutPropagation(n,function(n){i=n})},function(n,r){n&&i&&i();t&&t(n,r)})},unassignWithoutPropagation:function(n,t){var i=this,f=n instanceof Gnt.model.Resource?n.getId():n,r=i.getAssignmentStore(),u=i.getAssignmentFor(f),e;return u||Ext.Error.raise("Can't unassign resource `"+f+"` from task `"+i.getId()+"` resource is not assigned to the task!"),e=r.indexOf(u),r.unassignTaskFromResource(i,n),t&&t(function(){r.insert(e,u)}),!0},reassign:function(n,t,i){var r=this,u,f;r.propagateChanges(function(){var e=r.getAssignmentFor(n).getUnits(),i=!1;return i=r.unassignWithoutPropagation(n,function(n){u=n}),i&&r.assignWithoutPropagation(t,e,function(n){f=n})},function(n,t){n&&(f&&f(),u&&u());i&&i(n,t)})},linkTo:function(n,t,i,r){var f=this,u;f.propagateChanges(function(){return f.linkToWithoutPropagation(n,t,function(n){u=n},r)},function(n,t){n&&u&&u();i&&i(n,t)})},linkToWithoutPropagation:function(n,t,i,r){var f=this,o=f.getId(),s=f.getTaskStore(),e=f.getDependencyStore(),u;return n=n instanceof Gnt.model.Task?n.getId():n,t=(t===null||t===undefined)&&Gnt.model.Dependency.Type.EndToStart||t,s.getModelById(n instanceof Gnt.model.Task?n.getId():n)!=-1||Ext.Error.raise("Can't link task `"+o+"` to task with id `"+n+"` the task is not present in the task store!"),u=new e.model,u.setSourceId(o),u.setTargetId(n),u.setType(t),e.isValidDependency(u)&&(!r||r(u)!==!1)&&e.add(u),i&&i(function(){e.remove(u)}),f},unlinkFrom:function(n,t){var r=this,i;r.propagateChanges(function(){return r.unlinkFromWithoutPropagation(n,function(n){i=n})},function(n,r){n&&i&&i();t&&t(n,r)})},unlinkFromWithoutPropagation:function(n,t){var u=this,f=u.getId(),r=u.getDependencyStore(),i,e;return n=n instanceof Gnt.model.Task?n.getId():n,i=r.getByTaskIds(n,f),i||Ext.Error.raise("Can't unlink task '"+f+"' from task '"+n+", tasks are not linked!"),e=r.indexOf(i),r.remove(i),t&&t(function(){r.insert(e,i)}),u},calculateEffort:function(n,t,i){if(!n||!t)return 0;var r=0;return this.forEachAvailabilityIntervalWithResources({startDate:n,endDate:t},function(n,t,i){var u=0;for(var f in i)u+=i[f].units;r+=(t-n)*u/100}),this.getUnitConverter().convertMSDurationToUnit(r,i||this.getEffortUnit())},updateAssignments:function(){var t=this.getStartDate(),i=this.getEndDate(),n,r;t&&i&&(n=0,this.forEachAvailabilityIntervalWithResources({startDate:t,endDate:i},function(t,i,r){for(var u in r)n+=i-t}),n)&&(r=this.getEffort(Sch.util.Date.MILLI),Ext.Array.each(this.getAssignments(),function(t){t.setUnits(r/n*100)}))},updateEffortBasedOnDuration:function(){this.setEffortWithoutPropagation(this.calculateEffort(this.getStartDate(),this.getEndDate()))},updateEffortBasedOnSpan:function(){this.updateEffortBasedOnDuration()},updateSpanBasedOnEffort:function(){this.setStartEndDateWithoutPropagation(this.getStartDate(),this.recalculateEndDate())},onPotentialEffortChange:function(){var n=this,t=n.getTaskStore(!0);if(n.isTaskStored()&&(!t||!t.isUndoingOrRedoing()))switch(n.getSchedulingMode()){case"FixedDuration":n.updateEffortBasedOnDuration();break;case"DynamicAssignment":n.updateAssignments()}},onAssignmentMutation:function(){var n=this,t=n.getTaskStore(!0);if(n.isTaskStored()&&(!t||!t.isUndoingOrRedoing()))switch(this.getSchedulingMode()){case"FixedDuration":this.updateEffortBasedOnDuration();break;case"EffortDriven":this.updateSpanBasedOnEffort();break;case"DynamicAssignment":this.updateAssignments()}},onAssignmentStructureMutation:function(){var n=this,t=n.getTaskStore(!0);if(n.isTaskStored()&&(!t||!t.isUndoingOrRedoing()))switch(this.getSchedulingMode()){case"FixedDuration":this.updateEffortBasedOnDuration();break;case"EffortDriven":this.updateSpanBasedOnEffort();break;case"DynamicAssignment":this.updateAssignments()}},adjustToCalendar:function(n){var t=this;t.propagateChanges(function(){return t.adjustToCalendarWithoutPropagation()},n)},adjustToCalendarWithoutPropagation:function(){var n=this,t=n.getTaskStore(!0),i=!1;return t&&(n.get("leaf")?(n.setStartDateWithoutPropagation(n.getStartDate(),!0,t.skipWeekendsDuringDragDrop),n.alignByIncomingDependenciesWithoutPropagation(t,null),i=n):n.getStartDate()&&n.getEndDate()&&(n.set(n.durationField,n.calculateDuration(n.getStartDate(),n.getEndDate(),n.getDurationUnit())),i=n)),i},isReadOnly:function(){var n=!1;return this.bubble(function(t){if(t.getReadOnly())return n=!0,!1},this),n},isEditable:function(n){return!this.getReadOnly()&&this.isReadOnly()?!1:n===this.readOnlyField?!0:this.getReadOnly()?!1:!this.isLeaf()&&(n===this.effortField&&this.autoCalculateEffortForParentTask||n===this.percentDoneField&&this.autoCalculatePercentDoneForParentTask)?!1:(n===this.durationField||n===this.endDateField)&&this.getSchedulingMode()==="EffortDriven"?!1:n===this.effortField&&this.getSchedulingMode()==="FixedDuration"?!1:!0},isDraggable:function(){return this.getDraggable()},isResizable:function(){return this.getResizable()},getWBSCode:function(){for(var t=[],n=this;n.parentNode;)t.push(n.data.index+1),n=n.parentNode;return t.reverse().join(".")},resetTotalCount:function(n){for(var t=this;t;)t.totalCount=n?-1:null,t=t.parentNode},getTotalCount:function(){var n=this.totalCount,r=n==-1,t,i,u;if(n==null||r){for(t=this.childNodes,n=t.length,i=0,u=t.length;i<u;i++)n+=t[i].getTotalCount();if(r)return n;this.totalCount=n}return n},getPreviousSiblingsTotalCount:function(){for(var n=this.previousSibling,t=this.data.index;n;)t+=n.getTotalCount(),n=n.previousSibling;return t},getPredecessorsCount:function(){return this.getPreviousSiblingsTotalCount.apply(this,arguments)},getSequenceNumber:function(){for(var t=0,n=this;n.parentNode;)t+=n.getPredecessorsCount()+1,n=n.parentNode;return t},getBySequenceNumber:function(n){var r=null,i,u,t,f;if(n===0)r=this;else if(n>0&&n<=this.getTotalCount())for(n--,t=0,f=this.childNodes.length;t<f;t++)if(i=this.childNodes[t],u=i.getTotalCount(),n>u)n-=u+1;else{i=this.childNodes[t];r=i.getBySequenceNumber(n);break}return r},getDisplayStartDate:function(n,t,i,r,u){return n=n||Ext.Date.defaultFormat,arguments.length<3&&(i=this.getStartDate(),arguments.length<2&&(t=!0)),i&&t&&this.isMilestone(u)&&i-Ext.Date.clearTime(i,!0)==0&&!Ext.Date.formatContainsHourInfo(n)&&(i=Sch.util.Date.add(i,Sch.util.Date.MILLI,-1)),r?i:i?Ext.util.Format.date(i,n):""},getDisplayEndDate:function(n,t,i,r,u){return n=n||Ext.Date.defaultFormat,arguments.length<3&&(i=this.getEndDate(),arguments.length<2&&(t=!0)),i&&(!this.isMilestone(u)||t)&&i-Ext.Date.clearTime(i,!0)==0&&!Ext.Date.formatContainsHourInfo(n)&&(i=Sch.util.Date.add(i,Sch.util.Date.MILLI,-1)),r?i:i?Ext.util.Format.date(i,n):""},copy:function(){var r=this.callParent(arguments),t=r.getSegments(),n,i;if(t)for(n=0;n<t.length;n++)i=t[n],t[n]=i.copy(i.getId(),!1);return r},fullCopy:function(){var n=this.callParent(arguments);return n.taskStore=this.getTaskStore(),n},commit:function(){this.callParent(arguments);this.commitSegments()},reject:function(){this.callParent(arguments);this.rejectSegments()},isUnscheduled:function(){return!this.getStartDate()||!this.getEndDate()},isTaskStored:function(){return!!this.getTreeStore()}},function(){Ext.data.NodeInterface.decorate(this);this.override({insertBefore:function(n,t){var u,f,s;if(n=this.createNode(n),n){var i=this.getTaskStore(!0),c=i&&i.getRoot(),r=this.phantomParentIdField,h=this!==c&&this.phantom,e=!!n.parentNode,o=this.getId();return h&&(this.data[this.phantomIdField]=o),o!==n.data[r]&&(u=h?o:null,n.phantom||n.data[r]===u||(n.modified=n.modified||{},n.modified[r]=n.data[r]),n.data[r]=u),f=t&&t.get("index"),this.resetTotalCount(e),e&&n.hasDependencies()&&!i.isUndoingOrRedoing()&&n.removeDependenciesToParents(this),s=this.callParent(arguments),e&&(this.hasDependencies()&&(i.getDependencyStore().resetMethodsCache(),i.isUndoingOrRedoing()||this.removeInvalidDependencies()),this.resetTotalCount()),t&&t.get("index")!=f&&(t.modified=t.modified||{},t.modified.index=f),s}},appendChild:function(n,t,i){var f,u,o,c;n=n instanceof Array?n:[n];var r=this.getTaskStore(!0),v=r&&r.getRoot(),s=!1,e=this.phantomParentIdField,l=this!==v&&this.phantom,h=this.getId(),a=0;for(r&&n.length>1&&r.suspendAutoRecalculateParents++,f=0;f<n.length;f++)(u=this.createNode(n[f]),u)&&(a++,n[f]=u,u.parentNode&&(s=!0,u.hasDependencies()&&r&&!r.isUndoingOrRedoing()&&u.removeDependenciesToParents(this)),h!==u.data[e]&&(o=l?h:null,u.phantom||u.data[e]===o||(u.modified=u.modified||{},u.modified[e]=u.data[e]),u.data[e]=o));if(a)return l&&(this.data[this.phantomIdField]=h),this.resetTotalCount(s),c=this.callParent([n.length>1?n:n[0],t,i]),s&&(this.hasDependencies()&&(r.getDependencyStore().resetMethodsCache(),r&&!r.isUndoingOrRedoing()&&this.removeInvalidDependencies()),this.resetTotalCount()),r&&!r.isUndoingOrRedoing()&&(this.beginEdit(),this.markAsParent(),this.set(this.schedulingModeField,"Normal"),r&&n.length>1&&r.suspendAutoRecalculateParents--,this.endEdit()),!r||!r.recalculateParents||r.suspendAutoRecalculateParents||this.isRoot()||r.cascading||r.isUndoingOrRedoing()||n[0].recalculateParents(),c},removeChild:function(n,t,i,r){var u=this,o=!u.removeChildIsCalledFromReplaceChild&&u.convertEmptyParentToLeaf&&u.childNodes.length==1,f=u.getTaskStore(!0),e;return u.resetTotalCount(),u.removeChildIsCalledFromReplaceChild=!1,e=u.callParent(arguments),r&&u.resetTotalCount(),u.childNodes.length>0&&f&&f.recalculateParents&&!f.suspendAutoRecalculateParents&&!f.isUndoingOrRedoing()&&u.childNodes[0].recalculateParents(),o&&!u.isRoot()&&f&&!f.isUndoingOrRedoing()&&u.convertEmptyParentToLeafTask(),e},replaceChild:function(){this.removeChildIsCalledFromReplaceChild=!0;this.callParent(arguments)},removeAll:function(){var n=this.isLeaf(),t=this.getTaskStore(!0);this.resetTotalCount();this.callParent(arguments);!n&&this.convertEmptyParentToLeaf&&t&&this.convertEmptyParentToLeafTask()},createNode:function(n){var e=this,t=e.getTaskStore(!0),o=t&&t.getRoot(),i,r,u,f;if(t&&(i=t.getProxy().getReader(),r=i.getChildType,i.getChildType=function(){return r.apply(this,arguments)||this.getModel()}),n=this.callParent(arguments),t&&i&&delete i.getChildType,!t||o===this||!n.isProject)return u=t&&t.autoNormalizeNodes&&!n.normalized&&!n.normalizeScheduled,n=this.callParent(arguments),u&&(f=n.updateInfo,n.updateInfo=function(){f.apply(this,arguments);delete n.updateInfo;n.normalize()},n.normalizeScheduled=!0),n}})});Ext.define("Gnt.model.Project",{extend:Gnt.model.Task,alias:"gntmodel.project",isProject:!0,descriptionField:"Note",allowDependenciesField:"AllowDependencies",customizableFields:[{name:"Description",type:"string"},{name:"AllowDependencies",persist:!1,type:"bool",defaultValue:!1}],recognizedSchedulingModes:["Normal"],convertEmptyParentToLeaf:!1,isEditable:function(n){switch(n){case this.nameField:case this.startDateField:case this.endDateField:case this.readOnlyField:case this.durationField:case this.durationUnitField:case this.descriptionField:case this.allowDependenciesField:return this.callParent(arguments);default:return!1}}});Ext.define("Gnt.patches.TaskStore",{extend:Ext.Mixin,onClassMixedIn:function(n){Ext.getVersion().isGreaterThan("5.1.1")&&Ext.override(n,{onTasksLoad:function(){this._refreshCalled||this.onTasksLoaded();this.un("refresh",this.onTaskStoreRefresh,this)},onTasksBeforeLoad:function(){this._refreshCalled=!1;this.on("refresh",this.onTaskStoreRefresh,this,{priority:100})},onTaskStoreRefresh:function(){this._refreshCalled=!0;this.onTasksLoaded()},setupListeners:function(){this.callParent(arguments);this.on("beforeload",this.onTasksBeforeLoad,this,{priority:100});this.un({load:this.onTasksLoaded,rootchanged:this.onTasksLoaded,scope:this});this.on({load:this.onTasksLoad,rootchanged:this.onTasksLoad,scope:this})}})}});Ext.define("Gnt.data.undoredo.mixin.TaskStoreHint",{extend:Robo.data.Store,segmentsStateByTaskId:null,onSegmentEditBegin:function(n){var t=this;this.segmentsStateByTaskId=this.segmentsStateByTaskId||{};this.segmentsStateByTaskId.hasOwnProperty(n.internalId)||(this.segmentsStateByTaskId[n.internalId]=n.buildSegmentsSnapshot())},onSegmentEditEnd:function(n){var t=this;t.isInUndoRedoTransaction()||delete this.segmentsStateByTaskId[n.internalId]},onUndoRedoTransactionEnd:function(n,t){var i=this;this.segmentsStateByTaskId=null;i.callParent([n,t])},getOriginalSegmentsState:function(n){var t=this.segmentsStateByTaskId&&this.segmentsStateByTaskId[n.internalId],i;return t||(i=(n.previous||n.previousValues)[n.segmentsField],i&&(t=n.buildSegmentsSnapshot(i))),t}});Ext.define("Gnt.data.mixin.ProjectableStore",function(){function n(n,t){return n.byInternalIdMap&&n.byInternalIdMap[t]||n.getByInternalId(t)}function t(){var t=this,n=t.projectionStack;return n&&n[n.length-1]}function i(){var t=this,n=t.projectionStack;return n&&n.length||0}function r(){return this.getProjectionLevel()>0}function u(n){var t,r,i;for(n=[].concat(n),i=!1,t=0,r=n.length;!i&&t<r;t++)i=n[t].isProjected();return i}function f(){var n=this,t=n.projectionStack,i,r;t?(r=t[t.length-1],i={},Ext.Object.each(r,function(n,t){var r=function(){};r.prototype=t;i[n]=new r}),t.push(i)):n.projectionStack=[{}];n.fireEvent("projectionstart",n,n.getProjectionLevel())}function e(){var u=this,r=u.projectionStack,f,i,h,e,o,t,s;if(r.length===1){i=r[0];u.projectionStack=null;for(t in i)if(i.hasOwnProperty(t)&&(s=n(u,t),s)){e=i[t];o=!1;for(h in e)if(e.hasOwnProperty(h)){o=!0;break}o&&s.set(e)}}else{i=r.pop();f=r[r.length-1];for(t in i)i.hasOwnProperty(t)&&(f[t]=f.hasOwnProperty(t)?Ext.apply(f[t],i[t]):i[t])}u.fireEvent("projectioncommit",u,r&&r[r.length-1],i,u.getProjectionLevel())}function o(){var n=this,t=n.projectionStack,i=t.pop();t.length===0&&(n.projectionStack=null);n.fireEvent("projectionreject",n,t&&t[t.length-1],i,n.getProjectionLevel())}return{projectionStack:null,getProjection:t,isProjecting:r,areProjected:u,getProjectionLevel:i,startProjection:f,commitProjection:e,rejectProjection:o}});Ext.define("Gnt.data.TaskStore",{extend:Ext.data.TreeStore,mixins:[Gnt.patches.TaskStore,Sch.data.mixin.FilterableTreeStore,Sch.data.mixin.UniversalModelGetter,Sch.data.mixin.CacheHintHelper,Sch.data.mixin.EventStore,Gnt.data.undoredo.mixin.TaskStoreHint,Gnt.data.mixin.ProjectableStore],model:"Gnt.model.Task",alias:"store.gantt_taskstore",storeId:"tasks",typeProperty:"TaskType",calendarManager:null,calendar:null,dependencyStore:null,resourceStore:null,assignmentStore:null,weekendsAreWorkdays:!1,cascadeChanges:!0,batchSync:!0,recalculateParents:!0,skipWeekendsDuringDragDrop:!0,cascadeDelay:0,moveParentAsGroup:!0,enableDependenciesForParentTasks:!0,availabilitySearchLimit:1825,cycleResolutionStrategy:"cut",autoNormalizeNodes:!0,cascading:!1,isFillingRoot:!1,isSettingRoot:!1,earlyStartDates:null,earlyEndDates:null,lateStartDates:null,lateEndDates:null,lastTotalTimeSpan:null,suspendAutoRecalculateParents:0,suspendAutoCascade:0,currentCascadeBatch:null,batchCascadeLevel:0,fillTasksWithDepInfoCounter:0,dependenciesCalendar:"project",pendingDataUpdates:null,tasksLoadStarted:0,constructor:function(n){var s,t,f,r,i,u,e,o;n=n||{};s="calendarManager"in n?n.calendarManager:this.calendarManager;delete n.calendarManager;this.setCalendarManager(s);t=n.calendar||this.calendar;t||(f={},n.hasOwnProperty("weekendsAreWorkdays")?f.weekendsAreWorkdays=n.weekendsAreWorkdays:this.self.prototype.hasOwnProperty("weekendsAreWorkdays")&&this.self!=Gnt.data.TaskStore&&(f.weekendsAreWorkdays=this.weekendsAreWorkdays),this.calendarManager&&(t=this.calendarManager.getProjectCalendar()),t=t&&Ext.data.StoreManager.lookup(t)||new Gnt.data.Calendar(f));r=n.dependencyStore||this.dependencyStore;r=r&&Ext.data.StoreManager.lookup(r)||Ext.create("Gnt.data.DependencyStore");delete n.dependencyStore;i=n.resourceStore||this.resourceStore;i=i&&Ext.data.StoreManager.lookup(i)||Ext.create("Gnt.data.ResourceStore");delete n.resourceStore;u=n.assignmentStore||this.assignmentStore;u=u&&Ext.data.StoreManager.lookup(u)||Ext.create("Gnt.data.AssignmentStore",{resourceStore:i});delete n.assignmentStore;t&&(delete n.calendar,this.setCalendar(t,!0,!0));this.resetEarlyDates(!0);this.resetLateDates(!0);this.pendingDataUpdates={recalculateParents:{}};e=n.root||this.root;this.root=null;delete n.root;this.callParent([n]);this.setResourceStore(i);this.setAssignmentStore(u);this.setDependencyStore(r);e&&this.setRoot(e);this.setupListeners();this.fillTasksWithDepInfo();o=this.getRoot();o&&this.autoNormalizeNodes&&o.normalizeParent();this.autoSync&&this.batchSync&&(this.sync=Ext.Function.createBuffered(this.sync,500));this.initTreeFiltering()},setCalendarManager:function(n){return this.calendarManagerListeners&&this.calendarManagerListeners.destroy(),n=n&&Ext.data.StoreManager.lookup(n),this.calendarManager=n,n&&(this.projectCalendarSet=Boolean(n.getProjectCalendar()),this.calendarManagerListeners=n.on({projectcalendarset:function(n,t){this.settingCalendar||(this.setCalendar(t,!this.projectCalendarSet),this.projectCalendarSet=!0)},scope:this,destroyable:!0})),n},onProjectionCommit:function(n,t,i){var r,u;for(r in i)i.hasOwnProperty(r)&&(u=this.getModelByInternalId(r),u&&u.commitSegmentsProjection())},onProjectionReject:function(n,t,i){var r,u;for(r in i)i.hasOwnProperty(r)&&(u=this.getModelByInternalId(r),u&&u.rejectSegmentsProjection())},setupListeners:function(){this.on({nodeappend:this.onMyNodeAdded,nodeinsert:this.onMyNodeAdded,update:this.onTaskUpdated,projectioncommit:this.onProjectionCommit,projectionreject:this.onProjectionReject,scope:this});this.on({noderemove:this.onTaskRemoved,nodemove:this.onTaskMoved,write:this.onTaskStoreWrite,sort:this.onTasksSorted,load:this.onTasksLoaded,rootchange:this.onTasksRootChange,scope:this,priority:100})},createResourceEventsCache:Ext.emptyFn,createIdConsistencyManager:function(){var n=this;return new Gnt.data.util.IdConsistencyManager({eventStore:n,resourceStore:n.getResourceStore(),assignmentStore:n.getAssignmentStore(),dependencyStore:n.getDependencyStore()})},createModelPersistencyManager:function(){var n=this;return new Gnt.data.util.ModelPersistencyManager({eventStore:n,resourceStore:n.getResourceStore(),assignmentStore:n.getAssignmentStore(),dependencyStore:n.getDependencyStore()})},fillNode:function(n){n.isRoot()&&(this.isSettingRoot=!0);this.callParent(arguments);n.isRoot()&&(this.isSettingRoot=!1)},onTasksRootChange:function(){var n=this.getRoot();this.fillTasksWithDepInfoCounter=1;this.fillTasksWithDepInfo();n&&this.autoNormalizeNodes&&n.normalizeParent()},onTasksLoaded:function(){this.onTasksRootChange();this.onTasksLoadEnd()},onTasksLoadStart:function(){this.tasksLoadStarted++;this.suspendAutoRecalculateParents++;this.un("noderemove",this.onTaskRemoved,this);this.un("nodeappend",this.onMyNodeAdded,this);this.un("update",this.onTaskUpdated,this)},onTasksLoadEnd:function(){if(this.lastTotalTimeSpan=null,this.tasksLoadStarted>0||Ext.Error.raise("Invalid tasksLoadStarted flag state, should be greater than zero at this point"),this.tasksLoadStarted--,!this.tasksLoadStarted){this.on("noderemove",this.onTaskRemoved,this);this.on("nodeappend",this.onMyNodeAdded,this);this.on("update",this.onTaskUpdated,this)}this.suspendAutoRecalculateParents--},load:function(){this.on("beforeload",this.onTasksLoadStart,this,{priority:-999,single:!0});this.callParent(arguments)},setProxy:function(){if(this.callParent(arguments),this.typeProperty){var n=this,t=n.getProxy()&&n.getProxy().getReader();t&&!t.getTypeProperty()&&t.setTypeProperty(n.typeProperty)}},setRoot:function(n){var t=this,i=this.count()&&this.getRoot(),r;return this.isSettingRoot=!0,Ext.apply(n,{calendar:t.calendar,taskStore:t,dependencyStore:t.dependencyStore,phantom:!1,dirty:!1}),r=this.callParent(arguments),this.isSettingRoot=!1,i&&i.cascadeBy(function(n){n.setTaskStore(null)}),r},getDependencyStore:function(){return this.dependencyStore},fillTasksWithDepInfo:function(){if(this.getRoot()){var n=this.getDependencyStore();this.fillTasksWithDepInfoCounter++>0&&this.forEachTaskUnordered(function(n){n.successors=[];n.predecessors=[]});n&&n.each(function(n){var t=n.getSourceTask(),i=n.getTargetTask();t&&i&&(t.successors.push(n),i.predecessors.push(n))})}},fillSingleTaskWithDepInfo:function(n,t){var r=this,i=n.getDependencyStore();i&&(n.successors=[],n.predecessors=[],i.each(function(i){var u=i.getSourceTask(),r=i.getTargetTask();u===n&&r&&(n.successors.push(i),r.predecessors||(r.predecessors=[]),Ext.Array.contains(r.predecessors,i)||r.predecessors.push(i),t&&t(u,r));r===n&&u&&(n.predecessors.push(i),r.successors||(r.successors=[]),Ext.Array.contains(u.successors,i)||u.successors.push(i),t&&t(u,r))}))},setDependencyStore:function(n){var t=this,i=t.dependencyStore,r={add:t.onDependencyAdd,update:t.onDependencyUpdate,remove:t.onDependencyDelete,scope:t};if(i&&i.isStore&&(i.un(r),i.setTaskStore(null),t.idConsistencyManager&&t.idConsistencyManager.setDependencyStore(null),t.modelPersistencyManager&&t.modelPersistencyManager.setDependencyStore(null)),t.dependencyStore=n&&Ext.StoreMgr.lookup(n)||null,t.dependencyStore){t.modelPersistencyManager&&t.modelPersistencyManager.setDependencyStore(t.dependencyStore);t.idConsistencyManager&&t.idConsistencyManager.setDependencyStore(t.dependencyStore);t.dependencyStore.setTaskStore(t);t.dependencyStore.on(r);t.fillTasksWithDepInfo()}(i||n)&&i!==n&&t.events&&t.fireEvent("dependencystorechange",t,n,i)},getResourceStore:function(){return this.resourceStore||null},setResourceStore:function(n){var t=this,i=t.resourceStore;i&&i.isStore&&(i.setTaskStore(null),t.idConsistencyManager&&t.idConsistencyManager.setResourceStore(null),t.modelPersistencyManager&&t.modelPersistencyManager.setResourceStore(null));t.resourceStore=n&&Ext.StoreMgr.lookup(n)||null;t.resourceStore&&(t.modelPersistencyManager&&t.modelPersistencyManager.setResourceStore(t.resourceStore),t.idConsistencyManager&&t.idConsistencyManager.setResourceStore(t.resourceStore),t.resourceStore.setTaskStore(t),t.resourceStore.normalizeResources());(i||n)&&i!==n&&t.events&&t.fireEvent("resourcestorechange",t,n,i)},getAssignmentStore:function(){return this.assignmentStore||null},setAssignmentStore:function(n){var t=this,i=t.assignmentStore,r={add:t.onAssignmentStructureMutation,update:t.onAssignmentMutation,remove:t.onAssignmentStructureMutation,scope:t};if(i&&i.isStore&&(i.un(r),i.setTaskStore(null),t.idConsistencyManager&&t.idConsistencyManager.setAssignmentStore(null),t.modelPersistencyManager&&t.modelPersistencyManager.setAssignmentStore(null)),t.assignmentStore=n&&Ext.StoreMgr.lookup(n)||null,t.assignmentStore){t.modelPersistencyManager&&t.modelPersistencyManager.setAssignmentStore(t.assignmentStore);t.idConsistencyManager&&t.idConsistencyManager.setAssignmentStore(t.assignmentStore);n.setTaskStore(t);n.on(r)}(i||n)&&i!==n&&t.events&&t.fireEvent("assignmentstorechange",t,n,i)},adjustToCalendar:function(n,t){var r=this;if(r.resetEarlyDates(),r.resetLateDates(),n instanceof Gnt.model.Task)n.adjustToCalendar(t);else{Ext.isFunction(n)&&(t=n,n=[]);var i=r.getRoot(),f={},u=!1;Ext.isArray(n)&&n.length||(n=i&&i.childNodes||[],u=!0);i&&i.propagateChanges(function(){for(var t,r=[],f=0,e=n.length;f<e;f++)t=n[f],t.cascadeBy(function(n){n!==i&&n.adjustToCalendarWithoutPropagation()}),u&&t.hasIncomingDependencies()||r.push(t);return r.length&&r||!1},function(n,i){n||Ext.apply(f,i);t&&t.apply(this,arguments)})}},renormalizeTasks:function(n,t,i){this.adjustToCalendar(t,i)},getCalendar:function(){return this.calendar||null},setCalendar:function(n,t,i){var r,u;if(!this.settingCalendar){if(this.settingCalendar=!0,r={calendarchange:this.renormalizeTasks,scope:this},this.calendar&&this.calendar.un(r),this.calendar=n,n){n.on(r);u=this.getRoot();u&&(u.calendar=n);t||this.renormalizeTasks();i||this.fireEvent("calendarset",this,n);this.calendarManager&&this.calendarManager.setProjectCalendar(n)}this.settingCalendar=!1}},getCriticalPaths:function(){var t=[],i=this.getProjects(),n=new Date(0),r=i.length===0?[this.getRoot()]:i;return Ext.Array.each(r,function(i){i.cascadeBy(function(t){n=Sch.util.Date.max(t.getEndDate(),n)});i.cascadeBy(function(i){n-i.getEndDate()!=0||i.isRoot()||!i.isLeaf()&&i.childNodes.length||t.push(i)})}),Ext.Array.map(t,function(n){return n.getCriticalPaths()})},onMyNodeAdded:function(n,t){var i=this,r;t.isRoot()||(i.lastTotalTimeSpan&&(r=i.getTotalTimeSpan(),(t.getEndDate()>r.end||t.getStartDate()<r.start)&&(i.lastTotalTimeSpan=null)),t.getEndDate()-i.getProjectEndDate()==0&&i.resetLateDates(),t.cascadeBy(function(n){i.fillSingleTaskWithDepInfo(n,function(n,t){!i.isUndoingOrRedoing()&&i.getDependencyStore()&&i.getDependencyStore().scheduleLinkedTasks(n,t)})}),!i.cascadeChanges||i.suspendAutoCascade||i.isUndoingOrRedoing()||t.getParentsIncomingDependencies().length&&t.alignByIncomingDependenciesWithoutPropagation(),i.cascading||!i.recalculateParents||i.suspendAutoRecalculateParents||i.isUndoingOrRedoing()||(i.updating?i.pendingDataUpdates.recalculateParents[t.getId()]=t:t.recalculateParents()))},onTaskUpdated:function(n,t,i){var r=t.previous,u,e,f,o;this.lastTotalTimeSpan&&(u=this.getTotalTimeSpan(),(r&&(r[t.endDateField]-u.end==0||r[t.startDateField]-u.start==0)||t.getEndDate()>u.end||t.getStartDate()<u.start)&&(this.lastTotalTimeSpan=null));this.cascading||i===Ext.data.Model.COMMIT||!r||this.isUndoingOrRedoing()||(e=t.percentDoneField in r,t.startDateField in r||t.endDateField in r||"parentId"in r||t.effortField in r||r[t.schedulingModeField]==="Manual"||r[t.manuallyScheduledField]?(f=t,this.cascadeChanges&&!this.suspendAutoCascade?(r[f.schedulingModeField]=="Manual"&&(o=f.getIncomingDependencies(!0),o.length&&(f=o[0].getSourceTask())),Ext.Function.defer(this.cascadeChangesForTask,this.cascadeDelay,this,[f])):(this.resetEarlyDates(),this.resetLateDates()),e=!0):(r[t.schedulingModeField]||t.manuallyScheduledField in r)&&t.isManuallyScheduled()&&(this.resetEarlyDates(),this.resetLateDates()),e&&this.recalculateParents&&!this.suspendAutoRecalculateParents&&(this.updating?this.pendingDataUpdates.recalculateParents[t.getId()]=t:t.recalculateParents()))},onEndUpdate:function(){var t=this,n={},i;if(!this.isUndoingOrRedoing())for(Ext.Object.each(t.pendingDataUpdates.recalculateParents,function(t,i){i.parentNode&&(n[i.parentNode.getId()]=i.parentNode)}),n=Ext.Array.sort(Ext.Object.getValues(n),function(n,t){return n.data.depth>t.data.depth?1:n.data.depth<t.data.depth?-1:0});n.length>0;)i=n.pop(),i.refreshCalculatedParentNodeData(),i.recalculateParents();return t.pendingDataUpdates.recalculateParents={},t.callParent(arguments)},getEmptyCascadeBatch:function(){var n=this;return{nbrAffected:0,affected:{},visitedCounters:{},addVisited:function(n){var t=n.internalId;this.visitedCounters[t]?this.visitedCounters[t]++:this.visitedCounters[t]=1},addAffected:function(t,i){var u=t.internalId;if(!this.affected[u]&&(this.affected[u]=t,this.nbrAffected++,!n.cascading&&this.nbrAffected>1&&(n.fireEvent("beforecascade",n),n.cascading=!0),!i))for(var f=this.affectedParentsbyInternalId,e=this.affectedParentsArray,r=t.isLeaf()?t.parentNode:t;r&&!r.data.root;){if(f[r.internalId])break;f[r.internalId]=r;e.push(r);this.addAffected(r,!0);r=r.parentNode}},affectedParentsArray:[],affectedParentsbyInternalId:{},parentsStartDates:{}}},startBatchCascade:function(){return this.batchCascadeLevel||(this.currentCascadeBatch=this.getEmptyCascadeBatch(),this.suspendAutoRecalculateParents++,this.suspendAutoCascade++),this.batchCascadeLevel++,this.currentCascadeBatch},endBatchCascade:function(){if(this.batchCascadeLevel--,!this.batchCascadeLevel){this.suspendAutoRecalculateParents--;this.suspendAutoCascade--;var n=this.currentCascadeBatch;this.currentCascadeBatch=null;this.resetEarlyDates();this.resetLateDates();this.cascading&&(this.cascading=!1,this.fireEvent("cascade",this,n))}},cascadeChangesForTask:function(n,t){n.propagateChanges(Ext.emptyFn,t,!0)},removeTaskDependencies:function(n){var t=this.dependencyStore,i=n.getAllDependencies(t);i.length&&t.remove(i)},removeTaskAssignments:function(n){var i=this.getAssignmentStore(),t=n.getAssignments();t.length&&i.remove(t)},onTaskRemoved:function(n,t,i){var e=this.getDependencyStore(),r=this.getAssignmentStore(),u=!t.isReplace&&!i;e&&u&&t.cascadeBy(this.removeTaskDependencies,this);r&&u&&(r.fireEvent("beforetaskassignmentschange",r,t.getId(),[]),t.cascadeBy(this.removeTaskAssignments,this),r.fireEvent("taskassignmentschanged",r,t.getId(),[]));var f=this.getTotalTimeSpan(),o=t.getStartDate(),s=t.getEndDate();(s-f.end==0||o-f.start==0)&&(this.lastTotalTimeSpan=null);u&&t.setTaskStore(null);this.resetEarlyDates();this.resetLateDates()},onTaskMoved:function(n){var t=this.getTotalTimeSpan(),i=n.getStartDate(),r=n.getEndDate();(r-t.end==0||i-t.start==0)&&(this.lastTotalTimeSpan=null);this.resetEarlyDates();this.resetLateDates()},onAssignmentMutation:function(n,t){var i=this;this.isUndoingOrRedoing()||Ext.Array.each([].concat(t),function(n){var t=n.getTask(i);if(t)t.onAssignmentMutation(n)})},onAssignmentStructureMutation:function(n,t){var i=this;this.isUndoingOrRedoing()||Ext.Array.each([].concat(t),function(n){var t=n.getTask(i);if(t)t.onAssignmentStructureMutation(n)})},onDependencyUpdate:function(n,t,i){if(i!==Ext.data.Model.COMMIT)this.onDependencyAdd(n,t)},onDependencyAdd:function(n,t){var r=this,u,i;r.resetEarlyDates();r.resetLateDates();!r.cascadeChanges||r.suspendAutoCascade||r.isUndoingOrRedoing()||(i=[],Ext.isArray(t)?(Ext.Array.each(t,function(n){u=n.getSourceTask();u&&i.push(u)}),i.length&&r.getRoot().propagateChanges(function(){return i})):(i=t.getSourceTask(),i&&i.propagateChanges()))},onDependencyDelete:function(){this.resetEarlyDates();this.resetLateDates()},onTaskStoreWrite:function(n,t){var r=this,u=t.getRecords(),i;Ext.Array.each(u,function(n){Ext.each(n.childNodes,function(n){if(n.phantom)return i=!0,!1})});i&&!this.autoSync&&setTimeout(function(){r.sync()},1)},forEachTaskUnordered:function(n,t){var i=this.getRoot();i&&i.cascadeBy(function(r){if(r!==i)return n.call(t||this,r)})},getTimeSpanForTasks:function(n){var t=new Date(9999,0,1),i=new Date(0),r=function(n){var r=n.getStartDate(),u=n.getEndDate();r&&r<t&&(t=r);r&&u&&u>i&&(i=u)};return n?(Ext.isArray(n)||(n=[n]),Ext.Array.each(n,r)):this.forEachTaskUnordered(r),t=t<new Date(9999,0,1)?t:null,i=i>new Date(0)?i:null,{start:t,end:i||t&&Ext.Date.add(t,Ext.Date.DAY,1)||null}},getTotalTimeSpan:function(){return this.lastTotalTimeSpan?this.lastTotalTimeSpan:(this.lastTotalTimeSpan=this.getTimeSpanForTasks(),this.lastTotalTimeSpan)},getProjectStartDate:function(){return this.getTotalTimeSpan().start},getProjectEndDate:function(){return this.getTotalTimeSpan().end},getProjects:function(){for(var r=this.getRoot(),i=[],t=r.childNodes,n=0,u=t.length;n<u;n++)t[n].isProject&&i.push(t[n]);return i},getTotalTaskCount:function(n){var t=n===!1?1:0;return this.forEachTaskUnordered(function(){t++}),t},toArray:function(){var n=[];return this.getRoot().cascadeBy(function(t){n.push(t)}),n},beginIndent:function(n,t){this.fireEvent("beforeindentationchange",this,n,t)},endIndent:function(n,t){this.fireEvent("indentationchange",this,n,t)},indent:function(n,t){var i=this,e=!1,r={},u,f;n=Ext.isArray(n)?n.slice():[n];n=Ext.Array.filter(n,function(t){for(var i=!!t.previousSibling;i&&!t.isRoot();)i=!Ext.Array.contains(n,t.parentNode),t=t.parentNode;return i});n=Ext.Array.sort(n,function(n,t){return n.get("index")-t.get("index")});u=Ext.Array.reduce(n,function(n,t){return n[t.getId()]={parentNode:t.parentNode,index:t.get("index")},n},{});i.beginIndent(n,u);i.suspendEvent("beforeindentationchange","indentationchange");f=n.slice(),function o(){f.length?f.shift().indent(function(n,t){n?(e=!0,r={}):(r=Ext.apply(r,t),o())}):(i.resumeEvent("beforeindentationchange","indentationchange"),i.endIndent(n,u),t&&t(e,r))}()},outdent:function(n,t){var i=this,e=!1,r={},u,f;n=Ext.isArray(n)?n.slice():[n];n=Ext.Array.filter(n,function(t){for(var i=t.parentNode&&!t.parentNode.isRoot();i&&!t.isRoot();)i=!Ext.Array.contains(n,t.parentNode),t=t.parentNode;return i});n=Ext.Array.sort(n,function(n,t){return t.get("index")-n.get("index")});u=Ext.Array.reduce(n,function(n,t){return n[t.getId()]={parentNode:t.parentNode,index:t.get("index")},n},{});i.beginIndent(n,u);i.suspendEvent("beforeindentationchange","indentationchange");f=n.slice(),function o(){f.length?f.shift().outdent(function(n,t){n?(e=!0,r={}):(r=Ext.apply(r,t),o())}):(i.resumeEvent("beforeindentationchange","indentationchange"),i.endIndent(n,u),t&&t(e,r))}()},getTasksForResource:function(n){return this.getEventsForResource(n)},getResourcesForTask:function(n){return this.getResourcesForEvent(n)},forEachScheduledEvent:function(n,t){t=t||this;this.forEachTaskUnordered(function(i){var r=i.getStartDate(),u=i.getEndDate();if(r&&u)return n.call(t,i,r,u)})},onTasksSorted:function(){this.lastTreeFilter&&this.filterTreeBy(this.lastTreeFilter)},append:function(n){return this.getRoot().appendChild(n)},resetEarlyDates:function(n){this.earlyStartDates={};this.earlyEndDates={};n||this.fireEvent("resetearlydates")},resetLateDates:function(n){this.lateStartDates={};this.lateEndDates={};n||this.fireEvent("resetlatedates")},getBySequenceNumber:function(n){return this.getRoot().getBySequenceNumber(n)},destroy:function(){this.setCalendar(null);this.setCalendarManager(null);this.setAssignmentStore(null);this.setDependencyStore(null);this.setResourceStore(null);this.calendarManagerListeners&&this.calendarManagerListeners.destroy();this.callParent(arguments)},moveSeveralTasks:function(n){for(var r=this.startBatchCascade(),i,t;i=n();)t=i.task,t.isLeaf()||!t.childNodes.length?r.affected[t.internalId]||(r.addAffected(t),i.method&&t[i.method].apply(t,i.args),this.cascadeChanges&&this.cascadeChangesForTask(t)):this.recalculateParents&&r.addAffected(t);this.endBatchCascade()},linearWalkDependentTasks:function(n,t,i){var r=this;return!i||Ext.isObject(i)||Ext.Error.raise("Invalid arguments: walking specification must be an object"),i=i||{self:!0,ancestors:r.recalculateParents,descendants:r.moveParentAsGroup,successors:r.cascadeChanges,cycles:r.cycleResolutionStrategy},Gnt.data.Linearizator.linearWalkBySpecification(n,t,i)},getLinearWalkingSequenceForDependentTasks:function(n,t){var i=[];return this.linearWalkDependentTasks(n,function(){i.push(Array.prototype.slice.call(arguments))},t),i},isVisible:function(n){for(var t=n.parentNode,i=n.get("visible"),r=this.getRoot();i&&t;)i=t.get("expanded")&&t.get("visible"),t=t.parentNode;return i&&!(n===r&&!this.getRootVisible())},removeTasks:function(n){return n=[].concat(n),n=Ext.Array.filter(n,function(n){return!n.parentNode||!n.parentNode.isReadOnly()}),n=Ext.Array.sort(n,function(n,t){return t.getDepth()-n.getDepth()}),this.fireEvent("beforebatchremove",this,n),Ext.Array.forEach(n,function(n){n.remove()}),this.fireEvent("batchremove",this,n),n}});Ext.define("Gnt.data.calendar.BusinessTime",{extend:Gnt.data.Calendar,daysPerMonth:20,daysPerWeek:5,hoursPerDay:8,defaultAvailability:["08:00-12:00","13:00-17:00"]});Ext.define("Gnt.data.undoredo.Manager",{extend:Robo.Manager,getStoreTypeListeners:function(n){var t=this,i=t.callParent([n]);return n instanceof Gnt.data.TaskStore&&(i.update=t.onTaskStoreUpdate,i.projectionstart=t.onTaskStoreProjectionStart,i.projectioncommit=t.onTaskStoreProjectionEnd,i.projectionreject=t.onTaskStoreProjectionEnd),i},onTaskStoreUpdate:function(n,t,i,r){this.onAnyChangeInAnyStore(n)&&i=="edit"&&r&&r.length&&this.hasPersistableChanges(t,r)&&this.currentTransaction.addAction(new Gnt.data.undoredo.action.taskstore.Update({record:t,fieldNames:r}))},onTaskStoreProjectionStart:function(n,t){var i=this;if(t==1&&i.transactionBoundary==="timeout"){if(!i.currentTransaction)i.onAnyChangeInAnyStore(n);i.currentTransaction&&i.hold()}},onTaskStoreProjectionEnd:function(n,t,i,r){var u=this;r===0&&u.transactionBoundary==="timeout"&&u.currentTransaction&&u.release()}});Ext.define("Gnt.data.undoredo.action.taskstore.Update",{extend:Robo.action.tree.Update,getSerializedSegments:function(n){return n?Ext.Array.map(n,function(n){return Ext.clone(n.data)}):n},processSavingOldValue:function(n,t){var i=this;return n==t.segmentsField?t.getTaskStore().getOriginalSegmentsState(t):i.callParent([n,t])},processSavingNewValue:function(n,t){var i=this;return n===t.segmentsField?t.buildSegmentsSnapshot():i.callParent([n,t])},processRestoringValue:function(n,t,i){var r=this;return t==i.segmentsField?(i.rollbackSegmentsToSnapshot(n),n=r.self.CUSTOMLY_PROCESSED):n=r.callParent([n,t,i]),n}});Ext.define("Gnt.feature.DependencyDragZone",{extend:Ext.dd.DragZone,mixins:{observable:Ext.util.Observable},rtl:null,useLineProxy:null,terminalSelector:null,ganttView:null,fromText:null,toText:null,startText:null,endText:null,toolTipTpl:null,constructor:function(n,t){this.mixins.observable.constructor.call(this,t);this.callParent(arguments)},initLineProxy:function(n,t){var i=this.lineProxyEl=this.lineProxyEl||this.el.createChild({cls:"sch-gantt-connector-proxy"}),r=Ext.isIE9m?0:4,f=this.rtl?t?"r":"l":t?"l":"r",u=this.ganttView.getScroll();i.alignTo(n,f,[t?-r:r,0]);Ext.apply(this,{containerTop:this.el.getTop(),containerLeft:this.el.getLeft(),startXY:i.getXY(),startScrollLeft:u.left,startScrollTop:u.top})},onDrag:function(n){this.useLineProxy&&this.updateLineProxy(n.getXY())},updateLineProxy:function(n){var v=this.lineProxyEl,t=this.ganttView.getScroll(),r=n[0]-this.startXY[0]+t.left-this.startScrollLeft,u=n[1]-this.startXY[1]+t.top-this.startScrollTop,o=Math.max(1,Math.sqrt(Math.pow(r,2)+Math.pow(u,2))-2),f=Math.atan2(u,r)-Math.PI/2,e,i;if(Ext.isIE9m){var s=Math.cos(f),h=Math.sin(f),c='progid:DXImageTransform.Microsoft.Matrix(sizingMethod="auto expand", M11 = '+s+", M12 = "+-h+", M21 = "+h+", M22 = "+s+")",l,a;l=t.top!==this.startScrollTop?this.startScrollTop-this.containerTop:t.top-this.containerTop;a=t.left!==this.startScrollLeft?this.startScrollLeft-this.containerLeft:t.left-this.containerLeft;e={height:o+"px",top:Math.min(0,u)+this.startXY[1]+l+(u<0?2:0)+"px",left:Math.min(0,r)+this.startXY[0]+a+(r<0?2:0)+"px",filter:c,"-ms-filter":c}}else i="rotate("+f+"rad)",e={height:o+"px","-o-transform":i,"-webkit-transform":i,"-ms-transform":i,"-moz-transform":i,transform:i};v.setStyle(e)},onStartDrag:function(){if(this.el.addCls("sch-gantt-dep-dd-dragging"),this.proxy.el.addCls("sch-dd-dependency-proxy"),this.fireEvent("dndstart",this),this.useLineProxy){var n=this.dragData;this.initLineProxy(n.sourceNode,n.isStart);this.lineProxyEl.show()}},getDragData:function(n){var t=n.getTarget(this.terminalSelector),i;if(t){if(i=this.ganttView.resolveTaskRecord(t),this.fireEvent("beforednd",this,i)===!1)return null;var r=!!t.className.match("sch-gantt-terminal-start"),u={fromLabel:this.fromText,fromTaskName:Ext.String.htmlEncode(i.getName()),fromSide:r?this.startText:this.endText,toLabel:this.toText,toTaskName:"",toSide:""},f=Ext.core.DomHelper.createDom({html:this.toolTipTpl.apply(u)}).firstChild;return{fromId:i.getId()||i.internalId,tplData:u,isStart:r,repairXY:Ext.fly(t).getXY(),ddel:f,sourceNode:Ext.fly(t).up(this.ganttView.eventSelector)}}return!1},afterRepair:function(){this.el.removeCls("sch-gantt-dep-dd-dragging");this.dragging=!1;this.fireEvent("afterdnd",this)},onMouseUp:function(){if(this.el.removeCls("sch-gantt-dep-dd-dragging"),this.lineProxyEl){var t=Ext.isIE9m?0:400,n=this.lineProxyEl;n.animate({to:{height:0},duration:t,callback:function(){Ext.destroy(n)}});this.lineProxyEl=null}},getRepairXY:function(){return this.dragData.repairXY},destroy:function(){Ext.destroy(this.lineProxyEl);this.callParent(arguments)}});Ext.define("Gnt.feature.DependencyDropZone",{extend:Ext.dd.DropZone,mixins:{observable:Ext.util.Observable},terminalSelector:null,dependencyStore:null,toText:null,startText:null,endText:null,ganttView:null,constructor:function(n,t){this.mixins.observable.constructor.call(this,t);this.callParent(arguments)},getTargetFromEvent:function(n){return n.getTarget(this.terminalSelector)},onNodeEnter:function(n){Ext.fly(n).addCls("sch-gantt-terminal-drophover")},onNodeOut:function(n,t,i,r){Ext.fly(n).removeCls("sch-gantt-terminal-drophover");this.toolTipTpl.overwrite(t.proxy.el.down(".sch-dd-dependency"),r.tplData)},onNodeOver:function(n,t,i,r){var u=this.ganttView.resolveTaskRecord(n),o=u.getId()||u.internalId,s=n.className.match("sch-gantt-terminal-start"),f={},e;return Ext.apply(f,{toLabel:this.toText,toTaskName:Ext.String.htmlEncode(u.getName()),toSide:s?this.startText:this.endText},r.tplData),this.toolTipTpl.overwrite(t.proxy.el.down(".sch-dd-dependency"),f),e=this.resolveType(r.isStart,n),this.dependencyStore.isValidDependency(r.fromId,o,e)?this.dropAllowed:this.dropNotAllowed},onNodeDrop:function(n,t,i,r){var f=this.resolveType(r.isStart,n),u,e=this.ganttView.resolveTaskRecord(n),o=e.getId()||e.internalId;return this.el.removeCls("sch-gantt-dep-dd-dragging"),u=this.dependencyStore.isValidDependency(r.fromId,o,f),u&&this.fireEvent("drop",this,r.fromId,o,f),this.fireEvent("afterdnd",this),u},resolveType:function(n,t){var i=Gnt.model.Dependency.Type,r=t.className.match("sch-gantt-terminal-start");return n&&r?i.StartToStart:n&&!r?i.StartToEnd:!n&&r?i.EndToStart:i.EndToEnd}});Ext.define("Gnt.feature.DependencyDragDrop",{extend:Ext.util.Observable,mixins:{localizable:Gnt.mixin.Localizable},useLineProxy:!0,dragZoneConfig:null,dropZoneConfig:null,toolTipTpl:['<div class="sch-dd-dependency">',"<table><tbody>","<tr>",'<td><span class="sch-dd-dependency-from">{fromLabel}:<\/span><\/td>','<td><span class="sch-dd-dependency-from-name">{fromTaskName}<\/span> - {fromSide}<\/td>',"<\/tr>","<tr>",'<td><span class="sch-dd-dependency-to">{toLabel}:<\/span><\/td>','<td><span class="sch-dd-dependency-to-name">{toTaskName}<\/span> - {toSide}<\/td>',"<\/tr>","<\/tbody><\/table>","<\/div>"],terminalSelector:".sch-gantt-terminal",el:null,rtl:null,ddGroup:null,ganttView:null,dependencyStore:null,constructor:function(n){var t=n.ganttView;Ext.apply(this,n);this.ddGroup=t.id+"-sch-dependency-dd";this.el.on("mousemove",this.doSetup,this,{single:!0});this.callParent(arguments)},doSetup:function(){var n=this;if(this.dragZone=new Gnt.feature.DependencyDragZone(this.el,Ext.apply({rtl:this.rtl,terminalSelector:this.terminalSelector,useLineProxy:this.useLineProxy,ddGroup:this.ddGroup,ganttView:this.ganttView,startText:this.L("startText"),endText:this.L("endText"),fromText:this.L("fromText"),toText:this.L("toText"),toolTipTpl:Ext.XTemplate.getTpl(this,"toolTipTpl")},this.dragZoneConfig)),this.relayEvents(this.dragZone,["beforednd","dndstart","afterdnd"]),this.dropZone=Ext.create("Gnt.feature.DependencyDropZone",this.el,Ext.apply({rtl:this.rtl,terminalSelector:this.terminalSelector,ddGroup:this.ddGroup,ganttView:this.ganttView,dependencyStore:this.dependencyStore,startText:this.L("startText"),endText:this.L("endText"),toText:this.L("toText"),toolTipTpl:Ext.XTemplate.getTpl(this,"toolTipTpl")},this.dropZoneConfig)),this.relayEvents(this.dropZone,["drop","afterdnd"]),this.configureAllowedSourceTerminals(),this.dependencyStore.allowedDependencyTypes)this.dragZone.on("dndstart",this.configureAllowedTargetTerminals,this);else this.el.addCls(["sch-gantt-terminal-allow-target-start","sch-gantt-terminal-allow-target-end"])},configureAllowedSourceTerminals:function(){var n=this.dependencyStore.allowedDependencyTypes,t=["sch-gantt-terminal-allow-source-start","sch-gantt-terminal-allow-source-end"];n&&(t=[],(Ext.Array.indexOf(n,"EndToEnd")>-1||Ext.Array.indexOf(n,"EndToStart")>-1)&&t.push("sch-gantt-terminal-allow-source-end"),(Ext.Array.indexOf(n,"StartToStart")>-1||Ext.Array.indexOf(n,"StartToEnd")>-1)&&t.push("sch-gantt-terminal-allow-source-start"));this.el.addCls(t)},configureAllowedTargetTerminals:function(){var n=this.dependencyStore.allowedDependencyTypes,t=[];this.el.removeCls(["sch-gantt-terminal-allow-target-start","sch-gantt-terminal-allow-target-end"]);(Ext.Array.contains(n,"EndToEnd")||Ext.Array.contains(n,"StartToEnd"))&&t.push("sch-gantt-terminal-allow-target-end");(Ext.Array.contains(n,"StartToStart")||Ext.Array.contains(n,"EndToStart"))&&t.push("sch-gantt-terminal-allow-target-start");this.el.addCls(t)},destroy:function(){this.dragZone&&this.dragZone.destroy();this.dropZone&&this.dropZone.destroy()}});Ext.define("Gnt.feature.DragCreator",{disabled:!1,showDragTip:!0,tooltipConfig:null,dragTolerance:2,validatorFn:Ext.emptyFn,validatorFnScope:null,constructor:function(n){Ext.apply(this,n||{});this.init()},setDisabled:function(n){this.disabled=n;this.dragTip&&this.dragTip.setDisabled(n)},getProxy:function(){return this.proxy||(this.proxy=this.template.append(this.ganttView.up("tablepanel").el,{},!0)),this.proxy},onBeforeDragStart:function(n){var t=this.ganttView,u=n.getTarget("."+t.timeCellCls,2),i,r;return u&&!this.disabled&&(i=t.resolveTaskRecord(u),r=t.getDateFromDomEvent(n),!i.isReadOnly()&&!i.getStartDate()&&!i.getEndDate()&&t.fireEvent("beforedragcreate",t,i,r,n)!==!1)?(n.stopEvent(),this.record=i,this.originalStart=r,this.rowRegion=t.getScheduleRegion(this.record,this.originalStart),this.dateConstraints=t.getDateConstraints(this.resourceRecord,this.originalStart),!0):!1},onDragStart:function(){var n=this,i=n.ganttView,t=n.getProxy();n.start=n.originalStart;n.end=n.start;n.rowBoundaries={top:n.rowRegion.top,bottom:n.rowRegion.bottom};t.setBox({x:n.tracker.startXY[0],y:n.rowBoundaries.top,width:1,height:n.rowBoundaries.bottom-n.rowBoundaries.top});t.show();i.fireEvent("dragcreatestart",i);n.showDragTip&&(n.dragTip.updateContent(n.start,n.end,!0,n.record),n.dragTip.enable(),n.dragTip.show(t))},onDrag:function(n){var t=this,f=t.ganttView,r=t.tracker.getRegion().constrainTo(t.rowRegion),u=f.getStartEndDatesFromRegion(r,"round"),i;u&&(t.start=u.start||t.start,t.end=u.end||t.end,i=t.dateConstraints,i&&(t.end=Sch.util.Date.constrain(t.end,i.start,i.end),t.start=Sch.util.Date.constrain(t.start,i.start,i.end)),t.valid=t.validatorFn.call(t.validatorFnScope||t,t.record,t.start,t.end,n)!==!1,t.showDragTip&&t.dragTip.updateContent(t.start,t.end,t.valid,t.record),Ext.apply(r,t.rowBoundaries),t.getProxy().setBox(r))},onDragEnd:function(n){var t=this,r=t.ganttView,i=!1;t.createContext={start:t.start,end:t.end,e:n,record:t.record,finalize:function(){t.finalize.apply(t,arguments)}};t.showDragTip&&t.dragTip.disable();(!t.start||!t.end||t.end<t.start)&&(t.valid=!1);t.valid&&(i=r.fireEvent("beforedragcreatefinalize",t,t.createContext,n)!==!1);i&&t.finalize(t.valid)},finalize:function(n){var r=this,t=r.createContext,i=r.ganttView;n&&(t.record.setStartEndDate(t.start,t.end,t.record.getTaskStore().skipWeekendsDuringDragDrop),i.fireEvent("dragcreateend",i,t.record,t.e));r.proxy.hide();i.fireEvent("afterdragcreate",i)},init:function(){var t=this.ganttView,i=t.el,n=Ext.Function.bind;this.lastTime=new Date;this.template=this.template||Ext.create("Ext.Template",'<div class="sch-gantt-dragcreator-proxy"><\/div>',{compiled:!0,disableFormats:!0});t.on({destroy:this.onGanttDestroy,scope:this});this.tracker=new Sch.util.DragTracker({el:i,tolerance:this.dragTolerance,onBeforeStart:n(this.onBeforeDragStart,this),onStart:n(this.onDragStart,this),onDrag:n(this.onDrag,this),onEnd:n(this.onDragEnd,this)});this.showDragTip&&(this.dragTip=new Gnt.Tooltip(Ext.apply({mode:"duration",cls:"sch-gantt-dragcreate-tip",gantt:t},this.tooltipConfig)))},onGanttDestroy:function(){this.dragTip&&this.dragTip.destroy();this.tracker&&this.tracker.destroy();this.proxy&&(Ext.destroy(this.proxy),this.proxy=null)}});Ext.define("Gnt.feature.LabelEditor",{extend:Ext.Editor,labelPosition:"",triggerEvent:"dblclick",delegate:null,dataIndex:null,shadow:!1,completeOnEnter:!0,cancelOnEsc:!0,ignoreNoChange:!0,ganttView:null,constructor:function(n,t){this.ganttView=n;this.ganttView.on("afterrender",this.onGanttRender,this);Ext.apply(this,t);this.labelPosition==="left"?this.alignment="r-r":this.labelPosition==="right"&&(this.alignment="l-l");this.delegate=".sch-gantt-label-"+this.labelPosition;this.callParent([t])},edit:function(n){var t,i;n.isEditable(this.dataIndex)&&(t=this.ganttView.getElementFromEventRecord(n),t&&(i=t.up(this.ganttView.eventWrapSelector),this.record=n,this.rendered||this.render(this.ganttView.getSecondaryCanvasEl()),this.startEdit(i.down(this.delegate),this.dataIndex?n.get(this.dataIndex):"")))},onGanttRender:function(n){this.field.width||(this.autoSize="width");this.on({beforestartedit:function(t,i,r){return n.fireEvent("labeledit_beforestartedit",n,this.record,r,t)},beforecomplete:function(t,i,r){return n.fireEvent("labeledit_beforecomplete",n,i,r,this.record,t)},complete:function(t,i,r){this.record.set(this.dataIndex,i);n.fireEvent("labeledit_complete",n,i,r,this.record,t)},scope:this});n.el.on(this.triggerEvent,function(t,i){this.edit(n.resolveTaskRecord(i))},this,{delegate:this.delegate})}});Ext.define("Gnt.feature.ProgressBarResize",{useTooltip:!0,increment:10,tip:null,resizable:null,ganttView:null,constructor:function(n){Ext.apply(this,n||{});var t=this.ganttView;t.on({destroy:this.cleanUp,scope:this});t.el.on("mousedown",this.onMouseDown,this,{delegate:".sch-gantt-progressbar-handle"});this.callParent(arguments)},onMouseDown:function(n,t){var i=this.ganttView,r=i.resolveTaskRecord(t),u;if(i.fireEvent("beforeprogressbarresize",i,r)!==!1){u=Ext.fly(t).prev(".sch-gantt-progress-bar");n.stopEvent();u.addCls("active");this.resizable=this.createResizable(u,r,n);i.fireEvent("progressbarresizestart",i,r);Ext.getBody().on("mouseup",this.onBodyMouseUp,this,{single:!0,delay:1})}},createResizable:function(n,t,i){var u=this.ganttView.rtl,f=n.up(this.ganttView.eventSelector),e=f.getWidth()-2*this.ganttView.eventBorderWidth,o=e*this.increment/100,r=Ext.create("Ext.resizer.Resizer",{target:n,taskRecord:t,handles:u?"w":"e",minWidth:0,maxWidth:e,minHeight:1,widthIncrement:o,listeners:{resizedrag:this.partialResize,resize:this.afterResize,scope:this}});r.resizeTracker.onMouseDown(i,r[u?"west":"east"].dom);return f.addCls("sch-gantt-resizing"),this.useTooltip&&(this.tip=Ext.create("Ext.ToolTip",{autoHide:!1,anchor:"b",html:"%"}),this.tip.setTarget(n),this.tip.update(t.getPercentDone()+"%"),this.tip.show()),r},partialResize:function(n,t){var i=Math.round(t*100/(n.maxWidth*this.increment))*this.increment;this.tip&&this.tip.body.update(i+"%")},afterResize:function(n,t){var u=n.taskRecord,r,i;this.tip&&(this.tip.destroy(),this.tip=null);r=n.taskRecord.getPercentDone();Ext.isNumber(t)&&(i=Math.round(t*100/(n.maxWidth*this.increment))*this.increment,i=Math.min(100,Math.max(0,i)),n.taskRecord.setPercentDone(i));r===n.taskRecord.getPercentDone()&&this.ganttView.refreshNode(this.ganttView.indexOf(n.taskRecord));n.destroy();this.resizable=null;this.ganttView.fireEvent("afterprogressbarresize",this.ganttView,u)},onBodyMouseUp:function(){this.resizable&&this.afterResize(this.resizable)},cleanUp:function(){this.tip&&this.tip.destroy()}});Ext.define("Gnt.feature.TaskDragDrop",{extend:Ext.dd.DragZone,useTooltip:!0,tooltipConfig:null,validatorFn:function(){return!0},validatorFnScope:null,showExactDropPosition:!1,containerScroll:!1,dropAllowed:"sch-gantt-dragproxy",dropNotAllowed:"sch-gantt-dragproxy",gantt:null,onDragEnter:Ext.emptyFn,onDragOut:Ext.emptyFn,tip:null,skipWeekendsDuringDragDrop:!1,taskSelector:null,deadlineSelector:null,invalidHandleClasses:[Ext.baseCSSPrefix+"resizable-handle","sch-resizable-handle","sch-gantt-terminal","sch-gantt-progressbar-handle","sch-rollup-task","sch-gantt-baseline-item"],constructor:function(n,t){t=t||{};Ext.apply(this,t);Ext.isIE&&(Ext.isIE8||Ext.ieVersion<9)&&window.top!==window&&(Ext.dd.DragDropManager.notifyOccluded=!0);this.proxy=this.proxy||new Ext.dd.StatusProxy({shadow:!1,dropAllowed:"sch-gantt-dragproxy",dropNotAllowed:"sch-gantt-dragproxy",ensureAttachedToBody:Ext.emptyFn});this.gantt.rtl&&this.proxy.addCls("sch-rtl");var i=this,r=i.gantt;i.useTooltip&&(i.tip=new Gnt.Tooltip(Ext.apply({cls:"gnt-dragdrop-tip",gantt:r},i.tooltipConfig)));i.callParent([n,Ext.apply(t,{ddGroup:r.id+"-task-dd"})]);i.scroll=!1;i.isTarget=!0;i.ignoreSelf=!1;i.el.appendChild(i.proxy.el);r.on({destroy:i.destroy,scope:i})},destroy:function(){this.tip&&this.tip.destroy();this.callParent(arguments)},getDragData:function(n){var u=n.getTarget(this.taskSelector),b=!u&&n.getTarget(this.deadlineSelector),r=u||b,o,h,k,c;if(r){var i=this.gantt,l=u&&n.getTarget(".sch-gantt-task-segment"),t=i.resolveTaskRecord(r),s=0,a,v,y;if(!t||t.isReadOnly())return;if(l&&(s=Number(l.getAttribute("data-segmentIndex")),s>0&&(r=l,t=t.getSegment(s))),u&&i.fireEvent("beforetaskdrag",i,t,n)===!1)return;var p=n.getXY(),e=r.cloneNode(!0),d=this.showExactDropPosition?0:i.getSnapPixelAmount(),w=Ext.fly(r).getXY(),f=[p[0]-w[0],p[1]-w[1]];return e.id=Ext.id(),o=Ext.fly(r).getHeight(),h=Ext.fly(r).getWidth(),Ext.fly(e).setHeight(o),Ext.isIE8m&&u&&t.isMilestone()&&Ext.fly(e).setSize(o+5,o+5),e.style.left=i.rtl?h-f[0]+"px":-f[0]+"px",s>0?(k=t.getPrevSegment(),c=t.getNextSegment(),a=Sch.util.Date.max(k.getEndDate(),i.timeAxis.getStart()),v=c?Sch.util.Date.min(c.getStartDate(),i.timeAxis.getEnd()):i.timeAxis.getEnd(),y={left:i.getCoordinateFromDate(a,!1)+f[0],right:i.getCoordinateFromDate(v,!1)-h+f[0]}):y=Ext.fly(i.findItemByChild(r)).getRegion(),this.constrainTo(y,Ext.fly(r).getRegion(),f[0],f[1]),d>=1&&this.setXConstraint(this.leftConstraint,this.rightConstraint,d),{sourceNode:r,repairXY:w,offsetX:f[0],ddel:e,record:t,duration:Sch.util.Date.getDurationInMinutes(t.getStartDate(),t.getEndDate()),startPointDate:i.getDateFromCoordinate(p[0]),minDate:a,maxDate:v,start:null,isTaskDrag:Boolean(u),originalStart:u?t.getStartDate():t.getDeadlineDate(),valid:Boolean(b)}}},onDragOver:function(n){var t=this.dragData,f=t.record,u=t.originalStart,i=this.gantt,o;t.hidden||(Ext.fly(t.sourceNode).hide(),t.hidden=!0);var s=i.getDateFromCoordinate(n.getXY()[0])-t.startPointDate,e=new Date(+u+s),h=this.proxy.el,r;if(t.minDate&&(e=Sch.util.Date.constrain(new Date(+u+s),t.minDate,t.maxDate)),i.timeAxis.isContinuous()?r=i.timeAxis.roundDate(e,i.snapRelativeToEventStartDate?u:!1):(o=h.getX()+(i.rtl?h.getWidth():0)+i.getXOffset(f)-t.offsetX,r=i.getDateFromXY([o,0],"round")),t.isTaskDrag)this.onTaskDrag(f,n,r,e);else if(r&&r-u!=0)this.onCustomElementDrag(f,n,r);t.start=r},onTaskDrag:function(n,t,i,r){var u=this.dragData,f=this.gantt,s;if(this.showExactDropPosition&&this.skipWeekendsDuringDragDrop){var o=0,e=n.skipNonWorkingTime(i,!n.isMilestone()),h=n.recalculateEndDate(e);r.getTime()!=e.getTime()&&(o=f.timeAxisViewModel.getDistanceBetweenDates(r,e));r>f.timeAxis.getStart()&&(Ext.fly(u.ddel.id).setWidth(f.timeAxisViewModel.getDistanceBetweenDates(e,Sch.util.Date.min(h,f.timeAxis.getEnd()))),o&&this.proxy.setX(this.proxy.getX()+o))}i&&i-u.start!=0&&(u.valid=this.validatorFn.call(this.validatorFnScope||f,n,i,u.duration,t)!==!1,this.tip&&(s=n.calculateEndDate(i,n.getDuration(),n.getDurationUnit()),this.updateTip(n,i,s,u.valid)))},onCustomElementDrag:function(n,t,i){this.tip&&this.updateTip(n,i,i,!0)},onStartDrag:function(){var n=this.dragData.record,t=this.tip;t&&(t.enable(),this.updateTip(n,this.dragData.originalStart,n.getEndDate()),t.show(this.proxy.el));this.dragData.isTaskDrag&&this.gantt.fireEvent("taskdragstart",this.gantt,n)},updateTip:function(n,t,i,r){r=r!==!1;this.dragData.isTaskDrag?(n.isMilestone()&&t-Ext.Date.clearTime(t,!0)==0&&(t=Sch.util.Date.add(t,Sch.util.Date.MILLI,-1),i=Sch.util.Date.add(i,Sch.util.Date.MILLI,-1)),this.tip.updateContent(t,i,!0,n)):this.tip.updateContent(null,t,!0,n)},afterRepair:function(){Ext.fly(this.dragData.sourceNode).show();this.tip&&this.tip.hide();this.dragging=!1},getRepairXY:function(){return this.dragData.isTaskDrag&&this.gantt.fireEvent("aftertaskdrop",this.gantt),this.dragData.repairXY},onDragDrop:function(n,t){var r=this,s=r.cachedTarget||Ext.dd.DragDropMgr.getDDById(t),i=r.dragData,u=r.gantt,f=i.start,e=!0,o=i.valid&&f&&i.originalStart-f!=0;i.ddCallbackArgs=[s,n,t];this.tip&&this.tip.disable();i.isTaskDrag&&o&&(i.finalize=function(){r.finalize.apply(r,arguments)},e=u.fireEvent("beforetaskdropfinalize",u,i,n)!==!1);e&&this.finalize(o)},finalize:function(n){var t=this,i=this.dragData,r=this.gantt,u=i.record,f=i.start,e,o;n?(e=i.originalStart,i.isTaskDrag?u.setStartDate(f,!0,this.skipWeekendsDuringDragDrop,function(){o=u.getStartDate();e-o!=0?(r.fireEvent("taskdrop",r,u),Ext.isIE9?(t.proxy.el.setStyle("visibility","hidden"),Ext.Function.defer(t.onValidDrop,10,t,i.ddCallbackArgs)):t.onValidDrop.apply(t,i.ddCallbackArgs)):t.onInvalidDrop.apply(t,i.ddCallbackArgs);r.fireEvent("aftertaskdrop",r,u)}):(u.setDeadlineDate(f),t.onValidDrop.apply(t,i.ddCallbackArgs))):(t.onInvalidDrop.apply(t,i.ddCallbackArgs),i.isTaskDrag&&r.fireEvent("aftertaskdrop",r,u))},onInvalidDrop:function(n,t,i){return t||(t=n,n=n.getTarget()||document.body),this.callParent([n,t,i])},autoOffset:function(){this.setDelta(0,0)},setXConstraint:function(n,t,i){this.leftConstraint=n;this.rightConstraint=t;this.minX=n;this.maxX=t;i&&this.setXTicks(this.initPageX,i);this.constrainX=!0},setYConstraint:function(n,t,i){this.topConstraint=n;this.bottomConstraint=t;this.minY=n;this.maxY=t;i&&this.setYTicks(this.initPageY,i);this.constrainY=!0},constrainTo:function(n,t,i,r){this.resetConstraints();this.initPageX=n.left+i;this.initPageY=t.top+r;this.setXConstraint(n.left,n.right,this.xTickSize);this.setYConstraint(t.top-1,t.top-1,this.yTickSize)},startDrag:function(){return this.gantt.el.ddScrollConfig={increment:Ext.dd.ScrollManager.increment,hthresh:Ext.dd.ScrollManager.hthresh,vthresh:-1},this.callParent(arguments)},endDrag:function(){return delete this.gantt.el.ddScrollConfig,this.callParent(arguments)}});Ext.define("Gnt.feature.TaskResize",{constructor:function(n){Ext.apply(this,n);var t=this.ganttView;t.on({destroy:this.cleanUp,scope:this});t.mon(t.el,"mousedown",this.onMouseDown,this,{delegate:".sch-resizable-handle"});this.callParent(arguments)},showDuration:!0,showExactResizePosition:!1,useTooltip:!0,tooltipConfig:null,validatorFn:Ext.emptyFn,validatorFnScope:null,taskRec:null,taskEl:null,isStart:null,ganttView:null,resizable:null,onMouseDown:function(n,t){var i=this.ganttView,e=n.getTarget(".sch-gantt-task-segment"),u=n.getTarget(i.eventSelector),r=i.resolveTaskRecord(u),f;if((e&&(u=e,r=r.getSegment(parseInt(e.getAttribute("data-segmentIndex"),10))),f=r.isResizable(),n.button===0&&f!==!1&&(typeof f!="string"||u.className.match(f)))&&i.fireEvent("beforetaskresize",i,r,n)!==!1){n.stopEvent();this.taskEl=Ext.get(u);this.taskRec=r;this.isStart=!!t.className.match("sch-resizable-handle-start");i.el.on({mousemove:this.onMouseMove,mouseup:this.onMouseUp,scope:this,single:!0})}},onMouseMove:function(n){var o=this.ganttView,i=this.taskRec,t=this.taskEl,s=o.rtl,h=this.isStart,r=s&&!h||!s&&h,u=o.getSnapPixelAmount(),l=t.getWidth(),c,f,e;u=Math.max(1,u);f={otherEdgeX:r?t.getRight():t.getLeft(),target:t,record:i,isStart:h,isWest:r,handles:r?"w":"e",minHeight:1,minWidth:u,widthIncrement:u,listeners:{resizedrag:this.partialResize,resize:this.afterResize,scope:this}};i instanceof Gnt.model.TaskSegment&&(c=this.taskEl.next(".sch-gantt-task-segment"))&&(f.maxWidth=s?c.getRight()-t.getRight():c.getLeft()-t.getLeft());f.constrainRegion=t.up(o.getItemSelector()).getRegion();t.addCls("sch-gantt-resizing");this.ganttView.fireEvent("taskresizestart",this.ganttView,this.taskRec);e=t.down(".sch-gantt-progress-bar");e&&e.setWidth(100*e.getWidth()/t.getWidth()+"%");this.resizable=Ext.create("Ext.resizer.Resizer",f);this.resizable.resizeTracker.onMouseDown(n,this.resizable[r?"west":"east"].dom);if(this.useTooltip){this.tip?this.tip.enable():this.tip=Ext.create("Gnt.Tooltip",Ext.apply({mode:this.showDuration?"duration":"startend",gantt:this.ganttView},this.tooltipConfig));this.tip.show(t,n.getX()-15);this.tip.updateContent(i.getStartDate(),i.getEndDate(),!0,i);Ext.getBody().on("mouseup",function(){this.tip.disable()},this,{single:!0})}},onMouseUp:function(){var n=this.ganttView;n.el.un({mousemove:this.onMouseMove,mouseup:this.onMouseUp,scope:this,single:!0})},partialResize:function(n,t,i,r){var f=this.ganttView,p=n.isWest,u=n.record,e,o,s,a,h,c,v,w,l,y,b;(e=p?f.getDateFromCoordinate(n.otherEdgeX-Math.min(t,this.resizable.maxWidth),this.showExactResizePosition?null:"round"):f.getDateFromCoordinate(n.otherEdgeX+Math.min(t,this.resizable.maxWidth),this.showExactResizePosition?null:"round"),e&&n.date-e!=0)&&(this.showExactResizePosition?(h=f.timeAxis.roundDate(e,f.snapRelativeToEventStartDate?u.getStartDate():!1),h=u.skipNonWorkingTime(h,!u.isMilestone()),c=n.target.el,p?(o=u.skipNonWorkingTime(h,!u.isMilestone()),a=o,v=f.timeAxisViewModel.getDistanceBetweenDates(o,u.getEndDate()),c.setWidth(v),w=f.timeAxisViewModel.getDistanceBetweenDates(e,o),c.setX(c.getX()+w)):(l=Gnt.util.Data.cloneModelSet([u])[0],y=u.getTaskStore(),l.setTaskStore(y),l.setCalendar(u.getCalendar()),l.setEndDateWithoutPropagation(h,!1,y.skipWeekendsDuringDragDrop),s=l.getEndDate(),a=s,v=f.timeAxisViewModel.getDistanceBetweenDates(u.getStartDate(),s),c.setWidth(v))):(o=n.isStart?e:n.record.getStartDate(),s=n.isStart?n.record.getEndDate():e,a=e),n.date=a,f.fireEvent("partialtaskresize",f,u,o,s,n.el,r),this.useTooltip&&(b=this.validatorFn.call(this.validatorFnScope||this,u,o,s)!==!1,this.tip.updateContent(o,s,b,u)))},afterResize:function(n,t,i,r){this.useTooltip&&this.tip.disable();var u=this,f=n.record,s=f.getStartDate(),h=f.getEndDate(),e=n.isStart?n.date:s,o=n.isStart?h:n.date,c=u.ganttView,l=!1,a=!0;u.resizeContext={record:f,start:e,end:o,oldStart:f.getStartDate(),finalize:function(){u.finalize.apply(u,arguments)}};e&&o&&(e-s||o-h)&&u.validatorFn.call(u.validatorFnScope||u,f,e,o,r)!==!1?(a=c.fireEvent("beforetaskresizefinalize",u,u.resizeContext,r)!==!1,l=!0):c.refreshKeepingScroll();a&&u.finalize(l)},finalize:function(n){var o=this,t=o.ganttView,i=o.resizeContext,u=i.record,f=u.task||u,s=t.taskStore.skipWeekendsDuringDragDrop,e,r;n?i.start-i.oldStart!=0?(e=u.getStartDate(),r=i.start<=i.end?i.start:i.end,u.setStartDate(r,!1,s,function(){r=u.getStartDate();r<e||r>e||t.refreshNode(t.store.indexOf(f));t.fireEvent("aftertaskresize",t,f)})):(e=u.getEndDate(),r=i.start<=i.end?i.end:i.start,u.setEndDate(r,!1,s,function(){r=u.getEndDate();r<e||r>e||t.refreshNode(t.store.indexOf(f));t.fireEvent("aftertaskresize",t,f)})):(t.refreshNode(t.store.indexOf(f)),t.fireEvent("aftertaskresize",t,f));o.resizable.destroy();o.resizeContext=null},cleanUp:function(){this.tip&&this.tip.destroy()}});Ext.define("Gnt.feature.WorkingTime",{extend:Sch.plugin.Zones,expandToFitView:!0,calendar:null,init:function(n){this.calendar||Ext.Error.raise("Required attribute 'calendar' missed during initialization of 'Gnt.feature.WorkingTime'");this.bindCalendar(this.calendar);this.store=new Ext.data.Store({model:"Sch.model.Range",autoDestroy:!0});this.callParent(arguments);n.on("viewchange",this.onViewChange,this);this.onViewChange()},bindCalendar:function(n){var t={datachanged:this.refresh,update:this.refresh,scope:this,delay:1};if(this.calendar&&this.calendar.un(t),n)n.on(t);this.calendar=n},onViewChange:function(){var n=Sch.util.Date;n.compareUnits(this.timeAxis.unit,n.WEEK)>0?this.setDisabled(!0):(this.setDisabled(!1),this.refresh())},refresh:function(){var n=this.schedulerView;this.store.removeAll(!0);this.store.add(this.calendar.getHolidaysRanges(n.timeAxis.getStart(),n.timeAxis.getEnd(),!0))},destroy:function(){this.bindCalendar(null);this.callParent(arguments)}});Ext.define("Gnt.field.ReadOnly",{extend:Ext.form.field.Checkbox,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.readonlyfield",alternateClassName:["Gnt.widget.ReadOnlyField"],taskField:"readOnlyField",setTaskValueMethod:"setReadOnly",getTaskValueMethod:"getReadOnly",instantUpdate:!0,valueToVisible:function(n){return n?this.L("yes"):this.L("no")},getValue:function(){return this.value},setValue:function(n){this.callParent([n]);this.instantUpdate&&!this.getSuppressTaskUpdate()&&this.task&&this.applyChanges()}});Ext.define("Gnt.field.ShowInTimeline",{extend:Ext.form.field.Checkbox,mixins:[Gnt.field.mixin.TaskField,Gnt.mixin.Localizable],alias:"widget.showintimelinefield",alternateClassName:["Gnt.widget.ShowInTimelineField"],taskField:"showInTimelineField",setTaskValueMethod:"setShowInTimeline",getTaskValueMethod:"getShowInTimeline",valueToVisible:function(n){return n?this.L("yes"):this.L("no")},setValue:function(){this.callParent(arguments);this.instantUpdate&&!this.getSuppressTaskUpdate()&&this.task&&this.applyChanges()}});Ext.define("Gnt.model.ProjectLine",{extend:Ext.data.Model,idProperty:"Id",fields:[{name:"Id"},{name:"ProjectId"},{name:"Date",type:"date"},{name:"Cls",type:"string"},{name:"Text",type:"string"}]});Ext.define("Gnt.model.TaskSegment",{extend:Gnt.model.Task,task:null,customizableFields:[{name:"StartOffset",type:"int",defaultValue:null},{name:"EndOffset",type:"int",defaultValue:null}],startOffsetField:"StartOffset",endOffsetField:"EndOffset",taskNotifyingSuspended:0,respectNeighbours:0,constructor:function(n){if(n=n||{},n.leaf=!0,!n.task)throw"'task' has to be specified";this.task=n.task;this.callParent(arguments);Ext.override(this,this.overridables);this.getTask().normalized&&this.getTaskStore(!0)&&!this.normalized&&this.normalize()},overridables:{set:function(){var n=this.getTask();if(n&&!this.__editCounter&&!this.taskNotifyingSuspended)n.onSegmentEditBegin(this);if(this.callParent(arguments),n&&!this.__editCounter&&!this.taskNotifyingSuspended)n.onSegmentEditEnd(this)}},serialize:function(){var n={};return this.getId()&&(n[this.idProperty]=this.getId()),n[this.phantomIdField]=this.getPhantomId(),n[this.startDateField]=this.getStartDate(),n[this.endDateField]=this.getEndDate(),n[this.durationField]=this.getDuration(),n[this.durationUnitField]=this.getDurationUnit(),n[this.clsField]=this.getCls(),n},setStartOffset:function(n){var t=this.getTask().getProjectCalendar(),i=t.convertMSDurationToUnit(this.getEndOffset()-n,this.getDurationUnit());this.beginEdit();this.set(this.startOffsetField,n);this.set(this.durationField,i);this.endEdit()},setEndOffset:function(n){var t=this.getTask().getProjectCalendar(),i=t.convertMSDurationToUnit(n-this.getStartOffset(),this.getDurationUnit());this.beginEdit();this.set(this.endOffsetField,n);this.set(this.durationField,i);this.endEdit()},setStartEndOffset:function(n,t){var i=this.getTask().getProjectCalendar(),r=i.convertMSDurationToUnit(t-n,this.getDurationUnit());this.beginEdit();this.set(this.startOffsetField,n);this.set(this.endOffsetField,t);this.set(this.durationField,r);this.endEdit()},normalize:function(){var n;if(this.callParent(arguments),n=this.getStartDate(),!Ext.isNumber(this.getStartOffset())&&n){var i=this.getTask(),t=this.calculateDuration(i.getStartDate(),n,"MILLI"),r=t+this.getDuration("MILLI"),u=i.getProjectCalendar(),f=u.convertMSDurationToUnit(r-t,this.getDurationUnit());this.data[this.startOffsetField]=t;this.data[this.endOffsetField]=r;this.data[this.durationField]=f}},updateOffsetsByDates:function(){if(this.getTaskStore(!0)&&!this.updatingOffsets&&!this.updatingDates){this.updatingOffsets=!0;var n=this.calculateDuration(this.getTask().getStartDate(),this.getStartDate(),"MILLI");this.setStartEndOffset(n,n+this.getDuration("MILLI"));this.updatingOffsets=!1}},updateDatesByOffsets:function(n){var i,t;if(n=n||{},!this.updatingDates&&!this.updatingOffsets){var f=n.isForward!==!1,r=n.useAbsoluteOffset!==!1,e=n.startDate,o=n.endDate,u=this.getTaskStore(!0);u&&(this.updatingDates=!0,f?(t=this.getPrevSegment(),i=t&&!r?this.skipWorkingTime(t.getEndDate(),this.getStartOffset()-t.getEndOffset()):this.skipWorkingTime(e||this.getTask().getStartDate(),this.getStartOffset())):(t=this.getNextSegment(),i=t&&!r?this.skipWorkingTime(t.getStartDate(),t.getStartOffset()-this.getEndOffset()+this.getDuration("MILLI"),!1):this.skipWorkingTime(o||this.getTask().getEndDate(),this.getDuration("MILLI"),!1)),this.setStartDateWithoutPropagation(i,!0,u.skipWeekendsDuringDragDrop),this.updatingDates=!1)}},getPrevSegment:function(){var n=this.task.getSegments();return n[Ext.Array.indexOf(n,this)-1]},getNextSegment:function(){var n=this.task.getSegments();return n[Ext.Array.indexOf(n,this)+1]},buildSnapshot:function(){return[this,Ext.apply({},this.data)]},readSnapshot:function(n){return n?(Ext.apply(this.data,n[1]),this):n},enableRespectNeighbours:function(){this.respectNeighbours++},disableRespectNeighbours:function(){this.respectNeighbours--},suspendTaskNotifying:function(){this.taskNotifyingSuspended++},resumeTaskNotifying:function(){this.taskNotifyingSuspended--},setStartDate:function(n,t){t&&this.enableRespectNeighbours();this.callParent(arguments);t&&this.disableRespectNeighbours()},setStartDateWithoutPropagation:function(){if(this.beginEdit(),this.callParent(arguments),this.updateOffsetsByDates(),!this.inShifting&&this.respectNeighbours&&this.getNextSegment()){var n=this.getNextSegment(),t=this.getEndOffset()-n.getStartOffset();n&&t>0&&(n.suspendTaskNotifying(),n.enableRespectNeighbours(),n.shiftWithoutPropagation(t),n.resumeTaskNotifying(),n.disableRespectNeighbours())}return this.endEdit(),!0},shiftWithoutPropagation:function(n){var t=this,i;if(n)return t.beginEdit(),t.inShifting=!0,t.setStartEndOffset(t.getStartOffset()+n,t.getEndOffset()+n),t.updateDatesByOffsets(),t.respectNeighbours&&(i=n>0?t.getNextSegment():t.getPrevSegment())&&(i.suspendTaskNotifying(),i.enableRespectNeighbours(),i.shiftWithoutPropagation(n),i.resumeTaskNotifying(),i.disableRespectNeighbours()),t.inShifting=!1,t.endEdit(),!0},setEndDateWithoutPropagation:function(){return this.beginEdit(),this.callParent(arguments),this.updateOffsetsByDates(),this.endEdit(),!0},setStartEndDateWithoutPropagation:function(){return this.beginEdit(),this.callParent(arguments),this.updateOffsetsByDates(),this.endEdit(),!0},setDurationWithoutPropagation:function(){return this.beginEdit(),this.callParent(arguments),this.updateOffsetsByDates(),this.endEdit(),!0},getTask:function(){return this.task},beginEdit:function(){var n=this.getTask();if(n&&!this.__editCounter&&!this.taskNotifyingSuspended)n.onSegmentEditBegin(this);this.callParent(arguments)},endEdit:function(){var n=this.previous,t=this.getTask();if(this.callParent(arguments),t&&!this.__editCounter&&!this.taskNotifyingSuspended){if(this.startDateField in n||this.endDateField in n||this.startOffsetField in n||this.endOffsetField in n||this.durationField in n)t.onSegmentsChanged(this,n);t.onSegmentEditEnd(this)}},setSegments:Ext.emptyFn,getSegments:Ext.emptyFn,callTask:function(n){var t=this.task,i=this.callTask.caller,r=i&&t[i.$name];if(r)return r.apply(t,n)},getSchedulingMode:function(){return"Normal"},getCalendar:function(){return this.callTask(arguments)},getOwnCalendar:function(){return this.callTask(arguments)},getProjectCalendar:function(){return this.callTask(arguments)},getDependencyStore:function(){return this.callTask(arguments)},getResourceStore:function(){return this.callTask(arguments)},getAssignmentStore:function(){return this.callTask(arguments)},getTaskStore:function(){return this.callTask(arguments)},forEachAvailabilityInterval:function(n){return n.segments=n.segments||!1,this.callTask(arguments)},propagateChanges:function(){return this.callTask(arguments)},rejectSegmentsProjection:function(){return this.callTask(arguments)},commitSegmentsProjection:function(){return this.callTask(arguments)},getAssignments:function(){return this.callTask(arguments)},getAssignmentFor:function(){return this.callTask(arguments)},isAssignedTo:function(){return this.callTask(arguments)},getResources:function(){return this.callTask(arguments)}});Ext.define("Gnt.model.Week",{extend:Ext.data.Model,idProperty:"Id",fields:[{name:"Id"},{name:"name",type:"string"},{name:"startDate",type:"date"},{name:"endDate",type:"date"},{name:"mainDay"},{name:"weekAvailability"}],set:function(n,t){n==="name"&&Ext.Array.each(this.get("weekAvailability").concat(this.get("mainDay")),function(n){n&&n.setName(t)});this.callParent(arguments)}});Ext.define("Gnt.model.utilization.DefaultUtilizationNegotiationStrategy",{getUtilizationInfoForUtilizationEvent:function(n){var t=this,i={};return t.forEachTimeSpanInterval(n,function(r,u){var f;return n.isSurrogateAssignment()?f=n.getOriginalAssignment().getUtilizationInfo(r,u):n.isSurrogateSummary()?f=n.getOriginalResource().getUtilizationInfo(r,u):Ext.Error.raise("Unknown utilization event type"),Ext.Object.each(f,function(n,f){i[t.self.makeUtilizationInfoKey(r,u,n)]=f}),f}),i},getUtilizationInfoForAssignmentEventInterval:function(n,t,i){var u=Ext.Date,e=this,r={isUtilized:!1,allocationMs:0,allocationDeltaMs:0,isOverallocated:!1,isUnderallocated:!1,assignmentInfo:null,taskInfo:null},f=n.getUtilizationInfo();return i=i||u.add(t,u.DAY,1),Ext.Object.each(r,function(n,u){var o=e.self.makeUtilizationInfoKey(t,i,n);r[n]=f.hasOwnProperty(o)?f[o]:u}),r},forEachTimeSpanInterval:function(n,t){for(var r=Ext.Date,u=n.getStartDate?n.getStartDate():n.startDate,f=n.getEndDate?n.getEndDate():n.endDate,i=r.clearTime(u,!0);i<f;)u=i,i=r.add(i,r.DAY,1),t(u,i)},adjustStartDateToTick:function(n){return n&&Ext.Date.clearTime(n,!0)||n},adjustEndDateToTick:function(n){var t=Ext.Date,i=n,r;return n&&(r=new Date(n.getTime()-1),i=r.getDate()!=n.getDate()?new Date(n):t.clearTime(t.add(n,t.DAY,1))),i},calculateResourceAssignmentsTimespan:function(n){var u=this,r=!1,t,i;return t=new Date(864e13),i=new Date(-864e13),n.forEachAssignment(function(n){var u=n.getTask(),f=u&&u.getStartDate()||t,e=u&&u.getEndDate()||i;t>f&&(t=f);i<e&&(i=e);r=!0}),{startDate:r&&u.adjustStartDateToTick(t)||null,endDate:r&&u.adjustEndDateToTick(i)||null}},assignmentsComparator:function(n,t){return n.getTask().getName()>t.getTask().getName()?1:-1},inheritableStatics:{makeUtilizationInfoKey:function(n,t,i){return[n.getTime(),t.getTime(),i].join("-")}}});Ext.define("Gnt.model.utilization.ResourceStoreUtilizationNegotiationStrategy",{extend:Gnt.model.utilization.DefaultUtilizationNegotiationStrategy,config:{resourceUtilizationStore:null,underUtilizationThreshold:null,overUtilizationThreshold:null},constructor:function(n){var t=this;t.initConfig(n)},getUtilizationInfoForUtilizationEvent:function(n){var e=Gnt.model.UtilizationEvent,t=this,o=t.getResourceUtilizationStore(),s=n.getId(),i=o&&o.utilizationInfoCache||{},f=i[s]||null,r,h,u,c;return f||(r=n.getOriginalResource(),h=t.calculateResourceAssignmentsTimespan(r),u=[],r.forEachAssignment(function(n){u.push(n)}),u.sort(function(n,i){return t.assignmentsComparator(n,i)}),t.forEachTimeSpanInterval(h,function(n,f){var h=r.getUtilizationInfo(n,f,t.getUnderUtilizationThreshold(),t.getOverUtilizationThreshold()),o,s;o=e.getSurrogateIdFor(r);s=i[o]=i[o]||{};Ext.Object.each(h,function(i,r){s[t.self.makeUtilizationInfoKey(n,f,i)]=r});c=0;Ext.Array.each(u,function(r){var u,c=r.getId();h.assignmentInfo.hasOwnProperty(c)&&(o=e.getSurrogateIdFor(r),s=i[o]=i[o]||{},u=h.assignmentInfo[c],Ext.Object.each(u,function(i,r){s[t.self.makeUtilizationInfoKey(n,f,i)]=r}))})}),f=i[s]||{}),f},getUtilizationInfoForAssignmentEventInterval:function(n,t){var e=Ext.Date,u=this,o=u.getResourceUtilizationStore(),i=o.getTimeAxis(),r=i.getTickFromDate(t),f;return f=r!==-1&&r<i.count()?i.getAt(r).getEndDate():e.add(t,1,i.unit),u.callParent([n,t,f])},forEachTimeSpanInterval:function(n,t){var f=this,e=f.getResourceUtilizationStore(),i=e.getTimeAxis(),r,u;i?(r=n.getStartDate?n.getStartDate():n.startDate,u=n.getEndDate?n.getEndDate():n.endDate,r=new Date(Math.max(r,i.getStart())),u=new Date(Math.min(u,i.getEnd())),Ext.Array.each(i.generateTicks(r,u,i.getUnit()),function(n){n.start-r>=0&&n.end-u<=0&&t(n.start,n.end)})):f.callParent([n,t])},adjustStartDateToTick:function(n){var i=this,r=i.getResourceUtilizationStore(),t=r.getTimeAxis();return t.floorDate(n,!1,t.unit,1)},adjustEndDateToTick:function(n){var i=this,r=i.getResourceUtilizationStore(),t=r.getTimeAxis();return t.ceilDate(n,!1,t.unit,1)}});Ext.define("Gnt.patches.CellEditor",{extend:Sch.util.Patch,target:"Ext.grid.CellEditor",minVersion:"6.0.0",applyFn:function(){var n={onHide:function(){this.restoreCell();this.superclass.onHide.apply(this,arguments)}};Ext.getVersion().isLessThan("6.0.1")&&(n.onViewRefresh=function(n){var t=this,u=t.el&&t.el.dom,r,i=t.context;if(u){if(r=n.getCellByPosition(i,!0),!r){t.allowBlur=t.wasAllowBlur;t.completeEdit();Ext.getDetachedBody().dom.appendChild(u);return}i.node=n.getNode(i.record);i.row=n.getRow(i.record);i.cell=r;i.rowIdx=n.indexOf(i.row);r.insertBefore(u,r.firstChild);t.boundEl=t.container=Ext.get(r);t.realign(!0);t.editing&&(Ext.isIE?Ext.defer(function(){t.destroyed||(t.allowBlur=t.wasAllowBlur,t.field.focus())},10):(t.allowBlur=t.wasAllowBlur,t.field.focus()))}});Ext.ClassManager.get(this.target).override(n)}});Ext.define("Gnt.patches.CellEditing",{extend:Sch.util.Patch,target:"Ext.grid.plugin.CellEditing",minVersion:"5.1.1",maxVersion:"6.0.1.250",overrides:{showEditor:function(n,t){n.context&&n.context.record!==t.record&&n.field instanceof Ext.form.field.ComboBox&&(n.field.lastSelectedRecords=null);this.callParent(arguments)}}});Ext.define("Gnt.patches.TreeViewDragDrop",{extend:Sch.util.Patch,target:"Ext.tree.plugin.TreeViewDragDrop",minVersion:"6.0.0",overrides:{disable:function(){this.callParent(arguments);this.dragZone&&this.dragZone.lock();this.dropZone&&this.dropZone.lock()},enable:function(){this.callParent(arguments);this.dragZone&&this.dragZone.unlock();this.dropZone&&this.dropZone.unlock()}}});Ext.define("Gnt.patches.SelectionExtender",{extend:Sch.util.Patch,target:"Ext.grid.selection.SelectionExtender",minVersion:"6.0.0",applyFn:function(){var n={onDrag:function(n){Ext.fly(n.getTarget()).up(".sch-ganttview")||this.callParent(arguments)}};Ext.getVersion().isLessThan("6.0.1")&&(n.setHandle=function(n,t){n&&n.record&&t&&t.record&&this.callParent(arguments)});Ext.ClassManager.get(this.target).override(n)}});Ext.define("Gnt.patches.SpreadsheetModel",{extend:Sch.util.Patch,target:"Ext.grid.selection.SpreadsheetModel",minVersion:"6.0.0",applyFn:function(){var n={privates:{onMouseMove:function(n,t){Ext.fly(t).up(".sch-ganttview")||this.callParent(arguments)},handleMouseDown:function(n,t,i,r,u,f,e){Ext.fly(e.getTarget()).up(".sch-ganttview")||this.callParent(arguments)}}};Ext.getVersion().isLessThan("6.0.2")&&(n.select=function(n,t,i){var u=this,r=u.selected,o=u.view,c=o.dataSource,s,e,f,h=!1;for(r&&r.isRows&&r.view===o?t||r.clear():(u.resetSelection(!0),r=u.selected=new Ext.grid.selection.Rows(o)),Ext.isArray(n)||(n=[n]),s=n.length,e=0;e<s;e++)f=n[e],typeof f=="number"&&(f=c.getAt(f)),r.contains(f)||(r.add(f),h=!0);h&&(u.updateHeaderState(),i||u.fireSelectionChange())});Ext.override(Ext.grid.selection.SpreadsheetModel,n)}});Ext.define("Gnt.patches.LockingView",{extend:Sch.util.Patch,target:"Ext.grid.locking.View",minVersion:"6.0.0",overrides:{getCellByPosition:function(n){return n&&!n.column?null:this.callParent(arguments)},onCellDeselect:function(n){if(!n||n.column)return this.callParent(arguments)}}});Ext.define("Gnt.patches.IENavigationModel",{extend:Sch.util.Patch,target:"Ext.grid.NavigationModel",ieOnly:!0,minVersion:"6.0.0",maxVerson:"6.1.0",overrides:{onKeyTab:function(n){var t=!n.shiftKey,i=n.position.clone(),e=i.view,r=n.position.cellElement,u=Ext.fly(r).findTabbableElements(),f,s=e.ownerGrid.actionables,h=s.length,o;for(n.preventDefault(),f=u[Ext.Array.indexOf(u,n.target)+(t?1:-1)];!f&&(r=r[t?"nextSibling":"previousSibling"]);){for(i.setColumn(e.getHeaderByCell(r)),o=0;o<h;o++)s[o].activateCell(i);(u=Ext.fly(r).findTabbableElements()).length&&(f=u[t?0:u.length-1])}if(Ext.isIE&&e.el.focus(),f){this.actionPosition=i.view.actionPosition=i;Ext.fly(f).focus();return}e.onRowExit(n.item,n.item[t?"nextSibling":"previousSibling"],t)}}});Ext.define("Gnt.view.DependencyPainter",{ganttView:null,rowHeight:null,arrowOffset:8,lineWidth:2,xOffset:6,constructor:function(n){n=n||{};Ext.apply(this,n)},setRowHeight:function(n){this.rowHeight=n},getTaskBox:function(n){var f=Sch.util.Date,e=n.getStartDate(),o=n.getEndDate(),t=this.ganttView,v=t.bufferedRenderer,y=t.timeAxis.getStart(),p=t.timeAxis.getEnd(),i,u,s,w,r,h,b,k;if(!n.isVisible()||!e||!o||!f.intersectSpans(e,o,y,p)||t.store.indexOf(n)<0&&((i=t.taskStore,!v)||i.isTreeFiltered()&&!i.lastTreeFilter.filter.call(i.lastTreeFilter.scope||i,n)))return null;var c=t.getXFromDate(f.max(e,y)),l=t.getXFromDate(f.min(o,p)),d=t.getNodeByRecord(n);if(d||v){if(u=t.getXOffset(n),s=!0,c>u&&(c-=u),l+=u,d){var tt=t.el.down("."+Ext.baseCSSPrefix+"grid-item-container",!0),g=t.getElementsFromEventRecord(n,null,null,!0),nt=n.isMilestone(),a=g.length&&g[0];if(!a)return null;w=Ext.fly(a).getOffsetsTo(tt);r=w[1]+(nt&&Ext.isIE8?3:0);h=r+Ext.fly(a).getHeight();nt&&(l+=1)}else b=t.store.getAt(t.all.startIndex),k=n.isAbove(b)?-2*this.rowHeight:(t.all.endIndex-t.all.startIndex+2)*this.rowHeight,r=k,h=r+this.rowHeight,s=!1;return{top:r,end:l,bottom:h,start:c,rendered:s}}},getRenderData:function(n){var t=n.getSourceTask(),i=n.getTargetTask(),u,f;if(!t||!t.getTreeStore()||!i||!i.getTreeStore())return null;var e=this.getTaskBox(t),o=this.getTaskBox(i),r=this.ganttView;return r.bufferRender&&e&&!e.rendered&&o&&!o.rendered&&(u=r.store.getAt(r.all.startIndex),f=r.store.getAt(r.all.endIndex),t.isAbove(u)&&i.isAbove(u)||f.isAbove(t)&&f.isAbove(i))?null:{fromBox:e,toBox:o}},getDependencyTplData:function(n){var s=this,u,f,e,o,t,i,h,r;if(n instanceof Ext.data.Model&&(n=[n]),n.length!==0&&s.ganttView.store.getCount()!==0){for(u=[],i=0,h=n.length;i<h;i++)t=n[i],r=this.getRenderData(t),r&&(e=r.fromBox,o=r.toBox,e&&o&&(f=s.getLineCoordinates(e,o,t),f&&u.push({dependency:t,id:t.internalId,cls:t.getCls(),lineCoordinates:f})));return u}},getLineCoordinates:function(n,t,i){var e,o,f=[0,n.top-1+(n.bottom-n.top)/2],r=[0,t.top-1+(t.bottom-t.top)/2],b=r[1]>f[1],a=i.self.Type,v=this.arrowOffset+this.xOffset,k=i.getType(),u=[],y=i.getTargetTask().isMilestone(),s,l,p,h,w,c;switch(k){case a.StartToEnd:f[0]=n.start;r[0]=t.end+v;e="l";o="r";break;case a.StartToStart:f[0]=n.start;r[0]=t.start-v;e="l";o="l";break;case a.EndToStart:f[0]=n.end;r[0]=t.start-v;e="r";o="l";break;case a.EndToEnd:f[0]=n.end;r[0]=t.end+v;e="r";o="r";break;default:throw"Invalid dependency type: "+i.getType();}for(u.push(f),h=f[0]+(e==="r"?this.xOffset:-this.xOffset),b&&k===a.EndToStart&&n.end<t.start+5?(s=Math.min(t.start,t.end)+this.xOffset,u.push([s,f[1]]),u.push([s,t.top-this.arrowOffset-(y?2:0)])):e!==o&&(e==="r"&&h>r[0]||e==="l"&&h<r[0])?(l=t[o==="l"?"start":"end"],p=r[1]+(b?-1:1)*(this.rowHeight/2),u.push([h,f[1]]),u.push([h,p]),u.push([r[0],p]),u.push(r),u.push([l+(r[0]<l?-this.arrowOffset:this.arrowOffset)-(y&&o==="l"&&!Ext.isIE8m?2:0),r[1]])):(l=t[o==="l"?"start":"end"],s=e==="r"?Math.max(h,r[0]):Math.min(h,r[0]),u.push([s,f[1]]),u.push([s,r[1]]),u.push([l+(s<l?-this.arrowOffset:this.arrowOffset)-(y&&o==="l"?2:0),r[1]])),w=[],c=0;c<u.length-1;c++)w.push({x1:u[c][0],y1:u[c][1],x2:u[c+1][0],y2:u[c+1][1]});return w}});Ext.define("Gnt.view.Dependency",{extend:Ext.util.Observable,lineWidth:1,dragZoneConfig:null,dropZoneConfig:null,dependencyPainterClass:"Gnt.view.DependencyPainter",ganttView:null,painter:null,taskStore:null,store:null,dnd:null,lineTpl:null,renderTimer:null,depRe:/sch-dep-([^\s]+)/,enableDependencyDragDrop:!0,renderAllDepsBuffered:!1,dependencyCls:"sch-dependency",selectedCls:"sch-dependency-selected",constructor:function(n){var t,i,r;if(this.callParent(arguments),t=this.ganttView,t.bufferedRenderer)t.on({itemadd:this.renderAllDependenciesBuffered,scope:this});t.on({refresh:this.renderAllDependenciesBuffered,itemupdate:this.onGanttViewRowRefreshed,scope:this});if(this.bindTaskStore(t.getTaskStore()),this.bindDependencyStore(n.store),this.lineTpl||(i=this.rtl,r=i?"right":"left",this.lineTpl=new Ext.XTemplate('<tpl for=".">'+('<tpl for="lineCoordinates"><div class="{0} {[ parent.dependency.isHighlighted ? "{1}" : "" ]} {[values.x1==values.x2 ? "sch-dependency-line-v" : "sch-dependency-line-h"]} {lineCls} sch-dep-{parent.id} {0}-line {[this.getSuffixedCls(parent.cls, "-line")]}" style="'+r+':{[Math.min(values.x1, values.x2)]}px;top:{[Math.min(values.y1, values.y2)]}px;{[values.x1!=values.x2 ? "width:" + ('+this.lineWidth+'+ Math.abs(values.x1-values.x2)) + "px": ""]};{[values.y1!=values.y2 ? "height:" + ('+this.lineWidth+'+ Math.abs(values.y1-values.y2)) + "px": ""]}"><\/div><\/tpl><div style="'+r+':{[values.lineCoordinates[values.lineCoordinates.length - 1].x2]}px;top:{[values.lineCoordinates[values.lineCoordinates.length - 1].y2]}px" class="{0}-arrow-ct {0} {[ values.dependency.isHighlighted ? "{1}" : "" ]} sch-dep-{id} {[this.getSuffixedCls(values.cls, "-arrow-ct")]}"><img src="'+Ext.BLANK_IMAGE_URL+'" class="{0}-arrow {0}-arrow-{[this.getArrowDirection(values.lineCoordinates)]} {[this.getSuffixedCls(values.cls, "-arrow")]}" /><\/div>').replace(/\{0\}/g,this.dependencyCls).replace(/\{1\}/g,this.selectedCls)+"<\/tpl>",{getArrowDirection:function(n){var t=n[n.length-1];return t.y2<t.y1?"up":t.x1===t.x2?"down":!i&&t.x1>t.x2||i&&t.x1<t.x2?"left":"right"},getSuffixedCls:function(n,t){return n&&n.indexOf(" ")!=-1?n.replace(/^\s*(.*)\s*$/,"$1").split(/\s+/).join(t+" ")+t:n+t}})),this.painter=Ext.create(this.dependencyPainterClass,Ext.apply({rowHeight:t.getRowHeight(),ganttView:t},n)),this.enableDependencyDragDrop){this.dnd=Ext.create("Gnt.feature.DependencyDragDrop",{el:t.getEl(),rtl:t.rtl,ganttView:t,dragZoneConfig:this.dragZoneConfig,dropZoneConfig:this.dropZoneConfig,dependencyStore:this.store});this.dnd.on("drop",this.onDependencyDrop,this);this.relayEvents(this.dnd,["beforednd","dndstart","afterdnd","drop"])}t.rendered&&this.renderAllDependenciesBuffered();this.initDependencyListeners()},initDependencyListeners:function(){var n=this;n.ganttView.mon(n.ganttView.getEl(),{dblclick:n.onDependencyClick,click:n.onDependencyClick,contextmenu:n.onDependencyClick,scope:n,delegate:"."+n.dependencyCls})},createDependencyCanvas:function(n){return Ext.fly(n).insertFirst({cls:"sch-dependencyview-ct "+(this.lineWidth===1?" sch-dependencyview-thin ":"sch-dependencyview-thick")})},getDependencyCanvas:function(){var i=this,n=i.ganttView.getNodeContainer(),t=n&&Ext.fly(n).child("div.sch-dependencyview-ct");return n&&!t&&(t=i.createDependencyCanvas(n)),t},bindDependencyStore:function(n){this.depStoreListeners={refresh:this.renderAllDependenciesBuffered,clear:this.renderAllDependenciesBuffered,load:this.renderAllDependenciesBuffered,add:this.onDependencyAdd,update:this.onDependencyUpdate,remove:this.onDependencyDelete,scope:this};n.on(this.depStoreListeners);this.store=n},unBindDependencyStore:function(){this.depStoreListeners&&this.store.un(this.depStoreListeners)},bindTaskStore:function(n){this.taskStoreListeners={cascade:this.onTaskStoreCascade,noderemove:this.renderAllDependenciesBuffered,nodeinsert:this.renderAllDependenciesBuffered,nodeappend:this.renderAllDependenciesBuffered,nodemove:this.renderAllDependenciesBuffered,nodeexpand:this.renderAllDependenciesBuffered,nodecollapse:this.renderAllDependenciesBuffered,sort:this.renderAllDependenciesBuffered,scope:this};n.on(this.taskStoreListeners);this.taskStore=n},onTaskStoreCascade:function(n,t){t&&t.nbrAffected>0&&this.renderAllDependenciesBuffered()},unBindTaskStore:function(n){(n=n||this.taskStore,n)&&n.un(this.taskStoreListeners)},onDependencyClick:function(n,t){var i=this.getRecordForDependencyEl(t);this.fireEvent("dependency"+n.type,this,i,n,t)},highlightDependency:function(n){n instanceof Ext.data.Model||(n=this.getDependencyRecordByInternalId(n));n&&(n.isHighlighted=!0,this.getElementsForDependency(n).addCls(this.selectedCls))},unhighlightDependency:function(n){n instanceof Ext.data.Model||(n=this.getDependencyRecordByInternalId(n));n&&(n.isHighlighted=!1,this.getElementsForDependency(n).removeCls(this.selectedCls))},getElementsForDependency:function(n){var i=this,r=n instanceof Ext.data.Model?n.internalId:n,t=i.getDependencyCanvas();return t&&t.select(".sch-dep-"+r)},getDependencyRecordByInternalId:function(n){return this.store.getModelByInternalId(n)},getRecordForDependencyEl:function(n){var t=n.className.match(this.depRe),i=null,r;return t&&t[1]&&(r=t[1],i=this.getDependencyRecordByInternalId(r)),i},renderAllDependenciesBuffered:function(){var n=this,t,i=n.ganttView.up("{isHidden()}");if(i){clearTimeout(n.renderTimer);n.renderTimer=null;i.on("show",n.renderAllDependenciesBuffered,n,{single:!0});return}n.renderTimer||(t=n.getDependencyCanvas(),t&&(t.dom.style.display="none"),n.renderTimer=setTimeout(function(){n.renderTimer=null;n.ganttView.isDestroyed||n.renderAllDependencies()},0))},renderAllDependencies:function(){var n=this,t=n.getDependencyCanvas();t&&(t&&(t.dom.style.display="block"),n.renderDependencies(this.store.data.items,!0),n.fireEvent("refresh",this))},getDependencyElements:function(){var n=this,t=n.getDependencyCanvas();return t&&t.select("."+n.dependencyCls)},renderDependencies:function(n,t){var i=this,r=i.getDependencyCanvas(),u;r&&(n&&!Ext.isArray(n)&&(n=[n]),n&&n.length>0?(u=i.painter.getDependencyTplData(n),i.lineTpl[t?"overwrite":"append"](r,u)):t&&r.update())},renderTaskDependencies:function(n){var i=[],t,r;for(n instanceof Ext.data.Model&&(n=[n]),t=0,r=n.length;t<r;t++)i=i.concat(n[t].getAllDependencies());this.renderDependencies(i)},onDependencyUpdate:function(n,t){this.removeDependencyElements(t,!1);this.renderDependencies(t)},onDependencyAdd:function(n,t){this.renderDependencies(t)},removeDependencyElements:function(n){this.getElementsForDependency(n).remove()},onDependencyDelete:function(n,t){Ext.Array.each(t,function(n){this.removeDependencyElements(n)},this)},dimEventDependencies:function(n){var t=this,i=t.getDependencyCanvas();i&&i.select(t.depRe+n).setOpacity(.2)},clearSelectedDependencies:function(){var n=this,t=n.getDependencyCanvas();t.select("."+n.selectedCls).removeCls(n.selectedCls);n.store.each(function(n){n.isHighlighted=!1})},onGanttViewRowRefreshed:function(n){!this.taskStore.cascading&&(!n.previous||n.startDateField in n.previous||n.endDateField in n.previous)&&this.updateDependencies(n)},updateDependencies:function(n){var t=this;n instanceof Ext.data.Model&&(n=[n]);Ext.Array.each(n,function(n){Ext.Array.each(n.getAllDependencies(),function(n){t.removeDependencyElements(n,!1)})});this.renderTaskDependencies(n)},onNewDependencyCreated:function(){},onDependencyDrop:function(n,t,i,r){var u=this,e=u.taskStore,f;f=e&&e.getModelById(t);f&&f.linkTo(i,r,null,Ext.Function.bind(u.onNewDependencyCreated,u))},destroy:function(){this.dnd&&this.dnd.destroy();this.unBindTaskStore();this.unBindDependencyStore()},setRowHeight:function(n,t){this.rowHeight=n;this.painter.setRowHeight(n);t||this.renderAllDependencies()}});Ext.define("Gnt.template.Template",{extend:Ext.XTemplate,disableFormats:!0,isLegacyIE:Ext.isIE8m,getInnerTpl:Ext.emptyFn,innerTpl:null,dependencyTerminalMarkup:'<div class="sch-gantt-terminal sch-gantt-terminal-start"><\/div><div class="sch-gantt-terminal sch-gantt-terminal-end"><\/div>',constructor:function(n){Ext.apply(this,n);var i=n.rtl?"right":"left",t=this.getInnerTpl(n)||"";this.callParent(['<div class="sch-event-wrap {ctcls} '+Ext.baseCSSPrefix+'unselectable" style="'+i+':{offset}px">','<tpl if="isRollup">',t,"<tpl else>",n.leftLabel?'<div class="sch-gantt-labelct sch-gantt-labelct-left"><label class="sch-gantt-label sch-gantt-label-left">{leftLabel}<\/label><\/div>':"",n.rightLabel?'<div class="sch-gantt-labelct sch-gantt-labelct-right" style="left:{width}px"><label class="sch-gantt-label sch-gantt-label-right">{rightLabel}<\/label><\/div>':"",n.topLabel?'<div class="sch-gantt-labelct sch-gantt-labelct-top"><label class="sch-gantt-label sch-gantt-label-top">{topLabel}<\/label><\/div>':"",t,n.bottomLabel?'<div class="sch-gantt-labelct sch-gantt-labelct-bottom"><label class="sch-gantt-label sch-gantt-label-bottom">{bottomLabel}<\/label><\/div>':"","<\/tpl>","<\/div>"])}});Ext.define("Gnt.template.Task",{extend:Gnt.template.Template,innerTpl:'<div class="sch-gantt-progress-bar" style="width:{progressBarWidth}px;{progressBarStyle}" unselectable="on">&#160;<\/div>',getInnerTpl:function(n){var t=n.rtl?"right":"left";return'<div id="'+n.prefix+'{id}" class="sch-gantt-item sch-gantt-task-bar {cls}" unselectable="on" style="width:{width}px;{style}"><tpl if="isRollup"><tpl else><tpl if="segments"><div class="sch-gantt-segment-connector"><\/div><\/tpl>'+(n.resizeHandles==="both"||n.resizeHandles==="left"?'<div class="sch-resizable-handle sch-gantt-task-handle sch-resizable-handle-start"><\/div>':"")+'<tpl for="segments"><div id="'+n.prefix+'{parent.Id}-segment-{[xindex-1]}" class="sch-gantt-task-segment {cls}" style="'+t+':{left}px;width:{width}px;{style}" data-segmentIndex="{[xindex-1]}">'+this.innerTpl+(n.resizeHandles==="both"||n.resizeHandles==="right"?'<div class="sch-resizable-handle sch-gantt-task-handle sch-resizable-handle-end"><\/div>':"")+"<\/div><\/tpl>"+this.innerTpl+(n.resizeHandles==="both"||n.resizeHandles==="right"?'<div class="sch-resizable-handle sch-gantt-task-handle sch-resizable-handle-end"><\/div>':"")+(n.enableProgressBarResize?'<div style="'+t+':{progressBarWidth}px" class="sch-gantt-progressbar-handle"><\/div>':"")+(n.enableDependencyDragDrop?this.dependencyTerminalMarkup:"")+"<\/tpl><\/div>"}});Ext.define("Gnt.template.ParentTask",{extend:Gnt.template.Template,innerTpl:'<div class="sch-gantt-progress-bar" style="width:{progressBarWidth}px;{progressBarStyle}">&#160;<\/div><div class="sch-gantt-parenttask-arrow sch-gantt-parenttask-leftarrow"><\/div><div class="sch-gantt-parenttask-arrow sch-gantt-parenttask-rightarrow"><\/div>',getInnerTpl:function(n){return'<div id="'+n.prefix+'{id}" class="sch-gantt-item sch-gantt-parenttask-bar {cls}" style="width:{width}px; {style}">'+this.innerTpl+(n.enableDependencyDragDrop&&n.allowParentTaskDependencies?this.dependencyTerminalMarkup:"")+"<\/div>"}});Ext.define("Gnt.template.Milestone",{extend:Gnt.template.Template,innerTpl:Ext.isIE8m?'<div style="border-width:{[Math.floor(values.side*0.7)]}px;{style}" class="sch-gantt-milestone-diamond-top {cls}" unselectable="on"><\/div><div style="border-width:{[Math.floor(values.side*0.7)]}px;{style}" class="sch-gantt-milestone-diamond-bottom {cls}" unselectable="on"><\/div>':'<img style="{[values.print ? "height:" + values.side + "px;border-left-width:" + values.side + "px" : ""]};{style}" src="'+Ext.BLANK_IMAGE_URL+'" class="sch-gantt-milestone-diamond {cls}" unselectable="on"/>',getInnerTpl:function(n){return"<div "+(this.isLegacyIE?'style="width:{[Math.floor(values.side*0.7)]}px"':"")+' id="'+n.prefix+'{id}" class="sch-gantt-item sch-gantt-milestone-diamond-ct">'+this.innerTpl+'<tpl if="isRollup"><tpl else>'+(n.enableDependencyDragDrop?this.dependencyTerminalMarkup:"")+"<\/tpl><\/div>"}});Ext.define("Gnt.template.RollupTask",{extend:Ext.XTemplate,isLegacyIE:Ext.isIE8m,tplConfig:null,constructor:function(n){Ext.apply(this,n);this.tplConfig=Ext.apply(this.tplConfig||{},{disableFormats:!0,applyRollup:this.applyRollup});this.callParent(['<div class="sch-rollup-wrap">','<tpl for=".">',"{[values.tpl.apply(values)]}","<\/tpl>","<\/div>"].concat([this.tplConfig]))}});Ext.define("Gnt.template.Deadline",{extend:Ext.XTemplate,mixins:[Gnt.mixin.Localizable],disableFormats:!0,markup:'<div data-qtip="__DEADLINE__:  {date}" data-qalign="b-tl" class="gnt-deadline-indicator {cls}" style="{dir}:{offset}px"><\/div>',constructor:function(){this.markup=this.markup.replace(/__DEADLINE__/,this.L("deadline"));this.callParent([this.markup])}});Ext.define("Gnt.view.Gantt",{extend:Sch.view.TimelineGridView,alias:["widget.ganttview"],mixins:[Sch.mixin.FilterableTreeView],_cmpCls:"sch-ganttview",barMargin:4,scheduledEventName:"task",trackOver:!1,toggleOnDblClick:!1,eventSelector:".sch-gantt-item",eventWrapSelector:".sch-event-wrap",progressBarResizer:null,taskResizer:null,taskDragDrop:null,dragCreator:null,dependencyView:null,resizeConfig:null,createConfig:null,dragDropConfig:null,progressBarResizeConfig:null,drawDependencies:!0,dependencyViewConfig:null,externalGetRowClass:null,outsideLabelsGatherWidth:200,constructor:function(n){n=n||{};n&&(this.externalGetRowClass=n.getRowClass,delete n.getRowClass);this.callParent(arguments);this.on({boxready:this.onMyBoxReady,itemupdate:this.onRowUpdate,scope:this});this.mon(this.taskStore,{update:this.onTaskStoreUpdate,scope:this});this.initTreeFiltering()},onBeforeIndentationChange:function(){var n=this.getNavigationModel().getPosition();n&&n.record&&(this._lastNavigatedRecord=n.record)},onIndentationChange:function(){this._lastNavigatedRecord&&this.getNavigationModel().setPosition(this._lastNavigatedRecord);delete this._lastNavigatedRecord},onRender:function(){this.addCls("sch-ganttview-touch-only");this.mon(this.getTaskStore(),{beforeindentationchange:this.onBeforeIndentationChange,indentationchange:this.onIndentationChange,scope:this});this.configureLabels();this.setupGanttEvents();this.setupTemplates();this.callParent(arguments);var n=function(t){"TouchEvent"in window&&t.parentEvent&&t.parentEvent.type.match(/touch/i)||(Ext.getBody().un("mousemove",n,this),this.removeCls("sch-ganttview-touch-only"))};Ext.getBody().on("mousemove",n,this)},onMyBoxReady:function(){Ext.supports.Touch&&this.getNodeContainer()&&this.getDependencyView().getDependencyCanvas().insertBefore(this.getNodeContainer())},getDependencyStore:function(){return this.dependencyStore},configureFeatures:function(){if(this.enableProgressBarResize!==!1){this.progressBarResizer=Ext.create("Gnt.feature.ProgressBarResize",Ext.apply({ganttView:this},this.progressBarResizeConfig||{}));this.on({beforeprogressbarresize:this.onBeforeTaskProgressBarResize,progressbarresizestart:this.onTaskProgressBarResizeStart,afterprogressbarresize:this.onTaskProgressBarResizeEnd,scope:this})}if(this.resizeHandles!=="none"){this.taskResizer=Ext.create("Gnt.feature.TaskResize",Ext.apply({ganttView:this,validatorFn:this.resizeValidatorFn||Ext.emptyFn,validatorFnScope:this},this.resizeConfig||{}));this.on({beforedragcreate:this.onBeforeDragCreate,beforetaskresize:this.onBeforeTaskResize,taskresizestart:this.onTaskResizeStart,aftertaskresize:this.onTaskResizeEnd,progressbarresizestart:this.onTaskResizeStart,afterprogressbarresize:this.onTaskResizeEnd,scope:this})}if(this.enableTaskDragDrop){this.taskDragDrop=Ext.create("Gnt.feature.TaskDragDrop",this.up("tablepanel").getEl(),Ext.apply({gantt:this,taskSelector:this.eventSelector,deadlineSelector:".gnt-deadline-indicator",validatorFn:this.dndValidatorFn||Ext.emptyFn,validatorFnScope:this,skipWeekendsDuringDragDrop:this.taskStore.skipWeekendsDuringDragDrop},this.dragDropConfig));this.on({beforetaskdrag:this.onBeforeTaskDrag,taskdragstart:this.onDragDropStart,aftertaskdrop:this.onDragDropEnd,scope:this})}this.enableDragCreation&&(this.dragCreator=Ext.create("Gnt.feature.DragCreator",Ext.apply({ganttView:this,validatorFn:this.createValidatorFn||Ext.emptyFn,validatorFnScope:this},this.createConfig)))},getTemplateForTask:function(n,t){return n.isMilestone(t)?this.milestoneTemplate:n.isLeaf()?this.eventTemplate:this.parentEventTemplate},refreshNotReadOnlyChildNodes:function(n){n.cascadeBy({before:function(t){return t==n||!t.getReadOnly()},after:function(t){t!==n&&this.refreshNode(t)},scope:this})},setShowRollupTasks:function(n){var t,r,i;this.showRollupTasks=n;t={};this.taskStore.getRootNode().cascadeBy(function(n){if(n.getRollup()){var i=n.parentNode;t[i.internalId]=i}});for(r in t)i=this.store.indexOf(t[r]),i>=0&&this.refreshNode(i)},getRollupRenderData:function(n){for(var t,u,c=[],l=this.timeAxis,o=l.getStart(),f=l.getEnd(),s=0;s<n.childNodes.length;s++){var i=n.childNodes[s],r=i.getStartDate(),e=i.getEndDate()||r&&Sch.util.Date.add(r,i.getDurationUnit()||Sch.util.Date.DAY,1);if(i.getRollup()&&r&&e&&Sch.util.Date.intersectSpans(r,e,o,f)){t={};u=i.isMilestone();t.isRollup=!0;t.id="rollup_"+i.getId();var a=e>f,v=Sch.util.Date.betweenLesser(r,o,f),h=Math.floor(this.getXFromDate(v?r:o)),y=Math.floor(this.getXFromDate(a?f:e)),p=u?0:y-h;t.offset=u?(y||h)-this.getXOffset(i):h;t.tpl=u?this.milestoneTemplate:this.eventTemplate;t.cls=i.getCls();t.ctcls="";t.record=i;u?(t.side=Ext.isIE8m?Math.round(.3*this.getRowHeight()):Math.round(.5*this.getRowHeight()),t.ctcls+=" sch-gantt-milestone"):(t.width=Math.max(1,p),a&&(t.ctcls+=" sch-event-endsoutside "),v||(t.ctcls+=" sch-event-startsoutside "),t.ctcls+=" sch-gantt-task");i.isReadOnly()&&(t.ctcls+=" sch-gantt-task-readonly");i.isProject&&(t.ctcls+=" sch-gantt-project-task");t.cls+=" sch-rollup-task";c.push(t)}}return c},getLabelRenderData:function(n){var i=this.leftLabelField,r=this.rightLabelField,u=this.topLabelField,f=this.bottomLabelField,t={};return i&&(t.leftLabel=Ext.util.Format.htmlEncode(i.renderer.call(i.scope||this,n.data[i.dataIndex],n))),r&&(t.rightLabel=Ext.util.Format.htmlEncode(r.renderer.call(r.scope||this,n.data[r.dataIndex],n))),u&&(t.topLabel=Ext.util.Format.htmlEncode(u.renderer.call(u.scope||this,n.data[u.dataIndex],n))),f&&(t.bottomLabel=Ext.util.Format.htmlEncode(f.renderer.call(f.scope||this,n.data[f.dataIndex],n))),t},columnRenderer:function(n,t,i){var s=i.getStartDate(),ct=this.timeAxis,e=Sch.util.Date,o={},d="",v="",u=ct.getStart(),r=ct.getEnd(),lt=i.isMilestone(),bt=!1,g,ft,at,y,vt,nt,tt,et,h,c,p,b,k,l,f,yt,it,pt,rt;if(s){var w=i.getEndDate()||e.add(s,i.getDurationUnit()||e.DAY,1),kt=ct.getAt(0),wt=(kt.getEndDate()-kt.getStartDate())/this.timeAxisViewModel.getTickWidth(),dt=wt*this.outsideLabelsGatherWidth,gt=e.intersectSpans(s,w,u,r),ni=this.outsideLabelsGatherWidth>0,ti=ni&&e.intersectSpans(s,w,r,new Date(r.getTime()+dt)),ri=ni&&e.intersectSpans(s,w,new Date(u.getTime()-dt),u);if(gt||ti||ri){at=w>r;ft=e.betweenLesser(s,u,r);gt?(y=Math.floor(this.getXFromDate(ft?s:u)),vt=Math.floor(this.getXFromDate(at?r:w)),nt=lt?0:vt-y):(ft=!0,nt=0,y=ti?Math.floor(this.getXFromDate(r)+(s-r)/wt):Math.floor(this.getXFromDate(u)-(u-w)/wt));var ui=lt?(vt||y)-this.getXOffset(i):y,ot=Math.min(i.getPercentDone()||0,100)/100,a,st,ii,ht=i.getSegments(),ut;if(ht){for(tt=0,et=ht.length,h=0;h<et;h++)c=ht[h],tt+=(c.getEndDate()-c.getStartDate())*ot;for(ut=[],h=0;h<et;h++)c=ht[h],f={},yt=c.getCls()||"",l=c.getEndDate()||i.getStartDate(),k=c.getStartDate(),e.betweenLesser(k,u,r)?(p=Math.floor(this.getXFromDate(k)),b=e.betweenLesser(l,u,r)?Math.floor(this.getXFromDate(l)):Math.floor(this.getXFromDate(r))):(p=Math.floor(this.getXFromDate(u)),e.betweenLesser(l,u,r)?b=Math.floor(this.getXFromDate(l)):k>r&&l>r?p=b=Math.floor(this.getXFromDate(r))+100:k<u&&l<u?p=b=Math.floor(this.getXFromDate(u))-100:b=Math.floor(this.getXFromDate(r))),f.left=p-y,f.width=b-p,a?f.progressBarWidth=0:(tt-=l-k,tt<=0?(a=e.add(l,e.MILLI,tt),yt+=" sch-segment-in-progress",st=Math.floor(this.getXFromDate(a)),f.progressBarWidth=Math.min(Math.abs(st-p),f.width)):f.progressBarWidth=c.width),f.percentDone=ot*100,Ext.apply(f,c.data),f.cls=yt,f.SegmentIndex=h,ut.push(f);ut[0].cls+=" sch-gantt-task-segment-first";ut[et-1].cls+=" sch-gantt-task-segment-last"}else a=new Date((w-s)*ot+s.getTime()),a<u?a=u:a>r&&(a=r);st=Math.floor(this.getXFromDate(a));ii=Math.min(Math.abs(st-y),nt);o=Ext.apply({},{id:i.internalId+"-x-x",offset:ui,width:Math.max(1,nt),ctcls:"",cls:"",print:this._print,record:i,percentDone:ot*100,progressBarWidth:Math.max(0,ii-2*this.eventBorderWidth),segments:ut},i.data);g=this.eventRenderer.call(this.eventRendererScope||this,i,o,i.store)||{};Ext.apply(o,this.getLabelRenderData(i));bt=!0;Ext.apply(o,g);it=" sch-event-resizable-"+i.getResizable();lt?(o.side=Math.round((this.enableBaseline?.4:.5)*this.getRowHeight()),v+=" sch-gantt-milestone"):(o.width=Math.max(1,nt),at&&(v+=" sch-event-endsoutside "),ft||(v+=" sch-event-startsoutside "),v+=i.isLeaf()?" sch-gantt-task":" sch-gantt-parent-task");i.isReadOnly()&&(v+=" sch-gantt-task-readonly");i.isProject&&(v+=" sch-gantt-project-task");i.dirty&&(it+=" sch-dirty ");i.isDraggable()===!1&&(it+=" sch-event-fixed ");it+=i.isSegmented()?" sch-event-segmented ":" sch-event-notsegmented ";o.cls=(o.cls||"")+(i.getCls()||"")+it;o.ctcls+=" "+v;this.showRollupTasks&&(pt=this.getRollupRenderData(i),pt.length>0&&(d+=this.rollupTemplate.apply(pt)));d+=this.getTemplateForTask(i).apply(o)}}return this.enableBaseline&&(g||(g=this.eventRenderer.call(this,i,o,i.store)||{}),d+=this.baselineRenderer(i,g,u,r,bt)),rt=i.getDeadlineDate(),rt&&(d+=this.deadlineTemplate.apply({dir:this.rtl?"right":"left",offset:Math.floor(this.getXFromDate(rt)),date:this.getFormattedEndDate(rt),cls:new Date>rt&&!i.isCompleted()?"gnt-deadline-indicator-late":""})),d},baselineRenderer:function(n,t,i,r,u){var l=Sch.util.Date,e=n.getBaselineStartDate(),o=n.getBaselineEndDate();if(e&&o&&l.intersectSpans(e,o,i,r)){var a=o>r,v=l.betweenLesser(e,i,r),h=n.isBaselineMilestone(),c=Math.floor(this.getXFromDate(v?e:i)),y=Math.floor(this.getXFromDate(a?r:o)),p=Math.max(1,h?0:y-c),w=this.getTemplateForTask(n,!0),s={progressBarStyle:t.baseProgressBarStyle||"",id:"base-"+n.internalId,progressBarWidth:Math.min(100,n.getBaselinePercentDone())*p/100,percentDone:n.getBaselinePercentDone(),offset:h?(y||c)-this.getXOffset(n,!0):c,print:this._print,width:Math.max(1,p),baseline:!0},f="";return h?(s.side=Math.round(.4*this.getRowHeight()),f="sch-gantt-milestone-baseline sch-gantt-baseline-item"):f=n.isLeaf()?"sch-gantt-task-baseline sch-gantt-baseline-item":"sch-gantt-parenttask-baseline sch-gantt-baseline-item",a&&(f+=" sch-event-endsoutside "),v||(f+=" sch-event-startsoutside "),s.ctcls=f+" "+(t.basecls||""),u||Ext.apply(s,this.getLabelRenderData(n)),w.apply(s)}return""},setupTemplates:function(){var n={leftLabel:this.leftLabelField,rightLabel:this.rightLabelField,topLabel:this.topLabelField,bottomLabel:this.bottomLabelField,prefix:this.eventPrefix,resizeHandles:this.resizeHandles,enableDependencyDragDrop:this.enableDependencyDragDrop!==!1,allowParentTaskDependencies:this.allowParentTaskDependencies!==!1,enableProgressBarResize:this.enableProgressBarResize,rtl:this.rtl},t;this.eventTemplate||(t=this.taskBodyTemplate?Ext.apply({innerTpl:this.taskBodyTemplate},n):n,this.eventTemplate=Ext.create("Gnt.template.Task",t));this.parentEventTemplate||(t=this.parentTaskBodyTemplate?Ext.apply({innerTpl:this.parentTaskBodyTemplate},n):n,this.parentEventTemplate=Ext.create("Gnt.template.ParentTask",t));this.milestoneTemplate||(t=this.milestoneBodyTemplate?Ext.apply({innerTpl:this.milestoneBodyTemplate},n):n,this.milestoneTemplate=Ext.create("Gnt.template.Milestone",t));this.rollupTemplate||(this.rollupTemplate=Ext.create("Gnt.template.RollupTask",n));this.deadlineTemplate||(this.deadlineTemplate=Ext.create("Gnt.template.Deadline"))},getDependencyView:function(){return this.dependencyView},getTaskStore:function(){return this.taskStore},initDependencies:function(){if(this.dependencyStore&&this.drawDependencies){var n=this,t=Ext.create("Gnt.view.Dependency",Ext.apply({containerEl:n.el,ganttView:n,enableDependencyDragDrop:n.enableDependencyDragDrop,allowParentTaskDependencies:n.allowParentTaskDependencies,store:n.dependencyStore,rtl:n.rtl},this.dependencyViewConfig));t.on({beforednd:n.onBeforeDependencyDrag,dndstart:n.onDependencyDragStart,drop:n.onDependencyDrop,afterdnd:n.onAfterDependencyDragDrop,scope:n});n.dependencyView=t;n.relayEvents(t,["dependencyclick","dependencycontextmenu","dependencydblclick"])}},setupGanttEvents:function(){var n=this.taskStore;if(this.toggleParentTasksOnClick)this.on({taskclick:function(t,i){if(!i.isLeaf()&&(!n.isTreeFiltered()||n.allowExpandCollapseWhileFiltered)){var u=this,r=function(){this.fireEvent.apply(this,["taskdblclick"].concat(Array.prototype.slice.apply(arguments)))};this.on("taskclick",r);setTimeout(function(){u.un("taskclick",r)},300);i.isExpanded()?i.collapse():i.expand()}}})},configureLabels:function(){var n={renderer:function(n){return n},dataIndex:undefined};Ext.Array.each(["left","right","top","bottom"],function(t){var i=this[t+"LabelField"];i&&(Ext.isString(i)&&(i=this[t+"LabelField"]={dataIndex:i}),Ext.applyIf(i,n),i.editor&&(i.editor=Ext.create("Gnt.feature.LabelEditor",this,{labelPosition:t,field:i.editor,dataIndex:i.dataIndex})))},this);this.on("labeledit_beforestartedit",this.onBeforeLabelEdit,this)},onBeforeTaskDrag:function(n,t){return!this.readOnly&&t.isDraggable()!==!1&&(this.allowParentTaskMove||t.isLeaf())},onDragDropStart:function(){if(this.tip)this.tip.on("beforeshow",this.falseReturningFn)},falseReturningFn:function(){return!1},onDragDropEnd:function(){this.tip&&this.tip.un("beforeshow",this.falseReturningFn)},onTaskProgressBarResizeStart:function(){this.tip&&(this.tip.hide(),this.tip.disable())},onTaskProgressBarResizeEnd:function(){this.tip&&this.tip.enable()},onTaskResizeStart:function(){this.tip&&(this.tip.hide(),this.tip.disable());this.getScrollable().setDisabled(!0)},onTaskResizeEnd:function(){this.tip&&this.tip.enable();this.getScrollable().setDisabled(!1)},onBeforeDragCreate:function(){return!this.readOnly},onBeforeTaskResize:function(n,t){return!this.readOnly&&t.getSchedulingMode()!=="EffortDriven"},onBeforeTaskProgressBarResize:function(){return!this.readOnly},onBeforeLabelEdit:function(){return!this.readOnly},afterRender:function(){this.initDependencies();this.callParent(arguments);this.getEl().on("mousemove",this.configureFeatures,this,{single:!0});Ext.dd.ScrollManager.register(this.el)},resolveTaskRecord:function(n){var t=this.findItemByChild(n);return t?this.getRecord(t):null},resolveEventRecord:function(n){return this.resolveTaskRecord(n)},resolveEventRecordFromResourceRow:function(n){return this.resolveTaskRecord(n)},highlightTask:function(n,t){var r,i,f,u;if(n instanceof Ext.data.Model||(n=this.taskStore.getModelById(n)),n&&(n.isHighlighted=!0,r=this.getRow(n),r&&Ext.fly(r).addCls("sch-gantt-task-highlighted"),t!==!1))for(i=0,f=n.successors.length;i<f;i++)u=n.successors[i],this.highlightDependency(u),this.highlightTask(u.getTargetTask(),t)},unhighlightTask:function(n,t){var r,i,f,u;if(n instanceof Ext.data.Model||(n=this.taskStore.getModelById(n)),n&&(n.isHighlighted=!1,r=this.getRow(n),r&&Ext.fly(r).removeCls("sch-gantt-task-highlighted"),t!==!1))for(i=0,f=n.successors.length;i<f;i++)u=n.successors[i],this.unhighlightDependency(u),this.unhighlightTask(u.getTargetTask(),t)},getRowClass:function(n){var t="";return n.isHighlighted&&(t="sch-gantt-task-highlighted"),this.externalGetRowClass&&(t+=" "+(this.externalGetRowClass.apply(this,arguments)||"")),t},clearSelectedTasksAndDependencies:function(){this.getDependencyView().clearSelectedDependencies();this.el.select(".sch-gantt-task-highlighted").removeCls("sch-gantt-task-highlighted");this.taskStore.getRootNode().cascadeBy(function(n){n.isHighlighted=!1})},getCriticalPaths:function(){return this.taskStore.getCriticalPaths()},highlightCriticalPaths:function(){this.clearSelectedTasksAndDependencies();var u=this.getCriticalPaths(),f=this.getDependencyView(),t,n,i,r;Ext.Array.each(u,function(u){for(n=0,i=u.length;n<i;n++)if(t=u[n],this.highlightTask(t,!1),n<i-1){for(var e=0,o=t.predecessors.length;e<o;e++)if(t.predecessors[e].getSourceId()==u[n+1].getId()){r=t.predecessors[e];break}f.highlightDependency(r)}},this);this.addCls("sch-gantt-critical-chain")},unhighlightCriticalPaths:function(){this.removeCls("sch-gantt-critical-chain");this.clearSelectedTasksAndDependencies()},getXOffset:function(n,t){var i=0;return n.isMilestone(t)&&(i=Math.floor(this.getRowHeight()*Math.sqrt(2)/4)-2),i},onDestroy:function(){this.dependencyView&&this.dependencyView.destroy();this.rendered&&Ext.dd.ScrollManager.unregister(this.el);this.callParent(arguments)},highlightDependency:function(n){this.dependencyView.highlightDependency(n)},unhighlightDependency:function(n){this.dependencyView.unhighlightDependency(n)},onBeforeDependencyDrag:function(n,t){return this.fireEvent("beforedependencydrag",this,t)},onDependencyDragStart:function(){this.fireEvent("dependencydragstart",this);this.tip&&this.tip.disable();this.preventOverCls=!0},onDependencyDrop:function(n,t,i,r){this.fireEvent("dependencydrop",this,this.taskStore.getModelById(t),this.taskStore.getModelById(i),r)},onAfterDependencyDragDrop:function(){this.fireEvent("afterdependencydragdrop",this);this.tip&&this.tip.enable();this.preventOverCls=!1},getLeftEditor:function(){return this.leftLabelField&&this.leftLabelField.editor},getRightEditor:function(){return this.rightLabelField&&this.rightLabelField.editor},getTopEditor:function(){return this.topLabelField&&this.topLabelField.editor},getBottomEditor:function(){return this.bottomLabelField&&this.bottomLabelField.editor},editLeftLabel:function(n){var t=this.getLeftEditor();t&&t.edit(n)},editRightLabel:function(n){var t=this.getRightEditor();t&&t.edit(n)},editTopLabel:function(n){var t=this.getTopEditor();t&&t.edit(n)},editBottomLabel:function(n){var t=this.getBottomEditor();t&&t.edit(n)},getDependenciesForTask:function(n){return window.console&&console.warn&&console.warn("`ganttPanel.getDependenciesForTask()` is deprecated, use `task.getAllDependencies()` instead"),n.getAllDependencies()},onRowUpdate:function(n,t){var i=this.store.getAt(t),r=i.previous;r&&(i.parentNode&&(i.rollupField in r||i.getRollup())&&this.refreshNode(i.parentNode),i.readOnlyField in r&&this.refreshNotReadOnlyChildNodes(i))},onTaskStoreUpdate:function(n,t){var i=t.previous;i&&t.getRollup()&&t.parentNode&&!t.parentNode.expanded&&n.isUndoingOrRedoing()&&this.refreshNode(t.parentNode)},handleScheduleEvent:function(n){var t=n.getTarget("."+this.timeCellCls,3),i;t&&(i=this.findRowByChild(t),n.type.indexOf("pinch")>=0?this.fireEvent("schedule"+n.type,this,n):this.fireEvent("schedule"+n.type,this,this.getDateFromDomEvent(n,"floor"),this.indexOf(i),n))},scrollEventIntoView:function(n,t,i,r,u){var e,s;u=u||this;var o=this,v=this.taskStore,l=function(n,f){o.up("panel").scrollTask.cancel();o.scrollElementIntoView(n,f,i);t&&(typeof t=="boolean"?n.highlight():n.highlight(null,t));r&&r.call(u)};n.isVisible()||n.bubble(function(n){n.expand()});var f,h=n.getStartDate(),c=n.getEndDate(),a=Boolean(h&&c);a?(e=this.timeAxis,e.dateInAxis(h)&&e.dateInAxis(c)||(s=e.getEnd()-e.getStart(),e.setTimeSpan(new Date(h.getTime()-s/2),new Date(c.getTime()+s/2))),f=this.getElementFromEventRecord(n)):(f=this.getNode(n),f&&(f=Ext.fly(f).down(this.getCellSelector())));f?l(f,a):this.bufferedRenderer&&Ext.Function.defer(function(){o.bufferedRenderer.scrollTo(n,!1,function(){var t=o.getElementFromEventRecord(n);t?l(t,!0):r&&r.call(u)})},10)},setRowHeight:function(n){this.getDependencyView().setRowHeight(n,!0);this.callParent(arguments)}});Ext.define("Gnt.patches.RightClick",{extend:Sch.util.Patch,target:"Gnt.view.Gantt",maxVersion:"6.0.1",overrides:{handleScheduleBarEvent:function(n){return Ext.isGecko&&n.type==="click"&&n.button===2?!1:this.callParent(arguments)}}});Ext.define("Gnt.widget.ConstraintResolutionForm",{extend:Ext.form.Panel,mixins:[Gnt.mixin.Localizable],alias:"widget.constraintresolutionform",legacyMode:!1,config:{resolutionContext:null,dateFormat:null},bodyPadding:5,autoScroll:!0,initComponent:function(){var n=this;Ext.isObject(n.resolutionContext)||Ext.Error.raise("Can't initialize constration resolution form, resolution context is not given!");n.setupItemsFromResolutionContext(n.resolutionContext);n.setupFooterFromResolutionContext(n.resolutionContext);n.callParent(arguments)},setupItemsFromResolutionContext:function(n){var t=this,i;Ext.isObject(n)&&Ext.isArray(n.resolutions)&&Ext.isFunction(n.getCancelActionOption)||Ext.Error.raise("Invalid resolution context provided!");i=Ext.Array.map(n.resolutions,function(i,r){return{xtype:"radio",boxLabel:t.getResolutionOptionDescription(i.title,n),name:"resolutionOption",checked:i===n.getCancelActionOption(),inputValue:r,tabIndex:r}});t.items=[{xtype:"displayfield",itemId:"description",value:t.getConstraintViolationDescription(n),anchor:"-0"},{xtype:"radiogroup",itemId:"options",columns:1,title:t.L("Resolution options"),allowBlank:!1,items:i,anchor:"-0"}]},setupFooterFromResolutionContext:function(n){var t=this;Ext.isObject(n)&&Ext.isArray(n.resolutions)||Ext.Error.raise("Invalid resolution context provided!");t.fbar={itemId:"footer-tb",items:[{xtype:"checkbox",itemId:"dont-ask-cb",boxLabel:t.L("Don't ask again"),tabIndex:n.resolutions.length+1},"->",{text:t.L("OK"),itemId:"ok-btn",formBind:!0,tabIndex:n.resolutions.length+2,handler:t.onUserActionOk,scope:t},{text:t.L("Cancel"),itemId:"cancel-btn",tabIndex:n.resolutions.length+3,handler:t.onUserActionCancel,scope:t}]}},getDontAskValue:function(){var n=this;return n.down("#dont-ask-cb").getValue()},getConstraintViolationDescription:function(n){var t=this,r,u,f,i,e,o;return Ext.isObject(n)&&Ext.isDefined(n.title)&&Ext.isDefined(n.task)||Ext.Error.raise("Invalid resolution context provided!"),r=n.title,i=n.task,e=i.getName()||"",f=i.getConstraintClass(),o=t.dateFormat||t.L("dateFormat")||Ext.Date.defaultFormat,u=f&&f.getDisplayableConstraintDateForFormat(n.date,o,i)||n.date,u?Ext.String.format(t.L("Task {0} violates constraint {1} {2}"),e,r,Ext.Date.format(u,o)):Ext.String.format(t.L("Task {0} violates constraint {1}"),e,r)},getResolutionOptionDescription:function(n,t){var e=this,i,r,u,f;return Ext.isObject(t)||Ext.Error.raise("Invalid resolution context provided!"),i=t.task,u=i.getConstraintClass(),f=e.dateFormat||e.L("dateFormat")||Ext.Date.defaultFormat,r=u&&u.getDisplayableConstraintDateForFormat(t.date,f,i)||t.date,r?Ext.String.format(n,Ext.Date.format(r,f)):Ext.String.format(n,"")},onUserActionOk:function(){var n=this,t;t=n.getValues();t.dontAsk=n.getDontAskValue();n.fireEvent("ok",n,t)},onUserActionCancel:function(){var n=this;n.fireEvent("cancel",n)},getOptimalHeight:function(n){var t=this,r,u,i,f,e,o;return n&&(r=t.getXY(),u=t.getWidth(),t.setXY([-1e4,-1e4]),t.setWidth(n)),i=t.getComponent("options"),f=i.getEl().getOffsetsTo(t.body),o=t.getDockedComponent("footer-tb"),e=f[1]+Ext.getDom(i.getEl()).scrollHeight+2*t.bodyPadding+o.getHeight()+10,n&&(t.setWidth(u),t.setXY(r)),e}});Ext.define("Gnt.widget.ConstraintResolutionWindow",{extend:Ext.window.Window,alias:"widget.constraintresolutionwindow",mixins:[Gnt.mixin.Localizable],modal:!0,closable:!0,resizable:!0,collapsible:!1,border:!1,bodyBorder:!1,config:{resolutionContext:null,dateFormat:null},form:null,initComponent:function(){var n=this;n.title=n.L("Constraint violation");n.setupItems();n.height=Math.round(Ext.dom.Element.getViewportHeight()/3);n.width=Math.round(Ext.dom.Element.getViewportWidth()/4);n.callParent(arguments);n.on("afterlayout",n.onAfterOptimalLayout,n,{single:!0})},setupItems:function(){var n=this;n.layout="fit";n.form=new Gnt.widget.ConstraintResolutionForm({margin:"0 0 3 0",resolutionContext:n.getResolutionContext(),dateFormat:n.getDateFormat(),bubbleEvents:["ok","cancel"]});n.items=n.form},onAfterOptimalLayout:function(){var n=this,t,r,u,i;t=n.getHeight();r=n.form.getHeight();u=n.form.getOptimalHeight();i=u+t-r;t!=i&&n.setHeight(i)}});Ext.define("Gnt.plugin.ConstraintResolutionGui",{extend:Ext.AbstractPlugin,alias:"plugin.constraintresolutiongui",config:{dateFormat:null},cmpDetacher:null,storeDetacher:null,storedResolutions:null,init:function(){var n=this;n.callParent(arguments);n.disabled||n.enable()},enable:function(){var n=this,t=n.getCmp();n.callParent();t.rendered?n.attachToTaskStore():n.cmpDetacher=t.on("afterrender",function(){n.attachToTaskStore()},null,{destroyable:!0,single:!0})},disable:function(){var n=this,t=n.getCmp();n.callParent();t.rendered?n.detachFromTaskStore():(n.cmpDetacher&&Ext.destroy(n.cmpDetacher),n.cmpDetacher=null)},attachToTaskStore:function(){var n=this,t,i;n.storeDetacher||(t=n.getCmp(),i=t.getTaskStore(),n.storeDetacher=t.mon(i,"constraintconflict",n.onConstraintConflict,n,{destroyable:!0}))},detachFromTaskStore:function(){var n=this;n.storeDetacher&&Ext.destroy(n.storeDetacher);n.storeDetacher=null},onConstraintConflict:function(n,t){function r(){e!=-1&&(c.refreshNode(e),s.refreshNode(e),l.updateDependencies(n))}var i=this,f=i.getCmp(),c=f.lockedGrid.getView(),s=f.normalGrid.getView(),l=f.getDependencyView(),e=s.indexOf(n),u,h,o={destroy:function(){Ext.destroy(h)}};r();i.hasStoredResolutionForContext(t)?i.resolveSilently(t,r):(u=new Gnt.widget.ConstraintResolutionWindow({dateFormat:i.getDateFormat(),resolutionContext:t}),h=u.on({ok:Ext.Function.bind(i.onUserActionOk,i,[t,r,u,o],!0),cancel:Ext.Function.bind(i.onUserActionCancel,i,[t,r,u,o],!0),close:Ext.Function.bind(i.onUserActionClose,i,[t,r,o],!0),scope:i,destroyable:!0}),f.completeEdit(),u.show())},getStoredResolutions:function(){var n=this;return n.storedResolutions||(n.storedResolutions={}),n.storedResolutions},getStoredResolutionKeyForContext:function(n){return Ext.isObject(n)&&Ext.isString(n.title)&&Ext.isArray(n.resolutions)||Ext.Error.raise("Can't get stored resolution key for context, invalid context is given!"),n.title+n.resolutions.length},hasStoredResolutionForContext:function(n){var t=this,i=t.getStoredResolutionKeyForContext(n),r=t.getStoredResolutions();return Ext.isDefined(r[i])},getStoredResolutionForContext:function(n){var t=this,i=t.getStoredResolutionKeyForContext(n),r=t.getStoredResolutions();return Ext.isDefined(r[i])||Ext.Error.raise("Can't get resolution for context, no resolutions has been stored previously!"),r[i]},storeResolutionForContext:function(n,t){var i=this,r=i.getStoredResolutionKeyForContext(n),u=i.storedResolutions;i.storedResolutions[r]=t},resolveSilently:function(n,t){var r=this,i=r.getStoredResolutionForContext(n);Ext.isObject(n)&&Ext.isArray(n.resolutions)&&Ext.isDefined(n.resolutions[i])||Ext.Error.raise("Can't resolve constraint confict silently, stored resolution is inconsistent to the context given!");n.resolutions[i].resolve();t()},onUserActionOk:function(n,t,i,r,u,f,e){var o=this;Ext.isObject(t)&&Ext.isDefined(t.resolutionOption)&&Ext.isDefined(t.dontAsk)||Ext.Error.raise("Can't resolve constraint conflict according to user choise, user choise is invalid!");Ext.isObject(r)&&Ext.isArray(r.resolutions)&&Ext.isDefined(r.resolutions[t.resolutionOption])||Ext.Error.raise("Can't resolve constraint conflict according to user choise, resolution context is inconsistent to user choise!");Ext.destroy(e);f.close();t.dontAsk&&o.storeResolutionForContext(r,t.resolutionOption);r.resolutions[t.resolutionOption].resolve();u()},onUserActionCancel:function(n,t,i,r,u,f){var e=this;Ext.isObject(i)&&Ext.isFunction(i.cancelAction)||Ext.Error.raise("Invalid resolution context given!");Ext.destroy(f);u.close();i.cancelAction();r()},onUserActionClose:function(n,t,i,r,u){var f=this;i&&Ext.isFunction(i.cancelAction)||Ext.Error.raise("Invalid resolution context given!");Ext.destroy(u);i.cancelAction();r()}});Ext.define("Gnt.plugin.ProjectLines",{extend:Sch.plugin.Lines,alias:"plugin.gantt_projectlines",innerTpl:'<span class="sch-gantt-project-line-text" style="{Style}">{Text}<\/span>',labelHeight:25,showHeaderElements:!0,taskStore:null,linesFor:"both",init:function(n){this.taskStore=this.taskStore||n.getTaskStore();this.bindTaskStore(this.taskStore);this.store||(this.store=new Ext.data.Store({model:"Gnt.model.ProjectLine"}));this.callParent(arguments);n.on("viewchange",this.onViewChange,this);this.onViewChange()},bindTaskStore:function(n){var t={datachanged:this.onDataChanged,update:this.onUpdate,scope:this,delay:1};if(this.taskStore&&this.taskStore.un(t),n)n.on(t);this.taskStore=n},onDataChanged:function(){this.refresh()},onUpdate:function(n,t,i){if(t&&t.isProject&&i==Ext.data.Model.EDIT){var r=t.modified&&t.modified.Id||t.getId();this.store.remove(this.getProjectLines(r));this.store.add(this.retrieveProjectLines(t))}},onViewChange:function(){this.refresh()},loadStore:function(){this.store.removeAll(!0);this.store.add(this.retrieveProjectLines())},refresh:function(){this.loadStore()},getProjectLines:function(n){var t=[];return this.store.each(function(i){i.get("ProjectId")==n&&t.push(i)}),t},prepareProjectStartLine:function(n,t){return{Date:n.getStartDate(),Text:"Start of: "+n.getName(),Cls:"sch-gantt-project-line-start sch-gantt-project-line-"+n.getId(),ProjectId:n.getId(),Style:"margin-top:"+t*this.labelHeight+"px"}},prepareProjectEndLine:function(n,t){return{Date:n.getEndDate(),Text:"End of: "+n.getName(),Cls:"sch-gantt-project-line-end sch-gantt-project-line-"+n.getId(),ProjectId:n.getId(),Style:"margin-top:"+t*this.labelHeight+"px"}},retrieveProjectLines:function(n){for(var i=this,r=Ext.isArray(n)?n:n&&[n]||this.taskStore.getProjects(),u=[],f=i.linesFor,t=0;t<r.length;t++)f!="end"&&u.push(i.prepareProjectStartLine(r[t],t)),f!="start"&&u.push(i.prepareProjectEndLine(r[t],t));return u},destroy:function(){this.bindTaskStore(null);this.store.destroy();this.callParent(arguments)}});Ext.define("Gnt.plugin.Replicator",{extend:Ext.grid.selection.Replicator,alias:"plugin.gantt_selectionreplicator",init:function(n){this.gantt=n;this.callParent(arguments)},replicateSelection:function(n,t,i){var u=this;if(!i.columns&&!t.isColumns&&!this.gantt.isReadOnly()){var v=t.getFirstRowIndex(),b=t.getLastRowIndex(),nt=b-v+1,o=t.view.dataSource,y,p,a,s,k=u.columns,w=k.length,f,h,c,tt,l,d,g,e,r;if(nt===1)h=u.getColumnValues(o.getAt(v));else for(h=new Array(w),c=i.rows<0?[o.getAt(v+1),o.getAt(v)]:[o.getAt(b-1),o.getAt(b)],c[0]=u.getColumnValues(c[0]),c[1]=u.getColumnValues(c[1]),r=0;r<w;r++)d=c[1][r],g=c[0][r],isNaN(d)||isNaN(g)||(h[r]=Number(d)-Number(g));if(i.rows<0?(y=i.end.rowIdx,p=i.start.rowIdx-1,a=-1):(y=i.start.rowIdx,p=i.end.rowIdx+1,a=1),u.gantt.lockedGrid.view.un("beforerefresh",u.gantt.selModel.onBeforeViewRefresh,u.gantt.selModel),u.gantt.normalGrid.view.un("beforerefresh",u.gantt.selModel.onBeforeViewRefresh,u.gantt.selModel),nt===1){for(e=y;e!==p;e+=a)if(s=o.getAt(e),!s.isReadOnly())for(r=0;r<w;r++)f=k[r],f.putRawData?f.putRawData(Ext.clone(h[r]),s):f.dataIndex&&s.set(f.dataIndex,h[r])}else for(e=y;e!==p;e+=a)if(s=o.getAt(e),!s.isReadOnly())for(tt=u.getColumnValues(o.getAt(e-a)),r=0;r<w;r++)f=k[r],f.dataIndex&&(l=tt[r],isNaN(l)||(l instanceof Date?s.set(f.dataIndex,Sch.util.Date.add(l,"ms",h[r])):Ext.isEmpty(l)||s.set(f.dataIndex,Ext.coerce(Number(l)+h[r],l))));u.gantt.lockedGrid.view.on("beforerefresh",u.gantt.selModel.onBeforeViewRefresh,u.gantt.selModel);u.gantt.normalGrid.view.on("beforerefresh",u.gantt.selModel.onBeforeViewRefresh,u.gantt.selModel)}},getColumnValues:function(n){return Ext.Array.map(this.columns,function(t){return t.getRawData?t.getRawData(n):t.dataIndex?n.get(t.dataIndex):void 0})}});Ext.define("Gnt.panel.Gantt",{extend:Sch.panel.TimelineTreePanel,alias:["widget.ganttpanel"],alternateClassName:["Sch.gantt.GanttPanel"],viewType:"ganttview",layout:"border",rowLines:!0,syncRowHeight:!1,rowHeight:24,topLabelField:null,leftLabelField:null,bottomLabelField:null,rightLabelField:null,highlightWeekends:!0,weekendsAreWorkdays:!1,skipWeekendsDuringDragDrop:!0,enableTaskDragDrop:!0,enableDependencyDragDrop:!0,enableProgressBarResize:!1,toggleParentTasksOnClick:!0,addRowOnTab:!0,recalculateParents:!0,cascadeChanges:!1,showTodayLine:!1,enableBaseline:!1,baselineVisible:!1,enableAnimations:!1,animate:!1,workingTimePlugin:null,todayLinePlugin:null,allowParentTaskMove:!0,allowParentTaskDependencies:!0,enableDragCreation:!0,eventRenderer:Ext.emptyFn,eventRendererScope:null,eventTemplate:null,parentEventTemplate:null,rollupTemplate:null,milestoneTemplate:null,taskBodyTemplate:null,parentTaskBodyTemplate:null,milestoneBodyTemplate:null,autoHeight:null,calendar:null,crudManager:null,taskStore:null,dependencyStore:null,resourceStore:null,assignmentStore:null,columnLines:!1,dndValidatorFn:Ext.emptyFn,createValidatorFn:Ext.emptyFn,resizeHandles:"both",resizeValidatorFn:Ext.emptyFn,resizeConfig:null,progressBarResizeConfig:null,dragDropConfig:null,createConfig:null,autoFitOnLoad:!1,showRollupTasks:!1,enableConstraintsResolutionGui:!0,showProjectLines:!0,projectLinesConfig:null,constraintResolutionGuiConfig:null,scrollTaskIntoViewOnClick:!1,enableTaskReordering:!0,refreshLockedTreeOnDependencyUpdate:!1,_lockedDependencyListeners:null,_lastSpreadsheetSelection:null,earlyStartColumn:null,earlyEndColumn:null,lateStartColumn:null,lateEndColumn:null,earlyDatesListeners:null,lateDatesListeners:null,slackListeners:null,refreshTimeout:100,ganttEditingPlugin:null,simpleCascadeThreshold:30,forceDefineTimeSpanByStore:!0,keepSelection:!0,setShowRollupTasks:function(n){this.showRollupTasks=n;this.getSchedulingView().setShowRollupTasks(n)},onCalendarSet:function(n,t){this.needToTranslateOption("weekendsAreWorkdays")&&t.setWeekendsAreWorkDays(this.weekendsAreWorkdays);this.workingTimePlugin&&(this.workingTimePlugin.bindCalendar(t),this.workingTimePlugin.refresh());this.calendar=t},initStores:function(){var n,r,t,i;this.crudManager&&(!this.crudManager||this.crudManager instanceof Gnt.data.CrudManager||(this.crudManager=new Gnt.data.CrudManager(this.crudManager)),this.taskStore||(this.taskStore=this.crudManager.getTaskStore()),this.dependencyStore||(this.dependencyStore=this.crudManager.getDependencyStore()),this.resourceStore||(this.resourceStore=this.crudManager.getResourceStore()),this.assignmentStore||(this.assignmentStore=this.crudManager.getAssignmentStore()));this.taskStore||Ext.Error.raise("You must specify a taskStore config.");n=Ext.StoreMgr.lookup(this.taskStore);n||Ext.Error.raise("You have provided an incorrect taskStore identifier");n instanceof Gnt.data.TaskStore||Ext.Error.raise("A `taskStore` should be an instance of `Gnt.data.TaskStore` (or of a subclass)");this.mon(n,{calendarset:this.onCalendarSet,scope:this});this.mon(n,{beforeindentationchange:this.onBeforeBatchStoreUpdate,indentationchange:this.onBatchStoreUpdate,beforebatchremove:this.onBeforeBatchStoreUpdate,batchremove:this.onBatchStoreUpdate,scope:this});Ext.apply(this,{store:n,taskStore:n});r=this.calendar=n.calendar;this.dependencyStore?(this.dependencyStore=Ext.StoreMgr.lookup(this.dependencyStore),n.setDependencyStore(this.dependencyStore)):this.dependencyStore=n.dependencyStore;this.dependencyStore.allowParentTaskDependencies=this.allowParentTaskDependencies;this.dependencyStore instanceof Gnt.data.DependencyStore||Ext.Error.raise("The Gantt dependency store should be a Gnt.data.DependencyStore, or a subclass thereof.");t=this.resourceStore?Ext.StoreMgr.lookup(this.resourceStore):n.getResourceStore();t instanceof Gnt.data.ResourceStore||Ext.Error.raise("A `ResourceStore` should be an instance of `Gnt.data.ResourceStore` (or of a subclass)");i=this.assignmentStore?Ext.StoreMgr.lookup(this.assignmentStore):n.getAssignmentStore();i instanceof Gnt.data.AssignmentStore||Ext.Error.raise("An `assignmentStore` should be an instance of `Gnt.data.AssignmentStore` (or of a subclass)");this.bindAssignmentStore(i,!0);this.bindResourceStore(t,!0);this.needToTranslateOption("weekendsAreWorkdays")&&r.setWeekendsAreWorkDays(this.weekendsAreWorkdays)},onBeforeBatchStoreUpdate:function(){this.taskStore.suspendEvent("refresh","add","insert","remove");this.taskStore.filterUpdateSuspended=!0;var n=this.getSchedulingView().getNavigationModel().getPosition();n&&(this._lastNavigationPosition=n.clone());this.bufferedRenderer&&this.suspendLayouts()},onBatchStoreUpdate:function(){this.taskStore.resumeEvent("refresh","add","insert","remove");this.taskStore.filterUpdateSuspended=!1;this._lastNavigationPosition&&(this.getSchedulingView().getNavigationModel().setPosition(this._lastNavigationPosition),delete this._lastNavigationPosition);this.getView().relayFn("refreshView");this.bufferedRenderer&&(this.resumeLayouts(!0),this.taskStore.reApplyFilter())},initComponent:function(){var n,f,i,t,r,u;if(this.autoHeight=!1,this.initStores(),this.needToTranslateOption("cascadeChanges")&&this.setCascadeChanges(this.cascadeChanges),this.needToTranslateOption("recalculateParents")&&this.setRecalculateParents(this.recalculateParents),this.needToTranslateOption("skipWeekendsDuringDragDrop")&&this.setSkipWeekendsDuringDragDrop(this.skipWeekendsDuringDragDrop),this.normalViewConfig=this.normalViewConfig||{},Ext.apply(this.normalViewConfig,{taskStore:this.taskStore,dependencyStore:this.dependencyStore,snapRelativeToEventStartDate:this.snapRelativeToEventStartDate,enableDependencyDragDrop:this.enableDependencyDragDrop,enableTaskDragDrop:this.enableTaskDragDrop,enableProgressBarResize:this.enableProgressBarResize,enableDragCreation:this.enableDragCreation,allowParentTaskMove:this.allowParentTaskMove,allowParentTaskDependencies:this.allowParentTaskDependencies,toggleParentTasksOnClick:this.toggleParentTasksOnClick,resizeHandles:this.resizeHandles,enableBaseline:this.baselineVisible||this.enableBaseline,leftLabelField:this.leftLabelField,rightLabelField:this.rightLabelField,topLabelField:this.topLabelField,bottomLabelField:this.bottomLabelField,eventTemplate:this.eventTemplate,parentEventTemplate:this.parentEventTemplate,milestoneTemplate:this.milestoneTemplate,rollupTemplate:this.rollupTemplate,taskBodyTemplate:this.taskBodyTemplate,parentTaskBodyTemplate:this.parentTaskBodyTemplate,milestoneBodyTemplate:this.milestoneBodyTemplate,resizeConfig:this.resizeConfig,dragDropConfig:this.dragDropConfig,showRollupTasks:this.showRollupTasks}),(this.topLabelField||this.bottomLabelField)&&(this.addCls("sch-gantt-topbottom-labels "+(this.topLabelField?"sch-gantt-top-label":"")),this.normalViewConfig.rowHeight=52),this.configureFunctionality(),this.mon(this.taskStore,{beforecascade:this.onBeforeCascade,cascade:this.onAfterCascade,scope:this}),this.callParent(arguments),n=this.getSelectionModel(),this.keepSelection&&n instanceof Ext.grid.selection.SpreadsheetModel&&(this.mon(this.taskStore,{remove:this.tryRestoreSelectionAfterRemove,priority:1,scope:this}),Ext.getVersion().isLessThan("6.0.1")&&this.mon(this.taskStore,{remove:this.storeSelectionBeforeRemove,priority:1001,scope:this}),this.mon(this.taskStore,{beforebatchremove:this.storeSelectionBeforeRemove,batchremove:this.tryRestoreSelectionAfterBatchRemove,scope:this})),Ext.grid.selection.SpreadsheetModel&&n instanceof Ext.grid.selection.SpreadsheetModel){this.lockedGrid.view.on("render",function(n){Ext.Array.each(n.plugins,function(n){Ext.tree.plugin.TreeViewDragDrop&&n instanceof Ext.tree.plugin.TreeViewDragDrop&&n.disable()})});f=this.lockedGrid;i=n.applyExtensible;n.applyExtensible=function(){var n=i.apply(this,arguments);return f.body.appendChild(n.handle),this.applyExtensible=i,n}}if(this.autoFitOnLoad)this.normalGrid.on("afterlayout",function(){this.store.getCount()&&this.zoomToFit();this.mon(this.store,"load",function(){this.zoomToFit()},this)},this,{single:!0});this.bodyCls=(this.bodyCls||"")+" sch-ganttpanel-container-body";t=this.getSchedulingView();this.relayEvents(t,["taskclick","taskdblclick","taskcontextmenu","beforetaskresize","taskresizestart","partialtaskresize","beforetaskresizefinalize","aftertaskresize","beforeprogressbarresize","progressbarresizestart","afterprogressbarresize","beforetaskdrag","taskdragstart","beforetaskdropfinalize","beforedragcreate","dragcreatestart","beforedragcreatefinalize","dragcreateend","afterdragcreate","taskdrop","aftertaskdrop","labeledit_beforestartedit","labeledit_beforecomplete","labeledit_complete","beforedependencydrag","dependencydragstart","dependencydrop","afterdependencydragdrop","dependencyclick","dependencycontextmenu","dependencydblclick","scheduleclick","scheduledblclick","schedulecontextmenu","rowlongpress","containerlongpress"]);this.relayEvents(this.lockedGrid.getView(),["rowlongpress","containerlongpress"]);this.addRowOnTab&&(r=this.lockedGrid.getView(),r.onRowExit=Ext.Function.createInterceptor(r.onRowExit,this.beforeRowExit,this));this.registerRenderer(t.columnRenderer,t);u=" sch-ganttpanel sch-horizontal ";this.highlightWeekends&&(u+=" sch-ganttpanel-highlightweekends ");this.addCls(u);this.eventBorderWidth<1&&this.addCls("sch-gantt-no-task-border");this.baselineVisible&&this.showBaseline();this.on("add",function(n,t){t instanceof Ext.Editor&&(n.lockedGrid.suspendLayouts(),n.suspendLayouts(),n.lockedGrid.add(t),n.resumeLayouts(),n.lockedGrid.resumeLayouts())});this.on("viewready",this.onMyViewReady,this);this.on({dragcreatestart:function(){var n=this.findPlugin("scheduler_pan");n&&n.disable();this.getSchedulingView().getScrollable().setDisabled(!0)},afterdragcreate:function(){var n=this.findPlugin("scheduler_pan");n&&n.enable();this.getSchedulingView().getScrollable().setDisabled(!1)},scope:this});if(this.scrollTaskIntoViewOnClick)this.lockedGrid.on("itemclick",this.onRowClicked,this)},tryRestoreSelectionAfterRemove:function(n,t,i){var s=this.getSelectionModel(),u=this._lastSpreadsheetSelection||s.selected,h,r,c,f,e,o,a,l;if(this._lastSpreadsheetSelection=null,u&&n.getCount()!==0)if(h=this.lockedGrid.getView(),u.isCells){if(r=u.getRange(),r[1][0]===-1)return;c=h.getNodes().length-1;s.selectCells([r[0][0],Math.min(c,r[0][1])],[r[1][0],Math.min(c,r[1][1])])}else if(u.isRows&&(f=u.getRecords(),f.length)){for(e=!1,o=0,a=f.length;o<a;o++)if(e=e||n.indexOf(f[o])!==-1)break;e||(l=h.getRecord(Math.min(i,n.getCount()-1)),l&&s.select(l))}},storeSelectionBeforeRemove:function(){var n=this.getSelectionModel().getSelected(),t;n&&(n=n.clone(),n.isRows&&(t=n.getRecords(),t.length&&(n._lastRecordIndex=this.getView().indexOf(t[t.length-1]))),this._lastSpreadsheetSelection=n)},tryRestoreSelectionAfterBatchRemove:function(n,t){var i=this._lastSpreadsheetSelection,e,o,r,s,h,u,f,l,c;this._lastSpreadsheetSelection=null;this.getSelectionModel().onStoreRemove(n,t,null,!1);if(i&&n.getCount()!==0)if(e=this.getSelectionModel(),o=this.lockedGrid.getView(),i.isCells){if(r=i.getRange(),r[1][0]===-1)return;s=o.getNodes().length;e.selectCells([r[0][0],Math.min(s,r[0][1])],[r[1][0],Math.min(s,r[1][1])])}else if(i.isRows){for(h=i.getRecords(),u=!1,f=0,l=h.length;f<l;f++)if(u=u||n.indexOf(h[f])!==-1)break;u||(c=o.getRecord(Math.min(i._lastRecordIndex,n.getCount()-1)),c&&e.select(c))}},setReadOnly:function(n){this.callParent(arguments);this.fireEvent("setreadonly",this,n)},getTimeSpanDefiningStore:function(){return this.taskStore},bindAutoTimeSpanListeners:function(){this.autoFitOnLoad||this.callParent(arguments)},onBeforeCascade:function(){this.lockedGrid.view.onUpdate=this.normalGrid.view.onUpdate=Ext.emptyFn;this.suspendLayouts()},onAfterCascade:function(n,t){var u=this,f,e,i,o,s,r;if(this.lockedGrid.view.onUpdate=this.lockedGrid.view.self.prototype.onUpdate,this.normalGrid.view.onUpdate=this.normalGrid.view.self.prototype.onUpdate,u.resumeLayouts(),t.nbrAffected>0){if(f=this.lockedGrid.getView(),t.nbrAffected<=u.simpleCascadeThreshold){e=this.getView();i=this.getSchedulingView();i.suspendEvents(!0);for(o in t.affected)s=t.affected[o],r=f.store.indexOf(s),r>=0&&e.refreshNode(r);i.resumeEvents();return}this.refreshViews()}},bindFullRefreshListeners:function(n){var r=this,t,i=function(){t||(t=setTimeout(function(){t=null;r.redrawColumns([n])},r.refreshTimeout))};n.mon(this.taskStore,{nodeappend:i,nodeinsert:i,noderemove:i,scope:this})},bindSequentialDataListeners:function(n){var t=this.lockedGrid.view,i=this.taskStore;n.mon(i,{nodeappend:function(r,u){i.fillCount||this.updateAutoGeneratedCells(n,t.store.indexOf(u.parentNode))},nodeinsert:function(i,r,u){this.updateAutoGeneratedCells(n,t.store.indexOf(u))},noderemove:function(i,r,u){u||this.updateAutoGeneratedCells(n,t.store.indexOf(r))},nodemove:function(i,r){this.updateAutoGeneratedCells(n,t.store.indexOf(r))},scope:this})},bindSlackListeners:function(){var n=Ext.Function.createBuffered(this.updateSlackColumns,this.refreshTimeout,this,[]);this.slackListeners=this.mon(this.taskStore,{resetearlydates:n,resetlatedates:n,scope:this,destroyable:!0})},bindEarlyDatesListeners:function(){var n=Ext.Function.createBuffered(this.updateEarlyDateColumns,this.refreshTimeout,this,[]);this.earlyDatesListeners=this.mon(this.taskStore,{resetearlydates:n,scope:this,destroyable:!0})},bindLateDatesListeners:function(){var n=Ext.Function.createBuffered(this.updateLateDateColumns,this.refreshTimeout,this,[]);this.lateDatesListeners=this.mon(this.taskStore,{resetlatedates:n,scope:this,destroyable:!0})},startEditScrollToEditor:function(){var n=this.ganttEditingPlugin;!Sch.disableOverrides&&n&&n.on("beforeedit",function(n,t){t.column.getEl().scrollIntoView(this.lockedGrid.getHeaderContainer().getEl())},this,{single:!0})},beforeRowExit:function(n,t,i){if(i&&!t){var r=this.lockedGrid.getView(),u=r.getRecord(n),f=u.addTaskBelow({leaf:!0});this.startEditScrollToEditor(f)}},needToTranslateOption:function(n){return this.hasOwnProperty(n)||this.self.prototype.hasOwnProperty(n)&&this.self!=Gnt.panel.Gantt},getDependencyView:function(){return this.getSchedulingView().getDependencyView()},disableWeekendHighlighting:function(n){this.workingTimePlugin.setDisabled(n)},resolveTaskRecord:function(n){return this.getSchedulingView().resolveTaskRecord(n)},fitTimeColumns:function(){this.getSchedulingView().fitColumns()},getResourceStore:function(){return this.getTaskStore().getResourceStore()},getAssignmentStore:function(){return this.getTaskStore().getAssignmentStore()},getCrudManager:function(){return this.crudManager},getTaskStore:function(){return this.taskStore},getEventStore:function(){return this.taskStore},getDependencyStore:function(){return this.dependencyStore},onDragDropStart:function(){this.tip&&(this.tip.hide(),this.tip.disable())},onDragDropEnd:function(){this.tip&&this.tip.enable()},configureFunctionality:function(){var n=this.plugins=[].concat(this.plugins||[]),t,i,r;this.highlightWeekends&&(this.workingTimePlugin=Ext.create("Gnt.feature.WorkingTime",{calendar:this.calendar}),n.push(this.workingTimePlugin));this.showTodayLine&&(this.todayLinePlugin=new Sch.plugin.CurrentTimeLine,n.push(this.todayLinePlugin));this.enableConstraintsResolutionGui&&!Ext.Array.findBy(n,function(n){return n instanceof Gnt.plugin.ConstraintResolutionGui||n.ptype=="constraintresolutiongui"})&&n.push(Ext.apply(this.constraintResolutionGuiConfig||{},{pluginId:"constraintresolutiongui",ptype:"constraintresolutiongui"}));this.showProjectLines&&n.push(Ext.apply({pluginId:"gantt_projectlines",ptype:"gantt_projectlines"},this.projectLinesConfig));this.enableTaskReordering&&(this.lockedViewConfig=this.lockedViewConfig||{},this.lockedViewConfig.plugins=[].concat(this.lockedViewConfig.plugins||[]),t=this.lockedViewConfig.plugins,Ext.Array.each(t,function(n){(n==="treeviewdragdrop"||n.ptype==="treeviewdragdrop")&&(i=!0)}),i||(r=typeof this.enableTaskReordering!="boolean"?this.enableTaskReordering:{ptype:"treeviewdragdrop",pluginId:"bryntum_treedragdrop",nodeHighlightOnDrop:!1,nodeHighlightOnRepair:!1,containerScroll:!0,dragZone:{onBeforeDrag:Ext.Function.bind(this.onBeforeTaskReorder,this),beforeDragOver:Ext.Function.bind(this.onBeforeTaskReorderOver,this)}},t.push(r)))},getWorkingTimePlugin:function(){return this.workingTimePlugin},registerLockedDependencyListeners:function(){var n=this,t=this.getDependencyStore();this._lockedDependencyListeners=this._lockedDependencyListeners||{load:function(){var t=n.getTaskStore();t.resetEarlyDates();t.resetLateDates();n.lockedGrid.getView().refreshView()},clear:function(){var t=n.getTaskStore();t.resetEarlyDates();t.resetLateDates();n.lockedGrid.getView().refreshView()},add:function(t,i){n.refreshTasksForDependencies(i)},update:function(t,i,r){var u,f,e;r!=Ext.data.Model.COMMIT&&(u=n.lockedGrid.view,i.previous[i.fromField]&&(f=n.taskStore.getModelById(i.previous[i.fromField]),f&&u.refreshNode(f)),i.previous[i.toField]&&(e=n.taskStore.getModelById(i.previous[i.toField]),e&&u.refreshNode(e)));n.refreshTasksForDependencies([i])},remove:function(t,i){n.refreshTasksForDependencies(i)}};this.mun(t,this._lockedDependencyListeners);this.mon(t,this._lockedDependencyListeners)},getDependencyTasks:function(n){var t=n.getSourceTask(this.taskStore),i=n.getTargetTask(this.taskStore),r=[];return t&&t.getTreeStore()&&r.push(t),i&&i.getTreeStore()&&r.push(i),r},refreshLockedViewRows:function(n){for(var i=this.lockedGrid.view,t=0;t<n.length;t++)i.refreshNode(n[t])},refreshTasksForDependencies:function(n){var t=this,i={},r=[];Ext.Array.each(n,function(n){for(var f=t.getDependencyTasks(n),u=0;u<f.length;u++)i[f[u].getId()]||(i[f[u].getId()]=1,r.push(f[u]));t.refreshLockedViewRows(r)})},showBaseline:function(){this.addCls("sch-ganttpanel-showbaseline")},hideBaseline:function(){this.removeCls("sch-ganttpanel-showbaseline")},toggleBaseline:function(){this.toggleCls("sch-ganttpanel-showbaseline")},zoomToFit:function(n,t){t=Ext.apply({adjustStart:1,adjustEnd:1},t);!n&&this.taskStore.isTreeFiltered()&&(n=this.getSchedulingView().store.getRange());var i=n?this.taskStore.getTimeSpanForTasks(n):this.taskStore.getTotalTimeSpan();this.zoomToSpan(i,t)===null&&(n||this.fitTimeColumns())},getCascadeChanges:function(){return this.taskStore.cascadeChanges},setCascadeChanges:function(n){this.taskStore.cascadeChanges=n},getRecalculateParents:function(){return this.taskStore.recalculateParents},setRecalculateParents:function(n){this.taskStore.recalculateParents=n},setSkipWeekendsDuringDragDrop:function(n){this.taskStore.skipWeekendsDuringDragDrop=this.skipWeekendsDuringDragDrop=n},getSkipWeekendsDuringDragDrop:function(){return this.taskStore.skipWeekendsDuringDragDrop},bindResourceStore:function(n,t){var i=this,r={scope:i,update:i.onResourceStoreUpdate,datachanged:i.onResourceStoreDataChanged};!t&&i.resourceStore&&(n!==i.resourceStore&&i.resourceStore.autoDestroy?i.resourceStore.destroy():i.mun(i.resourceStore,r),n||(i.resourceStore=null));n&&(n=Ext.data.StoreManager.lookup(n),i.mon(n,r),this.taskStore.setResourceStore(n));i.resourceStore=n;n&&!t&&i.refreshViews()},bindAssignmentStore:function(n,t){var i=this,r={scope:i,beforetaskassignmentschange:i.onBeforeSingleTaskAssignmentChange,taskassignmentschanged:i.onSingleTaskAssignmentChange,update:i.onAssignmentStoreUpdate,datachanged:i.onAssignmentStoreDataChanged};!t&&i.assignmentStore&&(n!==i.assignmentStore&&i.assignmentStore.autoDestroy?i.assignmentStore.destroy():i.mun(i.assignmentStore,r),n||(i.assignmentStore=null));n&&(n=Ext.data.StoreManager.lookup(n),i.mon(n,r),this.taskStore.setAssignmentStore(n));i.assignmentStore=n;n&&!t&&i.refreshViews()},onResourceStoreUpdate:function(n,t){Ext.Array.each(t.getTasks(),function(n){var t=this.lockedGrid.view.store.indexOf(n);t>=0&&this.getView().refreshNode(t)},this)},onResourceStoreDataChanged:function(){this.taskStore.getRootNode().childNodes.length>0&&this.refreshViews()},onAssignmentStoreDataChanged:function(){this.taskStore.getRootNode().childNodes.length>0&&this.refreshViews()},onAssignmentStoreUpdate:function(n,t){var r=t.getTask(),i;r&&(i=this.lockedGrid.view.store.indexOf(r),i>=0&&this.getView().refreshNode(i))},onBeforeSingleTaskAssignmentChange:function(){this.assignmentStore.un("datachanged",this.onAssignmentStoreDataChanged,this)},onSingleTaskAssignmentChange:function(n,t){var i,r;this.assignmentStore.on("datachanged",this.onAssignmentStoreDataChanged,this);this.rendered&&(i=this.taskStore.getModelById(t),i&&i.parentNode&&(r=this.taskStore.indexOf(i),r>=0&&this.getView().refreshNode(r)))},updateAutoGeneratedCells:function(n,t){var i=this.lockedGrid.view,o=i.all.startIndex,e=i.all.endIndex,r,u,f;if(!(t<0)&&!(t>e))for(r=Math.max(o,t);r<=e;r++)u=i.store.getAt(r),f=this.getCellDom(i,u,n),f&&(f.firstChild.innerHTML=n.renderer(null,null,u))},getCellDom:function(n,t,i){var r=n.getNode(t,!0);return r&&Ext.fly(r).down(i.getCellSelector(),!0)},redrawColumns:function(n){var t,i,u,r,o,f,e;if(n.length&&!this.isDestroyed)for(t=this.lockedGrid.view,i=t.all.startIndex;i<=t.all.endIndex;i++)for(u=t.store.getAt(i),r=0,o=n.length;r<o;r++)f=this.getCellDom(t,u,n[r]),f&&(e=[],t.renderCell(n[r],u,i,n[r].getIndex(),i,e),f.innerHTML=e.join(""))},updateSlackColumns:function(){this.slackColumn&&this.redrawColumns([this.slackColumn])},updateEarlyDateColumns:function(){var n=[];this.earlyStartColumn&&n.push(this.earlyStartColumn);this.earlyEndColumn&&n.push(this.earlyEndColumn);n.length&&this.redrawColumns(n)},updateLateDateColumns:function(){var n=[];this.lateStartColumn&&n.push(this.lateStartColumn);this.lateEndColumn&&n.push(this.lateEndColumn);n.length&&this.redrawColumns(n)},onMyViewReady:function(){var n,i,t;this.on("beforeedit",this.onBeforeEdit,this);if(this.setupColumnListeners(),n=this.getDependencyView(),n)this.getView().on({expandbody:n.renderAllDependencies,collapsebody:n.renderAllDependencies,scope:n});if(i=this.lockedGrid.plugins||[],Ext.Array.each(i,function(n){if(Sch.plugin&&Sch.plugin.TreeCellEditing&&n instanceof Sch.plugin.TreeCellEditing)return this.ganttEditingPlugin=n,!1},this),this.mon(this.taskStore,{"nodestore-datachange-start":this.onFilterChange,"filter-clear":this.onFilterChange,scope:this}),t=this.down("splitter"),t)t.on("dragend",function(){this.saveState()},this,{delay:10});if(this.ganttEditingPlugin)this.ganttEditingPlugin.on({editingstart:this.onEditingStart,edit:this.onAfterEdit,canceledit:this.onAfterEdit})},onBeforeEdit:function(n,t){var i=t.column;return!this.isReadOnly()&&t.record.isEditable(t.field)&&(!i.isEditable||i.isEditable(t.record))},onEditingStart:function(n,t){var i=t.field;i.originalInstantUpdate&&i.setInstantUpdate(!0)},onAfterEdit:function(n,t){var i=t.column.getEditor();i.setInstantUpdate&&i.setInstantUpdate(!1)},onFilterChange:function(){this.getSelectionModel().deselectAll()},setupColumnListeners:function(){var t=this,n=this.lockedGrid.getHeaderContainer();n.on("add",this.onLockedColumnAdded,this);n.items.each(function(i){t.onLockedColumnAdded(n,i)})},onLockedColumnAdded:function(n,t){var i=Gnt.column;i&&(i.WBS&&t instanceof i.WBS||i.Sequence&&t instanceof i.Sequence?this.bindSequentialDataListeners(t):i.Dependency&&t instanceof i.Dependency&&t.useSequenceNumber?this.bindFullRefreshListeners(t):i.EarlyStartDate&&t instanceof i.EarlyStartDate?this.earlyStartColumn=t:i.EarlyEndDate&&t instanceof i.EarlyEndDate?this.earlyEndColumn=t:i.LateStartDate&&t instanceof i.LateStartDate?this.lateStartColumn=t:i.LateEndDate&&t instanceof i.LateEndDate?this.lateEndColumn=t:i.Slack&&t instanceof i.Slack&&(this.slackColumn=t));!this.slackListeners&&this.slackColumn&&this.bindSlackListeners();!this.earlyDatesListeners&&(this.earlyStartColumn||this.earlyEndColumn)&&this.bindEarlyDatesListeners();!this.lateDatesListeners&&(this.lateStartColumn||this.lateEndColumn)&&this.bindLateDatesListeners()},getState:function(){var n=this,t=n.callParent(arguments);return t.lockedWidth=n.lockedGrid.getWidth(),t},applyState:function(n){var t=this;t.callParent(arguments);n&&n.lockedWidth&&t.lockedGrid.setWidth(n.lockedWidth)},completeEdit:function(){this.ganttEditingPlugin&&this.ganttEditingPlugin.completeEdit()},cancelEdit:function(){this.ganttEditingPlugin&&this.ganttEditingPlugin.cancelEdit()},setRowHeight:function(n){var t="#"+this.getId()+" ."+Ext.baseCSSPrefix+"grid-cell";Ext.util.CSS.getRule(t)?Ext.util.CSS.updateRule(t,"height",n+"px"):Ext.util.CSS.createStyleSheet(t+"{ height:"+n+"px; }");this.getSchedulingView().setRowHeight(n)},getTaskEditor:function(n){for(var t,r=this.plugins,i=0,u=r.length;i<u;i++)if(t=r[i],t.isTaskEditor&&(!n||t.matchFilters(n)))return t},onRowClicked:function(n,t){this.getSchedulingView().scrollEventIntoView(t,!1,!1)},onBeforeTaskReorder:function(n,t){var i=t.record;return this._reorderingTask=i,!this.isReadOnly()&&i&&!i.isReadOnly()},onBeforeTaskReorderOver:function(n,t){var r=n.getTargetFromEvent(t),i;if(r)return i=n.view.getRecord(r),i!==this._reorderingTask&&!i.isReadOnly()},getSelectedRows:function(){var t=this.getSelectionModel().getSelected(),n=[];return Ext.grid.selection.Cells&&t instanceof Ext.grid.selection.Cells?t.eachRow(function(t){n.push(t)}):n=this.getSelectionModel().getSelection(),n},destroy:function(){if(this.destroyStores){var n=this.taskStore.calendarManager;this.assignmentStore&&this.assignmentStore.destroy();this.assignmentStore=null;this.resourceStore&&this.resourceStore.destroy();this.resourceStore=null;this.taskStore&&this.taskStore.destroy();this.taskStore=null;this.dependencyStore&&this.dependencyStore.destroy();this.dependencyStore=null;this.dependencyStore&&this.dependencyStore.destroy();this.dependencyStore=null;n&&n.destroy()}this.callParent(arguments)},collapseAll:function(){this.taskStore.suspendEvent("refresh","add","insert","remove");this.lockedGrid.getView().blockRefresh=this.normalGrid.getView().blockRefresh=!0;this.callParent(arguments);this.lockedGrid.getView().blockRefresh=this.normalGrid.getView().blockRefresh=!1;this.taskStore.resumeEvent("refresh","add","insert","remove");this.refreshViews()},expandAll:function(){this.lockedGrid.getView().blockRefresh=this.normalGrid.getView().blockRefresh=!0;this.callParent(arguments);this.lockedGrid.getView().blockRefresh=this.normalGrid.getView().blockRefresh=!1;this.refreshViews()}});Ext.define("Gnt.view.ResourceHistogram",{extend:Sch.view.TimelineGridView,alias:"widget.resourcehistogramview",_cmpCls:"gnt-resourcehistogramview",scheduledEventName:"bar",eventSelector:".gnt-resourcehistogram-bar",barTpl:null,barRenderer:Ext.emptyFn,limitLineRenderer:Ext.emptyFn,lineRenderer:Ext.emptyFn,lineTpl:null,limitLineTpl:null,_barCls:"gnt-resourcehistogram-bar",_limitLineCls:"gnt-resourcehistogram-limitline",_limitLineVerticalCls:"gnt-resourcehistogram-limitline-vertical",_lineCls:"gnt-resourcehistogram-line",barCls:null,limitLineCls:null,lineCls:null,limitLineWidth:1,rowHeight:60,showLimitLinesThreshold:10,showVerticalLimitLines:!0,labelMode:!1,labelPercentFormat:"0",labelUnitsFormat:"0.0",histogram:null,unitHeight:null,availableRowHeight:null,initComponent:function(){this.barCls&&(this.eventSelector="."+this.barCls);this.barTpl||(this.barTpl=new Ext.XTemplate('<tpl for=".">','<div id="{id}" class="gnt-resourcehistogram-bar '+(this.barCls||"")+' {cls}" gnt-bar-index="{index}" style="left:{left}px;top:{top}px;height:{height}px;width:{width}px">',"<tpl if=\"text !== ''\">",'<span class="gnt-resourcehistogram-bar-text" style="bottom:'+Math.floor(this.rowHeight/2)+'px">{text}<\/span>',"<\/tpl>","<\/div>","<\/tpl>"));this.lineTpl||(this.lineTpl=new Ext.XTemplate('<tpl for=".">','<div class="gnt-resourcehistogram-line '+(this.lineCls||"")+' {cls}" style="top:{top}px;"><\/div>',"<\/tpl>"));this.limitLineTpl||(this.limitLineTpl=new Ext.XTemplate('<tpl for=".">','<div class="gnt-resourcehistogram-limitline '+(this.limitLineCls||"")+' {cls}" style="left:{left}px;top:{top}px;width:{width}px;height:{height}px"><\/div>',"<\/tpl>"));this.callParent(arguments);this.unitHeight=this.getAvailableRowHeight()/(this.scaleMax-this.scaleMin+this.scaleStep)},renderLines:function(){return this.lineTpl.apply(this.prepareLines())},prepareLines:function(){var s=this.scaleMin,r=this.scaleMax,u=s,a=this.scaleLabelStep,h=this.getAvailableRowHeight(),n=[],i=this._lineCls,c=i+"min",t,f,e,l,o;if(this.scalePoints)for(e=0,l=this.scalePoints.length;e<l;e++)o=this.scalePoints[e],t={value:o.value,top:o.top||Math.round(h-this.unitHeight*(o.value-s)),cls:o.cls+(o.label?" "+i+"-label":"")+(e===0?" "+i+"-min":e==l?" "+i+"-max":"")},f=this.lineRenderer(n,t),n.push(Ext.apply(t,f));else{while(u<=r)t={value:u,top:Math.round(h-this.unitHeight*(u-s)),cls:c},f=this.lineRenderer(n,t),n.push(Ext.apply(t,f)),u+=this.scaleStep,c=u%a?"":i+"-label",u==r&&(c+=" "+i+"-max");n.length&&n[n.length-1].value!==r&&(t={value:r,top:Math.round(h-this.unitHeight*(r-s)),cls:(r%a?"":i+"-label")+" "+i+"-max"},f=this.lineRenderer(n,t),n.push(Ext.apply(t,f)))}return n},renderLimitLines:function(n){return this.limitLineTpl.apply(this.prepareLimitLines(n))},getLimitLinesConnector:function(n,t){return{left:n.right,width:1,top:Math.min(n.top,t.top),height:Math.abs(n.top-t.top)+this.limitLineWidth,cls:this._limitLineCls+"-top "+this._limitLineVerticalCls}},pushLimitLine:function(n,t,i){var r=n[n.length-1],u;i&&(r?(r.width=i.right-r.left,r.right=i.right):(t.left=i.left,t.width=t.right-i.left));r&&this.showVerticalLimitLines&&(r.visible||n.pop(),n.push(this.getLimitLinesConnector(r,t)));u=this.limitLineRenderer(n,t,i);n.push(Ext.apply(t,u))},prepareLimitLines:function(n){var e,a,s,o,h,u,c,l;if(n){var r=[],p=this.scaleMin,w=this.scaleMax,b=this.scaleStep,k=this.scaleUnit,v=this.getAvailableRowHeight(),d=this._limitLineCls,y=this.getTimeAxisViewModel()&&this.getTimeAxisViewModel().getTotalWidth(),t,i,f;for(e=0,a=n.length;e<a;e++)s=this.calendar.convertMSDurationToUnit(n[e].allocationMS,k),o=!0,s*this.unitHeight>v?(s=w+b,o=!1):s<=0&&(s=0,o=!1),h=n[e].startDate&&this.getXFromDate(n[e].startDate,!0)||0,u=n[e].endDate&&this.getXFromDate(n[e].endDate,!0)||y,h<0&&(h=0),u<0&&(u=y),i={left:h,width:u-h,right:u,top:"",height:0,cls:"",visible:o},i.top=Math.round(v-(s-p)*this.unitHeight),o&&(i.cls+=" "+d+"-top"),f=r[r.length-1]||t,c=i.width<=this.showLimitLinesThreshold,f&&(i.top==f.top||c&&!o)?(f.width=u-f.left,f.right=u,i=null,r[r.length-1]?t=null:t.width>this.showLimitLinesThreshold&&(this.pushLimitLine(r,t),t=null)):c&&o?(t?(l=t.width+i.width,t.top=Math.round(i.top*i.width/l+t.top*t.width/l),t.width=u-t.left,t.right=u):t=i,t.width>this.showLimitLinesThreshold&&(this.pushLimitLine(r,t),i=t=null)):(this.pushLimitLine(r,i,t),i=t=null);return i&&this.pushLimitLine(r,i,t),f=r[r.length-1],f&&!f.visible&&r.pop(),r}},renderBars:function(n,t){return this.barTpl.apply(this.prepareBars(n,t))},prepareBars:function(n,t){var i,e,u;if(n){var o=[],s=this.getAvailableRowHeight(),h=this._barCls,c=this.scaleUnit,a=Sch.util.Date.getShortNameOfUnit(c),l=this.scaleMin,v=this.scaleMax,y=this.scaleStep,p=v+y,r,f;for(i=0,e=n.length;i<e;i++)if(n[i].totalAllocation){if(f=this.calendar.convertMSDurationToUnit(n[i].allocationMS,c),r={id:t+"-"+i,index:i,left:this.getXFromDate(n[i].startDate,!0),width:this.getXFromDate(n[i].endDate,!0)-this.getXFromDate(n[i].startDate,!0),height:s,top:0,text:"",cls:""},this.labelMode)switch(this.labelMode){case"percent":r.text=Ext.util.Format.number(n[i].totalAllocation,this.labelPercentFormat)+"%";break;case"units":r.text=Ext.util.Format.number(f,this.labelUnitsFormat)+a;break;default:r.text=this.labelMode.apply({allocation:f,percent:n[i].totalAllocation})}f<=p?(r.height=f>=l?Math.round((f-l)*this.unitHeight):0,r.top=s-r.height):r.cls+=" "+h+"-partofbar";(n[i].totalAllocation>100||n[i].totalOverAllocationMS>0)&&(r.cls+=" "+h+"-overwork");u=this.barRenderer(t,n[i],r);u&&u.cls&&(u.cls=r.cls+" "+u.cls);r=Ext.apply(r,u);o.push(r)}return o}},getAvailableRowHeight:function(){return this.availableRowHeight?this.availableRowHeight:(this.availableRowHeight=this.rowHeight-this.cellTopBorderWidth-this.cellBottomBorderWidth,this.availableRowHeight)},resolveEventRecord:function(n){var u=this.findItemByChild(n),r;if(u&&(r=this.getRecord(u),r)){var t={resource:r},f=this.histogram.allocationData[r.getId()],e=n.getAttribute("gnt-bar-index"),i=f.bars[e];return i&&(t.startDate=i.startDate,t.endDate=i.endDate,t.assignments=i.assignments,t.allocationMS=i.allocationMS,t.totalAllocation=i.totalAllocation),t}return null},resolveEventRecordFromResourceRow:function(n){return this.resolveEventRecord(n)},getDataForTooltipTpl:function(n){return n}});Ext.define("Gnt.panel.ResourceHistogram",{extend:Sch.panel.TimelineGridPanel,mixins:[Gnt.mixin.Localizable],alias:"widget.resourcehistogram",viewType:"resourcehistogramview",layout:"border",preserveScrollOnRefresh:!0,showScaleLines:!1,showLimitLines:!0,showLimitLinesThreshold:10,showVerticalLimitLines:!0,cacheLimitDurationMS:0,cacheLimitDuration:6,cacheLimitDurationUnit:"mo",calendarResources:null,calendarListenersHash:null,calendar:null,taskStore:null,resourceStore:null,assignmentStore:null,startDate:null,endDate:null,highlightWeekends:!0,allocationData:null,scaleUnit:"HOUR",scaleMin:0,scaleMax:24,scaleLabelStep:4,scaleStep:2,rowHeight:50,scaleColumnClass:"Gnt.column.Scale",scaleColumnConfigs:["scalePoints","scaleStep","scaleLabelStep","scaleMin","scaleMax","scaleLabelStep","scaleStep"],normalViewConfigs:["barCls","barTpl","barRenderer","lineRenderer","limitLineRenderer","lineTpl","lineCls","limitLineTpl","limitLineCls","limitLineWidth","labelMode","labelPercentFormat","labelUnitsFormat","scaleMin","scaleMax","scaleStep","scaleLabelStep","scalePoints","scaleUnit","loadMask","showLimitLinesThreshold","showVerticalLimitLines","calendar"],cacheUpdateSuspended:!1,suspendedCacheUpdatesCount:0,gapThreshold:864e5,rowLines:!0,initComponent:function(){var n,t;this.cacheLimitDurationMS=Sch.util.Date.getUnitDurationInMs(this.cacheLimitDurationUnit)*this.cacheLimitDuration;this.resetAllocationDataCache();this.initStores();this.lockedGridConfig=Ext.applyIf(this.lockedGridConfig||{},{reserveScrollbar:!1,width:300,forceFit:!0});this.normalViewConfig=Ext.apply(this.normalViewConfig||{},{histogram:this,trackOver:!1,rowHeight:this.rowHeight,preserveScrollOnRefresh:this.preserveScrollOnRefresh});this.lockedViewConfig=Ext.apply(this.lockedViewConfig||{},{rowHeight:this.rowHeight,preserveScrollOnRefresh:this.preserveScrollOnRefresh});this.scalePoints&&(this.scalePoints.sort(function(n,t){return n.value>t.value?1:-1}),this.scaleMin=this.scalePoints[0].value,this.scaleMax=this.scalePoints[this.scalePoints.length-1].value,this.scaleStep=(this.scaleMax-this.scaleMin)/10);this.initColumns();Ext.Array.each(this.normalViewConfigs,function(n){n in this&&(this.normalViewConfig[n]=this[n])},this);this.highlightWeekends&&this.initWeekendsHightlight();this.callParent(arguments);n="gnt-resourcehistogram sch-horizontal ";this.highlightWeekends&&(n+=" gnt-resourcehistogram-highlightweekends ");this.addCls(n);this.registerRenderer(this.columnRenderer,this);t=this.getSchedulingView();this.relayEvents(t,["barclick","bardblclick","barcontextmenu"])},initStores:function(){var n=!1;if(this.crudManager&&(this.setCrudManager(this.crudManager),n=!0),this.store=this.resourceStore,this.taskStore=this.taskStore||this.store.getTaskStore(),this.calendar=this.calendar||this.taskStore&&this.taskStore.getCalendar(),!this.calendar)throw'Cannot get project calendar instance: please specify either "calendar" or "taskStore" option';this.assignmentStore=this.assignmentStore||this.store.getAssignmentStore()||this.taskStore&&this.taskStore.getAssignmentStore();n||this.bindStores()},getCrudManager:function(){return this.crudManager},setCrudManager:function(n){this.unbindStores();this.crudManagerListeners&&this.crudManagerListeners.destroy();this.crudManager=n;this.taskStore=this.crudManager.getTaskStore();this.store=this.resourceStore=this.crudManager.getResourceStore();this.assignmentStore=this.crudManager.getAssignmentStore();this.crudManagerListeners=this.mon(this.crudManager,{beforeloadapply:{fn:this.beforeCrudManagerLoad,priority:-999},load:this.afterCrudManagerLoad,destroyable:!0,scope:this});this.bindStores()},beforeCrudManagerLoad:function(){this.suspendStoreListeners()},afterCrudManagerLoad:function(){this.beforeCrudOperationStart(this.crudManager,null,"load");this.resumeStoreListeners(!0);this.onCrudOperationComplete()},bindStores:function(){this.taskStore&&this.mon(this.taskStore,{refresh:this.onTaskStoreRefresh,load:this.onTaskStoreRefresh,update:this.onTaskUpdate,nodeappend:this.onTaskUpdate,scope:this});this.assignmentStore&&this.mon(this.assignmentStore,{refresh:this.onAssignmentsRefresh,remove:this.onAssignmentsChange,update:this.onAssignmentUpdate,add:this.onAssignmentsChange,scope:this});this.calendar&&this.mon(this.calendar,{calendarchange:this.onProjectCalendarChange,scope:this});this.bindCalendarListeners();this.store&&this.mon(this.store,{update:this.onResourceUpdate,refresh:this.onResourceStoreRefresh,scope:this,priority:100})},unbindStores:function(){this.taskStore&&this.mun(this.taskStore,{refresh:this.onTaskStoreRefresh,load:this.onTaskStoreRefresh,update:this.onTaskUpdate,nodeappend:this.onTaskUpdate,scope:this});this.assignmentStore&&this.mun(this.assignmentStore,{refresh:this.onAssignmentsRefresh,remove:this.onAssignmentsChange,update:this.onAssignmentUpdate,add:this.onAssignmentsChange,scope:this});this.calendar&&this.mun(this.calendar,{calendarchange:this.onProjectCalendarChange,scope:this});this.unbindCalendarListeners();this.store&&this.mun(this.store,{update:this.onResourceUpdate,refresh:this.onResourceStoreRefresh,scope:this,priority:100})},suspendStoreListeners:function(){this.cacheUpdateSuspended=!0;this.suspendedCacheUpdatesCount=0;this.unbindStores()},resumeStoreListeners:function(n){this.cacheUpdateSuspended=!1;this.bindStores();n&&this.suspendedCacheUpdatesCount&&this.clearCacheAndRefresh()},clearCacheAndRefresh:function(n){this.resetAllocationDataCache(n);this.refreshIfRendered(n)},createDefaultColumns:function(){var t=[],i,n;i=this.resourceNameCol=new Ext.grid.column.Column({flex:1,resizable:!1,text:this.L("resourceText"),dataIndex:this.resourceStore.model.prototype.nameField});t.push(i);n={width:40,resizable:!1};Ext.copyTo(n,this,this.scaleColumnConfigs,!0);n=this.scaleCol=Ext.create(this.scaleColumnClass,n);n.on({beforerender:function(){n.setAvailableHeight(this.getSchedulingView().getAvailableRowHeight());this.scalePoints&&(this.scalePoints=n.scalePoints)},scope:this});return t.push(n),t},initColumns:function(){var i,r,t,n;if(this.columns)for(r=Ext.isArray(this.columns)?this.columns:[this.columns],t=0;t<r.length;t++)n=r[t],this.isScaleColumn(n)&&(Ext.copyToIf(n,this,this.scaleColumnConfigs),n instanceof Gnt.column.Scale||(n=r[t]=Ext.ComponentManager.create(n,n.xtype)),this.mon(n,{beforerender:function(){n.setAvailableHeight(this.getSchedulingView().getAvailableRowHeight())},scope:this,single:!0}));else this.columns=this.createDefaultColumns(),i=this.scaleCol,this.scalePoints&&(this.scaleMin=i.scaleMin,this.scaleMax=i.scaleMax,this.scaleStep=i.scaleStep)},isScaleColumn:function(n){var t=n.xtype&&Ext.ClassManager.getByAlias(n.xtype);return t=t&&t.prototype,n instanceof Gnt.column.Scale||t&&t instanceof Gnt.column.Scale},initWeekendsHightlight:function(){this.workingTimePlugin=new Gnt.feature.WorkingTime({calendar:this.calendar});this.plugins=[].concat(this.plugins||[]);this.plugins.push(this.workingTimePlugin)},destroy:function(){this.unbindStores();this.callParent(arguments)},getEventStore:function(){return this.taskStore},getTimeSpanDefiningStore:function(){return this.taskStore},unbindResourceCalendarListener:function(n,t){var i=this.calendarResources[t];i&&(Ext.Array.remove(i,n),i.length||(this.calendarListenersHash[t].destroy(),delete this.calendarListenersHash[t],delete this.calendarResources[t]))},bindResourceCalendarListener:function(n){var t=this,r=n.getOwnCalendar(),i=r.getCalendarId();t.calendarListenersHash[i]||(t.calendarListenersHash[i]=t.mon(r,{load:t.onCalendarChange,calendarchange:t.onCalendarChange,scope:t,destroyable:!0}));t.calendarResources[i]?Ext.Array.indexOf(t.calendarResources,n)===-1&&t.calendarResources[i].push(n):t.calendarResources[i]=[n]},bindCalendarListeners:function(){var n=this;n.unbindCalendarListeners();n.store.each(function(t){var i=t.getOwnCalendar();i&&i!==n.calendar&&n.bindResourceCalendarListener(t)})},unbindCalendarListeners:function(){for(var n in this.calendarListenersHash)this.calendarListenersHash[n].destroy();this.calendarResources=[];this.calendarListenersHash={}},onTaskStoreRefresh:function(){this.clearCacheAndRefresh()},onCalendarChange:function(n){var i=this.calendarResources[n.getCalendarId()],t;if(i)for(t=0;t<i.length;t++)this.clearCacheAndRefresh(i[t])},onProjectCalendarChange:function(){this.clearCacheAndRefresh()},onTaskUpdate:function(n,t){var i=this.assignmentStore&&t.getAssignmentStore()!=this.assignmentStore?this.assignmentStore.getAssignmentsForTask(t.getId()):t.getAssignments();this.onAssignmentsChange(this.assignmentStore,i)},onAssignmentsRefresh:function(n){this.onAssignmentsChange(n,n.getRange())},onAssignmentUpdate:function(n,t,i,r){var f=this,e=f.assignmentStore.model.prototype.resourceIdField,u,o;if(i==Ext.data.Model.EDIT){r&&Ext.Array.contains(r,e)&&(o=t.previous[e],u=this.resourceStore.getModelById(o),u&&this.clearCacheAndRefresh(u));f.onAssignmentsChange(n,[t])}},onAssignmentsChange:function(n,t){var u=this,i,r,f;for(Ext.isArray(t)||(t=[t]),r=0,f=t.length;r<f;r++)i=u.resourceStore.getModelById(t[r].getResourceId()),i&&!i.inOnCalendarChange&&u.clearCacheAndRefresh(i)},findEndIndex:function(n,t){var r,i;for(t=t||this.getEndDate(),r=n.length-1,i=r;i>=0;i--)if(n[i].startDate<t){r=i;break}return r},findStartIndex:function(n,t){var r,i,u;for(t=t||this.getStartDate(),r=0,i=0,u=n.length;i<u;i++)if(n[i].endDate>t){r=i;break}return r},resetAllocationDataCache:function(n){var t=this;n?(t.allocationData=t.allocationData||{},t.allocationData[n.getId()]=null):t.allocationData={}},constrainAllocationDataCache:function(n){var t=this,i=new Date(t.timeAxis.getStart()-this.cacheLimitDurationMS),r=new Date(t.timeAxis.getEnd()-0+this.cacheLimitDurationMS),o=n.maxBars.length-1,f=0,s=n.bars.length-1,e=0,u=!1;return n.cacheEnd>r&&(o=t.findEndIndex(n.maxBars,r),s=t.findEndIndex(n.bars,r),n.cacheEnd=r,u=!0),n.cacheStart<i&&(f=t.findStartIndex(n.maxBars,i),e=t.findStartIndex(n.bars,i),n.cacheStart=i,u=!0),u&&(n.maxBars=Ext.Array.splice(n.maxBars,f,o+1-f),n.bars=Ext.Array.splice(n.bars,e,s+1-e)),u},updateAllocationDataCache:function(n,t,i){var y=Sch.util.Date,u=this,r,o,s,f,e,h,c,l,a,v;if(u.cacheUpdateSuspended){u.suspendedCacheUpdatesCount++;return}t=t||u.getStartDate();i=i||u.getEndDate();n?(r=u.allocationData[n.getId()]||{},o=r.cacheStart,s=r.cacheEnd,(o!=t||s!=i)&&(o&&s&&y.intersectSpans(o,s,t,i)?(o>t&&(f=u.processAllocationData(n.getAllocationInfo({startDate:t,endDate:o,includeResCalIntervals:!0})),f.maxBars.length&&f.maxBars[f.maxBars.length-1].startDate.getTime()===o.getTime()&&f.maxBars.pop(),f.bars.length&&r.bars.length&&(h=f.bars[f.bars.length-1],c=r.bars[0],h.startDate>=c.startDate&&h.endDate<=c.endDate&&f.bars.pop()),f.maxBars.length&&(f.maxBars[f.maxBars.length-1].endDate=o),r.maxBars.length&&(r.maxBars[0].startDate=o),r.bars=f.bars.concat(r.bars),r.maxBars=f.maxBars.concat(r.maxBars),r.maxBarsStartIndex=0,r.barsStartIndex=0,r.cacheStart=t),s<i&&(e=u.processAllocationData(n.getAllocationInfo({startDate:s,endDate:i,includeResCalIntervals:!0})),e.maxBars.length&&(l=e.maxBars[0],l.endDate.getTime()===s.getTime()?e.maxBars.shift():l.startDate=s),e.bars.length&&r.bars.length&&(a=e.bars[0],v=r.bars[r.bars.length-1],a.startDate>=v.startDate&&a.endDate<=v.endDate&&e.bars.shift()),e.maxBars.length&&(e.maxBars[e.maxBars.length-1].endDate=i),r.maxBars.length&&(r.maxBars[r.maxBars.length-1].endDate=s),r.bars=r.bars.concat(e.bars),r.maxBars=r.maxBars.concat(e.maxBars),r.maxBarsEndIndex=r.maxBars.length-1,r.barsEndIndex=r.bars.length-1,r.cacheEnd=i),u.cacheLimitDuration>0&&u.constrainAllocationDataCache(r),r.maxBarsStartIndex=u.findStartIndex(r.maxBars,t),r.barsStartIndex=u.findStartIndex(r.bars,t),r.maxBarsEndIndex=u.findEndIndex(r.maxBars,i),r.barsEndIndex=u.findEndIndex(r.bars,i)):(r=u.processAllocationData(n.getAllocationInfo({startDate:t,endDate:i,includeResCalIntervals:!0})),r.maxBarsStartIndex=0,r.maxBarsEndIndex=r.maxBars.length-1,r.barsStartIndex=0,r.barsEndIndex=r.bars.length-1,r.cacheStart=t,r.cacheEnd=i)),u.allocationData[n.getId()]=r):u.resourceStore.each(function(n){u.updateAllocationDataCache(n,t,i)})},isBarAssignmentsChanged:function(n){var r=n.bar,t=n.period,i,u;if(!r.assignments||!t.inResourceCalendar||!t.totalAllocation||!t.inTasksCalendar)return!1;for(i=0,u=r.assignments.length;i<u;i++)if(t.assignmentsHash[r.assignments[i].getTaskId()])return!1;return!0},openBar:function(n,t){return t.bar={startDate:n,totalAllocation:t.period.totalAllocation,allocationMS:t.allocationMS,assignments:t.period.assignments,totalOverAllocationMS:t.totalOverAllocationMS},t.barOpened=!0,t.bar},closeBar:function(n,t){if(!t.barOpened)return!1;n&&(t.bar.endDate=n);t.bars.push(t.bar);t.barOpened=!1},appendZeroMaxBars:function(n,t,i){var u,f;if(!n||(u=this,f=Sch.util.Date.getDurationInDays(n,t),f<2))return!1;var e=!0,r=i.maxBar,o=i.maxBars;return r&&(r.allocationMS?(r.endDate=Sch.util.Date.getStartOfNextDay(n,!0),o.push(r)):e=!1),e&&(i.maxBar={startDate:r&&r.endDate||u.getStart(),allocationMS:0}),i.maxAllocationMS=0,i.maxBar},getMergePeriodStart:function(n){return Ext.Date.clearTime(n,!0)},processAllocationData:function(n){var u,o,e,v,s,y,p,b,h,k,w,nt,d=[],c=[],i=this,t={bars:d,maxBars:c},r=i.getMergePeriodStart(n[0].startDate),l,g,f,a;for(r>this.getStartDate()&&c.push({startDate:this.getStartDate(),endDate:r,allocationMS:0}),l=0,g=n.length;l<g;l++){if(u=t.period=n[l],r=i.getMergePeriodStart(u.startDate),r-v!=0){for(this.showLimitLines&&i.appendZeroMaxBars(v,r,t)&&(e=t.maxBar),v=r,b=t.allocationMS,nt=t.totalOverAllocationMS,k=t.maxAllocationMS,p=0,w=0,h=0,f=l;n[f]&&i.getMergePeriodStart(n[f].startDate)-r==0;)n[f].inResourceCalendar&&(h+=n[f].endDate-n[f].startDate,n[f].totalAllocationMS&&(p+=n[f].totalAllocationMS,w+=n[f].totalOverAllocationMS||0)),f++;t.allocationMS=p;t.totalOverAllocationMS=w;t.maxAllocationMS=h}else r=!1;i.showLimitLines&&(r&&h!=k&&(e&&(e.endDate=r,c.push(e)),e=t.maxBar={startDate:r,allocationMS:h}),e.endDate=u.endDate);t.barOpened?u.inTask?(a=!1,i.isBarAssignmentsChanged(t)?(s=o.endDate,y=new Date(u.startDate),a=!0):r&&r-o.endDate>=i.gapThreshold?(s=Ext.Date.clearTime(o.endDate,!0),s<o.endDate&&(s=Sch.util.Date.add(s,Sch.util.Date.DAY,1)),y=Ext.Date.clearTime(u.startDate,!0),a=!0):r&&p!==b&&u.totalAllocation&&(s=y=Ext.Date.clearTime(u.startDate,!0),a=!0),a&&(i.closeBar(s,t),o=i.openBar(y,t))):i.closeBar(null,t):u.inTask&&(o=i.openBar(new Date(u.startDate),t));t.barOpened&&(o.endDate=u.endDate)}return i.closeBar(null,t),i.showLimitLines&&(i.appendZeroMaxBars(v||i.getStart(),i.getEnd(),t)&&(e=t.maxBar),e&&c.push(e)),{bars:d,maxBars:c}},onResourceUpdate:function(n,t,i,r){var f,u;Ext.Array.indexOf(r,t.calendarIdField)>-1&&(this.resetAllocationDataCache(t),f=t.previous[t.calendarIdField],this.unbindResourceCalendarListener(t,f),u=t.getOwnCalendar(),u&&u!==this.calendar&&this.bindResourceCalendarListener(t))},onResourceStoreRefresh:function(){var n=this;n.clearCacheAndRefresh();n.bindCalendarListeners()},refreshIfRendered:function(n){var t=this;t.rendered&&t.resourceStore&&n?t.getView().refreshNode(t.resourceStore.indexOf(n)):t.rendered&&t.getView().refresh()},columnRenderer:function(n,t,i){var e=this,s=i.getId(),o=this.normalGrid.getView(),r,u,f;return e.updateAllocationDataCache(i),r=e.allocationData[s],u=r&&r.bars,f=r&&r.maxBars,u&&(r.barsStartIndex>0||r.barsEndIndex<u.length-1)&&(u=u.slice(r.barsStartIndex,r.barsEndIndex+1)),f&&(r.maxBarsStartIndex>0||r.maxBarsEndIndex<f.length-1)&&(f=f.slice(r.maxBarsStartIndex,r.maxBarsEndIndex+1)),t.style="height:"+this.getSchedulingView().getAvailableRowHeight()+"px",(e.showScaleLines?o.renderLines():"")+o.renderBars(u,s)+(e.showLimitLines?o.renderLimitLines(f):"")}});Ext.define("Gnt.panel.ResourceUtilization",{extend:Sch.panel.SchedulerTree,alias:"widget.resourceutilizationpanel",enableDragCreation:!1,enableEventDragDrop:!1,eventResizeHandles:"none",readOnly:!0,rowHeight:32,rowLines:!0,eventBorderWidth:0,columnLines:{useLowestHeader:!0},variableRowHeight:!1,syncRowHeight:!1,lockedGridDependsOnSchedule:!1,underUtilizationThreshold:99,overUtilizationThreshold:100,columns:[{xtype:"treecolumn",flex:1,resizable:!1,sortable:!1,renderer:function(n,t,i){return i.isSurrogateResource()?i.getName():i.getTaskName()}}],config:{taskStore:null,numberFormat:"0"},resourceStoreClass:"Gnt.data.ResourceUtilizationStore",viewConfig:{markDirty:!1,dynamicRowHeight:!1,getRowClass:function(n){return n.data.leaf?"gnt-utilizationrow-task":"gnt-utilizationrow-resource"}},eventBodyTemplate:'<tpl for="."><div class="gnt-resource-utilization-interval gnt-resource-utilization-interval-{status} {cls}" style="{dir}: {position}px; width: {width}px;{style}"data-utilization-interval-start="{startTime}"data-utilization-interval-end="{endTime}">{value}<\/div><\/tpl>',lockedGridConfig:{width:200},utilizationBarRenderer:null,utilizationBarRendererScope:null,initComponent:function(){var n=this;n.eventRendererScope=n;n.setupComponentStores();n.callParent(arguments);n.addCls("gnt-resourceutilizationpanel");n.provideTimeAxisToStore();n.partnerTimelinePanel&&Ext.isFunction(n.partnerTimelinePanel.getTaskStore)&&n.resourceStore.setTaskStore(n.partnerTimelinePanel.getTaskStore());n.resourceStore.fillStore()},setupComponentStores:function(){var n=this;n.resourceStore=n.resourceStore||Ext.create(n.resourceStoreClass,{underUtilizationThreshold:this.underUtilizationThreshold,overUtilizationThreshold:this.overUtilizationThreshold,taskStore:n.getTaskStore()});n.eventStore=n.resourceStore.getEventStore()},provideTimeAxisToStore:function(){var n=this;n.getStore().setTimeAxis(n.timeAxis)},eventRenderer:function(n,t){var h=Ext.util.Format,i=this,u=i.getSchedulingView(),c=n.getStartDate(),l=36e5,a=i.getNumberFormat(),e=[],o,r,f,s,v=this.utilizationBarRendererScope||this;return o=u.getXFromDate(c),n.forEachInterval(function(c,y){var p=n.getUtilizationInfoForInterval(c),b=h.number(p.allocationMs/l,a),w={};r=u.getXFromDate(c);f=u.getXFromDate(y)-1;s=p.isUtilized?p.isUnderallocated?"underallocated":p.isOverallocated?"overallocated":"optimallyallocated":"notutilized";i.utilizationBarRenderer&&i.utilizationBarRenderer.call(v,p,t,c,y,w);e.push({status:s,dir:i.rtl?"right":"left",position:r-o,width:f-r,startTime:c.getTime(),endTime:y.getTime(),value:f-r>10?b:"",style:w.style||"",cls:w.cls||""})}),e},getRowHeight:function(){return this.rowHeight}});Ext.define("Gnt.panel.TimelineScheduler",{extend:Sch.panel.SchedulerGrid,alias:"widget.gantt_timelinescheduler",taskStore:null,split:!1,milestoneBottomPadding:23,barMargin:0,header:!1,enableColumnMove:!1,enableColumnHide:!1,enableColumnResize:!1,sortableColumns:!1,trackMouseOver:!1,bufferedRenderer:!1,border:!1,rowLines:!1,columnLines:!1,readOnly:!0,resizeHandles:"none",enableDragCreation:!1,enableEventDragDrop:!1,forceFit:!0,autoAdjustTimeAxis:!1,leftTimespanMargin:25,rightTimespanMargin:50,resourceStoreClass:"Sch.data.ResourceStore",eventStoreClass:"Sch.data.EventStore",refreshMainRowTimeout:5,needToZoom:!1,destroyStores:!0,variableRowHeight:!1,syncRowHeight:!1,lockedGridDependsOnSchedule:!1,initComponent:function(){var n=this,t;if(n.addCls("sch-gantt-timeline-scheduler"),n.setTaskStore(this.taskStore),Ext.apply(n,{normalViewConfig:{onEventUpdate:Ext.Function.bind(n.onEventUpdate,n),onEventAdd:Ext.Function.bind(n.onEventAdd,n),onEventRemove:Ext.Function.bind(n.onEventRemove,n)},resourceStore:n.buildResourceStore(),eventStore:n.buildEventStore(),refreshMainRow:Ext.Function.createBuffered(n.refreshMainRow,n.refreshMainRowTimeout,n)}),t=n.taskStore.getRoot(),t&&t.childNodes.length)n.on({afterlayout:n.fillStoreFromTaskStore,scope:n,single:!0});n.callParent(arguments);n.on("resize",n.onSchedResize,n);n.resourceRecord=n.resourceStore.first();var r=n.getSchedulingView(),i=r.eventLayout.horizontal,u=i.applyLayout;i.applyLayout=function(n,t){return n=Ext.Array.filter(n,function(n){return n.event.getDuration()>0}),u.call(this,n,t)};this.registerRenderer(this.rowHeightRenderer,this)},setTaskStore:function(n,t){var i=this,r={load:i.fillStoreFromTaskStore,nodeappend:i.onTaskAdded,update:i.onTaskUpdated,noderemove:i.onTaskRemoved,clear:i.onTaskStoreClear,scope:i};return t&&i.mun(t,r),n=Ext.data.StoreManager.lookup(n),i.mon(n,r),i.taskStore=n,n},buildResourceStore:function(n){return Ext.create(this.resourceStoreClass,Ext.apply({storeId:null,data:[{Id:1}]},n))},buildEventStore:function(n){return Ext.create(this.eventStoreClass,Ext.apply({storeId:null,createResourceEventsCache:Ext.emptyFn,filterEventsForResource:function(){return this.getRange()},getEventsForResource:function(){return this.getRange()},isDateRangeAvailable:function(n,t,i){var o,f,e,u,s,r;if(!n||!t)return!0;for(o=Sch.util.Date,f=this.getRange(),u=0,s=f.length;u<s;u++)if(r=f[u],e=i===r||r.getDuration()===0||!r.getStartDate()||!r.getEndDate()||!o.intersectSpans(n,t,r.getStartDate(),r.getEndDate()),!e)break;return e}},n))},refreshMainRow:function(n){n||this.needToZoom?this.zoomToFit():(this.getSchedulingView().repaintEventsForResource(this.resourceRecord),this.fitEvents())},eventRenderer:function(n,t,i){return n.store.isDateRangeAvailable(n.getStartDate(),n.getEndDate(),n,t)&&(i.cls="sch-gantt-timeline-stretch"),n.isMilestone()||(i.style="line-height:"+i.height+"px;"),n.getName()},rowHeightRenderer:function(n,t){t.style="height:"+this.getAvailableRowHeight()+"px"},onTaskStoreClear:function(){this.eventStore.removeAll()},onTaskRemoved:function(n,t,i){i||(this.eventStore.remove(t),Ext.Array.each(t.childNodes||[],function(t){this.onTaskRemoved(n,t)},this))},onTaskAdded:function(n,t){t.getShowInTimeline()&&this.eventStore.add(t)},onTaskUpdated:function(n,t,i,r){r&&Ext.Array.contains(r,t.showInTimelineField)&&(t.getShowInTimeline()?this.eventStore.add(t):this.eventStore.remove(t))},onEventAdd:function(){if(!this.needToZoom){var n=this.eventStore.getTotalTimeSpan();this.needToZoom=n.start<this.getStart()||n.end>this.getEnd()}this.refreshMainRow()},onEventRemove:function(n,t){var r,i,u;if(!this.needToZoom)for(r=this.eventStore.getTotalTimeSpan(),i=0;i<t.length;i++)if(u=t[i],r.start>u.getStartDate()||r.end<u.getEndDate()){this.needToZoom=!0;break}this.refreshMainRow()},onEventUpdate:function(n,t,i,r){var u=t.previous,f=this.eventStore.lastTotalTimeSpan;r&&(!this.needToZoom&&u&&f&&(t.startDateField in u||t.endDateField in u)&&(this.needToZoom=t.startDateField in u&&f.start-u[t.startDateField]==0||t.endDateField in u&&f.end-u[t.endDateField]==0||t.startDateField in u&&f.start>t.getStartDate()||t.endDateField in u&&f.end<t.getEndDate()),this.refreshMainRow())},fillStoreFromTaskStore:function(){var n=[],t=[];this.taskStore.forEachTaskUnordered(function(i){i.getShowInTimeline()&&(i.isMilestone()?t.push(i):n.push(i))});n=n.concat(t);this.eventStore.removeAll();(n.length||this.eventStore.getCount())&&(this.eventStore.loadData(n),this.zoomToFit())},zoomToFit:function(){this.suspendLayouts();this.needToZoom=!1;this.callParent([{leftMargin:this.leftTimespanMargin,rightMargin:this.rightTimespanMargin}]);this.fitEvents();this.resumeLayouts()},onSchedResize:function(n,t,i,r,u){i!==u&&this.fitEvents()},fitEvents:function(){var n=this.getSchedulingView().eventLayout.horizontal.nbrOfBandsByResource[this.resourceRecord.internalId]||1;this.setRowHeight(Math.ceil(this.getAvailableRowHeight()/n))},getAvailableRowHeight:function(){return this.getSchedulingView().getHeight()-this.milestoneBottomPadding}});Ext.define("Gnt.panel.Timeline",{extend:Ext.Panel,mixins:[Gnt.mixin.Localizable],alias:"widget.gantt_timeline",layout:{type:"hbox",align:"stretch"},bodyPadding:"10 0 20 0",height:190,labelWidth:100,taskStore:null,scheduler:null,schedulerClass:"Gnt.panel.TimelineScheduler",initComponent:function(){this.addCls("sch-gantt-timeline");this.scheduler=Ext.create(this.schedulerClass,{taskStore:this.taskStore,flex:1});this.scheduler.on("viewchange",this.onTimespanChange,this);this.items=this.buildItems();this.callParent(arguments)},buildItems:function(){return[{xtype:"displayfield",fieldLabel:this.L("start"),labelAlign:"top",itemId:"startlabel",cls:"sch-gantt-timeline-label sch-gantt-timeline-left-label",width:this.labelWidth},this.scheduler,{xtype:"displayfield",fieldLabel:this.L("end"),labelAlign:"top",itemId:"endlabel",cls:"sch-gantt-timeline-label sch-gantt-timeline-right-label",width:this.labelWidth}]},getStartLabel:function(){return this.startLabel||(this.startLabel=this.down("#startlabel"))},getEndLabel:function(){return this.endLabel||(this.endLabel=this.down("#endlabel"))},onTimespanChange:function(){var n=this.scheduler.getStart(),t=this.scheduler.getEnd();this.getStartLabel().setValue(Ext.Date.format(n,Ext.Date.defaultFormat));this.getEndLabel().setValue(Ext.Date.format(t,Ext.Date.defaultFormat))}});Ext.define("Gnt.patches.AbstractClipboard",{extend:Sch.util.Patch,target:"Ext.plugin.AbstractClipboard",minVersion:"6.0.0",overrides:{privates:{getData:function(n,t){var o=this,r=o.getFormats(),f,e,i,u;if(Ext.isString(t))r[t]||Ext.raise('Invalid clipboard format "'+t+'"'),f=o[r[t].get](t,n);else{if(f={},u=[],t)for(i in t)r[i]||Ext.raise('Invalid clipboard format "'+i+'"'),u.push(i);else u=Ext.Object.getAllKeys(r);for(e=u.length;e-->0;)i=u[e],f[i]=o[r[i].get](i,n&&!e)}return f}}}});Ext.define("Gnt.patches.ComboBox",{extend:Sch.util.Patch,target:"Ext.form.field.ComboBox",minVersion:"5.1.0",overrides:{checkChangeEvents:Ext.isIE10p?["change","propertychange","keyup"]:["change","input","textInput","keyup","dragdrop"]}});Ext.define("Gnt.patches.ComponentManager",{extend:Sch.util.Patch,minVersion:"6.0.0",applyFn:function(){Ext.ComponentManager.onGlobalFocus=function(n){var o=this,u=n.toElement,f=n.fromElement,r=Ext.Component.fromElement(u),i=Ext.Component.fromElement(f),e=o.getCommonAncestor(i,r),t;if(i&&!(i.destroyed||i.destroying))for(i.handleBlurEvent&&i.handleBlurEvent(n),t=i;t&&t!==e;t=t.getRefOwner()){if(t instanceof Gnt.widget.AssignmentGrid&&t.view.refreshing&&t.getRefOwner()instanceof Gnt.field.Assignment)break;if(!(t.destroyed||t.destroying))t.onFocusLeave({event:n.event,type:"focusleave",target:f,relatedTarget:u,fromComponent:i,toComponent:r})}if(r&&!r.destroyed)for(r.handleFocusEvent&&r.handleFocusEvent(n),t=r;t&&t!==e;t=t.getRefOwner())t.onFocusEnter({event:n.event,type:"focusenter",relatedTarget:f,target:u,fromComponent:i,toComponent:r})}}});Ext.define("Gnt.patches.DelimitedValue",{extend:Sch.util.Patch,target:"Ext.util.DelimitedValue",minVersion:"6.0.0",overrides:{decode:function(n){return n===""?[]:this.callParent(arguments)}}});Ext.define("Gnt.patches.IETreeStore",{extend:Sch.util.Patch,target:"Gnt.data.TaskStore",ieOnly:!0,maxVersion:"5.1.0",overrides:{onNodeAdded:function(n,t){var i=this,e=i.getProxy(),r=e.getReader(),u=t.raw||t[t.persistenceProperty],f;Ext.Array.remove(i.removed,t);t.join(i);t.isLeaf()||(f=r.getRoot(u),f&&(i.fillNode(t,r.extractData(f)),u[r.root]&&delete u[r.root]));i.autoSync&&!i.autoSyncSuspended&&(t.phantom||t.dirty)&&i.sync()}}});Ext.define("Gnt.patches.LabelEditor",{extend:Sch.util.Patch,target:"Gnt.feature.LabelEditor",minVersion:"6.0.0",maxVersion:"6.0.1",ieOnly:!0,overrides:{constructor:function(){if(this.callParent(arguments),this.rendered)this.getEl().setVisibilityMode(Ext.dom.Element.OFFSETS);else this.on("render",function(){this.getEl().setVisibilityMode(Ext.dom.Element.OFFSETS)},this,{single:!0})}}});Ext.define("Gnt.patches.Tooltip",{extend:Sch.util.Patch,target:"Ext.tip.ToolTip",minVersion:"5.1.0",overrides:{onDocMouseDown:function(){this.isDisabled()||this.callParent(arguments)}}});Ext.define("Gnt.plugin.Clipboard",{extend:Ext.grid.plugin.Clipboard,alias:"plugin.gantt_clipboard",memory:"raw",formats:{raw:{get:"getRawData",put:"putRawData"}},putTextData:function(){return},getRawData:function(n,t){var a=this.getCmp(),v=a.getSelectionModel(),f=[],y=n==="raw",p=n==="text",o,h,u,e,c,i,r,l,s;return f.schedulingFields={},v.getSelected().eachCell(function(n){(u=null,i=n.column,s=n.column.getView(),r=n.record,i.ignoreExport)||(c!==r&&(c=r,f.push(l=[])),e=i.dataIndex,Gnt.column.StartDate&&i instanceof Gnt.column.StartDate?f.schedulingFields.startDate=1:Gnt.column.EndDate&&i instanceof Gnt.column.EndDate?f.schedulingFields.endDate=1:Gnt.column.Duration&&i instanceof Gnt.column.Duration&&(f.schedulingFields.duration=1),y?i.getRawData?u=i.getRawData(r):e!==null&&(u=r.data[e]):(o=s.all.item(n.rowIdx),o||(o=Ext.fly(s.createRowElement(r,n.rowIdx))),h=o.down(i.getCellInnerSelector()),u=h.dom.innerHTML,p&&(u=Ext.util.Format.stripTags(u))),l.push(u),t&&e&&r.set(e,r.getField(e).getDefaultValue()))}),f},getCellData:function(n,t){return Ext.util.TSV.encode(this.getRawData(n,t))},putRawData:function(n){var c,y=n.length,g=y?n[0].length:0,e,o,s=this.getCmp().getView(),k=s.dataSource.getCount()-1,p=s.getVisibleColumnManager().getColumns().length-1,d=s.getNavigationModel(),t=d.getPosition(),f,w,i,r,h,l,a,v,u,b;if(t&&!this.getCmp().isReadOnly())for(t=new Ext.grid.CellContext(s).setPosition(t.record,t.column),w=t.colIdx,e=0;e<y;e++)if(c=n[e],h={},u=t.record,!u.isReadOnly()){for(o=0;t.colIdx<p&&o<c.length;){if(i=t.column,r=c[o],i.ignoreExport||(n.schedulingFields.startDate&&n.schedulingFields.endDate&&(b=i.fieldProperty==="durationField"||i.fieldProperty==="startDateField"||i.fieldProperty==="endDateField",i.fieldProperty==="startDateField"&&(a=r),i.fieldProperty==="endDateField"&&(v=r)),f=i.dataIndex,b||(i.putRawData?i.putRawData(r,t.record):f&&f!=="index"&&(l=i.field,l?l.getErrors(r).length||(h[f]=r):h[f]=r)),o++),t.colIdx===p)break;t.setColumn(t.colIdx+1)}if(u.beginEdit(),u.set(h),a!==undefined&&v!==undefined&&u.setStartEndDate(a,v),u.endEdit(),t.rowIdx===k)break;t.setPosition(t.rowIdx+1,w)}}});Ext.define("Gnt.plugin.DependencyEditor",{extend:Ext.form.Panel,alias:"plugin.gantt_dependencyeditor",ptype:"gantt_dependencyeditor",mixins:[Ext.AbstractPlugin,Gnt.mixin.Localizable],hideOnBlur:!0,showLag:!1,triggerEvent:"dependencydblclick",constrain:!0,lockableScope:"top",header:!1,border:!1,frame:!0,labelWidth:60,floating:!0,hideMode:"offsets",bodyPadding:10,initComponent:function(){this.buttons=this.hasOwnProperty("buttons")?this.buttons:this.buttons||[{text:this.L("okButtonText"),itemId:"okbutton",scope:this,handler:function(){this.getForm().updateRecord(this.dependencyRecord);this.collapse()}},{text:this.L("cancelButtonText"),itemId:"cancelbutton",scope:this,handler:function(){this.collapse()}},{text:this.L("deleteButtonText"),itemId:"deletebutton",scope:this,handler:function(){var n=this.taskStore&&this.taskStore.getDependencyStore();n.remove(this.dependencyRecord);this.collapse()}}];this.callParent(arguments);this.saveButton=this.down("#okbutton");this.deleteButton=this.down("#deletebutton");this.addCls("sch-gantt-dependencyeditor")},getState:function(){if(this.rendered)return this.callParent(arguments)},init:function(n){n.on(this.triggerEvent,this.onTriggerEvent,this);this.gantt=n;this.taskStore=n.getTaskStore();this.add(this.buildFields())},renderAndCollapse:function(){if(this.render(Ext.getBody()),this.collapse(Ext.Component.DIRECTION_TOP,!1),this.hide(),this.hideOnBlur)this.on({show:function(){this.mon(Ext.getBody(),{click:this.onMouseClick,scope:this})},hide:function(){this.mun(Ext.getBody(),{click:this.onMouseClick,scope:this})},delay:50})},show:function(n,t){if(this.dependencyRecord=n,this.getForm().loadRecord(n),this.fromLabel.setValue(Ext.String.htmlEncode(this.dependencyRecord.getSourceTask().getName())),this.toLabel.setValue(Ext.String.htmlEncode(this.dependencyRecord.getTargetTask().getName())),this.typeField){var i=this.taskStore&&this.taskStore.getDependencyStore(),r=i&&i.allowedDependencyTypes;this.typeField.store.filter();this.typeField.setReadOnly(r&&r.length<2)}this.callParent([]);this.el.setXY(t);this.expand(!this.constrain);this.constrain&&this.doConstrain(Ext.util.Region.getRegion(Ext.getBody()));this.saveButton&&this.saveButton.setVisible(!this.gantt.isReadOnly());this.deleteButton&&this.deleteButton.setVisible(!this.gantt.isReadOnly())},buildFields:function(){var n=this,t=n.taskStore&&n.taskStore.getDependencyStore(),i=[n.fromLabel=new Ext.form.TextField({readOnly:!0,border:!1,fieldLabel:n.L("fromText"),cls:"sch-gantt-dependencyeditor-readonly"}),n.toLabel=new Ext.form.TextField({readOnly:!0,border:!1,fieldLabel:n.L("toText"),cls:"sch-gantt-dependencyeditor-readonly"}),n.typeField=n.buildTypeField()];return n.showLag&&i.push(n.lagField=new Ext.form.NumberField({name:t?t.model.prototype.lagField:Gnt.model.Dependency.prototype.lagField,fieldLabel:n.L("lagText")})),i},onTriggerEvent:function(n,t,i){this.rendered||this.renderAndCollapse();t!==this.dependencyRecord&&this.show(t,i.getXY())},filterAllowedTypes:function(n){var t=this.taskStore&&this.taskStore.getDependencyStore(),r,u,i,f,e;if(!t||!t.allowedDependencyTypes)return!0;for(r=t.allowedDependencyTypes,u=t.model.Type,i=0,f=r.length;i<f;i++)if(e=u[r[i]],n.getId()==e)return!0;return!1},buildTypeField:function(){var i=this.taskStore?this.taskStore.getDependencyStore().model:Gnt.model.Dependency,n=i.Type,t;return this.typesFilter=new Ext.util.Filter({filterFn:this.filterAllowedTypes,scope:this}),t=new Ext.data.ArrayStore({fields:[{name:"id",type:"int"},"text"],data:[[n.EndToStart,this.L("endToStartText")],[n.StartToStart,this.L("startToStartText")],[n.EndToEnd,this.L("endToEndText")],[n.StartToEnd,this.L("startToEndText")]]}),t.filter(this.typesFilter),new Ext.form.field.ComboBox({name:i.prototype.typeField,fieldLabel:this.L("typeText"),triggerAction:"all",queryMode:"local",editable:!1,valueField:"id",displayField:"text",store:t})},onMouseClick:function(n){this.collapsed||n.within(this.getEl())||n.getTarget("."+Ext.baseCSSPrefix+"layer")||n.getTarget(".sch-ignore-click")||this.collapse()},afterCollapse:function(){delete this.dependencyRecord;this.hide();this.callParent(arguments);this.hideOnBlur&&this.mun(Ext.getBody(),"click",this.onMouseClick,this)}});Ext.define("Gnt.plugin.exporter.mixin.DependencyPainter",{taskBoxes:null,dependencyPainter:null,dependenciesHtml:"",ganttView:null,initDependencyPainter:function(){var n=this;n.dependencyPainter=n.normalView.dependencyView.painter;n.ganttView=n.dependencyPainter.ganttView;n.taskBoxes={}},getLineCoordinates:function(){var n=this;return n.dependencyPainter.getLineCoordinates.apply(n.dependencyPainter,arguments)},renderDependencies:function(n){var t=this;t.dependenciesHtml=t.normalView.dependencyView.lineTpl.apply(t.getDependencyTplData(n))},fillTaskBox:function(n){var t=this,r=t.normalView.dependencyView.painter,i;(n.hasIncomingDependencies()||n.hasOutgoingDependencies())&&(t.ganttView.bufferedRenderer&&(i=t.ganttView.bufferedRenderer.bodyTop,t.ganttView.bufferedRenderer.bodyTop=0),t.taskBoxes[n.getId()]=r.getTaskBox(n),t.ganttView.bufferedRenderer&&(t.ganttView.bufferedRenderer.bodyTop=i))},getRenderData:function(n){var t=this,i=n.getSourceTask(),r=n.getTargetTask();if(i&&r)return{fromBox:t.taskBoxes[i.getId()],toBox:t.taskBoxes[r.getId()]}},getDependencyTplData:function(n){return n=n||this.normalView.dependencyView.store.getRange(),this.dependencyPainter.getDependencyTplData.call(this,n)}});Ext.define("Gnt.plugin.exporter.SinglePage",{extend:Sch.plugin.exporter.SinglePage,mixins:[Gnt.plugin.exporter.mixin.DependencyPainter],setComponent:function(){this.callParent(arguments);this.initDependencyPainter()},collectNormalRow:function(){var n=this,t=n.callParent(arguments);return n.fillTaskBox(t.record),t},onRowsCollected:function(){var n=this;n.renderDependencies();this.callParent(arguments)},preparePageToCommit:function(){var n=this,t=n.callParent(arguments),i=t.select(".sch-dependencyview-ct").first(),r=t.select("."+Ext.baseCSSPrefix+"splitter").first();i.dom.innerHTML=n.dependenciesHtml;i.applyStyles({top:"0px",left:"0px"});r&&r.setHeight("100%");var u=n.component.normalGrid,f=u.el.down(n.tableSelector).getWidth(),e=u.getView().id,o=t.select("#"+e).first().dom;return o.style.width=f+"px",t}});Ext.define("Gnt.plugin.exporter.MultiPage",{extend:Sch.plugin.exporter.MultiPage,mixins:[Gnt.plugin.exporter.mixin.DependencyPainter],depsTopOffset:0,normalGridOffset:0,collectNormalRow:function(){var n=this,t=n.callParent(arguments);return n.fillTaskBox(t.record),t},setComponent:function(){var n=this;n.callParent(arguments);n.initDependencyPainter()},onRowsCollected:function(){var n=this;n.renderDependencies();n.depsTopOffset=-n.firstExportedRowOffset;n.normalGridOffset=0;n.callParent(arguments)},commitPage:function(n){var t=this;t.callParent(arguments);t.depsTopOffset-=n.rowsHeight},startPage:function(n,t){var i=this;i.normalGridOffset=n.normalGridOffset;t&&(i.depsTopOffset=-i.firstExportedRowOffset);i.callParent(arguments)},buildPageFrame:function(){var n=this,t=n.callParent(arguments);return t.normalHidden=n.normalGrid.hidden,t.lockedHidden=n.lockedGrid.hidden,t},preparePageToCommit:function(){var n=this,t=n.callParent(arguments),u=t.select(".sch-dependencyview-ct").first(),f=n.pageFrames[n.columnPageIndex-1],e=function(n){var i=t.select("#"+n).first();return i&&i.dom},o,i;if(!f.normalHidden){u.dom.innerHTML=n.dependenciesHtml;u.applyStyles({top:n.depsTopOffset+"px"});var s=n.normalGrid,h=s.getView().id,r=e(h);r&&(o=s.el.down(n.tableSelector).getWidth(),r.style.width=o+"px",r.style.overflow="hidden")}return f.lockedHidden||(i=e(n.lockedView.id),i&&(i.style.overflow="hidden")),t}});Ext.define("Gnt.plugin.exporter.MultiPageVertical",{extend:Sch.plugin.exporter.MultiPageVertical,mixins:[Gnt.plugin.exporter.mixin.DependencyPainter],depsTopOffset:0,collectNormalRow:function(){var n=this,t=n.callParent(arguments);return n.fillTaskBox(t.record),t},setComponent:function(){var n=this;n.callParent(arguments);n.initDependencyPainter()},onRowsCollected:function(){var n=this;n.renderDependencies();n.depsTopOffset=-this.firstExportedRowOffset;n.callParent(arguments)},commitPage:function(n){var t=this;t.callParent(arguments);t.depsTopOffset-=n.rowsHeight},preparePageToCommit:function(){var n=this,t=n.callParent(arguments),i=t.select(".sch-dependencyview-ct").first(),r=t.select("."+Ext.baseCSSPrefix+"splitter").first(),u=function(n){var i=t.select("#"+n).first();return i&&i.dom},f;i.dom.innerHTML=n.dependenciesHtml;i.applyStyles({top:n.depsTopOffset+"px",left:"0px"});r&&r.setHeight("100%");var e=n.normalGrid,s=e.el.down(n.tableSelector).getWidth(),h=e.getView().id,o=u(h);return o.style.width=s+"px",o.style.overflow="hidden",f=u(n.lockedView.id),f.style.overflow="hidden",t}});Ext.define("Gnt.plugin.Export",{extend:Sch.plugin.Export,alias:"plugin.gantt_export",alternateClassName:"Gnt.plugin.PdfExport",buildExporters:function(){return["Gnt.plugin.exporter.SinglePage","Gnt.plugin.exporter.MultiPage","Gnt.plugin.exporter.MultiPageVertical"]},showExportDialog:function(){this.exportDialogConfig.scrollerDisabled=!0;this.callParent(arguments)}});Ext.define("Gnt.plugin.Printable",{extend:Sch.plugin.Printable,alias:"plugin.gantt_printable",buildExporters:function(){return["Gnt.plugin.exporter.MultiPage","Gnt.plugin.exporter.MultiPageVertical"]},showExportDialog:function(){this.exportDialogConfig.scrollerDisabled=!0;this.callParent(arguments)}});Ext.define("Gnt.plugin.TaskContextMenu",{extend:Ext.menu.Menu,alias:"plugin.gantt_taskcontextmenu",xtype:"gantt_taskcontextmenu",ptype:"gantt_taskcontextmenu",mixins:[Ext.AbstractPlugin,Gnt.mixin.Localizable],lockableScope:"top",plain:!0,triggerEvent:["rowcontextmenu","containercontextmenu","rowlongpress","containerlongpress"],hideEvent:null,grid:null,rec:null,triggerEventXY:null,lastHighlightedItem:null,taskEditorInjected:!1,config:{splitDuration:0,splitDurationUnit:"d",maxSplitDuration:1,maxSplitDurationUnit:"d",minSplitDuration:1,minSplitDurationUnit:"h"},initComponent:function(){var n=this.hideEvent;this.defaults=this.defaults||{};this.defaults.scope=this;this.triggerEvent=[].concat(this.triggerEvent);n&&(Ext.isArray(n)||(n=[n]));Ext.isIE&&(n=n||[],n.push("itemclick"));this.hideEvent=n;this.buildMenuItems();this.callParent(arguments)},init:function(n){this.grid=n;this.bindTriggerEvent();this.bindHideEvent()},getState:function(){if(this.rendered)return this.callParent(arguments)},isNotProject:function(n){return!n||!n.isProject},isReadOnly:function(n){return this.getCmp().isReadOnly()||n&&n.isReadOnly()},createMenuItems:function(){var n=this;return[{handler:this.deleteTask,requiresTask:!0,itemId:"deleteTask",text:this.L("deleteTask"),isValidAction:function(t){return!n.isReadOnly(t)}},{handler:this.editLeftLabel,requiresTask:!0,itemId:"editLeftLabel",text:this.L("editLeftLabel"),isValidAction:function(t){return n.grid.getSchedulingView().getLeftEditor()&&!n.isReadOnly(t)}},{handler:this.editRightLabel,requiresTask:!0,itemId:"editRightLabel",text:this.L("editRightLabel"),isValidAction:function(t){return n.grid.getSchedulingView().getRightEditor()&&!n.isReadOnly(t)}},{handler:this.toggleMilestone,requiresTask:!0,itemId:"toggleMilestone",text:this.L("convertToMilestone"),isValidAction:function(t){return this.isNotProject(t)&&!n.isReadOnly(t)}},{handler:this.splitTask,requiresTask:!0,itemId:"splitTask",isValidAction:function(t,i){return t&&!n.isReadOnly(t)&&t.getStartDate()&&t.getEndDate()&&!t.isMilestone()&&t.isLeaf()&&i&&i.getTarget(".sch-gantt-task-bar")},text:this.L("splitTask")},{text:this.L("add"),itemId:"addTaskMenu",menu:{plain:!0,defaults:{scope:this},items:[{handler:this.addTaskAboveAction,requiresTask:!0,itemId:"addTaskAbove",text:this.L("addTaskAbove"),isValidAction:function(t){return n.isNotProject(t)&&!n.isReadOnly(t.parentNode)}},{handler:this.addTaskBelowAction,itemId:"addTaskBelow",text:this.L("addTaskBelow"),isValidAction:function(t){return n.isNotProject(t)&&!n.isReadOnly(t.parentNode)}},{handler:this.addMilestone,itemId:"addMilestone",requiresTask:!0,text:this.L("addMilestone"),isValidAction:function(t){return n.isNotProject(t)&&!n.isReadOnly(t.parentNode)}},{handler:this.addSubtask,requiresTask:!0,itemId:"addSubtask",text:this.L("addSubtask"),isValidAction:function(t){return!n.isReadOnly(t)}},{handler:this.addSuccessor,requiresTask:!0,itemId:"addSuccessor",text:this.L("addSuccessor"),isValidAction:function(t){return n.isNotProject(t)&&!n.isReadOnly(t.parentNode)}},{handler:this.addPredecessor,requiresTask:!0,itemId:"addPredecessor",text:this.L("addPredecessor"),isValidAction:function(t){return n.isNotProject(t)&&!n.isReadOnly(t.parentNode)}}]}},{text:this.L("deleteDependency"),requiresTask:!0,itemId:"deleteDependencyMenu",isValidAction:function(t){return t&&!n.isReadOnly(t)&&t.getAllDependencies().length>0},menu:{plain:!0,listeners:{beforeshow:this.populateDependencyMenu,mouseover:this.onDependencyMouseOver,mouseleave:this.onDependencyMouseOut,scope:this}}}]},buildMenuItems:function(){this.items=this.createMenuItems()},bindGridEvents:function(n,t,i){var u,r;if(i=i||this,u=this.getCmp(),n)for(r=n.length-1;r>=0;r--)u.on(n[r],t,i)},bindTriggerEvent:function(){this.bindGridEvents(this.triggerEvent,this.onTriggerEvent)},bindHideEvent:function(){this.bindGridEvents(this.hideEvent,this.onHideEvent)},onHideEvent:function(){this.hide()},swallowNextClickEvent:function(){Ext.getBody().on("click",function(n){n.stopPropagation()},null,{single:!0,capture:!0})},populateDependencyMenu:function(n){var t;if(n.up("menuitem").isDisabled())return!1;var i=this.getCmp(),u=i.getTaskStore(),r=this.rec.getAllDependencies(),f=i.dependencyStore;if(n.removeAll(),!r.length)return!1;t=this.rec.getId()||this.rec.internalId;Ext.Array.each(r,function(i){var r=i.getSourceId(),e=u.getModelById(r==t?i.getTargetId():r);e&&n.add({dependency:i,text:Ext.util.Format.ellipsis(Ext.String.htmlEncode(e.getName()),30),scope:this,handler:function(n){f.remove(n.dependency)},disabled:this.isReadOnly(this.rec)})},this)},onDependencyMouseOver:function(n,t){if(t){var i=this.getCmp().getSchedulingView();this.lastHighlightedItem&&i.unhighlightDependency(this.lastHighlightedItem.dependency);this.lastHighlightedItem=t;i.highlightDependency(t.dependency)}},onDependencyMouseOut:function(){this.lastHighlightedItem&&this.getCmp().getSchedulingView().unhighlightDependency(this.lastHighlightedItem.dependency)},onTriggerEvent:function(){var n=this.getTriggerEventContext.apply(this,arguments);n.e.type.match("longpress")&&n.e.pointerType==="mouse"||this.activateMenu(n.record,n.e)},getTriggerEventContext:function(){for(var t={},n=0,i=arguments.length-1;n<=i;n++)if(arguments[n]instanceof Gnt.model.Task){t.record=arguments[n];break}for(n=arguments.length-1;n>=0;n--)if(arguments[n]instanceof Ext.EventObjectImpl){t.e=arguments[n];break}return t},activateMenu:function(n,t){this.getCmp().taskStore.getRootNode()!==n&&(t.type.match("longpress")&&this.swallowNextClickEvent(),t.stopEvent(),this.rec=n,this.triggerEventXY=t.getXY(),this.configureMenuItems(t),this.showAt(t.getXY()),this.focus())},addTaskEditorEntry:function(){this.insert(0,{text:this.L("taskInformation"),itemId:"taskEditor",requiresTask:!0,handler:function(){this.getCmp().getTaskEditor(this.rec).showTask(this.rec)},isValidAction:function(n){return this.getCmp().getTaskEditor(n)},scope:this});this.taskEditorInjected=!0},setTaskEditorEntryLabel:function(n){var t=this.down("#taskEditor");n&&t&&t.setText(n.isProject?this.L("projectInformation"):this.L("taskInformation"))},configureMenuItems:function(n){var t=this.rec,i;this.getCmp().getTaskEditor()&&(this.taskEditorInjected||this.addTaskEditorEntry(),this.setTaskEditorEntryLabel(t));Ext.Array.each(this.query("menuitem"),function(i){var r=i.requiresTask&&!t||i.isValidAction&&!i.isValidAction.call(i.scope||i,t,n);i.setDisabled(r)});i=this.down("#toggleMilestone");t&&i&&i.setText(t.isMilestone()?this.L("convertToRegular"):this.L("convertToMilestone"))},copyTask:function(n){var i=n&&n.self||this.getCmp().getTaskStore().getModel(),t=new i({leaf:!0});return t.setPercentDone(0),t.setName(this.L("newTaskText",this.texts)),t.set(t.startDateField,n&&n.getStartDate()||null),t.set(t.endDateField,n&&n.getEndDate()||null),t.set(t.durationField,n&&n.getDuration()||null),t.set(t.durationUnitField,n&&n.getDurationUnit()||"d"),t},addTaskAbove:function(n){var t=this.rec;t?t.addTaskAbove(n):this.getCmp().taskStore.getRootNode().appendChild(n)},addTaskBelow:function(n){var t=this.rec;t?t.addTaskBelow(n):this.getCmp().taskStore.getRootNode().appendChild(n)},deleteTask:function(){var n=this.getCmp().getSelectedRows().slice();this.rec&&!Ext.Array.contains(n,this.rec)&&n.push(this.rec);this.getCmp().getTaskStore().removeTasks(n)},editLeftLabel:function(){this.getCmp().getSchedulingView().editLeftLabel(this.rec)},editRightLabel:function(){this.getCmp().getSchedulingView().editRightLabel(this.rec)},addTaskAboveAction:function(){this.addTaskAbove(this.copyTask(this.rec))},addTaskBelowAction:function(){this.addTaskBelow(this.copyTask(this.rec))},addSubtask:function(){var n=this.rec,t=this.copyTask(this.isNotProject(n)&&n);n.addSubtask(t)},addSuccessor:function(){var n=this.rec;n.addSuccessor(this.copyTask(n))},addPredecessor:function(){var n=this.rec;n.addPredecessor(this.copyTask(n))},addMilestone:function(){var n=this.rec,t=this.copyTask(n);n.addTaskBelow(t);t.setStartEndDate(n.getEndDate(),n.getEndDate())},toggleMilestone:function(){this.rec.isMilestone()?this.rec.convertToRegular():this.rec.convertToMilestone()},getSplitDate:function(n){var u=n.task,f=n.date,t=n.tick,e=n.timeAxis,i=this.getMaxSplitDuration(),r;return t&&(r=t.getStartDate(),i&&(i=u.getUnitConverter().convertDurationToMs(i,this.getMaxSplitDurationUnit()),i<t.getEndDate()-t.getStartDate()&&(r=null))),r||e.roundDate(f,u.getStartDate())},getSplitDuration:function(n){if(this.splitDuration)return this.splitDuration;var r=n.task,o=n.pos,s=n.date,i=n.tick;if(i){var t=r.calculateDuration(i.getStartDate(),i.getEndDate(),Sch.util.Date.MILLI),u=r.getUnitConverter(),f=this.getMinSplitDuration(),e=this.getMaxSplitDuration();return(f||e)&&(e&&(t=Math.min(t,u.convertDurationToMs(e,this.getMaxSplitDurationUnit()))),f&&(t=Math.max(t,u.convertDurationToMs(f,this.getMinSplitDurationUnit())))),u.convertMSDurationToUnit(t,this.getSplitDurationUnit(r,o,s,i))}},getSplitDurationUnit:function(){return this.splitDuration?this.splitDurationUnit:Sch.util.Date.MILLI},splitTask:function(){var n=this,r=n.grid.getSchedulingView(),u=r.getDateFromX(n.triggerEventXY[0]),i=r.timeAxis,t={task:n.rec,pos:n.triggerEventXY,date:u,timeAxis:i,tick:i.getAt(Math.floor(i.getTickFromDate(u)))};t.task.split(n.getSplitDate(t),n.getSplitDuration(t),n.getSplitDurationUnit(t))}});Ext.define("Gnt.plugin.taskeditor.BaseEditor",{extend:Ext.window.Window,mixins:[Ext.AbstractPlugin,Gnt.mixin.Localizable],lockableScope:"top",closeOnBlur:!0,taskEditorCls:"Gnt.widget.taskeditor.TaskEditor",isTaskEditor:!0,taskEditor:null,panelConfig:null,height:340,width:600,layout:"card",constrain:!0,triggerEvent:"taskdblclick",closeAction:"hide",modal:!0,gantt:null,assignmentStore:null,resourceStore:null,taskStore:null,monitorDataUpdates:!1,monitorDataUpdatesInterval:500,taskEditorConfigs:"l10n,task,taskStore,assignmentStore,resourceStore",taskFilters:null,constructor:function(n){if(n=n||{},this.taskFilters=[],Ext.apply(this,n),this.title=this.L("title"),n.buttons||(this.buttons=["->",{itemId:"teOkBtn",text:this.L("okText"),handler:function(){this.completeEditing()||Ext.Msg.alert(this.L("alertCaption"),this.L("alertText"))},scope:this},{text:this.L("cancelText"),handler:this.close,scope:this}]),this.callParent([n]),this.addCls("gnt-taskeditor-window"),this.closeOnBlur)this.on("show",this.onFirstShow,this,{single:!0})},getState:function(){if(this.rendered)return this.callParent(arguments)},init:function(n){this.assignmentStore=this.assignmentStore||n.getAssignmentStore();this.resourceStore=this.resourceStore||n.getResourceStore();this.taskStore=this.taskStore||n.getTaskStore();var t={width:null,height:null,border:!1};Ext.copyTo(t,this,this.taskEditorConfigs);t.showBaseline=n.enableBaseline;t.showRollup=n.showRollupTasks;t.allowParentTaskDependencies=n.allowParentTaskDependencies;this.buildTaskEditor(Ext.apply(t,this.panelConfig));this.add(this.taskEditor);this.mon(n,this.triggerEvent,this.onTriggerEvent,this);this.gantt=n},buildTaskEditor:function(n){this.taskEditor=Ext.create(this.taskEditorCls,n);this.relayEvents(this.taskEditor,["loadtask","validate","beforeupdatetask","afterupdatetask"])},onTriggerEvent:function(n,t){this.showTask(t)},showTask:function(n){if(this.taskEditor&&n&&this.matchFilters(n)){this.taskEditor.loadTask(n);var t=this.gantt.isReadOnly();t!=this.taskEditor.setReadOnly()&&this.taskEditor.setReadOnly(t);this.down("#teOkBtn").setVisible(!t);this.show()}},matchFilters:function(n){var t,i;if(n){for(t=0;t<this.taskFilters.length;t++)if(i=this.taskFilters[t],!i.fn.call(i.scope,n))return!1;return!0}},addFilter:function(n,t){this.taskFilters.push({fn:n,scope:t||this})},validate:function(){if(this.taskEditor)return this.taskEditor.validate()},completeEditing:function(){if(this.taskEditor){var n=this.taskEditor.getActiveTab();return(n.editingPlugin&&n.editingPlugin.completeEdit&&n.editingPlugin.completeEdit(),!this.taskEditor.validate())?!1:this.taskEditor.updateTask()?(this.hide(),!0):!1}},updateTask:function(){if(this.taskEditor)return this.taskEditor.updateTask()},afterRender:function(){var n=this;n.callParent(arguments);n.startDataUpdatesMonitoring()},onFirstShow:function(){this.zIndexManager.mask&&this.mon(this.zIndexManager.mask,"click",function(){this.isVisible()&&this.hide()},this)},startDataUpdatesMonitoring:function(){function r(){t&&i&&n.taskEditor&&(i.setDisabled(!n.taskEditor.isDataChanged()||!n.taskEditor.isDataValid()),t=Ext.Function.defer(r,n.monitorDataUpdatesInterval))}function u(){t!==!0&&clearTimeout(t);t=!0}var n=this,i=n.down("#teOkBtn"),t=!0;if(n.monitorDataUpdates&&i)n.on({show:r,hide:u,destroy:u})}});Ext.define("Gnt.util.Data",{singleton:!0,cloneModelSet:function(n,t,i){var u=[],r,f=function(f){(r=f.copy(),r.phantom=!1,r.originalRecord=f,t&&t.call(i||n,r,f)===!1)||u.push(r)};return n.each?n.each(f):Ext.Array.each(n,f),u},applyCloneChanges:function(n,t,i,r){var c=[],v=t.autoSyncSuspended,s,u,h,f,o,e,l,a;for(t.autoSync&&!v&&t.suspendAutoSync(),s=n.getRemovedRecords(),u=0,h=s.length;u<h;u++)s[u].originalRecord&&c.push(s[u].originalRecord);for(c.length&&(t.remove(c),n.removed.length=0),f=n.getModifiedRecords(),u=0,h=f.length;u<h;u++){if(o=f[u].originalRecord,e=f[u].getData(),delete e[f[u].idProperty],o){o.beginEdit();for(a in e)o.set(a,e[a]);i&&i.call(r||f[u],e,f[u]);o.endEdit()}else i&&i.call(r||f[u],e,f[u]),l=t.add(e),f[u].originalRecord=l&&l[0];f[u].commit(!0)}t.autoSync&&!v&&(t.resumeAutoSync(),t.sync())}});Ext.define("Gnt.widget.taskeditor.BaseEditor",{extend:Ext.tab.Panel,mixins:[Gnt.mixin.Localizable],margin:"5 0 0 0",height:340,width:600,layout:"fit",border:!1,plain:!0,defaults:{margin:5,border:!1},eventIndicator:"task",task:null,taskBuffer:null,taskStore:null,assignmentStore:null,resourceStore:null,clonedStores:null,constructor:function(n){var t=this,r,i;n=n||{};Ext.apply(t,n);t.clonedStores||(t.clonedStores=t.task||t.taskStore?t.cloneStores():{});r=t.buildItems(n);i=t.items;i&&(r.push.apply(r,Ext.isArray(i)?i:[i]),delete n.items);t.items=r;t.items.length<=1&&(n.tabBar=n.tabBar||{},Ext.applyIf(n.tabBar,{hidden:!0}));this.callParent([n])},buildItems:function(){return[]},cloneTaskBranch:function(n,t){n=n||this.task;var r=this,u=r.getTaskStore(),e=u&&u.getRoot(),o=r.clonedStores,f,i;return n.bubble(function(n){if(n!==e){var u=t[n.getId()];if(u)return i&&u.appendChild(i),i=null,!1;u=r.cloneTask(n);t[n.getId()]=u;u.taskStore=o.taskStore;i?u.appendChild(i):f=u;i=u}}),{branch:i,task:f}},cloneRelevantTasks:function(n){n=n||this.task;var t=this,i={},u=t.cloneTaskBranch(n,i),f=u.task,r=[u.branch];return Ext.Array.each(n.predecessors,function(n){var u=t.cloneTaskBranch(n.getSourceTask(),i);u.branch&&r.push(u.branch)}),Ext.Array.each(n.successors,function(n){var u=t.cloneTaskBranch(n.getTargetTask(),i);u.branch&&r.push(u.branch)}),{task:f,tasks:r}},loadTask:function(n){if(n){var t=this;this.clonedStores=this.cloneStores({task:n});this.loadClonedStores(this.clonedStores,n)}},cloneTaskStore:function(n,t){var i=this.getTaskStore(),r;return i?(r=new i.self(Ext.apply({isCloned:!0,calendarManager:null,storeId:null,calendar:i.getCalendar(),model:i.model,weekendsAreWorkdays:i.weekendsAreWorkdays,cascadeChanges:i.cascadeChanges,batchSync:!1,recalculateParents:!1,skipWeekendsDuringDragDrop:i.skipWeekendsDuringDragDrop,moveParentAsGroup:i.moveParentAsGroup,enableDependenciesForParentTasks:i.enableDependenciesForParentTasks,availabilitySearchLimit:i.availabilitySearchLimit,autoNormalizeNodes:!1,dependenciesCalendar:"project",proxy:{type:"memory",reader:{type:"json"}}},t)),this.mon(i,{calendarset:function(n,t){r.setCalendar(t)}}),r):null},cloneDependencyStore:function(n,t){var r=this.getTaskStore(),i=this.dependencyStore||r&&r.getDependencyStore();return i?new i.self(Ext.apply({isCloned:!0,model:i.model,strictDependencyValidation:i.strictDependencyValidation,allowedDependencyTypes:i.allowedDependencyTypes,proxy:{type:"memory",reader:{type:"json"}}},t)):null},cloneAssignmentStore:function(n,t){var r=this.getTaskStore(),i=this.assignmentStore||r&&r.getAssignmentStore();return i?new i.self(Ext.apply({isCloned:!0,model:i.model,proxy:{type:"memory",reader:{type:"json"}}},t)):null},cloneResourceStore:function(n,t){var r=this.getTaskStore(),i=this.resourceStore||r&&r.getResourceStore();return i?new i.self(Ext.apply({isCloned:!0,model:i.model,proxy:{type:"memory",reader:{type:"json"}}},t)):null},cloneStores:function(n){n=n||{};var i=n.task||this.task,t=this.clonedStores||{},r=t.resourceStore||this.cloneResourceStore(i,n&&n.resourceStore),u=t.assignmentStore||this.cloneAssignmentStore(i,n&&n.assignmentStore),f=t.dependencyStore||this.cloneDependencyStore(i,n&&n.dependencyStore),e=t.taskStore||this.cloneTaskStore(i,Ext.apply({assignmentStore:u,resourceStore:r,dependencyStore:f},n&&n.taskStore));return r.taskStore=e,Ext.apply(t,{resourceStore:r,assignmentStore:u,dependencyStore:f,taskStore:e}),t},getTaskStore:function(n){return n=n||this.task,this.taskStore||n&&n.getTaskStore()},loadClonedStores:function(n,t){var i=this,u=i.cloneRelevantTasks(t),f=u.tasks,r=u.task;r.taskStore.on({update:function(n,t,u){t===r&&u==Ext.data.Model.EDIT&&(i.onTaskUpdated.call(i,t),t.fireEvent(i.eventIndicator+"updated",t))}});n.taskStore.setRootNode({expanded:!0,children:f});i.loadClonedDependencyStore(n,t);i.loadClonedResourceStore(n,t);i.loadClonedAssignmentStore(n,t);i.taskBuffer=r},loadClonedDependencyStore:function(n,t){n=n||this.clonedStores;n.dependencyStore&&n.dependencyStore.loadData(Gnt.util.Data.cloneModelSet(t.getAllDependencies(),function(n,t){n.setId(t.getId())}))},loadClonedResourceStore:function(n){n=n||this.clonedStores;n.resourceStore&&n.resourceStore.loadData(Gnt.util.Data.cloneModelSet(this.resourceStore||this.getTaskStore().getResourceStore(),function(n,t){n.setId(t.getId())}))},loadClonedAssignmentStore:function(n,t){n=n||this.clonedStores;n.assignmentStore&&n.assignmentStore.loadData(Gnt.util.Data.cloneModelSet(t.getAssignments(),function(n,t){n.setId(t.getId())}))},cloneTask:function(n){return n.copy(n.getId(),!1)},getTabByComponent:function(n){var t;return this.items.each(function(i){if(n===i||n.isDescendantOf(i))return t=i,!1},this),t},validate:function(){var n,i=this.getActiveTab(),r=[],t;return n=this.doValidate(function(n){r.push(n)}),n||!i||Ext.Array.contains(r,i)?!n&&i?t=i:n||(t=r[0]):(t=r[0],this.setActiveTab(t)),this.fireEvent("validate",this,t)!==!1&&n},updateTask:function(){var n=this,t=!1;return n.fireEvent("beforeupdate"+n.eventIndicator,n,function(){n.doUpdateTask()})!==!1&&(n.doUpdateTask(),n.fireEvent("afterupdate"+n.eventIndicator,n),t=!0),t},onDestroy:function(){this.clonedStores.taskStore&&this.clonedStores.taskStore.destroy();this.callParent(arguments)},doValidate:function(){return!0},isDataValid:function(){return this.doValidate()},isDataChanged:function(){return!1},doUpdateTask:function(){throw"Abstract method called";},updateReadOnly:function(){throw"Abstract method called";},getReadOnly:function(){return this.readOnly},setReadOnly:function(n){this.readOnly=n;this.updateReadOnly()},onTaskUpdated:function(){this.updateReadOnly()}});Ext.define("Gnt.widget.taskeditor.BaseForm",{extend:Ext.form.Panel,highlightTaskUpdates:!0,task:null,taskBuffer:null,taskStore:null,taskListeners:null,autoScroll:!0,defaults:{labelWidth:110},bodyPadding:5,border:!1,layout:"anchor",defaultType:"textfield",initComponent:function(){this.task&&(this.fieldNames=this.getFieldNames(this.task));this.items||this.buildFields();this.callParent(arguments);this.task&&this.loadRecord(this.task,this.taskBuffer)},getFieldNames:function(n){var t,i;if(n){t={};for(i in this.fieldNames)t[i]=n[i];return t}},renameFields:function(n){var t=this.getFieldNames(n),f,u,r,i;if(t){f=this.getForm();u=!1;for(i in this.fieldNames)r=f.findField(this.fieldNames[i]),r&&t[i]&&t[i]!=r.name&&(u=!0,r.name=t[i]);u&&(this.fieldNames=t)}},setSuppressTaskUpdate:function(n){var t=this.getForm().getFields();t.each(function(t){t.setSuppressTaskUpdate&&t.setSuppressTaskUpdate(n)})},isDataChanged:function(){return this.isDirty()},buildTaskBuffer:function(n){var t=this;t.taskBuffer=n.copy();t.taskBuffer.taskStore=n.taskStore},loadRecord:function(n,t){var i=this,r,u;n&&n!==i.task&&i.renameFields(n);i.task=n;i.taskBuffer=t;i.taskBuffer||i.buildTaskBuffer(n);i.taskListeners&&i.taskListeners.destroy();i.taskListeners=i.mon(i.taskBuffer,{taskupdated:i.onTaskUpdated,destroyable:!0,scope:i});r=i.getForm();r._record=n;this.suspendLayouts();u=n.getData();r.getFields().each(function(n){n.getName()in u&&(n.setTask?n.setTask(i.taskBuffer):n.setValue(u[n.getName()]),i.updateFieldReadOnly(n),r.trackResetOnLoad&&n.resetOriginalValue())});this.resumeLayouts(!0);this.fireEvent("afterloadrecord",this,n)},updateFieldReadOnly:function(n){var i=this,r,t;n.disabled||(r=n.isTaskField,t=i.getReadOnly()||!i.taskBuffer.isEditable(n.name),n.setReadOnly(t),n.editable===!1&&!t&&n.inputEl&&(n.inputEl.dom.readOnly=!0),r&&(n.forceReadOnly=t))},updateReadOnly:function(){var n=this,t=n.getForm(),i=n.taskBuffer.getData();t.getFields().each(function(t){t.getName()in i&&n.updateFieldReadOnly(t)})},updateRecord:function(n){var t=this;return(n=n||t.task,n&&t.fireEvent("beforeupdaterecord",t,n,t.updateRecordFn)!==!1)?(t.setSuppressTaskUpdate(!0),t.updateRecordFn.call(t,n),t.setSuppressTaskUpdate(!1),t.fireEvent("afterupdaterecord",t,n),!0):!1},updateRecordWithFieldValue:function(n,t){var i=n.getField(t.name);t.applyChanges?t.applyChanges(n):i&&t.name in this.getForm().getFieldValues()&&n.set(t.name,t.getValue())},updateRecordFn:function(n){var t=this;n.beginEdit();t.getForm().getFields().each(function(i){t.updateRecordWithFieldValue(n,i)});n.endEdit()},initFieldDefinition:function(n,t){var i=this,r={taskStore:i.taskStore,task:i.task,highlightTaskUpdates:i.highlightTaskUpdates};return!n.readOnly&&i.task&&(r.readOnly=!i.task.isEditable(n.name)),Ext.apply(n,r,t)},getTaskFieldValue:function(n){var i=this,t=this.task;return t?t.get(i.fieldNames[n]):""},onTaskUpdated:function(){this.updateReadOnly()},getReadOnly:function(){return this.readOnly},setReadOnly:function(n){this.readOnly=n;this.updateReadOnly()}});Ext.define("Gnt.widget.taskeditor.ProjectForm",{extend:Gnt.widget.taskeditor.BaseForm,alias:"widget.projectform",mixins:[Gnt.mixin.Localizable],alternateClassName:["Gnt.widget.ProjectForm"],showCalendar:!1,nameConfig:null,readOnlyConfig:null,allowDependenciesConfig:null,startConfig:null,finishConfig:null,calendarConfig:null,constructor:function(n){n=n||{};var t=n.taskStore&&n.taskStore.projectModel&&n.taskStore.projectModel.prototype||Gnt.model.Project.prototype;this.fieldNames={calendarIdField:t.calendarIdField,readOnlyField:t.readOnlyField,allowDependenciesField:t.allowDependenciesField,startDateField:t.startDateField,endDateField:t.endDateField,nameField:t.nameField,descriptionField:t.descriptionField};this.callParent(arguments);this.addBodyCls("gnt-projecteditor-projectform")},buildFields:function(){var n=this,t=n.fieldNames;n.items=n.items||[];n.items.push({xtype:"fieldset",title:n.L("projectText"),layout:"vbox",defaults:{allowBlank:!1},items:[n.initFieldDefinition({xtype:"textfield",fieldLabel:n.L("nameText"),name:t.nameField,labelWidth:110,flex:1,value:n.getTaskFieldValue(t.nameField)},n.nameConfig),n.initFieldDefinition({xtype:"readonlyfield",fieldLabel:n.L("readOnlyText"),name:t.readOnlyField,labelWidth:110,flex:1,value:n.getTaskFieldValue(t.readOnlyField)},n.readOnlyConfig),n.initFieldDefinition({xtype:"checkboxfield",fieldLabel:n.L("allowDependenciesText"),name:t.allowDependenciesField,labelWidth:110,flex:1,value:n.getTaskFieldValue(t.allowDependenciesField)},n.allowDependenciesConfig)]},n.initFieldDefinition({xtype:"fieldset",title:n.L("datesText"),layout:"hbox",defaults:{labelWidth:110,allowBlank:!1,margin:"5 5 5 0"},items:[n.initFieldDefinition({xtype:"startdatefield",fieldLabel:n.L("startText"),width:260,name:t.startDateField,value:n.getTaskFieldValue(t.startDateField)},n.startConfig),n.initFieldDefinition({xtype:"enddatefield",fieldLabel:n.L("finishText"),flex:1,labelWidth:110,name:t.endDateField,value:n.getTaskFieldValue(t.endDateField)},n.finishConfig)]}));n.showCalendar&&n.items.push({xtype:"fieldset",layout:"hbox",defaults:{labelWidth:110,allowBlank:!1,margin:"5 0 5 0"},items:[n.initFieldDefinition({xtype:"calendarfield",fieldLabel:this.L("calendarText"),width:260,name:t.calendarIdField,value:n.getTaskFieldValue(t.calendarIdField)},n.calendarConfig)]})}});Ext.define("Gnt.widget.taskeditor.ProjectEditor",{extend:Gnt.widget.taskeditor.BaseEditor,alias:"widget.projecteditor",alternateClassName:["Gnt.widget.ProjectEditor"],eventIndicator:"project",projectFormClass:"Gnt.widget.taskeditor.ProjectForm",showDescription:!0,projectFormConfig:null,descriptionConfig:null,descriptionPanel:null,descriptionEditor:null,projectForm:null,buildItems:function(){var n=this,i=[],t=this.task;return n.projectForm=Ext.create(n.projectFormClass,Ext.applyIf(n.projectFormConfig||{},{task:t,taskStore:n.taskStore})),i.push(n.projectForm),n.showDescription&&(n.descriptionEditor=Ext.create("Ext.form.field.HtmlEditor",Ext.apply({listeners:{afterrender:function(){n.descriptionEditor.setValue(n.task.get(n.task.descriptionField))}},readOnly:t&&!t.isEditable(t.descriptionField),isDataChanged:function(){return this.isDirty()}},n.descriptionConfig)),n.descriptionPanel=Ext.create("Ext.panel.Panel",{border:!1,layout:"fit",items:n.descriptionEditor}),i.push(n.descriptionPanel)),n.projectForm.title||(n.projectForm.title=n.L("generalText")),n.descriptionPanel&&!n.descriptionPanel.title&&(n.descriptionPanel.title=this.L("descriptionText")),i},loadProject:function(){this.loadTask.apply(this,arguments)},loadTask:function(n){if(n){this.task=n;var t=this.projectForm;t.setSuppressTaskUpdate(!0);t.getForm().reset();this.callParent(arguments);t.loadRecord(n,this.taskBuffer);this.descriptionEditor&&this.descriptionEditor.setValue(n.getDescription());this.setReadOnly(n.isReadOnly());t.setSuppressTaskUpdate(!1);this.fireEvent("loadproject",this,n)}},setReadOnly:function(n){var t=this,i=t.task;i&&t.descriptionEditor&&t.descriptionEditor.setReadOnly(n||!i.isEditable(i.descriptionField))},onTaskUpdated:function(n){this.setReadOnly(n.isReadOnly())},updateProject:function(){this.updateTask()},loadClonedDependencyStore:Ext.emptyFn,loadClonedResourceStore:Ext.emptyFn,loadClonedAssignmentStore:Ext.emptyFn,doValidate:function(n){var t=this.callParent(arguments);return this.projectForm&&!this.projectForm.isValid()&&(t=!1,n&&n(this.getTabByComponent(this.projectForm))),t},doUpdateTask:function(){var n=this.task;this.projectForm&&this.projectForm.updateRecord();this.descriptionEditor&&n.set(n.descriptionField,this.descriptionEditor.getValue())},isDataChanged:function(n){var t=this.callParent(arguments);return this.projectForm&&this.projectForm.isDataChanged()&&(t=!0,n&&n(this.getTabByComponent(this.projectForm))),this.descriptionEditor&&this.descriptionEditor.isDataChanged()&&(t=!0,n&&n(this.getTabByComponent(this.descriptionEditor))),t}});Ext.define("Gnt.plugin.taskeditor.ProjectEditor",{extend:Gnt.plugin.taskeditor.BaseEditor,alternateClassName:["Gnt.plugin.ProjectEditor"],alias:"plugin.gantt_projecteditor",ptype:"gantt_projecteditor",taskEditorCls:"Gnt.widget.taskeditor.ProjectEditor",taskEditorConfigs:"l10n,task,taskStore,assignmentStore,resourceStore,projectFormClass,showDescription,projectFormConfig,descriptionConfig",constructor:function(){this.callParent(arguments);this.addCls("gnt-projecteditor-window");this.addFilter(this.isProject)},init:function(n){this.callParent(arguments);n.projectEditor=this},isProject:function(n){return n&&n.isProject}});Ext.define("Gnt.widget.taskeditor.TaskForm",{extend:Gnt.widget.taskeditor.BaseForm,alias:"widget.taskform",mixins:[Gnt.mixin.Localizable],alternateClassName:["Gnt.widget.TaskForm"],showGeneral:!0,showBaseline:!0,editBaseline:!1,taskNameConfig:null,durationConfig:null,startConfig:null,finishConfig:null,percentDoneConfig:null,baselineStartConfig:null,baselineFinishConfig:null,baselinePercentDoneConfig:null,effortConfig:null,constructor:function(n){n=n||{};this.showBaseline=n.showBaseline;this.editBaseline=n.editBaseline;var t=n.taskStore?n.taskStore.model.prototype:Gnt.model.Task.prototype;this.fieldNames={baselineEndDateField:t.baselineEndDateField,baselinePercentDoneField:t.baselinePercentDoneField,baselineStartDateField:t.baselineStartDateField,calendarIdField:t.calendarIdField,readOnlyField:t.readOnlyField,clsField:t.clsField,draggableField:t.draggableField,durationField:t.durationField,durationUnitField:t.durationUnitField,effortField:t.effortField,effortUnitField:t.effortUnitField,endDateField:t.endDateField,manuallyScheduledField:t.manuallyScheduledField,nameField:t.nameField,percentDoneField:t.percentDoneField,resizableField:t.resizableField,rollupField:t.rollupField,schedulingModeField:t.schedulingModeField,startDateField:t.startDateField,noteField:t.noteField,constraintTypeField:t.constraintTypeField,constraintDateField:t.constraintDateField};this.callParent(arguments);this.addBodyCls("gnt-taskeditor-taskform")},buildFields:function(){var n=this,t=n.fieldNames;n.items=n.items||[];n.showGeneral&&n.items.push({xtype:"fieldcontainer",layout:"hbox",items:[n.initFieldDefinition({xtype:"textfield",fieldLabel:n.L("taskNameText"),name:t.nameField,labelWidth:110,allowBlank:!1,flex:1,value:n.getTaskFieldValue(t.nameField)},n.nameConfig)]},{xtype:"fieldcontainer",layout:"hbox",defaults:{labelWidth:110,allowBlank:!1},items:[n.initFieldDefinition({xtype:"percentfield",fieldLabel:n.L("percentDoneText"),name:t.percentDoneField,margin:"0 0 0 8",flex:1,value:n.getTaskFieldValue(t.percentDoneField)},n.percentDoneConfig),n.initFieldDefinition({xtype:"durationfield",fieldLabel:n.L("durationText"),name:t.durationField,flex:1,value:n.getTaskFieldValue(t.durationField)},n.durationConfig)]},{xtype:"fieldset",title:n.L("datesText"),layout:"hbox",defaults:{labelWidth:110,allowBlank:!1},items:[n.initFieldDefinition({xtype:"startdatefield",fieldLabel:n.L("startText"),flex:1,name:t.startDateField,value:n.getTaskFieldValue(t.startDateField)},n.startConfig),n.initFieldDefinition({xtype:"enddatefield",fieldLabel:n.L("finishText"),flex:1,name:t.endDateField,value:n.getTaskFieldValue(t.endDateField)},n.finishConfig)]},n.initFieldDefinition({xtype:"effortfield",fieldLabel:n.L("effortText"),name:t.effortField,invalidText:n.L("invalidEffortText"),width:200,allowBlank:!0,value:n.getTaskFieldValue(t.effortField)},n.effortConfig));n.showBaseline&&n.items.push({xtype:"fieldset",title:n.L("baselineText"),layout:"hbox",defaults:{labelWidth:110,width:260,cls:"gnt-baselinefield"},items:[n.initFieldDefinition({xtype:"baselinestartdatefield",fieldLabel:n.L("baselineStartText"),name:t.baselineStartDateField,value:n.getTaskFieldValue(t.baselineStartDateField),readOnly:!n.editBaseline,forceReadOnly:!n.editBaseline},n.baselineStartConfig),n.initFieldDefinition({xtype:"baselineenddatefield",fieldLabel:n.L("baselineFinishText"),name:t.baselineEndDateField,flex:1,value:n.getTaskFieldValue(t.baselineEndDateField),readOnly:!n.editBaseline,forceReadOnly:!n.editBaseline},n.baselineFinishConfig)]},n.initFieldDefinition({xtype:"percentfield",fieldLabel:n.L("baselinePercentDoneText"),name:t.baselinePercentDoneField,labelWidth:110,width:200,cls:"gnt-baselinefield",value:n.getTaskFieldValue(t.baselinePercentDoneField),readOnly:!n.editBaseline},n.baselinePercentDoneConfig))},updateRecordWithFieldValue:function(n,t){var i=this;if(t.name!=i.fieldNames.constraintTypeField&&t.name!=i.fieldNames.constraintDateField)return this.callParent(arguments)},updateRecordFn:function(n){var t=this,i=t.fieldNames,r=t.getForm(),u=r.findField(i.constraintTypeField),f=r.findField(i.constraintDateField);n.beginEdit();this.callParent(arguments);u&&f&&n.setConstraint&&n.setConstraint(u.getValue(),f.getValue());n.endEdit()},buildTaskBuffer:function(n){this.callParent(arguments);!n.getReadOnly()&&n.isReadOnly()&&(this.taskBuffer.isReadOnly=function(){return!0})}});Ext.define("Gnt.widget.taskeditor.AdvancedForm",{extend:Gnt.widget.taskeditor.TaskForm,alias:"widget.advanced_taskform",mixins:[Gnt.mixin.Localizable],alternateClassName:["Gnt.widget.AdvancedForm"],showGeneral:!1,showBaseline:!1,editBaseline:!1,showCalendar:!0,showManuallyScheduled:!0,showSchedulingMode:!0,showWbsCode:!0,showRollup:!1,showConstraint:!0,showReadOnly:!1,calendarConfig:null,manuallyScheduledConfig:null,schedulingModeConfig:null,wbsCodeConfig:null,rollupConfig:null,constraintTypeConfig:null,constraintDateConfig:null,readOnlyConfig:null,constructor:function(){this.callParent(arguments);this.addBodyCls("gnt-taskeditor-advancedtaskform")},buildFields:function(){var n=this,t=n.fieldNames;n.items=n.items||[];n.showCalendar&&n.items.push(n.initFieldDefinition({xtype:"calendarfield",fieldLabel:this.L("calendarText"),width:300,name:t.calendarIdField,value:n.getTaskFieldValue(t.calendarIdField)},n.calendarConfig));n.showManuallyScheduled&&n.items.push(n.initFieldDefinition({xtype:"manuallyscheduledfield",fieldLabel:n.L("manuallyScheduledText"),name:t.manuallyScheduledField,value:n.getTaskFieldValue(t.manuallyScheduledField)},n.manuallyScheduledConfig));n.showSchedulingMode&&n.items.push(n.initFieldDefinition({xtype:"schedulingmodefield",fieldLabel:n.L("schedulingModeText"),width:300,name:t.schedulingModeField,value:n.getTaskFieldValue(t.schedulingModeField),allowBlank:!1},n.schedulingModeConfig));n.showWbsCode&&n.items.push(n.initFieldDefinition({xtype:"textfield",fieldLabel:n.L("wbsCodeText"),name:"wbsCode",width:300,forceReadOnly:!0,readOnly:!0,value:n.task&&n.task.getWBSCode()},n.wbsCodeConfig));n.showRollup&&this.items.push(n.initFieldDefinition({xtype:"checkboxfield",fieldLabel:this.L("rollupText"),name:t.rollupField,value:n.getTaskFieldValue(t.rollupField)},n.rollupConfig));n.showReadOnly&&this.items.push(n.initFieldDefinition({xtype:"readonlyfield",fieldLabel:n.L("readOnlyText"),name:t.readOnlyField,labelWidth:110,flex:1,value:n.getTaskFieldValue(t.readOnlyField)},n.readOnlyConfig));n.showConstraint&&n.items.push(n.initFieldDefinition({xtype:"constrainttypefield",fieldLabel:n.L("Constraint Type"),name:t.constraintTypeField,width:300,value:n.getTaskFieldValue(t.constraintTypeField)},n.constraintTypeConfig),n.initFieldDefinition({xtype:"constraintdatefield",fieldLabel:n.L("Constraint Date"),name:t.constraintDateField,width:300,value:n.getTaskFieldValue(t.constraintDateField)},n.constraintDateConfig))}});Ext.define("Gnt.widget.AssignmentEditGrid",{extend:Ext.grid.Panel,alias:"widget.assignmenteditgrid",mixins:[Gnt.mixin.Localizable],assignmentStore:null,resourceStore:null,readOnly:!1,cls:"gnt-assignmentgrid",defaultAssignedUnits:100,confirmAddResource:!0,addResources:!0,taskId:null,refreshTimeout:100,resourceDupStore:null,resourceComboStore:null,assignmentUnitsEditor:null,constructor:function(n){var t,i,r;Ext.apply(this,n);t=n.assignmentStore;i=n.taskStore||t.getTaskStore();this.store=n.store||new t.self({model:t.model,taskStore:i});r=i.getResourceStore();this.resourceDupStore=n.resourceDupStore||new r.self({model:r.model,taskStore:i});this.resourceComboStore=new Ext.data.JsonStore({autoDestroy:!0,model:this.resourceDupStore.model});n.addResources!==undefined&&(this.addResources=n.addResources);this.columns=this.buildColumns();this.readOnly||(this.plugins=this.buildPlugins());this.callParent(arguments)},suspendRefreshResources:function(){this.refreshResourcesSuspended++},resumeRefreshResources:function(){this.refreshResourcesSuspended--},refreshResources:function(){this.refreshResourcesSuspended||this.loadResources()},suspendRefreshAssignments:function(){this.refreshAssignmentsSuspended++},resumeRefreshAssignments:function(){this.refreshAssignmentsSuspended--},refreshAssignments:function(){this.refreshAssignmentsSuspended||this.loadTaskAssignments()},initComponent:function(){var n,t;this.loadResources();n=Ext.Function.createBuffered(this.refreshResources,this.refreshTimeout,this,[]);this.mon(this.resourceStore,{add:n,remove:n,load:n,clear:n});this.loadTaskAssignments();t=Ext.Function.createBuffered(this.refreshAssignments,this.refreshTimeout,this,[]);this.mon(this.assignmentStore,{add:t,remove:t,load:t,clear:t});this.callParent(arguments)},loadResources:function(n){if(!this.resourceStore)return!1;var t=Gnt.util.Data.cloneModelSet(this.resourceStore);return this.resourceDupStore.loadData(t),this.resourceComboStore.loadData(t),n||this.loadTaskAssignments(),!0},afterRender:function(){var n,t;this.callParent(arguments);this.taskId&&(t=this.taskStore||this.assignmentStore.getTaskStore(),n=t&&t.getModelById(this.taskId));n&&this.setEditableFields(n)},getUnitsEditor:function(){return this.readOnly||this.assignmentUnitsEditor||(this.assignmentUnitsEditor=this.down("assignmentunitscolumn").getEditor()),this.assignmentUnitsEditor},setEditableFields:function(n){var t=this.getUnitsEditor();if(t)switch(n.getSchedulingMode()){case"DynamicAssignment":t.setReadOnly(!0);break;default:t.setReadOnly(!1)}},setReadOnly:function(n){this.cellEditing&&(n?this.cellEditing.disable():this.cellEditing.enable())},loadTaskAssignments:function(n){var i,t,r;if(n=n||this.taskId,!n)return!1;if(i=this.taskStore||this.assignmentStore.getTaskStore(),t=i&&i.getModelById(n),t)r=t.getAssignments();else{if(!this.assignmentStore)return!1;r=this.assignmentStore.queryBy(function(t){return t.getTaskId()==n})}this.taskId=n;var u=this.store,f=this.resourceDupStore,e=Gnt.util.Data.cloneModelSet(r,function(n,t){var r=t.getResourceId(),i=f.queryBy(function(n){var t=n.originalRecord;return(t.getId()||t.internalId)==r});i.getCount()&&(i=i.first(),n.setResourceId(i.getId()||i.internalId))});return u.loadData(e),t&&this.rendered&&this.setEditableFields(t),!0},insertAssignment:function(n,t){n&&n.isModel||(n=new this.store.model(n),n||n.setUnits(this.defaultAssignedUnits));n.getResourceId()===undefined&&n.setResourceId(null);n.setTaskId(this.taskId);this.store.insert(0,n);var i=this,r=n.isValid;return n.isValid=function(){return r.apply(this,arguments)&&i.isValidAssignment(this)},!t&&this.cellEditing&&this.cellEditing.startEditByPosition({row:0,column:0}),n},isValid:function(){var n=!0;return this.store.each(function(t){if(!t.isValid())return n=!1,!1}),n},getAssignmentErrors:function(n){var t=n.getResourceId();return t?this.resourceDupStore.getModelById(t)?void 0:[Ext.String.format(this.L("noResourceText"),t)]:[this.L("noValueText")]},isValidAssignment:function(n){return!this.getAssignmentErrors(n)},buildPlugins:function(){var n=this.cellEditing=Ext.create("Ext.grid.plugin.CellEditing",{clicksToEdit:1}),t=n.startEdit;n.startEdit=function(){return this.completeEdit(),t.apply(this,arguments)};n.on({beforeedit:this.onEditingStart,scope:this});return[n]},hide:function(){return this.cellEditing.cancelEdit(),this.callParent(arguments)},onEditingStart:function(n,t){var i=this.store.model.prototype;t.field==i.resourceIdField&&(this.assignment=t.record,this.resourceId=t.record.getResourceId(),this.resourceComboStore.loadData(this.resourceDupStore.getRange()),this.resourceComboStore.filter(this.resourcesFilter))},resourceRender:function(n,t,i){var r=this.getAssignmentErrors(i),u;return r&&r.length?(t.tdCls=Ext.baseCSSPrefix+"form-invalid",t.tdAttr='data-errorqtip="'+r.join("<br>")+'"'):(t.tdCls="",t.tdAttr='data-errorqtip=""'),u=this.resourceDupStore.getModelById(n),Ext.String.htmlEncode(u&&u.getName()||n)},filterResources:function(n){var t=n.getId(),r=this.store.model.prototype.resourceIdField,i=!0;return t!==this.resourceId&&this.store.each(function(n){if(t==n.get(r))return i=!1,!1}),i},onResourceComboAssert:function(n){var t=n.getRawValue(),i,r,u,f;if(t)if(i=this.resourceDupStore.findExact(n.displayField,t),r=i!==-1?this.resourceDupStore.getAt(i):!1,r)n.select(r,!0);else{var s=this.assignment,e=this,o=function(t){var u=e.resourceStore.model,i={},r;i[u.prototype.nameField]=n.rawValue;i=new u(i);i.setId(i.internalId);r=e.resourceDupStore.add(i);r&&r.length&&(t?s.setResourceId(r[0].getId()):(n.getStore().add(i),n.setValue(r[0].getId())))};this.confirmAddResource?(u=Ext.String.format(this.L("confirmAddResourceText"),Ext.String.htmlEncode(t)),f=Ext.Msg.confirm(this.L("confirmAddResourceTitle"),u,function(n){n=="yes"&&o(!0)}),setTimeout(function(){f.toFront()},1)):o()}},buildColumns:function(){var n=this;return this.resourceCombo=new Ext.form.field.ComboBox({queryMode:"local",store:this.resourceComboStore,allowBlank:!1,editing:this.addResources,validateOnChange:!1,autoSelect:!1,forceSelection:!this.addResources,valueField:this.resourceComboStore.model.prototype.idProperty,displayField:this.resourceComboStore.model.prototype.nameField,queryCaching:!1,listConfig:{getInnerTpl:function(){return"{"+this.displayField+":htmlEncode}"}}}),this.resourcesFilter=Ext.create("Ext.util.Filter",{filterFn:this.filterResources,scope:this}),this.addResources&&Ext.Function.interceptBefore(this.resourceCombo,"assertValue",function(){n.onResourceComboAssert(this)}),[{xtype:"resourcenamecolumn",editor:this.resourceCombo,dataIndex:this.assignmentStore.model.prototype.resourceIdField,renderer:this.resourceRender,scope:this},{xtype:"assignmentunitscolumn",assignmentStore:this.assignmentStore,dataIndex:this.assignmentStore.model.prototype.unitsField}]},saveResources:function(){Gnt.util.Data.applyCloneChanges(this.resourceDupStore,this.resourceStore)},saveTaskAssignments:function(){this.suspendRefreshAssignments();this.suspendRefreshResources();this.saveResources();var t=this.store.model,i=this.resourceDupStore,n=!0;return Gnt.util.Data.applyCloneChanges(this.store,this.assignmentStore,function(r){var u=i.getById(this.getResourceId()),f;if(!u||!u.originalRecord){n=!1;return}f=u.originalRecord;r[t.prototype.resourceIdField]=f.getId()||f.internalId}),this.resumeRefreshAssignments(),this.resumeRefreshResources(),n},isDataChanged:function(){var n=this;return n.store&&n.store.getUpdatedRecords().length>0||n.store.getNewRecords().length>0||n.store.getRemovedRecords().length>0},isDataValid:function(){var n=!0;return this.store.each(function(t){if(!t.isValid())return n=!1,!1}),n}});Ext.define("Gnt.widget.DependencyGrid",{extend:Ext.grid.Panel,alias:"widget.dependencygrid",mixins:[Gnt.mixin.Localizable],readOnly:!1,showCls:!1,cls:"gnt-dependencygrid",task:null,dependencyStore:null,taskModel:null,direction:"predecessors",oppositeStore:null,taskStoreListeners:null,refreshTimeout:100,allowParentTaskDependencies:!1,useSequenceNumber:!1,lagEditor:null,typesCombo:null,constructor:function(n){if(n=n||{},Ext.Array.each(["idText","taskText","blankTaskText","invalidDependencyText","parentChildDependencyText","duplicatingDependencyText","transitiveDependencyText","cyclicDependencyText","typeText","lagText","clsText","endToStartText","startToStartText","endToEndText","startToEndText"],function(t){t in n&&(this[t]=n[t])},this),this.store=n.store||new Ext.data.JsonStore({autoDestroy:!0,model:n.dependencyStore?n.dependencyStore.model:"Gnt.model.Dependency"}),this.readOnly||(this.plugins=this.buildPlugins()),this.direction=n.direction||this.direction,!n.taskModel&&(n.taskModel=Ext.ClassManager.get("Gnt.model.Task"),n.dependencyStore)){var t=n.dependencyStore.getTaskStore();t&&(n.taskModel=t.model)}n.oppositeStore&&this.setOppositeStore(n.oppositeStore);this.callParent([n])},initComponent:function(){this.task&&(this.setTask(this.task),this.loadDependencies(this.task));this.title||(this.title=this.direction==="predecessors"?this.L("predecessorsText"):this.L("successorsText"));this.columns=this.buildColumns();this.callParent(arguments)},destroy:function(){this.deferredStoreBind&&this.tasksCombo.un("render",this.bindTaskStore,this);this.tasksCombo.destroy();this.typesCombo.destroy();this.lagEditor.destroy();this.callParent(arguments);this.cellEditing.destroy()},setTask:function(n){if(n){this.task=n;var t=n.dependencyStore||n.getTaskStore().dependencyStore;t&&t!==this.dependencyStore&&(this.dependencyStore&&this.mun(this.dependencyStore,this.onDependencyStoreDataChanged,this),this.dependencyStore=t,this.typesCombo&&this.typesCombo.store.filter(this.typesFilter),this.mon(this.dependencyStore,this.onDependencyStoreDataChanged,this));this.setReadOnly(n.isReadOnly())}},setReadOnly:function(n){this.cellEditing&&(n?this.cellEditing.disable():this.cellEditing.enable())},onDependencyStoreDataChanged:function(){this.loadDependencies()},buildPlugins:function(){var n=this.cellEditing=new Ext.grid.plugin.CellEditing({clicksToEdit:1});n.on({beforeedit:this.onEditingStart,edit:this.onEditingDone,scope:this});return[n]},hide:function(){this.cellEditing.cancelEdit();this.callParent(arguments)},onEditingStart:function(n,t){var i=this.store.model.prototype;switch(t.field){case i.lagField:this.lagEditor.durationUnit=t.record.getLagUnit();break;case i.typeField:if(this.typesCombo.store.filter(this.typesFilter),this.typesCombo.store.count()<2)return!1;break;case i.fromField:this.direction=="predecessors"&&(this.activeDependency=t.record,this.refilterTasksCombo());break;case i.toField:this.direction!="predecessors"&&(this.activeDependency=t.record,this.refilterTasksCombo())}},onEditingDone:function(n,t){var i=this.store.model.prototype;t.field==i.lagField&&t.record.setLagUnit(this.lagEditor.durationUnit);this.getView().refreshView()},dependencyTypeRender:function(n){var t=this.store.model.Type;switch(n){case t.EndToStart:return this.L("endToStartText");case t.StartToStart:return this.L("startToStartText");case t.EndToEnd:return this.L("endToEndText");case t.StartToEnd:return this.L("startToEndText")}return n},taskValidate:function(n,t){if(!n)return[this.L("blankTaskText")];if(!t.isValid()){var i=this.getDependencyErrors(t);return i&&i.length?i:[this.L("invalidDependencyText")]}},taskRender:function(n,t,i){var r=this.taskValidate(n,i),u,f;return(r&&r.length?(t.tdCls=Ext.baseCSSPrefix+"form-invalid",t.tdAttr='data-errorqtip="'+r.join("<br>")+'"'):(t.tdCls="",t.tdAttr='data-errorqtip=""'),f=this.dependencyStore&&this.dependencyStore.getTaskStore(),f)?(u=f.getModelById(n),u&&Ext.String.htmlEncode(u.getName())||""):""},filterTasks:function(n){var t=n.getId(),i,r,u;return this.direction==="predecessors"?(r=t,u=this.task.getId(),i=this.activeDependency&&this.activeDependency.getSourceId()):(u=t,r=this.task.getId(),i=this.activeDependency&&this.activeDependency.getTargetId()),!this.activeDependency||t==i||this.isValidDependency(r,u)},refilterTasksCombo:function(){this.tasksCombo.getStore().addFilter(this.tasksFilter)},bindTaskStore:function(){var t=this.dependencyStore&&this.dependencyStore.getTaskStore(),n,i,r;t&&(this.taskStoreListeners||(n=Ext.Function.createBuffered(this.bindTaskStore,this.refreshTimeout,this,[]),this.taskStoreListeners=this.mon(t,{nodeappend:n,nodeinsert:n,noderemove:n,update:n,refresh:n,clear:n,"nodestore-datachange-end":n,scope:this,destroyable:!0})),i=new Ext.data.JsonStore({autoDestroy:!0,model:t.model,sorters:t.model.prototype.nameField}),r=t.getRoot(),i.loadData(Gnt.util.Data.cloneModelSet(t.toArray(),function(n,t){if(t===r||t.hidden||t.isReadOnly())return!1;t.getId()||n.setId(t.getId())})),this.tasksFilter=new Ext.util.Filter({id:"dependencygrid-tasksfilter",filterFn:this.filterTasks,scope:this}),i.filter(this.tasksFilter),this.tasksCombo.bindStore(i))},buildTasksCombo:function(){var n=this;return new Ext.form.field.ComboBox({queryMode:"local",allowBlank:!1,editing:!1,forceSelection:!0,valueField:this.taskModel.prototype.idProperty,displayField:this.taskModel.prototype.nameField,queryCaching:!1,listConfig:{getInnerTpl:function(){return"{"+this.displayField+":htmlEncode}"}},validator:function(t){return t?!0:n.L("blankTaskText")}})},filterAllowedTypes:function(n){var i,r,t,u,f;if(!this.dependencyStore||!this.dependencyStore.allowedDependencyTypes)return!0;for(i=this.dependencyStore.allowedDependencyTypes,r=this.store.model.Type,t=0,u=i.length;t<u;t++)if(f=r[i[t]],n.getId()==f)return!0;return!1},buildTypesCombo:function(){var n=this.store.model.Type,t;return this.typesFilter=new Ext.util.Filter({id:"typesfilter",filterFn:this.filterAllowedTypes,scope:this}),t=new Ext.data.ArrayStore({fields:[{name:"id",type:"int"},"text"],data:[[n.EndToStart,this.L("endToStartText")],[n.StartToStart,this.L("startToStartText")],[n.EndToEnd,this.L("endToEndText")],[n.StartToEnd,this.L("startToEndText")]]}),t.filter(this.typesFilter),new Ext.form.field.ComboBox({triggerAction:"all",queryMode:"local",editable:!1,valueField:"id",displayField:"text",store:t})},buildLagEditor:function(){return new Gnt.field.Duration({minValue:Number.NEGATIVE_INFINITY})},buildColumns:function(){var t=this,n=this.store.model.prototype,r=[],f=this.dependencyStore&&this.dependencyStore.getTaskStore(),u,i;if(this.tasksCombo=this.buildTasksCombo(),f)this.bindTaskStore();else{this.deferredStoreBind=!0;this.tasksCombo.on("render",this.bindTaskStore,this)}return u={},i=n[this.direction==="predecessors"?"fromField":"toField"],u=this.useSequenceNumber?{text:this.L("snText"),dataIndex:i,renderer:function(n,i,r){var u=t.dependencyStore&&t.dependencyStore.getTaskStore(),f=u&&u.getModelById(r.get("From"));return f?f.getSequenceNumber():""},width:50}:{text:this.L("idText"),dataIndex:i,width:50},r.push(u,{text:this.L("taskText"),dataIndex:i,flex:1,editor:this.tasksCombo,renderer:function(n,i,r){return t.taskRender(n,i,r)}}),this.lagEditor=this.buildLagEditor(),this.typesCombo=this.buildTypesCombo(),r.push({text:this.L("typeText"),dataIndex:n.typeField,width:120,renderer:this.dependencyTypeRender,scope:this,editor:this.typesCombo},{text:this.L("lagText"),dataIndex:n.lagField,width:100,editor:this.lagEditor,renderer:function(i,r,u){return t.lagEditor.valueToVisible(i,u.get(n.lagUnitField),2)}},{text:this.L("clsText"),dataIndex:n.clsField,hidden:!this.showCls,width:100}),r},insertDependency:function(n,t){var r,f;if(this.dependencyStore){var e=this.task.getId(),u=this.store.model.prototype,i={},o=this;return n?i=n:(i[u.typeField]=this.typesCombo.store.getAt(0).getId(),i[u.lagField]=0,i[u.lagUnitField]="d"),this.direction==="predecessors"?i[u.toField]=e:i[u.fromField]=e,r=this.store.insert(0,i),r.length&&(f=r[0].isValid,r[0].isValid=function(){return f.call(this,!1)&&o.isValidDependency(this)}),t||this.cellEditing.startEditByPosition({row:0,column:1}),r}},onOppositeStoreChange:function(){this.getView().refreshView()},setOppositeStore:function(n){var t={update:this.onOppositeStoreChange,datachanged:this.onOppositeStoreChange,scope:this};this.oppositeStore&&this.mun(this.oppositeStore,t);this.oppositeStore=n;this.mon(this.oppositeStore,t)},loadDependencies:function(n){var r=this,t,i;(n=n||this.task,n)&&(this.task!==n&&this.setTask(n),this.direction==="predecessors"?(t=n.getIncomingDependencies(!0),this.oppositeStore||(this.oppositeData=n.getOutgoingDependencies(!0))):(t=n.getOutgoingDependencies(!0),this.oppositeStore||(this.oppositeData=n.getIncomingDependencies(!0))),i=Gnt.util.Data.cloneModelSet(t,function(n){var t=n.isValid;n.isValid=function(){return t.call(this,!1)&&r.isValidDependency(this)}}),this.store.loadData(i),this.fireEvent("loaddependencies",this,this.store,i,n))},getDependencyErrors:function(n,t){var i=this,h=i.dependencyStore,u=[],r,o,f,s,e;if(n instanceof Gnt.model.Dependency&&(r=n,n=i.task.getId(),t=n,o=r.getType(),i.direction==="predecessors"?n=r.getSourceId():t=r.getTargetId()),r&&(i.store.each(function(f){if(n==f.getSourceId()&&t==f.getTargetId()&&f!==r)return u.push(i.L("duplicatingDependencyText")),!1}),u.length))return u;if(f=i.store.getRange(),r&&f.splice(Ext.Array.indexOf(f,r),1),s=i.task[i.direction],e=h.getDependencyError(n,t,o,f,s),e){switch(e){case-3:case-8:case-5:case-6:return[i.L("transitiveDependencyText")];case-4:case-7:return[i.L("cyclicDependencyText")];case-9:return[i.L("parentChildDependencyText")]}return[this.L("invalidDependencyText")]}return u},isValidDependency:function(){return!this.getDependencyErrors.apply(this,arguments).length},isValid:function(){var n=!0;return this.store.each(function(t){if(!t.isValid())return n=!1,!1}),n},saveDependencies:function(){this.dependencyStore&&this.isValid()&&Gnt.util.Data.applyCloneChanges(this.store,this.dependencyStore)},isDataChanged:function(){var n=this;return n.store&&n.store.getUpdatedRecords().length>0||n.store.getNewRecords().length>0||n.store.getRemovedRecords().length>0},isDataValid:function(){return this.isValid()}});Ext.define("Gnt.widget.taskeditor.TaskEditor",{extend:Gnt.widget.taskeditor.BaseEditor,alias:"widget.taskeditor",alternateClassName:["Gnt.widget.TaskEditor"],taskFormClass:"Gnt.widget.taskeditor.TaskForm",advancedFormClass:"Gnt.widget.taskeditor.AdvancedForm",showAssignmentGrid:!0,showDependencyGrid:!0,allowParentTaskDependencies:!0,showNotes:!0,showAdvancedForm:!0,showRollup:!1,showReadOnly:!0,showBaseline:!0,taskFormConfig:null,dependencyGridClass:"Gnt.widget.DependencyGrid",dependencyGridConfig:null,assignmentGridClass:"Gnt.widget.AssignmentEditGrid",assignmentGridConfig:null,advancedFormConfig:null,notesConfig:null,notesPanel:null,notesEditor:null,taskForm:null,assignmentGrid:null,dependencyGrid:null,advancedForm:null,buildItems:function(){var n=this,t=[],i=n.clonedStores||{};return n.taskFormConfig=n.taskFormConfig||{},Ext.applyIf(n.taskFormConfig,{showBaseline:n.showBaseline,showRollup:!1}),n.taskForm=Ext.create(n.taskFormClass,Ext.apply({task:n.task,taskStore:n.taskStore},n.taskFormConfig)),t.push(n.taskForm),n.showDependencyGrid&&(n.dependencyGrid=Ext.create(n.dependencyGridClass,Ext.apply({allowParentTaskDependencies:n.allowParentTaskDependencies,taskModel:n.taskStore.model,task:n.task,margin:5,tbar:{layout:"auto",items:[{xtype:"button",iconCls:"gnt-action-add",text:n.L("addDependencyText"),itemId:"add-dependency-btn",handler:function(){n.dependencyGrid.insertDependency()}},{xtype:"button",iconCls:"gnt-action-remove",text:n.L("dropDependencyText"),itemId:"drop-dependency-btn",disabled:!0,handler:function(){var t=n.dependencyGrid.getSelectionModel().getSelection();t&&t.length&&n.dependencyGrid.store.remove(t)}}]},listeners:{selectionchange:function(t,i){var r=n.dependencyGrid;r.dropDepBtn||(r.dropDepBtn=r.down("#drop-dependency-btn"));r.dropDepBtn&&r.dropDepBtn.setDisabled(!i.length)}}},n.dependencyGridConfig)),t.push(n.dependencyGrid)),n.showAssignmentGrid&&n.assignmentStore&&n.resourceStore&&(i.assignmentStore||(i.assignmentStore=n.cloneAssignmentStore(n.task)),i.resourceStore||(i.resourceStore=n.cloneResourceStore(n.task)),n.assignmentGrid=Ext.create(n.assignmentGridClass,Ext.apply({assignmentStore:n.assignmentStore,resourceStore:n.resourceStore,store:i.assignmentStore,resourceDupStore:i.resourceStore,tbar:{layout:"auto",items:[{xtype:"button",iconCls:"gnt-action-add",text:n.L("addAssignmentText"),itemId:"add-assignment-btn",handler:function(){n.assignmentGrid.insertAssignment()}},{xtype:"button",iconCls:"gnt-action-remove",text:n.L("dropAssignmentText"),itemId:"drop-assignment-btn",disabled:!0,handler:function(){var t=n.assignmentGrid.getSelectionModel().getSelection();t&&t.length&&n.assignmentGrid.store.remove(t)}}]},listeners:{afterrender:{fn:function(t){t.loadTaskAssignments(n.task.get(n.task.idProperty))},single:!0},selectionchange:function(t,i){var r=n.assignmentGrid;r.dropBtn||(r.dropBtn=r.down("#drop-assignment-btn"));r.dropBtn&&r.dropBtn.setDisabled(!i.length)}}},n.assignmentGridConfig)),t.push(n.assignmentGrid)),n.showAdvancedForm&&(n.advancedFormConfig=n.advancedFormConfig||{},n.advancedForm=Ext.create(n.advancedFormClass,Ext.applyIf(n.advancedFormConfig,{showGeneral:!1,showBaseline:!1,showCalendar:!0,showManuallyScheduled:!0,showSchedulingMode:!0,showWbsCode:!0,showConstraint:!0,showRollup:n.showRollup,showReadOnly:n.showReadOnly,task:n.task,taskStore:n.taskStore})),t.push(n.advancedForm)),n.showNotes&&(n.notesEditor=Ext.create("Ext.form.field.HtmlEditor",Ext.apply({listeners:{afterrender:function(){n.notesEditor.setValue(n.task.get(n.task.noteField))}},readOnly:n.task&&!n.task.isEditable(n.task.noteField),isDataChanged:function(){return this.isDirty()}},n.notesConfig)),n.notesPanel=Ext.create("Ext.panel.Panel",{border:!1,layout:"fit",items:n.notesEditor}),t.push(n.notesPanel)),n.taskForm.title||(n.taskForm.title=n.L("generalText")),n.assignmentGrid&&!n.assignmentGrid.title&&(n.assignmentGrid.title=n.L("resourcesText")),n.advancedForm&&!n.advancedForm.title&&(n.advancedForm.title=n.L("advancedText")),n.notesPanel&&!n.notesPanel.title&&(n.notesPanel.title=n.L("notesText")),t},bindDependencyGrid:function(){var n=this.clonedStores.dependencyStore,t=this.dependencyGrid;t.store.taskStore=this.clonedStores.taskStore;n&&(this.mon(t,{loaddependencies:function(t,i){n.loadData(i.getRange().concat(Gnt.util.Data.cloneModelSet(t.oppositeData)))}}),this.mon(t.store,{add:function(t,i){n.add(i)},remove:function(t,i){n.remove(i)}}),this.dependencyGridBound=!0)},loadTask:function(n){var r,f,e,o;if(n){this.task=n;var t=this,u=t.taskForm,s=t.dependencyGrid,i=t.assignmentGrid,h=n.isReadOnly();u.setSuppressTaskUpdate(!0);u.getForm().reset();t.callParent(arguments);r=t.clonedStores;f=t.taskBuffer;s&&(t.dependencyGridBound||t.bindDependencyGrid(),s.loadDependencies(n),s.tab.setVisible(t.allowParentTaskDependencies||n.isLeaf()));i&&(r.assignmentStore!==i.getStore()&&i.reconfigure(r.assignmentStore),i.resourceDupStore!==r.resourceStore&&(i.resourceDupStore=r.resourceStore),i.loadResources(!0),i.loadTaskAssignments(n.getId()||n.getPhantomId()),i.task=f);u.loadRecord(n,f);t.advancedForm&&(t.advancedForm.setSuppressTaskUpdate(!0),e=t.advancedForm.getForm(),e.reset(),t.advancedForm.loadRecord(n,u.taskBuffer),o=e.findField("wbsCode"),o&&o.setValue(n.getWBSCode()),t.advancedForm.setSuppressTaskUpdate(!1));u.setSuppressTaskUpdate(!1);t.notesEditor&&t.notesEditor.setValue(n.getNote());t.setReadOnly(h);t.fireEvent("loadtask",t,n)}},updateReadOnly:function(){var n=this,i=n.taskBuffer,t=n.getReadOnly(),r=t||i.isReadOnly();i&&(n.taskForm&&(t!=n.taskForm.getReadOnly()?n.taskForm.setReadOnly(t):n.taskForm.updateReadOnly()),n.assignmentGrid&&(n.assignmentGrid.setReadOnly(r),n.assignmentGrid.down("toolbar").setVisible(!r)),n.dependencyGrid&&n.dependencyGrid.down("toolbar").setVisible(!r),n.notesEditor&&n.notesEditor.setReadOnly(r||!i.isEditable(i.noteField)),n.advancedForm&&(t!=n.advancedForm.getReadOnly()?n.advancedForm.setReadOnly(t):n.advancedForm.updateReadOnly()))},doValidate:function(n){var t=this.callParent(arguments);return this.taskForm&&!this.taskForm.isValid()&&(t=!1,n&&n(this.getTabByComponent(this.taskForm),this.taskForm)),this.dependencyGrid&&!this.dependencyGrid.isValid()&&(t=!1,n&&n(this.getTabByComponent(this.dependencyGrid),this.dependencyGrid)),this.assignmentGrid&&!this.assignmentGrid.isValid()&&(t=!1,n&&n(this.getTabByComponent(this.assignmentGrid),this.assignmentGrid)),this.advancedForm&&!this.advancedForm.isValid()&&(t=!1,n&&n(this.getTabByComponent(this.advancedForm),this.advancedForm)),t},doUpdateTask:function(){this.taskForm&&this.taskForm.updateRecord();this.advancedForm&&this.advancedForm.updateRecord();this.notesEditor&&this.task.set(this.task.noteField,this.notesEditor.getValue());this.assignmentGrid&&this.assignmentGrid.saveTaskAssignments();this.dependencyGrid&&this.dependencyGrid.saveDependencies()},isDataChanged:function(n){var t=this.callParent(arguments);return this.taskForm&&this.taskForm.isDataChanged()&&(t=!0,n&&n(this.getTabByComponent(this.taskForm))),this.dependencyGrid&&this.dependencyGrid.isDataChanged()&&(t=!0,n&&n(this.getTabByComponent(this.dependencyGrid))),this.assignmentGrid&&this.assignmentGrid.isDataChanged()&&(t=!0,n&&n(this.getTabByComponent(this.assignmentGrid))),this.advancedForm&&this.advancedForm.isDataChanged()&&(t=!0,n&&n(this.getTabByComponent(this.advancedForm))),this.notesEditor&&this.notesEditor.isDataChanged()&&(t=!0,n&&n(this.getTabByComponent(this.notesEditor))),t}});Ext.define("Gnt.plugin.taskeditor.TaskEditor",{extend:Gnt.plugin.taskeditor.BaseEditor,alternateClassName:["Gnt.plugin.TaskEditor"],alias:"plugin.gantt_taskeditor",ptype:"gantt_taskeditor",taskEditorCls:"Gnt.widget.taskeditor.TaskEditor",height:420,width:650,taskEditorConfigs:"l10n,task,taskStore,assignmentStore,resourceStore,generalText,resourcesText,dependencyText,addDependencyText,dropDependencyText,notesText,advancedText,wbsCodeText,addAssignmentText,dropAssignmentText,showAssignmentGrid,showDependencyGrid,allowParentTaskDependencies,showNotes,showStyle,showAdvancedForm,taskFormClass,advancedFormClass,taskFormConfig,dependencyGridConfig,assignmentGridConfig,advancedFormConfig,styleFormConfig,dependencyGridClass,assignmentGridClass",constructor:function(){this.callParent(arguments);this.addFilter(this.isTask)},init:function(n){this.callParent(arguments);n.taskEditor=this},isTask:function(n){return n&&!n.isProject}});Ext.define("Gnt.widget.Calendar",{extend:Ext.picker.Date,alias:"widget.ganttcalendar",mixins:[Gnt.mixin.Localizable],calendar:null,startDate:null,endDate:null,initComponent:function(){this.calendar||Ext.Error.raise('Required attribute "calendar" missing during initialization of `Gnt.widget.Calendar`');this.startDate||Ext.Error.raise('Required attribute "startDate" missing during initialization of `Gnt.widget.Calendar`');this.endDate||(this.endDate=Sch.util.Date.add(this.startDate,Sch.util.Date.MONTH,1));this.setCalendar(this.calendar);this.minDate=this.value=this.startDate;this.callParent(arguments);this.injectDates()},injectDates:function(){var n=this,t=n.disabledDates=[];Ext.Array.each(n.calendar.getHolidaysRanges(n.startDate,n.endDate),function(i){i.forEachDate(function(i){t.push(Ext.Date.format(i,n.format))})});n.setDisabledDates(t)},setCalendar:function(n){var t={update:this.injectDates,remove:this.injectDates,add:this.injectDates,load:this.injectDates,clear:this.injectDates,scope:this};this.calendar&&this.mun(n,t);this.calendar=n;n&&this.mon(n,t)}});Ext.define("Gnt.widget.calendar.AvailabilityGrid",{extend:Ext.grid.Panel,mixins:[Gnt.mixin.Localizable],alias:"widget.calendaravailabilitygrid",calendarDay:null,height:160,addButton:null,removeButton:null,maxIntervalsNum:5,initComponent:function(){this.tbar||(this.tbar=this.buildToolbar());Ext.applyIf(this,{store:new Ext.data.Store({fields:["startTime","endTime"],autoDestroy:!0,data:this.calendarDay.getAvailability()}),plugins:[new Ext.grid.plugin.CellEditing({clicksToEdit:2})],columns:[{xtype:"datecolumn",header:this.L("startText"),format:"g:i a",dataIndex:"startTime",flex:1,editor:{xtype:"timefield",allowBlank:!1,initDate:"31/12/1899"}},{xtype:"datecolumn",header:this.L("endText"),format:"g:i a",dataIndex:"endTime",flex:1,editor:{xtype:"timefield",allowBlank:!1,initDate:"31/12/1899"}}],listeners:{selectionchange:this.onAvailabilityGridSelectionChange,scope:this}});this.callParent(arguments)},buildToolbar:function(){return this.addButton=new Ext.Button({text:this.L("addText"),iconCls:"gnt-action-add",handler:this.addAvailability,scope:this}),this.removeButton=new Ext.Button({text:this.L("removeText"),iconCls:"gnt-action-remove",handler:this.removeAvailability,scope:this,disabled:!0}),[this.addButton,this.removeButton]},onAvailabilityGridSelectionChange:function(n,t){this.removeButton.setDisabled(!t.length)},setAvailability:function(n){this.store.loadData(n);this.addButton.setDisabled(this.store.getCount()>=this.maxIntervalsNum)},addAvailability:function(){var n=this.getStore(),t=n.count();t>=this.maxIntervalsNum||(n.add({startTime:new Date(0,0,0,12,0),endTime:new Date(0,0,0,13,0)}),t+1>=this.maxIntervalsNum&&this.addButton&&this.addButton.disable())},removeAvailability:function(){var n=this.getStore(),i=n.getCount(),t=this.getSelection();t.length&&(n.remove(t[0]),i<this.maxIntervalsNum&&this.addButton&&this.addButton.enable())},isValid:function(n){try{this.calendarDay.verifyAvailability(this.getIntervals())}catch(t){return n||Ext.MessageBox.show({title:this.L("error"),msg:t,modal:!0,icon:Ext.MessageBox.ERROR,buttons:Ext.MessageBox.OK}),!1}return!0},extractTimeFromDate:function(n){return new Date(0,0,0,n.getHours(),n.getMinutes(),n.getSeconds())},getIntervals:function(){var n=[],t=this;return this.getStore().each(function(i){var r=t.extractTimeFromDate(i.get("endTime"));r-new Date(0,0,0,0,0,0)==0&&(r=new Date(0,0,1,0,0));n.push({startTime:t.extractTimeFromDate(i.get("startTime")),endTime:r})}),n}});Ext.define("Gnt.widget.calendar.DayEditor",{extend:Gnt.widget.calendar.AvailabilityGrid,mixins:[Gnt.mixin.Localizable],alias:"widget.calendardayeditor",height:160,initComponent:function(){var n=this.calendarDay.getIsWorkingDay();this.dockedItems=this.dockedItems||[{xtype:"radiogroup",dock:"top",name:"dayType",padding:"0 5px",margin:0,items:[{boxLabel:this.L("workingTimeText"),name:"IsWorkingDay",inputValue:!0,checked:n},{boxLabel:this.L("nonworkingTimeText"),name:"IsWorkingDay",inputValue:!1,checked:!n}],listeners:{change:this.onDayTypeChanged,scope:this}}];this.on("afterrender",this.myApplyState,this);this.callParent(arguments)},getDayTypeRadioGroup:function(){return this.down('radiogroup[name="dayType"]')},myApplyState:function(){this.isWorkingDay()||(this.viewSetDisabled(!0),this.addButton.disable())},viewSetDisabled:function(n){n?(this.getView().getEl().mask(),this.getHeaderContainer().getEl().mask()):(this.getView().getEl().unmask(),this.getHeaderContainer().getEl().unmask())},onDayTypeChanged:function(n){var t=n.getValue();Ext.isArray(t.IsWorkingDay)||(this.viewSetDisabled(!t.IsWorkingDay),this.addButton.setDisabled(!t.IsWorkingDay||this.getStore().getCount()>=this.maxIntervalsNum))},isWorkingDay:function(){return this.getDayTypeRadioGroup().getValue().IsWorkingDay},isValid:function(){return this.isWorkingDay()?this.callParent():!0},getIntervals:function(){return this.isWorkingDay()?this.callParent():[]}});Ext.define("Gnt.widget.calendar.WeekEditor",{extend:Ext.form.Panel,mixins:[Gnt.mixin.Localizable],alias:"widget.calendarweekeditor",weekName:null,startDate:null,endDate:null,weekAvailability:null,calendarWeekAvailability:null,defaultWeekAvailability:null,backupWeekAvailability:null,layout:"anchor",defaults:{border:!1,anchor:"100%"},calendarDayModel:null,currentDayIndex:null,_weekDaysGrid:null,_availabilityGrid:null,initComponent:function(){this.backupWeekAvailability=[];this.items=[{xtype:"radiogroup",padding:"0 5px",name:"dayType",items:[{boxLabel:this.L("defaultTimeText"),name:"IsWorkingDay",inputValue:0},{boxLabel:this.L("workingTimeText"),name:"IsWorkingDay",inputValue:1},{boxLabel:this.L("nonworkingTimeText"),name:"IsWorkingDay",inputValue:2}],listeners:{change:this.onDayTypeChanged,scope:this}},{layout:"column",padding:"0 0 5px 0",defaults:{border:!1},items:[{margin:"0 10px 0 5px",columnWidth:.5,items:this.getWeekDaysGrid()},{columnWidth:.5,margin:"0 5px 0 0",items:this.getAvailabilityGrid()}]}];this.callParent(arguments)},getWeekDaysGrid:function(){if(this._weekDaysGrid!=null)return this._weekDaysGrid;var n=Ext.Date.dayNames;return this._weekDaysGrid=new Ext.grid.Panel({hideHeaders:!0,height:160,columns:[{header:"",dataIndex:"name",flex:1}],store:new Ext.data.Store({autoDestroy:!0,fields:["id","name"],idProperty:"id",data:[{id:1,name:n[1]},{id:2,name:n[2]},{id:3,name:n[3]},{id:4,name:n[4]},{id:5,name:n[5]},{id:6,name:n[6]},{id:0,name:n[0]}]}),listeners:{viewready:this.onWeekDaysListViewReady,selectionchange:this.onWeekDaysListSelectionChange,beforeselect:this.onWeekDaysListBeforeSelect,scope:this}})},getAvailabilityGrid:function(){return this._availabilityGrid||(this._availabilityGrid=new Gnt.widget.calendar.AvailabilityGrid({calendarDay:new this.calendarDayModel})),this._availabilityGrid},getDayTypeRadioGroup:function(){return this.dayTypeRadioGroup||(this.dayTypeRadioGroup=this.down('radiogroup[name="dayType"]')),this.dayTypeRadioGroup},getWeekAvailability:function(){return this.weekAvailability},onWeekDaysListViewReady:function(){var n=this.getWeekDaysGrid(),t=n.getStore().getAt(0);this.currentDayIndex=t.getId();this.readFromData();n.getSelectionModel().select(t,!1,!0)},onWeekDaysListBeforeSelect:function(){if(!this.saveToData())return!1},applyChanges:function(n){var u,r,t,i;if(!this.saveToData())return!1;for(u=this.weekAvailability,r=!1,t=0;t<7;t++)i=u[t],i?(r=!0,n[t]||(n[t]=i),n[t].setIsWorkingDay(i.getIsWorkingDay()),n[t].setAvailability(i.getAvailability())):n[t]=null;return r?!0:(Ext.MessageBox.show({title:this.L("error"),msg:this.L("noOverrideError"),modal:!0,icon:Ext.MessageBox.ERROR,buttons:Ext.MessageBox.OK}),!1)},onWeekDaysListSelectionChange:function(n,t){this.currentDayIndex=t[0].getId();this.readFromData()},getCurrentTypeOfWeekDay:function(n){return this.weekAvailability[n]?this.weekAvailability[n].getIsWorkingDay()?1:2:0},getCurrentWeekDay:function(n){return this.weekAvailability[n]||this.calendarWeekAvailability[n]||this.defaultWeekAvailability[n]},saveToData:function(){var n=this.currentDayIndex,r=this.getDayTypeRadioGroup().getValue().IsWorkingDay,t=this.weekAvailability,i;return r===0?(t[n]=null,!0):(i=this.getAvailabilityGrid(),r==1)?i.isValid()?(t[n]||(t[n]=this.copyDefaultWeekDay(n)),t[n].setIsWorkingDay(!0),t[n].setAvailability(i.getIntervals()),this.backupWeekAvailability[n]=null,!0):!1:(t[n]||(t[n]=this.copyDefaultWeekDay(n)),t[n].setIsWorkingDay(!1),t[n].setAvailability([]),!0)},copyDefaultWeekDay:function(n){var t=(this.calendarWeekAvailability[n]||this.defaultWeekAvailability[n]).copy();return t.phantom=!0,t.beginEdit(),t.setType("WEEKDAYOVERRIDE"),t.setOverrideStartDate(this.startDate),t.setOverrideEndDate(this.endDate),t.setName(this.weekName),t.endEdit(),t},readFromData:function(n){var u=this.getCurrentWeekDay(this.currentDayIndex),i=this.getCurrentTypeOfWeekDay(this.currentDayIndex),r=this.getAvailabilityGrid(),t;r.setAvailability(n||u.getAvailability());t=this.getDayTypeRadioGroup();t.suspendEvents();t.setValue({IsWorkingDay:[i]});t.resumeEvents();r.setDisabled(i!=1)},onDayTypeChanged:function(n,t,i){var f=n.getValue();if(f.IsWorkingDay!=null&&!Ext.isArray(f.IsWorkingDay)){var u=this.weekAvailability,e=this.backupWeekAvailability,r=this.currentDayIndex,s=this.getAvailabilityGrid(),o;i.IsWorkingDay==1&&(e[r]=s.getIntervals());switch(f.IsWorkingDay){case 0:u[r]=null;break;case 1:u[r]||(u[r]=this.copyDefaultWeekDay(r));o=e[r];u[r].setIsWorkingDay(!0);break;case 2:u[r]||(u[r]=this.copyDefaultWeekDay(r));u[r].setAvailability([]);u[r].setIsWorkingDay(!1);break;default:throw"Unrecognized day type";}this.readFromData(o)}}});Ext.define("Gnt.widget.calendar.DatePicker",{extend:Ext.picker.Date,alias:"widget.gntdatepicker",workingDayCls:"gnt-datepicker-workingday",nonWorkingDayCls:"gnt-datepicker-nonworkingday",overriddenDayCls:"gnt-datepicker-overriddenday",overriddenWeekDayCls:"gnt-datepicker-overriddenweekday",weekOverridesStore:null,dayOverridesCalendar:null,update:function(){this.callParent(arguments);this.refreshCssClasses()},refreshCssClasses:function(){var t=this,i=t.cells.elements,n,r;for(this.removeCustomCls(),n=0;n<t.numDays;n++)r=i[n].firstChild.dateValue,i[n].className+=" "+this.getDateCls(new Date(r))},getDateCls:function(n){var t="",i,r,f,u;if(n.getMonth()===this.getActive().getMonth())return i=this.dayOverridesCalendar,i.getOwnCalendarDay(n)?(t+=" "+this.overriddenDayCls,i.isWorkingDay(n)||(t+=" "+this.nonWorkingDayCls)):(r=null,this.weekOverridesStore.each(function(t){if(Ext.Date.between(n,t.get("startDate"),t.get("endDate")))return r=t,!1}),r?(t+=" "+this.overriddenWeekDayCls,f=n.getDay(),u=r.get("weekAvailability"),u&&u[f]&&!u[f].getIsWorkingDay()&&(t+=" "+this.nonWorkingDayCls)):i.isWorkingDay(n)||(t+=" "+this.nonWorkingDayCls)),t||this.workingDayCls},removeCustomCls:function(){this.cells.removeCls([this.overriddenDayCls,this.nonWorkingDayCls,this.workingDayCls,this.overriddenWeekDayCls])}});Ext.define("Gnt.widget.calendar.Calendar",{extend:Ext.form.Panel,mixins:[Gnt.mixin.Localizable],alias:"widget.calendar",defaults:{padding:10,border:!1},workingDayCls:"gnt-datepicker-workingday",nonWorkingDayCls:"gnt-datepicker-nonworkingday",overriddenDayCls:"gnt-datepicker-overriddenday",overriddenWeekDayCls:"gnt-datepicker-overriddenweekday",calendar:null,calendarManager:null,dayGridConfig:null,weekGridConfig:null,datePickerConfig:null,readOnly:!1,dayGrid:null,weekGrid:null,datePicker:null,legendTpl:'<ul class="gnt-calendar-legend"><li class="gnt-calendar-legend-item"><div class="gnt-calendar-legend-itemstyle {workingDayCls}"><\/div><span class="gnt-calendar-legend-itemname">{workingDayText}<\/span><div style="clear: both"><\/div><\/li><li><div class="gnt-calendar-legend-itemstyle {nonWorkingDayCls}"><\/div><span class="gnt-calendar-legend-itemname">{weekendsText}<\/span><div style="clear: both"><\/div><\/li><li class="gnt-calendar-legend-override"><div class="gnt-calendar-legend-itemstyle {overriddenDayCls}">31<\/div><span class="gnt-calendar-legend-itemname">{overriddenDayText}<\/span><div style="clear: both"><\/div><\/li><li class="gnt-calendar-legend-override"><div class="gnt-calendar-legend-itemstyle {overriddenWeekDayCls}">31<\/div><span class="gnt-calendar-legend-itemname">{overriddenWeekText}<\/span><div style="clear: both"><\/div><\/li><\/ul>',dateInfoTpl:null,dayOverridesCalendar:null,weekOverridesStore:null,currentDayOverrideEditor:null,calendarDayModel:null,layout:{type:"vbox",align:"stretch"},initComponent:function(){var n=this,t;n.setupTemplates();t=n.calendar;!t&&n.calendarManager&&(t=n.calendarManager.getProjectCalendar()||n.calendarManager.getRoot().firstChild);n.calendarDayModel||(n.calendarDayModel=t&&t.getModel&&t.getModel()||t.model);n.buildItems();n.bindListeners();n.callParent(arguments);n.setReadOnly(n.readOnly);t&&n.setCalendar(t)},setReadOnly:function(n){this.readOnly=n;this.cmbParentCalendar.setDisabled(n);this.down("#calendarName").setDisabled(n);this.setGridReadOnly(this.dayGrid,n);this.setGridReadOnly(this.weekGrid,n)},getReadOnly:function(){return this.readOnly},isReadOnly:function(){return this.getReadOnly()},setGridReadOnly:function(n,t){var i=n.getPlugin("editingPlugin");i&&i[t?"disable":"enable"]();n.down("#btnAdd").setDisabled(t);n.down("#btnEdit").setDisabled(t);n.down("#btnRemove").setDisabled(t)},bindListeners:function(){var n=this;n.on("calendarset",n.onCalendarSet);n.on("afterrender",n.onCalendarSet);n.dayGrid.on({selectionchange:n.onDayGridSelectionChange,validateedit:n.onDayGridValidateEdit,edit:n.onDayGridEdit,scope:n});n.dayGrid.store.on({update:n.refreshView,remove:n.refreshView,add:n.refreshView,scope:n});n.weekGrid.on({selectionchange:n.onWeekGridSelectionChange,validateedit:n.onWeekGridValidateEdit,edit:n.onWeekGridEdit,scope:n});n.weekGrid.store.on({update:n.refreshView,remove:n.refreshView,add:n.refreshView,scope:n});n.datePicker.on({select:n.onDateSelect,scope:n})},buildItems:function(){this.dateInfoPanel=new Ext.Panel({cls:"gnt-calendar-dateinfo",padding:"10 10 10 10",columnWidth:.33,border:!1,height:200});this.cmbParentCalendar=new Ext.form.field.ComboBox({name:"cmb_parentCalendar",fieldLabel:this.L("parentCalendarText"),store:new Ext.data.Store({autoDestroy:!0,fields:["Id","Name"]}),queryMode:"local",displayField:"Name",valueField:"Id",editable:!1,emptyText:this.L("selectParentText"),flex:1});this.buildWeekGrid();this.buildDayGrid();this.buildDatePicker();this.items=[{xtype:"container",layout:"hbox",pack:"start",align:"stretch",items:[{xtype:"textfield",itemId:"calendarName",fieldLabel:this.L("calendarNameText"),margin:"0 10 0 0",flex:1},this.cmbParentCalendar]},{layout:"column",padding:"10 10 0 10",defaults:{border:!1},items:[{columnWidth:.3,html:this.legendTpl.apply({workingDayText:this.L("workingDayText"),weekendsText:this.L("weekendsText"),overriddenDayText:this.L("overriddenDayText"),overriddenWeekText:this.L("overriddenWeekText"),workingDayCls:this.workingDayCls,nonWorkingDayCls:this.nonWorkingDayCls,overriddenDayCls:this.overriddenDayCls,overriddenWeekDayCls:this.overriddenWeekDayCls})},{columnWidth:.37,layout:{type:"hbox",pack:"center"},items:[this.datePicker]},this.dateInfoPanel]},{xtype:"tabpanel",padding:"10 10 10 10",flex:1,items:[this.dayGrid,this.weekGrid]}]},buildDayGrid:function(){var n=this.calendarDayModel.prototype;this.dayGrid=new Ext.grid.Panel(Ext.apply({title:this.L("dayOverridesText"),itemId:"dayGrid",tbar:[{text:this.L("addText"),itemId:"btnAdd",action:"add",iconCls:"gnt-action-add",handler:this.addDay,scope:this},{text:this.L("editText"),itemId:"btnEdit",action:"edit",iconCls:"gnt-action-edit",handler:this.editDay,scope:this},{text:this.L("removeText"),itemId:"btnRemove",action:"remove",iconCls:"gnt-action-remove",handler:this.removeDay,scope:this}],store:new Gnt.data.Calendar,plugins:[new Ext.grid.plugin.CellEditing({clicksToEdit:2,pluginId:"editingPlugin"})],columns:[{header:this.L("dayOverrideNameHeaderText"),dataIndex:n.nameField,flex:1,editor:{allowBlank:!1}},{header:this.L("dateText"),dataIndex:n.dateField,width:100,xtype:"datecolumn",editor:{xtype:"datefield"}}]},this.dayGridConfig||{}));this.dayOverridesCalendar=this.dayGrid.store},updateGrids:function(){this.dayGrid&&this.fillDaysStore();this.weekGrid&&this.fillWeeksStore()},buildWeekGrid:function(){this.weekGrid=new Ext.grid.Panel(Ext.apply({title:this.L("weekOverridesText"),border:!0,itemId:"weekGrid",plugins:[new Ext.grid.plugin.CellEditing({clicksToEdit:2,pluginId:"editingPlugin"})],store:new Ext.data.Store({autoDestroy:!0,model:"Gnt.model.Week"}),tbar:[{text:this.L("addText"),itemId:"btnAdd",action:"add",iconCls:"gnt-action-add",handler:this.addWeek,scope:this},{text:this.L("editText"),itemId:"btnEdit",action:"edit",iconCls:"gnt-action-edit",handler:this.editWeek,scope:this},{text:this.L("removeText"),itemId:"btnRemove",action:"remove",iconCls:"gnt-action-remove",handler:this.removeWeek,scope:this}],columns:[{header:this.L("overrideName"),dataIndex:"name",flex:1,editor:{allowBlank:!1}},{xtype:"datecolumn",header:this.L("startDate"),dataIndex:"startDate",width:100,editor:{xtype:"datefield"}},{xtype:"datecolumn",header:this.L("endDate"),dataIndex:"endDate",width:100,editor:{xtype:"datefield"}}]},this.weekGridConfig||{}));this.weekOverridesStore=this.weekGrid.store},buildDatePicker:function(){this.datePicker=new Gnt.widget.calendar.DatePicker(Ext.apply({dayOverridesCalendar:this.dayGrid.store,weekOverridesStore:this.weekGrid.store},this.datePickerConfig))},onCalendarSet:function(){this.weekOverridesStore.commitChanges()},setCalendar:function(n){this.calendar&&this.mun(this.calendar,{load:this.onCalendarChange,add:this.onCalendarChange,remove:this.onCalendarChange,update:this.onCalendarChange,parentchange:this.onParentChange,scope:this});this.calendar=n;n&&this.mon(this.calendar,{load:this.onCalendarChange,add:this.onCalendarChange,remove:this.onCalendarChange,update:this.onCalendarChange,parentchange:this.onParentChange,scope:this});this.onCalendarChange();this.fireEvent("calendarset",n)},onParentChange:function(){this.updateComboBox()},updateComboBox:function(){var n=this,t=[],i,r,u,f;n.calendarManager?(i=n.calendarManager.getRoot(),r=n.calendarManager.getNodeByCalendar(n.calendar),i.cascadeBy(function(n){var u=n.getCalendar();n===i||n===r||r.contains(n)||t.push({Id:u.calendarId,Name:n.getName()||u.calendarId})})):t=n.calendar.getParentableCalendars();this.cmbParentCalendar.store.loadData([{Id:-1,Name:this.L("noParentText")}].concat(t));u=this.calendar&&this.calendar.parent;f=u&&u.calendarId;this.cmbParentCalendar.setValue(f||-1)},onCalendarChange:function(){this.updateComboBox();this.fillDaysStore();this.fillWeeksStore();this.refreshView()},setupTemplates:function(){var n=this.L("tplTexts");this.dateInfoTpl||(this.dateInfoTpl=Ext.String.format('<div class="gnt-calendar-overridedate"><tpl if="isWorkingDay">'+n.tplWorkingHours+" {date}:<tpl else>{date} "+n.tplIsNonWorking+'<\/tpl><\/div><ul class="gnt-calendar-availabilities"><tpl for="availability"><li>{.}<\/li><\/tpl><\/ul><span class="gnt-calendar-overridesource">'+n.tplBasedOn+': <tpl if="override">'+n.tplOverride+' "{name}" '+n.tplInCalendar+' "{calendarName}"<tpl else>'+n.tplDayInCalendar+' "{calendarName}"<\/tpl><\/span>'));this.dateInfoTpl instanceof Ext.Template||(this.dateInfoTpl=new Ext.XTemplate(this.dateInfoTpl));this.legendTpl instanceof Ext.Template||(this.legendTpl=new Ext.XTemplate(this.legendTpl))},afterRender:function(){this.callParent(arguments);this.onDateSelect(this.datePicker,new Date)},fillDaysStore:function(){var n=Gnt.util.Data.cloneModelSet(this.calendar,function(n){return n.getType()=="DAY"&&n.getDate()});this.dayOverridesCalendar.loadData(n)},copyCalendarDay:function(n){var t=n.copy(null);return t.__COPYOF__=n.getId(),t},fillWeeksStore:function(){var n=this,t=[];this.calendar.forEachNonStandardWeek(function(i){var r=Ext.apply({},i);r.weekAvailability=Ext.Array.map(r.weekAvailability,function(t){return t&&n.copyCalendarDay(t)||null});r.mainDay=n.copyCalendarDay(r.mainDay);t.push(r)});this.weekOverridesStore.loadData(t)},addDay:function(){var i=this.datePicker.getValue();if(this.dayOverridesCalendar.getOwnCalendarDay(i)){this.alert({msg:this.L("overrideErrorText")});return}var r=this.calendar.model,t=r.prototype,n={};n[t.nameField]=this.L("newDayName");n[t.typeField]="DAY";n[t.dateField]=i;n=new r(n);this.dayGrid.getStore().insert(0,n);this.dayGrid.getSelectionModel().select([n],!1,!1)},editDay:function(){var r=this,u=this.dayGrid.getSelection(),i=u[0],n,t;i&&(n=this.currentDayOverrideEditor=new Gnt.widget.calendar.DayEditor({addText:this.L("addText"),removeText:this.L("removeText"),workingTimeText:this.L("workingTimeText"),nonworkingTimeText:this.L("nonworkingTimeText"),calendarDay:i}),t=Ext.create("Ext.window.Window",{title:this.L("dayOverridesText"),modal:!0,width:280,height:260,layout:"fit",items:n,buttons:[{text:this.L("okText"),handler:function(){if(n.isValid()){var u=n.calendarDay;u.setIsWorkingDay(n.isWorkingDay());u.setAvailability(n.getIntervals());r.applyCalendarDay(u,i);r.refreshView();t.close()}}},{text:this.L("cancelText"),handler:function(){t.close()}}]}),t.show())},removeDay:function(){var n=this.dayGrid,t=n.getSelection();t[0]&&(n.getStore().remove(t[0]),this.refreshView())},refreshView:function(){var t=this.datePicker.getValue(),r=this.getCalendarDay(t),e=this.weekGrid,o=this.dayGrid,i=this.dayOverridesCalendar.getOwnCalendarDay(t),n,u,f;i?(o.getSelectionModel().select([i],!1,!0),u=i.getName()):(n=this.getWeekOverrideByDate(t),n&&(e.getSelectionModel().select([n],!1,!0),u=n.get("name")));f={name:u||r.getName(),date:Ext.Date.format(t,"M j, Y"),calendarName:this.calendar.name||this.calendar.calendarId,availability:r.getAvailability(!0),override:Boolean(i||n),isWorkingDay:r.getIsWorkingDay()};this.dateInfoPanel.update(this.dateInfoTpl.apply(f));this.down("#calendarName").setValue(this.calendar.name);this.datePicker.rendered&&this.datePicker.refreshCssClasses()},onDayGridSelectionChange:function(n,t){t[0]&&(this.datePicker.setValue(t[0].getDate()),this.refreshView())},onDayGridEdit:function(n,t){t.field==="Date"&&(t.grid.getStore().clearCache(),this.datePicker.setValue(t.value));this.refreshView()},onDayGridValidateEdit:function(n,t){var i=this.dayGrid.store;if(t.field===i.model.prototype.dateField&&i.getOwnCalendarDay(t.value)&&t.value!==t.originalValue)return this.alert({msg:this.L("overrideErrorText")}),!1},onDateSelect:function(){this.refreshView()},getCalendarDay:function(n){var t=this.dayOverridesCalendar.getOwnCalendarDay(n);return t?t:(t=this.getWeekOverrideDay(n),t)?t:this.calendar.weekAvailability[n.getDay()]||this.calendar.defaultWeekAvailability[n.getDay()]},getWeekOverrideDay:function(n){var i=this.getWeekOverrideByDate(n),r=n.getDay(),t;return i==null?null:(t=i.get("weekAvailability"),!t)?null:t[r]},getWeekOverrideByDate:function(n){var t=null;return this.weekOverridesStore.each(function(i){if(Ext.Date.between(n,i.get("startDate"),i.get("endDate")))return t=i,!1}),t},intersectsWithCurrentWeeks:function(n,t,i){var r=!1;return this.weekOverridesStore.each(function(u){if(u!=i){var f=u.get("startDate"),e=u.get("endDate");if(f<=n&&n<e||f<t&&t<=e)return r=!0,!1}}),r},addWeek:function(){for(var n,u,f=this.weekOverridesStore,t=this.datePicker.getValue(),i,r=7;r>0;r--)if(i=Sch.util.Date.add(t,Sch.util.Date.DAY,r),!this.intersectsWithCurrentWeeks(t,i))break;if(!r){this.alert({msg:Ext.String.format(this.L("overrideDateError"),Ext.Date.format(t,"Y/m/d"))});return}n=new this.calendar.model;n.setType("WEEKDAYOVERRIDE");n.setName(this.L("newDayName"));n.setOverrideStartDate(t);n.setOverrideEndDate(i);n.setWeekday(-1);u=f.insert(0,{name:this.L("newDayName"),startDate:t,endDate:i,weekAvailability:[],mainDay:n})[0];this.weekGrid.getSelectionModel().select([u],!1,!1)},editWeek:function(){var i=this.weekGrid.getSelection(),u=this;if(i.length!==0){var n=i[0],r=new Gnt.widget.calendar.WeekEditor({startDate:n.get("startDate"),endDate:n.get("endDate"),weekName:n.get("name"),calendarDayModel:this.calendar.model,weekAvailability:n.get("weekAvailability"),calendarWeekAvailability:this.calendar.weekAvailability,defaultWeekAvailability:this.calendar.defaultWeekAvailability}),t=Ext.create("Ext.window.Window",{title:this.L("weekOverridesText"),modal:!0,width:370,defaults:{border:!1},layout:"fit",items:r,buttons:[{action:"ok",text:this.L("okText"),handler:function(){r.applyChanges(n.get("weekAvailability"))&&(u.refreshView(),t.close())}},{text:this.L("cancelText"),handler:function(){t.close()}}]});t.show()}},removeWeek:function(){var n=this.weekGrid.getSelection();n[0]&&(this.weekOverridesStore.remove(n[0]),this.refreshView())},onWeekGridSelectionChange:function(n,t){t[0]&&this.datePicker.setValue(t[0].get("startDate"))},onWeekGridEdit:function(n,t){var i=t.record,r=i.get("startDate"),u=i.get("endDate");(t.field=="startDate"||t.field=="endDate")&&(Ext.Array.each(i.get("weekAvailability").concat(i.get("mainDay")),function(n){n&&(n.setOverrideStartDate(r),n.setOverrideEndDate(u))}),this.datePicker.setValue(r));this.refreshView()},alert:function(n){n=n||{};Ext.MessageBox.show(Ext.applyIf(n,{title:this.L("error"),icon:Ext.MessageBox.WARNING,buttons:Ext.MessageBox.OK}))},onWeekGridValidateEdit:function(n,t){var i=t.record,r=t.field=="startDate"?t.value:i.get("startDate"),u=t.field=="endDate"?t.value:i.get("endDate");return r>u?(this.alert({msg:this.L("startAfterEndError")}),!1):this.intersectsWithCurrentWeeks(r,u,i)?(this.alert({msg:this.L("weeksIntersectError")}),!1):void 0},applyCalendarDay:function(n,t){t.beginEdit();t.setName(n.getName());t.setIsWorkingDay(n.getIsWorkingDay());t.setDate(n.getDate());t.setOverrideStartDate(n.getOverrideStartDate());t.setOverrideEndDate(n.getOverrideEndDate());var i=n.getAvailability(!0),r=t.getAvailability(!0);i+""!=r+""&&t.setAvailability(n.getAvailability());t.endEdit()},applySingleDay:function(n,t){n.__COPYOF__?this.applyCalendarDay(n,this.calendar.getModelById(n.__COPYOF__)):(n.store&&n.unjoin(n.store),n.setId(null),t.push(n.getData()))},applyChanges:function(){var o=this,n=this.calendar,i=this.down('combobox[name="cmb_parentCalendar"]').getValue(),r=this.down("#calendarName").getValue(),t;this.calendarManager&&(t=this.calendarManager.getModelById(n.calendarId),t&&t.setName(r));n.suspendEvents(!0);n.suspendCacheUpdate++;n.name=r;n.setParent(i?Gnt.data.Calendar.getCalendar(i):null);n.getProxy()&&n.getProxy().extraParams&&(n.getProxy().extraParams.calendarId=n.calendarId);Gnt.util.Data.applyCloneChanges(this.dayOverridesCalendar,n);var u=[],f=[],e={};this.weekOverridesStore.each(function(n){Ext.Array.each(n.get("weekAvailability").concat(n.get("mainDay")),function(n){n&&(n.__COPYOF__&&(e[n.__COPYOF__]=!0),o.applySingleDay(n,u))})});n.forEachNonStandardWeek(function(n){Ext.Array.each(n.weekAvailability.concat(n.mainDay),function(n){n&&!e[n.getId()]&&f.push(n)})});n.add(u);n.remove(f);n.suspendCacheUpdate--;n.clearCache();n.resumeEvents();this.fireEvent("calendarset",n)},hasChanges:function(){if(!this.calendar)return!1;var n=this.dayOverridesCalendar.getModifiedRecords().length||this.dayOverridesCalendar.getRemovedRecords().length,t=this.weekOverridesStore.getModifiedRecords().length||this.weekOverridesStore.getRemovedRecords().length,i=this.down("#calendarName").getValue()!=this.calendar.name,r=this.calendar.parent&&this.calendar.parent.calendarId||-1,u=this.cmbParentCalendar.getValue()!=r;return n||t||i||u}});Ext.define("Gnt.widget.calendar.CalendarManager",{extend:Ext.panel.Panel,mixins:[Gnt.mixin.Localizable],alias:"widget.calendarmanager",treePanelConfig:null,treePanel:null,calendarPanelConfig:null,calendarManager:null,readOnly:!1,calendarPanel:null,layout:"border",width:800,height:600,initComponent:function(){var n=this,t;n.cls=n.cls+" gnt-calendarmanager";n.treePanel=n.buildTreePanel();n.calendarPanel=new Gnt.widget.calendar.Calendar(Ext.apply({region:"center",calendar:n.calendar,split:!0,calendarManager:n.calendarManager,readOnly:n.readOnly},n.calendarPanelConfig));n.items=[n.treePanel,n.calendarPanel];n.callParent(arguments);n.contextMenu=n.buildContextMenu();n.setReadOnly(n.readOnly);t=n.calendarManager;n.setCalendar(n.calendar||t.getProjectCalendar()||t.getRoot().firstChild);n.counter=1},setReadOnly:function(n){var i,t,r;if(this.readOnly=n,i=this.treePanel,i.down("#btnAdd").setDisabled(n),i.down("#btnRemove").setDisabled(n),t=i.getView(),r=n?"disable":"enable",t.rendered)t.getPlugin("treeDragDrop")[r]();else t.on("render",function(){t.getPlugin("treeDragDrop")[r]()},this,{single:!0});this.contextMenu.setDisabled(n);this.calendarPanel.setReadOnly(n)},getReadOnly:function(){return this.readOnly},isReadOnly:function(){return this.getReadOnly()},buildTreePanel:function(){var n=this;return new Ext.tree.Panel(Ext.apply({split:!0,region:"west",width:200,store:n.calendarManager,displayField:n.calendarManager.model.prototype.nameField,rootVisible:!1,tbar:[{itemId:"btnAdd",text:n.L("addText"),action:"add",iconCls:"gnt-action-add",handler:n.doAddRootNode,scope:n},{itemId:"btnRemove",text:n.L("removeText"),action:"remove",iconCls:"gnt-action-remove",handler:n.doRemoveCalendar,scope:n}],viewConfig:{plugins:{ptype:"treeviewdragdrop",pluginId:"treeDragDrop",allowContainerDrops:!0,dropZone:{onNodeDrop:function(n,t,i,r){var u=!0;return this.overRecord=this.view.getRecord(n),this.currentPosition="append",Ext.Array.each(r.records,function(n){if(n.contains(this.overRecord))return u=!1,!1},this),this.valid=u,this.overRecord.isLeaf()&&(this.overRecord.set("expanded",!0),this.overRecord.childNodes=[]),this.self.prototype.onNodeDrop.apply(this,arguments)}}},getRowClass:function(t){if(n.calendarManager.getProjectCalendar()==t.calendar)return"gnt-project-calendar-row"},listeners:{drop:n.onDrop,scope:n}},listeners:{containercontextmenu:n.onContainerContextMenu,itemcontextmenu:n.onItemContextMenu,selectionchange:n.onSelectionChange,scope:n}},n.treePanelConfig))},buildContextMenu:function(){return new Ext.menu.Menu({margin:"0 0 10 0",items:[{text:this.L("add_node"),handler:this.doAddRootNode,itemId:"add-node",scope:this},{text:this.L("add_child"),handler:this.doAddChildNode,scope:this},{text:this.L("add_sibling"),handler:this.doAddSiblingCalendar,scope:this},{text:this.L("remove"),handler:this.doRemoveCalendar,itemId:"remove-node",scope:this}]})},showContextMenu:function(n,t){var i=this.contextMenu.query("menuitem");Ext.Array.each(i,function(n){n.setVisible(!!t)});this.contextMenu.down("#add-node").setVisible(!t);n.stopEvent();this.contextMenu.showAt(n.getXY())},onContainerContextMenu:function(n,t){this.showContextMenu(t)},onItemContextMenu:function(n,t,i,r,u){this.showContextMenu(u,t)},hasChanges:function(){return this.calendarPanel.hasChanges()},onSelectionChange:function(n,t){var i=this,o=i.calendarManager,r=i.calendarPanel;if(t.length>0){var f=t[0],u=f.getCalendar(),e=o.getProjectCalendar(),s=u===e||e&&Boolean(f.findChild(f.idProperty,e.calendarId));i.isReadOnly()||(i.treePanel.down("#btnRemove").setDisabled(s),i.contextMenu.down("#remove-node").setDisabled(s));r.calendar&&r.hasChanges()?Ext.Msg.show({title:i.L("confirm_action"),msg:i.L("confirm_message"),buttons:Ext.Msg.YESNOCANCEL,icon:Ext.Msg.QUESTION,fn:function(t){t=="yes"?(i.applyChanges(),r.setCalendar(u)):t=="no"?r.setCalendar(u):(n.suspendEvents(),n.select(o.getNodeByCalendar(r.calendar)),n.resumeEvents())}}):r.setCalendar(u)}},onDrop:function(n,t,i){i=i||this.calendarManager.getRootNode();i.expand()},onDestroy:function(){this.contextMenu.destroy();this.callParent(arguments)},applyChanges:function(){this.calendarPanel.applyChanges()},doAddRootNode:function(){this.addCalendar()},doAddChildNode:function(){var n=this.treePanel.getSelectionModel().getSelection();this.addCalendar(n[0])},doAddSiblingCalendar:function(){var n=this.treePanel.getSelectionModel().getSelection();this.addCalendar(n[0]&&n[0].parentNode)},doRemoveCalendar:function(){var n=this.treePanel.getSelectionModel().getSelection();this.removeCalendar(n[0])},addCalendar:function(n){var r=Ext.ClassManager.get(this.calendarManager.calendarClass).prototype,i=this.calendarManager.model.prototype,t=i.getModelConfig(r);t[i.nameField]=this.L("calendarName")+this.counter++;t.expanded=!0;t.leaf=!0;n=n||this.treePanel.getRootNode();n.data.expanded=!0;n.appendChild(t)},removeCalendar:function(n){var i=this.treePanel.getRootNode(),t;n&&(t=n.nextSibling||n.previousSibling||(n.parentNode==i?i.firstChild:n.parentNode),t&&this.treePanel.getSelectionModel().select(t),n.remove())},setCalendar:function(n){n instanceof Gnt.model.Calendar?this.treePanel.setSelection(n):this.treePanel.setSelection(this.calendarManager.getNodeByCalendar(n))}});Ext.define("Gnt.widget.calendar.CalendarManagerWindow",{extend:Ext.window.Window,mixins:[Gnt.mixin.Localizable],alias:"widget.calendarmanagerwindow",width:850,height:600,layout:"fit",border:!1,calendarConfig:null,calendarManager:null,panel:null,closing:!1,initComponent:function(){this.panel=new Gnt.widget.calendar.CalendarManager({calendarManager:this.calendarManager,calendarConfig:this.calendarConfig});Ext.apply(this,{title:this.title||this.L("title"),items:[this.panel],buttons:[{text:this.L("ok"),handler:function(){this.applyChanges()},scope:this},{text:this.L("cancel"),handler:function(){this.close()},scope:this}],listeners:{beforeclose:this.onBeforeClose,close:this.onAfterClose}});this.callParent(arguments)},applyChanges:function(){this.panel.applyChanges()},onBeforeClose:function(){var n=this,t=this.panel;if(!n.closing&&t.hasChanges())return Ext.Msg.show({title:n.L("confirm_action"),msg:n.L("confirm_message"),buttons:Ext.Msg.YESNOCANCEL,icon:Ext.Msg.QUESTION,fn:function(i){switch(i){case"yes":t.applyChanges();n.close();break;case"no":n.closing=!0;n.close()}}}),!1},onAfterClose:function(){this.closing=!1}});Ext.define("Gnt.widget.calendar.CalendarWindow",{extend:Ext.window.Window,mixins:[Gnt.mixin.Localizable],alias:"widget.calendarwindow",calendarConfig:null,calendar:null,calendarWidget:null,initComponent:function(){Ext.apply(this,{width:600,layout:"fit",items:this.calendarWidget=new Gnt.widget.calendar.Calendar(Ext.apply({calendar:this.calendar},this.calendarConfig)),buttons:[{text:this.L("ok"),handler:function(){this.applyChanges();this.close()},scope:this},{text:this.L("cancel"),handler:this.close,scope:this}]});this.callParent(arguments)},applyChanges:function(){this.calendarWidget.applyChanges()},setCalendar:function(n){this.calendarWidget.setCalendar(n)}});Ext.define("Gnt.widget.calendar.ResourceCalendarGrid",{extend:Ext.grid.Panel,mixins:[Gnt.mixin.Localizable],alias:"widget.resourcecalendargrid",resourceStore:null,calendarStore:null,cellEditingConfig:null,initComponent:function(){var n=this,t;this.calendarStore=this.calendarStore||{xclass:"Ext.data.Store",model:"Gnt.model.Calendar"};this.calendarStore instanceof Ext.data.Store||(this.calendarStore=Ext.create(this.calendarStore));t=Ext.create("Ext.grid.plugin.CellEditing",Ext.apply({clicksToEdit:2},this.cellEditingConfig));this.mon(t,{edit:function(n,t){this.onCalendarChange(t.record,t.value)},scope:this});Ext.apply(n,{store:n.resourceStore,columns:[{header:this.L("name"),dataIndex:"Name",flex:1},{header:this.L("calendar"),flex:1,renderer:function(t,i,r){var u=r.getCalendar(),e=n.calendarStore.getModelById?"getModelById":"getById",f=n.calendarStore[e](u&&u.calendarId);return f&&f.getName()||t},editor:{xtype:"combobox",store:n.calendarStore,queryMode:"local",displayField:"Name",valueField:"Id",editable:!1,allowBlank:!1}}],border:!0,height:180,plugins:t});this.calendarStore.loadData(this.getCalendarData());this.callParent(arguments)},getCalendarData:function(){return Ext.Array.map(Gnt.data.Calendar.getAllCalendars(),function(n){return{Id:n.calendarId,Name:n.name||n.calendarId}})},onCalendarChange:function(n,t){n.setCalendarId(t)},destroy:function(){this.calendarStore.destroy();this.callParent(arguments)}});Ext.define("Robo.util.Array",{singleton:!0,reduce:function(n,t,i){n=Object(n);Ext.isFunction(t)||Ext.raise("Invalid parameter: expected a function.");var r=0,f=n.length>>>0,u=i;if(arguments.length<3)for(;;){if(r in n){u=n[r++];break}if(++r>=f)throw new TypeError("Reduce of empty array with no initial value");}for(;r<f;++r)r in n&&(u=t(u,n[r],r,n));return u}});